[{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\comparison\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Copy' is defined but never used.","line":31,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TextParser' is defined but never used.","line":34,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractKeyTakeaway' is defined but never used.","line":34,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logicIcons' is assigned a value but never used.","line":86,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logicColors' is assigned a value but never used.","line":93,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":235,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10709,10712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10709,10712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n// Force rebuild trigger\r\n\r\nimport { useState, useEffect, useMemo } from \"react\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\"; // [NEW] Persistence\r\n\r\nimport { useDemoMode } from \"@/hooks/useDemoMode\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { ArrowLeftRight, Globe2, Scale, Users, Building, Loader2, Sparkles, AlertTriangle, RefreshCw, Wand2, Eye } from \"lucide-react\";\r\nimport { PromptDialog } from \"@/components/transparency/PromptDialog\";\r\nimport { ConfidenceBadge } from \"@/components/ui/confidence-badge\";\r\nimport dynamic from 'next/dynamic';\r\nconst LegitimacyAnalysisView = dynamic(() => import('@/components/policy/LegitimacyAnalysisView').then(mod => mod.LegitimacyAnalysisView), {\r\n    loading: () => <div className=\"h-64 w-full bg-slate-50 animate-pulse rounded-lg flex items-center justify-center text-slate-400\">Loading Analysis...</div>,\r\n    ssr: false\r\n});\r\nimport { synthesizeComparison, analyzeDocument } from \"@/services/analysis\";\r\nimport { DeepAnalysisProgressGraph, AnalysisStepStatus } from \"@/components/comparison/DeepAnalysisProgressGraph\";\r\nimport { PositionalityDialog } from \"@/components/reflexivity/PositionalityDialog\";\r\nimport { MutationTable } from \"@/components/comparison/MutationTable\";\r\nimport { StabilizationCard } from \"@/components/comparison/StabilizationCard\";\r\nimport { RhizomeNetwork } from \"@/components/comparison/RhizomeNetwork\";\r\nimport { LensSelector, InterpretationLens } from \"@/components/comparison/LensSelector\";\r\nimport { RebuttalPopover } from \"@/components/comparison/RebuttalPopover\";\r\nimport { Source, ComparativeSynthesis, PositionalityData } from \"@/types\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Copy } from \"lucide-react\"; // Or whatever icon needed\r\nimport { CulturalFramingTable } from \"@/components/policy/CulturalFramingTable\";\r\nimport { InstitutionalLogicsTable } from \"@/components/policy/InstitutionalLogicsTable\";\r\nimport { TextParser, extractKeyTakeaway } from \"@/components/ui/TextParser\";\r\n\r\nexport default function ComparisonPage() {\r\n    const { sources, isLoading, updateSource } = useSources();\r\n    const { isReadOnly } = useDemoMode();\r\n\r\n    // Filter for policy documents (non-traces)\r\n    const policyDocs = useMemo(() => sources.filter(s => s.type !== \"Trace\"), [sources]);\r\n\r\n    const [selectedDocs, setSelectedDocs] = useServerStorage<string[]>(\"comparison_selected_docs_v2\", []);\r\n    const [activeTab, setActiveTab] = useState<\"cultural\" | \"logics\" | \"legitimacy\" | \"synthesis\">(\"cultural\");\r\n    const [activeLens, setActiveLens] = useState<InterpretationLens>(\"assemblage\");\r\n    const [isSynthesizing, setIsSynthesizing] = useState(false);\r\n\r\n    // [NEW] Dynamic Persistence for Synthesis Results\r\n    const docKey = useMemo(() => selectedDocs.slice().sort().join('-'), [selectedDocs]);\r\n    const [synthesisResults, setSynthesisResults, isSynthesisLoading] = useServerStorage<Record<string, ComparativeSynthesis>>(`comparison_synthesis_${docKey}`, {});\r\n    const [synthesisError, setSynthesisError] = useState<string | null>(null);\r\n    const [forceRefresh, setForceRefresh] = useState(false);\r\n    // [TRANSPARENCY] State\r\n    const [showTransparency, setShowTransparency] = useState(false);\r\n\r\n    const [isPositionalityOpen, setIsPositionalityOpen] = useState(false);\r\n    const [analyzingSourceId, setAnalyzingSourceId] = useState<string | null>(null);\r\n    const [isDeepAnalyzing, setIsDeepAnalyzing] = useState<Record<string, boolean>>({});\r\n\r\n    // Detailed Progress Tracking\r\n    const [analysisProgress, setAnalysisProgress] = useState<Record<string, {\r\n        decolonial: AnalysisStepStatus;\r\n        cultural: AnalysisStepStatus;\r\n        logics: AnalysisStepStatus;\r\n        legitimacy: AnalysisStepStatus;\r\n        message?: string;\r\n    }>>({});\r\n\r\n    // Derived state for current lens\r\n    const currentResult = synthesisResults?.[activeLens] || null;\r\n\r\n    useEffect(() => {\r\n        // Wait for both sources and storage to load\r\n        if (isLoading || isSynthesisLoading) return;\r\n\r\n        // Auto-select first two docs\r\n        if (policyDocs.length >= 2 && selectedDocs.length === 0) {\r\n            setSelectedDocs([policyDocs[0].id, policyDocs[1].id]);\r\n        }\r\n    }, [isLoading, isSynthesisLoading, selectedDocs.length, policyDocs, setSelectedDocs]);\r\n\r\n    const selectedSources = selectedDocs\r\n        .map(id => policyDocs.find(s => s.id === id))\r\n        .filter(Boolean) as Source[];\r\n\r\n    const logicIcons = {\r\n        market: Building,\r\n        state: Scale,\r\n        professional: Users,\r\n        community: Users,\r\n    };\r\n\r\n    const logicColors = {\r\n        market: \"text-purple-600 bg-purple-100\",\r\n        state: \"text-blue-600 bg-blue-100\",\r\n        professional: \"text-green-600 bg-green-100\",\r\n        community: \"text-orange-600 bg-orange-100\",\r\n    };\r\n\r\n    const handleSynthesize = async (forceOverride?: boolean) => {\r\n        if (selectedSources.length < 2) return;\r\n\r\n        const isForced = forceOverride === true || forceRefresh === true;\r\n\r\n        // Validation: Check if all analyses are present\r\n        const missingAnalysis = selectedSources.some(\r\n            s => !s.cultural_framing || !s.institutional_logics || !s.legitimacy_analysis\r\n        );\r\n\r\n        if (missingAnalysis) {\r\n            setSynthesisError(\"All selected documents must have Cultural Framing, Institutional Logics, and Legitimacy analysis completed before synthesis.\");\r\n            return;\r\n        }\r\n\r\n        // Confirmation: Check if persistence data exists for THIS lens\r\n        // If isForced is true, we skip confirmation because user explicitly asked for it via Clear Cache or forceOverride\r\n        if (currentResult && !isForced) {\r\n            if (!confirm(`Existing ${activeLens} synthesis found. Do you want to re-run it? This will overwrite the current findings.`)) {\r\n                setActiveTab(\"synthesis\");\r\n                return;\r\n            }\r\n        }\r\n\r\n        // When forced, clear the persisted result for this lens first so the UI shows loading state\r\n        if (isForced) {\r\n            setSynthesisResults(prev => {\r\n                const next = { ...prev };\r\n                delete next[activeLens];\r\n                return next;\r\n            });\r\n        }\r\n\r\n        setSynthesisError(null);\r\n        setIsSynthesizing(true);\r\n        setActiveTab(\"synthesis\");\r\n\r\n        try {\r\n            // Prepare documents for synthesis\r\n            // Pass the forced flag\r\n            const result = await synthesizeComparison(selectedSources, activeLens, isForced);\r\n\r\n            // Update the record\r\n            setSynthesisResults(prev => {\r\n                return {\r\n                    ...prev,\r\n                    [activeLens]: result as unknown as ComparativeSynthesis\r\n                }\r\n            });\r\n\r\n            // Reset force flag\r\n            setForceRefresh(false);\r\n\r\n        } catch (error) {\r\n            console.error(\"Synthesis failed:\", error);\r\n            setSynthesisError(\"Failed to generate synthesis. Please try again.\");\r\n        } finally {\r\n            setIsSynthesizing(false);\r\n        }\r\n    };\r\n\r\n    const initiateDeepAnalysis = (sourceId: string) => {\r\n        setAnalyzingSourceId(sourceId);\r\n        setIsPositionalityOpen(true);\r\n    };\r\n\r\n    const handleRunDeepAnalysis = async (positionality: PositionalityData) => {\r\n        if (!analyzingSourceId) return;\r\n        const sourceId = analyzingSourceId;\r\n        const source = sources.find(s => s.id === sourceId);\r\n\r\n        setIsPositionalityOpen(false);\r\n        setAnalyzingSourceId(null);\r\n\r\n        if (!source || !source.extractedText) return;\r\n\r\n        setIsDeepAnalyzing(prev => ({ ...prev, [sourceId]: true }));\r\n\r\n        // Initialize Progress\r\n        setAnalysisProgress(prev => ({\r\n            ...prev,\r\n            [sourceId]: {\r\n                decolonial: 'analyzing',\r\n                cultural: 'pending',\r\n                logics: 'pending',\r\n                legitimacy: 'pending',\r\n                message: \"Calibrating Decolonial Framework...\"\r\n            }\r\n        }));\r\n\r\n        try {\r\n            // Artificial delay for the first step to show the \"Decolonial\" node active\r\n            await new Promise(r => setTimeout(r, 1500));\r\n\r\n            setAnalysisProgress(prev => ({\r\n                ...prev,\r\n                [sourceId]: { ...prev[sourceId], decolonial: 'done', cultural: 'analyzing', logics: 'analyzing', legitimacy: 'analyzing', message: \"Running Parallel Lens Analysis...\" }\r\n            }));\r\n\r\n            // Run all 3 analyses in parallel but wrapped to track individual completion if we wanted (simulated here since we await all)\r\n            // Realistically, to update progress individually, we need to not use Promise.all or wrap them.\r\n\r\n            const runMode = async (mode: 'cultural_framing' | 'institutional_logics' | 'legitimacy', stepName: 'cultural' | 'logics' | 'legitimacy') => {\r\n                const result = await analyzeDocument(\r\n                    source.extractedText!.substring(0, 50000),\r\n                    mode,\r\n                    'Policy Document',\r\n                    true,\r\n                    sourceId,\r\n                    source.title,\r\n                    positionality\r\n                );\r\n\r\n                setAnalysisProgress(prev => ({\r\n                    ...prev,\r\n                    [sourceId]: { ...prev[sourceId], [stepName]: 'done' }\r\n                }));\r\n\r\n                return { mode, result };\r\n            };\r\n\r\n            const promises = [\r\n                runMode('cultural_framing', 'cultural'),\r\n                runMode('institutional_logics', 'logics'),\r\n                runMode('legitimacy', 'legitimacy') // Note: legitimacy usually technically distinct but mapped here\r\n            ];\r\n\r\n            const results = await Promise.all(promises);\r\n\r\n            // Construct updates\r\n            const updates: Partial<Source> = {};\r\n            results.forEach(({ mode, result }) => {\r\n                if (mode === 'cultural_framing') updates.cultural_framing = result;\r\n                if (mode === 'institutional_logics') updates.institutional_logics = result;\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                if (mode === 'legitimacy') updates.legitimacy_analysis = result as any;\r\n            });\r\n\r\n            await updateSource(sourceId, updates);\r\n\r\n        } catch (error: unknown) {\r\n            console.error(\"Deep analysis failed:\", error);\r\n            const err = error as Error;\r\n            if (err.message?.includes(\"Insufficient Credits\")) {\r\n                if (confirm(\"Insufficient Credits. Would you like to top up now?\")) {\r\n                    window.location.href = \"/settings/billing\";\r\n                }\r\n            } else {\r\n                alert(`Failed to complete deep analysis: ${err.message || \"Unknown error\"}`);\r\n            }\r\n        } finally {\r\n            setIsDeepAnalyzing(prev => ({ ...prev, [sourceId]: false }));\r\n            // Clear progress after a delay\r\n            setTimeout(() => {\r\n                setAnalysisProgress(prev => {\r\n                    const next = { ...prev };\r\n                    delete next[sourceId];\r\n                    return next;\r\n                });\r\n            }, 3000);\r\n        }\r\n    };\r\n\r\n    // Helper to render the \"Run Deep Analysis\" button if data is missing\r\n    const renderAnalysisButtonOrContent = (source: Source, type: 'cultural' | 'logics' | 'legitimacy', content: React.ReactNode) => {\r\n        // [NEW] If analyzing, show the graph overlay instead of the button/empty state\r\n        if (isDeepAnalyzing[source.id]) {\r\n            const progress = analysisProgress[source.id] || { decolonial: 'pending', cultural: 'pending', logics: 'pending', legitimacy: 'pending' };\r\n            return (\r\n                <div className=\"min-h-[250px] flex items-center justify-center\">\r\n                    <DeepAnalysisProgressGraph status={progress} currentStepMessage={progress.message} />\r\n                </div>\r\n            );\r\n        }\r\n\r\n        const data = (type === 'cultural' ? source.cultural_framing :\r\n            type === 'logics' ? source.institutional_logics :\r\n                source.legitimacy_analysis) as Record<string, unknown> | undefined;\r\n\r\n        // Check if data exists AND has meaningful content (not just empty object)\r\n        const hasData = data && Object.keys(data).length > 0;\r\n\r\n        if (hasData) {\r\n            return (\r\n                <div className=\"relative group\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"absolute top-0 right-0 z-10 bg-white/50 hover:bg-white backdrop-blur-sm border border-slate-200 shadow-sm gap-2\"\r\n                        title=\"Re-run Analysis\"\r\n                        onClick={() => initiateDeepAnalysis(source.id)}\r\n                        disabled={isDeepAnalyzing[source.id] || isReadOnly}\r\n                    >\r\n                        <RefreshCw className=\"h-3 w-3 text-slate-500\" />\r\n                        <span className=\"text-xs text-slate-500\">Re-run</span>\r\n                    </Button>\r\n                    <div className=\"pt-8\">\r\n                        {content}\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // [NEW] Idle State: Show the graph structure in \"pending\" state with the start button overlay\r\n        const idleProgress: {\r\n            decolonial: AnalysisStepStatus;\r\n            cultural: AnalysisStepStatus;\r\n            logics: AnalysisStepStatus;\r\n            legitimacy: AnalysisStepStatus;\r\n        } = {\r\n            decolonial: 'pending',\r\n            cultural: 'pending',\r\n            logics: 'pending',\r\n            legitimacy: 'pending'\r\n        };\r\n\r\n        return (\r\n            <div className=\"relative min-h-[250px] bg-slate-50/50 rounded-lg border border-dashed border-slate-200 overflow-hidden group\">\r\n                {/* Background Graph (Blurred/Faded) */}\r\n                <div className=\"absolute inset-0 opacity-40 grayscale group-hover:grayscale-0 group-hover:opacity-60 transition-all duration-500 pointer-events-none\">\r\n                    <DeepAnalysisProgressGraph status={idleProgress} />\r\n                </div>\r\n\r\n                {/* Overlay Action */}\r\n                <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-white/60 backdrop-blur-[1px] group-hover:bg-white/40 transition-all z-10\">\r\n                    <Sparkles className=\"h-8 w-8 text-indigo-400 mb-3 drop-shadow-sm\" />\r\n                    <h3 className=\"text-sm font-semibold text-slate-700 mb-1\">Deep Analysis Required</h3>\r\n                    <p className=\"text-xs text-slate-500 max-w-[200px] text-center mb-4\">\r\n                        Run the entanglement process to generate {type} insights.\r\n                    </p>\r\n                    <Button\r\n                        onClick={() => initiateDeepAnalysis(source.id)}\r\n                        disabled={isDeepAnalyzing[source.id] || isReadOnly}\r\n                        className=\"bg-indigo-600 hover:bg-indigo-700 text-white shadow-md animate-in zoom-in-95 duration-300\"\r\n                        title={isReadOnly ? \"Deep analysis disabled in Demo Mode\" : \"\"}\r\n                    >\r\n                        <Wand2 className=\"mr-2 h-4 w-4\" />\r\n                        initiate Entanglement\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            <PositionalityDialog\r\n                isOpen={isPositionalityOpen}\r\n                onClose={() => setIsPositionalityOpen(false)}\r\n                onConfirm={handleRunDeepAnalysis}\r\n            />\r\n\r\n            <div>\r\n                <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">Policy Assemblages</h2>\r\n                <p className=\"text-slate-500\">Relational mapping of policy mobilities, mutations, and institutional tensions.</p>\r\n            </div>\r\n\r\n            {/* Definitions Card */}\r\n            <Card className=\"bg-slate-50 border-slate-200\">\r\n                <CardHeader className=\"pb-3\">\r\n                    <CardTitle className=\"text-base font-semibold text-slate-700\">Analysis Definitions</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 text-sm\">\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Globe2 className=\"h-4 w-4 text-blue-600\" />\r\n                            Cultural Framing\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            How a policy problem is constructed through specific cultural lenses (e.g., market-driven vs. rights-driven).\r\n                        </p>\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Scale className=\"h-4 w-4 text-purple-600\" />\r\n                            Institutional Logics\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            The organizing principles that shape behavior and decision-making (e.g., state, market, profession, community).\r\n                        </p>\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Scale className=\"h-4 w-4 text-emerald-600\" />\r\n                            Legitimacy\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            The moral justifications used to defend or critique a system (based on Boltanski & Th√©venot&apos;s Orders of Worth).\r\n                        </p>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Document Selector */}\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                        <ArrowLeftRight className=\"h-5 w-5\" />\r\n                        Select Documents to Compare\r\n                    </CardTitle>\r\n                    <CardDescription>Choose 2-3 policy documents for side-by-side analysis</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                        {[0, 1, 2].map((index) => (\r\n                            <div key={index}>\r\n                                <label className=\"text-sm font-medium text-slate-700 mb-2 block\">\r\n                                    Document {index + 1} {index > 0 && \"(Optional)\"}\r\n                                </label>\r\n                                <Select\r\n                                    value={selectedDocs[index] || \"\"}\r\n                                    onValueChange={(value) => {\r\n                                        const newSelection = [...selectedDocs];\r\n                                        newSelection[index] = value;\r\n                                        setSelectedDocs(newSelection.filter(Boolean));\r\n                                    }}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"Select document...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {policyDocs.map((doc) => (\r\n                                            <SelectItem key={doc.id} value={doc.id}>\r\n                                                {doc.title}\r\n                                                {doc.jurisdiction && (\r\n                                                    <Badge variant=\"outline\" className=\"ml-2\">\r\n                                                        {doc.jurisdiction}\r\n                                                    </Badge>\r\n                                                )}\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Analysis Type Tabs */}\r\n            {selectedSources.length >= 2 && (\r\n                <>\r\n                    <div className=\"flex gap-2\">\r\n                        <Button\r\n                            variant={activeTab === \"cultural\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"cultural\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Globe2 className=\"mr-2 h-4 w-4\" />\r\n                            Cultural Framing\r\n                        </Button>\r\n                        <Button\r\n                            variant={activeTab === \"logics\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"logics\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Scale className=\"mr-2 h-4 w-4\" />\r\n                            Institutional Logics\r\n                        </Button>\r\n                        <Button\r\n                            variant={activeTab === \"legitimacy\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"legitimacy\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Scale className=\"mr-2 h-4 w-4\" />\r\n                            Legitimacy\r\n                        </Button>\r\n\r\n                        <div className=\"flex-1 flex gap-2\">\r\n                            <Button\r\n                                variant={activeTab === \"synthesis\" ? \"default\" : \"outline\"}\r\n                                onClick={() => {\r\n                                    if (currentResult) {\r\n                                        // If results exist, just switch to the tab\r\n                                        setActiveTab(\"synthesis\");\r\n                                    } else {\r\n                                        // Otherwise, run synthesis\r\n                                        handleSynthesize();\r\n                                    }\r\n                                }}\r\n                                disabled={isSynthesizing || isReadOnly}\r\n                                title={isReadOnly ? \"Synthesis disabled in Demo Mode\" : \"\"}\r\n                                className=\"flex-1 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border-indigo-200\">\r\n                                {isSynthesizing ? (\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                ) : (\r\n                                    <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                )}\r\n                                {currentResult ? \"View Synthesis\" : \"Synthesize\"}\r\n                            </Button>\r\n                            {(currentResult || isSynthesizing) && (\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    size=\"icon\"\r\n                                    onClick={() => handleSynthesize(true)}\r\n                                    disabled={isReadOnly || isSynthesizing}\r\n                                    title={isReadOnly ? \"Cache clearing disabled in Demo Mode\" : \"Clear Cache & Re-run Synthesis\"}\r\n                                    className={`text-slate-400 hover:text-red-600 shrink-0 ${isSynthesizing ? 'animate-spin' : ''}`}\r\n                                >\r\n                                    <RefreshCw className=\"h-4 w-4\" />\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {synthesisError && (\r\n                        <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md flex items-center gap-2 text-sm\">\r\n                            <AlertTriangle className=\"h-4 w-4\" />\r\n                            {synthesisError}\r\n                        </div>\r\n                    )}\r\n\r\n                    {activeTab === \"cultural\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card className=\"border-slate-200 shadow-sm\">\r\n                                <CardHeader className=\"pb-4\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <div>\r\n                                            <CardTitle>Cultural Framing Comparison</CardTitle>\r\n                                            <CardDescription>\r\n                                                Comparing the deep cultural assumptions across jurisdictions.\r\n                                            </CardDescription>\r\n                                        </div>\r\n                                    </div>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <Tabs defaultValue=\"state_market_society\" className=\"w-full\">\r\n                                        <div className=\"overflow-x-auto pb-2 mb-4\">\r\n                                            <TabsList className=\"bg-slate-100/50 p-1 w-full md:w-auto flex md:inline-flex justify-start\">\r\n                                                <TabsTrigger value=\"state_market_society\">State-Market Relations</TabsTrigger>\r\n                                                <TabsTrigger value=\"technology_role\">Technology Role</TabsTrigger>\r\n                                                <TabsTrigger value=\"rights_conception\">Rights Conception</TabsTrigger>\r\n                                                <TabsTrigger value=\"historical_context\">Historical Context</TabsTrigger>\r\n                                                <TabsTrigger value=\"epistemic_authority\">Epistemic Authority</TabsTrigger>\r\n                                            </TabsList>\r\n                                        </div>\r\n\r\n                                        {([\"state_market_society\", \"technology_role\", \"rights_conception\", \"historical_context\", \"epistemic_authority\"] as const).map((dimension) => (\r\n                                            <TabsContent key={dimension} value={dimension} className=\"mt-0 focus-visible:ring-0\">\r\n                                                <CulturalFramingTable dimension={dimension} sources={selectedSources} />\r\n                                            </TabsContent>\r\n                                        ))}\r\n                                    </Tabs>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Institutional Logics Comparison */}\r\n                    {activeTab === \"logics\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>Institutional Logics Comparison</CardTitle>\r\n                                    <CardDescription>\r\n                                        Which institutional logics dominate in each jurisdiction?\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <InstitutionalLogicsTable sources={selectedSources} />\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Legitimacy Analysis Comparison */}\r\n                    {activeTab === \"legitimacy\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>Legitimacy & Justification Comparison</CardTitle>\r\n                                    <CardDescription>\r\n                                        Compare the moral arguments and orders of worth used in each jurisdiction.\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                                        {selectedSources.map((source, idx) => (\r\n                                            <div key={idx} className=\"space-y-4\">\r\n                                                <div className=\"flex items-center justify-between border-b pb-2\">\r\n                                                    <h3 className=\"font-semibold text-lg\">{source.title}</h3>\r\n                                                </div>\r\n                                                {renderAnalysisButtonOrContent(source, 'legitimacy', (\r\n                                                    source.legitimacy_analysis ? (\r\n                                                        <LegitimacyAnalysisView analysis={source.legitimacy_analysis} />\r\n                                                    ) : null\r\n                                                ))}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Comparative Synthesis Tab */}\r\n                    {activeTab === \"synthesis\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card className=\"border-indigo-100 shadow-sm\">\r\n                                <CardHeader className=\"bg-indigo-50/50\">\r\n                                    <CardTitle className=\"text-indigo-900 flex items-center gap-2\">\r\n                                        <Sparkles className=\"h-5 w-5 text-indigo-600\" />\r\n                                        Comparative Synthesis\r\n                                    </CardTitle>\r\n                                    <CardDescription>\r\n                                        AI-generated synthesis of cultural, institutional, and legitimacy dynamics across jurisdictions.\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent className=\"pt-6\">\r\n                                    {!currentResult && !isSynthesizing && (\r\n                                        <div className=\"text-center py-12 text-slate-500\">\r\n                                            <Sparkles className=\"h-12 w-12 mx-auto mb-4 text-slate-300\" />\r\n                                            <p className=\"font-medium text-slate-700\">No {activeLens} analysis generated yet</p>\r\n                                            <p className=\"text-sm mt-2 max-w-sm mx-auto\">\r\n                                                Each interpretation lens requires a separate AI analysis. Click &quot;Synthesize&quot; to generate findings specifically for the <strong>{activeLens}</strong> perspective.\r\n                                            </p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {isSynthesizing && (\r\n                                        <div className=\"text-center py-12 text-slate-500\">\r\n                                            <Loader2 className=\"h-12 w-12 mx-auto mb-4 animate-spin text-indigo-500\" />\r\n                                            <p>Synthesizing analysis across {selectedSources.length} documents...</p>\r\n                                            <p className=\"text-xs text-slate-400 mt-2\">This may take a minute.</p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {currentResult && (\r\n                                        <div className=\"space-y-8 animate-in fade-in duration-500\">\r\n\r\n                                            {/* [TRANSPARENCY] Transparency Dialog */}\r\n                                            <PromptDialog\r\n                                                open={showTransparency}\r\n                                                onOpenChange={setShowTransparency}\r\n                                                metadata={currentResult.metadata}\r\n                                                provenance={undefined} // Provenance not yet tracked for synthesis\r\n                                            />\r\n\r\n                                            {/* [TRANSPARENCY] Banner */}\r\n                                            {currentResult.metadata && (\r\n                                                <div className=\"flex items-center gap-3 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg\">\r\n                                                    <div className=\"flex-1\">\r\n                                                        <h4 className=\"text-sm font-semibold text-indigo-900 mb-1\">AI Transparency</h4>\r\n                                                        <p className=\"text-xs text-indigo-700\">View the exact prompt used for this synthesis</p>\r\n                                                    </div>\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        {currentResult.confidence && (\r\n                                                            <ConfidenceBadge confidence={currentResult.confidence} />\r\n                                                        )}\r\n                                                        <Button\r\n                                                            onClick={() => setShowTransparency(true)}\r\n                                                            variant=\"outline\"\r\n                                                            size=\"sm\"\r\n                                                            className=\"bg-white hover:bg-indigo-50 border-indigo-300\"\r\n                                                        >\r\n                                                            <Eye className=\"h-4 w-4 mr-2\" />\r\n                                                            Show Prompt\r\n                                                        </Button>\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                            {/* Top Bar: Lens Selector */}\r\n                                            <div className=\"flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200\">\r\n                                                <div className=\"text-sm font-medium text-slate-600\">Active Interpretation Lens:</div>\r\n                                                <LensSelector currentLens={activeLens} onLensChange={setActiveLens} />\r\n                                            </div>\r\n\r\n                                            {/* Executive Summary with Assemblage Tone */}\r\n                                            <div className=\"bg-gradient-to-br from-indigo-50 to-white p-6 rounded-xl border border-indigo-100 shadow-sm\">\r\n                                                <h3 className=\"text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2\">\r\n                                                    <Sparkles className=\"h-5 w-5 text-indigo-600\" />\r\n                                                    Relational Summary\r\n                                                </h3>\r\n                                                <RebuttalPopover targetId=\"summary\" initialRebuttal=\"\" onSave={(id, txt) => console.log(id, txt)}>\r\n                                                    <div className=\"prose prose-slate max-w-none text-slate-700 leading-relaxed cursor-pointer hover:bg-white/50 transition-colors rounded p-2 -ml-2\">\r\n                                                        <p className=\"whitespace-pre-wrap\">{currentResult.synthesis_summary}</p>\r\n                                                    </div>\r\n                                                </RebuttalPopover>\r\n                                            </div>\r\n\r\n                                            {/* Network & Stabilization Row */}\r\n                                            <div className=\"grid lg:grid-cols-3 gap-6 min-h-[400px]\">\r\n                                                <div className=\"lg:col-span-2 h-full\">\r\n                                                    <RhizomeNetwork network={currentResult.assemblage_network!} />\r\n                                                </div>\r\n                                                <div className=\"h-full\">\r\n                                                    {currentResult.stabilization_mechanisms && (\r\n                                                        <StabilizationCard mechanisms={currentResult.stabilization_mechanisms} />\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Mutation Table */}\r\n                                            {currentResult.concept_mutations && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <MutationTable mutations={currentResult.concept_mutations} />\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Friction & Desire */}\r\n                                            {currentResult.desire_and_friction && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <h3 className=\"text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2\">\r\n                                                        <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\r\n                                                        Friction & Desire\r\n                                                    </h3>\r\n                                                    <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                                                        {currentResult.desire_and_friction.map((item, i) => (\r\n                                                            <div key={i} className=\"flex flex-col p-5 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group\">\r\n                                                                <div className=\"absolute top-0 left-0 w-1 h-full bg-amber-400 group-hover:w-2 transition-all\" />\r\n                                                                <div className=\"text-[10px] font-bold uppercase tracking-wider text-amber-600 mb-2\">{item.topic}</div>\r\n                                                                <div className=\"font-semibold text-slate-900 mb-3 leading-snug\">{item.friction_point}</div>\r\n                                                                <div className=\"mt-auto pt-3 border-t border-slate-100\">\r\n                                                                    <span className=\"text-xs text-slate-400 uppercase font-semibold\">Underlying Desire</span>\r\n                                                                    <div className=\"text-sm font-medium text-indigo-700 mt-0.5\">{item.underlying_desire}</div>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Institutional Conflicts */}\r\n                                            {currentResult.institutional_conflict && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <h3 className=\"text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2\">\r\n                                                        <Building className=\"h-5 w-5 text-purple-600\" />\r\n                                                        Institutional Conflicts\r\n                                                    </h3>\r\n                                                    <div className=\"grid md:grid-cols-2 gap-4\">\r\n                                                        {currentResult.institutional_conflict?.map((conf, i) => (\r\n                                                            <Card key={i} className=\"border-purple-100 bg-purple-50/30 hover:bg-purple-50/50 transition-colors\">\r\n                                                                <CardHeader className=\"pb-2\">\r\n                                                                    <CardTitle className=\"text-base font-bold text-purple-900\">{conf.conflict_type}</CardTitle>\r\n                                                                    <CardDescription className=\"text-slate-700\">{conf.description}</CardDescription>\r\n                                                                </CardHeader>\r\n                                                                <CardContent className=\"space-y-3 text-sm\">\r\n                                                                    {conf.evidence?.map((ev, eIdx) => (\r\n                                                                        <div key={eIdx} className=\"flex gap-2 items-start\">\r\n                                                                            <Badge variant=\"outline\" className=\"shrink-0 text-[10px] px-1.5 py-0 h-5 mt-0.5 bg-white border-purple-200 text-purple-700\">\r\n                                                                                {ev.policy}\r\n                                                                            </Badge>\r\n                                                                            <span className=\"italic text-slate-600 leading-snug\">&quot;{ev.text}&quot;</span>\r\n                                                                        </div>\r\n                                                                    ))}\r\n                                                                </CardContent>\r\n                                                            </Card>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Legitimacy Tensions */}\r\n                                            <div>\r\n                                                <h3 className=\"text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2\">\r\n                                                    <Scale className=\"h-5 w-5 text-emerald-600\" />\r\n                                                    Legitimacy Tensions\r\n                                                </h3>\r\n                                                <div className=\"grid gap-4\">\r\n                                                    {currentResult.legitimacy_tensions?.map((tens, i) => (\r\n                                                        <Card key={i} className=\"border-emerald-100 bg-emerald-50/30\">\r\n                                                            <CardHeader className=\"pb-2\">\r\n                                                                <CardTitle className=\"text-base font-bold text-emerald-900\">{tens.tension_type}</CardTitle>\r\n                                                                <CardDescription className=\"text-slate-700\">{tens.description}</CardDescription>\r\n                                                            </CardHeader>\r\n                                                            <CardContent className=\"space-y-3 text-sm\">\r\n                                                                {tens.evidence?.map((ev, eIdx) => (\r\n                                                                    <div key={eIdx} className=\"flex gap-2 items-start\">\r\n                                                                        <Badge variant=\"outline\" className=\"shrink-0 text-[10px] px-1.5 py-0 h-5 mt-0.5 bg-white border-emerald-200 text-emerald-700\">\r\n                                                                            {ev.policy}\r\n                                                                        </Badge>\r\n                                                                        <span className=\"italic text-slate-600 leading-snug\">&quot;{ev.text}&quot;</span>\r\n                                                                    </div>\r\n                                                                ))}\r\n                                                            </CardContent>\r\n                                                        </Card>\r\n                                                    ))}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Coloniality Assessment */}\r\n                                            {currentResult.coloniality_assessment && (\r\n                                                <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-6\">\r\n                                                    <h3 className=\"text-lg font-bold text-amber-900 mb-2 flex items-center gap-2\">\r\n                                                        <AlertTriangle className=\"h-5 w-5\" />\r\n                                                        Coloniality Assessment\r\n                                                    </h3>\r\n                                                    <p className=\"text-amber-800 leading-relaxed\">\r\n                                                        {currentResult.coloniality_assessment}\r\n                                                    </p>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {selectedSources.length < 2 && (\r\n                                        <Card className=\"bg-slate-50 border-dashed\">\r\n                                            <CardContent className=\"pt-6 text-center text-slate-500\">\r\n                                                <Globe2 className=\"h-12 w-12 mx-auto mb-4 text-slate-400\" />\r\n                                                <p>Select at least 2 documents above to begin comparing</p>\r\n                                            </CardContent>\r\n                                        </Card>\r\n                                    )}\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            )\r\n            }\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\CulturalFramingCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":162,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6818,6821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6818,6821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10788,10791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10788,10791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11227,11230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11227,11230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11486,11489],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11486,11489],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":242,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":242,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11801,11804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11801,11804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport {\r\n    Accordion,\r\n    AccordionContent,\r\n    AccordionItem,\r\n    AccordionTrigger,\r\n} from \"@/components/ui/accordion\";\r\nimport { ConceptNetworkGraph } from './ConceptNetworkGraph';\r\nimport { AnalysisResult } from '@/types';\r\nimport {\r\n    VolumeX,\r\n    Quote,\r\n    Landmark,\r\n    Cpu,\r\n    Scale,\r\n    BookOpen,\r\n    GraduationCap,\r\n    Shield,\r\n    AlertTriangle,\r\n    Eye,\r\n} from 'lucide-react';\r\nimport { TextParser } from '@/components/ui/TextParser';\r\n\r\ninterface CulturalFramingCardProps {\r\n    result: AnalysisResult;\r\n}\r\n\r\n// --- Dimension Metadata ---\r\nconst DIMENSIONS = [\r\n    { key: 'state_market_society', label: 'State / Market / Society', icon: Landmark, color: 'amber' },\r\n    { key: 'technology_role', label: 'Technology Role', icon: Cpu, color: 'blue' },\r\n    { key: 'rights_conception', label: 'Rights Conception', icon: Scale, color: 'emerald' },\r\n    { key: 'historical_context', label: 'Historical Context', icon: BookOpen, color: 'rose' },\r\n    { key: 'epistemic_authority', label: 'Epistemic Authority', icon: GraduationCap, color: 'indigo' },\r\n    { key: 'enforcement_culture', label: 'Enforcement Culture', icon: Shield, color: 'slate' },\r\n] as const;\r\n\r\ntype DimensionKey = typeof DIMENSIONS[number]['key'];\r\n\r\n// --- Bullet Parser ---\r\ninterface ParsedBullet {\r\n    mainText: string;\r\n    mechanism?: string;\r\n    rhetoric?: string;\r\n    pageRefs: string[];\r\n}\r\n\r\nfunction parseBullets(raw: string | undefined | null): ParsedBullet[] {\r\n    if (!raw) return [];\r\n    const bullets = raw.split('‚Ä¢').map(b => b.trim()).filter(Boolean);\r\n    return bullets.map(bullet => {\r\n        let mainText = bullet;\r\n        let mechanism: string | undefined;\r\n        let rhetoric: string | undefined;\r\n        const pageRefs: string[] = [];\r\n\r\n        // Extract (Mechanism: ...) \r\n        const mechMatch = mainText.match(/\\(Mechanism:\\s*([^)]+)\\)/i);\r\n        if (mechMatch) {\r\n            mechanism = mechMatch[1].trim();\r\n            mainText = mainText.replace(mechMatch[0], '');\r\n        }\r\n\r\n        // Extract (Rhetoric: ...) \r\n        const rhetMatch = mainText.match(/\\(Rhetoric:\\s*\"?([^\")\\n]+)\"?\\)/i);\r\n        if (rhetMatch) {\r\n            rhetoric = rhetMatch[1].trim();\r\n            mainText = mainText.replace(rhetMatch[0], '');\r\n        }\r\n\r\n        // Extract (Page N, ...) \r\n        const pageMatches = mainText.matchAll(/\\(Page\\s+\\d+[^)]*\\)/gi);\r\n        for (const m of pageMatches) {\r\n            pageRefs.push(m[0].replace(/[()]/g, ''));\r\n            mainText = mainText.replace(m[0], '');\r\n        }\r\n\r\n        // Clean up multiple spaces / dashes\r\n        mainText = mainText.replace(/\\s{2,}/g, ' ').replace(/\\s*‚Äì\\s*$/, '').trim();\r\n\r\n        return { mainText, mechanism, rhetoric, pageRefs };\r\n    });\r\n}\r\n\r\n// --- Distinctiveness Gauge ---\r\nfunction DistinctivenessGauge({ score }: { score: number | undefined | null }) {\r\n    const value = typeof score === 'number' ? Math.max(0, Math.min(1, score)) : null;\r\n    if (value === null) return null;\r\n\r\n    const pct = Math.round(value * 100);\r\n    const label = value < 0.33 ? 'Low' : value < 0.66 ? 'Mid' : 'High';\r\n    const barColor = value < 0.33 ? 'bg-slate-400' : value < 0.66 ? 'bg-amber-500' : 'bg-emerald-500';\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-3\" aria-label={`Cultural Distinctiveness: ${label} (${pct}%)`}>\r\n            <span className=\"text-[10px] font-bold uppercase tracking-wider text-slate-400 whitespace-nowrap\">\r\n                Distinctiveness\r\n            </span>\r\n            <div className=\"flex-1 h-2 bg-slate-100 rounded-full overflow-hidden max-w-[120px]\">\r\n                <div\r\n                    className={`h-full rounded-full transition-all duration-500 ${barColor}`}\r\n                    style={{ width: `${pct}%` }}\r\n                />\r\n            </div>\r\n            <Badge variant=\"outline\" className=\"text-[10px] font-semibold\">\r\n                {label} ({pct}%)\r\n            </Badge>\r\n        </div>\r\n    );\r\n}\r\n\r\n// --- Dimension Tab Content ---\r\nfunction DimensionContent({ bullets }: { bullets: ParsedBullet[] }) {\r\n    if (bullets.length === 0) {\r\n        return <p className=\"text-xs text-slate-400 italic py-3\">No analysis available for this dimension.</p>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-3 py-2\">\r\n            {bullets.map((b, i) => (\r\n                <div key={i} className=\"bg-white rounded-md border border-slate-100 p-3 shadow-sm hover:shadow transition-shadow\">\r\n                    <TextParser text={b.mainText} className=\"space-y-1 [&_li]:text-xs [&_li]:leading-relaxed [&_li]:text-slate-700 [&_span.text-indigo-300]:hidden\" />\r\n                    {(b.mechanism || b.rhetoric) && (\r\n                        <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                            {b.mechanism && (\r\n                                <span className=\"inline-flex items-center gap-1 text-[10px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full border border-blue-100\">\r\n                                    <Eye className=\"h-2.5 w-2.5\" /> Mechanism: {b.mechanism}\r\n                                </span>\r\n                            )}\r\n                            {b.rhetoric && (\r\n                                <span className=\"inline-flex items-center gap-1 text-[10px] bg-purple-50 text-purple-700 px-2 py-0.5 rounded-full border border-purple-100\">\r\n                                    <Quote className=\"h-2.5 w-2.5\" /> Rhetoric: &ldquo;{b.rhetoric}&rdquo;\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n                    {b.pageRefs.length > 0 && (\r\n                        <div className=\"mt-1.5 flex flex-wrap gap-1\">\r\n                            {b.pageRefs.map((ref, j) => (\r\n                                <span key={j} className=\"text-[9px] text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded\">\r\n                                    {ref}\r\n                                </span>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n\r\n// --- Main Component ---\r\nexport function CulturalFramingCard({ result }: CulturalFramingCardProps) {\r\n    const summary = result.plain_language_summary;\r\n    const dominantLabel = summary?.dominant_cultural_logic?.label || result.dominant_cultural_logic || 'Undetermined';\r\n    const dominantExplanation = summary?.dominant_cultural_logic?.explanation;\r\n\r\n    // Memoize parsed dimension data\r\n    const parsedDimensions = useMemo(() => {\r\n        const map: Record<DimensionKey, ParsedBullet[]> = {} as any;\r\n        for (const dim of DIMENSIONS) {\r\n            const raw = result[dim.key as keyof AnalysisResult] as string | undefined;\r\n            map[dim.key] = parseBullets(raw);\r\n        }\r\n        return map;\r\n    }, [result]);\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* 1. Executive Summary / One-Sentence Overview */}\r\n            {summary?.one_sentence_overview && (\r\n                <div className=\"bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-md p-3\">\r\n                    <span className=\"text-[10px] font-bold text-amber-700 uppercase tracking-wider block mb-1\">\r\n                        Overview\r\n                    </span>\r\n                    <p className=\"text-xs leading-relaxed text-amber-900\">\r\n                        {summary.one_sentence_overview}\r\n                    </p>\r\n                </div>\r\n            )}\r\n\r\n            {/* 2. Dominant Cultural Logic + Distinctiveness */}\r\n            <div className=\"flex flex-col sm:flex-row gap-3\">\r\n                <div className=\"flex-1 bg-amber-50 border border-amber-100 rounded-md p-3\">\r\n                    <span className=\"text-xs font-bold text-amber-800 uppercase tracking-wide block mb-1\">\r\n                        Dominant Cultural Logic\r\n                    </span>\r\n                    <p className=\"font-semibold text-amber-900 leading-tight text-sm\">\r\n                        {dominantLabel}\r\n                    </p>\r\n                    {dominantExplanation && (\r\n                        <p className=\"text-xs text-amber-700 mt-1.5 leading-relaxed\">\r\n                            {dominantExplanation}\r\n                        </p>\r\n                    )}\r\n                </div>\r\n                <div className=\"sm:w-56 flex items-center sm:items-end\">\r\n                    <DistinctivenessGauge score={result.cultural_distinctiveness_score} />\r\n                </div>\r\n            </div>\r\n\r\n            {/* 3. Key Points Accordion */}\r\n            {summary?.key_points && summary.key_points.length > 0 && (\r\n                <div className=\"border border-slate-200 rounded-lg overflow-hidden\">\r\n                    <div className=\"bg-slate-50 px-3 py-2 border-b border-slate-100\">\r\n                        <span className=\"text-xs font-bold text-slate-600 uppercase tracking-wide\">\r\n                            Key Findings ({summary.key_points.length})\r\n                        </span>\r\n                    </div>\r\n                    <Accordion type=\"single\" collapsible className=\"w-full\">\r\n                        {summary.key_points.map((kp) => (\r\n                            <AccordionItem key={kp.number} value={`kp-${kp.number}`} className=\"border-b border-slate-100 last:border-0\">\r\n                                <AccordionTrigger className=\"px-3 py-2.5 text-xs font-semibold text-slate-800 hover:text-amber-700 hover:no-underline [&[data-state=open]]:text-amber-700\">\r\n                                    <span className=\"flex items-center gap-2 text-left\">\r\n                                        <span className=\"shrink-0 w-5 h-5 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center text-[10px] font-bold\">\r\n                                            {kp.number}\r\n                                        </span>\r\n                                        {kp.heading}\r\n                                    </span>\r\n                                </AccordionTrigger>\r\n                                <AccordionContent className=\"px-3 pb-3\">\r\n                                    <div className=\"space-y-2 pl-7\">\r\n                                        {kp.paragraphs?.map((p, i) => (\r\n                                            <p key={i} className=\"text-xs leading-relaxed text-slate-600\">{p}</p>\r\n                                        ))}\r\n                                    </div>\r\n                                    {/* Evidence strip */}\r\n                                    {(kp as any).evidence && (\r\n                                        <div className=\"mt-2 pl-7 pt-2 border-t border-slate-100\">\r\n                                            <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1\">Evidence</span>\r\n                                            <p className=\"text-[10px] text-slate-500 leading-relaxed italic\">\r\n                                                {(kp as any).evidence}\r\n                                            </p>\r\n                                        </div>\r\n                                    )}\r\n                                    {/* Summary callout */}\r\n                                    {(kp as any).summary && (\r\n                                        <div className=\"mt-2 pl-7 bg-amber-50/50 rounded p-2 border-l-2 border-amber-300\">\r\n                                            <p className=\"text-[10px] font-medium text-amber-800 leading-relaxed\">\r\n                                                {(kp as any).summary}\r\n                                            </p>\r\n                                        </div>\r\n                                    )}\r\n                                </AccordionContent>\r\n                            </AccordionItem>\r\n                        ))}\r\n                    </Accordion>\r\n                </div>\r\n            )}\r\n\r\n            {/* 4. Dimension Deep-Dive Tabs */}\r\n            {Object.values(parsedDimensions).some(bullets => bullets.length > 0) && (\r\n                <div className=\"border border-slate-200 rounded-lg overflow-hidden bg-slate-50/30\">\r\n                    <div className=\"bg-slate-50 px-3 py-2 border-b border-slate-100\">\r\n                        <span className=\"text-xs font-bold text-slate-600 uppercase tracking-wide\">\r\n                            Dimension Deep-Dive\r\n                        </span>\r\n                    </div>\r\n                    <Tabs defaultValue={DIMENSIONS[0].key} className=\"w-full\">\r\n                        <TabsList className=\"w-full h-auto flex flex-wrap gap-0 rounded-none bg-white border-b border-slate-100 p-0\">\r\n                            {DIMENSIONS.map((dim) => {\r\n                                const Icon = dim.icon;\r\n                                const count = parsedDimensions[dim.key].length;\r\n                                return (\r\n                                    <TabsTrigger\r\n                                        key={dim.key}\r\n                                        value={dim.key}\r\n                                        className=\"flex-1 min-w-[120px] rounded-none border-b-2 border-transparent data-[state=active]:border-amber-500 data-[state=active]:bg-amber-50/50 data-[state=active]:shadow-none py-2 px-2 text-[11px] gap-1\"\r\n                                    >\r\n                                        <Icon className=\"h-3 w-3\" />\r\n                                        <span className=\"hidden sm:inline\">{dim.label}</span>\r\n                                        <span className=\"sm:hidden\">{dim.label.split(' ')[0]}</span>\r\n                                        {count > 0 && (\r\n                                            <span className=\"text-[9px] text-slate-400 ml-0.5\">({count})</span>\r\n                                        )}\r\n                                    </TabsTrigger>\r\n                                );\r\n                            })}\r\n                        </TabsList>\r\n                        {DIMENSIONS.map((dim) => (\r\n                            <TabsContent key={dim.key} value={dim.key} className=\"px-3 pb-3 mt-0\">\r\n                                <DimensionContent bullets={parsedDimensions[dim.key]} />\r\n                            </TabsContent>\r\n                        ))}\r\n                    </Tabs>\r\n                </div>\r\n            )}\r\n\r\n            {/* 5. Silenced Voices */}\r\n            {(result.silenced_voices?.length || summary?.silenced_voices_detailed) && (\r\n                <div className=\"border border-red-100 rounded-lg bg-red-50/30 p-3\">\r\n                    <span className=\"text-xs font-bold text-red-600 uppercase tracking-wider block mb-2 flex items-center gap-1\">\r\n                        <VolumeX className=\"h-3 w-3\" /> Silenced Voices\r\n                    </span>\r\n                    {result.silenced_voices && result.silenced_voices.length > 0 && (\r\n                        <ul className=\"space-y-1 mb-2\">\r\n                            {result.silenced_voices.map((voice, idx) => (\r\n                                <li key={idx} className=\"text-xs text-red-800 font-medium flex items-start gap-2\">\r\n                                    <AlertTriangle className=\"h-3 w-3 text-red-400 mt-0.5 shrink-0\" />\r\n                                    {voice}\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    )}\r\n                    {summary?.silenced_voices_detailed && (\r\n                        <details className=\"group\">\r\n                            <summary className=\"text-[10px] font-medium text-red-500 cursor-pointer hover:text-red-700 select-none transition-colors w-fit\">\r\n                                <span className=\"group-open:hidden\">+ View detailed analysis</span>\r\n                                <span className=\"hidden group-open:inline\">Hide detailed analysis</span>\r\n                            </summary>\r\n                            <p className=\"mt-2 text-xs text-red-800/80 leading-relaxed bg-white/60 rounded p-2 border border-red-100\">\r\n                                {summary.silenced_voices_detailed}\r\n                            </p>\r\n                        </details>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* 6. Concept Network Graph */}\r\n            {result.concept_map && result.concept_map.nodes?.length > 0 && (\r\n                <div className=\"border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm\">\r\n                    <div className=\"bg-slate-50 px-3 py-2 border-b border-slate-100 flex justify-between items-center\">\r\n                        <span className=\"text-xs font-bold text-slate-500 uppercase tracking-wide\">\r\n                            Cultural Logic Network\r\n                        </span>\r\n                        <span className=\"text-[10px] text-slate-400\">\r\n                            {result.concept_map.nodes.length} Nodes ¬∑ {result.concept_map.edges?.length || 0} Edges\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"h-[500px] w-full relative\">\r\n                        <ConceptNetworkGraph data={result.concept_map} />\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]}]
