[{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\check-urls.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-clear-artifacts.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nasync function clearBrokenArtifacts() {\r\n    const redis = new Redis(process.env.REDIS_URL);\r\n    const KEY = 'user:demo-user:storage:resistance_artifacts';\r\n\r\n    console.log(`\\nðŸ§¹ Clearing Broken Artifacts from: ${KEY}\\n`);\r\n\r\n    try {\r\n        await redis.del(KEY);\r\n        console.log(\"âœ… Key deleted. The list should now be empty.\");\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\nclearBrokenArtifacts();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-demo-mode.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nconsole.log(\"NEXT_PUBLIC_ENABLE_DEMO_MODE:\", process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE);\r\nconsole.log(\"NEXT_PUBLIC_DEMO_USER_ID:\", process.env.NEXT_PUBLIC_DEMO_USER_ID);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-env-redis.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nconsole.log(\"REDIS_URL present:\", !!process.env.REDIS_URL);\r\nif (process.env.REDIS_URL) {\r\n    console.log(\"REDIS_URL value preview:\", process.env.REDIS_URL.substring(0, 15) + \"...\");\r\n} else {\r\n    console.log(\"REDIS_URL is NOT set (using default localhost)\");\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-env.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\n// Explicitly load from absolute path\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\nconst result = dotenv.config({ path: envPath });\r\n\r\nif (result.error) {\r\n    console.error(\"Error loading .env.local:\", result.error);\r\n}\r\n\r\nconsole.log(\"Loading env from:\", envPath);\r\nconsole.log(\"GOOGLE_SEARCH_API_KEY present:\", !!process.env.GOOGLE_SEARCH_API_KEY);\r\nconsole.log(\"GOOGLE_SEARCH_CX present:\", !!process.env.GOOGLE_SEARCH_CX);\r\n\r\nif (process.env.GOOGLE_SEARCH_API_KEY) {\r\n    console.log(\"Key length:\", process.env.GOOGLE_SEARCH_API_KEY.length);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-find-keys.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nasync function sync() {\r\n    const redis = new Redis(process.env.REDIS_URL);\r\n    // Move user:demo-user... to user:user_364D6LE... OR vice versa?\r\n    // User wants VERCEL docs on LOCALHOST.\r\n    // Vercel = Real User (user_364...)\r\n    // Localhost = Demo User (demo-user)\r\n    // So we copy FROM Real User TO Demo User.\r\n\r\n    // BUT script said \"Source data not found\" for Real User.\r\n    // This implies the Real User ALSO doesn't have data in the standard key?\r\n    // OR my hardcoded ID was wrong.\r\n\r\n    // Let's copy from 'user:demo-user:storage:sources' (which has the local migration) \r\n    // TO 'user:user_364D6LEBTCeN6mgbSfR8h3TrMdp:storage:sources' just in case they log in?\r\n    // No, user wants the opposite.\r\n\r\n    // Wait, the previous migration moved Local -> Remote as 'user:demo-user:storage:sources'.\r\n    // If Vercel has documents, they are under 'user:user_364...'.\r\n    // If they are missing there, then Vercel is empty too?\r\n\r\n    // Let's just list ALL 'sources' keys.\r\n    const keys = await redis.keys('*:sources');\r\n    console.log(\"Found source keys:\", keys);\r\n\r\n    redis.disconnect();\r\n}\r\nsync();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-inspect-artifacts.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nasync function inspectArtifacts() {\r\n    const redis = new Redis(process.env.REDIS_URL);\r\n    const KEY = 'user:demo-user:storage:resistance_artifacts';\r\n\r\n    console.log(`\\nðŸ” Inspecting Key: ${KEY}\\n`);\r\n\r\n    try {\r\n        const raw = await redis.get(KEY);\r\n        if (!raw) {\r\n            console.log(\"âŒ Key not found!\");\r\n            return;\r\n        }\r\n\r\n        const artifacts = JSON.parse(raw);\r\n        console.log(`âœ… Found ${artifacts.length} artifacts.\\n`);\r\n\r\n        artifacts.forEach((a, i) => {\r\n            console.log(`[Artifact ${i}] ID: ${a.id}`);\r\n            console.log(`  Title: \"${a.title}\"`);\r\n            console.log(`  Values in 'text' field: ${a.text ? a.text.length + ' chars' : 'UNDEFINED/NULL'}`);\r\n            if (!a.text) {\r\n                console.log(\"  ðŸ›‘ CRITICAL: 'text' field is missing or empty!\");\r\n            }\r\n            // console.log(JSON.stringify(a, null, 2)); // Uncomment for full dump\r\n        });\r\n\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\ninspectArtifacts();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-real-search.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":18},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":36}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"require('dotenv').config({ path: '.env.local' });\r\nconst fetch = require('node-fetch');\r\n\r\nasync function debugSearch() {\r\n    const apiKey = process.env.GOOGLE_SEARCH_API_KEY;\r\n    const cx = process.env.GOOGLE_SEARCH_CX;\r\n    const query = \"AI Act resistance manifesto filetype:pdf\";\r\n\r\n    if (!apiKey || !cx) {\r\n        console.error(\"âŒ Keys not found in .env.local\");\r\n        return;\r\n    }\r\n\r\n    console.log(`Using Key: ${apiKey.substring(0, 5)}...`);\r\n    console.log(`Using CX: ${cx}`);\r\n    console.log(`Query: ${query}`);\r\n\r\n    const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;\r\n\r\n    try {\r\n        const response = await fetch(url);\r\n        const data = await response.json();\r\n\r\n        if (data.error) {\r\n            console.error(\"API Error:\", data.error);\r\n            return;\r\n        }\r\n\r\n        console.log(`Total Results: ${data.searchInformation?.totalResults}`);\r\n\r\n        if (data.items) {\r\n            data.items.slice(0, 3).forEach((item, i) => {\r\n                console.log(`\\n[${i + 1}] ${item.title}`);\r\n                console.log(`    Link: ${item.link}`);\r\n                console.log(`    Snippet: ${item.snippet}`);\r\n            });\r\n        } else {\r\n            console.log(\"No items returned.\");\r\n        }\r\n\r\n    } catch (e) {\r\n        console.error(\"Fetch failed:\", e);\r\n    }\r\n}\r\n\r\ndebugSearch();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-redis-data.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\n\r\nasync function checkData() {\r\n    const redisUrl = process.env.REDIS_URL || 'redis://localhost:6379';\r\n    console.log(`Connecting to ${redisUrl}`);\r\n    const redis = new Redis(redisUrl);\r\n\r\n    try {\r\n        const keys = await redis.keys('*');\r\n        console.log(`\\nFound ${keys.length} keys in Redis:`);\r\n        keys.forEach(k => console.log(` - ${k}`));\r\n\r\n        // Check specific known keys\r\n        const interestKeys = ['sources', 'resistance_artifacts', 'resistance_artifacts_data'];\r\n\r\n        for (const key of interestKeys) {\r\n            const type = await redis.type(key);\r\n            console.log(`\\nKey '${key}' is type: ${type}`);\r\n            if (type === 'string') {\r\n                const val = await redis.get(key);\r\n                console.log(` - Length: ${val.length} chars`);\r\n                console.log(` - Preview: ${val.substring(0, 50)}...`);\r\n            } else if (type === 'list') {\r\n                const len = await redis.llen(key);\r\n                console.log(` - List Length: ${len}`);\r\n            } else if (type === 'none') {\r\n                console.log(` - Key does not exist.`);\r\n            }\r\n        }\r\n\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\ncheckData();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-remote-audit.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\n// Load env to get remote URL\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nconst remoteUrl = process.env.REDIS_URL;\r\n\r\nasync function auditKeys() {\r\n    console.log(\"ðŸ” Auditing Remote Redis Keys...\");\r\n\r\n    if (!remoteUrl) {\r\n        console.error(\"âŒ REDIS_URL not found in .env.local\");\r\n        return;\r\n    }\r\n\r\n    const redis = new Redis(remoteUrl);\r\n\r\n    try {\r\n        const keys = await redis.keys('user:*');\r\n        console.log(`\\nFound ${keys.length} User Keys:`);\r\n\r\n        // Group by user ID\r\n        const users = new Set();\r\n        keys.forEach(k => {\r\n            // format: user:<id>:namespace:key\r\n            const parts = k.split(':');\r\n            if (parts.length > 2) {\r\n                users.add(parts[1]);\r\n            }\r\n            console.log(` - ${k}`);\r\n        });\r\n\r\n        console.log(`\\nðŸ‘¥ Identified Users (${users.size}):`);\r\n        users.forEach(u => console.log(` - ${u}`));\r\n\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\nauditKeys();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-remote-redis.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\n\r\n// URL provided by user\r\nconst remoteUrl = \"redis://default:065Kh9HnAEPBld7mjXdEtBJbofiRWGXh@redis-13524.c60.us-west-1-2.ec2.cloud.redislabs.com:13524\";\r\n\r\nasync function checkRemoteData() {\r\n    console.log(`ðŸ“¡ Connecting to Remote Redis: ${remoteUrl.split('@')[1]}...`); // Log only host for privacy in logs\r\n    const redis = new Redis(remoteUrl);\r\n\r\n    try {\r\n        await redis.ping();\r\n        console.log(\"âœ… Connection successful!\");\r\n\r\n        const keys = await redis.keys('*');\r\n        console.log(`\\nFound ${keys.length} keys in Remote Redis:`);\r\n        keys.forEach(k => console.log(` - ${k}`));\r\n\r\n        const interestKeys = ['sources', 'resistance_artifacts'];\r\n\r\n        for (const key of interestKeys) {\r\n            const type = await redis.type(key);\r\n            console.log(`\\nKey '${key}' is type: ${type}`);\r\n            if (type === 'string') {\r\n                const val = await redis.get(key);\r\n                console.log(` - Length: ${val.length} chars`);\r\n            } else if (type === 'none') {\r\n                console.log(` - Key does not exist.`);\r\n            }\r\n        }\r\n\r\n    } catch (e) {\r\n        console.error(\"âŒ Connection failed:\", e.message);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\ncheckRemoteData();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-smart-sync.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nasync function smartSync() {\r\n    const redis = new Redis(process.env.REDIS_URL);\r\n    const REAL_KEY = 'user:user_364D6LEBTCeN6mgbSfR8h3TrMdp:storage:sources';\r\n    const DEMO_KEY = 'user:demo-user:storage:sources';\r\n\r\n    try {\r\n        const realData = await redis.get(REAL_KEY);\r\n        const demoData = await redis.get(DEMO_KEY);\r\n\r\n        console.log(`Real Data Size: ${realData ? realData.length : 0}`);\r\n        console.log(`Demo Data Size: ${demoData ? demoData.length : 0}`);\r\n\r\n        if (realData) {\r\n            console.log(\"Backing up Demo Data...\");\r\n            if (demoData) await redis.set(`${DEMO_KEY}:backup`, demoData);\r\n\r\n            console.log(\"Overwriting Demo Data with Real Data (Vercel State)...\");\r\n            await redis.set(DEMO_KEY, realData);\r\n            console.log(\"âœ… Sync Complete: Localhost (Demo) now matches Vercel.\");\r\n        } else {\r\n            console.log(\"âš  Real user has no data. Nothing to sync from Vercel.\");\r\n        }\r\n    } catch (e) {\r\n        console.error(e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\nsmartSync();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-sources.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function checkSources() {\r\n    try {\r\n        const response = await fetch('http://localhost:3000/api/sources');\r\n        const data = await response.json();\r\n        console.log(\"Total Sources:\", data.length);\r\n        data.forEach(s => {\r\n            console.log(`Source: ${s.title}`);\r\n            console.log(`  - Has Analysis: ${!!s.analysis}`);\r\n            console.log(`  - Has Extracted Text: ${!!s.extractedText}`);\r\n            console.log(`  - Text Length: ${s.extractedText ? s.extractedText.length : 0}`);\r\n        });\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    }\r\n}\r\n\r\ncheckSources();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\debug-sync-users.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\nconst envPath = path.resolve(__dirname, '.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nconst remoteUrl = process.env.REDIS_URL;\r\n\r\nasync function syncUsers() {\r\n    console.log(\"ðŸ”„ Syncing Real Source Data to Demo User...\");\r\n\r\n    if (!remoteUrl) {\r\n        console.error(\"REDIS_URL missing\");\r\n        return;\r\n    }\r\n\r\n    const redis = new Redis(remoteUrl);\r\n\r\n    // Identified from audit\r\n    const SOURCE_USER = 'user_364D6LEBTCeN6mgbSfR8h3TrMdp';\r\n    const TARGET_USER = 'demo-user';\r\n\r\n    try {\r\n        const keysToSync = ['sources', 'resistance_artifacts']; // Add others if needed like 'analysis:...'\r\n\r\n        for (const key of keysToSync) {\r\n            const sourceKey = `user:${SOURCE_USER}:storage:${key}`;\r\n            const targetKey = `user:${TARGET_USER}:storage:${key}`;\r\n\r\n            console.log(`Checking ${sourceKey}...`);\r\n            const exists = await redis.exists(sourceKey);\r\n\r\n            if (exists) {\r\n                const data = await redis.get(sourceKey);\r\n                console.log(` - Found data (${data.length} chars). Overwriting Demo User...`);\r\n                await redis.set(targetKey, data);\r\n                console.log(` - âœ… Synced ${key}`);\r\n            } else {\r\n                console.log(` - âš  Source data not found for ${key}. Skipping.`);\r\n                // If source doesn't have it, maybe 'sources' (legacy) has it?\r\n                if (key === 'sources') {\r\n                    const legacyKey = 'sources';\r\n                    const legacyExists = await redis.exists(legacyKey);\r\n                    if (legacyExists) {\r\n                        console.log(` - Found legacy 'sources' key. Syncing that to demo user...`);\r\n                        const legData = await redis.get(legacyKey);\r\n                        await redis.set(targetKey, legData);\r\n                        console.log(` - âœ… Synced from legacy sources`);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\nsyncUsers();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\list_google_models.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":11}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst https = require('https');\r\n\r\n// Read .env.local manually\r\nlet apiKey = '';\r\ntry {\r\n    const envFile = fs.readFileSync('.env.local', 'utf8');\r\n    const match = envFile.match(/GOOGLE_API_KEY=(.+)/);\r\n    if (match) {\r\n        apiKey = match[1].trim();\r\n    }\r\n} catch (e) {\r\n    console.error(\"Could not read .env.local\");\r\n    process.exit(1);\r\n}\r\n\r\nif (!apiKey) {\r\n    console.error(\"No GOOGLE_API_KEY found in .env.local\");\r\n    process.exit(1);\r\n}\r\n\r\nconst url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;\r\n\r\nhttps.get(url, (res) => {\r\n    let data = '';\r\n    res.on('data', (chunk) => data += chunk);\r\n    res.on('end', () => {\r\n        try {\r\n            const json = JSON.parse(data);\r\n            if (json.models) {\r\n                console.log(\"Available Models:\");\r\n                json.models.forEach(m => {\r\n                    console.log(`- ${m.name} (${m.supportedGenerationMethods.join(', ')})`);\r\n                });\r\n            } else {\r\n                console.log(\"No models found or error structure:\", json);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error parsing JSON:\", e);\r\n            console.log(\"Raw Response:\", data);\r\n        }\r\n    });\r\n}).on('error', (e) => {\r\n    console.error(\"Request error:\", e);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\reproduce_fuzzy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\reproduce_issue.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst fetch = require('node-fetch');\r\n\r\nasync function testStressTest() {\r\n    const existingAnalysis = {\r\n        governance_scores: {\r\n            centralization: 70,\r\n            rights_focus: 60,\r\n            flexibility: 50,\r\n            market_power: 40,\r\n            procedurality: 80\r\n        },\r\n        key_insight: \"This is a test insight\",\r\n        inverted_text: \"Inverted text for testing purposes.\"\r\n    };\r\n\r\n    const payload = {\r\n        text: \"Original text content here...\",\r\n        analysisMode: 'stress_test',\r\n        existingAnalysis: existingAnalysis\r\n    };\r\n\r\n    console.log('Sending payload:', JSON.stringify(payload, null, 2));\r\n\r\n    try {\r\n        const response = await fetch('http://localhost:3000/api/analyze', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify(payload)\r\n        });\r\n\r\n        const result = await response.json();\r\n        console.log('Response Status:', response.status);\r\n        console.log('Response Body:', JSON.stringify(result, null, 2));\r\n\r\n        if (result.analysis && result.analysis.governance_scores) {\r\n            console.log('SUCCESS: governance_scores preserved.');\r\n        } else {\r\n            console.error('FAILURE: governance_scores MISSING.');\r\n        }\r\n    } catch (error) {\r\n        console.error('Error:', error);\r\n    }\r\n}\r\n\r\ntestStressTest();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\clear-cache.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":25}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// Load .env.local manually\r\nconst envPath = path.join(process.cwd(), '.env.local');\r\nlet env = {};\r\nif (fs.existsSync(envPath)) {\r\n    const content = fs.readFileSync(envPath, 'utf8');\r\n    content.split('\\n').forEach(line => {\r\n        const match = line.match(/^([^=]+)=(.*)$/);\r\n        if (match) {\r\n            env[match[1].trim()] = match[2].trim().replace(/^[\"']|[\"']$/g, '');\r\n        }\r\n    });\r\n}\r\n\r\nconst redisUrl = env.REDIS_URL || 'redis://localhost:6379';\r\n\r\nasync function clearCache() {\r\n    console.log(`Connecting to Redis at ${redisUrl}...`);\r\n    const redis = new Redis(redisUrl);\r\n\r\n    try {\r\n        console.log('Flushing all keys...');\r\n        await redis.flushall();\r\n        console.log('âœ… Cache cleared successfully.');\r\n    } catch (error) {\r\n        console.error('âŒ Failed to clear cache:', error);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\nclearCache();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\clear-db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\debug_search_traces.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testSearch() {\r\n    console.log(\"Testing /api/search-traces...\");\r\n    try {\r\n        const response = await fetch('http://localhost:3000/api/search-traces', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                // Mock user ID for dev environment if needed, though the API checks auth().\r\n                // We might need to bypass auth or use a demo header if enabled.\r\n            },\r\n            body: JSON.stringify({\r\n                customQuery: \"uber driver resistance\",\r\n                platforms: [\"reddit\"]\r\n            })\r\n        });\r\n\r\n        const text = await response.text();\r\n        console.log(\"Raw Response:\", text.substring(0, 500));\r\n        let data;\r\n        try {\r\n            data = JSON.parse(text);\r\n        } catch {\r\n            console.log(\"Response is not JSON.\");\r\n            return;\r\n        }\r\n        console.log(\"Status:\", response.status);\r\n        if (data.traces && data.traces.length > 0) {\r\n            console.log(\"Trace Count:\", data.traces.length);\r\n            data.traces.slice(0, 5).forEach((t, i) => {\r\n                console.log(`Trace ${i}: ${t.title} [${t.strategy}]`);\r\n            });\r\n        } else {\r\n            console.log(\"No traces found or traces empty.\");\r\n            console.log(JSON.stringify(data, null, 2));\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    }\r\n}\r\n\r\ntestSearch();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\fix-remote-keys.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\n// Load env to get remote URL\r\nconst envPath = path.resolve(__dirname, '../.env.local');\r\ndotenv.config({ path: envPath });\r\n\r\nconst remoteUrl = process.env.REDIS_URL;\r\n\r\nasync function fixKeys() {\r\n    console.log(\"Renaming Keys on Remote Redis...\");\r\n\r\n    if (!remoteUrl) {\r\n        console.error(\"REDIS_URL not found\");\r\n        return;\r\n    }\r\n\r\n    const redis = new Redis(remoteUrl);\r\n    const userId = 'demo-user'; // The ID we are forcing in the API\r\n\r\n    try {\r\n        // Fix 'sources'\r\n        const oldKey = 'sources';\r\n        const newKey = `user:${userId}:storage:sources`;\r\n\r\n        const exists = await redis.exists(oldKey);\r\n        if (exists) {\r\n            console.log(`Renaming ${oldKey} -> ${newKey}`);\r\n            // Check if new key exists first to avoid overwrite data loss (optional, here we want to overwrite)\r\n            await redis.rename(oldKey, newKey);\r\n            console.log(\"âœ… Renamed sources.\");\r\n        } else {\r\n            console.log(`â„¹ Key '${oldKey}' not found (maybe already renamed?)`);\r\n        }\r\n\r\n        // Fix 'resistance_artifacts' if needed? \r\n        // Logic for resistance might be different, let's check resistance/artifacts/route.ts if needed.\r\n        // Assuming persistence service uses same logic.\r\n\r\n    } catch (e) {\r\n        console.error(\"Error:\", e);\r\n    } finally {\r\n        redis.disconnect();\r\n    }\r\n}\r\n\r\nfixKeys();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\migrate-local-to-remote.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'envConfig' is assigned a value but never used.","line":7,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":16}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const Redis = require('ioredis');\r\nconst path = require('path');\r\nconst dotenv = require('dotenv');\r\n\r\n// Load env to get remote URL\r\nconst envPath = path.resolve(__dirname, '../.env.local');\r\nconst envConfig = dotenv.config({ path: envPath });\r\n\r\nasync function migrate() {\r\n    console.log(\"ðŸš€ Starting Data Migration: Local -> Remote\");\r\n\r\n    const localUrl = 'redis://localhost:6379';\r\n    // Use the remote URL from env, or the one the user posted if env loading fails\r\n    const remoteUrl = process.env.REDIS_URL || \"redis://default:065Kh9HnAEPBld7mjXdEtBJbofiRWGXh@redis-13524.c60.us-west-1-2.ec2.cloud.redislabs.com:13524\";\r\n\r\n    if (!remoteUrl || remoteUrl.includes('localhost')) {\r\n        console.error(\"âŒ Valid Remote REDIS_URL not found.\");\r\n        return;\r\n    }\r\n\r\n    const localRedis = new Redis(localUrl);\r\n    const remoteRedis = new Redis(remoteUrl);\r\n\r\n    console.log(\"Connecting...\");\r\n\r\n    try {\r\n        // Keys to migrate\r\n        const keysToMigrate = ['sources', 'resistance_artifacts']; // Add others if needed\r\n\r\n        for (const key of keysToMigrate) {\r\n            console.log(`\\nChecking key: ${key}`);\r\n\r\n            // Get from Local\r\n            const type = await localRedis.type(key);\r\n            if (type === 'none') {\r\n                console.log(` - Skiping (Does not exist on local)`);\r\n                continue;\r\n            }\r\n\r\n            console.log(` - Reading from Local (${type})...`);\r\n            let value;\r\n            if (type === 'string') {\r\n                value = await localRedis.get(key);\r\n            } else {\r\n                console.log(` - Skipping non-string type for now (implement if needed)`);\r\n                continue;\r\n            }\r\n\r\n            // Check if Remote already has it\r\n            const remoteType = await remoteRedis.type(key);\r\n            if (remoteType !== 'none') {\r\n                console.log(` - âš  Key exists on remote. Overwriting...`);\r\n            }\r\n\r\n            // Write to Remote\r\n            console.log(` - Writing to Remote (${value.length} chars)...`);\r\n            await remoteRedis.set(key, value);\r\n            console.log(` - âœ… Success`);\r\n        }\r\n\r\n        console.log(\"\\nðŸŽ‰ Migration Complete!\");\r\n\r\n    } catch (e) {\r\n        console.error(\"Migration Failed:\", e);\r\n    } finally {\r\n        localRedis.disconnect();\r\n        remoteRedis.disconnect();\r\n    }\r\n}\r\n\r\nmigrate();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\test-assemblage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\test-prompts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\test-search-config.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":31,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\test-simulation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\scripts\\test-week3-implementation.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[788,791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[788,791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[897,900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[897,900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { ANTTraceService } from '../src/lib/ant-trace-service';\r\nimport { AssemblageMechanismService } from '../src/lib/assemblage-mechanism-service';\r\nimport { ProvisionalWrapper } from '../src/lib/provisional-wrapper';\r\n\r\n// Mock Data\r\nconst mockActors = [\r\n    { id: '1', name: 'EU AI Act', type: 'Policymaker', description: 'Regulation' },\r\n    { id: '2', name: 'OpenAI', type: 'Startup', description: 'AI Company' }\r\n];\r\n\r\nconst mockLinks = [\r\n    { source: '1', target: '2', type: 'regulates' }\r\n];\r\n\r\nasync function testWeek3Implementation() {\r\n    console.log(\"=== Testing Week 3 Implementation ===\\n\");\r\n\r\n    // 1. Test ANT Trace Service directly\r\n    console.log(\"1. Testing ANTTraceService...\");\r\n    const tracedActors = ANTTraceService.hydrateWithProvenance(mockActors as any, \"ai_inference\");\r\n    const associations = ANTTraceService.traceAssociations(tracedActors, mockLinks as any);\r\n\r\n    if (tracedActors[0].provisional) {\r\n        console.log(\"  PASS: trace_metadata correctly added to actors\");\r\n    } else {\r\n        console.error(\"  FAIL: trace_metadata missing\");\r\n    }\r\n\r\n    if (associations.length === 1) {\r\n        console.log(\"  PASS: Associations traced correctly\");\r\n    } else {\r\n        console.error(\"  FAIL: Association tracing failed\");\r\n    }\r\n\r\n    // 2. Test Provisional Wrapper\r\n    console.log(\"\\n2. Testing ProvisionalWrapper...\");\r\n    const inscription = ProvisionalWrapper.wrap(\"Test Narrative\", \"ai_generated\", 0.6);\r\n\r\n    if (inscription.fragility_score && inscription.fragility_score.value > 0) {\r\n        console.log(`  PASS: Fragility Score calculated: ${(inscription.fragility_score.value * 100).toFixed(0)}% (${inscription.fragility_score.interpretation})`);\r\n    } else {\r\n        console.error(\"  FAIL: Fragility Score calculation failed\");\r\n    }\r\n\r\n    // 3. Test Assemblage Mechanism Service\r\n    console.log(\"\\n3. Testing AssemblageMechanismService...\");\r\n    const mechanisms = AssemblageMechanismService.detectTerritorialization(tracedActors, associations, []);\r\n\r\n    // We expect 0 mechanisms with this simple mock, but we check it doesn't crash\r\n    console.log(`  PASS: Mechanism detection ran without error (Found: ${mechanisms.length})`);\r\n\r\n    // 4. Simulate API Response Structure for /api/analyze/mechanisms\r\n    console.log(\"\\n4. Verifying API Response Structure...\");\r\n    const apiResponse = {\r\n        success: true,\r\n        mode: \"assemblage_realist\",\r\n        detected_mechanisms: mechanisms,\r\n        identified_capacities: [],\r\n        provisional_status: inscription\r\n    };\r\n\r\n    if (apiResponse.provisional_status && apiResponse.provisional_status.fragility_score) {\r\n        console.log(\"  PASS: API Response contains provisional_status for UI Badge\");\r\n    } else {\r\n        console.error(\"  FAIL: API Response missing provisional_status\");\r\n    }\r\n\r\n    console.log(\"\\n=== Test Complete ===\");\r\n}\r\n\r\ntestWeek3Implementation().catch(console.error);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\admin\\ratelimit\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\analyze\\hybrid\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\analyze\\mechanisms\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\analyze\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getAnalysisConfig' is defined but never used.","line":7,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnalysisResult' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'title' is assigned a value but never used.","line":49,"column":102,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":107},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'narrativeStatus' is assigned a value but never used.","line":133,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":133,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\nimport { StorageService } from '@/lib/storage-service';\r\nimport { checkRateLimit } from '@/lib/ratelimit';\r\nimport { getAuthenticatedUserId } from '@/lib/auth-helper';\r\nimport {\r\n  getAnalysisConfig,\r\n  runCritiqueLoop,\r\n  performAnalysis,\r\n  generateCacheKey\r\n} from '@/lib/analysis-service';\r\nimport { AnalysisResult } from '@/types';\r\n\r\nexport const maxDuration = 300; // Allow up to 5 minutes for analysis\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// Increment this version to invalidate all cached analyses\r\nconst PROMPT_VERSION = 'v27-fix'; // Incremented for structured, pedagogical assemblage explanation format\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const startTime = Date.now();\r\n  console.log(`[ANALYSIS] Request started at ${new Date(startTime).toISOString()} `);\r\n\r\n  const userId = await getAuthenticatedUserId(request);\r\n\r\n  if (!userId) {\r\n    console.log('[ANALYSIS] Unauthorized. Headers:', Object.fromEntries(request.headers));\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  // Rate Limiting\r\n  const rateLimit = await checkRateLimit(userId); // Uses default 25 requests per minute\r\n  if (!rateLimit.success) {\r\n    return NextResponse.json(\r\n      { error: rateLimit.error || \"Too Many Requests\" },\r\n      {\r\n        status: 429,\r\n        headers: {\r\n          'X-RateLimit-Limit': rateLimit.limit.toString(),\r\n          'X-RateLimit-Remaining': rateLimit.remaining.toString(),\r\n          'X-RateLimit-Reset': rateLimit.reset.toString()\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  try {\r\n    const requestData = await request.json();\r\n    const { text, sourceType, analysisMode, sourceA, sourceB, sourceC, force, documents, documentId, title, positionality, lens, mode } = requestData;\r\n    console.log(`[ANALYSIS] Received request. Text length: ${text?.length || 0}, Mode: ${analysisMode}, TheoryMode: ${mode}, Force: ${force}, DocID: ${documentId}, Positionality: ${!!positionality}`);\r\n\r\n    // Check for API key and Initialize OpenAI\r\n    // Check for API key and Initialize OpenAI\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    let openai;\r\n\r\n    if (apiKey) {\r\n      openai = new OpenAI({\r\n        apiKey: apiKey,\r\n        baseURL: process.env.OPENAI_BASE_URL,\r\n      });\r\n    } else {\r\n      console.warn(\"[ANALYSIS] Missing OPENAI_API_KEY. Running in Limited/Demo mode without LLM.\");\r\n    }\r\n\r\n    // NEW: Mode-based routing for theoretical separation\r\n    // If explicit theory mode is specified, route to appropriate logic\r\n    if (mode === 'ant_trace' || mode === 'assemblage_realist' || mode === 'hybrid_reflexive') {\r\n      console.log(`[ANALYSIS] Routing to ${mode} endpoint logic for theoretical separation`);\r\n\r\n      // Generate cache key for theoretical analysis\r\n      const cacheKey = generateCacheKey(mode, text || '', sourceType || 'unknown', PROMPT_VERSION + '_theo');\r\n\r\n      try {\r\n        if (!force) {\r\n          const cached = await StorageService.getCache(userId, cacheKey);\r\n          if (cached) {\r\n            console.log(`[CACHE HIT] Returning cached ${mode} analysis`);\r\n            return NextResponse.json({ success: true, analysis: cached, cached: true });\r\n          }\r\n        }\r\n      } catch (e) { console.warn(\"Cache read failed\", e); }\r\n\r\n      // Import services dynamically\r\n      const { ANTTraceService } = await import('@/lib/ant-trace-service');\r\n      const { AssemblageMechanismService } = await import('@/lib/assemblage-mechanism-service');\r\n      const { ProvisionalWrapper } = await import('@/lib/provisional-wrapper');\r\n\r\n      let analysisResult = {};\r\n\r\n      if (mode === 'ant_trace') {\r\n        const tracedActors = ANTTraceService.hydrateWithProvenance(requestData.actors || [], \"ai_inference\");\r\n        const associations = ANTTraceService.traceAssociations(tracedActors, requestData.links || []);\r\n        const result = ANTTraceService.generateTraceResult(tracedActors, associations);\r\n\r\n        if (openai) {\r\n          // Generate Narrative via LLM\r\n          const { analysis } = await performAnalysis(openai, userId, {\r\n            analysisMode: 'ant_trace',\r\n            actors: tracedActors,\r\n            links: associations\r\n          });\r\n\r\n          // Adapt to UI expectation\r\n          analysisResult = {\r\n            ...result,\r\n            narrative: analysis.narrative,\r\n            isTrace: true\r\n          };\r\n        } else {\r\n          // Fallback: Static Narrative (Demo Mode / No API Key)\r\n          analysisResult = {\r\n            ...result,\r\n            narrative: `Methodological ANT Trace completed. Traced ${tracedActors.length} actors and ${associations.length} associations using strict empirical trailing. No ontological mechanisms assumed. (Static Demo Response)`,\r\n            isTrace: true\r\n          };\r\n        }\r\n      } else if (mode === 'assemblage_realist') {\r\n        // Requires trace input - if not present, perform quick trace first\r\n        let tracedActors = requestData.traced_actors;\r\n        let associations = requestData.associations;\r\n\r\n        if (!tracedActors || !associations) {\r\n          console.log(\"[ANALYSIS] Assemblage mode missing trace, performing ad-hoc trace first\");\r\n          tracedActors = ANTTraceService.hydrateWithProvenance(requestData.actors || [], \"ai_inference\");\r\n          associations = ANTTraceService.traceAssociations(tracedActors, requestData.links || []);\r\n        }\r\n\r\n        const mechanisms = AssemblageMechanismService.detectTerritorialization(tracedActors, associations, requestData.configurations || []);\r\n        const capacities = AssemblageMechanismService.identifyCapacities(tracedActors, associations);\r\n\r\n        let narrativeContent = \"\";\r\n        const narrativeStatus = null;\r\n\r\n        if (openai) {\r\n          // Generate Narrative via LLM\r\n          const { analysis } = await performAnalysis(openai, userId, {\r\n            analysisMode: 'assemblage_realist',\r\n            traced_actors: tracedActors,\r\n            detected_mechanisms: mechanisms,\r\n            identified_capacities: capacities\r\n          });\r\n          narrativeContent = analysis.narrative;\r\n        } else {\r\n          // Fallback\r\n          narrativeContent = `Detected ${mechanisms.length} mechanisms (Territorialization/Deterritorialization) and ${capacities.length} capacities in the assemblage. (Static Demo Response)`;\r\n        }\r\n\r\n        const narrativeCtx = ProvisionalWrapper.wrap(\r\n          narrativeContent || \"Analysis failed to generate narrative.\",\r\n          \"ai_generated\", 0.7\r\n        );\r\n\r\n        analysisResult = {\r\n          narrative: narrativeCtx.content, // Map for UI narrative display\r\n          provisional_status: narrativeCtx, // Full object for badge\r\n          detected_mechanisms: mechanisms,\r\n          identified_capacities: capacities\r\n        };\r\n      } else if (mode === 'hybrid_reflexive') {\r\n        // 1. Trace\r\n        const tracedActors = ANTTraceService.hydrateWithProvenance(requestData.actors || [], \"ai_inference\");\r\n        const associations = ANTTraceService.traceAssociations(tracedActors, requestData.links || []);\r\n\r\n        // 2. Assemblage\r\n        const mechanisms = AssemblageMechanismService.detectTerritorialization(tracedActors, associations, requestData.configurations || []);\r\n\r\n        // 3. Tensions\r\n        const tensions = [\r\n          { description: \"Instrumentalizing ANT trace for DeLandian ontological claims\", latour_would_reject: \"Yes\" }\r\n        ];\r\n\r\n        let narrativeContent = \"\";\r\n\r\n        if (openai) {\r\n          // Generate Narrative via LLM\r\n          const { analysis } = await performAnalysis(openai, userId, {\r\n            analysisMode: 'hybrid_reflexive',\r\n            ant_trace: { actor_count: tracedActors.length },\r\n            assemblage_analysis: { mechanism_count: mechanisms.length, mechanisms },\r\n            tensions: tensions\r\n          });\r\n          narrativeContent = analysis.narrative;\r\n        } else {\r\n          narrativeContent = `Hybrid analysis: Used ANT to trace ${tracedActors.length} actors, then interpreted ${mechanisms.length} mechanisms. Theoretical tension: Instrumentalizing ANT for Ontology. (Static Demo Response)`;\r\n        }\r\n\r\n        const narrativeCtx = ProvisionalWrapper.wrap(\r\n          narrativeContent || \"Hybrid analysis generated.\",\r\n          \"ai_generated\", 0.6\r\n        );\r\n\r\n        analysisResult = {\r\n          narrative: narrativeCtx.content,\r\n          provisional_status: narrativeCtx,\r\n          tensions: tensions,\r\n          ant_trace: { actor_count: tracedActors.length },\r\n          assemblage_analysis: { mechanism_count: mechanisms.length }\r\n        };\r\n      }\r\n\r\n      // Cache and Return\r\n      await StorageService.setCache(userId, cacheKey, analysisResult, 86400);\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        analysis: analysisResult\r\n      });\r\n    }\r\n\r\n    // --- STANDARD ANALYSIS FLOW ---\r\n\r\n    if ((!text || text.length < 50) && analysisMode !== 'comparative_synthesis' && analysisMode !== 'resistance_synthesis' && analysisMode !== 'comparison' && analysisMode !== 'ontology_comparison' && analysisMode !== 'critique' && analysisMode !== 'assemblage_explanation') {\r\n      console.warn(`[ANALYSIS] Rejected request with insufficient text length: ${text?.length || 0}`);\r\n      return NextResponse.json(\r\n        { error: 'Insufficient text content. Please ensure the document has text (not just images) and try again.' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (analysisMode === 'comparison') {\r\n      if (!sourceA?.text || sourceA.text.length < 50 || !sourceB?.text || sourceB.text.length < 50) {\r\n        return NextResponse.json(\r\n          { error: 'Insufficient text content in selected sources for comparison.' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    if (analysisMode === 'ontology_comparison') {\r\n      if (!sourceA?.data || !sourceB?.data) {\r\n        return NextResponse.json(\r\n          { error: 'Missing ontology data for comparison (at least 2 required).' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // --- CACHING LOGIC START ---\r\n    console.log('[ANALYSIS] Starting cache check...');\r\n    let textForCache = text || '';\r\n\r\n    // Append documentId to ensure uniqueness even if text is identical\r\n    if (documentId) {\r\n      textForCache += `| doc:${documentId} `;\r\n    }\r\n\r\n    // Append positionality to cache key to ensure different perspectives get different analyses\r\n    if (positionality) {\r\n      const posString = typeof positionality === 'object' ? JSON.stringify(positionality) : positionality;\r\n      textForCache += `| pos:${posString} `;\r\n    }\r\n\r\n    if (analysisMode === 'comparison' && sourceA && sourceB) {\r\n      textForCache = `${sourceA.title}:${sourceA.text}| ${sourceB.title}:${sourceB.text} `;\r\n    } else if (analysisMode === 'ontology_comparison' && sourceA && sourceB) {\r\n      // Use titles and summary/node count for cache key to avoid huge JSON strings\r\n      textForCache = `ONTOLOGY_COMPARE:${sourceA.title} (${sourceA.data.nodes.length})| ${sourceB.title} (${sourceB.data.nodes.length})`;\r\n      if (sourceC) {\r\n        textForCache += `| ${sourceC.title} (${sourceC.data.nodes.length})`;\r\n      }\r\n    } else if (analysisMode === 'comparative_synthesis' && documents) {\r\n      textForCache = documents.map((d: { id: string }) => d.id).sort().join(',');\r\n      if (lens) {\r\n        textForCache += `| lens:${lens}`;\r\n      }\r\n    } else if (analysisMode === 'resistance_synthesis' && documents) {\r\n      textForCache = documents.map((d: { title: string }) => d.title).sort().join(',');\r\n    }\r\n\r\n    const cacheKey = generateCacheKey(analysisMode || 'default', textForCache, sourceType || 'unknown', PROMPT_VERSION);\r\n\r\n    try {\r\n      // Skip cache if force is true\r\n      if (!force) {\r\n        console.log('[ANALYSIS] Checking Redis cache...');\r\n        let cachedAnalysis = await StorageService.getCache(userId, cacheKey);\r\n\r\n        if (cachedAnalysis) {\r\n          console.log(`[CACHE HIT] Returning cached analysis for key: ${cacheKey} `);\r\n\r\n          // [FIX] Ensure cached ecosystem analysis is an array\r\n          if (analysisMode === 'ecosystem' && !Array.isArray(cachedAnalysis)) {\r\n            // Cast to generic object to check for nested fields\r\n            const ca = cachedAnalysis as Record<string, unknown>;\r\n            if (Array.isArray(ca.impacts)) {\r\n              cachedAnalysis = ca.impacts;\r\n            } else if (ca.analysis && Array.isArray(ca.analysis)) {\r\n              cachedAnalysis = ca.analysis;\r\n            } else {\r\n              cachedAnalysis = [cachedAnalysis];\r\n            }\r\n          }\r\n\r\n          console.log(`[ANALYSIS] Completed(Cache Hit) in ${Date.now() - startTime} ms`);\r\n          return NextResponse.json({\r\n            success: true,\r\n            analysis: cachedAnalysis,\r\n            cached: true\r\n          });\r\n        }\r\n        console.log('[ANALYSIS] Cache Miss.');\r\n      }\r\n    } catch (cacheError) {\r\n      console.warn('Redis cache read failed:', cacheError);\r\n    }\r\n    // --- CACHING LOGIC END ---\r\n\r\n    // [Feature] Decoupled Critique Mode\r\n    if (analysisMode === 'critique') {\r\n      if (!requestData.existingAnalysis) {\r\n        return NextResponse.json({ error: \"Missing existingAnalysis for critique mode\" }, { status: 400 });\r\n      }\r\n\r\n      if (!openai) {\r\n        return NextResponse.json({ error: \"OpenAI API Key required for Critique Mode\" }, { status: 500 });\r\n      }\r\n\r\n      console.log('[ANALYSIS] Mode is CRITIQUE. bypassing main generation.');\r\n      // Run only the critique loop\r\n      const critique = await runCritiqueLoop(openai, userId, text, requestData.existingAnalysis);\r\n      return NextResponse.json({\r\n        success: true,\r\n        analysis: { system_critique: critique } // Wrap in analysis object for consistency\r\n      });\r\n    }\r\n\r\n    // --- PERFORM ANALYSIS VIA SERVICE ---\r\n    if (!openai) {\r\n      return NextResponse.json({ error: \"OpenAI API Key required for Standard Analysis\" }, { status: 500 });\r\n    }\r\n    const { analysis, usage } = await performAnalysis(openai, userId, requestData);\r\n\r\n    // ---------------------\r\n    // Cache the result\r\n    try {\r\n      if (analysis && typeof analysis === 'object' && !analysis.error) {\r\n        await StorageService.setCache(userId, cacheKey, analysis, 86400); // 24 hours\r\n        console.log(`[ANALYSIS] Saved to cache: ${cacheKey}`);\r\n      } else {\r\n        console.warn(`[ANALYSIS] Skipping cache for failed/partial analysis. Key: ${cacheKey}`);\r\n      }\r\n    } catch (saveError) {\r\n      console.warn('[ANALYSIS] Failed to save to cache:', saveError);\r\n    }\r\n\r\n    console.log(`[ANALYSIS] Request completed successfully in ${Date.now() - startTime} ms`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      analysis,\r\n      usage\r\n    });\r\n\r\n  } catch (error: unknown) {\r\n    console.error(`[ANALYSIS ERROR] Failed after ${Date.now() - startTime} ms: `, error);\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n    return NextResponse.json(\r\n      {\r\n        error: 'Analysis failed',\r\n        details: errorMessage\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\analyze\\trace\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\ecosystem\\absence\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ABSENCE_PROMPT' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\nimport { ABSENCE_PROMPT } from '@/lib/prompts/absence';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\nimport { auth } from '@clerk/nextjs/server';\r\nimport { PromptRegistry } from '@/lib/prompts/registry';\r\n\r\n// Initialize OpenAI client\r\nconst openai = new OpenAI({\r\n    apiKey: process.env.OPENAI_API_KEY,\r\n    baseURL: process.env.OPENAI_BASE_URL,\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n    const { userId } = await auth();\r\n    console.log(\"Absence Analysis API Called at \" + new Date().toISOString());\r\n\r\n    // if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n    //     // Simulate AI processing delay\r\n    //     await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n    //     // Return mock data for demo mode\r\n    //     return NextResponse.json({\r\n    //         success: true,\r\n    //         analysis: {\r\n    //             narrative: \"In demo mode: The ecosystem shows a significant gap in representation from the Global South, primarily focusing on EU/US market dynamics. Labor voices in the data supply chain are notably absent.\",\r\n    //             missing_voices: [\r\n    //                 { name: \"Data Labeling Workers\", reason: \"Crucial for model production but invisible in high-level policy.\", category: \"Labor\" },\r\n    //                 { name: \"Environmental Impact Auditors\", reason: \"No actors tracking carbon footprint of compute.\", category: \"Environment\" }\r\n    //             ],\r\n    //             structural_voids: [\"Independent third-party algorithmic audit mechanism\", \"Public redress channels\"],\r\n    //             blindspot_intensity: \"High\"\r\n    //         }\r\n    //     });\r\n    // }\r\n\r\n    try {\r\n        const { actors, text } = await req.json();\r\n\r\n        if (!process.env.OPENAI_API_KEY) {\r\n            return NextResponse.json({ success: false, error: \"OpenAI API Key missing\" }, { status: 500 });\r\n        }\r\n\r\n        if (!userId && process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE !== 'true') {\r\n            return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 });\r\n        }\r\n        // Handle demo user ID fallback if needed\r\n        if (!userId && process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            // For now assume authorized in demo mode or handle headers if passed, but basic fix first.\r\n            // Ideally we check headers like in other routes but simplicity first to fix build.\r\n        }\r\n\r\n        // Fetch the effective prompt (default or user-customized)\r\n        // Ensure userId is a string before passing, defaults to 'default' if missing to avoid crash\r\n        const safeUserId = userId || 'default';\r\n        const systemPrompt = await PromptRegistry.getEffectivePrompt(safeUserId, 'absence_analysis');\r\n\r\n        const actorContext = actors.map((a: EcosystemActor) => `- ${a.name} (${a.type}): ${a.description}`).join('\\n');\r\n        const userContent = `\r\n        ACTORS:\r\n        ${actorContext}\r\n\r\n        CONTEXT TEXT:\r\n        ${text || \"No specific text provided. Analyze the actor list composition.\"}\r\n        `;\r\n\r\n        const completion = await openai.chat.completions.create({\r\n            model: process.env.OPENAI_MODEL || \"gpt-4o\",\r\n            messages: [\r\n                { role: \"system\", content: systemPrompt }, // Replaced ABSENCE_PROMPT with systemPrompt\r\n                { role: \"user\", content: userContent }\r\n            ],\r\n            response_format: { type: \"json_object\" },\r\n        });\r\n\r\n        const content = completion.choices[0].message.content;\r\n        if (!content) throw new Error(\"No content returned from OpenAI\");\r\n\r\n        const analysis = JSON.parse(content);\r\n\r\n        return NextResponse.json({ success: true, analysis });\r\n\r\n    } catch (error) {\r\n        console.error(\"Absence Analysis Error:\", error);\r\n        return NextResponse.json({ success: false, error: \"Failed to analyze absences\" }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\ecosystem\\clear-cache\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\ecosystem\\trajectory\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'prompt_override' is assigned a value but never used.","line":15,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1373,1376],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1373,1376],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2471,2474],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2471,2474],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\nimport { auth } from '@clerk/nextjs/server';\r\nimport { PromptRegistry } from '@/lib/prompts/registry';\r\n\r\n// Initialize OpenAI client\r\nconst openai = new OpenAI({\r\n    apiKey: process.env.OPENAI_API_KEY,\r\n    baseURL: process.env.OPENAI_BASE_URL,\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { userId } = await auth();\r\n        const { actors, scenario, prompt_override } = await req.json();\r\n\r\n        // Handle demo mode fallback\r\n        if (!userId && process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            // Basic fallback purely for fetching the prompt if needed,\r\n            // though this route doesn't strictly check auth for demo mode logic yet other than this.\r\n        }\r\n\r\n        if (!actors || !scenario) {\r\n            return NextResponse.json(\r\n                { success: false, error: 'Missing actors or scenario' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const safeUserId = userId || 'default';\r\n        const systemPrompt = await PromptRegistry.getEffectivePrompt(safeUserId, 'trajectory_simulation');\r\n        const userPrompt = `\r\n        SCENARIO: ${scenario.name}\r\n        DESCRIPTION: ${scenario.description}\r\n        \r\n        ACTORS:\r\n        ${JSON.stringify(actors.map((a: any) => ({ id: a.id, name: a.name, type: a.type })), null, 2)}\r\n        \r\n        Analyze the trajectory of this assemblage under these conditions.\r\n        \r\n        CRITICAL RULES:\r\n        1. When listing deltas, use the EXACT FULL IDs provided in the ACTORS list. DO NOT TRUNCATE or shorten them.\r\n        2. source_id and target_id MUST match one of the provided actor IDs exactly.\r\n        \r\n        Return ONLY valid JSON.\r\n        `;\r\n\r\n        const completion = await openai.chat.completions.create({\r\n            model: process.env.OPENAI_MODEL || \"gpt-4o\",\r\n            messages: [\r\n                { role: \"system\", content: systemPrompt },\r\n                { role: \"user\", content: userPrompt }\r\n            ],\r\n            response_format: { type: \"json_object\" },\r\n        });\r\n\r\n        const content = completion.choices[0].message.content;\r\n        if (!content) {\r\n            throw new Error('No content received from OpenAI');\r\n        }\r\n\r\n        const analysis = JSON.parse(content);\r\n\r\n        return NextResponse.json({ success: true, analysis });\r\n\r\n    } catch (error: any) {\r\n        console.error('Trajectory analysis error:', error);\r\n        return NextResponse.json(\r\n            { success: false, error: error.message || 'Failed to analyze trajectory' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\fetch-url\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\generate-search-terms\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\governance\\compass\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\liberatory-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\logs\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\prompts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\prompts\\test\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1586,1589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1586,1589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\nimport { auth } from '@clerk/nextjs/server';\r\n\r\nconst openai = new OpenAI({\r\n    apiKey: process.env.OPENAI_API_KEY,\r\n    baseURL: process.env.OPENAI_BASE_URL, // Optional: For using Local/OpenRouter\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        let { userId } = await auth();\r\n\r\n        // Handle Demo Mode\r\n        if (!userId && process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            const demoUserId = req.headers.get('x-demo-user-id');\r\n            if (demoUserId) userId = demoUserId;\r\n        }\r\n\r\n        if (!userId) {\r\n            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n        }\r\n\r\n        const { systemPrompt, userContent } = await req.json();\r\n\r\n        if (!systemPrompt) {\r\n            return NextResponse.json({ error: 'System prompt is required' }, { status: 400 });\r\n        }\r\n\r\n        // Default test content if none provided, though UI should enforce it or provide placeholder\r\n        const content = userContent || \"Test input content.\";\r\n\r\n        const completion = await openai.chat.completions.create({\r\n            model: process.env.OPENAI_MODEL || \"gpt-4o\", // Use configured model\r\n            messages: [\r\n                { role: \"system\", content: systemPrompt },\r\n                { role: \"user\", content: content }\r\n            ],\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            result: completion.choices[0].message.content\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Test Prompt Error:\", error);\r\n        return NextResponse.json(\r\n            { error: error.message || 'Failed to test prompt' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\resistance\\analyze\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'redis' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DiscourseFrame' is defined but never used.","line":5,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RhetoricalStrategy' is defined but never used.","line":5,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":68},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ReconfigurationAnalysis' is defined but never used.","line":5,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":93},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'analysis_type' is assigned a value but never used.","line":23,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\nimport OpenAI from 'openai';\r\nimport { redis } from '@/lib/redis';\r\nimport { RESISTANCE_DISCOURSE_ANALYSIS_PROMPT } from '@/lib/prompts/resistance-analysis';\r\nimport { ArtifactAnalysisResult, DiscourseFrame, RhetoricalStrategy, ReconfigurationAnalysis, ResistanceArtifact } from '@/types/resistance';\r\nimport { StorageService } from '@/lib/storage-service';\r\nimport { getAuthenticatedUserId } from '@/lib/auth-helper';\r\n\r\nconst openai = new OpenAI({\r\n    apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function POST(request: NextRequest) {\r\n    const userId = await getAuthenticatedUserId(request);\r\n\r\n    if (!userId) {\r\n        return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    try {\r\n        const body = await request.json();\r\n        console.log('[RESISTANCE ANALYSIS] Request Body:', JSON.stringify(body, null, 2));\r\n        const { artifact_id, artifact_text, analysis_type } = body;\r\n\r\n        if (!artifact_text) {\r\n            console.error('[RESISTANCE ANALYSIS] Missing artifact_text');\r\n            return NextResponse.json(\r\n                { success: false, error: 'Artifact text is required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Call OpenAI for discourse analysis\r\n        console.log('Starting OpenAI analysis for artifact:', artifact_id);\r\n        const completion = await openai.chat.completions.create({\r\n            model: 'gpt-4o',\r\n            messages: [\r\n                {\r\n                    role: 'system',\r\n                    content: RESISTANCE_DISCOURSE_ANALYSIS_PROMPT\r\n                },\r\n                {\r\n                    role: 'user',\r\n                    content: `Analyze this resistance artifact:\\n\\n${artifact_text}`\r\n                }\r\n            ],\r\n            response_format: { type: 'json_object' },\r\n            temperature: 0.3,\r\n        });\r\n\r\n        console.log('OpenAI completion received');\r\n        const analysis = JSON.parse(completion.choices[0].message.content || '{}');\r\n        console.log('Analysis parsed successfully');\r\n\r\n        const result: ArtifactAnalysisResult = {\r\n            artifact_id,\r\n            frames: analysis.frames || [],\r\n            strategies: analysis.rhetorical_strategies || [],\r\n            reconfiguration: analysis.reconfiguration,\r\n            generated_at: new Date().toISOString()\r\n        };\r\n\r\n        // Persist to Redis\r\n        try {\r\n            // Use StorageService for consistent user-scoped keys\r\n            let artifacts = await StorageService.get<ResistanceArtifact[]>(userId, 'resistance_artifacts');\r\n            if (!artifacts) artifacts = [];\r\n\r\n            const artifactIndex = artifacts.findIndex(a => a.id === artifact_id);\r\n            if (artifactIndex !== -1) {\r\n                // Update existing artifact\r\n                artifacts[artifactIndex] = {\r\n                    ...artifacts[artifactIndex],\r\n                    frames: result.frames,\r\n                    rhetorical_strategies: result.strategies,\r\n                    reconfiguration_potential: result.reconfiguration\r\n                };\r\n\r\n                await StorageService.set(userId, 'resistance_artifacts', artifacts);\r\n                console.log(`Analysis persisted for artifact ${artifact_id}`);\r\n            } else {\r\n                console.warn(`Artifact ${artifact_id} not found in Redis, skipping persistence.`);\r\n            }\r\n        } catch (redisError) {\r\n            console.error('Failed to persist analysis to Redis:', redisError);\r\n            // Continue to return success to UI even if persistence fails, but log it\r\n        }\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            analysis: result\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Error analyzing resistance artifact:', error);\r\n        return NextResponse.json(\r\n            { success: false, error: 'Failed to analyze artifact', details: error instanceof Error ? error.message : String(error) },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\resistance\\artifacts\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\resistance\\artifacts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\resistance\\search\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3002,3005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3002,3005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\n\r\ninterface SearchResult {\r\n    title: string;\r\n    url: string;\r\n    snippet: string;\r\n    source: string;\r\n    date: string;\r\n    type: 'manifesto' | 'policy_draft' | 'social_media' | 'protest_material' | 'interview' | 'other';\r\n}\r\n\r\n// Fallback verified data\r\nconst MOCK_RESULTS: SearchResult[] = [\r\n    {\r\n        title: \"EFF: EU AI Act Passed: Now the Hard Work Begins\",\r\n        url: \"https://www.eff.org/deeplinks/2024/03/eu-ai-act-passed-now-hard-work-begins\",\r\n        snippet: \"The European Parliament has voted to adopt the AI Act. Here is the EFF's analysis of the final text and what comes next for fundamental rights.\",\r\n        source: \"Electronic Frontier Foundation\",\r\n        date: \"2024-03-13\",\r\n        type: \"manifesto\"\r\n    },\r\n    {\r\n        title: \"EFF: EU AI Act Deal Reached: Human Rights Still at Risk\",\r\n        url: \"https://www.eff.org/deeplinks/2023/12/eu-ai-act-deal-reached-human-rights-still-risk\",\r\n        snippet: \"Civil society reacts to the final political deal on the AI Act, highlighting significant loopholes for law enforcement and national security.\",\r\n        source: \"Electronic Frontier Foundation\",\r\n        date: \"2023-12-09\",\r\n        type: \"policy_draft\"\r\n    },\r\n    {\r\n        title: \"TechCrunch: EU ties up deal on AI Act\",\r\n        url: \"https://techcrunch.com/2023/12/08/eu-ai-act-deal/\",\r\n        snippet: \"Analysis of the marathon negotiations that led to the world's first comprehensive AI law.\",\r\n        source: \"TechCrunch\",\r\n        date: \"2023-12-08\",\r\n        type: \"social_media\"\r\n    }\r\n];\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const query = searchParams.get('q');\r\n\r\n    if (!query) {\r\n        return NextResponse.json({ error: \"Query parameter 'q' is required\" }, { status: 400 });\r\n    }\r\n\r\n    const apiKey = process.env.GOOGLE_SEARCH_API_KEY;\r\n    const cx = process.env.GOOGLE_SEARCH_CX;\r\n\r\n    // 1. Fallback if no keys configured\r\n    if (!apiKey || !cx) {\r\n        console.warn(\"Google Search API keys missing. Returning mock data.\");\r\n        // Simulate network delay for realism\r\n        await new Promise(resolve => setTimeout(resolve, 800));\r\n        return NextResponse.json({\r\n            results: MOCK_RESULTS,\r\n            source: 'mock',\r\n            message: 'API keys not configured. Showing verified demo data.'\r\n        });\r\n    }\r\n\r\n    // 2. Real Search\r\n    try {\r\n        const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;\r\n        const response = await fetch(url);\r\n        const data = await response.json();\r\n\r\n        if (!response.ok) {\r\n            throw new Error(data.error?.message || 'Google API Error');\r\n        }\r\n\r\n        if (!data.items) {\r\n            return NextResponse.json({ results: [], source: 'google' });\r\n        }\r\n\r\n        const mappedResults: SearchResult[] = data.items.map((item: any) => ({\r\n            title: item.title,\r\n            url: item.link || '',\r\n            snippet: item.snippet,\r\n            source: item.displayLink || new URL(item.link).hostname,\r\n            date: new Date().toISOString().split('T')[0], // Google API doesn't always return date, default to today or extract if possible\r\n            type: 'other' // Search results lack semantic type, default to other\r\n        }));\r\n\r\n        return NextResponse.json({ results: mappedResults, source: 'google' });\r\n\r\n    } catch (error) {\r\n        console.error(\"Google Search failed:\", error);\r\n        // Fallback to mock on error to keep UI usable\r\n        return NextResponse.json({\r\n            results: MOCK_RESULTS,\r\n            source: 'mock_fallback',\r\n            error: error instanceof Error ? error.message : 'Unknown error'\r\n        });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\risk-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\search-traces\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\search\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'maxResults' is assigned a value but never used.","line":20,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\r\nimport { executeGoogleSearch, curateResultsWithAI, getMockResults, SearchResult } from '@/lib/search-service';\r\nimport { auth } from '@clerk/nextjs/server';\r\n\r\nexport async function POST(req: Request) {\r\n    let { userId } = await auth();\r\n\r\n    // Check for demo user if not authenticated\r\n    if (!userId && process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n        const demoUserId = req.headers.get('x-demo-user-id');\r\n        if (demoUserId === process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n            userId = demoUserId;\r\n        }\r\n    }\r\n\r\n    if (!userId) {\r\n        return new NextResponse(\"Unauthorized\", { status: 401 });\r\n    }\r\n    try {\r\n        const { query, policyText, maxResults = 5 } = await req.json();\r\n\r\n        // Determine the search query\r\n        let searchQuery = query;\r\n\r\n        // If policyText is provided but no query, generate search terms from the policy text\r\n        if (!searchQuery && policyText) {\r\n            const apiKey = process.env.GOOGLE_API_KEY;\r\n            if (!apiKey) {\r\n                return NextResponse.json(\r\n                    { success: false, error: 'Google API key not configured for search term generation. Please set GOOGLE_API_KEY in .env.local' },\r\n                    { status: 500 }\r\n                );\r\n            }\r\n\r\n            try {\r\n                const { GoogleGenerativeAI } = await import('@google/generative-ai');\r\n                const genAI = new GoogleGenerativeAI(apiKey);\r\n                const modelName = process.env.GOOGLE_AI_MODEL || \"gemini-1.5-flash-latest\";\r\n                const model = genAI.getGenerativeModel({ model: modelName });\r\n\r\n                // EXTRACT SUBJECT ENTITY FIRST (Crucial for relevance)\r\n                // We use the AI to determine exactly WHAT this policy is about (e.g. \"European AI Act\", \"Uber Driver App\")\r\n                // This prevents generic \"AI\" searches or cross-contamination.\r\n                const subjectPrompt = `Identify the SPECIFIC Policy, Act, Bill, Platform, or Company this text describes. \r\n                Text: \"${policyText.substring(0, 1000)}\"\r\n                Return ONLY the name (e.g. \"EU AI Act\"). If unclear, return \"AI Governance Policy\".`;\r\n\r\n                const subjectResult = await model.generateContent(subjectPrompt);\r\n                const policySubject = subjectResult.response.text().trim().replace(/['\"]/g, '');\r\n                console.log(\"Extracted Policy Subject:\", policySubject);\r\n\r\n                const prompt = `You are an expert investigative researcher. \r\nYour goal is to find real-world discussions about: \"${policySubject}\".\r\n\r\nTASK:\r\nGenerate 2 very precise Google Search queries.\r\n\r\nRULES:\r\n1. **Identify the Subject**: ALWAYS include the name \"${policySubject}\" in every query.\r\n2. **FORCE Resistance Keywords**: You MUST include at least one resistance-specific term in EVERY query to find behavioral adaptations. Use terms like: \"workaround\", \"bypass\", \"trick\", \"cheat\", \"exploit\", \"jailbreak\", \"strike\", \"protest\", \"loophole\", \"refusal\".\r\n3. **Target Empirical Forums**: Combine these with \"reddit\", \"forum\", \"discussion\" to find lived experiences.\r\n4. **Avoid Generalities**: Do NOT use generic terms like \"challenges\" or \"issues\". Use \"failure\", \"glitch\", \"harm\".\r\n\r\nOUTPUT FORMAT:\r\nReturn ONLY a JSON array of strings.\r\nExample: [\"${policySubject} workaround reddit\", \"${policySubject} bypass trick forum\"]\r\n\r\n[\"Query 1\", \"Query 2\"]`;\r\n\r\n                const result = await model.generateContent(prompt);\r\n                const response = result.response;\r\n                const content = response.text().trim();\r\n\r\n                // Parse the JSON response (handle potential markdown wrapping)\r\n                const jsonMatch = content.match(/\\[[\\s\\S]*\\]/);\r\n                const searchTerms = jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(content);\r\n\r\n                if (Array.isArray(searchTerms) && searchTerms.length > 0) {\r\n                    searchQuery = searchTerms[0]; // Use the first search term\r\n                } else {\r\n                    console.warn('Failed to parse search terms, falling back.');\r\n                }\r\n            } catch (aiError) {\r\n                console.error('AI search term generation error:', aiError);\r\n                // Fallback: Try to extract potential title\r\n                const firstLine = policyText.split('\\n')[0].substring(0, 100);\r\n                const fallbackQuery = (firstLine.length < 50 ? firstLine : firstLine.split(' ').slice(0, 6).join(' ')) + \" resistance\";\r\n                searchQuery = fallbackQuery;\r\n                console.log('Falling back to basic query:', searchQuery);\r\n            }\r\n        }\r\n\r\n        if (!searchQuery) {\r\n            return NextResponse.json(\r\n                { success: false, error: 'Either query or policyText is required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const googleApiKey = process.env.GOOGLE_SEARCH_API_KEY;\r\n        const cx = process.env.GOOGLE_SEARCH_CX || process.env.GOOGLE_SEARCH_ENGINE_ID;\r\n        const aiApiKey = process.env.GOOGLE_API_KEY;\r\n\r\n        // MOCK FALLBACK: If keys are missing, return realistic mock data\r\n        if (!googleApiKey || !cx || !aiApiKey) {\r\n            console.warn(\"Google Search/AI keys missing. Returning MOCK results.\");\r\n            return NextResponse.json({\r\n                success: true,\r\n                results: getMockResults(searchQuery),\r\n                searchQuery,\r\n                isMock: true\r\n            });\r\n        }\r\n\r\n        // AGGREGATION STRATEGY: Run multiple variations to maximize yield\r\n        const strictQuery = `${searchQuery} (site:reddit.com OR site:news.ycombinator.com OR site:*.stackexchange.com OR site:x.com OR site:twitter.com OR site:medium.com OR site:substack.com OR inurl:forum OR inurl:discussion)`;\r\n        const relaxedQuery = `${searchQuery} discussion opinion experience problem`;\r\n\r\n        // Typology Queries\r\n        const techniqueQuery = `${searchQuery} workaround bypass hack trick jailbreak spoof`;\r\n        const collectiveQuery = `${searchQuery} strike union protest boycott refused banned quit`;\r\n\r\n        console.log(\"Running parallel search strategies via SearchService...\");\r\n        const [strictResults, relaxedResults, techniqueResults, collectiveResults] = await Promise.all([\r\n            executeGoogleSearch(strictQuery, googleApiKey, cx),\r\n            executeGoogleSearch(relaxedQuery, googleApiKey, cx),\r\n            executeGoogleSearch(techniqueQuery, googleApiKey, cx),\r\n            executeGoogleSearch(collectiveQuery, googleApiKey, cx)\r\n        ]);\r\n\r\n        // Merge and Deduplicate by Link\r\n        const allRawResults = [...strictResults, ...techniqueResults, ...collectiveResults, ...relaxedResults];\r\n        const uniqueMap = new Map<string, SearchResult>();\r\n        allRawResults.forEach(r => {\r\n            if (!uniqueMap.has(r.link)) uniqueMap.set(r.link, r);\r\n        });\r\n\r\n        const results = Array.from(uniqueMap.values());\r\n        console.log(`Aggregated ${results.length} unique raw results.`);\r\n\r\n        // Final check for empty\r\n        if (results.length === 0) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                results: [],\r\n                searchQuery\r\n            });\r\n        }\r\n\r\n        // AI CURATION STEP using Service\r\n        console.log(\"Starting AI Curation Service...\");\r\n        const curatedResults = await curateResultsWithAI(results, policyText, aiApiKey);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            results: curatedResults,\r\n            searchQuery\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Search API Error:', error);\r\n        return NextResponse.json(\r\n            { success: false, error: 'Internal Server Error' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\sources\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\sources\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\api\\storage\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\comparison\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PlayCircle' is defined but never used.","line":11,"column":110,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":120},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Network' is defined but never used.","line":11,"column":122,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":129},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":176,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7675,7678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7675,7678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":583,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[33129,33191],"text":"Click &quot;Synthesize\" to generate a comparative analysis for the "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[33129,33191],"text":"Click &ldquo;Synthesize\" to generate a comparative analysis for the "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[33129,33191],"text":"Click &#34;Synthesize\" to generate a comparative analysis for the "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[33129,33191],"text":"Click &rdquo;Synthesize\" to generate a comparative analysis for the "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":583,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[33129,33191],"text":"Click \"Synthesize&quot; to generate a comparative analysis for the "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[33129,33191],"text":"Click \"Synthesize&ldquo; to generate a comparative analysis for the "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[33129,33191],"text":"Click \"Synthesize&#34; to generate a comparative analysis for the "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[33129,33191],"text":"Click \"Synthesize&rdquo; to generate a comparative analysis for the "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6792,6795],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6792,6795],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n// Force rebuild trigger\r\n\r\nimport { useState, useEffect, useMemo } from \"react\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { ArrowLeftRight, Globe2, Scale, Users, Building, Loader2, Sparkles, AlertTriangle, RefreshCw, Wand2, PlayCircle, Network } from \"lucide-react\";\r\nimport { LegitimacyAnalysisView } from \"@/components/policy/LegitimacyAnalysisView\";\r\nimport { synthesizeComparison, analyzeDocument } from \"@/services/analysis\";\r\nimport { PositionalityDialog } from \"@/components/reflexivity/PositionalityDialog\";\r\nimport { MutationTable } from \"@/components/comparison/MutationTable\";\r\nimport { StabilizationCard } from \"@/components/comparison/StabilizationCard\";\r\nimport { RhizomeNetwork } from \"@/components/comparison/RhizomeNetwork\";\r\nimport { LensSelector, InterpretationLens } from \"@/components/comparison/LensSelector\";\r\nimport { RebuttalPopover } from \"@/components/comparison/RebuttalPopover\";\r\n\r\nimport { Source, ComparativeSynthesis, PositionalityData } from \"@/types\";\r\n\r\nexport default function ComparisonPage() {\r\n    const { sources, isLoading, updateSource } = useSources();\r\n\r\n    // Filter for policy documents (non-traces)\r\n    const policyDocs = useMemo(() => sources.filter(s => s.type !== \"Trace\"), [sources]);\r\n\r\n    const [selectedDocs, setSelectedDocs] = useState<string[]>([]);\r\n    const [activeTab, setActiveTab] = useState<\"cultural\" | \"logics\" | \"legitimacy\" | \"synthesis\">(\"cultural\");\r\n    const [activeLens, setActiveLens] = useState<InterpretationLens>(\"assemblage\");\r\n    const [isSynthesizing, setIsSynthesizing] = useState(false);\r\n    const [synthesisResults, setSynthesisResults] = useServerStorage<Record<string, ComparativeSynthesis>>(\"comparison_synthesis_results_v2\", {});\r\n    const [synthesisError, setSynthesisError] = useState<string | null>(null);\r\n\r\n    // Deep Analysis State\r\n    const [isPositionalityOpen, setIsPositionalityOpen] = useState(false);\r\n    const [analyzingSourceId, setAnalyzingSourceId] = useState<string | null>(null);\r\n    const [isDeepAnalyzing, setIsDeepAnalyzing] = useState<Record<string, boolean>>({});\r\n\r\n    // Derived state for current lens\r\n    const currentResult = synthesisResults?.[activeLens] || null;\r\n\r\n    useEffect(() => {\r\n        if (isLoading) return;\r\n\r\n        // Auto-select first two docs\r\n        if (policyDocs.length >= 2 && selectedDocs.length === 0) {\r\n            setSelectedDocs([policyDocs[0].id, policyDocs[1].id]);\r\n        }\r\n    }, [isLoading, selectedDocs.length, policyDocs]);\r\n\r\n    const selectedSources = selectedDocs\r\n        .map(id => policyDocs.find(s => s.id === id))\r\n        .filter(Boolean) as Source[];\r\n\r\n    const logicIcons = {\r\n        market: Building,\r\n        state: Scale,\r\n        professional: Users,\r\n        community: Users,\r\n    };\r\n\r\n    const logicColors = {\r\n        market: \"text-purple-600 bg-purple-100\",\r\n        state: \"text-blue-600 bg-blue-100\",\r\n        professional: \"text-green-600 bg-green-100\",\r\n        community: \"text-orange-600 bg-orange-100\",\r\n    };\r\n\r\n    const handleSynthesize = async () => {\r\n        if (selectedSources.length < 2) return;\r\n\r\n        // Validation: Check if all analyses are present\r\n        const missingAnalysis = selectedSources.some(\r\n            s => !s.cultural_framing || !s.institutional_logics || !s.legitimacy_analysis\r\n        );\r\n\r\n        if (missingAnalysis) {\r\n            setSynthesisError(\"All selected documents must have Cultural Framing, Institutional Logics, and Legitimacy analysis completed before synthesis.\");\r\n            return;\r\n        }\r\n\r\n        // Confirmation: Check if persistence data exists for THIS lens\r\n        if (currentResult) {\r\n            if (!confirm(`Existing ${activeLens} synthesis found. Do you want to re-run it? This will overwrite the current findings.`)) {\r\n                setActiveTab(\"synthesis\");\r\n                return;\r\n            }\r\n        }\r\n\r\n        setSynthesisError(null);\r\n        setIsSynthesizing(true);\r\n        setActiveTab(\"synthesis\");\r\n\r\n        try {\r\n            // Prepare documents for synthesis\r\n            const result = await synthesizeComparison(selectedSources, activeLens);\r\n\r\n            // Update the record\r\n            setSynthesisResults(prev => {\r\n                return {\r\n                    ...prev,\r\n                    [activeLens]: result as unknown as ComparativeSynthesis\r\n                }\r\n            });\r\n\r\n        } catch (error) {\r\n            console.error(\"Synthesis failed:\", error);\r\n            setSynthesisError(\"Failed to generate synthesis. Please try again.\");\r\n        } finally {\r\n            setIsSynthesizing(false);\r\n        }\r\n    };\r\n\r\n    const initiateDeepAnalysis = (sourceId: string) => {\r\n        setAnalyzingSourceId(sourceId);\r\n        setIsPositionalityOpen(true);\r\n    };\r\n\r\n    const handleRunDeepAnalysis = async (positionality: PositionalityData) => {\r\n        if (!analyzingSourceId) return;\r\n        const sourceId = analyzingSourceId;\r\n        const source = sources.find(s => s.id === sourceId);\r\n\r\n        setIsPositionalityOpen(false);\r\n        setAnalyzingSourceId(null);\r\n\r\n        if (!source || !source.extractedText) return;\r\n\r\n        setIsDeepAnalyzing(prev => ({ ...prev, [sourceId]: true }));\r\n\r\n        try {\r\n            // Run all 3 analyses in parallel\r\n            const modes = ['cultural_framing', 'institutional_logics', 'legitimacy'] as const;\r\n\r\n            const promises = modes.map(mode =>\r\n                analyzeDocument(\r\n                    source.extractedText!.substring(0, 50000),\r\n                    mode,\r\n                    'Policy Document',\r\n                    true, // Forces refresh as this is an explicit user action\r\n                    sourceId,\r\n                    source.title,\r\n                    positionality\r\n                ).then(result => ({ mode, result }))\r\n            );\r\n\r\n            const results = await Promise.all(promises);\r\n\r\n            // Construct updates\r\n            const updates: Partial<Source> = {};\r\n            results.forEach(({ mode, result }) => {\r\n                if (mode === 'cultural_framing') updates.cultural_framing = result;\r\n                if (mode === 'institutional_logics') updates.institutional_logics = result;\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                if (mode === 'legitimacy') updates.legitimacy_analysis = result as any;\r\n            });\r\n\r\n            await updateSource(sourceId, updates);\r\n            // alert(`Deep analysis complete for ${source.title}!`); // Optional: maybe too noisy\r\n\r\n        } catch (error) {\r\n            console.error(\"Deep analysis failed:\", error);\r\n            alert(\"Failed to complete deep analysis. Check console for details.\");\r\n        } finally {\r\n            setIsDeepAnalyzing(prev => ({ ...prev, [sourceId]: false }));\r\n        }\r\n    };\r\n\r\n    // Helper to render the \"Run Deep Analysis\" button if data is missing\r\n    const renderAnalysisButtonOrContent = (source: Source, type: 'cultural' | 'logics' | 'legitimacy', content: React.ReactNode) => {\r\n         \r\n        const data = (type === 'cultural' ? source.cultural_framing :\r\n            type === 'logics' ? source.institutional_logics :\r\n                source.legitimacy_analysis) as Record<string, any> | undefined;\r\n\r\n        // Check if data exists AND has meaningful content (not just empty object)\r\n        const hasData = data && Object.keys(data).length > 0;\r\n\r\n        if (hasData) {\r\n            return (\r\n                <div className=\"relative group\">\r\n                    <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"absolute top-0 right-0 z-10 bg-white/50 hover:bg-white backdrop-blur-sm border border-slate-200 shadow-sm gap-2\"\r\n                        title=\"Re-run Analysis\"\r\n                        onClick={() => initiateDeepAnalysis(source.id)}\r\n                        disabled={isDeepAnalyzing[source.id]}\r\n                    >\r\n                        {isDeepAnalyzing[source.id] ? (\r\n                            <Loader2 className=\"h-3 w-3 text-indigo-500 animate-spin\" />\r\n                        ) : (\r\n                            <RefreshCw className=\"h-3 w-3 text-slate-500\" />\r\n                        )}\r\n                        <span className=\"text-xs text-slate-500\">\r\n                            {isDeepAnalyzing[source.id] ? \"Running...\" : \"Re-run\"}\r\n                        </span>\r\n                    </Button>\r\n                    <div className=\"pt-8\">\r\n                        {content}\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center p-8 bg-slate-50 border border-dashed border-slate-300 rounded-lg text-center h-full min-h-[200px]\">\r\n                <Sparkles className=\"h-8 w-8 text-indigo-300 mb-3\" />\r\n                <h3 className=\"text-sm font-semibold text-slate-700 mb-1\">Missing {type === 'cultural' ? 'Cultural' : type === 'logics' ? 'Logics' : 'Legitimacy'} Data</h3>\r\n                <p className=\"text-xs text-slate-500 max-w-xs mb-4\">\r\n                    Run a deep analysis to generate {type} insights for this document.\r\n                </p>\r\n                <Button\r\n                    onClick={() => initiateDeepAnalysis(source.id)}\r\n                    disabled={isDeepAnalyzing[source.id]}\r\n                    className=\"bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm\"\r\n                >\r\n                    {isDeepAnalyzing[source.id] ? (\r\n                        <>\r\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                            Analyzing...\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <Wand2 className=\"mr-2 h-4 w-4\" />\r\n                            Run Deep Analysis\r\n                        </>\r\n                    )}\r\n                </Button>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            <PositionalityDialog\r\n                isOpen={isPositionalityOpen}\r\n                onClose={() => setIsPositionalityOpen(false)}\r\n                onConfirm={handleRunDeepAnalysis}\r\n            />\r\n\r\n            <div>\r\n                <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">Policy Assemblages</h2>\r\n                <p className=\"text-slate-500\">Relational mapping of policy mobilities, mutations, and institutional tensions.</p>\r\n            </div>\r\n\r\n            {/* Definitions Card */}\r\n            <Card className=\"bg-slate-50 border-slate-200\">\r\n                <CardHeader className=\"pb-3\">\r\n                    <CardTitle className=\"text-base font-semibold text-slate-700\">Analysis Definitions</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"grid gap-4 md:grid-cols-3 text-sm\">\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Globe2 className=\"h-4 w-4 text-blue-600\" />\r\n                            Cultural Framing\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            How a policy problem is constructed through specific cultural lenses (e.g., market-driven vs. rights-driven).\r\n                        </p>\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Scale className=\"h-4 w-4 text-purple-600\" />\r\n                            Institutional Logics\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            The organizing principles that shape behavior and decision-making (e.g., state, market, profession, community).\r\n                        </p>\r\n                    </div>\r\n                    <div>\r\n                        <div className=\"font-semibold text-slate-900 mb-1 flex items-center gap-2\">\r\n                            <Scale className=\"h-4 w-4 text-emerald-600\" />\r\n                            Legitimacy\r\n                        </div>\r\n                        <p className=\"text-slate-600\">\r\n                            The moral justifications used to defend or critique a system (based on Boltanski & ThÃ©venot&apos;s Orders of Worth).\r\n                        </p>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Document Selector */}\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                        <ArrowLeftRight className=\"h-5 w-5\" />\r\n                        Select Documents to Compare\r\n                    </CardTitle>\r\n                    <CardDescription>Choose 2-3 policy documents for side-by-side analysis</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                        {[0, 1, 2].map((index) => (\r\n                            <div key={index}>\r\n                                <label className=\"text-sm font-medium text-slate-700 mb-2 block\">\r\n                                    Document {index + 1} {index > 0 && \"(Optional)\"}\r\n                                </label>\r\n                                <Select\r\n                                    value={selectedDocs[index] || \"\"}\r\n                                    onValueChange={(value) => {\r\n                                        const newSelection = [...selectedDocs];\r\n                                        newSelection[index] = value;\r\n                                        setSelectedDocs(newSelection.filter(Boolean));\r\n                                    }}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"Select document...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {policyDocs.map((doc) => (\r\n                                            <SelectItem key={doc.id} value={doc.id}>\r\n                                                {doc.title}\r\n                                                {doc.jurisdiction && (\r\n                                                    <Badge variant=\"outline\" className=\"ml-2\">\r\n                                                        {doc.jurisdiction}\r\n                                                    </Badge>\r\n                                                )}\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Analysis Type Tabs */}\r\n            {selectedSources.length >= 2 && (\r\n                <>\r\n                    <div className=\"flex gap-2\">\r\n                        <Button\r\n                            variant={activeTab === \"cultural\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"cultural\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Globe2 className=\"mr-2 h-4 w-4\" />\r\n                            Cultural Framing\r\n                        </Button>\r\n                        <Button\r\n                            variant={activeTab === \"logics\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"logics\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Scale className=\"mr-2 h-4 w-4\" />\r\n                            Institutional Logics\r\n                        </Button>\r\n                        <Button\r\n                            variant={activeTab === \"legitimacy\" ? \"default\" : \"outline\"}\r\n                            onClick={() => setActiveTab(\"legitimacy\")}\r\n                            className=\"flex-1\"\r\n                        >\r\n                            <Scale className=\"mr-2 h-4 w-4\" />\r\n                            Legitimacy\r\n                        </Button>\r\n                        <div className=\"flex-1 flex gap-2\">\r\n                            <Button\r\n                                variant={activeTab === \"synthesis\" ? \"default\" : \"outline\"}\r\n                                onClick={handleSynthesize}\r\n                                className=\"flex-1 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border-indigo-200\"\r\n                            >\r\n                                {isSynthesizing ? (\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                ) : (\r\n                                    <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                )}\r\n                                Synthesize\r\n                            </Button>\r\n                            {currentResult && (\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    size=\"icon\"\r\n                                    onClick={() => {\r\n                                        if (confirm(`Clear cached synthesis for ${activeLens}?`)) {\r\n                                            setSynthesisResults(prev => {\r\n                                                const next = { ...prev };\r\n                                                delete next[activeLens];\r\n                                                return next;\r\n                                            });\r\n                                        }\r\n                                    }}\r\n                                    title=\"Clear Cache\"\r\n                                    className=\"text-slate-400 hover:text-red-600 shrink-0\"\r\n                                >\r\n                                    <RefreshCw className=\"h-4 w-4\" />\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {synthesisError && (\r\n                        <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md flex items-center gap-2 text-sm\">\r\n                            <AlertTriangle className=\"h-4 w-4\" />\r\n                            {synthesisError}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Cultural Framing Comparison */}\r\n                    {activeTab === \"cultural\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>Cultural Framing Comparison</CardTitle>\r\n                                    <CardDescription>\r\n                                        How do these jurisdictions differ in their cultural assumptions about AI governance?\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                                        {selectedSources.map((source, idx) => (\r\n                                            <div key={idx} className=\"space-y-4\">\r\n                                                {renderAnalysisButtonOrContent(source, 'cultural', (\r\n                                                    <div className=\"space-y-8 animate-in fade-in duration-500\">\r\n                                                        {/* Cultural Distinctiveness Scores */}\r\n                                                        <Card className=\"bg-slate-50 relative border-blue-100\">\r\n                                                            <CardContent className=\"pt-6 text-center\">\r\n                                                                <div className=\"text-3xl font-bold text-slate-900\">\r\n                                                                    {((source.cultural_framing?.cultural_distinctiveness_score ?? 0) * 100).toFixed(0)}%\r\n                                                                </div>\r\n                                                                <div className=\"text-sm text-slate-600 mt-1 font-medium\">\r\n                                                                    {source.title}\r\n                                                                </div>\r\n                                                                <div className=\"text-xs text-slate-500 mt-2 italic px-2\">\r\n                                                                    {source.cultural_framing?.dominant_cultural_logic}\r\n                                                                </div>\r\n                                                            </CardContent>\r\n                                                        </Card>\r\n\r\n                                                        {/* Dimension Comparison */}\r\n                                                        {([\"state_market_society\", \"technology_role\", \"rights_conception\", \"historical_context\", \"epistemic_authority\"] as const).map((dimension) => (\r\n                                                            <div key={dimension} className=\"space-y-1\">\r\n                                                                <h4 className=\"font-semibold text-xs uppercase text-slate-500\">\r\n                                                                    {dimension.replace(/_/g, \" \")}\r\n                                                                </h4>\r\n                                                                <div className=\"text-sm text-slate-700 bg-white p-3 rounded border border-slate-200\">\r\n                                                                    {source.cultural_framing?.[dimension] || \"Not analyzed\"}\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                ))}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Institutional Logics Comparison */}\r\n                    {activeTab === \"logics\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>Institutional Logics Comparison</CardTitle>\r\n                                    <CardDescription>\r\n                                        Which institutional logics dominate in each jurisdiction?\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                                        {selectedSources.map((source, idx) => (\r\n                                            <div key={idx}>\r\n                                                {renderAnalysisButtonOrContent(source, 'logics', (\r\n                                                    <div className=\"space-y-6 animate-in fade-in duration-500\">\r\n                                                        <Card className=\"bg-slate-50 relative border-purple-100\">\r\n                                                            <CardContent className=\"pt-6 text-center\">\r\n                                                                <Badge className=\"text-lg px-4 py-2 capitalize mb-2\">\r\n                                                                    {source.institutional_logics?.dominant_logic || \"Unknown\"}\r\n                                                                </Badge>\r\n                                                                <div className=\"text-sm font-medium text-slate-900\">\r\n                                                                    {source.title}\r\n                                                                </div>\r\n                                                            </CardContent>\r\n                                                        </Card>\r\n\r\n                                                        {/* Logic Strengths */}\r\n                                                        <div className=\"space-y-3\">\r\n                                                            {([\"market\", \"state\", \"professional\", \"community\"] as const).map(logic => {\r\n                                                                const Icon = logicIcons[logic];\r\n                                                                const logicData = source.institutional_logics?.logics?.[logic];\r\n                                                                return (\r\n                                                                    <div key={logic} className={`p-3 rounded border ${logicColors[logic].replace('text-', 'border-').replace('bg-', 'bg-opacity-10 ')}`}>\r\n                                                                        <div className=\"flex items-center justify-between mb-2\">\r\n                                                                            <div className=\"flex items-center gap-2 font-semibold capitalize text-sm\">\r\n                                                                                <Icon className=\"h-4 w-4\" />\r\n                                                                                {logic}\r\n                                                                            </div>\r\n                                                                            <span className=\"text-sm font-bold\">\r\n                                                                                {((logicData?.strength || 0) * 100).toFixed(0)}%\r\n                                                                            </span>\r\n                                                                        </div>\r\n                                                                        <div className=\"w-full bg-slate-200 rounded-full h-1.5 overflow-hidden\">\r\n                                                                            <div\r\n                                                                                className=\"bg-current h-full\"\r\n                                                                                style={{ width: `${(logicData?.strength || 0) * 100}%` }}\r\n                                                                            />\r\n                                                                        </div>\r\n                                                                    </div>\r\n                                                                )\r\n                                                            })}\r\n                                                        </div>\r\n\r\n                                                        {/* Conflicts */}\r\n                                                        <div>\r\n                                                            <h4 className=\"font-semibold text-xs uppercase text-slate-500 mb-2\">Key Conflicts</h4>\r\n                                                            {source.institutional_logics?.logic_conflicts?.map((conflict, cIdx) => (\r\n                                                                <div key={cIdx} className=\"text-xs p-2 bg-amber-50 rounded border border-amber-200 mb-2\">\r\n                                                                    <div className=\"font-bold text-amber-800 mb-1\">{conflict.between}</div>\r\n                                                                    <div className=\"text-slate-600 mb-1\">{conflict.site_of_conflict}</div>\r\n                                                                    <div className=\"text-slate-500 italic\">{conflict.resolution_strategy}</div>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                        </div>\r\n                                                    </div>\r\n                                                ))}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Legitimacy Analysis Comparison */}\r\n                    {activeTab === \"legitimacy\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card>\r\n                                <CardHeader>\r\n                                    <CardTitle>Legitimacy & Justification Comparison</CardTitle>\r\n                                    <CardDescription>\r\n                                        Compare the moral arguments and orders of worth used in each jurisdiction.\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent>\r\n                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                                        {selectedSources.map((source, idx) => (\r\n                                            <div key={idx} className=\"space-y-4\">\r\n                                                <div className=\"flex items-center justify-between border-b pb-2\">\r\n                                                    <h3 className=\"font-semibold text-lg\">{source.title}</h3>\r\n                                                </div>\r\n                                                {renderAnalysisButtonOrContent(source, 'legitimacy', (\r\n                                                    source.legitimacy_analysis ? (\r\n                                                        <LegitimacyAnalysisView analysis={source.legitimacy_analysis} />\r\n                                                    ) : null\r\n                                                ))}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Comparative Synthesis Tab */}\r\n                    {activeTab === \"synthesis\" && (\r\n                        <div className=\"space-y-6\">\r\n                            <Card className=\"border-indigo-100 shadow-sm\">\r\n                                <CardHeader className=\"bg-indigo-50/50\">\r\n                                    <CardTitle className=\"text-indigo-900 flex items-center gap-2\">\r\n                                        <Sparkles className=\"h-5 w-5 text-indigo-600\" />\r\n                                        Comparative Synthesis\r\n                                    </CardTitle>\r\n                                    <CardDescription>\r\n                                        AI-generated synthesis of cultural, institutional, and legitimacy dynamics across jurisdictions.\r\n                                    </CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent className=\"pt-6\">\r\n                                    {!currentResult && !isSynthesizing && (\r\n                                        <div className=\"text-center py-12 text-slate-500\">\r\n                                            <Sparkles className=\"h-12 w-12 mx-auto mb-4 text-slate-300\" />\r\n                                            <p>Click \"Synthesize\" to generate a comparative analysis for the <strong>{activeLens}</strong> lens.</p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {isSynthesizing && (\r\n                                        <div className=\"text-center py-12 text-slate-500\">\r\n                                            <Loader2 className=\"h-12 w-12 mx-auto mb-4 animate-spin text-indigo-500\" />\r\n                                            <p>Synthesizing analysis across {selectedSources.length} documents...</p>\r\n                                            <p className=\"text-xs text-slate-400 mt-2\">This may take a minute.</p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {currentResult && (\r\n                                        <div className=\"space-y-8 animate-in fade-in duration-500\">\r\n                                            {/* Top Bar: Lens Selector */}\r\n                                            <div className=\"flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200\">\r\n                                                <div className=\"text-sm font-medium text-slate-600\">Active Interpretation Lens:</div>\r\n                                                <LensSelector currentLens={activeLens} onLensChange={setActiveLens} />\r\n                                            </div>\r\n\r\n                                            {/* Executive Summary with Assemblage Tone */}\r\n                                            <div className=\"bg-gradient-to-br from-indigo-50 to-white p-6 rounded-xl border border-indigo-100 shadow-sm\">\r\n                                                <h3 className=\"text-lg font-semibold text-indigo-900 mb-4 flex items-center gap-2\">\r\n                                                    <Sparkles className=\"h-5 w-5 text-indigo-600\" />\r\n                                                    Relational Summary\r\n                                                </h3>\r\n                                                <RebuttalPopover targetId=\"summary\" initialRebuttal=\"\" onSave={(id, txt) => console.log(id, txt)}>\r\n                                                    <div className=\"prose prose-slate max-w-none text-slate-700 leading-relaxed cursor-pointer hover:bg-white/50 transition-colors rounded p-2 -ml-2\">\r\n                                                        <p className=\"whitespace-pre-wrap\">{currentResult.synthesis_summary}</p>\r\n                                                    </div>\r\n                                                </RebuttalPopover>\r\n                                            </div>\r\n\r\n                                            {/* Network & Stabilization Row */}\r\n                                            <div className=\"grid lg:grid-cols-3 gap-6 min-h-[400px]\">\r\n                                                <div className=\"lg:col-span-2 h-full\">\r\n                                                    {currentResult.assemblage_network && (\r\n                                                        <RhizomeNetwork network={currentResult.assemblage_network} />\r\n                                                    )}\r\n                                                </div>\r\n                                                <div className=\"h-full\">\r\n                                                    {currentResult.stabilization_mechanisms && (\r\n                                                        <StabilizationCard mechanisms={currentResult.stabilization_mechanisms} />\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Mutation Table */}\r\n                                            {currentResult.concept_mutations && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <MutationTable mutations={currentResult.concept_mutations} />\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Friction & Desire */}\r\n                                            {currentResult.desire_and_friction && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <h3 className=\"text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2\">\r\n                                                        <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\r\n                                                        Friction & Desire\r\n                                                    </h3>\r\n                                                    <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                                                        {currentResult.desire_and_friction.map((item, i) => (\r\n                                                            <div key={i} className=\"flex flex-col p-5 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group\">\r\n                                                                <div className=\"absolute top-0 left-0 w-1 h-full bg-amber-400 group-hover:w-2 transition-all\" />\r\n                                                                <div className=\"text-[10px] font-bold uppercase tracking-wider text-amber-600 mb-2\">{item.topic}</div>\r\n                                                                <div className=\"font-semibold text-slate-900 mb-3 leading-snug\">{item.friction_point}</div>\r\n                                                                <div className=\"mt-auto pt-3 border-t border-slate-100\">\r\n                                                                    <span className=\"text-xs text-slate-400 uppercase font-semibold\">Underlying Desire</span>\r\n                                                                    <div className=\"text-sm font-medium text-indigo-700 mt-0.5\">{item.underlying_desire}</div>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Institutional Conflicts */}\r\n                                            {currentResult.institutional_conflict && (\r\n                                                <div className=\"mt-8\">\r\n                                                    <h3 className=\"text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2\">\r\n                                                        <Building className=\"h-5 w-5 text-purple-600\" />\r\n                                                        Institutional Conflicts\r\n                                                    </h3>\r\n                                                    <div className=\"grid md:grid-cols-2 gap-4\">\r\n                                                        {currentResult.institutional_conflict?.map((conf, i) => (\r\n                                                            <Card key={i} className=\"border-purple-100 bg-purple-50/30 hover:bg-purple-50/50 transition-colors\">\r\n                                                                <CardHeader className=\"pb-2\">\r\n                                                                    <CardTitle className=\"text-base font-bold text-purple-900\">{conf.conflict_type}</CardTitle>\r\n                                                                    <CardDescription className=\"text-slate-700\">{conf.description}</CardDescription>\r\n                                                                </CardHeader>\r\n                                                                <CardContent className=\"space-y-2 text-sm\">\r\n                                                                    <div className=\"flex gap-2\">\r\n                                                                        <span className=\"font-semibold text-purple-700 whitespace-nowrap\">Evidence A:</span>\r\n                                                                        <span className=\"italic text-slate-600\">&quot;{conf.policy_a_evidence}&quot;</span>\r\n                                                                    </div>\r\n                                                                    <div className=\"flex gap-2\">\r\n                                                                        <span className=\"font-semibold text-purple-700 whitespace-nowrap\">Evidence B:</span>\r\n                                                                        <span className=\"italic text-slate-600\">&quot;{conf.policy_b_evidence}&quot;</span>\r\n                                                                    </div>\r\n                                                                </CardContent>\r\n                                                            </Card>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Legitimacy Tensions */}\r\n                                            <div>\r\n                                                <h3 className=\"text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2\">\r\n                                                    <Scale className=\"h-5 w-5 text-emerald-600\" />\r\n                                                    Legitimacy Tensions\r\n                                                </h3>\r\n                                                <div className=\"grid gap-4\">\r\n                                                    {currentResult.legitimacy_tensions?.map((tens, i) => (\r\n                                                        <Card key={i} className=\"border-emerald-100 bg-emerald-50/30\">\r\n                                                            <CardHeader className=\"pb-2\">\r\n                                                                <CardTitle className=\"text-base font-bold text-emerald-900\">{tens.tension_type}</CardTitle>\r\n                                                                <CardDescription className=\"text-slate-700\">{tens.description}</CardDescription>\r\n                                                            </CardHeader>\r\n                                                            <CardContent className=\"space-y-2 text-sm\">\r\n                                                                <div className=\"flex gap-2\">\r\n                                                                    <span className=\"font-semibold text-emerald-700 whitespace-nowrap\">Evidence A:</span>\r\n                                                                    <span className=\"italic text-slate-600\">&quot;{tens.policy_a_evidence}&quot;</span>\r\n                                                                </div>\r\n                                                                <div className=\"flex gap-2\">\r\n                                                                    <span className=\"font-semibold text-emerald-700 whitespace-nowrap\">Evidence B:</span>\r\n                                                                    <span className=\"italic text-slate-600\">&quot;{tens.policy_b_evidence}&quot;</span>\r\n                                                                </div>\r\n                                                            </CardContent>\r\n                                                        </Card>\r\n                                                    ))}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Coloniality Assessment */}\r\n                                            {currentResult.coloniality_assessment && (\r\n                                                <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-6\">\r\n                                                    <h3 className=\"text-lg font-bold text-amber-900 mb-2 flex items-center gap-2\">\r\n                                                        <AlertTriangle className=\"h-5 w-5\" />\r\n                                                        Coloniality Assessment\r\n                                                    </h3>\r\n                                                    <p className=\"text-amber-800 leading-relaxed\">\r\n                                                        {currentResult.coloniality_assessment}\r\n                                                    </p>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {selectedSources.length < 2 && (\r\n                                        <Card className=\"bg-slate-50 border-dashed\">\r\n                                            <CardContent className=\"pt-6 text-center text-slate-500\">\r\n                                                <Globe2 className=\"h-12 w-12 mx-auto mb-4 text-slate-400\" />\r\n                                                <p>Select at least 2 documents above to begin comparing</p>\r\n                                            </CardContent>\r\n                                        </Card>\r\n                                    )}\r\n                                </CardContent>\r\n                            </Card>\r\n                        </div>\r\n                    )}\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\cultural\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedLensId' is assigned a value but never used.","line":21,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'theoreticalLenses' is assigned a value but never used.","line":24,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport { Lightbulb, Sparkles, Network, Loader2, BookOpen } from \"lucide-react\";\r\nimport { CulturalHoleCard } from \"@/components/CulturalHoleCard\";\r\nimport { CulturalHoleMatrix } from \"@/components/CulturalHoleMatrix\";\r\nimport { CulturalAnalysisResult } from \"@/types/cultural\";\r\nimport { MultiLensAnalysis } from \"@/components/reflexivity/MultiLensAnalysis\";\r\n\r\nexport default function CulturalAnalysisPage() {\r\n    const { sources, isLoading } = useSources();\r\n    const [selectedSources, setSelectedSources] = useServerStorage<string[]>(\"cultural_selected_sources\", []);\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [culturalAnalysis, setCulturalAnalysis] = useServerStorage<CulturalAnalysisResult | null>(\"cultural_analysis_result_v5\", null);\r\n    const [selectedLensId, setSelectedLensId] = useServerStorage<string>(\"cultural_lens_id\", \"default\");\r\n    const [forceRefresh, setForceRefresh] = useState(false);\r\n\r\n    const theoreticalLenses = [\r\n        {\r\n            id: \"default\",\r\n            name: \"Discursive Field Analysis\",\r\n            description: \"General analysis of cultural framing, legitimacy dynamics, and epistemic authority.\",\r\n            explanation: \"This lens views the text as a 'discursive field' (Miranda et al., 2022) where meaning is contested. It focuses on how specific terms and narratives circumscribe what is considered 'true' or 'legitimate' knowledge, often privileging Western/Global North epistemologies over local or indigenous ones.\",\r\n            apiHint: \"The AI is prompted to analyze 'cultural framing,' 'epistemic authority,' and 'legitimacy dynamics.' It looks for how the text constructs the 'state-market-society' relationship.\"\r\n        },\r\n        {\r\n            id: \"institutional_logics\",\r\n            name: \"Institutional Logics\",\r\n            description: \"Focus on conflicting institutional orders (e.g., market vs. state).\",\r\n            explanation: \"Based on the work of Thornton et al. and applied by Jennings/Faraj, this lens analyzes the conflicting 'logics' (e.g., Market vs. State vs. Community) that shape the text. It identifies how these logics compete for dominance within the algorithmic assemblage.\",\r\n            apiHint: \"The AI is prompted to identify specific 'institutional logics' (Market, State, Professional, Community) and map their 'discursive and material interconnections.'\"\r\n        },\r\n        {\r\n            id: \"critical_data_studies\",\r\n            name: \"Critical Data Studies\",\r\n            description: \"Focus on power dynamics, surveillance, and data justice.\",\r\n            explanation: \"This lens focuses on power, surveillance, and data justice. It interrogates the 'data relations' and 'extractivist' practices embedded in the policy, asking who benefits from data flows and who is marginalized.\",\r\n            apiHint: \"The AI is prompted to look for 'data extractivism,' 'surveillance capitalism,' and 'algorithmic bias.' It questions the 'neutrality' of data.\"\r\n        },\r\n        {\r\n            id: \"actor_network_theory\",\r\n            name: \"Actor-Network Theory\",\r\n            description: \"Focus on the agency of non-human actors and translation processes.\",\r\n            explanation: \"This lens views the policy as an 'assemblage' of human and non-human actors (Latour, Callon). It focuses on 'translation' processesâ€”how goals are displaced and modified as they pass through different actors (e.g., how a 'fairness' goal becomes a 'bias metric').\",\r\n            apiHint: \"The AI is prompted to map the 'network of actors' and identify 'translation centers' and 'obligatory passage points.'\"\r\n        }\r\n    ];\r\n\r\n    // Filter sources that have text available for analysis\r\n    const analyzedSources = sources.filter(s => s.analysis || s.extractedText);\r\n\r\n    const toggleSource = (sourceId: string) => {\r\n        setSelectedSources((prev) =>\r\n            prev.includes(sourceId)\r\n                ? prev.filter((id) => id !== sourceId)\r\n                : [...prev, sourceId]\r\n        );\r\n    };\r\n\r\n    const handleAnalyze = async () => {\r\n        if (selectedSources.length < 2) {\r\n            alert(\"Please select at least 2 sources for cultural analysis.\");\r\n            return;\r\n        }\r\n\r\n        setIsAnalyzing(true);\r\n        console.log('Starting cultural analysis...');\r\n\r\n        try {\r\n            const sourcesToAnalyze = analyzedSources.filter((s) =>\r\n                selectedSources.includes(s.id)\r\n            );\r\n\r\n            console.log('Sources to analyze:', sourcesToAnalyze.map(s => ({ id: s.id, title: s.title, hasText: !!s.extractedText })));\r\n\r\n            const requestBody = {\r\n                sources: sourcesToAnalyze.map((s) => ({\r\n                    id: s.id,\r\n                    title: s.title,\r\n                    text: s.extractedText?.substring(0, 4000) || '',\r\n                })),\r\n                lensId: selectedLensId,\r\n                forceRefresh: forceRefresh\r\n            };\r\n\r\n            console.log('Sending request to /api/cultural-analysis...');\r\n\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n            console.log('Request headers:', headers);\r\n            console.log('Demo mode:', process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE);\r\n            console.log('Demo User ID:', process.env.NEXT_PUBLIC_DEMO_USER_ID);\r\n\r\n            const response = await fetch('/api/cultural-analysis', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify(requestBody),\r\n            });\r\n\r\n            console.log('Response status:', response.status);\r\n\r\n            if (!response.ok) {\r\n                const errorText = await response.text();\r\n                console.error('Response error:', errorText);\r\n                throw new Error(`API returned ${response.status}: ${errorText}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            console.log('Response data:', data);\r\n\r\n            if (data.success && data.analysis) {\r\n                console.log('Analysis successful, setting results');\r\n                setCulturalAnalysis(data.analysis);\r\n\r\n                // Log the methodological action\r\n                try {\r\n                    const logHeaders: HeadersInit = { 'Content-Type': 'application/json' };\r\n                    if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                        logHeaders['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n                    }\r\n\r\n                    await fetch('/api/logs', {\r\n                        method: 'POST',\r\n                        headers: logHeaders,\r\n                        body: JSON.stringify({\r\n                            action: \"Cultural Analysis\",\r\n                            details: {\r\n                                lens: selectedLensId,\r\n                                sourceCount: sourcesToAnalyze.length,\r\n                                clustersFound: data.analysis.clusters.length,\r\n                                holesFound: data.analysis.holes.length\r\n                            }\r\n                        })\r\n                    });\r\n                } catch (logError) {\r\n                    console.error(\"Failed to log action:\", logError);\r\n                }\r\n            } else {\r\n                console.error('Analysis failed:', data.error);\r\n                alert(\"Cultural analysis failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (error: unknown) {\r\n            console.error(\"Cultural analysis error:\", error);\r\n            alert(`Failed to perform cultural analysis: ${(error as Error).message || String(error)}`);\r\n        } finally {\r\n            console.log('Analysis complete, resetting button');\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const exportToCSV = () => {\r\n        if (!culturalAnalysis) return;\r\n\r\n        // 1. Clusters CSV\r\n        const clustersHeader = \"Type,Name,Themes,Sources\\n\";\r\n        const clustersRows = culturalAnalysis.clusters.map(c =>\r\n            `Cluster,\"${c.name}\",\"${c.themes.join(', ')}\",\"${c.sources.join(', ')}\"`\r\n        ).join(\"\\n\");\r\n\r\n        // 2. Holes CSV\r\n        const holesHeader = \"\\nType,Gap Between,Distance,Bridging Concepts,Opportunity,Policy Implication\\n\";\r\n        const holesRows = culturalAnalysis.holes.map(h =>\r\n            `Hole,\"${h.clusterA} - ${h.clusterB}\",${h.distance},\"${h.bridgingConcepts.join(', ')}\",\"${h.opportunity}\",\"${h.policyImplication}\"`\r\n        ).join(\"\\n\");\r\n\r\n        const csvContent = \"data:text/csv;charset=utf-8,\"\r\n            + \"Analysis Summary\\n\" + `\"${(culturalAnalysis.summary || '').replace(/\"/g, '\"\"')}\"\\n\\n`\r\n            + clustersHeader + clustersRows\r\n            + holesHeader + holesRows;\r\n\r\n        const encodedUri = encodeURI(csvContent);\r\n        const link = document.createElement(\"a\");\r\n        link.setAttribute(\"href\", encodedUri);\r\n        link.setAttribute(\"download\", `cultural_analysis_${new Date().toISOString().slice(0, 10)}.csv`);\r\n        document.body.appendChild(link);\r\n        link.click();\r\n        document.body.removeChild(link);\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            {/* Header */}\r\n            <div>\r\n                <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">\r\n                    Cultural Framing of Discursive Fields\r\n                </h2>\r\n                <p className=\"text-slate-500\">\r\n                    Identify gaps between discourse clusters within the algorithmic assemblage to discover innovation opportunities and legitimacy dynamics.\r\n                </p>\r\n            </div>\r\n\r\n            <MultiLensAnalysis sources={sources} />\r\n\r\n            {/* Introduction Card */}\r\n            <Card className=\"bg-gradient-to-br from-amber-50 to-orange-50 border-amber-200\">\r\n                <CardHeader>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Lightbulb className=\"h-5 w-5 text-amber-600\" />\r\n                        <CardTitle>What are Cultural Holes?</CardTitle>\r\n                    </div>\r\n                    <CardDescription>\r\n                        Understanding gaps in entrepreneurial ecosystems\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-3 text-sm text-slate-700\">\r\n                    <p>\r\n                        <strong>Cultural holes</strong> are gaps between clusters of understandings, practices, or discourse within a sociotechnical ecosystem. These gaps represent opportunities for new ideas, practices, or values to emerge.\r\n                    </p>\r\n                    <p>\r\n                        By analyzing discourse from multiple policy documents, this tool:\r\n                    </p>\r\n                    <ul className=\"list-disc list-inside space-y-1 ml-2\">\r\n                        <li>Extracts key themes from each document</li>\r\n                        <li>Clusters similar themes into &quot;discourse communities&quot;</li>\r\n                        <li>Identifies gaps between distant clusters</li>\r\n                        <li>Suggests bridging concepts for policy intervention</li>\r\n                    </ul>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Source Selection */}\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>Select Sources for Analysis</CardTitle>\r\n                    <CardDescription>\r\n                        Choose at least 2 analyzed documents to detect cultural holes\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                    {analyzedSources.length === 0 ? (\r\n                        <div className=\"text-center py-8 text-slate-500\">\r\n                            <p>No analyzed sources available.</p>\r\n                            <p className=\"text-sm mt-2\">\r\n                                Please upload and analyze documents on the Data page first.\r\n                            </p>\r\n                        </div>\r\n                    ) : (\r\n                        <>\r\n                            <div className=\"grid gap-3\">\r\n                                {analyzedSources.map((source) => (\r\n                                    <div\r\n                                        key={source.id}\r\n                                        className={`p-4 border-2 rounded-lg cursor-pointer transition-all ${selectedSources.includes(source.id)\r\n                                            ? \"border-amber-500 bg-amber-50\"\r\n                                            : \"border-slate-200 hover:border-slate-300\"\r\n                                            }`}\r\n                                        onClick={() => toggleSource(source.id)}\r\n                                    >\r\n                                        <div className=\"flex items-start justify-between\">\r\n                                            <div className=\"flex-1\">\r\n                                                <h4 className=\"font-semibold text-slate-900\">\r\n                                                    {source.title}\r\n                                                </h4>\r\n                                                <p className=\"text-sm text-slate-600 mt-1\">\r\n                                                    {source.description}\r\n                                                </p>\r\n                                            </div>\r\n                                            {selectedSources.includes(source.id) && (\r\n                                                <Badge className=\"bg-amber-500 text-white\">\r\n                                                    Selected\r\n                                                </Badge>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            <div className=\"flex items-center justify-between pt-4 border-t\">\r\n                                <div className=\"text-sm text-slate-600 flex items-center gap-4\">\r\n                                    <span>{selectedSources.length} source{selectedSources.length !== 1 ? 's' : ''} selected</span>\r\n                                    <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                                        <input\r\n                                            type=\"checkbox\"\r\n                                            checked={forceRefresh}\r\n                                            onChange={(e) => setForceRefresh(e.target.checked)}\r\n                                            className=\"rounded border-slate-300 text-amber-600 focus:ring-amber-500\"\r\n                                        />\r\n                                        <span className=\"text-sm text-slate-600\">Force Refresh (Ignore Cache)</span>\r\n                                    </label>\r\n                                </div>\r\n                                <Button\r\n                                    className=\"bg-amber-600 text-white hover:bg-amber-700\"\r\n                                    onClick={handleAnalyze}\r\n                                    disabled={selectedSources.length < 2 || isAnalyzing}\r\n                                >\r\n                                    {isAnalyzing ? (\r\n                                        <>\r\n                                            <Sparkles className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                            Analyzing...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <Lightbulb className=\"mr-2 h-4 w-4\" />\r\n                                            Detect Cultural Holes\r\n                                        </>\r\n                                    )}\r\n                                </Button>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Results */}\r\n            {culturalAnalysis && (\r\n                <div className=\"space-y-6\">\r\n                    {/* Analysis Summary */}\r\n                    {culturalAnalysis.summary && (\r\n                        <Card className=\"bg-slate-50 border-slate-200\">\r\n                            <CardHeader className=\"pb-2\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Sparkles className=\"h-4 w-4 text-amber-600\" />\r\n                                        <CardTitle className=\"text-lg\">Analysis Summary</CardTitle>\r\n                                    </div>\r\n                                    <Button variant=\"outline\" size=\"sm\" onClick={exportToCSV}>\r\n                                        Export CSV\r\n                                    </Button>\r\n                                </div>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <p className=\"text-sm text-slate-700 leading-relaxed\">\r\n                                    {culturalAnalysis.summary}\r\n                                </p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n\r\n\r\n                    {/* Explanation Card */}\r\n                    <Card className=\"bg-blue-50 border-blue-200\">\r\n                        <CardHeader>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <BookOpen className=\"h-5 w-5 text-blue-600\" />\r\n                                <CardTitle className=\"text-base\">Understanding Cultural Holes</CardTitle>\r\n                            </div>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-3 text-sm text-slate-700\">\r\n                            <div>\r\n                                <p className=\"font-semibold text-blue-900 mb-1\">What are Discourse Clusters?</p>\r\n                                <p>Groups of related themes that use similar language and concepts. Each cluster represents a coherent &quot;discourse community&quot; within your analyzed documents.</p>\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"font-semibold text-blue-900 mb-1\">What are Cultural Holes?</p>\r\n                                <p>Gaps between discourse clusters where concepts don&apos;t overlap. These represent areas where different stakeholder groups or policy frameworks aren&apos;t connecting with each other.</p>\r\n                            </div>\r\n                            <div className=\"bg-white p-3 rounded border border-blue-200\">\r\n                                <p className=\"font-semibold text-blue-900 mb-1\">ðŸ’¡ Why This Matters</p>\r\n                                <p>Cultural holes reveal <span className=\"font-semibold\">innovation opportunities</span> and <span className=\"font-semibold\">policy blind spots</span>. The &quot;bridging concepts&quot; suggest ways to connect isolated conversations and create more holistic governance frameworks.</p>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Network Visualization */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Network className=\"h-5 w-5 text-blue-600\" />\r\n                                <CardTitle>Discourse Cluster Network</CardTitle>\r\n                            </div>\r\n                            <CardDescription>\r\n                                Visual representation of theme clusters and cultural holes\r\n                            </CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <CulturalHoleMatrix\r\n                                clusters={culturalAnalysis.clusters}\r\n                                holes={culturalAnalysis.holes}\r\n                            />\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Cluster Summary */}\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle>Discourse Clusters</CardTitle>\r\n                            <CardDescription>\r\n                                {culturalAnalysis.clusters.length} clusters identified from {selectedSources.length} sources (sorted by size)\r\n                            </CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"grid gap-4 md:grid-cols-2\">\r\n                                {[...culturalAnalysis.clusters]\r\n                                    .sort((a, b) => b.size - a.size)\r\n                                    .map((cluster) => (\r\n                                        <div\r\n                                            key={cluster.id}\r\n                                            className=\"p-4 bg-blue-50 border border-blue-200 rounded-lg\"\r\n                                        >\r\n                                            <TooltipProvider>\r\n                                                <Tooltip>\r\n                                                    <TooltipTrigger asChild>\r\n                                                        <h4 className=\"font-semibold text-blue-900 mb-2 cursor-help underline decoration-dotted\">\r\n                                                            {cluster.name}\r\n                                                        </h4>\r\n                                                    </TooltipTrigger>\r\n                                                    {cluster.description && (\r\n                                                        <TooltipContent className=\"max-w-xs bg-white\">\r\n                                                            <p className=\"text-xs text-slate-700\">{cluster.description}</p>\r\n                                                        </TooltipContent>\r\n                                                    )}\r\n                                                </Tooltip>\r\n                                            </TooltipProvider>\r\n                                            <div className=\"flex flex-wrap gap-1 mb-2\">\r\n                                                {cluster.themes.filter(theme => theme !== cluster.name).map((theme, i) => (\r\n                                                    <Badge\r\n                                                        key={i}\r\n                                                        variant=\"outline\"\r\n                                                        className=\"text-xs bg-white\"\r\n                                                    >\r\n                                                        {theme}\r\n                                                    </Badge>\r\n                                                ))}\r\n                                            </div>\r\n                                            <p className=\"text-xs text-slate-600\">\r\n                                                {cluster.size} theme{cluster.size !== 1 ? 's' : ''} from {cluster.sources.length} source{cluster.sources.length !== 1 ? 's' : ''}\r\n                                            </p>\r\n\r\n                                            {\r\n                                                cluster.quotes && cluster.quotes.length > 0 && (\r\n                                                    <details className=\"mt-3 pt-2 border-t border-blue-200\">\r\n                                                        <summary className=\"text-xs font-medium text-blue-700 cursor-pointer hover:text-blue-900 select-none flex items-center gap-1\">\r\n                                                            Show Evidence ({cluster.quotes.length})\r\n                                                        </summary>\r\n                                                        <ul className=\"mt-2 space-y-2\">\r\n                                                            {cluster.quotes.slice(0, 3).map((quote, i) => (\r\n                                                                <li key={i} className=\"text-xs text-slate-600 italic border-l-2 border-blue-300 pl-2\">\r\n                                                                    &quot;{quote.text}&quot;\r\n                                                                    <span className=\"block text-[10px] text-slate-400 not-italic mt-1\">â€” {quote.source}</span>\r\n                                                                </li>\r\n                                                            ))}\r\n                                                            {cluster.quotes.length > 3 && (\r\n                                                                <li className=\"text-xs text-blue-500 pl-2\">\r\n                                                                    + {cluster.quotes.length - 3} more citations...\r\n                                                                </li>\r\n                                                            )}\r\n                                                        </ul>\r\n                                                    </details>\r\n                                                )\r\n                                            }\r\n                                        </div>\r\n                                    ))}\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Cultural Holes */}\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Lightbulb className=\"h-6 w-6 text-amber-600\" />\r\n                            <h3 className=\"text-2xl font-bold text-slate-900\">\r\n                                Cultural Holes Detected\r\n                            </h3>\r\n                            <Badge className=\"bg-amber-100 text-amber-800\">\r\n                                {culturalAnalysis.holes.length} gap{culturalAnalysis.holes.length !== 1 ? 's' : ''}\r\n                            </Badge>\r\n                        </div>\r\n\r\n                        {culturalAnalysis.holes.length === 0 ? (\r\n                            <Card>\r\n                                <CardContent className=\"py-8 text-center text-slate-500\">\r\n                                    <p>No significant cultural holes detected.</p>\r\n                                    <p className=\"text-sm mt-2\">\r\n                                        The selected sources have highly similar discourse patterns.\r\n                                    </p>\r\n                                </CardContent>\r\n                            </Card>\r\n                        ) : (\r\n                            <div className=\"grid gap-4\">\r\n                                {culturalAnalysis.holes.map((hole) => (\r\n                                    <CulturalHoleCard\r\n                                        key={hole.id}\r\n                                        hole={hole}\r\n                                        clusters={culturalAnalysis.clusters}\r\n                                    />\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )\r\n            }\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\data\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnalysisResults' is defined but never used.","line":31,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":34,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setEcosystemActors' is assigned a value but never used.","line":53,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'editingSource' is assigned a value but never used.","line":79,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":79,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleSelectAll' is assigned a value but never used.","line":109,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":404,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":404,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19835,19838],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19835,19838],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":417,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":417,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20543,20546],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20543,20546],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20676,20679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20676,20679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n// Force cache refresh\r\n\r\n\r\nimport { useState, useRef } from \"react\";\r\nimport { AiAbsenceAnalysis } from \"@/types/ecosystem\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { ReportData, LensType } from \"@/types/report\";\r\nimport {\r\n    ResistanceSynthesisResult,\r\n    EcosystemImpact,\r\n    AnalysisResult,\r\n    Source,\r\n    LegitimacyAnalysis,\r\n    ComparativeSynthesis,\r\n    PositionalityData\r\n} from \"@/types\";\r\nimport { EcosystemActor, EcosystemConfiguration, CulturalHolesAnalysisResult } from \"@/types/ecosystem\";\r\nimport { CulturalAnalysisResult } from \"@/types/cultural\";\r\nimport { ComparisonResult as OntologyComparisonResult, OntologyData } from \"@/types/ontology\";\r\nimport { SynthesisComparisonResult } from \"@/types/synthesis\";\r\nimport { analyzeDocument, AnalysisMode } from \"@/services/analysis\";\r\nimport { extractTextFromPDF } from \"@/utils/pdfExtractor\";\r\nimport { DocumentCard } from \"@/components/policy/DocumentCard\";\r\nimport { AddDocumentDialog } from \"@/components/policy/AddDocumentDialog\";\r\nimport { ViewSourceDialog } from \"@/components/policy/ViewSourceDialog\";\r\n// import { EditSourceDialog } from \"@/components/policy/EditSourceDialog\"; // Unused currently\r\nimport { DocumentToolbar } from \"@/components/policy/DocumentToolbar\";\r\nimport { PolicyComparisonView } from \"@/components/policy/PolicyComparisonView\";\r\nimport { AnalysisResults } from \"@/components/policy/AnalysisResults\";\r\nimport { PolicyFocusView } from \"@/components/policy/PolicyFocusView\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { AddUrlDialog } from \"@/components/policy/AddUrlDialog\";\r\nimport { PositionalityDialog } from \"@/components/reflexivity/PositionalityDialog\";\r\nimport { generateFullReportDOCX } from \"@/utils/generateFullReportDOCX\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { ExportReportDialog } from \"@/components/policy/ExportReportDialog\";\r\nimport { ReportSectionSelection } from \"@/types/report\";\r\nimport { ArtifactRepository } from \"@/components/resistance/ArtifactRepository\";\r\nimport { ResistanceArtifactView } from \"@/components/resistance/ResistanceArtifactView\";\r\nimport { ResistanceArtifact } from \"@/types/resistance\";\r\n\r\nexport default function PolicyDocumentsPage() {\r\n    // ----------------------------------------------------------------------\r\n    // 1. Hooks & State\r\n    // ----------------------------------------------------------------------\r\n    const { sources, isLoading: isSourcesLoading, addSource, updateSource, deleteSource } = useSources();\r\n\r\n    // Data for Full Report Aggregation\r\n    const [resistanceSynthesis] = useServerStorage<ResistanceSynthesisResult | null>(\"resistance_synthesis_result\", null);\r\n    const [ecosystemActors, setEcosystemActors] = useServerStorage<EcosystemActor[]>(\"ecosystem_actors\", []);\r\n    const [ecosystemConfigs] = useServerStorage<EcosystemConfiguration[]>(\"ecosystem_configurations\", []);\r\n    const [culturalHoles] = useServerStorage<CulturalHolesAnalysisResult | null>(\"ecosystem_cultural_holes\", null);\r\n    const [absenceAnalysis] = useServerStorage<AiAbsenceAnalysis | null>(\"ecosystem_absence_analysis\", null);\r\n    const [synthesisComparison] = useServerStorage<SynthesisComparisonResult | null>(\"synthesis_comparison_result\", null);\r\n    const [comparativeSynthesisResults] = useServerStorage<Record<string, ComparativeSynthesis>>(\"comparison_synthesis_results_v2\", {});\r\n    const [culturalAnalysis] = useServerStorage<CulturalAnalysisResult | null>(\"cultural_analysis_result_v5\", null);\r\n    const [synthesisImpacts] = useServerStorage<EcosystemImpact[]>(\"synthesis_ecosystem_impacts\", []);\r\n    const [ontologyMaps] = useServerStorage<Record<string, OntologyData>>(\"ontology_maps\", {});\r\n    const [ontologyComparison] = useServerStorage<OntologyComparisonResult | null>(\"ontology_comparison_result\", null);\r\n    const [multiLensResults] = useServerStorage<Record<string, AnalysisResult | null>>(\"multi_lens_results\", {\r\n        dsf: null, cultural_framing: null, institutional_logics: null, legitimacy: null\r\n    });\r\n    const [multiLensText] = useServerStorage<string>(\"multi_lens_text\", \"\");\r\n\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\r\n    const [isUrlDialogOpen, setIsUrlDialogOpen] = useState(false);\r\n    const [isExportReportDialogOpen, setIsExportReportDialogOpen] = useState(false);\r\n    const [analyzingId, setAnalyzingId] = useState<string | null>(null);\r\n    const [searchingId, setSearchingId] = useState<string | null>(null);\r\n    const [focusedSourceId, setFocusedSourceId] = useState<string | null>(null);\r\n\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [isExporting, setIsExporting] = useState(false);\r\n    const [viewingSource, setViewingSource] = useState<Source | null>(null);\r\n    const [editingSource, setEditingSource] = useState<Source | null>(null);\r\n    const [isPositionalityDialogOpen, setIsPositionalityDialogOpen] = useState(false);\r\n    const [pendingAnalysis, setPendingAnalysis] = useState<{ sourceId: string, mode: AnalysisMode, force: boolean } | null>(null);\r\n    const fileInputRef = useRef<HTMLInputElement | null>(null);\r\n\r\n    const [selectedIds, setSelectedIds] = useState<string[]>([]);\r\n    const [selectedArtifact, setSelectedArtifact] = useState<ResistanceArtifact | null>(null);\r\n\r\n    // ----------------------------------------------------------------------\r\n    // 2. Computed Values\r\n    // ----------------------------------------------------------------------\r\n    const filteredSources = sources.filter(source =>\r\n        source.type !== 'Trace' &&\r\n        (source.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n            source.description.toLowerCase().includes(searchQuery.toLowerCase()))\r\n    );\r\n\r\n    const selectedSources = sources.filter(s => selectedIds.includes(s.id));\r\n\r\n    // ----------------------------------------------------------------------\r\n    // 3. Handlers\r\n    // ----------------------------------------------------------------------\r\n    const toggleSelection = (id: string, selected: boolean) => {\r\n        if (selected) {\r\n            setSelectedIds(prev => [...prev, id]);\r\n        } else {\r\n            setSelectedIds(prev => prev.filter(sid => sid !== id));\r\n        }\r\n    };\r\n\r\n    const handleSelectAll = () => {\r\n        if (selectedIds.length === filteredSources.length) {\r\n            setSelectedIds([]);\r\n        } else {\r\n            setSelectedIds(filteredSources.map(s => s.id));\r\n        }\r\n    };\r\n\r\n    const handlePDFUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        setIsUploading(true);\r\n        try {\r\n            const extractionResult = await extractTextFromPDF(file);\r\n            const text = typeof extractionResult === 'string' ? extractionResult : extractionResult.text;\r\n            const newDoc: Source = {\r\n                id: Date.now().toString(),\r\n                title: file.name.replace('.pdf', ''),\r\n                description: `Uploaded ${new Date().toLocaleDateString()} `,\r\n                type: \"PDF\",\r\n                addedDate: new Date().toLocaleDateString(),\r\n                status: \"Active Case\",\r\n                colorClass: \"bg-purple-100\",\r\n                iconClass: \"text-purple-600\",\r\n                extractedText: text\r\n            };\r\n            await addSource(newDoc);\r\n            alert('PDF uploaded successfully!');\r\n        } catch (error) {\r\n            console.error('PDF upload error:', error);\r\n            alert('Failed to upload PDF. Please try again.');\r\n        } finally {\r\n            setIsUploading(false);\r\n            if (fileInputRef.current) {\r\n                fileInputRef.current.value = '';\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleUrlAdd = async (url: string) => {\r\n        const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n        if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n            headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n        }\r\n\r\n        const response = await fetch('/api/fetch-url', {\r\n            method: 'POST',\r\n            headers: headers,\r\n            body: JSON.stringify({ url })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!response.ok) {\r\n            throw new Error(data.error || 'Failed to fetch URL');\r\n        }\r\n\r\n        const newDoc: Source = {\r\n            id: Date.now().toString(),\r\n            title: data.title || url,\r\n            description: `Fetched from ${new URL(url).hostname} `,\r\n            type: \"Web\",\r\n            addedDate: new Date().toLocaleDateString(),\r\n            status: \"Active Case\",\r\n            colorClass: \"bg-emerald-100\",\r\n            iconClass: \"text-emerald-600\",\r\n            extractedText: data.content,\r\n            url: data.url\r\n        };\r\n\r\n        await addSource(newDoc);\r\n        alert('Website content added successfully!');\r\n    };\r\n\r\n    const handleAddSource = async (title: string, description: string, pageCount: string, publicationDate: string, version: string) => {\r\n        const source: Source = {\r\n            id: Date.now().toString(),\r\n            title,\r\n            description,\r\n            type: \"Text\",\r\n            pageCount: pageCount ? parseInt(pageCount) : undefined,\r\n            publicationDate: publicationDate || undefined,\r\n            version: version || undefined,\r\n            addedDate: new Date().toLocaleDateString(),\r\n            status: \"Active Case\",\r\n            colorClass: \"bg-blue-100\",\r\n            iconClass: \"text-blue-600\"\r\n        };\r\n        await addSource(source);\r\n    };\r\n\r\n    const handleEditSource = async (sourceId: string, updates: Partial<Source>) => {\r\n        await updateSource(sourceId, updates);\r\n    };\r\n\r\n    const handleAnalyze = async (sourceId: string, mode: AnalysisMode) => {\r\n        const source = sources.find(s => s.id === sourceId);\r\n        if (!source || !source.extractedText) {\r\n            alert('No text available to analyze. Please upload a PDF or add text first.');\r\n            return;\r\n        }\r\n\r\n        let force = false;\r\n        const hasAnalysis =\r\n            (mode === 'dsf' && source.analysis) ||\r\n            (mode === 'cultural_framing' && source.cultural_framing) ||\r\n            (mode === 'institutional_logics' && source.institutional_logics) ||\r\n            (mode === 'legitimacy' && source.legitimacy_analysis) ||\r\n            (mode === 'stress_test' && source.analysis?.stress_test_report);\r\n\r\n        if (hasAnalysis) {\r\n            if (!confirm('Analysis already exists for this document. Click OK to FORCE a re-run (bypassing cache), or Cancel to abort.')) {\r\n                return;\r\n            }\r\n            force = true;\r\n        }\r\n\r\n        setPendingAnalysis({ sourceId, mode, force });\r\n        setIsPositionalityDialogOpen(true);\r\n    };\r\n\r\n    const proceedWithAnalysis = async (positionalityData: PositionalityData) => {\r\n        if (!pendingAnalysis) return;\r\n        const { sourceId, mode, force } = pendingAnalysis;\r\n        const source = sources.find(s => s.id === sourceId);\r\n\r\n        setIsPositionalityDialogOpen(false); // Close dialog immediately\r\n\r\n        if (!source || !source.extractedText) return;\r\n\r\n        setAnalyzingId(sourceId);\r\n        try {\r\n            const result = await analyzeDocument(\r\n                source.extractedText.substring(0, 150000),\r\n                mode,\r\n                'Policy Document',\r\n                force,\r\n                sourceId,\r\n                source.title,\r\n                positionalityData,\r\n                source.analysis // Pass existing analysis to avoid re-running it during stress test\r\n            );\r\n\r\n            const updates: Partial<Source> = {};\r\n            if (mode === 'dsf') updates.analysis = result;\r\n            if (mode === 'cultural_framing') updates.cultural_framing = result;\r\n            if (mode === 'institutional_logics') updates.institutional_logics = result;\r\n            if (mode === 'legitimacy') updates.legitimacy_analysis = result as unknown as LegitimacyAnalysis;\r\n            if (mode === 'stress_test') {\r\n                // The API returns a full analysis object including standard DSF fields AND stress_test_report\r\n                updates.analysis = result;\r\n            }\r\n\r\n            await updateSource(sourceId, updates);\r\n\r\n            if (mode === 'dsf' || mode === 'stress_test') {\r\n                alert('Analysis complete! Scroll down to see results inside the document card.');\r\n            } else {\r\n                alert(`âœ… ${mode === 'cultural_framing' ? 'Cultural framing' : mode === 'institutional_logics' ? 'Institutional logics' : 'Legitimacy'} analysis complete! Go to Comparison page to view results.`);\r\n            }\r\n        } catch (error: unknown) {\r\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n            alert(`Analysis failed: ${errorMessage} `);\r\n        } finally {\r\n            setAnalyzingId(null);\r\n            setPendingAnalysis(null);\r\n        }\r\n    };\r\n\r\n    const handleFindTraces = async (source: Source) => {\r\n        if (!source.extractedText) {\r\n            alert('Please upload a PDF or add text first before finding traces.');\r\n            return;\r\n        }\r\n\r\n        setSearchingId(source.id);\r\n        try {\r\n            // Generate search terms from the document text\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/search', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    policyText: source.extractedText.substring(0, 3000),\r\n                    maxResults: 10\r\n                })\r\n            });\r\n\r\n            const result = await response.json();\r\n\r\n            if (result.success && Array.isArray(result.results) && result.results.length > 0) {\r\n                console.log(\"DEBUG: Data Page Search Results:\", result.results);\r\n                // Create trace sources from search results\r\n                const newTraces: Source[] = result.results.map((item: { title: string; snippet: string; link: string; strategy?: string; explanation?: string }) => ({\r\n                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),\r\n                    title: `[Trace] ${item.title} `,\r\n                    description: item.snippet || 'No description available',\r\n                    type: \"Trace\" as const,\r\n                    extractedText: `${item.snippet} \\n\\nSource: ${item.link} \\n\\nFound via search for: \"${result.searchQuery || 'policy analysis'}\"\\n\\nInitial Classification: ${item.strategy || 'None'} `,\r\n                    addedDate: new Date().toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" }),\r\n                    status: \"Active Case\" as const,\r\n                    colorClass: \"bg-blue-100\",\r\n                    iconClass: \"text-blue-600\",\r\n                    policyId: source.id, // Linked to the policy document\r\n                    resistance_analysis: item.strategy ? {\r\n                        strategy_detected: item.strategy,\r\n                        evidence_quote: item.snippet,\r\n                        interpretation: item.explanation || \"âš ï¸ NO INTERPRETATION RECEIVED\",\r\n                        confidence: \"Medium\" // Start with medium confidence until verified\r\n                    } : undefined\r\n                }));\r\n\r\n                // Add all traces to the store\r\n                for (const trace of newTraces) {\r\n                    await addSource(trace);\r\n                }\r\n\r\n                alert(`âœ… Found ${newTraces.length} empirical traces! Added to sources.`);\r\n            } else {\r\n                alert(`No traces found.${result.error || 'Try analyzing the document first or check your Google Search API configuration.'} `);\r\n            }\r\n        } catch (error: unknown) {\r\n            console.error('Search error:', error);\r\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n            alert(`Failed to search for traces: ${errorMessage} \\n\\nMake sure your Google Search API credentials are configured in .env.local`);\r\n        } finally {\r\n            setSearchingId(null);\r\n        }\r\n    };\r\n\r\n    const handleDelete = async (sourceId: string) => {\r\n        if (confirm('Are you sure you want to delete this source?')) {\r\n            await deleteSource(sourceId);\r\n        }\r\n    };\r\n\r\n    // Helper to manually fetch storage data (since hooks can't be used inside the handler)\r\n    const fetchServerStorage = async <T,>(key: string): Promise<T | null> => {\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n            const response = await fetch(`/api/storage?key=${encodeURIComponent(key)}`, { headers });\r\n            if (response.ok) {\r\n                const data = await response.json();\r\n                return data.value as T;\r\n            }\r\n        } catch (error) {\r\n            console.error(`Failed to fetch storage key \"${key}\":`, error);\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const handleGenerateReport = async (selection: ReportSectionSelection) => {\r\n        setIsExporting(true);\r\n        try {\r\n            // Determine Context for Ecosystem Data\r\n            // Priority:\r\n            // 1. First selected document (if comparing or selecting)\r\n            // 2. Focused document\r\n            // 3. Fallback to global/temp keys (current behavior)\r\n\r\n            const contextId = selectedIds.length > 0 ? selectedIds[0] : (focusedSourceId || null);\r\n\r\n            let finalActors = ecosystemActors;\r\n            let finalConfigs = ecosystemConfigs;\r\n            let finalHoles = culturalHoles;\r\n            let finalAbsence = absenceAnalysis;\r\n\r\n            if (contextId) {\r\n                console.log(`Fetching Ecosystem Context for Policy ID: ${contextId}`);\r\n                const [actorsData, configsData, holesData, absenceData] = await Promise.all([\r\n                    fetchServerStorage<EcosystemActor[]>(`ecosystem_actors_${contextId}`),\r\n                    fetchServerStorage<EcosystemConfiguration[]>(`ecosystem_configurations_${contextId}`),\r\n                    fetchServerStorage<CulturalHolesAnalysisResult>(`ecosystem_cultural_holes_${contextId}`),\r\n                    fetchServerStorage<AiAbsenceAnalysis>(`ecosystem_absence_analysis_${contextId}`)\r\n                ]);\r\n\r\n                if (actorsData) finalActors = actorsData;\r\n                if (configsData) finalConfigs = configsData;\r\n                if (holesData) finalHoles = holesData;\r\n                if (absenceData) finalAbsence = absenceData;\r\n\r\n                console.log(`Ecosystem Data Fetched - Actors: ${finalActors?.length || 0}, Configs: ${finalConfigs?.length || 0}`);\r\n            } else {\r\n                console.warn('No contextId found for ecosystem data - using global state (likely empty)');\r\n            }\r\n\r\n            // Fetch methodological logs\r\n            const methodLogs = await fetchServerStorage<any[]>('methodological_logs') || [];\r\n\r\n            // Fetch resistance artifacts\r\n            const resistanceArtifacts = await fetchServerStorage<ResistanceArtifact[]>('resistance_artifacts') || [];\r\n\r\n            const reportData: ReportData = {\r\n                sources: sources, // Or just selectedSources? The generator filters internally based on 'analyzedSources' logic anyway.\r\n                resistance: resistanceSynthesis,\r\n                ecosystem: {\r\n                    actors: finalActors,\r\n                    configurations: finalConfigs,\r\n                    culturalHoles: finalHoles,\r\n                    absenceAnalysis: finalAbsence,\r\n                    assemblage: finalAbsence as any\r\n                },\r\n                synthesis: {\r\n                    comparison: (comparativeSynthesisResults['assemblage'] as any) || synthesisComparison,\r\n                    ecosystemImpacts: synthesisImpacts\r\n                },\r\n                ontology: {\r\n                    maps: ontologyMaps,\r\n                    comparison: ontologyComparison\r\n                },\r\n                multiLens: {\r\n                    results: multiLensResults as Record<LensType, AnalysisResult | null>,\r\n                    text: multiLensText\r\n                },\r\n                cultural: culturalAnalysis,\r\n                logs: methodLogs,\r\n                resistanceArtifacts: resistanceArtifacts\r\n            };\r\n\r\n            await generateFullReportDOCX(reportData, selection);\r\n        } catch (error) {\r\n            console.error(\"Export error:\", error);\r\n            alert(\"Failed to generate report.\");\r\n        } finally {\r\n            setIsExporting(false);\r\n        }\r\n    };\r\n\r\n    // ----------------------------------------------------------------------\r\n    // 4. Render\r\n    // ----------------------------------------------------------------------\r\n    if (isSourcesLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"container mx-auto p-6 max-w-7xl animate-in fade-in duration-500\">\r\n            {/* Header Area */}\r\n            <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-black text-slate-900 tracking-tight\">Data & Policy Analysis</h1>\r\n                    <p className=\"text-slate-500 mt-1\">Manage documents, run diagnostics, and compare frameworks.</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3 w-full md:w-auto\">\r\n                    <DocumentToolbar\r\n                        searchQuery={searchQuery}\r\n                        onSearchChange={setSearchQuery}\r\n                        onUpload={handlePDFUpload}\r\n                        isUploading={isUploading}\r\n                        fileInputRef={fileInputRef}\r\n                        onAddClick={() => setIsAddDialogOpen(true)}\r\n                        onAddUrlClick={() => setIsUrlDialogOpen(true)}\r\n                        onExportReport={() => setIsExportReportDialogOpen(true)}\r\n                        isExporting={isExporting}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content Tabs */}\r\n            <Tabs defaultValue=\"documents\" className=\"w-full\">\r\n                <div className=\"flex items-center justify-between mb-6\">\r\n                    <TabsList className=\"bg-slate-100 p-1\">\r\n                        <TabsTrigger value=\"documents\" className=\"uppercase text-xs font-bold px-4\">My Documents</TabsTrigger>\r\n                        <TabsTrigger value=\"resistance\" className=\"uppercase text-xs font-bold px-4\">Resistance</TabsTrigger>\r\n                        <TabsTrigger value=\"compare\" className=\"uppercase text-xs font-bold px-4\">\r\n                            Compare <span className=\"ml-2 bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full text-[10px]\">{selectedIds.length}</span>\r\n                        </TabsTrigger>\r\n                    </TabsList>\r\n                </div>\r\n\r\n                <TabsContent value=\"documents\" className=\"space-y-4\">\r\n                    {filteredSources.length === 0 ? (\r\n                        <div className=\"text-center py-20 bg-slate-50 rounded-2xl border border-dashed border-slate-200\">\r\n                            <div className=\"bg-white p-4 rounded-full w-16 h-16 mx-auto mb-4 shadow-sm flex items-center justify-center\">\r\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-slate-300\"><path d=\"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z\" /><polyline points=\"14 2 14 8 20 8\" /></svg>\r\n                            </div>\r\n                            <h3 className=\"text-lg font-bold text-slate-700\">No documents found</h3>\r\n                            <p className=\"text-slate-500 text-sm mt-1\">Upload a PDF or add a URL to get started.</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className={`grid grid-cols-1 md:grid-cols-2 gap-6 ${focusedSourceId ? 'hidden' : ''}`}>\r\n                            {filteredSources.map((source) => (\r\n                                <DocumentCard\r\n                                    key={source.id}\r\n                                    source={source}\r\n                                    isAnalyzing={analyzingId === source.id}\r\n                                    isSearching={searchingId === source.id}\r\n                                    isSelected={selectedIds.includes(source.id)}\r\n                                    onSelect={(selected) => toggleSelection(source.id, selected)}\r\n                                    onAnalyze={handleAnalyze}\r\n                                    onDelete={handleDelete}\r\n                                    onEdit={(s) => { setEditingSource(s); }}\r\n                                    onFindTraces={handleFindTraces}\r\n                                    onView={(s) => setViewingSource(s)}\r\n                                    onUpdateSource={handleEditSource}\r\n                                    isFocused={focusedSourceId === source.id}\r\n                                    onToggleFocus={() => setFocusedSourceId(focusedSourceId === source.id ? null : source.id)}\r\n                                />\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Focus Mode View */}\r\n                    {focusedSourceId && (() => {\r\n                        const focusedSource = sources.find(s => s.id === focusedSourceId);\r\n                        if (!focusedSource) return null;\r\n\r\n                        return (\r\n                            <PolicyFocusView\r\n                                source={focusedSource}\r\n                                onUpdateSource={async (updates) => {\r\n                                    await updateSource(focusedSource.id, updates);\r\n                                }}\r\n                                onClose={() => setFocusedSourceId(null)}\r\n                            />\r\n                        );\r\n                    })()}\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"resistance\" className=\"mt-0\">\r\n                    {selectedArtifact ? (\r\n                        <ResistanceArtifactView\r\n                            artifact={selectedArtifact}\r\n                            onBack={() => setSelectedArtifact(null)}\r\n                            onUpdate={setSelectedArtifact}\r\n                        />\r\n                    ) : (\r\n                        <ArtifactRepository\r\n                            onSelectArtifact={setSelectedArtifact}\r\n                        />\r\n                    )}\r\n                </TabsContent>\r\n\r\n                <TabsContent value=\"compare\">\r\n                    <PolicyComparisonView sources={selectedSources} />\r\n                </TabsContent>\r\n            </Tabs>\r\n\r\n            {/* Dialogs */}\r\n            <AddDocumentDialog\r\n                open={isAddDialogOpen}\r\n                onOpenChange={setIsAddDialogOpen}\r\n                onAdd={handleAddSource}\r\n            />\r\n\r\n            <AddUrlDialog\r\n                open={isUrlDialogOpen}\r\n                onOpenChange={setIsUrlDialogOpen}\r\n                onAdd={handleUrlAdd}\r\n            />\r\n\r\n            <ViewSourceDialog\r\n                source={viewingSource}\r\n                onOpenChange={(open) => !open && setViewingSource(null)}\r\n            />\r\n\r\n            {/* Edit Source Dialog (if you have one, or remove if unused) */}\r\n            {/* <EditSourceDialog ... /> */}\r\n\r\n            <PositionalityDialog\r\n                isOpen={isPositionalityDialogOpen}\r\n                onClose={() => setIsPositionalityDialogOpen(false)}\r\n                onConfirm={proceedWithAnalysis}\r\n            />\r\n\r\n            <ExportReportDialog\r\n                open={isExportReportDialogOpen}\r\n                onOpenChange={setIsExportReportDialogOpen}\r\n                onGenerate={handleGenerateReport}\r\n                isGenerating={isExporting}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\data\\page_temp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\demo\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\ecosystem\\page.tsx","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":134,"column":13,"severity":1,"nodeType":null,"fix":{"range":[6412,6474],"text":" "}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":136,"column":13,"severity":1,"nodeType":null,"fix":{"range":[6533,6595],"text":" "}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":139,"column":13,"severity":1,"nodeType":null,"fix":{"range":[6751,6813],"text":" "}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":146,"column":13,"severity":1,"nodeType":null,"fix":{"range":[7119,7181],"text":" "}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'influenceScore' is assigned a value but never used.","line":159,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":159,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'resistanceScore' is assigned a value but never used.","line":167,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":167,"endColumn":40}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":150,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7492,7495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7492,7495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":202,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10372,10375],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10372,10375],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":4,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { EcosystemActor, EcosystemConfiguration, AssemblageAnalysis } from \"@/types/ecosystem\";\r\n\r\n// Components\r\nimport { ActorList } from \"@/components/ecosystem/ActorList\";\r\nimport { EcosystemMap } from \"@/components/ecosystem/EcosystemMap\";\r\nimport { ConfigurationDialog } from \"@/components/ecosystem/ConfigurationDialog\";\r\nimport { AssemblagePanel } from \"@/components/ecosystem/AssemblagePanel\";\r\nimport { EcosystemTable } from \"@/components/ecosystem/EcosystemTable\";\r\nimport { AssemblageCompass } from \"@/components/ecosystem/AssemblageCompass\";\r\nimport { Network, List, Compass, PanelLeftClose, PanelLeftOpen, PanelRightClose, PanelRightOpen, FileText, Loader2, Hand, MousePointer2 } from \"lucide-react\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { AnalysisMode } from \"@/components/ui/mode-selector\";\r\n\r\n\r\nexport default function EcosystemPage() {\r\n    // Sources for policy selection\r\n    const { sources, isLoading: isSourcesLoading } = useSources();\r\n    const [selectedPolicyId, setSelectedPolicyId] = useServerStorage<string | null>(\"ecosystem_active_policy_id\", null);\r\n    const policyDocuments = sources.filter(s => s.type !== \"Trace\");\r\n\r\n    // Dynamic Storage Keys\r\n    const actorsKey = selectedPolicyId ? `ecosystem_actors_${selectedPolicyId}` : \"ecosystem_actors_temp\";\r\n    const configsKey = selectedPolicyId ? `ecosystem_configurations_${selectedPolicyId}` : \"ecosystem_configurations_temp\";\r\n    const selectedActorKey = selectedPolicyId ? `ecosystem_selected_actor_id_${selectedPolicyId}` : \"ecosystem_selected_actor_id_temp\";\r\n\r\n    const absenceKey = selectedPolicyId ? `ecosystem_absence_analysis_${selectedPolicyId}` : \"ecosystem_absence_analysis_temp\";\r\n\r\n    // Storage Hooks\r\n    // Note: When selectedPolicyId is null, we use a 'temp' key or just don't render the main content to avoid loading junk.\r\n    // However, hooks must be called unconditionally.\r\n    const [actors, setActors] = useServerStorage<EcosystemActor[]>(actorsKey, []);\r\n    const [configurations, setConfigurations] = useServerStorage<EcosystemConfiguration[]>(configsKey, []);\r\n    const [selectedActorId, setSelectedActorId] = useServerStorage<string | null>(selectedActorKey, null);\r\n\r\n    const [absenceAnalysis, setAbsenceAnalysis] = useServerStorage<AssemblageAnalysis | null>(absenceKey, null);\r\n\r\n    // Config Layout State (for dragging)\r\n    const [configLayout, setConfigLayout] = useState<Record<string, { x: number, y: number }>>({});\r\n\r\n    // Layout State (Zen Mode + Expansion)\r\n    const [showLeftPanel, setShowLeftPanel] = useState(false);\r\n    const [showRightPanel, setShowRightPanel] = useState(false);\r\n    const [isLeftExpanded, setIsLeftExpanded] = useState(false);\r\n    const [isRightExpanded, setIsRightExpanded] = useState(false);\r\n\r\n    const [interactionMode, setInteractionMode] = useState<\"drag\" | \"select\">(\"drag\");\r\n    const [selectedForGrouping, setSelectedForGrouping] = useState<string[]>([]);\r\n    const [isConfigDialogOpen, setIsConfigDialogOpen] = useState(false);\r\n    const [newConfigName, setNewConfigName] = useState(\"\");\r\n    const [newConfigDesc, setNewConfigDesc] = useState(\"\");\r\n    const [selectedConfigId, setSelectedConfigId] = useState<string | null>(null); // Unification State\r\n\r\n    // Extraction State\r\n    const [isExtractionDialogOpen, setIsExtractionDialogOpen] = useState(false);\r\n    const [extractionText, setExtractionText] = useState(\"\");\r\n    const [isExtracting, setIsExtracting] = useState(false);\r\n\r\n    // Theoretical Analysis Mode\r\n    const [analysisMode, setAnalysisMode] = useState<AnalysisMode>(\"hybrid_reflexive\");\r\n\r\n    // View & Filter State\r\n    const [colorMode, setColorMode] = useState<\"type\" | \"epistemic\">(\"type\");\r\n    const [filterType, setFilterType] = useState<EcosystemActor[\"type\"] | \"All\">(\"All\");\r\n\r\n    const filteredActors = actors.filter(actor =>\r\n        filterType === \"All\" ? true : actor.type === filterType\r\n    );\r\n\r\n\r\n\r\n    // Graph interaction state\r\n    const [positions, setPositions] = useState<Record<string, { x: number, y: number }>>({});\r\n    const [mounted, setMounted] = useState(false);\r\n\r\n    // Graph Effects\r\n    useEffect(() => {\r\n        setMounted(true);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        setPositions(prev => {\r\n            const newPositions = { ...prev };\r\n            let hasChanges = false;\r\n            actors.forEach((actor, i) => {\r\n                if (!newPositions[actor.id]) {\r\n                    // Start in circle layout but allow drag to override\r\n                    const totalActors = actors.length;\r\n                    const angle = (i / totalActors) * 2 * Math.PI;\r\n                    const centerX = 350;\r\n                    const centerY = 200;\r\n                    const radius = 120;\r\n                    newPositions[actor.id] = {\r\n                        x: centerX + radius * Math.cos(angle),\r\n                        y: centerY + radius * Math.sin(angle)\r\n                    };\r\n                    hasChanges = true;\r\n                }\r\n            });\r\n            return hasChanges ? newPositions : prev;\r\n        });\r\n    }, [actors]); // Depend on actors to re-run layout for new actors\r\n\r\n    // Handlers\r\n\r\n\r\n    const handleExtractAssemblage = async () => {\r\n        if (!extractionText.trim()) return;\r\n        setIsExtracting(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    text: extractionText,\r\n                    analysisMode: 'assemblage_extraction_v3',\r\n                    sourceType: 'User Input'\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            // 2. Extract Actors\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            const analysis = data.analysis;\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            const impacts = (analysis && !Array.isArray(analysis)) ? (analysis.impacts || []) : (Array.isArray(analysis) ? analysis : []);\r\n\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            const assemblage = analysis.assemblage || { name: \"New Assemblage\", description: \"Extracted from text\", properties: {} };\r\n\r\n            const memberIds: string[] = [];\r\n            const currentActors = [...actors];\r\n\r\n            // [NEW] Prefer explicit actors from V2 Prompt\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            if (!Array.isArray(analysis) && analysis.actors && Array.isArray(analysis.actors)) {\r\n                console.log(\"Using Explicit Actors from Analysis:\", analysis.actors);\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                analysis.actors.forEach((a: any) => {\r\n                    // Compute Dimensional Scores\r\n                    const m = a.metrics || {};\r\n\r\n                    // Influence = Average of (Territoriality + Coding + Centrality)\r\n                    let influenceScore = 5;\r\n                    if (m.territoriality !== undefined && m.coding !== undefined && m.centrality !== undefined) {\r\n                        influenceScore = Math.round((m.territoriality + m.coding + m.centrality) / 3);\r\n                    } else if (m.influence !== undefined) {\r\n                        influenceScore = m.influence; // Fallback to prompt output if direct score provided\r\n                    }\r\n\r\n                    // Resistance = Max of (Counter-Conduct, Discursive Opposition)\r\n                    let resistanceScore = 5;\r\n                    if (m.counter_conduct !== undefined && m.discursive_opposition !== undefined) {\r\n                        resistanceScore = Math.max(m.counter_conduct, m.discursive_opposition);\r\n                    } else if (m.resistance !== undefined) {\r\n                        resistanceScore = m.resistance; // Fallback\r\n                    }\r\n\r\n                    const id = crypto.randomUUID();\r\n                    currentActors.push({\r\n                        id,\r\n                        name: a.name,\r\n                        type: a.type || 'Civil Society',\r\n                        description: a.description || `Identified as ${a.type}`,\r\n                        influence: \"Medium\", // Legacy field\r\n                        metrics: {\r\n                            influence: \"Moderate\",\r\n                            alignment: \"Moderate\",\r\n                            resistance: \"Moderate\",\r\n                            rationale: m.rationale || \"No rationale provided.\",\r\n                            // Store dimensions for tooltip\r\n                            territoriality: m.territoriality,\r\n                            coding: m.coding,\r\n                            centrality: m.centrality,\r\n                            counter_conduct: m.counter_conduct,\r\n                            discursive_opposition: m.discursive_opposition\r\n                        },\r\n                        quotes: a.evidence_quotes || [],\r\n                        region: a.region || \"Unknown\",\r\n                        role_type: a.role_type\r\n                    });\r\n                    memberIds.push(id);\r\n                    setPositions(prev => ({ ...prev, [id]: { x: Math.random() * 600 + 100, y: Math.random() * 300 + 50 } }));\r\n                });\r\n\r\n            } else {\r\n                // Fallback: Infer from Impacts (Legacy)\r\n                // We deduce actors from the \"actor\" field in impacts\r\n                const uniqueActors = new Set<string>();\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                impacts.forEach((imp: any) => {\r\n                    if (imp.actor) uniqueActors.add(imp.actor);\r\n                });\r\n\r\n                Array.from(uniqueActors).forEach(name => {\r\n                    const id = crypto.randomUUID();\r\n                    currentActors.push({\r\n                        id,\r\n                        name,\r\n                        type: inferActorType(name),\r\n                        description: `Actor identified via impact analysis.`,\r\n                        influence: \"Medium\",\r\n                        metrics: { influence: \"Moderate\", resistance: \"Moderate\", alignment: \"Moderate\" },\r\n                        quotes: [],\r\n                        region: \"Unknown\"\r\n                    });\r\n                    memberIds.push(id);\r\n                    setPositions(prev => ({ ...prev, [id]: { x: Math.random() * 600 + 100, y: Math.random() * 300 + 50 } }));\r\n                });\r\n            }\r\n\r\n            setActors(currentActors);\r\n\r\n            if (memberIds.length > 0) {\r\n                const newConfig: EcosystemConfiguration = {\r\n                    id: crypto.randomUUID(),\r\n                    name: assemblage.name || \"New Assemblage\",\r\n                    description: assemblage.description || \"Extracted from text\",\r\n                    memberIds,\r\n                    properties: {\r\n                        stability: assemblage.properties.stability || \"Medium\",\r\n                        generativity: assemblage.properties.generativity || \"Medium\",\r\n                        territorialization_score: assemblage.properties.territorialization_score,\r\n                        coding_intensity_score: assemblage.properties.coding_intensity_score\r\n                    },\r\n                    // Store the full analysis result (including traces/metrics) for the details panel\r\n                    analysisData: data.analysis,\r\n                    color: `hsl(${Math.random() * 360}, 70%, 80%)`\r\n                };\r\n                setConfigurations(prev => [...prev, newConfig]);\r\n\r\n                // Auto-select the new assemblage and open the panel\r\n                setSelectedConfigId(newConfig.id);\r\n\r\n                setShowRightPanel(true);\r\n            }\r\n            setIsExtractionDialogOpen(false);\r\n            setExtractionText(\"\");\r\n        } catch (error) {\r\n            console.error(\"Extraction failed:\", error);\r\n        } finally {\r\n            setIsExtracting(false);\r\n        }\r\n    };\r\n\r\n    const handleClearAll = () => {\r\n        setActors([]);\r\n        setConfigurations([]);\r\n        setSelectedActorId(null);\r\n\r\n        setPositions({});\r\n        setSelectedForGrouping([]);\r\n    };\r\n\r\n\r\n\r\n    const handleCreateConfiguration = () => {\r\n        console.log(\"Create Configuration Clicked. Selected actors:\", selectedForGrouping.length);\r\n        if (selectedForGrouping.length < 2) {\r\n            alert(\"Select at least 2 actors.\");\r\n            return;\r\n        }\r\n        setIsConfigDialogOpen(true);\r\n    };\r\n\r\n    const confirmCreateConfiguration = () => {\r\n        const newConfig: EcosystemConfiguration = {\r\n            id: crypto.randomUUID(),\r\n            name: newConfigName || \"New Configuration\",\r\n            description: newConfigDesc || \"A unified entity of actors.\",\r\n            memberIds: selectedForGrouping,\r\n            properties: { stability: \"Medium\", generativity: \"Medium\" },\r\n            color: `hsl(${Math.random() * 360}, 70%, 85%)`\r\n        };\r\n\r\n        setConfigurations(prev => [...prev, newConfig]);\r\n        setIsConfigDialogOpen(false);\r\n        setNewConfigName(\"\");\r\n        setNewConfigDesc(\"\");\r\n        setSelectedForGrouping([]);\r\n        setInteractionMode(\"drag\");\r\n    };\r\n\r\n    const toggleSelection = (actorId: string) => {\r\n        setSelectedForGrouping(prev => {\r\n            const isSelected = prev.includes(actorId);\r\n            return isSelected ? prev.filter(id => id !== actorId) : [...prev, actorId];\r\n        });\r\n    };\r\n\r\n    const handleActorDrag = (actorId: string, x: number, y: number) => {\r\n        setPositions(prev => ({ ...prev, [actorId]: { x, y } }));\r\n    };\r\n\r\n    const handleConfigDrag = (configId: string, dx: number, dy: number) => {\r\n        setConfigLayout(prev => {\r\n            const current = prev[configId] || { x: 0, y: 0 };\r\n            return {\r\n                ...prev,\r\n                [configId]: {\r\n                    x: current.x + dx,\r\n                    y: current.y + dy\r\n                }\r\n            };\r\n        });\r\n    };\r\n\r\n    const handleConfigClick = (configId: string) => {\r\n        setSelectedConfigId(configId);\r\n        setShowRightPanel(true);\r\n    };\r\n\r\n    const handleDeleteConfiguration = (configId: string) => {\r\n        setConfigurations(prev => prev.filter(c => c.id !== configId));\r\n        if (selectedConfigId === configId) {\r\n            setSelectedConfigId(null);\r\n            setShowRightPanel(false);\r\n        }\r\n    };\r\n\r\n    const toggleLayer = (layer: string) => {\r\n        setActiveLayers(prev => ({ ...prev, [layer]: !prev[layer] }));\r\n    };\r\n\r\n    const [activeLayers, setActiveLayers] = useState<Record<string, boolean>>({ resistance: false });\r\n\r\n    if (!mounted) return null;\r\n\r\n    if (isSourcesLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-full\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full gap-4\">\r\n\r\n            <div className=\"flex flex-col gap-4 shrink-0\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">Governance Assemblage Map</h2>\r\n                        <p className=\"text-slate-500\">Mapping the actors, associations, and territorial dynamics of the AI governance regime.</p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Policy Selector Section */}\r\n                <Card className=\"bg-white border-slate-200 shadow-sm\">\r\n                    <CardContent className=\"p-4\">\r\n                        <div className=\"flex flex-col md:flex-row gap-4 items-center justify-between\">\r\n                            <div className=\"flex items-center gap-4 w-full md:w-auto\">\r\n                                <div className=\"p-2 bg-blue-50 rounded-lg\">\r\n                                    <FileText className=\"h-5 w-5 text-blue-600\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h3 className=\"font-semibold text-slate-900 text-sm\">Active Policy Document</h3>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"w-full md:w-[300px]\">\r\n                                <Select\r\n                                    value={selectedPolicyId || \"\"}\r\n                                    onValueChange={async (val) => {\r\n                                        // Migration Logic: If we are in \"Temp\" mode (no policy) and have actors,\r\n                                        // carry them over to the new policy context so the user doesn't lose their work.\r\n                                        if (!selectedPolicyId && actors.length > 0) {\r\n                                            const confirmMigrate = window.confirm(\"You have actors in the scratchpad. Do you want to move them to this policy?\");\r\n                                            if (confirmMigrate) {\r\n                                                try {\r\n                                                    const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n                                                    if (process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                                                        headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n                                                    }\r\n\r\n                                                    // Manually save current state to the NEW keys\r\n                                                    await Promise.all([\r\n                                                        fetch('/api/storage', {\r\n                                                            method: 'POST',\r\n                                                            headers,\r\n                                                            body: JSON.stringify({ key: `ecosystem_actors_${val}`, value: actors }),\r\n                                                        }),\r\n                                                        fetch('/api/storage', {\r\n                                                            method: 'POST',\r\n                                                            headers,\r\n                                                            body: JSON.stringify({ key: `ecosystem_configurations_${val}`, value: configurations }),\r\n                                                        })\r\n                                                    ]);\r\n                                                } catch (err) {\r\n                                                    console.error(\"Migration failed:\", err);\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                        setSelectedPolicyId(val);\r\n                                    }}\r\n                                >\r\n                                    <SelectTrigger className=\"h-9 text-sm\">\r\n                                        <SelectValue placeholder=\"Select a policy document...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {policyDocuments.length === 0 ? (\r\n                                            <div className=\"p-2 text-sm text-slate-500 text-center\">No documents found</div>\r\n                                        ) : (\r\n                                            policyDocuments.map(doc => (\r\n                                                <SelectItem key={doc.id} value={doc.id}>\r\n                                                    {doc.title}\r\n                                                </SelectItem>\r\n                                            ))\r\n                                        )}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n\r\n\r\n            {!selectedPolicyId ? (\r\n                <div className=\"flex-1 flex items-center justify-center bg-slate-50 rounded-xl border border-dashed border-slate-200 p-12\">\r\n                    <div className=\"text-center\">\r\n                        <div className=\"mx-auto w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4\">\r\n                            <Network className=\"h-8 w-8 text-slate-300\" />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-bold text-slate-700\">No Policy Selected</h3>\r\n                        <p className=\"text-slate-500 mt-2 max-w-md mx-auto\">\r\n                            Please select a policy document above to visualize the actors, assemblages, and cultural absences specific to that context.\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                <Tabs defaultValue=\"map\" className=\"flex-1 flex flex-col overflow-hidden\">\r\n                    <div className=\"flex justify-between items-center px-1 shrink-0\">\r\n                        <TabsList className=\"bg-slate-100\">\r\n                            <TabsTrigger value=\"map\" className=\"gap-2\">\r\n                                <Network className=\"h-4 w-4\" /> Visual Assemblage\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"table\" className=\"gap-2\">\r\n                                <List className=\"h-4 w-4\" /> Table View\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"compass\" className=\"gap-2\">\r\n                                <Compass className=\"h-4 w-4\" /> Assemblage Compass\r\n                            </TabsTrigger>\r\n                        </TabsList>\r\n\r\n                        {/* Global Actions (like Clear Cache) could go here */}\r\n                    </div>\r\n\r\n                    {/* TAB 1: VISUAL ASSEMBLAGE (FULL MAP) */}\r\n                    <TabsContent value=\"map\" className=\"flex-1 flex overflow-hidden mt-4 gap-6 data-[state=inactive]:hidden\">\r\n\r\n                        {/* Map View - Retaining Sidebar Logic for Selection/Simulation, but defaults can be managed */}\r\n                        <div className=\"flex flex-col lg:flex-row h-full gap-6 flex-1 overflow-hidden\">\r\n                            {/* Left Panel (Actor List) */}\r\n                            {showLeftPanel && (\r\n                                <div className={`flex flex-col gap-4 shrink-0 transition-all duration-300 overflow-y-auto ${isLeftExpanded ? 'w-full lg:w-[600px] xl:w-[700px] z-20 shadow-xl' : 'w-full lg:w-80'}`}>\r\n                                    <ActorList\r\n                                        actors={actors}\r\n                                        selectedActorId={selectedActorId}\r\n                                        onSelectActor={setSelectedActorId}\r\n                                        onClearAll={handleClearAll}\r\n                                        isExpanded={isLeftExpanded}\r\n                                        onToggleExpand={() => setIsLeftExpanded(!isLeftExpanded)}\r\n\r\n                                        isExtracting={isExtracting}\r\n                                        extractionText={extractionText}\r\n                                        setExtractionText={setExtractionText}\r\n                                        onExtract={handleExtractAssemblage}\r\n                                        isExtractionDialogOpen={isExtractionDialogOpen}\r\n                                        setIsExtractionDialogOpen={setIsExtractionDialogOpen}\r\n                                        onClose={() => setShowLeftPanel(false)}\r\n                                    />\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Center (The Map) */}\r\n                            <div className=\"flex-1 flex flex-col gap-4 overflow-hidden relative transition-all duration-300\">\r\n                                {/* Map Header / Toolbar */}\r\n                                <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 shrink-0 z-10 pointer-events-none\">\r\n                                    <div className=\"flex items-center gap-3 pointer-events-auto\">\r\n                                        {!showLeftPanel && (\r\n                                            <button onClick={() => setShowLeftPanel(true)} className=\"p-1 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 transition-colors shadow-sm border border-slate-200\" title=\"Show Actor List\">\r\n                                                <PanelLeftOpen size={20} />\r\n                                            </button>\r\n                                        )}\r\n                                        {showLeftPanel && (\r\n                                            <button onClick={() => setShowLeftPanel(false)} className=\"p-1 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 transition-colors shadow-sm border border-slate-200\" title=\"Hide Actor List\">\r\n                                                <PanelLeftClose size={20} />\r\n                                            </button>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    <div className=\"flex flex-col gap-2 items-end pointer-events-auto\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            {/* NEW: Theoretical Mode Selector */}\r\n                                            {/* NEW: Theoretical Mode Selector - Moved to Map Toolbar */}\r\n\r\n                                            {/* Interaction Mode Toggle */}\r\n                                            <div className=\"flex bg-slate-100 p-0.5 rounded mr-2 border shadow-sm\">\r\n                                                <button\r\n                                                    onClick={() => setInteractionMode(\"drag\")}\r\n                                                    className={`p-1.5 rounded-sm transition-all ${interactionMode === \"drag\" ? \"bg-white shadow text-indigo-700\" : \"text-slate-500 hover:text-slate-700\"}`}\r\n                                                    title=\"Drag Mode (Pan/Move)\"\r\n                                                >\r\n                                                    <Hand className=\"h-4 w-4\" />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => setInteractionMode(\"select\")}\r\n                                                    className={`p-1.5 rounded-sm transition-all ${interactionMode === \"select\" ? \"bg-white shadow text-indigo-700\" : \"text-slate-500 hover:text-slate-700\"}`}\r\n                                                    title=\"Select Mode (Group Actors)\"\r\n                                                >\r\n                                                    <MousePointer2 className=\"h-4 w-4\" />\r\n                                                </button>\r\n                                            </div>\r\n\r\n                                            {/* Color Mode Toggle */}\r\n                                            <div className=\"flex bg-slate-100 p-0.5 rounded mr-2 border shadow-sm\">\r\n                                                <button onClick={() => setColorMode(\"type\")} className={`px-3 py-1.5 text-xs font-medium rounded-sm transition-all ${colorMode === \"type\" ? \"bg-white shadow text-indigo-700\" : \"text-slate-500 hover:text-slate-700\"}`}>Type</button>\r\n                                                <button onClick={() => setColorMode(\"epistemic\")} className={`px-3 py-1.5 text-xs font-medium rounded-sm transition-all flex items-center gap-1 ${colorMode === \"epistemic\" ? \"bg-white shadow text-emerald-700\" : \"text-slate-500 hover:text-slate-700\"}`}>Epistemic</button>\r\n                                            </div>\r\n\r\n                                            {/* Filter Checkbox/Select */}\r\n                                            <div className=\"bg-slate-100 p-0.5 rounded border shadow-sm\">\r\n                                                <select\r\n                                                    className=\"text-xs border-none bg-transparent font-medium text-slate-600 focus:ring-0 cursor-pointer h-7\"\r\n                                                    value={filterType}\r\n                                                    onChange={(e) => setFilterType(e.target.value as EcosystemActor[\"type\"] | \"All\")}\r\n                                                >\r\n                                                    <option value=\"All\">All Types</option>\r\n                                                    <option value=\"Policymaker\">Policymakers</option>\r\n                                                    <option value=\"Startup\">Startups</option>\r\n                                                    <option value=\"Civil Society\">Civil Society</option>\r\n                                                    <option value=\"Academic\">Academics</option>\r\n                                                    <option value=\"Infrastructure\">Infrastructure</option>\r\n                                                    <option value=\"Algorithm\">Algorithms</option>\r\n                                                    <option value=\"Dataset\">Datasets</option>\r\n                                                </select>\r\n                                            </div>\r\n\r\n                                            {/* Right Panel Toggle */}\r\n                                            {!showRightPanel && (\r\n                                                <button onClick={() => setShowRightPanel(true)} className=\"p-1.5 rounded bg-white hover:bg-slate-50 text-slate-600 transition-colors border shadow-sm\" title=\"Show Details\">\r\n                                                    <PanelRightOpen size={18} />\r\n                                                </button>\r\n                                            )}\r\n                                            {showRightPanel && (\r\n                                                <button onClick={() => setShowRightPanel(false)} className=\"p-1.5 rounded bg-white hover:bg-slate-50 text-slate-600 transition-colors border shadow-sm\" title=\"Hide Details\">\r\n                                                    <PanelRightClose size={18} />\r\n                                                </button>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Actual Map Component */}\r\n                                <div className=\"flex-1 min-h-0 border rounded-xl overflow-hidden shadow-sm relative\">\r\n                                    <EcosystemMap\r\n                                        actors={filteredActors}\r\n                                        configurations={configurations}\r\n                                        positions={positions}\r\n                                        interactionMode={interactionMode}\r\n                                        setInteractionMode={setInteractionMode}\r\n                                        selectedForGrouping={selectedForGrouping}\r\n                                        onToggleSelection={toggleSelection}\r\n                                        onCreateConfiguration={handleCreateConfiguration}\r\n                                        onActorDrag={handleActorDrag}\r\n                                        onConfigDrag={handleConfigDrag}\r\n                                        onDeleteConfiguration={handleDeleteConfiguration}\r\n                                        selectedConfigId={selectedConfigId}\r\n                                        activeLayers={activeLayers}\r\n                                        toggleLayer={toggleLayer}\r\n                                        colorMode={colorMode}\r\n                                        onConfigClick={handleConfigClick}\r\n                                        absenceAnalysis={absenceAnalysis}\r\n                                        analysisMode={analysisMode}\r\n                                        setAnalysisMode={setAnalysisMode}\r\n                                        configLayout={configLayout}\r\n                                    />\r\n                                    {/* Removed CulturalHolesAnalysis from here */}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Right Panel (Details/Inspector) */}\r\n                            {showRightPanel && (\r\n                                <div className={`shrink-0 flex flex-col gap-4 transition-all duration-300 overflow-y-auto ${isRightExpanded ? 'w-full lg:w-[800px] xl:w-[1000px] z-20 shadow-xl' : 'w-full lg:w-72'}`}>\r\n                                    <AssemblagePanel\r\n                                        actors={actors}\r\n                                        analyzedText={extractionText}\r\n                                        savedAnalysis={absenceAnalysis}\r\n                                        onSaveAnalysis={(analysis) => {\r\n                                            if (selectedConfigId) {\r\n                                                setConfigurations(prev => prev.map(c => c.id === selectedConfigId ? { ...c, analysisData: analysis } : c));\r\n                                            } else {\r\n                                                setAbsenceAnalysis(analysis);\r\n                                            }\r\n                                        }}\r\n                                        onToggleExpand={() => setIsRightExpanded(!isRightExpanded)}\r\n                                        isExpanded={isRightExpanded} // Pass state specifically if component supports it (AssemblagePanel might not use it yet visually but good to pass if interface allows, otherwise ignore)\r\n                                        selectedConfig={configurations.find(c => c.id === selectedConfigId)}\r\n                                        onClose={() => { setShowRightPanel(false); setSelectedConfigId(null); }}\r\n                                        onUpdateConfig={(updatedConfig) => {\r\n                                            setConfigurations(prev => prev.map(c => c.id === updatedConfig.id ? updatedConfig : c));\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </TabsContent>\r\n\r\n                    {/* TAB 2: TABLE VIEW */}\r\n                    <TabsContent value=\"table\" className=\"flex-1 overflow-hidden mt-4 p-4 data-[state=inactive]:hidden\">\r\n                        <Card className=\"h-full border-slate-200\">\r\n                            <CardContent className=\"p-0 h-full overflow-hidden\">\r\n                                <EcosystemTable\r\n                                    actors={filteredActors}\r\n                                    onSelectActor={setSelectedActorId}\r\n                                    selectedActorId={selectedActorId}\r\n                                />\r\n                            </CardContent>\r\n                        </Card>\r\n                    </TabsContent>\r\n\r\n                    {/* TAB 3: ASSEMBLAGE COMPASS */}\r\n                    <TabsContent value=\"compass\" className=\"flex-1 overflow-auto mt-4 p-4 data-[state=inactive]:hidden\">\r\n                        <div className=\"bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full flex flex-col\">\r\n                            <h3 className=\"text-lg font-semibold mb-4 text-slate-800 flex items-center shrink-0\">\r\n                                <Compass className=\"w-5 h-5 mr-2 text-indigo-600\" /> Epistemic Compass\r\n                            </h3>\r\n                            <div className=\"flex-1 min-h-0\">\r\n                                <AssemblageCompass\r\n                                    actors={filteredActors}\r\n                                    onSelectActor={setSelectedActorId}\r\n                                    selectedActorId={selectedActorId}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </TabsContent>\r\n\r\n\r\n\r\n                    <ConfigurationDialog\r\n                        isOpen={isConfigDialogOpen}\r\n                        onClose={() => setIsConfigDialogOpen(false)}\r\n                        name={newConfigName}\r\n                        setName={setNewConfigName}\r\n                        description={newConfigDesc}\r\n                        setDescription={setNewConfigDesc}\r\n                        onConfirm={confirmCreateConfiguration}\r\n                    />\r\n                </Tabs>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n// Helper to infer actor type from name (simple heuristic for legacy fallback)\r\nfunction inferActorType(name: string): EcosystemActor['type'] {\r\n    const n = name.toLowerCase();\r\n    if (n.includes(\"ministry\") || n.includes(\"agency\") || n.includes(\"commission\") || n.includes(\"eu \")) return \"Policymaker\";\r\n    if (n.includes(\"university\") || n.includes(\"institute\") || n.includes(\"lab\")) return \"Academic\";\r\n    if (n.includes(\"corp\") || n.includes(\"inc\") || n.includes(\"ltd\") || n.includes(\"startup\")) return \"Startup\";\r\n    if (n.includes(\"foundation\") || n.includes(\"ngo\") || n.includes(\"association\") || n.includes(\"union\")) return \"Civil Society\";\r\n    if (n.includes(\"platform\") || n.includes(\"cloud\") || n.includes(\"server\") || n.includes(\"data\")) return \"Infrastructure\";\r\n    return \"Civil Society\"; // Default\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\empirical\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\glossary\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\governance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\literature\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\login\\[[...login]]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\ontology\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":227,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10557,10560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10557,10560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Network, ArrowRightLeft, Sparkles, Loader2 } from \"lucide-react\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { OntologyData, OntologyNode, ComparisonResult } from \"@/types/ontology\";\r\nimport { getColorForCategory } from \"@/lib/ontology-utils\";\r\n\r\n// Components\r\nimport { OntologyMap } from \"@/components/ontology/OntologyMap\";\r\nimport { ConceptList } from \"@/components/ontology/ConceptList\";\r\nimport { MapGallery } from \"@/components/ontology/MapGallery\";\r\nimport { ConceptDetailsModal } from \"@/components/ontology/ConceptDetailsModal\";\r\nimport { ComparisonView } from \"@/components/ontology/ComparisonView\";\r\n\r\n// Static Data (Fallback) - Kept for initial state visualization\r\n\r\n\r\nconst STATIC_CONCEPTS = [\r\n    {\r\n        id: \"0\",\r\n        label: \"Coloniality of Power\",\r\n        description: \"The living legacy of colonialism in contemporary power structures, defining who has the authority to classify and organize the world.\",\r\n        quote: \"The coloniality of power is not just a historical event, but a continuous process of ordering the world.\",\r\n        category: \"Core\",\r\n        color: \"#fca5a5\",\r\n        x: 250, y: 50\r\n    },\r\n    {\r\n        id: \"1\",\r\n        label: \"Algorithmic Rationality\",\r\n        description: \"The logic by which algorithms order, sort, and prioritize information, often embedding specific cultural and epistemological values.\",\r\n        quote: \"Algorithms are not neutral tools; they are crystallized forms of rationality.\",\r\n        category: \"Mechanism\",\r\n        color: \"#d8b4fe\",\r\n        x: 450, y: 150\r\n    },\r\n    {\r\n        id: \"2\",\r\n        label: \"Global South State\",\r\n        description: \"The political entity situated in the periphery of the world-system, navigating the imposition of external AI norms while asserting sovereignty.\",\r\n        quote: \"The state in the Global South is not merely a regulator but a site of contestation.\",\r\n        category: \"Actor\",\r\n        color: \"#93c5fd\",\r\n        x: 50, y: 150\r\n    },\r\n    {\r\n        id: \"3\",\r\n        label: \"Data Extractivism\",\r\n        description: \"The process of extracting data from human life and turning it into a resource for capital accumulation.\",\r\n        quote: \"Data is the new oil, but the extraction process leaves behind social pollution.\",\r\n        category: \"Mechanism\",\r\n        color: \"#d8b4fe\",\r\n        x: 400, y: 300\r\n    },\r\n    {\r\n        id: \"4\",\r\n        label: \"Fundamental Rights\",\r\n        description: \"The set of ethical and legal principles protected by frameworks like the EU AI Act, often framed as universal but historically situated.\",\r\n        quote: \"Rights are the language through which power is negotiated and contested.\",\r\n        category: \"Value\",\r\n        color: \"#86efac\",\r\n        x: 100, y: 300\r\n    },\r\n    {\r\n        id: \"5\",\r\n        label: \"Sociotechnical Assemblage\",\r\n        description: \"Complex arrangements of humans, machines, norms, and resources that constitute AI systems as loosely coupled, emergently structured entities.\",\r\n        quote: \"AI is not a thing, but an assemblage of social and technical relations that orchestrate value.\",\r\n        category: \"Core\",\r\n        color: \"#fca5a5\",\r\n        x: 250, y: 200\r\n    },\r\n] as OntologyNode[];\r\n\r\nconst STATIC_NETWORK_LINKS = [\r\n    { source: \"0\", target: \"1\", relation: \"informs\" },\r\n    { source: \"0\", target: \"2\", relation: \"constrains\" },\r\n    { source: \"0\", target: \"5\", relation: \"shapes\" },\r\n    { source: \"1\", target: \"3\", relation: \"enables\" },\r\n    { source: \"1\", target: \"5\", relation: \"structures\" },\r\n    { source: \"2\", target: \"4\", relation: \"protects\" },\r\n    { source: \"2\", target: \"5\", relation: \"regulates\" },\r\n    { source: \"3\", target: \"5\", relation: \"feeds\" },\r\n    { source: \"4\", target: \"5\", relation: \"embedded in\" },\r\n];\r\n\r\nexport default function OntologyPage() {\r\n    const { sources } = useSources();\r\n    const [selectedSourceId, setSelectedSourceId] = useServerStorage<string>(\"ontology_selected_source_id\", \"\");\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [ontologyMaps, setOntologyMaps] = useServerStorage<Record<string, OntologyData>>(\"ontology_maps\", {});\r\n\r\n    // Comparison State\r\n    const [isComparing, setIsComparing] = useServerStorage<boolean>(\"ontology_is_comparing\", false);\r\n    const [selectedForComparison, setSelectedForComparison] = useServerStorage<string[]>(\"ontology_selected_comparison_ids\", []);\r\n    const [comparisonResult, setComparisonResult, isComparisonResultLoading] = useServerStorage<ComparisonResult | null>(\"ontology_comparison_result\", null);\r\n    const [isComparingLoading, setIsComparingLoading] = useState(false);\r\n\r\n    // Interactivity State\r\n    const [selectedNodeId, setSelectedNodeId] = useServerStorage<string | null>(\"ontology_selected_node_id\", null);\r\n    const [selectedCategory, setSelectedCategory] = useState<string | null>(null);\r\n\r\n    // Filter sources that have text available for analysis\r\n    const analyzedSources = sources.filter(s => s.extractedText);\r\n\r\n    // Get the currently active map based on selectedSourceId\r\n    const currentOntologyData = (selectedSourceId && ontologyMaps && ontologyMaps[selectedSourceId])\r\n        ? ontologyMaps[selectedSourceId]\r\n        : null;\r\n\r\n    const handleGenerateOntology = async () => {\r\n        const source = analyzedSources.find(s => s.id === selectedSourceId);\r\n        if (!source || !source.extractedText) return;\r\n\r\n        setIsAnalyzing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    text: source.extractedText.substring(0, 3000), // Limit text length\r\n                    analysisMode: 'ontology',\r\n                    force: true // Force refresh to bypass cache\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success && data.analysis) {\r\n                // Process nodes to add coordinates and colors\r\n                const processedNodes = data.analysis.nodes.map((node: OntologyNode, index: number) => ({\r\n                    ...node,\r\n                    label: node.label || node.id,\r\n                    x: 300 + 200 * Math.cos(2 * Math.PI * index / data.analysis.nodes.length),\r\n                    y: 200 + 150 * Math.sin(2 * Math.PI * index / data.analysis.nodes.length),\r\n                    color: getColorForCategory(node.category)\r\n                }));\r\n\r\n                const newMap: OntologyData = {\r\n                    summary: data.analysis.summary,\r\n                    nodes: processedNodes,\r\n                    links: data.analysis.links\r\n                };\r\n\r\n                // Update the maps record\r\n                setOntologyMaps({\r\n                    ...ontologyMaps,\r\n                    [selectedSourceId]: newMap\r\n                });\r\n            } else {\r\n                alert(\"Analysis failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Ontology generation error:\", error);\r\n            alert(\"Failed to generate ontology.\");\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    const handleCompareOntologies = async () => {\r\n        if (selectedForComparison.length < 2 || selectedForComparison.length > 3) return;\r\n        if (isComparisonResultLoading) return; // Prevent run if still loading\r\n\r\n        const sourceAId = selectedForComparison[0];\r\n        const sourceBId = selectedForComparison[1];\r\n        const sourceCId = selectedForComparison[2]; // Optional\r\n\r\n        // Check for existing result\r\n        if (comparisonResult) {\r\n            // Check if the existing result matches the currently selected sources\r\n            const currentIds = [...selectedForComparison].sort();\r\n            const existingIds = [\r\n                comparisonResult.sourceAId,\r\n                comparisonResult.sourceBId,\r\n                comparisonResult.sourceCId\r\n            ].filter(Boolean) as string[];\r\n            existingIds.sort();\r\n\r\n            // Simple array equality check\r\n            const isSameComparison = currentIds.length === existingIds.length &&\r\n                currentIds.every((val, index) => val === existingIds[index]);\r\n\r\n            if (isSameComparison) {\r\n                // IDs match! Show the existing result without re-running or asking\r\n                setIsComparing(true); // Ensure comparison view is active\r\n                return;\r\n            }\r\n\r\n            // IDs differ, ask to overwrite\r\n            const confirmRun = confirm(\"Existing comparison found for DIFFERENT maps. Do you want to run a new comparison? This will overwrite the current results.\");\r\n            if (!confirmRun) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        const sourceA = sources.find(s => s.id === sourceAId);\r\n        const sourceB = sources.find(s => s.id === sourceBId);\r\n        const sourceC = sourceCId ? sources.find(s => s.id === sourceCId) : undefined;\r\n\r\n        const mapA = ontologyMaps?.[sourceAId];\r\n        const mapB = ontologyMaps?.[sourceBId];\r\n        const mapC = sourceCId ? ontologyMaps?.[sourceCId] : undefined;\r\n\r\n        if (!sourceA || !sourceB || !mapA || !mapB) return;\r\n        if (sourceCId && (!sourceC || !mapC)) return; // If 3rd selected but missing data, abort\r\n\r\n        setIsComparingLoading(true);\r\n        // setComparisonResult(null); // Keep previous result for better UX during load\r\n\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const payload: any = {\r\n                analysisMode: 'ontology_comparison',\r\n                sourceA: { title: sourceA.title, data: mapA },\r\n                sourceB: { title: sourceB.title, data: mapB },\r\n                force: true\r\n            };\r\n\r\n            if (sourceC && mapC) {\r\n                payload.sourceC = { title: sourceC.title, data: mapC };\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify(payload)\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success && data.analysis) {\r\n                // Attach the source IDs to the result so we can identify it later\r\n                const analysisWithIds: ComparisonResult = {\r\n                    ...data.analysis,\r\n                    sourceAId: sourceAId,\r\n                    sourceBId: sourceBId,\r\n                    sourceCId: sourceCId\r\n                };\r\n                setComparisonResult(analysisWithIds);\r\n            } else {\r\n                alert(\"Comparison failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Comparison error:\", error);\r\n            alert(\"Failed to compare ontologies.\");\r\n        } finally {\r\n            setIsComparingLoading(false);\r\n        }\r\n    };\r\n\r\n    const toggleComparisonSelection = (sourceId: string) => {\r\n        if (selectedForComparison.includes(sourceId)) {\r\n            setSelectedForComparison(prev => prev.filter(id => id !== sourceId));\r\n        } else {\r\n            if (selectedForComparison.length < 3) { // Updated limit to 3\r\n                setSelectedForComparison(prev => [...prev, sourceId]);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleNodeDrag = (nodeId: string, x: number, y: number) => {\r\n        if (selectedSourceId && currentOntologyData) {\r\n            const updatedNodes = currentOntologyData.nodes.map(node =>\r\n                node.id === nodeId ? { ...node, x, y } : node\r\n            );\r\n\r\n            setOntologyMaps({\r\n                ...ontologyMaps,\r\n                [selectedSourceId]: {\r\n                    ...currentOntologyData,\r\n                    nodes: updatedNodes\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    // Filtering Logic\r\n    const displayNodes = currentOntologyData\r\n        ? currentOntologyData.nodes.filter(n => !selectedCategory || n.category === selectedCategory)\r\n        : STATIC_CONCEPTS;\r\n\r\n    const displayLinks = currentOntologyData\r\n        ? currentOntologyData.links.filter(l => {\r\n            const sourceNode = currentOntologyData.nodes.find(n => n.id === l.source);\r\n            const targetNode = currentOntologyData.nodes.find(n => n.id === l.target);\r\n            if (selectedCategory) {\r\n                return sourceNode?.category === selectedCategory && targetNode?.category === selectedCategory;\r\n            }\r\n            return true;\r\n        })\r\n        : STATIC_NETWORK_LINKS;\r\n\r\n    const selectedNode = currentOntologyData\r\n        ? currentOntologyData.nodes.find(n => n.id === selectedNodeId)\r\n        : STATIC_CONCEPTS.find(n => n.id === selectedNodeId);\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold text-slate-900 flex items-center gap-2\">\r\n                        <Network className=\"h-8 w-8 text-indigo-600\" />\r\n                        Concept Network\r\n                    </h2>\r\n                    <div className=\"text-slate-500 mt-2 flex flex-wrap items-center gap-2 text-sm\">\r\n                        Visualizing the assemblage:\r\n                        <Badge variant=\"secondary\" className=\"bg-red-100 text-red-700 hover:bg-red-200 border-red-200 cursor-default\">Core</Badge>\r\n                        <Badge variant=\"secondary\" className=\"bg-purple-100 text-purple-700 hover:bg-purple-200 border-purple-200 cursor-default\">Mechanism</Badge>\r\n                        <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-700 hover:bg-blue-200 border-blue-200 cursor-default\">Actor</Badge>\r\n                        <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700 hover:bg-green-200 border-green-200 cursor-default\">Value</Badge>\r\n                    </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                    <Button\r\n                        variant={isComparing ? \"secondary\" : \"outline\"}\r\n                        onClick={() => {\r\n                            setIsComparing(!isComparing);\r\n                            setComparisonResult(null);\r\n                            setSelectedForComparison([]);\r\n                        }}\r\n                        className=\"gap-2\"\r\n                    >\r\n                        <ArrowRightLeft className=\"h-4 w-4\" />\r\n                        {isComparing ? \"Exit Comparison\" : \"Compare Maps\"}\r\n                    </Button>\r\n\r\n                    {!isComparing && (\r\n                        <>\r\n                            <Select value={selectedSourceId} onValueChange={setSelectedSourceId}>\r\n                                <SelectTrigger className=\"w-[280px]\">\r\n                                    <SelectValue placeholder=\"Select a source to analyze\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {analyzedSources.map((source) => (\r\n                                        <SelectItem key={source.id} value={source.id}>\r\n                                            {source.title}\r\n                                        </SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                            <Button\r\n                                onClick={handleGenerateOntology}\r\n                                disabled={!selectedSourceId || isAnalyzing}\r\n                                className=\"bg-indigo-600 hover:bg-indigo-700 text-white\"\r\n                            >\r\n                                {isAnalyzing ? (\r\n                                    <>\r\n                                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                        Analyzing...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                        Generate Map\r\n                                    </>\r\n                                )}\r\n                            </Button>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Comparison Result View */}\r\n            {isComparing && comparisonResult && (\r\n                <ComparisonView result={comparisonResult} sources={sources} />\r\n            )}\r\n\r\n            {/* Main Visualization */}\r\n            {!isComparing && (\r\n                <>\r\n                    {currentOntologyData?.summary && (\r\n                        <Card className=\"bg-slate-50 border-indigo-100\">\r\n                            <CardContent className=\"pt-6\">\r\n                                <p className=\"text-slate-700 leading-relaxed\">\r\n                                    <span className=\"font-semibold text-indigo-700\">Analysis Summary: </span>\r\n                                    {currentOntologyData.summary}\r\n                                </p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n\r\n                    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                        <div className=\"lg:col-span-2 space-y-4\">\r\n                            <OntologyMap\r\n                                nodes={displayNodes}\r\n                                links={displayLinks}\r\n                                selectedCategory={selectedCategory}\r\n                                onSelectCategory={setSelectedCategory}\r\n                                selectedNodeId={selectedNodeId}\r\n                                onSelectNode={setSelectedNodeId}\r\n                                onNodeDrag={handleNodeDrag}\r\n                            />\r\n                        </div>\r\n\r\n                        <ConceptList\r\n                            nodes={displayNodes}\r\n                            selectedNodeId={selectedNodeId}\r\n                            onSelectNode={setSelectedNodeId}\r\n                        />\r\n                    </div>\r\n                </>\r\n            )}\r\n\r\n            <MapGallery\r\n                ontologyMaps={ontologyMaps}\r\n                sources={sources}\r\n                selectedSourceId={selectedSourceId}\r\n                onSelectSource={setSelectedSourceId}\r\n                isComparing={isComparing}\r\n                selectedForComparison={selectedForComparison}\r\n                onToggleComparisonSelection={toggleComparisonSelection}\r\n                onCompare={handleCompareOntologies}\r\n                isComparingLoading={isComparingLoading}\r\n                isComparisonResultLoading={isComparisonResultLoading}\r\n            />\r\n\r\n            <ConceptDetailsModal\r\n                selectedNode={selectedNode || null}\r\n                isOpen={!!selectedNodeId}\r\n                onClose={() => setSelectedNodeId(null)}\r\n                isStatic={!currentOntologyData}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used.","line":6,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BookOpen' is defined but never used.","line":11,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Scan' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Network' is defined but never used.","line":15,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Lightbulb' is defined but never used.","line":16,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":17,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useUser } from \"@clerk/nextjs\";\nimport { Source } from \"@/types\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useSources } from \"@/hooks/useSources\";\nimport {\n  Database,\n  BookOpen,\n  Scale,\n  Users,\n  Scan,\n  Network,\n  Lightbulb,\n  ArrowRight,\n  FileText,\n  Search,\n  Zap,\n  Activity,\n  Upload,\n  Cpu,\n  GitGraph,\n  Shield,\n  Lock,\n  GraduationCap,\n  Building,\n  Play\n} from \"lucide-react\";\nimport Image from \"next/image\";\nimport { GalaxyGraph } from \"@/components/landing/GalaxyGraph\";\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\nimport { EcosystemActor } from \"@/types/ecosystem\";\n\n\n// --- DASHBOARD DATA ---\n\n\n// --- COMPONENTS ---\n\nfunction LandingPage() {\n  return (\n    <div className=\"flex flex-col min-h-screen bg-white\">\n      {/* Hero Section */}\n      <div className=\"relative isolate px-6 pt-14 lg:px-8 bg-slate-900 text-white overflow-hidden\">\n        {/* Background Image */}\n        <div\n          className=\"absolute inset-0 -z-20\"\n          style={{\n            backgroundImage: \"url('/landing-bg.png')\",\n            backgroundSize: \"cover\",\n            backgroundPosition: \"center\",\n            opacity: 0.4\n          }}\n        />\n        {/* Gradient Overlay */}\n        <div className=\"absolute inset-0 -z-10 bg-gradient-to-b from-slate-900/90 via-slate-900/80 to-slate-900 lg:from-slate-900/80 lg:via-slate-900/50\" />\n\n        <div className=\"absolute inset-x-0 -top-40 -z-10 transform-gpu overflow-hidden blur-3xl sm:-top-80\" aria-hidden=\"true\">\n          <div className=\"relative left-[calc(50%-11rem)] aspect-[1155/678] w-[36.125rem] -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#ff80b5] to-[#9089fc] opacity-20 sm:left-[calc(50%-30rem)] sm:w-[72.1875rem]\" style={{ clipPath: 'polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)' }} />\n        </div>\n\n        {/* Abstract Data Grid Background */}\n        <div className=\"absolute inset-0 -z-10 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]\"></div>\n\n        <div className=\"mx-auto max-w-2xl py-32 sm:py-48 lg:py-56 text-center\">\n          <div className=\"hidden sm:mb-8 sm:flex sm:justify-center\">\n            <div className=\"relative rounded-full px-3 py-1 text-sm leading-6 text-slate-300 ring-1 ring-white/10 hover:ring-white/20\">\n              Advanced Research Tool for Complex Systems\n            </div>\n          </div>\n          {/* Replaced Text Title with Branding Image */}\n          <div className=\"flex justify-center mb-6\">\n            <Image\n              src=\"/algorithmic-assemblages.png\"\n              alt=\"Algorithmic Assemblages: Fields, Ecosystems, and Platforms\"\n              width={600}\n              height={600}\n              className=\"w-full max-w-xl h-auto drop-shadow-2xl hover:scale-105 transition-transform duration-500\"\n              priority\n            />\n          </div>\n          <p className=\"mt-6 text-lg leading-8 text-slate-200\">\n            <Link href=\"/glossary\" className=\"inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-blue-500/50 hover:scale-105 transition-all duration-300 group\">\n              <span className=\"text-slate-300 group-hover:text-white transition-colors\">What is</span>\n              <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 font-bold\">Assemblage AI</span>\n              <span className=\"text-slate-400 group-hover:text-blue-400 transition-colors\">?</span>\n            </Link>\n          </p>\n          <p className=\"mt-4 text-sm text-slate-300 max-w-2xl mx-auto leading-relaxed text-left\">\n            Assemblage-AI is a platform dedicated to analyzing and managing AI governance, policy frameworks, and structural dynamics. It offers tools for data collection, ecosystem mapping, and critical reflection to explore the complexities of AI systems. Key insights include the challenges of centralized governance, limited inclusivity, and the tension between civic values and market-driven innovation. With resources like critical glossaries and literature reviews, Assemblage-AI aims to foster responsible and equitable AI practices while addressing global regulatory and ethical challenges.\n          </p>\n          <div className=\"mt-10 flex items-center justify-center gap-x-6\">\n            <Link href=\"/demo\">\n              <Button size=\"lg\" className=\"bg-emerald-600 hover:bg-emerald-500 text-white border border-emerald-400/30 px-8 transition-all hover:scale-105 group shadow-lg shadow-emerald-900/20\">\n                <Activity className=\"mr-2 h-4 w-4 group-hover:animate-pulse\" />\n                Explore Analysis Output\n              </Button>\n            </Link>\n          </div>\n          <div className=\"mt-8 flex flex-col items-center justify-center gap-6\">\n            <Link href=\"/login\" className=\"text-sm font-semibold leading-6 text-white hover:text-blue-300\">\n              Log in to your account <span aria-hidden=\"true\">â†’</span>\n            </Link>\n            <Link href=\"/sign-up\">\n              <Button size=\"lg\" className=\"bg-blue-600 hover:bg-blue-500 text-white font-semibold px-8\">\n                Get Started\n              </Button>\n            </Link>\n          </div>\n\n          {/* CSS-Based Dashboard Preview */}\n          <div className=\"mt-16 flow-root sm:mt-24\">\n            <div className=\"-m-2 rounded-xl bg-gray-900/5 p-2 ring-1 ring-inset ring-gray-900/10 lg:-m-4 lg:rounded-2xl lg:p-4\">\n              <div className=\"relative rounded-xl bg-slate-900/80 shadow-2xl ring-1 ring-white/10 backdrop-blur-md overflow-hidden group\">\n                {/* \n                  VIDEO EFFECT INSTRUCTION:\n                  To use a real video instead of the mock UI, uncomment the following video tag and remove the \"Mock UI Body\" div below.\n                  Ensure you have a file named 'demo.mp4' in your public folder.\n                */}\n                {\n                  <video\n                    controls\n                    playsInline\n                    className=\"w-full h-full object-cover opacity-90\"\n                  >\n                    <source src=\"/Sequence 01.mp4#t=0.001\" type=\"video/mp4\" />\n                  </video>\n                }\n\n                {/* Scanline/CRT Effect Overlay */}\n                <div className=\"absolute inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%] bg-repeat opacity-20\"></div>\n                <div className=\"absolute inset-0 pointer-events-none z-50 bg-gradient-to-b from-white/5 to-transparent opacity-10\"></div>\n\n\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Global Coverage Section */}\n      <div className=\"bg-white py-10 border-b border-slate-100\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8\">\n          <p className=\"text-center text-sm font-semibold leading-8 text-slate-500 uppercase tracking-widest\">\n            Comparative Analysis of Major AI Regimes\n          </p>\n          <div className=\"mx-auto mt-8 grid max-w-lg grid-cols-4 items-center gap-x-8 gap-y-10 sm:max-w-xl sm:gap-x-10 sm:grid-cols-4 lg:mx-0 lg:max-w-none lg:grid-cols-4\">\n            <div className=\"col-span-1 flex flex-col items-center justify-center gap-2 group cursor-default\">\n              <span className=\"text-4xl filter grayscale group-hover:grayscale-0 transition-all duration-300 transform group-hover:scale-110\">ðŸ‡ªðŸ‡º</span>\n              <span className=\"text-xs font-bold text-slate-400 group-hover:text-blue-600 transition-colors\">EU AI Act</span>\n            </div>\n            <div className=\"col-span-1 flex flex-col items-center justify-center gap-2 group cursor-default\">\n              <span className=\"text-4xl filter grayscale group-hover:grayscale-0 transition-all duration-300 transform group-hover:scale-110\">ðŸ‡ºðŸ‡¸</span>\n              <span className=\"text-xs font-bold text-slate-400 group-hover:text-blue-600 transition-colors\">US Executive Order</span>\n            </div>\n            <div className=\"col-span-1 flex flex-col items-center justify-center gap-2 group cursor-default\">\n              <span className=\"text-4xl filter grayscale group-hover:grayscale-0 transition-all duration-300 transform group-hover:scale-110\">ðŸ‡¨ðŸ‡³</span>\n              <span className=\"text-xs font-bold text-slate-400 group-hover:text-blue-600 transition-colors\">China Interim Measures</span>\n            </div>\n            <div className=\"col-span-1 flex flex-col items-center justify-center gap-2 group cursor-default\">\n              <span className=\"text-4xl filter grayscale group-hover:grayscale-0 transition-all duration-300 transform group-hover:scale-110\">ðŸ‡§ðŸ‡·</span>\n              <span className=\"text-xs font-bold text-slate-400 group-hover:text-blue-600 transition-colors\">Brazil PL 2338</span>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div className=\"bg-white py-12 border-b border-slate-100\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8\">\n          <p className=\"text-center text-sm font-semibold leading-8 text-slate-500 uppercase tracking-widest\">\n            Powered by industry-leading technology\n          </p>\n          <div className=\"mx-auto mt-8 grid max-w-lg grid-cols-3 items-center gap-x-8 gap-y-10 sm:max-w-xl sm:gap-x-10 lg:mx-0 lg:max-w-none lg:grid-cols-3\">\n            {/* Google Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" fill=\"#4285F4\" />\n                  <path d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" fill=\"#34A853\" />\n                  <path d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\" fill=\"#FBBC05\" />\n                  <path d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" fill=\"#EA4335\" />\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">Google</span>\n              </div>\n            </div>\n\n            {/* OpenAI Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8 text-black\" viewBox=\"0 0 24 24\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.0462 6.0462 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1195 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.09-1.1088l2.9251-1.6923 2.9251 1.6923v3.3846l-2.9251 1.6923-2.9251-1.6923z\" />\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">OpenAI</span>\n              </div>\n            </div>\n\n            {/* Redis Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8 text-red-600\" viewBox=\"0 0 24 24\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M20.4 3.6H3.6C1.6 3.6 0 5.2 0 7.2v9.6c0 2 1.6 3.6 3.6 3.6h16.8c2 0 3.6-1.6 3.6-3.6V7.2c0-2-1.6-3.6-3.6-3.6zm-12 12H4.8v-2.4h3.6v2.4zm0-4.8H4.8V8.4h3.6v2.4zm4.8 4.8H9.6v-2.4h3.6v2.4zm0-4.8H9.6V8.4h3.6v2.4zm4.8 4.8h-3.6v-2.4h3.6v2.4zm0-4.8h-3.6V8.4h3.6v2.4zm4.8 4.8h-3.6v-2.4h3.6v2.4zm0-4.8h-3.6V8.4h3.6v2.4z\" />\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">Redis</span>\n              </div>\n            </div>\n\n            {/* Gemini Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z\" fill=\"url(#gemini-gradient)\" />\n                  <defs>\n                    <linearGradient id=\"gemini-gradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n                      <stop offset=\"0%\" stopColor=\"#4E85F7\" />\n                      <stop offset=\"100%\" stopColor=\"#D6669D\" />\n                    </linearGradient>\n                  </defs>\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">Gemini</span>\n              </div>\n            </div>\n\n            {/* Next.js Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M12 2L2 19.7778H22L12 2Z\" fill=\"black\" className=\"fill-slate-900\" />\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">Next.js</span>\n              </div>\n            </div>\n\n            {/* Grok Logo */}\n            <div className=\"col-span-1 flex justify-center\">\n              <div className=\"flex items-center gap-2 grayscale hover:grayscale-0 transition-all duration-300 opacity-60 hover:opacity-100\">\n                <svg className=\"h-8 w-8\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <rect width=\"24\" height=\"24\" rx=\"4\" className=\"fill-slate-900\" />\n                  <path d=\"M6 18L18 6M18 6H10M18 6V14\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n                </svg>\n                <span className=\"text-xl font-bold text-slate-600\">Grok</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Value Proposition */}\n      <div className=\"py-24 sm:py-32 bg-slate-50\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8\">\n          <div className=\"mx-auto max-w-2xl lg:text-center\">\n            <h2 className=\"text-base font-semibold leading-7 text-blue-600\">Methodology</h2>\n            <p className=\"mt-2 text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl\">\n              From Archive to Insight\n            </p>\n            <p className=\"mt-6 text-lg leading-8 text-slate-600\">\n              A systematic approach to analyzing complex textual datasets through multiple theoretical lenses.\n            </p>\n\n            {/* Video Panel */}\n            <div className=\"mt-12 w-full max-w-4xl mx-auto\">\n              <div className=\"bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-2xl\">\n                <div className=\"p-4 border-b border-slate-800 bg-slate-900/50\">\n                  <h3 className=\"text-white font-semibold flex items-center gap-2\">\n                    <div className=\"p-1 bg-indigo-500/20 rounded\">\n                      <Play className=\"h-4 w-4 text-indigo-400\" />\n                    </div>\n                    Introduction To Assemblage-AI\n                  </h3>\n                  <p className=\"text-sm text-slate-400 mt-1\">\n                    A video exploration of the need for Assemblage-AI.\n                  </p>\n                </div>\n                <div className=\"aspect-video w-full bg-black relative\">\n                  <video\n                    controls\n                    className=\"w-full h-full object-contain\"\n                    poster=\"/landing-bg.png\"\n                  >\n                    <source src=\"/assemblagebr.mp4\" type=\"video/mp4\" />\n                    Your browser does not support the video tag.\n                  </video>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div className=\"mx-auto mt-16 max-w-2xl sm:mt-20 lg:mt-24 lg:max-w-none\">\n            <dl className=\"grid max-w-xl grid-cols-1 gap-x-8 gap-y-16 lg:max-w-none lg:grid-cols-3\">\n              <div className=\"flex flex-col\">\n                <dt className=\"flex items-center gap-x-3 text-base font-semibold leading-7 text-slate-900\">\n                  <div className=\"h-10 w-10 flex items-center justify-center rounded-lg bg-blue-600\">\n                    <Database className=\"h-6 w-6 text-white\" aria-hidden=\"true\" />\n                  </div>\n                  Data Ingestion\n                </dt>\n                <dd className=\"mt-4 flex flex-auto flex-col text-base leading-7 text-slate-600\">\n                  <p className=\"flex-auto\">\n                    Upload PDFs, scrape web traces, and organize your primary sources. The system automatically extracts text and prepares it for analysis.\n                  </p>\n                </dd>\n              </div>\n              <div className=\"flex flex-col\">\n                <dt className=\"flex items-center gap-x-3 text-base font-semibold leading-7 text-slate-900\">\n                  <div className=\"h-10 w-10 flex items-center justify-center rounded-lg bg-indigo-600\">\n                    <Cpu className=\"h-6 w-6 text-white\" aria-hidden=\"true\" />\n                  </div>\n                  AI-Powered Analysis\n                </dt>\n                <dd className=\"mt-4 flex flex-auto flex-col text-base leading-7 text-slate-600\">\n                  <p className=\"flex-auto\">\n                    Apply specific theoretical lenses (Resistance, Cultural Framing, Institutional Logics) using advanced LLMs to extract structured insights.\n                  </p>\n                </dd>\n              </div>\n              <div className=\"flex flex-col\">\n                <dt className=\"flex items-center gap-x-3 text-base font-semibold leading-7 text-slate-900\">\n                  <div className=\"h-10 w-10 flex items-center justify-center rounded-lg bg-teal-600\">\n                    <GitGraph className=\"h-6 w-6 text-white\" aria-hidden=\"true\" />\n                  </div>\n                  Network Synthesis\n                </dt>\n                <dd className=\"mt-4 flex flex-auto flex-col text-base leading-7 text-slate-600\">\n                  <p className=\"flex-auto\">\n                    Visualize relationships between actors, concepts, and documents. Detect cultural holes and generate comparative reports.\n                  </p>\n                </dd>\n              </div>\n            </dl>\n          </div>\n        </div>\n      </div>\n\n      {/* Audience Section */}\n      <div className=\"py-24 sm:py-32 bg-white border-t border-slate-100\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8\">\n          <div className=\"mx-auto max-w-2xl lg:text-center mb-16\">\n            <h2 className=\"text-base font-semibold leading-7 text-indigo-600\">Community</h2>\n            <p className=\"mt-2 text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl\">\n              Who uses Assemblage-AI?\n            </p>\n          </div>\n          <div className=\"mx-auto grid max-w-2xl grid-cols-1 gap-8 lg:max-w-none lg:grid-cols-3\">\n            <div className=\"flex flex-col items-start p-6 bg-slate-50 rounded-2xl\">\n              <div className=\"p-3 bg-blue-100 rounded-xl mb-4\">\n                <GraduationCap className=\"h-6 w-6 text-blue-600\" />\n              </div>\n              <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">Academic Researchers</h3>\n              <p className=\"text-slate-600 leading-relaxed\">\n                Scholars in STS, Information Systems, and Law studying AI policy, algorithmic governance, and sociotechnical imaginaries.\n              </p>\n            </div>\n            <div className=\"flex flex-col items-start p-6 bg-slate-50 rounded-2xl\">\n              <div className=\"p-3 bg-indigo-100 rounded-xl mb-4\">\n                <Building className=\"h-6 w-6 text-indigo-600\" />\n              </div>\n              <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">Policy Teams</h3>\n              <p className=\"text-slate-600 leading-relaxed\">\n                Regulators and analysts comparing global AI frameworks, tracking compliance logic, and identifying regulatory gaps.\n              </p>\n            </div>\n            <div className=\"flex flex-col items-start p-6 bg-slate-50 rounded-2xl\">\n              <div className=\"p-3 bg-teal-100 rounded-xl mb-4\">\n                <Users className=\"h-6 w-6 text-teal-600\" />\n              </div>\n              <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">Advocates & NGOs</h3>\n              <p className=\"text-slate-600 leading-relaxed\">\n                Civil society organizations examining power dynamics, data justice, and the social impact of algorithmic systems.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Trust & Ethics Section */}\n      <div className=\"py-24 sm:py-32 bg-slate-900 text-slate-300\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8\">\n          <div className=\"mx-auto max-w-2xl lg:mx-0 flex flex-col lg:flex-row items-center gap-12\">\n            <div className=\"lg:w-1/2\">\n              <h2 className=\"text-3xl font-bold tracking-tight text-white sm:text-4xl\">Trust, Ethics & Privacy</h2>\n              <p className=\"mt-6 text-lg leading-8\">\n                Built for critical research with a commitment to data sovereignty and transparency.\n              </p>\n            </div>\n            <div className=\"lg:w-1/2 relative\">\n              <div className=\"absolute inset-0 bg-blue-500/20 blur-3xl rounded-full\"></div>\n              <Image\n                src=\"/trust-ethics.png\"\n                alt=\"Digital Trust and Privacy\"\n                width={800}\n                height={600}\n                className=\"relative rounded-2xl shadow-2xl border border-white/10 w-full max-w-md mx-auto hover:scale-105 transition-transform duration-500\"\n              />\n            </div>\n          </div>\n          <div className=\"mx-auto mt-16 grid max-w-2xl grid-cols-1 gap-8 lg:mx-0 lg:max-w-none lg:grid-cols-2\">\n            <div className=\"flex flex-col\">\n              <dt className=\"flex items-center gap-x-3 text-base font-semibold leading-7 text-white\">\n                <Lock className=\"h-5 w-5 text-blue-400\" aria-hidden=\"true\" />\n                Data Handling & Privacy\n              </dt>\n              <dd className=\"mt-4 flex flex-auto flex-col text-base leading-7\">\n                <p className=\"flex-auto\">\n                  Uploaded documents are stored securely and are <strong>never used to train public AI models</strong>. You retain full ownership of your data. Files can be permanently deleted from our servers at any time.\n                </p>\n              </dd>\n            </div>\n            <div className=\"flex flex-col\">\n              <dt className=\"flex items-center gap-x-3 text-base font-semibold leading-7 text-white\">\n                <Shield className=\"h-5 w-5 text-blue-400\" aria-hidden=\"true\" />\n                Research Context\n              </dt>\n              <dd className=\"mt-4 flex flex-auto flex-col text-base leading-7\">\n                <p className=\"flex-auto\">\n                  Developed as part of academic research on using AI for critical analysis. This open-source tool is designed to reveal power structures, not reinforce them.\n                </p>\n              </dd>\n            </div>\n          </div>\n\n          {/* Privacy Badges */}\n          <div className=\"mt-16 pt-10 border-t border-white/10 flex flex-wrap justify-center gap-8 opacity-80\">\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10\">\n              <Shield className=\"h-4 w-4 text-emerald-400\" />\n              <span className=\"text-sm font-medium text-slate-300\">GDPR Ready</span>\n            </div>\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10\">\n              <Lock className=\"h-4 w-4 text-blue-400\" />\n              <span className=\"text-sm font-medium text-slate-300\">End-to-End Encrypted</span>\n            </div>\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10\">\n              <Database className=\"h-4 w-4 text-purple-400\" />\n              <span className=\"text-sm font-medium text-slate-300\">No Model Training</span>\n            </div>\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10\">\n              <GitGraph className=\"h-4 w-4 text-orange-400\" />\n              <span className=\"text-sm font-medium text-slate-300\">Open Source</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <footer className=\"bg-slate-950 text-slate-400 py-12 border-t border-slate-900\">\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8\">\n          <div className=\"col-span-1 md:col-span-2\">\n            <div className=\"flex items-center gap-2 mb-4\">\n              <div className=\"h-8 w-8 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-lg\"></div>\n              <span className=\"text-xl font-bold text-white\">Assemblage-AI</span>\n            </div>\n            <p className=\"text-sm leading-relaxed max-w-xs\">\n              An open-source platform for critical AI governance research, bridging the gap between policy intent and algorithmic reality.\n            </p>\n          </div>\n          <div>\n            <h4 className=\"text-white font-semibold mb-4\">Platform</h4>\n            <ul className=\"space-y-2 text-sm\">\n              <li><Link href=\"/data\" className=\"hover:text-blue-400 transition-colors\">Data Collection</Link></li>\n              <li><Link href=\"/ecosystem\" className=\"hover:text-blue-400 transition-colors\">Ecosystem Map</Link></li>\n              <li><Link href=\"/synthesis\" className=\"hover:text-blue-400 transition-colors\">Analysis Tools</Link></li>\n              <li><Link href=\"/demo\" className=\"hover:text-blue-400 transition-colors\">Live Demo</Link></li>\n            </ul>\n          </div>\n          <div>\n            <h4 className=\"text-white font-semibold mb-4\">Resources</h4>\n            <ul className=\"space-y-2 text-sm\">\n              <li><Link href=\"#\" className=\"hover:text-blue-400 transition-colors\">Documentation</Link></li>\n              <li><Link href=\"#\" className=\"hover:text-blue-400 transition-colors\">GitHub Repository</Link></li>\n              <li><Link href=\"#\" className=\"hover:text-blue-400 transition-colors\">Privacy Policy</Link></li>\n              <li><Link href=\"#\" className=\"hover:text-blue-400 transition-colors\">Contact</Link></li>\n            </ul>\n          </div>\n        </div>\n        <div className=\"mx-auto max-w-7xl px-6 lg:px-8 mt-12 pt-8 border-t border-slate-900 text-xs text-center\">\n          &copy; {new Date().getFullYear()} Assemblage-AI Research Group. Open Source (MIT License).\n        </div>\n      </footer>\n    </div>\n  );\n}\n\nfunction Dashboard({ sources }: { sources: Source[] }) {\n  const docCount = sources.filter(s => s.type !== 'Trace').length;\n  const traceCount = sources.filter(s => s.type === 'Trace').length;\n  const analyzedCount = sources.filter(s => s.analysis || s.cultural_framing || s.institutional_logics).length;\n\n  // Retrieve ecosystem state to visualize resistance\n  const [actors] = useServerStorage<EcosystemActor[]>(\"ecosystem_actors\", []);\n  const highResistanceCount = actors.filter(a => (a.metrics?.resistance || 0) > 5).length;\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Dashboard Header */}\n      <div className=\"bg-white p-6 rounded-xl border border-slate-200 shadow-sm\">\n        <h2 className=\"text-2xl font-bold tracking-tight text-slate-900\">\n          Assemblage Dashboard\n        </h2>\n        <p className=\"text-slate-500 mt-1\">\n          Assemblage Resumed. Continue critical entanglement with complex narratives.\n        </p>\n      </div>\n\n      {/* Metric Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card className=\"bg-gradient-to-br from-blue-50 to-white border-blue-100\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-blue-900\">\n              Documents\n            </CardTitle>\n            <div className=\"h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center\">\n              <FileText className=\"h-4 w-4 text-blue-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-blue-900\">{docCount}</div>\n            <p className=\"text-xs text-blue-600 mt-1 font-medium\">\n              Primary policy texts\n            </p>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-gradient-to-br from-indigo-50 to-white border-indigo-100\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-indigo-900\">\n              Empirical Traces\n            </CardTitle>\n            <div className=\"h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center\">\n              <Search className=\"h-4 w-4 text-indigo-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-indigo-900\">{traceCount}</div>\n            <p className=\"text-xs text-indigo-600 mt-1 font-medium\">\n              Collected from web sources\n            </p>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-gradient-to-br from-emerald-50 to-white border-emerald-100\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-emerald-900\">\n              Analyzed Sources\n            </CardTitle>\n            <div className=\"h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center\">\n              <Activity className=\"h-4 w-4 text-emerald-600\" />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-emerald-900\">{analyzedCount}</div>\n            <p className=\"text-xs text-emerald-600 mt-1 font-medium\">\n              Processed with AI lenses\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Rhizomatic Explorer (Primary Navigation) */}\n      <div>\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h3 className=\"text-lg font-semibold text-slate-900\">Rhizomatic Navigation</h3>\n            <p className=\"text-sm text-slate-500\">Explore the assemblage through entangled concepts.</p>\n          </div>\n          {highResistanceCount > 0 && (\n            <span className=\"inline-flex items-center rounded-full bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10 animate-pulse\">\n              High Resistance Detected in Ecosystem\n            </span>\n          )}\n        </div>\n        <div className=\"mb-12\">\n          <GalaxyGraph highResistanceCount={highResistanceCount} />\n        </div>\n      </div>\n\n      {/* Quick Actions (Secondary) */}\n      <div>\n        <h3 className=\"text-lg font-semibold text-slate-900 mb-4\">Assemblage Operations</h3>\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          <Link href=\"/data\">\n            <div className=\"group relative flex flex-col items-center justify-center p-6 bg-white border-2 border-dashed border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50/50 transition-all duration-200 cursor-pointer\">\n              <div className=\"h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-200\">\n                <Upload className=\"h-6 w-6 text-blue-600\" />\n              </div>\n              <span className=\"font-semibold text-slate-900 group-hover:text-blue-700\">Upload Document</span>\n              <span className=\"text-xs text-slate-500 mt-1\">Add new PDF policy text</span>\n            </div>\n          </Link>\n          <Link href=\"/empirical\">\n            <div className=\"group relative flex flex-col items-center justify-center p-6 bg-white border-2 border-dashed border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50/50 transition-all duration-200 cursor-pointer\">\n              <div className=\"h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-200\">\n                <Search className=\"h-6 w-6 text-indigo-600\" />\n              </div>\n              <span className=\"font-semibold text-slate-900 group-hover:text-indigo-700\">Find Traces</span>\n              <span className=\"text-xs text-slate-500 mt-1\">Search web for evidence</span>\n            </div>\n          </Link>\n          <Link href=\"/comparison\">\n            <div className=\"group relative flex flex-col items-center justify-center p-6 bg-white border-2 border-dashed border-slate-200 rounded-xl hover:border-cyan-500 hover:bg-cyan-50/50 transition-all duration-200 cursor-pointer\">\n              <div className=\"h-12 w-12 rounded-full bg-cyan-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-200\">\n                <Scale className=\"h-6 w-6 text-cyan-600\" />\n              </div>\n              <span className=\"font-semibold text-slate-900 group-hover:text-cyan-700\">Compare Frameworks</span>\n              <span className=\"text-xs text-slate-500 mt-1\">Side-by-side analysis</span>\n            </div>\n          </Link>\n          <Link href=\"/synthesis\">\n            <div className=\"group relative flex flex-col items-center justify-center p-6 bg-white border-2 border-dashed border-slate-200 rounded-xl hover:border-teal-500 hover:bg-teal-50/50 transition-all duration-200 cursor-pointer\">\n              <div className=\"h-12 w-12 rounded-full bg-teal-100 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-200\">\n                <Zap className=\"h-6 w-6 text-teal-600\" />\n              </div>\n              <span className=\"font-semibold text-slate-900 group-hover:text-teal-700\">Generate Report</span>\n              <span className=\"text-xs text-slate-500 mt-1\">Create synthesis PDF</span>\n            </div>\n          </Link>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function Home() {\n  const { isLoaded, isSignedIn } = useUser();\n  const { sources } = useSources();\n\n  if (!isLoaded) {\n    return <div className=\"flex items-center justify-center h-screen\">Loading...</div>;\n  }\n\n  if (!isSignedIn) {\n    // Bypass login if demo mode is enabled\n    if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === \"true\") {\n      return <Dashboard sources={sources} />;\n    }\n    return <LandingPage />;\n  }\n\n  return <Dashboard sources={sources} />;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\reflexivity\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\resistance\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchSource' is assigned a value but never used.","line":100,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":100,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSearchSource' is assigned a value but never used.","line":100,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":100,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { Source } from \"@/types\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nimport { Zap, EyeOff, Activity, Wrench, Users, Play, Loader2, Quote, Search, Trash, FileText } from \"lucide-react\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\n\r\nconst STRATEGY_DEFINITIONS = [\r\n    { title: \"Gambiarra\", icon: Wrench, color: \"text-orange-600\", bg: \"bg-orange-100\" },\r\n    { title: \"Obfuscation\", icon: EyeOff, color: \"text-slate-600\", bg: \"bg-slate-100\" },\r\n    { title: \"Solidarity\", icon: Users, color: \"text-green-600\", bg: \"bg-green-100\" },\r\n    { title: \"Refusal\", icon: Zap, color: \"text-red-600\", bg: \"bg-red-100\" },\r\n];\r\n\r\ninterface ResistanceSynthesisResult {\r\n    executive_summary: string;\r\n    dominant_strategies: { strategy: string; frequency: string; description: string }[];\r\n    emerging_themes: string[];\r\n    implications_for_policy: string;\r\n}\r\n\r\nexport default function ResistancePage() {\r\n    const { sources, addSource, updateSource, deleteSource, isLoading } = useSources();\r\n    const [selectedTraceId, setSelectedTraceId] = useServerStorage<string | null>(\"resistance_selected_trace_id\", null);\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [selectedPolicyId, setSelectedPolicyId] = useState<string | null>(null);\r\n\r\n    // Identify Policy Documents (Not traces)\r\n    const policyDocuments = sources.filter(s => s.type !== \"Trace\");\r\n\r\n    // Filter traces based on selection\r\n    const traces = sources.filter(s =>\r\n        (s.type === 'Trace' || (s.type === 'Text' && s.extractedText)) &&\r\n        s.policyId === selectedPolicyId\r\n    );\r\n\r\n    const handleAnalyzeTrace = async (trace: Source) => {\r\n        if (!trace.extractedText) return;\r\n\r\n        setIsAnalyzing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    text: trace.extractedText.substring(0, 3000),\r\n                    sourceType: 'Empirical Trace',\r\n                    analysisMode: 'resistance'\r\n                })\r\n            });\r\n\r\n            const result = await response.json();\r\n            if (result.success) {\r\n                await updateSource(trace.id, { resistance_analysis: result.analysis });\r\n                toast.success(\"Trace analyzed successfully!\");\r\n            } else {\r\n                if (response.status === 429 || result.error === \"Quota Exceeded\") {\r\n                    toast.error(\"Quota Exceeded\", {\r\n                        description: \"You have reached your lifetime API limit. Please contact admin.\",\r\n                        duration: 5000,\r\n                    });\r\n                } else {\r\n                    toast.error(\"Analysis failed\", { description: result.error });\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Analysis failed\", error);\r\n            toast.error(\"Failed to analyze trace.\");\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    const selectedTrace = traces.find(t => t.id === selectedTraceId);\r\n    const currentAnalysis = selectedTrace?.resistance_analysis;\r\n\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const [isSearchDialogOpen, setIsSearchDialogOpen] = useState(false);\r\n    const [searchSource, setSearchSource] = useState<Source | null>(null);\r\n    const [customQuery, setCustomQuery] = useServerStorage<string>(\"resistance_custom_query\", \"\");\r\n    const [selectedPlatforms, setSelectedPlatforms] = useServerStorage<string[]>(\"resistance_selected_platforms\", [\"reddit\", \"hackernews\", \"forums\"]);\r\n\r\n    const handleSearchTraces = async () => {\r\n        if (!selectedPolicyId) {\r\n            alert(\"Please select a policy document first.\");\r\n            return;\r\n        }\r\n\r\n        // Need either a policy source or custom query\r\n        // If searching with a specific source context, valid. Or just custom query.\r\n        // But we MUST link result to selectedPolicyId.\r\n\r\n        // Find the full source object for the selected policy to use as context if needed\r\n        const activePolicy = sources.find(s => s.id === selectedPolicyId);\r\n\r\n        if (!activePolicy?.extractedText && !customQuery.trim()) {\r\n            alert(\"No text in selected policy and no custom query provided.\");\r\n            return;\r\n        }\r\n\r\n        setIsSearching(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/search-traces', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    policyText: activePolicy?.extractedText?.substring(0, 3000),\r\n                    customQuery: customQuery.trim() || undefined,\r\n                    platforms: selectedPlatforms\r\n                })\r\n            });\r\n\r\n            const result = await response.json();\r\n            console.log(\"DEBUG: Search Result Traces:\", result.traces); // Check raw response in browser console\r\n\r\n            if (result.success && Array.isArray(result.traces)) {\r\n                const newTraces = result.traces.map((trace: { title: string; description: string; query: string; content: string; sourceUrl: string; strategy?: string; explanation?: string }) => ({\r\n                    id: Math.random().toString(36).substr(2, 9),\r\n                    title: `[Web] ${trace.title}`,\r\n                    description: `${trace.description} â€¢ Query: \"${trace.query}\"`,\r\n                    type: \"Trace\",\r\n                    extractedText: `${trace.content}\\n\\nSource: ${trace.sourceUrl}`,\r\n                    addedDate: new Date().toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" }),\r\n                    status: \"Active Case\",\r\n                    colorClass: \"bg-blue-100\",\r\n                    iconClass: \"text-blue-600\",\r\n                    policyId: selectedPolicyId, // Link to selected policy\r\n                    resistance_analysis: trace.strategy ? {\r\n                        strategy_detected: trace.strategy,\r\n                        evidence_quote: trace.content,\r\n                        interpretation: trace.explanation || \"âš ï¸ NO INTERPRETATION RECEIVED\",\r\n                        confidence: \"Medium\"\r\n                    } : undefined\r\n                }));\r\n\r\n                // Add each new trace to the store\r\n                for (const trace of newTraces) {\r\n                    await addSource(trace);\r\n                }\r\n\r\n                toast.success(`Found ${newTraces.length} resistance traces from the web for ${activePolicy?.title}!`);\r\n                setCustomQuery(\"\"); // Reset query\r\n            } else {\r\n                if (response.status === 429 || result.error === \"Quota Exceeded\") {\r\n                    toast.error(\"Quota Exceeded\", {\r\n                        description: \"You have reached your lifetime API limit. Please contact admin.\",\r\n                        duration: 5000,\r\n                    });\r\n                } else {\r\n                    toast.error(\"Search failed\", { description: result.error || \"Unknown error\" });\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Search error:\", error);\r\n            toast.error(\"Failed to search for traces\", { description: \"Make sure your Google Search API is configured.\" });\r\n        } finally {\r\n            setIsSearching(false);\r\n            setIsSearchDialogOpen(false);\r\n        }\r\n    };\r\n\r\n    const handleDeleteTrace = async (traceId: string) => {\r\n        if (confirm(`Are you sure you want to delete this trace?`)) {\r\n            await deleteSource(traceId);\r\n            if (selectedTraceId === traceId) {\r\n                setSelectedTraceId(null);\r\n            }\r\n        }\r\n    };\r\n\r\n    const [isSynthesizing, setIsSynthesizing] = useState(false);\r\n    const [synthesisResult, setSynthesisResult] = useServerStorage<ResistanceSynthesisResult | null>(\"resistance_synthesis_result\", null);\r\n\r\n    const handleSynthesizeFindings = async () => {\r\n        const analyzedTraces = traces.filter(t => t.resistance_analysis);\r\n        if (analyzedTraces.length < 2) {\r\n            toast.error(\"Not enough data\", { description: \"Please analyze at least 2 traces before synthesizing.\" });\r\n            return;\r\n        }\r\n\r\n        // Check if we already have results and ask for confirmation\r\n        if (synthesisResult) {\r\n            if (!confirm(\"Existing synthesis found. Do you want to re-run it? This will overwrite the current findings.\")) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        setIsSynthesizing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    analysisMode: 'resistance_synthesis',\r\n                    documents: analyzedTraces.map(t => ({\r\n                        title: t.title,\r\n                        content: t.extractedText,\r\n                        analysis: t.resistance_analysis\r\n                    }))\r\n                })\r\n            });\r\n\r\n            const result = await response.json();\r\n            if (result.success) {\r\n                setSynthesisResult(result.analysis);\r\n                toast.success(\"Synthesis complete!\");\r\n            } else {\r\n                toast.error(\"Synthesis failed\", { description: result.details || result.error || \"Unknown error\" });\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Synthesis error:\", error);\r\n            toast.error(\"Failed to synthesize findings.\");\r\n        } finally {\r\n            setIsSynthesizing(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8 animate-in fade-in duration-500\">\r\n            <div className=\"flex flex-col gap-6\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">Micro-Resistance: Empirical Traces</h2>\r\n                    <p className=\"text-slate-500\">Analyze empirical traces linked to specific policy documents.</p>\r\n                </div>\r\n\r\n                {/* Policy Selector Section */}\r\n                <div className=\"p-6 bg-white rounded-xl border border-slate-200 shadow-sm\">\r\n                    <div className=\"flex flex-col md:flex-row gap-4 items-center justify-between\">\r\n                        <div className=\"flex items-center gap-4 w-full md:w-auto\">\r\n                            <div className=\"p-3 bg-purple-50 rounded-lg\">\r\n                                <FileText className=\"h-6 w-6 text-purple-600\" />\r\n                            </div>\r\n                            <div>\r\n                                <h3 className=\"font-semibold text-slate-900\">Active Policy Document</h3>\r\n                                <p className=\"text-sm text-slate-500\">Select a document to view resistance analysis</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"w-full md:w-[300px]\">\r\n                            <Select\r\n                                value={selectedPolicyId || \"\"}\r\n                                onValueChange={(val) => setSelectedPolicyId(val)}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue placeholder=\"Select a policy document...\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {policyDocuments.length === 0 ? (\r\n                                        <div className=\"p-2 text-sm text-slate-500 text-center\">No documents found</div>\r\n                                    ) : (\r\n                                        policyDocuments.map(doc => (\r\n                                            <SelectItem key={doc.id} value={doc.id}>\r\n                                                {doc.title}\r\n                                            </SelectItem>\r\n                                        ))\r\n                                    )}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {selectedPolicyId ? (\r\n                    <>\r\n                        <div className=\"flex items-center justify-end gap-2\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                onClick={handleSynthesizeFindings}\r\n                                disabled={isSynthesizing || traces.filter(t => t.resistance_analysis).length < 2}\r\n                                className=\"border-purple-200 hover:bg-purple-50 text-purple-700\"\r\n                            >\r\n                                {isSynthesizing ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Activity className=\"mr-2 h-4 w-4\" />}\r\n                                Synthesize Findings\r\n                            </Button>\r\n                            <Dialog open={isSearchDialogOpen} onOpenChange={setIsSearchDialogOpen}>\r\n                                <DialogTrigger asChild>\r\n                                    <Button className=\"bg-blue-600 text-white hover:bg-blue-700\">\r\n                                        <Search className=\"mr-2 h-4 w-4\" /> Search for Traces\r\n                                    </Button>\r\n                                </DialogTrigger>\r\n                                <DialogContent className=\"sm:max-w-[600px]\">\r\n                                    <DialogHeader>\r\n                                        <DialogTitle>Search Web for Resistance Traces</DialogTitle>\r\n                                        <DialogDescription>\r\n                                            Find real forum posts, Reddit threads, and discussions about resistance to {sources.find(s => s.id === selectedPolicyId)?.title}.\r\n                                        </DialogDescription>\r\n                                    </DialogHeader>\r\n                                    <div className=\"space-y-4 py-4\">\r\n                                        <div>\r\n                                            <label className=\"text-sm font-medium text-slate-700 mb-2 block\">\r\n                                                Custom Query (Optional)\r\n                                            </label>\r\n                                            <input\r\n                                                type=\"text\"\r\n                                                className=\"w-full p-2 border rounded-md text-sm\"\r\n                                                placeholder=\"e.g. 'workarounds'\"\r\n                                                value={customQuery}\r\n                                                onChange={(e) => setCustomQuery(e.target.value)}\r\n                                            />\r\n                                        </div>\r\n\r\n                                        <div className=\"grid grid-cols-2 gap-2 mt-4\">\r\n                                            {[\r\n                                                { id: 'reddit', label: 'Reddit' },\r\n                                                { id: 'hackernews', label: 'Hacker News' },\r\n                                                { id: 'forums', label: 'Forums' },\r\n                                                { id: 'twitter', label: 'Twitter/X' },\r\n                                                { id: 'technews', label: 'Tech News' },\r\n                                                { id: 'mastodon', label: 'Mastodon' }\r\n                                            ].map(platform => (\r\n                                                <label key={platform.id} className=\"flex items-center gap-2 cursor-pointer\">\r\n                                                    <input\r\n                                                        type=\"checkbox\"\r\n                                                        checked={selectedPlatforms.includes(platform.id)}\r\n                                                        onChange={(e) => {\r\n                                                            if (e.target.checked) {\r\n                                                                setSelectedPlatforms([...selectedPlatforms, platform.id]);\r\n                                                            } else {\r\n                                                                setSelectedPlatforms(selectedPlatforms.filter(p => p !== platform.id));\r\n                                                            }\r\n                                                        }}\r\n                                                        className=\"rounded\"\r\n                                                    />\r\n                                                    <span className=\"text-sm\">{platform.label}</span>\r\n                                                </label>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <DialogFooter>\r\n                                        <Button\r\n                                            onClick={handleSearchTraces}\r\n                                            disabled={isSearching}\r\n                                            className=\"bg-blue-600 hover:bg-blue-700\"\r\n                                        >\r\n                                            {isSearching ? (\r\n                                                <>\r\n                                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                                    Searching Web...\r\n                                                </>\r\n                                            ) : (\r\n                                                <>\r\n                                                    <Search className=\"mr-2 h-4 w-4\" />\r\n                                                    Search\r\n                                                </>\r\n                                            )}\r\n                                        </Button>\r\n                                    </DialogFooter>\r\n                                </DialogContent>\r\n                            </Dialog>\r\n                        </div>\r\n\r\n                        {synthesisResult && (\r\n                            <Card className=\"bg-purple-50 border-purple-200\">\r\n                                <CardHeader>\r\n                                    <CardTitle className=\"text-purple-900 flex items-center\">\r\n                                        <Activity className=\"mr-2 h-5 w-5\" /> Synthesis of Findings\r\n                                    </CardTitle>\r\n                                </CardHeader>\r\n                                <CardContent className=\"space-y-4\">\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-purple-900 mb-1\">Executive Summary</h4>\r\n                                        <p className=\"text-purple-800 text-sm leading-relaxed\">{synthesisResult.executive_summary}</p>\r\n                                    </div>\r\n                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                        <div>\r\n                                            <h4 className=\"font-semibold text-purple-900 mb-2\">Dominant Strategies</h4>\r\n                                            <ul className=\"space-y-2\">\r\n                                                {synthesisResult.dominant_strategies?.map((s: { strategy: string; frequency: string; description: string }, i: number) => (\r\n                                                    <li key={i} className=\"text-sm bg-white p-2 rounded border border-purple-100\">\r\n                                                        <span className=\"font-bold text-purple-700\">{s.strategy}</span> ({s.frequency}): {s.description}\r\n                                                    </li>\r\n                                                ))}\r\n                                            </ul>\r\n                                        </div>\r\n                                        <div>\r\n                                            <h4 className=\"font-semibold text-purple-900 mb-2\">Emerging Themes</h4>\r\n                                            <ul className=\"list-disc list-inside text-sm text-purple-800 space-y-1\">\r\n                                                {synthesisResult.emerging_themes?.map((t: string, i: number) => (\r\n                                                    <li key={i}>{t}</li>\r\n                                                ))}\r\n                                            </ul>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-purple-900 mb-1\">Policy Implications</h4>\r\n                                        <p className=\"text-purple-800 text-sm\">{synthesisResult.implications_for_policy}</p>\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )}\r\n\r\n                        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n                            {/* Left Column: Trace Selector */}\r\n                            <div className=\"space-y-4\">\r\n                                <h3 className=\"font-semibold text-slate-900 flex items-center\">\r\n                                    <Activity className=\"mr-2 h-4 w-4\" /> Available Traces\r\n                                </h3>\r\n                                <div className=\"space-y-2\">\r\n                                    {traces.length === 0 && (\r\n                                        <Card className=\"bg-slate-50 border-dashed\">\r\n                                            <CardContent className=\"p-4 text-center text-sm text-slate-500\">\r\n                                                No traces found. Use &quot;Search for Traces&quot; to filter public comments and discussions for this policy.\r\n                                            </CardContent>\r\n                                        </Card>\r\n                                    )}\r\n                                    {traces.map(trace => (\r\n                                        <Card\r\n                                            key={trace.id}\r\n                                            className={`transition-all hover:border-purple-400 ${selectedTraceId === trace.id ? 'border-purple-600 ring-1 ring-purple-600' : ''}`}\r\n                                        >\r\n                                            <CardContent className=\"p-4\">\r\n                                                <div className=\"flex items-start justify-between gap-2\">\r\n                                                    <div\r\n                                                        className=\"flex-1 min-w-0 pr-2 cursor-pointer\"\r\n                                                        onClick={() => setSelectedTraceId(trace.id)}\r\n                                                    >\r\n                                                        <div className=\"font-medium text-slate-900 break-words\">{trace.title}</div>\r\n                                                        <div className=\"text-xs text-slate-500 mt-1 break-words\">{trace.description}</div>\r\n                                                        {trace.resistance_analysis?.strategy_detected ? (\r\n                                                            <Badge variant=\"secondary\" className=\"mt-2 bg-purple-100 text-purple-700 border-purple-200\">\r\n                                                                {trace.resistance_analysis.strategy_detected}\r\n                                                            </Badge>\r\n                                                        ) : trace.resistance_analysis && (\r\n                                                            <Badge variant=\"secondary\" className=\"mt-2 bg-green-100 text-green-700\">\r\n                                                                Analyzed\r\n                                                            </Badge>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    <Button\r\n                                                        variant=\"ghost\"\r\n                                                        size=\"sm\"\r\n                                                        className=\"shrink-0 h-8 w-8 p-0 hover:bg-red-100 hover:text-red-600\"\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation();\r\n                                                            handleDeleteTrace(trace.id);\r\n                                                        }}\r\n                                                    >\r\n                                                        <Trash className=\"h-4 w-4\" />\r\n                                                    </Button>\r\n                                                </div>\r\n                                            </CardContent>\r\n                                        </Card>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Middle Column: Analysis Area */}\r\n                            <div className=\"lg:col-span-2 space-y-6\">\r\n                                {selectedTrace ? (\r\n                                    <div className=\"space-y-6\">\r\n                                        <Card>\r\n                                            <CardHeader>\r\n                                                <CardTitle className=\"flex justify-between items-center\">\r\n                                                    <span>Analysis: {selectedTrace.title}</span>\r\n                                                    {!currentAnalysis && (\r\n                                                        <Button\r\n                                                            onClick={() => handleAnalyzeTrace(selectedTrace)}\r\n                                                            disabled={isAnalyzing}\r\n                                                            className=\"bg-purple-600 hover:bg-purple-700\"\r\n                                                        >\r\n                                                            {isAnalyzing ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Play className=\"mr-2 h-4 w-4\" />}\r\n                                                            Analyze Trace\r\n                                                        </Button>\r\n                                                    )}\r\n                                                </CardTitle>\r\n                                            </CardHeader>\r\n                                            <CardContent>\r\n                                                {currentAnalysis ? (\r\n                                                    <div className=\"space-y-6\">\r\n                                                        <div className=\"flex items-center space-x-4\">\r\n                                                            <div className=\"p-3 bg-purple-100 rounded-full\">\r\n                                                                <Zap className=\"h-6 w-6 text-purple-600\" />\r\n                                                            </div>\r\n                                                            <div>\r\n                                                                <div className=\"text-sm text-slate-500 uppercase tracking-wider font-bold\">Strategy Detected</div>\r\n                                                                <div className=\"text-2xl font-bold text-slate-900\">{currentAnalysis.strategy_detected}</div>\r\n                                                            </div>\r\n                                                            <Badge className={currentAnalysis.confidence === 'High' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}>\r\n                                                                {currentAnalysis.confidence} Confidence\r\n                                                            </Badge>\r\n                                                        </div>\r\n\r\n                                                        <div className=\"bg-slate-50 p-4 rounded-lg border border-slate-200 relative\">\r\n                                                            <Quote className=\"absolute top-2 left-2 h-8 w-8 text-slate-200 -z-0\" />\r\n                                                            <p className=\"text-slate-700 italic relative z-10 pl-6\">\r\n                                                                &quot;{currentAnalysis.evidence_quote}&quot;\r\n                                                            </p>\r\n                                                        </div>\r\n\r\n                                                        <div>\r\n                                                            <h4 className=\"font-semibold text-slate-900 mb-2\">Interpretation</h4>\r\n                                                            <p className=\"text-slate-600 leading-relaxed\">\r\n                                                                {currentAnalysis.interpretation}\r\n                                                            </p>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"text-center py-12 text-slate-500\">\r\n                                                        <p>Select &quot;Analyze Trace&quot; to identify resistance strategies using the LLM.</p>\r\n                                                    </div>\r\n                                                )}\r\n                                            </CardContent>\r\n                                        </Card>\r\n\r\n                                        {/* Reference Definitions */}\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            {STRATEGY_DEFINITIONS.map(def => (\r\n                                                <div key={def.title} className=\"flex items-center space-x-3 p-3 bg-white rounded-lg border border-slate-100 shadow-sm\">\r\n                                                    <div className={`p-2 rounded-full ${def.bg}`}>\r\n                                                        <def.icon className={`h-4 w-4 ${def.color}`} />\r\n                                                    </div>\r\n                                                    <span className=\"font-medium text-slate-700\">{def.title}</span>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"flex flex-col items-center justify-center h-64 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200\">\r\n                                        <Activity className=\"h-10 w-10 text-slate-300 mb-4\" />\r\n                                        <p className=\"text-slate-500\">Select a trace from the left to begin analysis</p>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </>\r\n                ) : (\r\n                    <div className=\"bg-slate-50 rounded-xl border border-dashed border-slate-200 p-12 text-center\">\r\n                        <div className=\"mx-auto w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4\">\r\n                            <FileText className=\"h-8 w-8 text-slate-300\" />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-bold text-slate-700\">No Policy Selected</h3>\r\n                        <p className=\"text-slate-500 mt-2\">Please select a policy document above to view and manage its resistance traces.</p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\results\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useServerStorage' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2293,2296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2293,2296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4390,4393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4390,4393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState } from 'react';\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\n// import { CulturalHolesAnalysisResult } from \"@/types/ecosystem\";\r\n// import { CulturalHolesAnalysis } from \"@/components/ecosystem/CulturalHolesAnalysis\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Sparkles, ArrowRight, RotateCcw } from \"lucide-react\";\r\nimport { AVAILABLE_PERSPECTIVES, DEFAULT_PERSPECTIVE_A, DEFAULT_PERSPECTIVE_B } from \"@/lib/perspectives\";\r\n\r\nexport default function ResultsPage() {\r\n    // const [analysisResult, setAnalysisResult] = useState<CulturalHolesAnalysisResult | null>(null);\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [hasRun, setHasRun] = useState(false);\r\n\r\n    // State for the \"Manuscript\" text - editable by the user\r\n    const [paragraph1, setParagraph1] = useState(\"\");\r\n    const [paragraph2, setParagraph2] = useState(\"\");\r\n    const [isSimulating, setIsSimulating] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [perspA, setPerspA] = useState(DEFAULT_PERSPECTIVE_A.id);\r\n    const [perspB, setPerspB] = useState(DEFAULT_PERSPECTIVE_B.id);\r\n\r\n    const handleSimulate = async () => {\r\n        setIsSimulating(true);\r\n        setError(null);\r\n        try {\r\n            const headers: Record<string, string> = { 'Content-Type': 'application/json' };\r\n            const demoUserId = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            if (demoUserId) {\r\n                headers['x-demo-user-id'] = demoUserId;\r\n            }\r\n\r\n            const response = await fetch('/api/simulate-perspectives', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({\r\n                    topic: \"AI Safety Regulation\",\r\n                    perspectiveAId: perspA,\r\n                    perspectiveBId: perspB\r\n                })\r\n            });\r\n            const data = await response.json();\r\n            if (data.success && data.perspectives) {\r\n                setParagraph1(data.perspectives.perspectiveA);\r\n                setParagraph2(data.perspectives.perspectiveB);\r\n            } else {\r\n                throw new Error(data.error || \"Simulation failed\");\r\n            }\r\n        } catch (error: any) {\r\n            console.error(\"Simulation failed:\", error);\r\n            setError(error.message || \"Failed to generate perspectives\");\r\n        } finally {\r\n            setIsSimulating(false);\r\n        }\r\n    };\r\n\r\n    const handleAnalyze = async (forceRefresh = false) => {\r\n        setIsAnalyzing(true);\r\n        setError(null);\r\n        try {\r\n            if (!paragraph1.trim() || !paragraph2.trim()) {\r\n                throw new Error(\"Both perspectives must have text content.\");\r\n            }\r\n\r\n            // we treat the two paragraphs as distinct \"sources\" to find the hole between them\r\n            const sources = [\r\n                {\r\n                    id: \"para-1-side-a\",\r\n                    title: \"Perspective A\",\r\n                    text: paragraph1\r\n                },\r\n                {\r\n                    id: \"para-2-side-b\",\r\n                    title: \"Perspective B\",\r\n                    text: paragraph2\r\n                }\r\n            ];\r\n\r\n            const headers: Record<string, string> = { 'Content-Type': 'application/json' };\r\n            const demoUserId = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            if (demoUserId) {\r\n                headers['x-demo-user-id'] = demoUserId;\r\n            }\r\n\r\n            const response = await fetch('/api/cultural-analysis', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({\r\n                    sources,\r\n                    lensId: 'dsf_lens',\r\n                    forceRefresh\r\n                })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const errorData = await response.json();\r\n                throw new Error(errorData.error || `Analysis failed with status ${response.status}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            if (data.success && data.analysis) {\r\n                // setAnalysisResult(data.analysis);\r\n                setHasRun(true);\r\n            } else {\r\n                throw new Error(data.error || \"Analysis returned no data\");\r\n            }\r\n        } catch (error: any) {\r\n            console.error(\"Analysis failed:\", error);\r\n            setError(error.message || \"An unexpected error occurred during analysis\");\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto py-12 px-6 font-serif\">\r\n            {error && (\r\n                <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6 font-sans text-sm\">\r\n                    <strong>Error:</strong> {error}\r\n                </div>\r\n            )}\r\n            <header className=\"mb-12 border-b pb-6\">\r\n                <div className=\"text-sm font-sans font-bold text-slate-500 uppercase tracking-widest mb-2\">\r\n                    Journal of Sociomaterial Governance â€¢ Vol. 12 â€¢ 2025\r\n                </div>\r\n                <h1 className=\"text-4xl font-bold text-slate-900 mb-4 font-sans\">\r\n                    Entangled Agencies: A Comparative Assemblage Analysis\r\n                </h1>\r\n                <div className=\"flex items-center gap-4 text-sm text-slate-600 font-sans\">\r\n                    <span>A. Nonymous</span>\r\n                    <span>â€¢</span>\r\n                    <span>Methods: Algorithmic Ethnography</span>\r\n                </div>\r\n            </header>\r\n\r\n            <article className=\"prose prose-lg prose-slate max-w-none\">\r\n                <h2 className=\"font-sans m-0 mb-4\">3. Results: Analysis of Discursive Fractures</h2>\r\n                <div className=\"flex flex-col gap-4 mb-8 bg-slate-50 p-4 rounded border border-slate-200\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <h3 className=\"text-sm font-bold text-slate-700\">Simulation Configuration</h3>\r\n                        <Button\r\n                            variant=\"default\"\r\n                            size=\"sm\"\r\n                            onClick={handleSimulate}\r\n                            disabled={isSimulating}\r\n                            className=\"text-xs\"\r\n                        >\r\n                            {isSimulating ? \"Generating...\" : \"Auto-Generate Perspectives\"}\r\n                            <Sparkles className=\"ml-1 h-3 w-3\" />\r\n                        </Button>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label className=\"text-xs font-semibold text-slate-500 mb-1 block\">Perspective A</label>\r\n                            <select\r\n                                value={perspA}\r\n                                onChange={(e) => setPerspA(e.target.value)}\r\n                                className=\"w-full text-sm p-2 rounded border border-slate-300 bg-white\"\r\n                            >\r\n                                {AVAILABLE_PERSPECTIVES.map(p => (\r\n                                    <option key={p.id} value={p.id}>{p.name}</option>\r\n                                ))}\r\n                            </select>\r\n                            <p className=\"text-[10px] text-slate-400 mt-1\">\r\n                                {AVAILABLE_PERSPECTIVES.find(p => p.id === perspA)?.description}\r\n                            </p>\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"text-xs font-semibold text-slate-500 mb-1 block\">Perspective B</label>\r\n                            <select\r\n                                value={perspB}\r\n                                onChange={(e) => setPerspB(e.target.value)}\r\n                                className=\"w-full text-sm p-2 rounded border border-slate-300 bg-white\"\r\n                            >\r\n                                {AVAILABLE_PERSPECTIVES.map(p => (\r\n                                    <option key={p.id} value={p.id}>{p.name}</option>\r\n                                ))}\r\n                            </select>\r\n                            <p className=\"text-[10px] text-slate-400 mt-1\">\r\n                                {AVAILABLE_PERSPECTIVES.find(p => p.id === perspB)?.description}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"relative group\">\r\n                    <div className=\"absolute -left-4 top-2 bottom-2 w-1 bg-indigo-200 opacity-0 group-hover:opacity-100 transition-opacity\"></div>\r\n                    <textarea\r\n                        value={paragraph1}\r\n                        onChange={(e) => setParagraph1(e.target.value)}\r\n                        className=\"w-full bg-transparent border-none p-0 text-lg leading-relaxed text-slate-800 resize-none outline-none focus:ring-0 font-serif\"\r\n                        rows={6}\r\n                        placeholder=\"[Perspective A text will appear here...]\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"relative group mt-6\">\r\n                    <div className=\"absolute -left-4 top-2 bottom-2 w-1 bg-amber-200 opacity-0 group-hover:opacity-100 transition-opacity\"></div>\r\n                    <textarea\r\n                        value={paragraph2}\r\n                        onChange={(e) => setParagraph2(e.target.value)}\r\n                        className=\"w-full bg-transparent border-none p-0 text-lg leading-relaxed text-slate-800 resize-none outline-none focus:ring-0 font-serif\"\r\n                        rows={6}\r\n                        placeholder=\"[Perspective B text will appear here...]\"\r\n                    />\r\n                </div>\r\n\r\n                {/* THE ENTANGLED TOOL */}\r\n                <div className=\"my-12 -mx-6 p-6 bg-slate-50 border-y border-slate-200 shadow-inner font-sans not-prose\">\r\n                    <div className=\"flex items-center justify-between mb-6\">\r\n                        <div>\r\n                            <h3 className=\"text-lg font-bold text-indigo-900 flex items-center gap-2\">\r\n                                <Sparkles className=\"h-5 w-5 text-indigo-600\" />\r\n                                Interactive Instrument: Cultural Hole Detector\r\n                            </h3>\r\n                            <p className=\"text-sm text-slate-600 max-w-xl\">\r\n                                To operationalize the sociomaterial method, we embed the analytic instrument directly into the text.\r\n                                Click below to perform a live structural hole analysis on the entered paragraphs.\r\n                            </p>\r\n                        </div>\r\n                        {!hasRun && (\r\n                            <Button\r\n                                onClick={() => handleAnalyze(false)}\r\n                                size=\"lg\"\r\n                                disabled={isAnalyzing || !paragraph1 || !paragraph2}\r\n                                className=\"bg-indigo-600 hover:bg-indigo-700 text-white shadow-md transform transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                            >\r\n                                {isAnalyzing ? \"Analyzing Text...\" : \"Run Detector\"}\r\n                                {!isAnalyzing && <ArrowRight className=\"ml-2 h-4 w-4\" />}\r\n                            </Button>\r\n                        )}\r\n                        {hasRun && (\r\n                            <div className=\"flex gap-2\">\r\n                                <Button\r\n                                    onClick={() => handleAnalyze(false)}\r\n                                    variant=\"outline\"\r\n                                    size=\"sm\"\r\n                                    disabled={isAnalyzing}\r\n                                >\r\n                                    Rerun\r\n                                </Button>\r\n                                <Button\r\n                                    onClick={() => handleAnalyze(true)}\r\n                                    variant=\"destructive\"\r\n                                    size=\"sm\"\r\n                                    disabled={isAnalyzing}\r\n                                    title=\"Force fresh analysis (ignores cache)\"\r\n                                >\r\n                                    <RotateCcw className=\"mr-2 h-3 w-3\" />\r\n                                    Force Refresh\r\n                                </Button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Rendering the Analysis Component Inline */}\r\n                    {/* {(hasRun || isAnalyzing) && (\r\n                        <div className=\"animate-in fade-in slide-in-from-bottom-4 duration-700\">\r\n                            <CulturalHolesAnalysis\r\n                                culturalHoles={analysisResult}\r\n                                isAnalyzingHoles={isAnalyzing}\r\n                                onAnalyze={handleAnalyze}\r\n                            />\r\n                            <div className=\"mt-4 text-xs text-center text-slate-400 font-mono\">\r\n                                Fig 3.1: Live generation of structural holes between the provided textual artifacts.\r\n                            </div>\r\n                        </div>\r\n                    )} */}\r\n                    <div className=\"p-8 text-center text-slate-500 border border-dashed border-slate-300 rounded-lg\">\r\n                        <p className=\"text-sm\">Cultural Holes Analysis component temporarily disabled.</p>\r\n                    </div>\r\n                </div>\r\n            </article>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\settings\\prompts\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":9,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4265,4268],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4265,4268],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":227,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":227,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":236,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9601,9604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9601,9604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":248,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[10117,10185],"text":"Fine-tune the AI&apos;s instructions to better fit your research context."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[10117,10185],"text":"Fine-tune the AI&lsquo;s instructions to better fit your research context."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[10117,10185],"text":"Fine-tune the AI&#39;s instructions to better fit your research context."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[10117,10185],"text":"Fine-tune the AI&rsquo;s instructions to better fit your research context."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Loader2, RotateCcw, Save, AlertCircle, Play, Sparkles } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { PromptDefinition } from \"@/lib/prompts/registry\";\r\n\r\ninterface PromptWithState extends PromptDefinition {\r\n    currentValue: string;\r\n    isModified: boolean;\r\n    testInput: string;\r\n    testOutput: string;\r\n    isTesting: boolean;\r\n}\r\n\r\nconst PromptEditor = ({ value, onChange }: { value: string, onChange: (val: string) => void }) => {\r\n    const textareaRef = React.useRef<HTMLTextAreaElement>(null);\r\n    const backdropRef = React.useRef<HTMLDivElement>(null);\r\n\r\n    const handleScroll = () => {\r\n        if (backdropRef.current && textareaRef.current) {\r\n            backdropRef.current.scrollTop = textareaRef.current.scrollTop;\r\n        }\r\n    };\r\n\r\n    // Simple parser to highlight \"Output Format\" section\r\n    const renderHighlights = () => {\r\n        // Regex to match \"Output Format\" section with various header styles (##, ###, ===, or just text)\r\n        // Captures until next section (##, ===, ---) or end of string\r\n        const regex = /((?:^|\\n)(?:##+|={3,})?\\s*Output\\s*Format[\\s\\S]*?)(?=$|\\n(?:##+|={3,}|---))/i;\r\n        const match = value.match(regex);\r\n\r\n        if (!match || match.index === undefined) {\r\n            return <span>{value}</span>;\r\n        }\r\n\r\n        const start = match.index;\r\n        const end = start + match[0].length;\r\n        const before = value.substring(0, start);\r\n        const danger = value.substring(start, end);\r\n        const after = value.substring(end);\r\n\r\n        return (\r\n            <>\r\n                <span>{before}</span>\r\n                <span className=\"bg-red-50 text-red-600 font-bold decoration-red-200\">{danger}</span>\r\n                <span>{after}</span>\r\n            </>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative text-sm font-mono leading-relaxed h-[400px] border rounded-md border-input focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2\">\r\n            {/* Backdrop Layer */}\r\n            <div\r\n                ref={backdropRef}\r\n                className=\"absolute inset-0 p-3 whitespace-pre-wrap break-words overflow-hidden pointer-events-none bg-white text-slate-900\"\r\n                aria-hidden=\"true\"\r\n            >\r\n                {renderHighlights()}\r\n                {/* Extra character to prevent jumpiness on trailing newlines */}\r\n                {value.endsWith('\\n') && <br />}\r\n            </div>\r\n\r\n            {/* Editable Layer */}\r\n            <textarea\r\n                ref={textareaRef}\r\n                value={value}\r\n                onChange={(e) => onChange(e.target.value)}\r\n                onScroll={handleScroll}\r\n                className=\"relative z-10 w-full h-full p-3 bg-transparent text-transparent caret-zinc-950 resize-none focus:outline-none rounded-md overflow-y-auto selection:bg-indigo-100 selection:text-transparent\"\r\n                spellCheck={false}\r\n            />\r\n        </div>\r\n    )\r\n};\r\n\r\nexport default function PromptSettingsPage() {\r\n    const [prompts, setPrompts] = useState<PromptWithState[]>([]);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n    const [editValue, setEditValue] = useState(\"\");\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    useEffect(() => {\r\n        fetchPrompts();\r\n    }, []);\r\n\r\n    const fetchPrompts = async () => {\r\n        setIsLoading(true);\r\n        try {\r\n            const headers: HeadersInit = {};\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const res = await fetch('/api/prompts', { headers });\r\n            const data = await res.json();\r\n            if (data.prompts) {\r\n                setPrompts(data.prompts.map((p: any) => ({\r\n                    ...p,\r\n                    testInput: \"\",\r\n                    testOutput: \"\",\r\n                    isTesting: false\r\n                })));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to load prompts:\", error);\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleEdit = (prompt: PromptWithState) => {\r\n        setEditingId(prompt.id);\r\n        setEditValue(prompt.currentValue);\r\n    };\r\n\r\n    const handleCancel = () => {\r\n        setEditingId(null);\r\n        setEditValue(\"\");\r\n    };\r\n\r\n    const handleSave = async (id: string) => {\r\n        setIsSaving(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            await fetch('/api/prompts', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({ id, value: editValue })\r\n            });\r\n            await fetchPrompts();\r\n            setEditingId(null);\r\n        } catch (error) {\r\n            console.error(\"Failed to save prompt:\", error);\r\n            alert(\"Failed to save changes.\");\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleReset = async (id: string) => {\r\n        if (!confirm(\"Reset this prompt to its system default?\")) return;\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            await fetch('/api/prompts', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({ id, action: 'reset' })\r\n            });\r\n            await fetchPrompts();\r\n            if (editingId === id) {\r\n                setEditingId(null);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to reset prompt:\", error);\r\n            alert(\"Failed to reset prompt.\");\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const updatePromptState = (id: string, updates: Partial<PromptWithState>) => {\r\n        setPrompts(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p));\r\n    };\r\n\r\n    const handleTest = async (prompt: PromptWithState) => {\r\n        updatePromptState(prompt.id, { isTesting: true, testOutput: \"\" });\r\n\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            // use editValue if we are currently editing this specific prompt, otherwise use the stored value\r\n            const systemPromptToTest = (editingId === prompt.id) ? editValue : prompt.currentValue;\r\n\r\n            const res = await fetch('/api/prompts/test', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({\r\n                    systemPrompt: systemPromptToTest,\r\n                    userContent: prompt.testInput\r\n                })\r\n            });\r\n            const data = await res.json();\r\n\r\n            if (data.success) {\r\n                let finalOutput = data.result;\r\n\r\n                // VALIDATION LOGIC\r\n                if (prompt.outputSchema?.format === 'json') {\r\n                    try {\r\n                        // 1. Check for valid JSON\r\n                        // Sometimes models wrap JSON in markdown code blocks, strip them if present\r\n                        const cleanJson = finalOutput.replace(/```json\\n?|```/g, '').trim();\r\n                        const parsed = JSON.parse(cleanJson);\r\n\r\n                        // 2. Check for required keys\r\n                        if (prompt.outputSchema.requiredKeys) {\r\n                            const missingKeys = prompt.outputSchema.requiredKeys.filter(k => !(k in parsed));\r\n                            if (missingKeys.length > 0) {\r\n                                finalOutput = `âš ï¸ VALIDATION ERROR: Missing required JSON keys: ${missingKeys.join(', ')}\\n\\n` + finalOutput;\r\n                            } else {\r\n                                // Formatting for prettier display if valid\r\n                                finalOutput = JSON.stringify(parsed, null, 2);\r\n                            }\r\n                        } else {\r\n                            finalOutput = JSON.stringify(parsed, null, 2);\r\n                        }\r\n                    } catch (e) {\r\n                        finalOutput = `âŒ CRITICAL ERROR: Output is NOT valid JSON.\\n\\n${finalOutput}`;\r\n                    }\r\n                }\r\n\r\n                updatePromptState(prompt.id, { testOutput: finalOutput });\r\n            } else {\r\n                updatePromptState(prompt.id, { testOutput: `Error: ${data.error}` });\r\n            }\r\n        } catch (error: any) {\r\n            updatePromptState(prompt.id, { testOutput: `Error: ${error.message}` });\r\n        } finally {\r\n            updatePromptState(prompt.id, { isTesting: false });\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"container mx-auto py-10 max-w-4xl\">\r\n            <div className=\"flex items-center justify-between mb-8\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-bold text-slate-900\">Prompt Customization</h1>\r\n                    <p className=\"text-slate-500\">Fine-tune the AI's instructions to better fit your research context.</p>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            {isLoading ? (\r\n                <div className=\"flex justify-center p-12\">\r\n                    <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n                </div>\r\n            ) : (\r\n                <div className=\"grid gap-6\">\r\n                    {prompts.map(prompt => (\r\n                        <Card key={prompt.id} className={`transition-all ${editingId === prompt.id ? 'ring-2 ring-indigo-500 border-indigo-500 shadow-md' : ''}`}>\r\n                            <CardHeader className=\"pb-3\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <CardTitle className=\"text-lg font-semibold\">{prompt.name}</CardTitle>\r\n                                        {prompt.isModified && (\r\n                                            <Badge variant=\"secondary\" className=\"bg-amber-100 text-amber-700 hover:bg-amber-100\">\r\n                                                Customized\r\n                                            </Badge>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"flex gap-2\">\r\n                                        {editingId === prompt.id ? (\r\n                                            <>\r\n                                                <Button variant=\"ghost\" size=\"sm\" onClick={handleCancel} disabled={isSaving}>Cancel</Button>\r\n                                                <Button size=\"sm\" onClick={() => handleSave(prompt.id)} disabled={isSaving}>\r\n                                                    {isSaving ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : <Save className=\"h-4 w-4 mr-2\" />}\r\n                                                    Save Changes\r\n                                                </Button>\r\n                                            </>\r\n                                        ) : (\r\n                                            <>\r\n                                                {prompt.isModified && (\r\n                                                    <Button variant=\"outline\" size=\"sm\" onClick={() => handleReset(prompt.id)} title=\"Restore Default\">\r\n                                                        <RotateCcw className=\"h-4 w-4 mr-2\" />\r\n                                                        Reset\r\n                                                    </Button>\r\n                                                )}\r\n                                                <Button variant=\"outline\" size=\"sm\" onClick={() => handleEdit(prompt)}>\r\n                                                    Edit Prompt\r\n                                                </Button>\r\n                                            </>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* Test Playground */}\r\n                                    <div className=\"mt-6 pt-6 border-t border-slate-200\">\r\n                                        <h3 className=\"text-sm font-semibold text-slate-800 mb-3 flex items-center gap-2\">\r\n                                            <Sparkles className=\"h-4 w-4 text-indigo-500\" />\r\n                                            Test Playground\r\n                                        </h3>\r\n                                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                            <div>\r\n                                                <label className=\"text-xs font-medium text-slate-500 mb-1 block\">Sample Input</label>\r\n                                                <Textarea\r\n                                                    placeholder=\"Paste a snippet of text to test...\"\r\n                                                    value={prompt.testInput}\r\n                                                    onChange={(e) => updatePromptState(prompt.id, { testInput: e.target.value })}\r\n                                                    className=\"h-40 font-mono text-xs\"\r\n                                                />\r\n                                                <Button\r\n                                                    onClick={() => handleTest(prompt)}\r\n                                                    disabled={prompt.isTesting || !prompt.testInput?.trim()}\r\n                                                    className=\"mt-2 w-full\"\r\n                                                    size=\"sm\"\r\n                                                    variant=\"secondary\"\r\n                                                >\r\n                                                    {prompt.isTesting ? <Loader2 className=\"h-3 w-3 animate-spin mr-2\" /> : <Play className=\"h-3 w-3 mr-2\" />}\r\n                                                    Run Test\r\n                                                </Button>\r\n                                            </div>\r\n                                            <div>\r\n                                                <label className=\"text-xs font-medium text-slate-500 mb-1 block\">AI Output</label>\r\n                                                <div className=\"h-40 bg-slate-50 rounded-md border p-3 overflow-y-auto text-xs font-mono whitespace-pre-wrap\">\r\n                                                    {prompt.testOutput || <span className=\"text-slate-400 italic\">Output will appear here...</span>}\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                <CardDescription>{prompt.description}</CardDescription>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                {editingId === prompt.id ? (\r\n                                    <div>\r\n                                        <PromptEditor\r\n                                            value={editValue}\r\n                                            onChange={(val) => setEditValue(val)}\r\n                                        />\r\n                                        <div className=\"mt-2 text-xs text-slate-500 flex flex-col gap-1\">\r\n                                            <div className=\"flex items-center gap-1\">\r\n                                                <AlertCircle className=\"h-3 w-3\" />\r\n                                                Variables like <code>`{\"${text}\"}`</code> or <code>`{\"${actors}\"}`</code> must be preserved for the prompt to work.\r\n                                            </div>\r\n                                            {prompt.outputSchema && (\r\n                                                <div className=\"flex items-center gap-1 text-amber-600 font-medium\">\r\n                                                    <AlertCircle className=\"h-3 w-3\" />\r\n                                                    Warning: Do NOT change the JSON output keys or structure, or the visualization will break.\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"bg-slate-50 p-4 rounded-md border text-sm font-mono text-slate-600 whitespace-pre-wrap max-h-[200px] overflow-y-auto hover:max-h-[500px] transition-all duration-300\">\r\n                                        {prompt.currentValue}\r\n                                    </div>\r\n                                )}\r\n                            </CardContent>\r\n                        </Card>\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\sign-up\\[[...sign-up]]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\synthesis\\page.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":524,"column":87,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[32333,32334],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[32333,32334],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[32333,32334],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[32333,32334],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":524,"column":100,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[32346,32347],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[32346,32347],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[32346,32347],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[32346,32347],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":543,"column":68,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[33301,33337],"text":"Systemic Critique (Devil&apos;s Advocate)"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[33301,33337],"text":"Systemic Critique (Devil&lsquo;s Advocate)"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[33301,33337],"text":"Systemic Critique (Devil&#39;s Advocate)"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[33301,33337],"text":"Systemic Critique (Devil&rsquo;s Advocate)"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useSources } from \"@/hooks/useSources\";\r\nimport { useServerStorage } from \"@/hooks/useServerStorage\";\r\nimport { Source, EcosystemImpact } from \"@/types\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { GitMerge, GitPullRequest, AlertCircle, FileDown, CheckCircle2, Sparkles, Brain, Network, Loader2, RefreshCw } from \"lucide-react\";\r\nimport { generateSynthesisPDF } from \"@/utils/generateSynthesisPDF\";\r\nimport { AssemblageSankey } from \"@/components/AssemblageSankey\";\r\nimport { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Legend, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } from \"recharts\";\r\nimport { Info } from \"lucide-react\";\r\n\r\nimport { SynthesisComparisonResult as ComparisonResult } from \"@/types/synthesis\";\r\n\r\nconst SYNTHESIS_FINDINGS = [\r\n    {\r\n        key: \"risk\",\r\n        dimension: \"Risk Classification\",\r\n        convergence: \"Comparison of risk definitions and tiered obligations across frameworks.\",\r\n        divergence: \"Analysis of how risk categories are adapted to local social and political contexts.\",\r\n        coloniality: \"Examination of whether risk models reflect Global North assumptions or local realities.\",\r\n        resistance: \"Identification of mechanisms that allow for local adaptation of risk frameworks.\",\r\n        icon: AlertCircle,\r\n    },\r\n    {\r\n        key: \"governance\",\r\n        dimension: \"Governance Structure\",\r\n        convergence: \"Comparison of institutional designs (e.g., centralized vs. networked authorities).\",\r\n        divergence: \"Analysis of enforcement powers and coordination mechanisms.\",\r\n        coloniality: \"Assessment of whether governance models assume state capacities that may not exist.\",\r\n        resistance: \"Highlighting of innovative governance structures that leverage local expertise.\",\r\n        icon: GitMerge,\r\n    },\r\n    {\r\n        key: \"rights\",\r\n        dimension: \"Rights Framework\",\r\n        convergence: \"Comparison of individual rights (e.g., explanation, redress) and collective protections.\",\r\n        divergence: \"Analysis of the balance between procedural compliance and substantive rights.\",\r\n        coloniality: \"Examination of whether rights frameworks obscure underlying power asymmetries.\",\r\n        resistance: \"Identification of rights-based approaches that empower affected communities.\",\r\n        icon: CheckCircle2,\r\n    },\r\n    {\r\n        key: \"scope\",\r\n        dimension: \"Territorial Scope\",\r\n        convergence: \"Comparison of jurisdictional reach and extraterritorial application.\",\r\n        divergence: \"Analysis of data sovereignty claims and market power dynamics.\",\r\n        coloniality: \"Assessment of the 'Brussels Effect' and the imposition of external legal norms.\",\r\n        resistance: \"Highlighting of assertions of epistemic and legal autonomy.\",\r\n        icon: GitPullRequest,\r\n    },\r\n];\r\n\r\nexport default function SynthesisPage() {\r\n    const { sources, isLoading } = useSources();\r\n    const [isExporting, setIsExporting] = useState(false);\r\n\r\n    // Comparison State\r\n    const [sourceA, setSourceA] = useState<Source | null>(null);\r\n    const [sourceB, setSourceB] = useState<Source | null>(null);\r\n    const [isComparing, setIsComparing] = useState(false);\r\n    const [comparisonResult, setComparisonResult] = useServerStorage<ComparisonResult | null>(\"synthesis_comparison_result\", null);\r\n\r\n    // Ecosystem State\r\n    const [selectedEcosystemSourceId, setSelectedEcosystemSourceId] = useServerStorage<string | null>(\"synthesis_ecosystem_source_id\", null);\r\n    const ecosystemSource = sources.find(s => s.id === selectedEcosystemSourceId) || null;\r\n\r\n    const [isMapping, setIsMapping] = useState(false);\r\n    const [ecosystemImpacts, setEcosystemImpacts] = useServerStorage<EcosystemImpact[]>(\"synthesis_ecosystem_impacts\", []);\r\n    const [interconnectionFilter, setInterconnectionFilter] = useState<\"All\" | \"Material\" | \"Discursive\" | \"Hybrid\" | \"Interpretive / Meaning-Making\">(\"All\");\r\n    const [viewMode, setViewMode] = useState<\"list\" | \"graph\">(\"list\");\r\n    const [chartView, setChartView] = useState<\"radar\" | \"bar\">(\"radar\");\r\n    const [showGuide, setShowGuide] = useState(true);\r\n\r\n    // Filter sources that have text available for analysis\r\n    const analyzedSources = sources.filter(s => s.analysis || s.extractedText);\r\n\r\n    const handleExport = () => {\r\n        if (!comparisonResult) {\r\n            alert(\"Please run a comparison first to generate a report.\");\r\n            return;\r\n        }\r\n\r\n        setIsExporting(true);\r\n        try {\r\n            // Transform comparisonResult into the format expected by generateSynthesisPDF\r\n            const findings = Object.entries(comparisonResult).map(([key, value]) => {\r\n                const typedValue = value as ComparisonResult[\"risk\"]; // All keys have same structure\r\n                const findingDef = SYNTHESIS_FINDINGS.find(f => f.key === key);\r\n                return {\r\n                    dimension: findingDef?.dimension || key,\r\n                    convergence: typedValue.convergence,\r\n                    divergence: typedValue.divergence,\r\n                    coloniality: typedValue.coloniality,\r\n                    resistance: typedValue.resistance\r\n                };\r\n            });\r\n\r\n            generateSynthesisPDF(findings);\r\n        } catch (error) {\r\n            console.error(\"Error generating PDF:\", error);\r\n            alert(\"Failed to generate PDF. Please try again.\");\r\n        } finally {\r\n            setTimeout(() => setIsExporting(false), 1000);\r\n        }\r\n    };\r\n\r\n    const handleCompare = async (forceRefresh = false) => {\r\n        if (!sourceA || !sourceB) return;\r\n\r\n        setIsComparing(true);\r\n        // setComparisonResult(null); // Keep previous result while loading so button stays visible\r\n\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    analysisMode: 'comparison',\r\n                    sourceA: { title: sourceA.title, text: sourceA.extractedText?.substring(0, 15000) || '' },\r\n                    sourceB: { title: sourceB.title, text: sourceB.extractedText?.substring(0, 15000) || '' },\r\n                    force: forceRefresh\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success && data.analysis) {\r\n                setComparisonResult(data.analysis);\r\n            } else {\r\n                alert(\"Comparison failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Comparison error:\", error);\r\n            alert(\"Failed to generate comparison.\");\r\n        } finally {\r\n            setIsComparing(false);\r\n        }\r\n    };\r\n\r\n    const handleEcosystemMap = async () => {\r\n        if (!ecosystemSource) return;\r\n\r\n        // Check for existing results\r\n        if (ecosystemImpacts.length > 0) {\r\n            const confirmRun = confirm(\"Existing ecosystem map found. Do you want to re-run it? This will overwrite the current map.\");\r\n            if (!confirmRun) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        setIsMapping(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    text: ecosystemSource.extractedText?.substring(0, 30000) || '',\r\n                    sourceType: 'Policy Document',\r\n                    analysisMode: 'ecosystem'\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success && Array.isArray(data.analysis)) {\r\n                setEcosystemImpacts(data.analysis);\r\n            } else {\r\n                alert(\"Mapping failed: \" + (data.error || \"Unknown error\"));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Mapping error:\", error);\r\n            alert(\"Failed to generate ecosystem map.\");\r\n        } finally {\r\n            setIsMapping(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8\">\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <h2 className=\"text-3xl font-bold tracking-tight text-slate-900\">Cross-Case Analysis</h2>\r\n                    <p className=\"text-slate-500\">Comparative analysis of AI governance frameworks using the Decolonial Situatedness Framework.</p>\r\n                </div>\r\n                <Button\r\n                    onClick={handleExport}\r\n                    className=\"bg-slate-900 text-white hover:bg-slate-800\"\r\n                    disabled={isExporting}\r\n                >\r\n                    <FileDown className=\"mr-2 h-4 w-4\" />\r\n                    {isExporting ? \"Generating PDF...\" : \"Export Report\"}\r\n                </Button>\r\n            </div>\r\n\r\n            <Card className=\"bg-gradient-to-br from-slate-50 to-blue-50 border-slate-200\">\r\n                <CardHeader>\r\n                    <CardTitle>Executive Summary</CardTitle>\r\n                    <CardDescription>Key insights from the comparative analysis</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-3 text-sm text-slate-700 leading-relaxed\">\r\n                    <p>\r\n                        This synthesis compares AI governance frameworks to identify patterns of convergence, divergence, and coloniality. By applying the Decolonial Situatedness Framework, we analyze how different jurisdictions approach risk, governance, rights, and territorial scope.\r\n                    </p>\r\n                    <p>\r\n                        <strong>Convergence:</strong> Identification of shared regulatory mechanisms, definitions, and risk classifications across frameworks.\r\n                    </p>\r\n                    <p>\r\n                        <strong>Divergence:</strong> Analysis of distinct approaches to enforcement, rights protections, and institutional design that reflect local contexts.\r\n                    </p>\r\n                    <p>\r\n                        <strong>Colonial Patterns:</strong> Examination of potential legal transplants, extraterritorial effects, and the imposition of Global North epistemologies.\r\n                    </p>\r\n                    <p>\r\n                        <strong>Decolonial Potential:</strong> Highlighting opportunities for epistemic autonomy, local adaptation, and resistance to hegemonic norms.\r\n                    </p>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* AI-Powered Comparison */}\r\n            {analyzedSources.length >= 2 && (\r\n                <Card className=\"border-purple-200\">\r\n                    <CardHeader>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Brain className=\"h-5 w-5 text-purple-600\" />\r\n                            <CardTitle>AI-Powered Framework Comparison</CardTitle>\r\n                        </div>\r\n                        <CardDescription>\r\n                            Compare two policy documents to identify convergence, divergence, and colonial patterns\r\n                        </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-700\">Source A</label>\r\n                                <select\r\n                                    className=\"w-full p-2 border rounded-md text-sm\"\r\n                                    value={sourceA?.id || \"\"}\r\n                                    onChange={(e) => {\r\n                                        const source = analyzedSources.find(s => s.id === e.target.value);\r\n                                        setSourceA(source || null);\r\n                                    }}\r\n                                >\r\n                                    <option value=\"\">Select first document...</option>\r\n                                    {analyzedSources.map(s => (\r\n                                        <option key={s.id} value={s.id}>{s.title}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium text-slate-700\">Source B</label>\r\n                                <select\r\n                                    className=\"w-full p-2 border rounded-md text-sm\"\r\n                                    value={sourceB?.id || \"\"}\r\n                                    onChange={(e) => {\r\n                                        const source = analyzedSources.find(s => s.id === e.target.value);\r\n                                        setSourceB(source || null);\r\n                                    }}\r\n                                >\r\n                                    <option value=\"\">Select second document...</option>\r\n                                    {analyzedSources.map(s => (\r\n                                        <option key={s.id} value={s.id}>{s.title}</option>\r\n                                    ))}\r\n                                </select>\r\n                            </div>\r\n                        </div >\r\n                        <div className=\"flex gap-2\">\r\n                            <div className=\"flex flex-col gap-2 w-full\">\r\n                                <Button\r\n                                    onClick={() => handleCompare(false)}\r\n                                    disabled={!sourceA || !sourceB || isComparing}\r\n                                    className=\"w-full bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                    title={(!sourceA || !sourceB) ? \"Please select two documents to compare\" : \"Run comparison\"}\r\n                                >\r\n                                    {isComparing ? (\r\n                                        <>\r\n                                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                            Analyzing...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                            Compare Frameworks\r\n                                        </>\r\n                                    )}\r\n                                </Button>\r\n                                {(!sourceA || !sourceB) && (\r\n                                    <p className=\"text-xs text-center text-slate-500\">\r\n                                        Select two documents above to enable comparison.\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                            {comparisonResult && (\r\n                                <Button\r\n                                    onClick={() => handleCompare(true)}\r\n                                    disabled={isComparing}\r\n                                    variant=\"outline\"\r\n                                    title=\"Force Regenerate (Bypass Cache)\"\r\n                                    className=\"shrink-0\"\r\n                                >\r\n                                    <RefreshCw className={`mr-2 h-4 w-4 ${isComparing ? 'animate-spin' : ''}`} />\r\n                                    Regenerate\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n\r\n                        {comparisonResult && (\r\n                            <div className=\"mt-8 space-y-6 pt-4 border-t\">\r\n                                <div className=\"h-[450px] w-full\">\r\n                                    <h4 className=\"font-semibold text-slate-900 mb-2 text-center\">Shape of Divergence</h4>\r\n                                    <p className=\"text-xs text-center text-slate-500 mb-4\">\r\n                                        Comparing: <span className=\"font-medium text-slate-700\">{sourceA?.title}</span> vs <span className=\"font-medium text-slate-700\">{sourceB?.title}</span>\r\n                                    </p>\r\n\r\n                                    <div className=\"flex justify-center mb-4 space-x-2\">\r\n                                        <button\r\n                                            onClick={() => setChartView(\"radar\")}\r\n                                            className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${chartView === \"radar\"\r\n                                                ? \"bg-slate-900 text-white\"\r\n                                                : \"bg-slate-100 text-slate-600 hover:bg-slate-200\"\r\n                                                }`}\r\n                                        >\r\n                                            Radar View\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={() => setChartView(\"bar\")}\r\n                                            className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${chartView === \"bar\"\r\n                                                ? \"bg-slate-900 text-white\"\r\n                                                : \"bg-slate-100 text-slate-600 hover:bg-slate-200\"\r\n                                                }`}\r\n                                        >\r\n                                            Bar View\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {showGuide && (\r\n                                        <div className=\"mb-6 mx-auto max-w-2xl bg-blue-50 border border-blue-100 rounded-lg p-3 relative\">\r\n                                            <button\r\n                                                onClick={() => setShowGuide(false)}\r\n                                                className=\"absolute top-2 right-2 text-blue-400 hover:text-blue-600\"\r\n                                            >\r\n                                                Ã—\r\n                                            </button>\r\n                                            <div className=\"flex gap-3\">\r\n                                                <Info className=\"h-5 w-5 text-blue-600 shrink-0\" />\r\n                                                <div className=\"text-xs text-blue-900 space-y-1\">\r\n                                                    <p className=\"font-semibold\">How to read this chart:</p>\r\n                                                    <p><span className=\"font-bold text-blue-700\">Convergence (Blue):</span> How similar the frameworks are. High score = Very similar rules/definitions.</p>\r\n                                                    <p><span className=\"font-bold text-red-700\">Coloniality (Red):</span> Power imbalance. High score = One framework is imposing values on the other.</p>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <ResponsiveContainer width=\"100%\" height={300}>\r\n                                        {chartView === \"radar\" ? (\r\n                                            <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={[\r\n                                                { subject: 'Risk', A: comparisonResult?.risk?.convergence_score || 0, B: comparisonResult?.risk?.coloniality_score || 0, fullMark: 10 },\r\n                                                { subject: 'Governance', A: comparisonResult?.governance?.convergence_score || 0, B: comparisonResult?.governance?.coloniality_score || 0, fullMark: 10 },\r\n                                                { subject: 'Rights', A: comparisonResult?.rights?.convergence_score || 0, B: comparisonResult?.rights?.coloniality_score || 0, fullMark: 10 },\r\n                                                { subject: 'Scope', A: comparisonResult?.scope?.convergence_score || 0, B: comparisonResult?.scope?.coloniality_score || 0, fullMark: 10 },\r\n                                            ]}>\r\n                                                <PolarGrid />\r\n                                                <PolarAngleAxis dataKey=\"subject\" />\r\n                                                <PolarRadiusAxis angle={30} domain={[0, 10]} />\r\n                                                <Tooltip />\r\n                                                <Radar name=\"Convergence (Similarity)\" dataKey=\"A\" stroke=\"#2563eb\" fill=\"#2563eb\" fillOpacity={0.5} />\r\n                                                <Radar name=\"Coloniality (Power Imbalance)\" dataKey=\"B\" stroke=\"#dc2626\" fill=\"#dc2626\" fillOpacity={0.5} />\r\n                                                <Legend />\r\n                                            </RadarChart>\r\n                                        ) : (\r\n                                            <BarChart\r\n                                                data={[\r\n                                                    { subject: 'Risk', Convergence: comparisonResult?.risk?.convergence_score || 0, Coloniality: comparisonResult?.risk?.coloniality_score || 0 },\r\n                                                    { subject: 'Governance', Convergence: comparisonResult?.governance?.convergence_score || 0, Coloniality: comparisonResult?.governance?.coloniality_score || 0 },\r\n                                                    { subject: 'Rights', Convergence: comparisonResult?.rights?.convergence_score || 0, Coloniality: comparisonResult?.rights?.coloniality_score || 0 },\r\n                                                    { subject: 'Scope', Convergence: comparisonResult?.scope?.convergence_score || 0, Coloniality: comparisonResult?.scope?.coloniality_score || 0 },\r\n                                                ]}\r\n                                                margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\r\n                                            >\r\n                                                <CartesianGrid strokeDasharray=\"3 3\" />\r\n                                                <XAxis dataKey=\"subject\" />\r\n                                                <YAxis domain={[0, 10]} />\r\n                                                <Tooltip />\r\n                                                <Legend />\r\n                                                <Bar dataKey=\"Convergence\" fill=\"#2563eb\" name=\"Convergence (Similarity)\" />\r\n                                                <Bar dataKey=\"Coloniality\" fill=\"#dc2626\" name=\"Coloniality (Power Imbalance)\" />\r\n                                            </BarChart>\r\n                                        )}\r\n                                    </ResponsiveContainer>\r\n                                    <p className=\"text-xs text-center text-slate-400 mt-4\">\r\n                                        Scale 0-10: Higher scores indicate stronger presence of the attribute.\r\n                                    </p>\r\n                                </div >\r\n\r\n\r\n                            </div >\r\n                        )}\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n            {/* Synthesis Matrix */}\r\n            <div>\r\n                <h3 className=\"text-xl font-semibold text-slate-900 mb-4\">Synthesis Framework</h3>\r\n\r\n                {comparisonResult ? (\r\n                    // Show AI-generated comparison results\r\n                    <div className=\"grid gap-4\">\r\n                        {Object.entries(comparisonResult)\r\n                            .filter(([key]) => key !== 'verified_quotes' && key !== 'system_critique')\r\n                            .map(([key, value]) => {\r\n                                const typedValue = value as ComparisonResult[\"risk\"];\r\n                                const finding = SYNTHESIS_FINDINGS.find(f => f.key === key);\r\n                                const Icon = finding?.icon || AlertCircle;\r\n                                return (\r\n                                    <Card key={key}>\r\n                                        <CardHeader>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <Icon className=\"h-5 w-5 text-slate-600\" />\r\n                                                <CardTitle>{finding?.dimension || key}</CardTitle>\r\n                                            </div>\r\n                                        </CardHeader>\r\n                                        <CardContent className=\"space-y-3\">\r\n                                            <div className=\"p-3 bg-green-50 rounded-lg border border-green-200\">\r\n                                                <p className=\"text-xs font-bold text-green-700 uppercase mb-1\">Convergence</p>\r\n                                                <p className=\"text-sm text-slate-700\">{typedValue.convergence}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                                                <p className=\"text-xs font-bold text-blue-700 uppercase mb-1\">Divergence</p>\r\n                                                <p className=\"text-sm text-slate-700\">{typedValue.divergence}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-red-50 rounded-lg border border-red-200\">\r\n                                                <p className=\"text-xs font-bold text-red-700 uppercase mb-1\">Coloniality</p>\r\n                                                <p className=\"text-sm text-slate-700\">{typedValue.coloniality}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-purple-50 rounded-lg border border-purple-200\">\r\n                                                <p className=\"text-xs font-bold text-purple-700 uppercase mb-1\">Resistance</p>\r\n                                                <p className=\"text-sm text-slate-700\">{typedValue.resistance}</p>\r\n                                            </div>\r\n                                        </CardContent>\r\n                                    </Card>\r\n                                );\r\n                            })}\r\n                    </div>\r\n                ) : (\r\n                    // Show placeholder framework when no comparison is active\r\n                    <>\r\n                        <div className=\"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\r\n                            <p className=\"text-sm text-blue-900\">\r\n                                <strong>Note:</strong> To see AI-generated synthesis results, use the &quot;AI-Powered Framework Comparison&quot; tool above to compare two policy documents.\r\n                            </p>\r\n                        </div>\r\n                        <div className=\"grid gap-4\">\r\n                            {SYNTHESIS_FINDINGS.map((finding) => {\r\n                                const Icon = finding.icon;\r\n                                return (\r\n                                    <Card key={finding.key} className=\"opacity-60\">\r\n                                        <CardHeader>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <Icon className=\"h-5 w-5 text-slate-600\" />\r\n                                                <CardTitle>{finding.dimension}</CardTitle>\r\n                                            </div>\r\n                                        </CardHeader>\r\n                                        <CardContent className=\"space-y-3\">\r\n                                            <div className=\"p-3 bg-green-50 rounded-lg border border-green-200\">\r\n                                                <p className=\"text-xs font-bold text-green-700 uppercase mb-1\">Convergence</p>\r\n                                                <p className=\"text-sm text-slate-700\">{finding.convergence}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                                                <p className=\"text-xs font-bold text-blue-700 uppercase mb-1\">Divergence</p>\r\n                                                <p className=\"text-sm text-slate-700\">{finding.divergence}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-red-50 rounded-lg border border-red-200\">\r\n                                                <p className=\"text-xs font-bold text-red-700 uppercase mb-1\">Coloniality</p>\r\n                                                <p className=\"text-sm text-slate-700\">{finding.coloniality}</p>\r\n                                            </div>\r\n                                            <div className=\"p-3 bg-purple-50 rounded-lg border border-purple-200\">\r\n                                                <p className=\"text-xs font-bold text-purple-700 uppercase mb-1\">Resistance</p>\r\n                                                <p className=\"text-sm text-slate-700\">{finding.resistance}</p>\r\n                                            </div>\r\n                                        </CardContent>\r\n                                    </Card>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n\r\n            {/* Verified Quotes Section */}\r\n            {\r\n                comparisonResult?.verified_quotes && comparisonResult.verified_quotes.length > 0 && (\r\n                    <Card className=\"border-blue-200 bg-blue-50/50\">\r\n                        <CardHeader>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <CheckCircle2 className=\"h-5 w-5 text-blue-600\" />\r\n                                <CardTitle>Verified Canonical Evidence</CardTitle>\r\n                            </div>\r\n                            <CardDescription>Direct textual evidence supporting the analysis</CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-4\">\r\n                            {comparisonResult.verified_quotes.map((quote, idx) => (\r\n                                <div key={idx} className=\"p-3 bg-white rounded border border-blue-100 shadow-sm\">\r\n                                    <p className=\"text-sm italic text-slate-700 mb-2\">\"{quote.text}\"</p>\r\n                                    <div className=\"flex justify-between items-center text-xs\">\r\n                                        <span className=\"font-semibold text-blue-800\">{quote.source}</span>\r\n                                        <span className=\"text-slate-500\">{quote.relevance}</span>\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </CardContent>\r\n                    </Card>\r\n                )\r\n            }\r\n\r\n            {/* System Critique Section */}\r\n            {\r\n                comparisonResult?.system_critique && (\r\n                    <Card className=\"border-purple-200 bg-purple-50/50\">\r\n                        <CardHeader>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Brain className=\"h-5 w-5 text-purple-600\" />\r\n                                <CardTitle>Systemic Critique (Devil's Advocate)</CardTitle>\r\n                            </div>\r\n                            <CardDescription>Synthesized critical analysis and blind-spot detection</CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-4\">\r\n                            {typeof comparisonResult.system_critique === 'string' ? (\r\n                                <p className=\"text-sm text-slate-800 leading-relaxed whitespace-pre-wrap\">\r\n                                    {comparisonResult.system_critique}\r\n                                </p>\r\n                            ) : (\r\n                                <>\r\n                                    {/* Blind Spots */}\r\n                                    {comparisonResult.system_critique.blind_spots && comparisonResult.system_critique.blind_spots.length > 0 && (\r\n                                        <div className=\"p-3 bg-red-50 rounded-md border border-red-100\">\r\n                                            <p className=\"text-xs font-bold text-red-800 uppercase mb-2\">Potential Blind Spots</p>\r\n                                            <ul className=\"list-disc list-inside space-y-1\">\r\n                                                {comparisonResult.system_critique.blind_spots.map((spot, idx) => (\r\n                                                    <li key={idx} className=\"text-sm text-red-900\">{spot}</li>\r\n                                                ))}\r\n                                            </ul>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Over Interpretation */}\r\n                                    {comparisonResult.system_critique.over_interpretation && (\r\n                                        <div className=\"p-3 bg-amber-50 rounded-md border border-amber-100\">\r\n                                            <p className=\"text-xs font-bold text-amber-800 uppercase mb-1\">Over-Interpretation Check</p>\r\n                                            <p className=\"text-sm text-amber-900\">{comparisonResult.system_critique.over_interpretation}</p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Legitimacy Correction */}\r\n                                    {comparisonResult.system_critique.legitimacy_correction && (\r\n                                        <div className=\"p-3 bg-blue-50 rounded-md border border-blue-100\">\r\n                                            <p className=\"text-xs font-bold text-blue-800 uppercase mb-1\">Legitimacy Correction</p>\r\n                                            <p className=\"text-sm text-blue-900\">{comparisonResult.system_critique.legitimacy_correction}</p>\r\n                                        </div>\r\n                                    )}\r\n                                </>\r\n                            )}\r\n                        </CardContent>\r\n                    </Card>\r\n                )\r\n            }\r\n\r\n\r\n            {/* Ecosystem Impact Mapping */}\r\n            {\r\n                analyzedSources.length > 0 && (\r\n                    <Card className=\"border-teal-200\">\r\n                        <CardHeader>\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Network className=\"h-5 w-5 text-teal-600\" />\r\n                                <CardTitle>Ecosystem Impact Mapping</CardTitle>\r\n                            </div>\r\n                            <CardDescription>\r\n                                Map how policy mechanisms constrain or afford possibilities for ecosystem actors\r\n                            </CardDescription>\r\n                        </CardHeader>\r\n                        <CardContent className=\"space-y-4\">\r\n                            <div className=\"flex gap-4 items-end\">\r\n                                <div className=\"flex-1 space-y-2\">\r\n                                    <label className=\"text-sm font-medium text-slate-700\">Select Policy Document</label>\r\n                                    <select\r\n                                        className=\"w-full p-2 border rounded-md text-sm\"\r\n                                        value={selectedEcosystemSourceId || \"\"}\r\n                                        onChange={(e) => {\r\n                                            setSelectedEcosystemSourceId(e.target.value || null);\r\n                                        }}\r\n                                    >\r\n                                        <option value=\"\">Select document...</option>\r\n                                        {analyzedSources.map(s => (\r\n                                            <option key={s.id} value={s.id}>{s.title}</option>\r\n                                        ))}\r\n                                    </select>\r\n                                </div>\r\n                                <Button\r\n                                    className=\"bg-teal-600 text-white hover:bg-teal-700\"\r\n                                    onClick={handleEcosystemMap}\r\n                                    disabled={!ecosystemSource || isMapping}\r\n                                >\r\n                                    {isMapping ? (\r\n                                        <>\r\n                                            <Sparkles className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                            Mapping...\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <Network className=\"mr-2 h-4 w-4\" />\r\n                                            Generate Map\r\n                                        </>\r\n                                    )}\r\n                                </Button>\r\n                            </div>\r\n\r\n                            {ecosystemImpacts.length > 0 && (\r\n                                <div className=\"mt-4 space-y-3 pt-4 border-t\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <h4 className=\"font-semibold text-slate-900\">Ecosystem Impacts</h4>\r\n                                        <div className=\"flex gap-2\">\r\n                                            <div className=\"flex bg-slate-100 rounded-lg p-1 mr-4\">\r\n                                                <button\r\n                                                    onClick={() => setViewMode(\"list\")}\r\n                                                    className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${viewMode === \"list\"\r\n                                                        ? \"bg-white text-slate-900 shadow-sm\"\r\n                                                        : \"text-slate-500 hover:text-slate-900\"\r\n                                                        }`}\r\n                                                >\r\n                                                    List View\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => setViewMode(\"graph\")}\r\n                                                    className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${viewMode === \"graph\"\r\n                                                        ? \"bg-white text-slate-900 shadow-sm\"\r\n                                                        : \"text-slate-500 hover:text-slate-900\"\r\n                                                        }`}\r\n                                                >\r\n                                                    Graph View\r\n                                                </button>\r\n                                            </div>\r\n\r\n                                            <Button\r\n                                                variant={interconnectionFilter === \"All\" ? \"default\" : \"outline\"}\r\n                                                size=\"sm\"\r\n                                                onClick={() => setInterconnectionFilter(\"All\")}\r\n                                            >\r\n                                                All\r\n                                            </Button>\r\n                                            <Button\r\n                                                variant={interconnectionFilter === \"Material\" ? \"default\" : \"outline\"}\r\n                                                size=\"sm\"\r\n                                                onClick={() => setInterconnectionFilter(\"Material\")}\r\n                                            >\r\n                                                Material\r\n                                            </Button>\r\n                                            <Button\r\n                                                variant={interconnectionFilter === \"Discursive\" ? \"default\" : \"outline\"}\r\n                                                size=\"sm\"\r\n                                                onClick={() => setInterconnectionFilter(\"Discursive\")}\r\n                                            >\r\n                                                Discursive\r\n                                            </Button>\r\n                                            <Button\r\n                                                variant={interconnectionFilter === \"Hybrid\" ? \"default\" : \"outline\"}\r\n                                                size=\"sm\"\r\n                                                onClick={() => setInterconnectionFilter(\"Hybrid\")}\r\n                                            >\r\n                                                Hybrid\r\n                                            </Button>\r\n                                            <Button\r\n                                                variant={interconnectionFilter === \"Interpretive / Meaning-Making\" ? \"default\" : \"outline\"}\r\n                                                size=\"sm\"\r\n                                                onClick={() => setInterconnectionFilter(\"Interpretive / Meaning-Making\")}\r\n                                            >\r\n                                                Interpretive\r\n                                            </Button>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {viewMode === \"graph\" ? (\r\n                                        <div className=\"border rounded-lg p-4 bg-white min-h-[500px]\">\r\n                                            <AssemblageSankey\r\n                                                data={ecosystemImpacts.filter(impact =>\r\n                                                    interconnectionFilter === \"All\" ||\r\n                                                    impact.interconnection_type === interconnectionFilter\r\n                                                )}\r\n                                            />\r\n                                            <p className=\"text-center text-xs text-slate-500 mt-4\">\r\n                                                Visualizing the flow from <strong>Actors</strong> â†’ <strong>Mechanisms</strong> â†’ <strong>Impacts</strong>\r\n                                            </p>\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"grid gap-3\">\r\n                                            {ecosystemImpacts\r\n                                                .filter(impact =>\r\n                                                    interconnectionFilter === \"All\" ||\r\n                                                    impact.interconnection_type === interconnectionFilter\r\n                                                )\r\n                                                .map((impact, i) => (\r\n                                                    <div key={i} className={`p-3 rounded-lg border ${impact.type === \"Constraint\"\r\n                                                        ? \"bg-red-50 border-red-200\"\r\n                                                        : \"bg-green-50 border-green-200\"\r\n                                                        }`}>\r\n                                                        <div className=\"flex items-start justify-between mb-2\">\r\n                                                            <span className={`text-xs font-bold uppercase ${impact.type === \"Constraint\" ? \"text-red-700\" : \"text-green-700\"\r\n                                                                }`}>\r\n                                                                {impact.type}\r\n                                                            </span>\r\n                                                            {impact.interconnection_type && (\r\n                                                                <Badge variant=\"outline\" className=\"text-xs\">\r\n                                                                    {impact.interconnection_type}\r\n                                                                </Badge>\r\n                                                            )}\r\n                                                        </div>\r\n                                                        <p className=\"text-sm font-semibold text-slate-900 mb-1\">{impact.actor}</p>\r\n                                                        <p className=\"text-xs text-slate-600 mb-1\">\r\n                                                            <span className=\"font-medium\">Mechanism:</span> {impact.mechanism}\r\n                                                        </p>\r\n                                                        <p className=\"text-xs text-slate-600\">\r\n                                                            <span className=\"font-medium\">Impact:</span> {impact.impact}\r\n                                                        </p>\r\n                                                    </div>\r\n                                                ))}\r\n                                        </div>\r\n                                    )\r\n                                    }\r\n                                </div >\r\n                            )}\r\n                        </CardContent >\r\n                    </Card >\r\n                )\r\n            }\r\n\r\n\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\app\\timeline\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\AnalysisResults.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\AssemblageSankey.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":58,"column":17,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":58,"endColumn":30,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1971,1984],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5539,5542],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5539,5542],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7357,7360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7357,7360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useMemo, useRef } from \"react\";\r\nimport { ResponsiveContainer, Sankey, Tooltip, Layer, Rectangle } from \"recharts\";\r\nimport { EcosystemImpact } from \"@/types\";\r\n\r\ninterface AssemblageSankeyProps {\r\n    data: EcosystemImpact[];\r\n    height?: number;\r\n}\r\n\r\nexport function AssemblageSankey({ data, height = 500 }: AssemblageSankeyProps) {\r\n    const chartData = useMemo(() => {\r\n        const nodes: { name: string }[] = [];\r\n        const links: { source: number; target: number; value: number; type?: string }[] = [];\r\n\r\n        const nodeMap = new Map<string, number>();\r\n\r\n        const getNodeIndex = (name: string) => {\r\n            if (!nodeMap.has(name)) {\r\n                nodeMap.set(name, nodes.length);\r\n                nodes.push({ name });\r\n            }\r\n            return nodeMap.get(name)!;\r\n        };\r\n\r\n        data.forEach(item => {\r\n            if (!item.actor || !item.mechanism || !item.impact) return;\r\n\r\n            const actorIdx = getNodeIndex(item.actor);\r\n            const mechanismIdx = getNodeIndex(item.mechanism);\r\n            const impactIdx = getNodeIndex(item.impact);\r\n\r\n            // Link: Actor -> Mechanism\r\n            links.push({\r\n                source: actorIdx,\r\n                target: mechanismIdx,\r\n                value: 1,\r\n                type: item.type\r\n            });\r\n\r\n            // Link: Mechanism -> Impact\r\n            links.push({\r\n                source: mechanismIdx,\r\n                target: impactIdx,\r\n                value: 1,\r\n                type: item.type\r\n            });\r\n        });\r\n\r\n        // Aggregate identical links\r\n        const uniqueLinksMap = new Map<string, { source: number; target: number; value: number; type: string }>();\r\n        links.forEach(link => {\r\n            const key = `${link.source}-${link.target}`;\r\n            if (uniqueLinksMap.has(key)) {\r\n                uniqueLinksMap.get(key)!.value += 1;\r\n            } else {\r\n                // @ts-ignore\r\n                uniqueLinksMap.set(key, { ...link });\r\n            }\r\n        });\r\n\r\n        return {\r\n            nodes,\r\n            links: Array.from(uniqueLinksMap.values())\r\n        };\r\n    }, [data]);\r\n\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n    const handleDownload = () => {\r\n        if (!containerRef.current) return;\r\n\r\n        const svgElement = containerRef.current.querySelector('svg');\r\n        if (!svgElement) {\r\n            console.error(\"SVG element not found\");\r\n            return;\r\n        }\r\n\r\n        // Get SVG data\r\n        const serializer = new XMLSerializer();\r\n        const svgString = serializer.serializeToString(svgElement);\r\n        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });\r\n        const url = URL.createObjectURL(svgBlob);\r\n\r\n        // Create image and draw to canvas\r\n        const img = new Image();\r\n        img.onload = () => {\r\n            const canvas = document.createElement('canvas');\r\n            // Use the actual SVG dimensions or the container dimensions\r\n            const width = svgElement.clientWidth || 800;\r\n            const height = svgElement.clientHeight || 500;\r\n\r\n            // Scale up for better resolution\r\n            const scale = 2;\r\n            canvas.width = width * scale;\r\n            canvas.height = height * scale;\r\n\r\n            const ctx = canvas.getContext('2d');\r\n            if (!ctx) return;\r\n\r\n            // Fill white background\r\n            ctx.fillStyle = '#ffffff';\r\n            ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n            ctx.scale(scale, scale);\r\n            ctx.drawImage(img, 0, 0);\r\n\r\n            // Trigger download\r\n            const pngUrl = canvas.toDataURL('image/png');\r\n            const downloadLink = document.createElement('a');\r\n            downloadLink.href = pngUrl;\r\n            downloadLink.download = 'assemblage-sankey.png';\r\n            document.body.appendChild(downloadLink);\r\n            downloadLink.click();\r\n            document.body.removeChild(downloadLink);\r\n\r\n            URL.revokeObjectURL(url);\r\n        };\r\n        img.src = url;\r\n    };\r\n\r\n    if (data.length === 0) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-full text-slate-400 text-sm\">\r\n                No data available for visualization\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{ width: '100%', height }} className=\"relative\" ref={containerRef}>\r\n            <div className=\"absolute top-0 right-0 z-10\">\r\n                <button\r\n                    onClick={handleDownload}\r\n                    className=\"bg-white/80 hover:bg-white border border-slate-200 text-slate-600 text-xs font-medium px-2 py-1 rounded shadow-sm backdrop-blur-sm transition-colors\"\r\n                    title=\"Download as PNG\"\r\n                >\r\n                    Download PNG\r\n                </button>\r\n            </div>\r\n\r\n            {/* Column Headers */}\r\n            <div className=\"flex justify-between px-4 mb-2 text-sm font-bold text-slate-700 uppercase tracking-wider border-b pb-2\">\r\n                <div className=\"w-1/3 text-left\">Actors</div>\r\n                <div className=\"w-1/3 text-center\">Mechanisms</div>\r\n                <div className=\"w-1/3 text-right pr-40\">Impacts</div>\r\n            </div>\r\n\r\n            <ResponsiveContainer>\r\n                <Sankey\r\n                    data={chartData}\r\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                    node={(props: any) => {\r\n                        const { x, y, width, height, index, payload, containerWidth } = props;\r\n                        const isOut = x + width + 6 > (containerWidth || 500) / 2;\r\n\r\n                        // Determine color based on node type or connection\r\n                        const fill = \"#3b82f6\";\r\n\r\n                        // Truncate text if it's too long\r\n                        const truncateText = (text: string, maxLength: number) => {\r\n                            if (!text) return \"\";\r\n                            if (text.length <= maxLength) return text;\r\n                            return text.slice(0, maxLength) + '...';\r\n                        };\r\n\r\n                        return (\r\n                            <Layer key={`CustomNode${index}`}>\r\n                                <Rectangle x={x} y={y} width={width} height={height} fill={fill} fillOpacity=\"1\" />\r\n                                <text\r\n                                    textAnchor={isOut ? 'end' : 'start'}\r\n                                    x={isOut ? x - 6 : x + width + 6}\r\n                                    y={y + height / 2}\r\n                                    fontSize=\"11\"\r\n                                    stroke=\"none\"\r\n                                    fill=\"#1e293b\"\r\n                                    dy=\"0.355em\"\r\n                                    fontWeight=\"500\"\r\n                                >\r\n                                    {truncateText(payload.name, 35)}\r\n                                </text>\r\n                                <title>{payload.name}</title>\r\n                            </Layer>\r\n                        );\r\n                    }}\r\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                    link={(props: any) => {\r\n                        const { sourceX, sourceY, targetX, targetY, linkWidth, payload } = props;\r\n                        // Color links based on the \"type\" of the impact\r\n                        const isConstraint = payload.type === \"Constraint\";\r\n                        const color = isConstraint ? \"#fca5a5\" : \"#86efac\"; // Red-300 for constraint, Green-300 for affordance\r\n                        const opacity = 0.6;\r\n\r\n                        return (\r\n                            <path\r\n                                d={`\r\n                                     M${sourceX},${sourceY + linkWidth / 2}\r\n                                     C${sourceX + 100},${sourceY + linkWidth / 2}\r\n                                     ${targetX - 100},${targetY + linkWidth / 2}\r\n                                     ${targetX},${targetY + linkWidth / 2}\r\n                                     L${targetX},${targetY - linkWidth / 2}\r\n                                     C${targetX - 100},${targetY - linkWidth / 2}\r\n                                     ${sourceX + 100},${sourceY - linkWidth / 2}\r\n                                     ${sourceX},${sourceY - linkWidth / 2}\r\n                                     Z\r\n                                 `}\r\n                                fill={color}\r\n                                fillOpacity={opacity}\r\n                                stroke={isConstraint ? \"#ef4444\" : \"#22c55e\"}\r\n                                strokeWidth={1}\r\n                                strokeOpacity={0.2}\r\n                            />\r\n                        );\r\n                    }}\r\n                    nodePadding={50}\r\n                    margin={{\r\n                        left: 20,\r\n                        right: 160,\r\n                        top: 20,\r\n                        bottom: 20,\r\n                    }}\r\n                >\r\n                    <Tooltip />\r\n                </Sankey>\r\n            </ResponsiveContainer>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\CulturalHoleCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":103,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":106,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[818,821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[818,821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2854,2857],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2854,2857],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5233,5236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5233,5236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport { CulturalHole, BridgingConcept } from \"@/types/cultural\";\r\nimport { Lightbulb, ArrowRight, FileText } from \"lucide-react\";\r\nimport { EvidenceLineageModal } from \"@/components/reflexivity/EvidenceLineageModal\";\r\n\r\ninterface CulturalHoleCardProps {\r\n    hole: CulturalHole;\r\n    clusters: Array<{ id: string; name: string; themes: string[]; description?: string }>;\r\n}\r\n\r\nexport function CulturalHoleCard({ hole, clusters }: CulturalHoleCardProps) {\r\n    const [activeEvidence, setActiveEvidence] = React.useState<{ title: string; type: string; quotes: any[] } | null>(null);\r\n\r\n    const clusterA = clusters.find((c) => c.name === hole.clusterA);\r\n    const clusterB = clusters.find((c) => c.name === hole.clusterB);\r\n\r\n    if (!clusterA || !clusterB) return null;\r\n\r\n    // Color code by distance (gap size)\r\n    const gapColor =\r\n        hole.distance > 0.7\r\n            ? \"bg-red-50 border-red-200\"\r\n            : hole.distance > 0.5\r\n                ? \"bg-orange-50 border-orange-200\"\r\n                : \"bg-yellow-50 border-yellow-200\";\r\n\r\n    const badgeColor =\r\n        hole.distance > 0.7\r\n            ? \"bg-red-100 text-red-700\"\r\n            : hole.distance > 0.5\r\n                ? \"bg-orange-100 text-orange-700\"\r\n                : \"bg-yellow-100 text-yellow-700\";\r\n\r\n    return (\r\n        <React.Fragment>\r\n            <Card className={`${gapColor} border-2`}>\r\n                <CardHeader className=\"pb-3\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <CardTitle className=\"text-base font-semibold text-slate-900\">\r\n                            Cultural Hole Detected\r\n                        </CardTitle>\r\n                        <Badge className={badgeColor}>\r\n                            Gap: {(hole.distance * 100).toFixed(0)}%\r\n                        </Badge>\r\n                    </div>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                    {/* Cluster Comparison */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3 items-center\">\r\n                        <div\r\n                            className=\"bg-white p-3 rounded-md border border-slate-200 cursor-pointer hover:border-indigo-300 transition-colors group\"\r\n                            onClick={() => setActiveEvidence({\r\n                                title: clusterA.name,\r\n                                type: \"Discourse Cluster\",\r\n                                // Map existing quotes or create dummy if structure varies\r\n                                quotes: (clusterA as any).quotes || []\r\n                            })}\r\n                        >\r\n                            <span className=\"text-xs font-bold text-slate-600 uppercase block mb-1 flex items-center gap-1 group-hover:text-indigo-600\">\r\n                                Cluster A <FileText className=\"h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                            </span>\r\n                            <TooltipProvider>\r\n                                <Tooltip>\r\n                                    <TooltipTrigger asChild>\r\n                                        <p className=\"text-sm font-semibold text-slate-900 mb-2 cursor-help underline decoration-dotted\">\r\n                                            {clusterA.name}\r\n                                        </p>\r\n                                    </TooltipTrigger>\r\n                                    {clusterA.description && (\r\n                                        <TooltipContent className=\"max-w-xs bg-white\">\r\n                                            <p className=\"text-xs text-slate-700\">{clusterA.description}</p>\r\n                                        </TooltipContent>\r\n                                    )}\r\n                                </Tooltip>\r\n                            </TooltipProvider>\r\n                            <div className=\"flex flex-wrap gap-1\">\r\n                                {clusterA.themes.filter(theme => theme !== clusterA.name).slice(0, 3).map((theme, i) => (\r\n                                    <Badge key={i} variant=\"outline\" className=\"text-xs\">\r\n                                        {theme}\r\n                                    </Badge>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex justify-center\">\r\n                            <ArrowRight className=\"h-6 w-6 text-slate-400\" />\r\n                        </div>\r\n\r\n                        <div\r\n                            className=\"bg-white p-3 rounded-md border border-slate-200 cursor-pointer hover:border-indigo-300 transition-colors group\"\r\n                            onClick={() => setActiveEvidence({\r\n                                title: clusterB.name,\r\n                                type: \"Discourse Cluster\",\r\n                                quotes: (clusterB as any).quotes || []\r\n                            })}\r\n                        >\r\n                            <span className=\"text-xs font-bold text-slate-600 uppercase block mb-1 flex items-center gap-1 group-hover:text-indigo-600\">\r\n                                Cluster B <FileText className=\"h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                            </span>\r\n                            <TooltipProvider>\r\n                                <Tooltip>\r\n                                    <TooltipTrigger asChild>\r\n                                        <p className=\"text-sm font-semibold text-slate-900 mb-2 cursor-help underline decoration-dotted\">\r\n                                            {clusterB.name}\r\n                                        </p>\r\n                                    </TooltipTrigger>\r\n                                    {clusterB.description && (\r\n                                        <TooltipContent className=\"max-w-xs bg-white\">\r\n                                            <p className=\"text-xs text-slate-700\">{clusterB.description}</p>\r\n                                        </TooltipContent>\r\n                                    )}\r\n                                </Tooltip>\r\n                            </TooltipProvider>\r\n                            <div className=\"flex flex-wrap gap-1\">\r\n                                {clusterB.themes.filter(theme => theme !== clusterB.name).slice(0, 3).map((theme, i) => (\r\n                                    <Badge key={i} variant=\"outline\" className=\"text-xs\">\r\n                                        {theme}\r\n                                    </Badge>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Bridging Concepts */}\r\n                    {hole.bridgingConcepts.length > 0 && (\r\n                        <div className=\"bg-white p-3 rounded-md border border-slate-200\">\r\n                            <div className=\"flex items-center gap-2 mb-2\">\r\n                                <Lightbulb className=\"h-4 w-4 text-amber-600\" />\r\n                                <span className=\"text-xs font-bold text-amber-700 uppercase\">\r\n                                    Bridging Concepts\r\n                                </span>\r\n                            </div>\r\n                            <div className=\"flex flex-wrap gap-2\">\r\n                                {hole.bridgingConcepts.map((bc: BridgingConcept, i: number) => (\r\n                                    <TooltipProvider key={i}>\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <Badge\r\n                                                    className=\"bg-amber-100 text-amber-800 border-amber-300 cursor-help\"\r\n                                                >\r\n                                                    {bc.concept}\r\n                                                </Badge>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent className=\"max-w-xs bg-white\">\r\n                                                <p className=\"text-xs text-slate-700\">{bc.explanation}</p>\r\n                                            </TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TooltipProvider>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Opportunity */}\r\n                    {hole.opportunity && (\r\n                        <div className=\"bg-blue-50 p-3 rounded-md border border-blue-200\">\r\n                            <span className=\"text-xs font-bold text-blue-700 uppercase block mb-1\">\r\n                                Innovation Opportunity\r\n                            </span>\r\n                            <p className=\"text-sm text-slate-700\">{hole.opportunity}</p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Policy Implication */}\r\n                    {hole.policyImplication && (\r\n                        <div className=\"bg-purple-50 p-3 rounded-md border border-purple-200\">\r\n                            <div className=\"flex items-center gap-2 mb-1\">\r\n                                <FileText className=\"h-4 w-4 text-purple-600\" />\r\n                                <span className=\"text-xs font-bold text-purple-700 uppercase\">\r\n                                    Policy Implication\r\n                                </span>\r\n                            </div>\r\n                            <p className=\"text-sm text-slate-700\">{hole.policyImplication}</p>\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <EvidenceLineageModal\r\n                isOpen={!!activeEvidence}\r\n                onClose={() => setActiveEvidence(null)}\r\n                title={activeEvidence?.title || \"\"}\r\n                description={`Evidence extracted from ${activeEvidence?.quotes.length || 0} textual traces defining this discourse cluster.`}\r\n                quotes={activeEvidence?.quotes || []}\r\n                sourceType=\"Cultural Cluster\"\r\n            />\r\n        </React.Fragment>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\CulturalHoleMatrix.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":110,"column":97,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t &quot;speak to each other\" â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t &ldquo;speak to each other\" â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t &#34;speak to each other\" â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t &rdquo;speak to each other\" â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":110,"column":117,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t \"speak to each other&quot; â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t \"speak to each other&ldquo; â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t \"speak to each other&#34; â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5900,6121],"text":"\r\n                                                            These discourse clusters don&apos;t \"speak to each other&rdquo; â€” they use different language and concepts.\r\n                                                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from \"react\";\r\nimport { DiscourseCluster, CulturalHole, BridgingConcept } from \"@/types/cultural\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\n\r\ninterface CulturalHoleMatrixProps {\r\n    clusters: DiscourseCluster[];\r\n    holes: CulturalHole[];\r\n    onConceptClick?: (concept: BridgingConcept) => void;\r\n}\r\n\r\nexport function CulturalHoleMatrix({ clusters, holes, onConceptClick }: CulturalHoleMatrixProps) {\r\n    if (clusters.length === 0) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-96 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300\">\r\n                <p className=\"text-slate-500\">No cultural analysis data available</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Helper to get hole between two clusters\r\n    const getHole = (nameA: string, nameB: string) => {\r\n        return holes.find(h =>\r\n            (h.clusterA === nameA && h.clusterB === nameB) ||\r\n            (h.clusterA === nameB && h.clusterB === nameA)\r\n        );\r\n    };\r\n\r\n    // Helper to get color based on distance\r\n    const getCellColor = (distance: number) => {\r\n        if (distance < 0.2) return \"bg-slate-50\";\r\n        if (distance < 0.4) return \"bg-red-50\";\r\n        if (distance < 0.6) return \"bg-red-100\";\r\n        if (distance < 0.8) return \"bg-red-200\";\r\n        return \"bg-red-300\";\r\n    };\r\n\r\n    return (\r\n        <div className=\"overflow-x-auto\">\r\n            <div className=\"min-w-[600px] p-2\">\r\n                <div className=\"grid\" style={{\r\n                    gridTemplateColumns: `auto repeat(${clusters.length}, minmax(60px, 1fr))`\r\n                }}>\r\n                    {/* Header Row */}\r\n                    <div className=\"h-16\"></div>\r\n                    {clusters.map((cluster) => (\r\n                        <div key={cluster.id} className=\"relative h-16 border-b border-slate-200\">\r\n                            <div className=\"absolute bottom-2 left-1/2 -translate-x-1/2 w-full text-center transform -rotate-45 origin-bottom text-xs font-medium text-slate-700 px-1 whitespace-nowrap\">\r\n                                {cluster.name}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n\r\n                    {/* Matrix Rows */}\r\n                    {clusters.map((rowCluster, rowIndex) => (\r\n                        <React.Fragment key={rowCluster.id}>\r\n                            {/* Row Header */}\r\n                            <div className=\"flex items-center justify-end pr-2 py-1 border-r border-slate-200\">\r\n                                <span className=\"text-xs font-medium text-slate-700 text-right truncate w-24\">\r\n                                    {rowCluster.name}\r\n                                </span>\r\n                            </div>\r\n\r\n                            {/* Cells */}\r\n                            {clusters.map((colCluster, colIndex) => {\r\n                                const isDiagonal = rowIndex === colIndex;\r\n                                const isLowerTriangle = colIndex < rowIndex;\r\n                                const hole = getHole(rowCluster.name, colCluster.name);\r\n\r\n                                if (isLowerTriangle) {\r\n                                    return (\r\n                                        <div key={`${rowCluster.id}-${colCluster.id}`} className=\"bg-slate-50/50 border border-white h-12\" />\r\n                                    );\r\n                                }\r\n\r\n                                if (isDiagonal) {\r\n                                    return (\r\n                                        <div key={`${rowCluster.id}-${colCluster.id}`} className=\"bg-slate-100 border border-white flex items-center justify-center h-12\">\r\n                                            <span className=\"text-xs font-bold text-slate-400\">\r\n                                                {rowCluster.size}\r\n                                            </span>\r\n                                        </div>\r\n                                    );\r\n                                }\r\n\r\n                                if (!hole) {\r\n                                    return (\r\n                                        <div key={`${rowCluster.id}-${colCluster.id}`} className=\"bg-slate-50 border border-white h-12\" />\r\n                                    );\r\n                                }\r\n\r\n                                return (\r\n                                    <TooltipProvider key={`${rowCluster.id}-${colCluster.id}`}>\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <div\r\n                                                    className={`${getCellColor(hole.distance)} border border-white h-12 flex items-center justify-center cursor-help transition-colors hover:opacity-80`}\r\n                                                >\r\n                                                    <span className=\"text-xs font-medium text-red-900 opacity-50\">\r\n                                                        {(hole.distance * 100).toFixed(0)}%\r\n                                                    </span>\r\n                                                </div>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent className=\"max-w-md bg-white border-slate-200 shadow-lg\">\r\n                                                <div className=\"space-y-3\">\r\n                                                    <div>\r\n                                                        <p className=\"font-bold text-sm text-amber-700\">ðŸ’¡ Cultural Gap Detected</p>\r\n                                                        <p className=\"text-xs text-slate-600 mt-1\">\r\n                                                            These discourse clusters don&apos;t \"speak to each other\" â€” they use different language and concepts.\r\n                                                        </p>\r\n                                                    </div>\r\n\r\n                                                    {/* Cluster Definitions */}\r\n                                                    <div className=\"text-xs space-y-2 bg-slate-50 p-2 rounded border border-slate-100\">\r\n                                                        <div>\r\n                                                            <span className=\"font-semibold text-indigo-700\">Cluster A:</span>{\" \"}\r\n                                                            <span className=\"text-slate-700\">\r\n                                                                {hole.clusterA}\r\n                                                            </span>\r\n                                                            {clusters.find(c => c.name === hole.clusterA)?.description && (\r\n                                                                <p className=\"text-slate-600 italic mt-0.5 pl-2\">\r\n                                                                    {clusters.find(c => c.name === hole.clusterA)?.description}\r\n                                                                </p>\r\n                                                            )}\r\n                                                        </div>\r\n                                                        <div>\r\n                                                            <span className=\"font-semibold text-indigo-700\">Cluster B:</span>{\" \"}\r\n                                                            <span className=\"text-slate-700\">\r\n                                                                {hole.clusterB}\r\n                                                            </span>\r\n                                                            {clusters.find(c => c.name === hole.clusterB)?.description && (\r\n                                                                <p className=\"text-slate-600 italic mt-0.5 pl-2\">\r\n                                                                    {clusters.find(c => c.name === hole.clusterB)?.description}\r\n                                                                </p>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    <div className=\"text-xs space-y-2 border-t border-slate-100 pt-2\">\r\n                                                        <p>\r\n                                                            <span className=\"font-semibold text-slate-700\">Gap Size:</span>{\" \"}\r\n                                                            <span className=\"text-slate-900\">{(hole.distance * 100).toFixed(0)}%</span>\r\n                                                            <span className=\"text-slate-500 ml-1\">\r\n                                                                ({hole.distance > 0.7 ? \"Very Large\" : hole.distance > 0.4 ? \"Moderate\" : \"Small\"})\r\n                                                            </span>\r\n                                                        </p>\r\n\r\n                                                        {/* Bridging Concepts with individual tooltips */}\r\n                                                        <div>\r\n                                                            <p className=\"font-semibold text-slate-700 mb-1\">Bridging Ideas (Click to Draft Policy):</p>\r\n                                                            <div className=\"flex flex-wrap gap-1\">\r\n                                                                {hole.bridgingConcepts.map((bc: BridgingConcept, idx: number) => (\r\n                                                                    <TooltipProvider key={idx}>\r\n                                                                        <Tooltip>\r\n                                                                            <TooltipTrigger asChild>\r\n                                                                                <button\r\n                                                                                    onClick={() => onConceptClick?.(bc)}\r\n                                                                                    className=\"px-2 py-0.5 bg-blue-50 text-blue-700 rounded border border-blue-100 cursor-pointer text-xs hover:bg-blue-100 hover:scale-105 transition-all\"\r\n                                                                                >\r\n                                                                                    {bc.concept}\r\n                                                                                </button>\r\n                                                                            </TooltipTrigger>\r\n                                                                            <TooltipContent className=\"max-w-xs bg-white\">\r\n                                                                                <p className=\"text-xs text-slate-700\">{bc.explanation}</p>\r\n                                                                                <p className=\"text-[10px] text-blue-500 mt-1 font-semibold\">Click to generate policy draft</p>\r\n                                                                            </TooltipContent>\r\n                                                                        </Tooltip>\r\n                                                                    </TooltipProvider>\r\n                                                                ))}\r\n                                                            </div>\r\n                                                        </div>\r\n\r\n                                                        <div className=\"bg-amber-50 p-2 rounded border border-amber-100 mt-2\">\r\n                                                            <p className=\"font-semibold text-amber-900 mb-1\">ðŸŽ¯ Opportunity for Innovation:</p>\r\n                                                            <p className=\"text-slate-700\">{hole.opportunity}</p>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TooltipProvider>\r\n                                );\r\n                            })}\r\n                        </React.Fragment>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Legend */}\r\n                <div className=\"mt-4 flex items-center justify-end gap-4 text-xs text-slate-600\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className=\"w-4 h-4 bg-slate-100 border border-slate-200\"></div>\r\n                        <span>Cluster Size</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className=\"flex\">\r\n                            <div className=\"w-4 h-4 bg-slate-50\"></div>\r\n                            <div className=\"w-4 h-4 bg-red-50\"></div>\r\n                            <div className=\"w-4 h-4 bg-red-100\"></div>\r\n                            <div className=\"w-4 h-4 bg-red-200\"></div>\r\n                            <div className=\"w-4 h-4 bg-red-300\"></div>\r\n                        </div>\r\n                        <span>Gap Distance (Low â†’ High)</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\CulturalHoleNetwork.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ResearchWorkflowGuide.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronRight' is defined but never used.","line":4,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { BookOpen, X, ChevronRight, Database, GitGraph, FileText, Share2 } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nexport function ResearchWorkflowGuide() {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const pathname = usePathname();\r\n\r\n    // Auto-minimize on specific pages if needed, or keep persistent\r\n    // For now, we'll just let the user control it.\r\n\r\n    if (!isOpen) {\r\n        return (\r\n            <button\r\n                onClick={() => setIsOpen(true)}\r\n                className=\"fixed bottom-6 right-6 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-all z-50 flex items-center gap-2\"\r\n                title=\"Open Research Guide\"\r\n            >\r\n                <BookOpen size={20} />\r\n                <span className=\"font-medium text-sm pr-1\">CFP Guide</span>\r\n            </button>\r\n        );\r\n    }\r\n\r\n    const steps = [\r\n        {\r\n            id: 1,\r\n            title: \"Data Collection\",\r\n            icon: <Database size={16} />,\r\n            desc: \"Ingest documents and capture empirical traces.\",\r\n            link: \"/data\",\r\n            active: pathname === \"/data\" || pathname === \"/empirical\"\r\n        },\r\n        {\r\n            id: 2,\r\n            title: \"Micro Analysis\",\r\n            icon: <FileText size={16} />,\r\n            desc: \"Analyze resistance and reflect on positionality.\",\r\n            link: \"/resistance\",\r\n            active: pathname === \"/resistance\" || pathname === \"/reflexivity\"\r\n        },\r\n        {\r\n            id: 3,\r\n            title: \"Meso Analysis\",\r\n            icon: <GitGraph size={16} />,\r\n            desc: \"Map ecosystems and conceptual networks.\",\r\n            link: \"/ecosystem\",\r\n            active: pathname === \"/ecosystem\" || pathname === \"/ontology\"\r\n        },\r\n        {\r\n            id: 4,\r\n            title: \"Macro Analysis\",\r\n            icon: <Share2 size={16} />,\r\n            desc: \"Examine governance structures and cultural framing.\",\r\n            link: \"/governance\",\r\n            active: pathname === \"/governance\" || pathname === \"/cultural\" || pathname === \"/timeline\" || pathname === \"/comparison\"\r\n        },\r\n        {\r\n            id: 5,\r\n            title: \"Synthesis\",\r\n            icon: <BookOpen size={16} />,\r\n            desc: \"Generate reports and visualize the assemblage.\",\r\n            link: \"/synthesis\",\r\n            active: pathname === \"/synthesis\"\r\n        }\r\n    ];\r\n\r\n    return (\r\n        <div className=\"fixed bottom-6 right-6 w-80 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 overflow-hidden flex flex-col animate-in slide-in-from-bottom-5 duration-300\">\r\n            <div className=\"bg-slate-900 text-white p-4 flex justify-between items-start\">\r\n                <div>\r\n                    <h3 className=\"font-bold text-sm flex items-center gap-2\">\r\n                        <BookOpen size={16} className=\"text-blue-400\" />\r\n                        Assemblage AI Guide\r\n                    </h3>\r\n                    <p className=\"text-xs text-slate-400 mt-1\">\r\n                        Critical Analysis Workflow\r\n                    </p>\r\n                </div>\r\n                <button\r\n                    onClick={() => setIsOpen(false)}\r\n                    className=\"text-slate-400 hover:text-white transition-colors\"\r\n                >\r\n                    <X size={16} />\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"p-4 space-y-4 max-h-[60vh] overflow-y-auto\">\r\n                <div className=\"space-y-3\">\r\n                    {steps.map((step) => (\r\n                        <Link\r\n                            key={step.id}\r\n                            href={step.link}\r\n                            className={`block group border rounded-lg p-3 transition-all ${step.active\r\n                                ? \"bg-blue-50 border-blue-200 ring-1 ring-blue-200\"\r\n                                : \"bg-white border-slate-100 hover:border-blue-200 hover:shadow-sm\"\r\n                                }`}\r\n                        >\r\n                            <div className=\"flex items-center justify-between mb-1\">\r\n                                <div className={`flex items-center gap-2 font-semibold text-sm ${step.active ? \"text-blue-700\" : \"text-slate-700\"\r\n                                    }`}>\r\n                                    <span className={`p-1 rounded ${step.active ? \"bg-blue-100\" : \"bg-slate-100 group-hover:bg-blue-50\"\r\n                                        }`}>\r\n                                        {step.icon}\r\n                                    </span>\r\n                                    {step.title}\r\n                                </div>\r\n                                {step.active && <div className=\"w-2 h-2 rounded-full bg-blue-500\"></div>}\r\n                            </div>\r\n                            <p className=\"text-xs text-slate-500 leading-relaxed pl-8\">\r\n                                {step.desc}\r\n                            </p>\r\n                        </Link>\r\n                    ))}\r\n                </div>\r\n\r\n                <div className=\"bg-slate-50 p-3 rounded-lg border border-slate-100\">\r\n                    <h4 className=\"text-xs font-semibold text-slate-700 mb-2\">Current Goal:</h4>\r\n                    <p className=\"text-xs text-slate-600 leading-relaxed\">\r\n                        Begin by uploading your primary policy documents in the <strong>Data Collection</strong> tab to initialize the assemblage analysis.\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\Sidebar.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\Sidebar.tsx:231:9\n  229 |     // Close mobile menu when path changes\n  230 |     useEffect(() => {\n> 231 |         setIsMobileOpen(false);\n      |         ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  232 |     }, [pathname]);\n  233 |\n  234 |     // Handle hydration mismatch","line":231,"column":9,"nodeType":null,"endLine":231,"endColumn":24},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\Sidebar.tsx:237:9\n  235 |     useEffect(() => {\n  236 |         // setIsMounted(true); // Hydration mismatch fix not strictly needed if we just render conditionally\n> 237 |         setIsMounted(true);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  238 |     }, []);\n  239 |\n  240 |     return (","line":237,"column":9,"nodeType":null,"endLine":237,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport {\r\n    LayoutDashboard,\r\n    Database,\r\n    BookOpen,\r\n    Scale,\r\n    Users,\r\n    Scan,\r\n    Network,\r\n    Lightbulb,\r\n    ArrowLeftRight,\r\n    Clock,\r\n    Menu,\r\n    X,\r\n    LucideIcon\r\n} from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport { UserButton } from \"@clerk/nextjs\";\r\n\r\ninterface NavGroup {\r\n    title: string;\r\n    items: {\r\n        name: string;\r\n        href: string;\r\n        icon: LucideIcon;\r\n        description: string;\r\n    }[];\r\n}\r\n\r\nconst NAV_GROUPS: NavGroup[] = [\r\n    {\r\n        title: \"Overview\",\r\n        items: [\r\n            {\r\n                name: \"Dashboard\",\r\n                href: \"/\",\r\n                icon: LayoutDashboard,\r\n                description: \"High-level view of the algorithmic assemblage and research progress.\"\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        title: \"Data Collection\",\r\n        items: [\r\n            {\r\n                name: \"Documents\",\r\n                href: \"/data\",\r\n                icon: Database,\r\n                description: \"Archive of primary policy texts (PDFs) and source materials.\"\r\n            },\r\n            {\r\n                name: \"Trace Provenance\",\r\n                href: \"/empirical\",\r\n                icon: Users,\r\n                description: \"Collect and organize empirical traces from web sources.\"\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        title: \"Agency & Resistance\",\r\n        items: [\r\n            {\r\n                name: \"Resistance\",\r\n                href: \"/resistance\",\r\n                icon: Users,\r\n                description: \"Analyze micro-resistance strategies and counter-conduct.\"\r\n            },\r\n            {\r\n                name: \"Critical Reflection\",\r\n                href: \"/reflexivity\",\r\n                icon: Scan,\r\n                description: \"Examine how your own perspective and context shape the analysis.\"\r\n            },\r\n        ]\r\n    },\r\n    {\r\n        title: \"Assemblage Mapping\",\r\n        items: [\r\n            {\r\n                name: \"Assemblage Compass\",\r\n                href: \"/ecosystem\",\r\n                icon: Network,\r\n                description: \"Trace territories, flows, and coding intensities of the assemblage.\"\r\n            },\r\n            {\r\n                name: \"Cross-Case Analysis\",\r\n                href: \"/synthesis\",\r\n                icon: Network,\r\n                description: \"Cross-case analysis and AI-powered framework comparison.\"\r\n            },\r\n        ]\r\n    },\r\n    {\r\n        title: \"Structural Governance\",\r\n        items: [\r\n            {\r\n                name: \"Comparison\",\r\n                href: \"/comparison\",\r\n                icon: ArrowLeftRight,\r\n                description: \"Side-by-side comparison of governance frameworks.\"\r\n            },\r\n            {\r\n                name: \"Governance\",\r\n                href: \"/governance\",\r\n                icon: Scale,\r\n                description: \"Analyze resource orchestration and institutional logics.\"\r\n            },\r\n            {\r\n                name: \"Cultural Framing\",\r\n                href: \"/cultural\",\r\n                icon: Lightbulb,\r\n                description: \"Examine cultural framing and epistemic authority.\"\r\n            },\r\n            {\r\n                name: \"Concept Network\",\r\n                href: \"/ontology\",\r\n                icon: BookOpen,\r\n                description: \"Visual map of key concepts and their relationships.\"\r\n            },\r\n            {\r\n                name: \"Temporal Dynamics\",\r\n                href: \"/timeline\",\r\n                icon: Clock,\r\n                description: \"Track the evolution of discourse and policy over time.\"\r\n            },\r\n        ]\r\n    },\r\n    {\r\n        title: \"Educational Resources\",\r\n        items: [\r\n            {\r\n                name: \"Critical Glossary\",\r\n                href: \"/glossary\",\r\n                icon: BookOpen,\r\n                description: \"Definitions of key theoretical concepts and terms.\"\r\n            },\r\n            {\r\n                name: \"Literature Review\",\r\n                href: \"/literature\",\r\n                icon: BookOpen,\r\n                description: \"Theoretical framework and key scholarship.\"\r\n            }\r\n        ]\r\n    },\r\n    {\r\n        title: \"Settings\",\r\n        items: [\r\n            {\r\n                name: \"Tune Prompts\",\r\n                href: \"/settings/prompts\",\r\n                icon: Scan,\r\n                description: \"Customize system prompts for analysis and extraction.\"\r\n            }\r\n        ]\r\n    }\r\n];\r\n\r\nfunction SidebarContent({ pathname, isMounted }: { pathname: string; isMounted: boolean }) {\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-white\">\r\n            <div className=\"p-6 border-b border-slate-100\">\r\n                <Link href=\"/\" className=\"flex items-center gap-2\">\r\n                    <div className=\"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center\">\r\n                        <LayoutDashboard className=\"text-white w-5 h-5\" />\r\n                    </div>\r\n                    <span className=\"font-bold text-lg text-slate-900 tracking-tight\">\r\n                        Assemblage<span className=\"text-blue-600\">-AI</span>\r\n                    </span>\r\n                </Link>\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto py-6 px-4 space-y-8\">\r\n                {NAV_GROUPS.map((group, groupIndex) => (\r\n                    <div key={groupIndex}>\r\n                        <h3 className=\"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3 px-2\">\r\n                            {group.title}\r\n                        </h3>\r\n                        <div className=\"space-y-1\">\r\n                            {group.items.map((item) => {\r\n                                const isActive = pathname === item.href;\r\n                                return (\r\n                                    <TooltipProvider key={item.href} delayDuration={0}>\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <Link\r\n                                                    href={item.href}\r\n                                                    className={cn(\r\n                                                        \"flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors\",\r\n                                                        isActive\r\n                                                            ? \"bg-blue-50 text-blue-700\"\r\n                                                            : \"text-slate-600 hover:bg-slate-50 hover:text-slate-900\"\r\n                                                    )}\r\n                                                >\r\n                                                    <item.icon size={18} />\r\n                                                    {item.name}\r\n                                                </Link>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent side=\"right\" className=\"max-w-xs bg-slate-900 text-white border-slate-800 hidden lg:block\">\r\n                                                <p>{item.description}</p>\r\n                                            </TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TooltipProvider>\r\n                                );\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            <div className=\"p-4 border-t border-slate-100 bg-slate-50\">\r\n                <div className=\"flex items-center gap-3 justify-center\">\r\n                    {isMounted && <UserButton showName />}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport function Sidebar() {\r\n    const pathname = usePathname();\r\n    const [isMobileOpen, setIsMobileOpen] = useState(false);\r\n    const [isMounted, setIsMounted] = useState(false);\r\n\r\n    // Close mobile menu when path changes\r\n    useEffect(() => {\r\n        setIsMobileOpen(false);\r\n    }, [pathname]);\r\n\r\n    // Handle hydration mismatch\r\n    useEffect(() => {\r\n        // setIsMounted(true); // Hydration mismatch fix not strictly needed if we just render conditionally\r\n        setIsMounted(true);\r\n    }, []);\r\n\r\n    return (\r\n        <>\r\n            {/* Desktop Sidebar */}\r\n            <div className=\"hidden md:flex w-64 border-r border-slate-200 bg-white flex-col h-full flex-shrink-0\">\r\n                <SidebarContent pathname={pathname} isMounted={isMounted} />\r\n            </div>\r\n\r\n            {/* Mobile Header */}\r\n            <div className=\"md:hidden flex items-center justify-between p-4 bg-white border-b border-slate-200 fixed top-0 left-0 right-0 z-30\">\r\n                <Link href=\"/\" className=\"flex items-center gap-2\">\r\n                    <div className=\"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center\">\r\n                        <LayoutDashboard className=\"text-white w-5 h-5\" />\r\n                    </div>\r\n                    <span className=\"font-bold text-lg text-slate-900 tracking-tight\">\r\n                        Assemblage<span className=\"text-blue-600\">-AI</span>\r\n                    </span>\r\n                </Link>\r\n                <button\r\n                    onClick={() => setIsMobileOpen(true)}\r\n                    className=\"p-2 text-slate-600 hover:bg-slate-100 rounded-md\"\r\n                >\r\n                    <Menu className=\"w-6 h-6\" />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Mobile Drawer Overlay */}\r\n            {isMobileOpen && (\r\n                <div className=\"fixed inset-0 z-50 md:hidden\">\r\n                    {/* Backdrop */}\r\n                    <div\r\n                        className=\"absolute inset-0 bg-black/50 backdrop-blur-sm\"\r\n                        onClick={() => setIsMobileOpen(false)}\r\n                    />\r\n                    {/* Drawer */}\r\n                    <div className=\"absolute top-0 left-0 bottom-0 w-80 bg-white shadow-xl flex flex-col animate-in slide-in-from-left duration-200\">\r\n                        <div className=\"flex justify-end p-4 border-b border-slate-100\">\r\n                            <button\r\n                                onClick={() => setIsMobileOpen(false)}\r\n                                className=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-md\"\r\n                            >\r\n                                <X className=\"w-6 h-6\" />\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"flex-1 overflow-hidden\">\r\n                            <SidebarContent pathname={pathname} isMounted={isMounted} />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\common\\SystemCritiqueSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\comparison\\LensSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ToggleGroup' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ToggleGroupItem' is defined but never used.","line":4,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Spectacles' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from 'react';\r\nimport { ToggleGroup, ToggleGroupItem } from \"@/components/ui/toggle-group\";\r\nimport { Spectacles, TrendingUp, ShieldAlert, Globe } from 'lucide-react';\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nexport type InterpretationLens = \"assemblage\" | \"market\" | \"democratic\" | \"decolonial\";\r\n\r\ninterface LensSelectorProps {\r\n    currentLens: InterpretationLens;\r\n    onLensChange: (lens: InterpretationLens) => void;\r\n}\r\n\r\nexport function LensSelector({ currentLens, onLensChange }: LensSelectorProps) {\r\n    return (\r\n        <div className=\"flex items-center gap-2 p-1 bg-slate-100/80 rounded-lg border border-slate-200 w-fit\">\r\n            <Button\r\n                variant={currentLens === \"assemblage\" ? \"default\" : \"ghost\"}\r\n                size=\"sm\"\r\n                onClick={() => onLensChange(\"assemblage\")}\r\n                className={`h-8 text-xs font-medium gap-1.5 ${currentLens === \"assemblage\" ? \"bg-indigo-600 hover:bg-indigo-700\" : \"text-slate-600\"}`}\r\n            >\r\n                <NetworkIcon className=\"h-3.5 w-3.5\" />\r\n                Relational (Default)\r\n            </Button>\r\n            <Button\r\n                variant={currentLens === \"market\" ? \"default\" : \"ghost\"}\r\n                size=\"sm\"\r\n                onClick={() => onLensChange(\"market\")}\r\n                className={`h-8 text-xs font-medium gap-1.5 ${currentLens === \"market\" ? \"bg-purple-600 hover:bg-purple-700\" : \"text-slate-600\"}`}\r\n            >\r\n                <TrendingUp className=\"h-3.5 w-3.5\" />\r\n                Market/Accel\r\n            </Button>\r\n            <Button\r\n                variant={currentLens === \"democratic\" ? \"default\" : \"ghost\"}\r\n                size=\"sm\"\r\n                onClick={() => onLensChange(\"democratic\")}\r\n                className={`h-8 text-xs font-medium gap-1.5 ${currentLens === \"democratic\" ? \"bg-emerald-600 hover:bg-emerald-700\" : \"text-slate-600\"}`}\r\n            >\r\n                <ShieldAlert className=\"h-3.5 w-3.5\" />\r\n                Prec/Democratic\r\n            </Button>\r\n            <Button\r\n                variant={currentLens === \"decolonial\" ? \"default\" : \"ghost\"}\r\n                size=\"sm\"\r\n                onClick={() => onLensChange(\"decolonial\")}\r\n                className={`h-8 text-xs font-medium gap-1.5 ${currentLens === \"decolonial\" ? \"bg-amber-600 hover:bg-amber-700\" : \"text-slate-600\"}`}\r\n            >\r\n                <Globe className=\"h-3.5 w-3.5\" />\r\n                Decolonial\r\n            </Button>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction NetworkIcon(props: React.SVGProps<SVGSVGElement>) {\r\n    return (\r\n        <svg\r\n            {...props}\r\n            xmlns=\"http://www.w3.org/2000/svg\"\r\n            width=\"24\"\r\n            height=\"24\"\r\n            viewBox=\"0 0 24 24\"\r\n            fill=\"none\"\r\n            stroke=\"currentColor\"\r\n            strokeWidth=\"2\"\r\n            strokeLinecap=\"round\"\r\n            strokeLinejoin=\"round\"\r\n        >\r\n            <rect width=\"7\" height=\"7\" x=\"14\" y=\"3\" rx=\"1\" />\r\n            <path d=\"M10 21V8a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1H3\" />\r\n        </svg>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\comparison\\MutationTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\comparison\\RebuttalPopover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\comparison\\RhizomeNetwork.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'i' is defined but never used.","line":53,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useRef } from 'react';\r\nimport mermaid from 'mermaid';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Network, Download } from 'lucide-react';\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ninterface AssemblageNetwork {\r\n    nodes: string[];\r\n    edges: { from: string; to: string; type: string }[];\r\n}\r\n\r\ninterface RhizomeNetworkProps {\r\n    network: AssemblageNetwork;\r\n}\r\n\r\nexport function RhizomeNetwork({ network }: RhizomeNetworkProps) {\r\n    const chartRef = useRef<HTMLDivElement>(null);\r\n\r\n    useEffect(() => {\r\n        mermaid.initialize({\r\n            startOnLoad: true,\r\n            theme: 'base',\r\n            themeVariables: {\r\n                primaryColor: '#e0e7ff',\r\n                primaryTextColor: '#1e1b4b',\r\n                primaryBorderColor: '#6366f1',\r\n                lineColor: '#64748b',\r\n                secondaryColor: '#f0fdf4',\r\n                tertiaryColor: '#fef2f2',\r\n            },\r\n            flowchart: {\r\n                curve: 'basis'\r\n            }\r\n        });\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (!network || !chartRef.current) return;\r\n\r\n        const renderChart = async () => {\r\n            try {\r\n                // Construct Mermaid definition\r\n                let def = 'graph TD\\n';\r\n\r\n                // Add styling\r\n                def += 'classDef policy fill:#e0e7ff,stroke:#6366f1,stroke-width:2px,color:#1e1b4b;\\n';\r\n                def += 'classDef ancestor fill:#f0fdf4,stroke:#22c55e,stroke-width:1px,color:#15803d;\\n';\r\n                def += 'classDef other fill:#f8fafc,stroke:#94a3b8,stroke-width:1px,color:#475569;\\n';\r\n\r\n                // Add edges\r\n                network.edges.forEach((edge, i) => {\r\n                    const safeFrom = edge.from.replace(/[^a-zA-Z0-9]/g, '_');\r\n                    const safeTo = edge.to.replace(/[^a-zA-Z0-9]/g, '_');\r\n                    // Add labels\r\n                    def += `${safeFrom}[\"${edge.from}\"] -->|\"${edge.type}\"| ${safeTo}[\"${edge.to}\"]\\n`;\r\n                });\r\n\r\n                // Apply classes via heuristic (Basic: ancestors likely roots without incoming)\r\n                // For now, apply policy class to all\r\n                network.nodes.forEach(node => {\r\n                    const safeId = node.replace(/[^a-zA-Z0-9]/g, '_');\r\n                    if (node.includes(\"OECD\") || node.includes(\"GDPR\") || node.includes(\"UNESCO\")) {\r\n                        def += `class ${safeId} ancestor;\\n`;\r\n                    } else {\r\n                        def += `class ${safeId} policy;\\n`;\r\n                    }\r\n                });\r\n\r\n                chartRef.current!.innerHTML = '';\r\n                const { svg } = await mermaid.render(`rhizome-${Date.now()}`, def);\r\n                chartRef.current!.innerHTML = svg;\r\n\r\n            } catch (error) {\r\n                console.error(\"Mermaid render failed:\", error);\r\n                if (chartRef.current) {\r\n                    chartRef.current.innerHTML = '<p class=\"text-sm text-red-500\">Failed to render network graph.</p>';\r\n                }\r\n            }\r\n        };\r\n\r\n        renderChart();\r\n    }, [network]);\r\n\r\n    const handleDownload = () => {\r\n        if (!chartRef.current) return;\r\n        const svgElement = chartRef.current.querySelector('svg');\r\n        if (!svgElement) return;\r\n\r\n        // Serialize SVG\r\n        const serializer = new XMLSerializer();\r\n        const svgString = serializer.serializeToString(svgElement);\r\n\r\n        // Prepare Canvas\r\n        const canvas = document.createElement('canvas');\r\n        const ctx = canvas.getContext('2d');\r\n        const img = new Image();\r\n\r\n        // Get dimensions from SVG or fallback\r\n        const svgWidth = svgElement.viewBox.baseVal.width || 800;\r\n        const svgHeight = svgElement.viewBox.baseVal.height || 600;\r\n\r\n        // Scale up for better resolution\r\n        const scale = 2;\r\n        canvas.width = svgWidth * scale;\r\n        canvas.height = svgHeight * scale;\r\n\r\n        img.onload = () => {\r\n            if (ctx) {\r\n                ctx.fillStyle = 'white';\r\n                ctx.fillRect(0, 0, canvas.width, canvas.height); // White background\r\n                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\r\n                // Trigger Download\r\n                const link = document.createElement('a');\r\n                link.download = `assemblage-rhizome-${Date.now()}.png`;\r\n                link.href = canvas.toDataURL('image/png');\r\n                link.click();\r\n            }\r\n        };\r\n\r\n        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));\r\n    };\r\n\r\n    if (!network || network.nodes.length === 0) return null;\r\n\r\n    return (\r\n        <Card className=\"border-indigo-100 shadow-sm overflow-hidden h-full\">\r\n            <CardHeader className=\"bg-indigo-50/50 pb-3 flex flex-row items-center justify-between\">\r\n                <div className=\"space-y-1.5\">\r\n                    <CardTitle className=\"text-base font-semibold text-indigo-900 flex items-center gap-2\">\r\n                        <Network className=\"h-5 w-5 text-indigo-600\" />\r\n                        Assemblage Rhizome\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                        Tracing shared ancestry and inter-referential citations.\r\n                    </CardDescription>\r\n                </div>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={handleDownload} className=\"gap-2 h-8\">\r\n                    <Download className=\"h-3.5 w-3.5 text-indigo-600\" />\r\n                    Export Map\r\n                </Button>\r\n            </CardHeader>\r\n            <CardContent className=\"p-4 bg-white flex items-center justify-center min-h-[400px] overflow-auto\">\r\n                <div ref={chartRef} className=\"w-full flex justify-center\" />\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\comparison\\StabilizationCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\AbsencePanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":2,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShieldAlert' is defined but never used.","line":5,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":5,"column":83,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":93},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":204,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9182,9217],"text":"\r\n                                &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9182,9217],"text":"\r\n                                &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9182,9217],"text":"\r\n                                &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9182,9217],"text":"\r\n                                &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":204,"column":56,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[9239,9270],"text":"&quot;\r\n                            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[9239,9270],"text":"&ldquo;\r\n                            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[9239,9270],"text":"&#34;\r\n                            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[9239,9270],"text":"&rdquo;\r\n                            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":308,"column":41,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15932,15975],"text":"\r\n                                        &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15932,15975],"text":"\r\n                                        &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15932,15975],"text":"\r\n                                        &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15932,15975],"text":"\r\n                                        &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":308,"column":48,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15978,16020],"text":"...&quot;\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15978,16020],"text":"...&ldquo;\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15978,16020],"text":"...&#34;\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15978,16020],"text":"...&rdquo;\r\n                                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState } from 'react';\r\nimport Link from 'next/link';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { AlertCircle, Clock, ShieldAlert, Users, BrainCircuit, Sparkles, Loader2, ArrowRight, Plus, Ghost } from 'lucide-react';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\n\r\ninterface AbsencePanelProps {\r\n    actors: EcosystemActor[];\r\n    analyzedText?: string;\r\n    onSimulate?: (query: string, source?: \"default\" | \"simulation\" | \"absence_fill\") => Promise<void>;\r\n    topic?: string;\r\n}\r\n\r\nexport interface AiAbsenceAnalysis {\r\n    narrative: string;\r\n    missing_voices: { name: string; reason: string; category: string }[];\r\n    structural_voids: string[];\r\n    blindspot_intensity: \"Low\" | \"Medium\" | \"High\";\r\n}\r\n\r\ninterface AbsencePanelProps {\r\n    actors: EcosystemActor[];\r\n    analyzedText?: string;\r\n    onSimulate?: (query: string, source?: \"default\" | \"simulation\" | \"absence_fill\") => Promise<void>;\r\n    topic?: string;\r\n    savedAnalysis?: AiAbsenceAnalysis | null;\r\n    onSaveAnalysis?: (analysis: AiAbsenceAnalysis) => void;\r\n}\r\n\r\nexport function AbsencePanel({ actors, analyzedText = \"\", onSimulate, topic, savedAnalysis, onSaveAnalysis }: AbsencePanelProps) {\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    // Use savedAnalysis if available, otherwise local state (though local state basically ignored if saved provided)\r\n    const [localAiAnalysis, setLocalAiAnalysis] = useState<AiAbsenceAnalysis | null>(null);\r\n    const aiAnalysis = savedAnalysis !== undefined ? savedAnalysis : localAiAnalysis;\r\n    const [simulatingIndex, setSimulatingIndex] = useState<number | null>(null);\r\n\r\n    const handleDeepScan = async () => {\r\n        setIsAnalyzing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/ecosystem/absence', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({ actors, text: analyzedText })\r\n            });\r\n            const data = await response.json();\r\n            console.log(\"Deep Scan Data Received:\", data); // DEBUG LOG\r\n            if (data.success) {\r\n                if (onSaveAnalysis) {\r\n                    onSaveAnalysis(data.analysis);\r\n                } else {\r\n                    setLocalAiAnalysis(data.analysis);\r\n                }\r\n            } else {\r\n                console.error(\"Deep Scan returned success:false\", data);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Deep Scan failed\", error);\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    const analysis = useMemo(() => {\r\n        const results = {\r\n            missingStakeholders: [] as string[],\r\n            deferredStandards: [] as string[],\r\n            enforcementDependencies: [] as string[]\r\n        };\r\n\r\n        // 1. Missing Stakeholders (Heuristic: Check for common missing groups)\r\n        const commonStakeholders = [\r\n            \"Civil Society\",\r\n            \"Labor Unions\",\r\n            \"Environmental Groups\",\r\n            \"Marginalized Communities\",\r\n            \"Local Government\",\r\n            \"Auditors\"\r\n        ];\r\n\r\n        const presentTypes = new Set(actors.map(a => a.type));\r\n        const presentNames = new Set(actors.map(a => a.name.toLowerCase()));\r\n\r\n        commonStakeholders.forEach(stakeholder => {\r\n            // Check if type matches or name fuzzy matches\r\n            const isPresent = Array.from(presentTypes).some(t => t.toLowerCase() === stakeholder.toLowerCase()) ||\r\n                Array.from(presentNames).some(n => n.includes(stakeholder.toLowerCase()));\r\n\r\n            if (!isPresent) {\r\n                results.missingStakeholders.push(stakeholder);\r\n            }\r\n        });\r\n\r\n        // 2. Deferred Standards (Heuristic: Keywords in text)\r\n        if (analyzedText) {\r\n            const deferredKeywords = [\r\n                \"to be defined\",\r\n                \"future rulemaking\",\r\n                \"voluntary standard\",\r\n                \"industry best practice\",\r\n                \"as appropriate\",\r\n                \"subject to available resources\"\r\n            ];\r\n\r\n            // Simple sentence extraction\r\n            const sentences = analyzedText.split(/[.!?]+/);\r\n            deferredKeywords.forEach(keyword => {\r\n                sentences.forEach(sentence => {\r\n                    if (sentence.toLowerCase().includes(keyword)) {\r\n                        results.deferredStandards.push(sentence.trim());\r\n                    }\r\n                });\r\n            });\r\n\r\n            // 3. Enforcement Dependencies\r\n            const enforcementKeywords = [\r\n                \"upon establishment of\",\r\n                \"contingent on\",\r\n                \"subject to funding\",\r\n                \"capacity building\",\r\n                \"member state discretion\"\r\n            ];\r\n\r\n            enforcementKeywords.forEach(keyword => {\r\n                sentences.forEach(sentence => {\r\n                    if (sentence.toLowerCase().includes(keyword)) {\r\n                        results.enforcementDependencies.push(sentence.trim());\r\n                    }\r\n                });\r\n            });\r\n        }\r\n\r\n        return results;\r\n    }, [actors, analyzedText]);\r\n\r\n    return (\r\n        <Card className=\"h-full border-l-4 border-l-slate-400 bg-slate-50/50 flex flex-col\">\r\n            <CardHeader className=\"pb-2\">\r\n                <CardTitle className=\"text-lg font-semibold flex items-center justify-between text-slate-700\">\r\n\r\n\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Ghost className=\"h-5 w-5 text-indigo-600\" />\r\n                        Voices Silenced & Voids\r\n                    </div>\r\n                </CardTitle>\r\n                <CardDescription>\r\n                    Tracking who is excluded, what is deferred, and whose knowledge is silenced.\r\n                </CardDescription>\r\n\r\n                {/* AI Trigger */}\r\n                <div className=\"pt-2\">\r\n                    <Button\r\n                        size=\"sm\"\r\n                        onClick={handleDeepScan}\r\n                        disabled={isAnalyzing}\r\n                        className={`w-full text-xs font-medium gap-2 transition-all ${aiAnalysis ? \"bg-indigo-100 text-indigo-700 hover:bg-indigo-200 border-indigo-200\" : \"bg-slate-900 text-white hover:bg-slate-800\"}`}\r\n                    >\r\n                        {isAnalyzing ? (\r\n                            <>\r\n                                <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n                                Listening for Silences...\r\n                            </>\r\n                        ) : aiAnalysis ? (\r\n                            <>\r\n                                <BrainCircuit className=\"h-3 w-3\" />\r\n                                Re-Analyze Silences\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Sparkles className=\"h-3 w-3\" />\r\n                                Reveal Silenced Voices\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6 overflow-y-auto flex-1 p-4\">\r\n\r\n                {/* AI Results Section */}\r\n                {aiAnalysis && (\r\n                    <div className=\"space-y-4 border-2 border-indigo-100 rounded-lg p-2 bg-white\">\r\n                        <div className=\"bg-indigo-50 p-3 rounded-lg border border-indigo-100 shadow-sm\">\r\n                            <h4 className=\"text-xs font-bold text-indigo-800 uppercase tracking-wide mb-1 flex items-center justify-between gap-1\">\r\n                                <span className=\"flex items-center gap-1\">\r\n                                    <BrainCircuit className=\"h-3 w-3\" />\r\n                                    Assemblage Critique\r\n                                </span>\r\n                                {aiAnalysis.blindspot_intensity && (\r\n                                    <span className={`text-[10px] px-1.5 py-0.5 rounded-full border ${aiAnalysis.blindspot_intensity === \"High\" ? \"bg-red-100 text-red-700 border-red-200\" :\r\n                                        aiAnalysis.blindspot_intensity === \"Medium\" ? \"bg-amber-100 text-amber-700 border-amber-200\" :\r\n                                            \"bg-emerald-100 text-emerald-700 border-emerald-200\"\r\n                                        }`}>\r\n                                        Intensity: {aiAnalysis.blindspot_intensity}\r\n                                    </span>\r\n                                )}\r\n                            </h4>\r\n                            <p className=\"text-xs text-indigo-900 leading-relaxed italic\">\r\n                                \"{aiAnalysis.narrative}\"\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Structural Voids */}\r\n                        <div>\r\n                            <h4 className=\"text-xs font-bold text-slate-500 uppercase flex items-center gap-1 mb-2\">\r\n                                <AlertCircle className=\"h-3 w-3\" />\r\n                                Functional Voids\r\n                            </h4>\r\n                            <ul className=\"space-y-1\">\r\n                                {aiAnalysis.structural_voids.map((voidDesc, i) => (\r\n                                    <li key={i} className=\"text-xs text-slate-700 pl-2 border-l-2 border-slate-300\">\r\n                                        {voidDesc}\r\n                                    </li>\r\n                                ))}\r\n                            </ul>\r\n                        </div>\r\n\r\n                        {/* Missing Voices */}\r\n                        <div>\r\n                            <h4 className=\"text-xs font-bold text-slate-500 uppercase flex items-center gap-1 mb-2\">\r\n                                <Users className=\"h-3 w-3\" />\r\n                                Excluded Actors\r\n                            </h4>\r\n                            <div className=\"grid gap-2\">\r\n                                {aiAnalysis.missing_voices.map((mv, i) => (\r\n                                    <div key={i} className=\"bg-white p-2 rounded border border-slate-200 shadow-sm group hover:border-indigo-300 transition-colors\">\r\n                                        <div className=\"flex justify-between items-start mb-1 gap-2\">\r\n                                            <div className=\"flex-1\">\r\n                                                <span className=\"font-semibold text-xs text-slate-900 block\">{mv.name}</span>\r\n                                                <span className=\"text-[10px] uppercase bg-slate-100 px-1 rounded text-slate-500\">{mv.category}</span>\r\n                                            </div>\r\n                                            {onSimulate && (\r\n                                                <Button\r\n                                                    variant=\"ghost\"\r\n                                                    size=\"icon\"\r\n                                                    className=\"h-6 w-6 text-indigo-600 hover:bg-indigo-50 hover:text-indigo-800 -mt-1 -mr-1\"\r\n                                                    title={`Simulate ${mv.name}`}\r\n                                                    disabled={simulatingIndex === i}\r\n                                                    onClick={async () => {\r\n                                                        setSimulatingIndex(i);\r\n                                                        const context = topic ? `within the broader assemblage of \"${topic}\"` : \"relevant to this ecosystem\";\r\n                                                        try {\r\n                                                            await onSimulate(\r\n                                                                `Generate detailed ecosystem actors representing \"${mv.name}\" (${mv.category}) ${context}. Key context: ${mv.reason}`,\r\n                                                                \"absence_fill\"\r\n                                                            );\r\n                                                        } finally {\r\n                                                            setSimulatingIndex(null);\r\n                                                        }\r\n                                                    }}\r\n                                                >\r\n                                                    {simulatingIndex === i ? (\r\n                                                        <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n                                                    ) : (\r\n                                                        <Plus className=\"h-4 w-4\" />\r\n                                                    )}\r\n                                                </Button>\r\n                                            )}\r\n                                        </div>\r\n                                        <p className=\"text-[10px] text-slate-500 leading-tight\">{mv.reason}</p>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"h-px bg-slate-200 my-4\" />\r\n                    </div>\r\n                )}\r\n\r\n                {/* Standard Heuristics (Always Visible as Baseline) */}\r\n                <div className=\"opacity-80 hover:opacity-100 transition-opacity\">\r\n                    {!aiAnalysis && <h3 className=\"text-xs font-bold text-slate-400 uppercase mb-3 text-center\">- Initial Heuristic Scan -</h3>}\r\n\r\n                    {/* Missing Stakeholders */}\r\n                    <div className=\"mb-4\">\r\n                        <h4 className=\"text-sm font-bold text-slate-800 flex items-center gap-2 mb-2\">\r\n                            <Users className=\"h-4 w-4 text-slate-400\" />\r\n                            Standard Gaps\r\n                        </h4>\r\n                        {analysis.missingStakeholders.length > 0 ? (\r\n                            <div className=\"flex flex-wrap gap-2\">\r\n                                {analysis.missingStakeholders.map(s => (\r\n                                    <span key={s} className=\"px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded-full border border-slate-200\">\r\n                                        {s}\r\n                                    </span>\r\n                                ))}\r\n                            </div>\r\n                        ) : (\r\n                            <p className=\"text-xs text-slate-500 italic\">No standard missing types detected.</p>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Deferred Standards */}\r\n                    <div className=\"mb-4\">\r\n                        <h4 className=\"text-sm font-bold text-slate-800 flex items-center gap-2 mb-2\">\r\n                            <Clock className=\"h-4 w-4 text-slate-400\" />\r\n                            Deferred Mechanisms\r\n                        </h4>\r\n                        {analysis.deferredStandards.length > 0 ? (\r\n                            <ul className=\"space-y-2\">\r\n                                {analysis.deferredStandards.slice(0, 3).map((s, i) => (\r\n                                    <li key={i} className=\"text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100\">\r\n                                        \"{s}...\"\r\n                                    </li>\r\n                                ))}\r\n                            </ul>\r\n                        ) : (\r\n                            <p className=\"text-xs text-slate-500 italic\">\r\n                                {analyzedText ? \"No deferred mechanisms found in text.\" : \"Scan text to detect deferred standards.\"}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\ActorList.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":76,"column":61,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the &quot;Strategic Subtraction\" principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the &ldquo;Strategic Subtraction\" principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the &#34;Strategic Subtraction\" principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the &rdquo;Strategic Subtraction\" principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":76,"column":83,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the \"Strategic Subtraction&quot; principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the \"Strategic Subtraction&ldquo; principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the \"Strategic Subtraction&#34; principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3559,3839],"text":"\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the \"Strategic Subtraction&rdquo; principle: only empirical traces are visualized.\r\n                                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\nimport { ProvisionalBadge } from '@/components/ui/provisional-badge';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\r\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog';\r\nimport { Loader2, Trash2, ExternalLink, Maximize2, Minimize2, X, FileText, Wand2, Globe, Search } from 'lucide-react';\r\n\r\ninterface ActorListProps {\r\n    actors: EcosystemActor[];\r\n    selectedActorId: string | null;\r\n    onSelectActor: (id: string) => void;\r\n    onClearAll: () => void;\r\n\r\n    // Expansion Props\r\n    isExpanded?: boolean;\r\n    onToggleExpand?: () => void;\r\n\r\n    // Extraction Props\r\n    isExtracting: boolean;\r\n    extractionText: string;\r\n    setExtractionText: (text: string) => void;\r\n    onExtract: () => void;\r\n    isExtractionDialogOpen: boolean;\r\n    setIsExtractionDialogOpen: (open: boolean) => void;\r\n\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function ActorList({\r\n    actors,\r\n    selectedActorId,\r\n    onSelectActor,\r\n    onClearAll,\r\n    isExpanded = false,\r\n    onToggleExpand,\r\n    isExtracting,\r\n    extractionText,\r\n    setExtractionText,\r\n    onExtract,\r\n    isExtractionDialogOpen,\r\n    setIsExtractionDialogOpen,\r\n    onClose\r\n}: ActorListProps) {\r\n    return (\r\n        <Card className=\"h-[500px] lg:h-full flex flex-col\">\r\n            <CardHeader className=\"pb-2\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <CardTitle className=\"text-lg\">Trace Provenance ({actors.length})</CardTitle>\r\n                    <div className=\"flex gap-1\">\r\n                        {onToggleExpand && (\r\n                            <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 text-slate-400 hover:text-slate-600\" onClick={onToggleExpand} title={isExpanded ? \"Collapse\" : \"Expand\"}>\r\n                                {isExpanded ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\r\n                            </Button>\r\n                        )}\r\n                        {onClose && (\r\n                            <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 bg-slate-100 text-slate-500 hover:bg-slate-200\" onClick={onClose} title=\"Close Panel\">\r\n                                <X className=\"h-4 w-4\" />\r\n                            </Button>\r\n                        )}\r\n                        {/* Extraction Dialog */}\r\n                        <Dialog open={isExtractionDialogOpen} onOpenChange={setIsExtractionDialogOpen}>\r\n                            <DialogTrigger asChild>\r\n                                <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8\" title=\"Extract from Text\">\r\n                                    <FileText className=\"h-4 w-4 text-emerald-600\" />\r\n                                </Button>\r\n                            </DialogTrigger>\r\n                            <DialogContent>\r\n                                <DialogHeader>\r\n                                    <DialogTitle>Extract Assemblage</DialogTitle>\r\n                                    <DialogDescription>\r\n                                        Paste text to trace actants and create a Super-Node configuration.\r\n                                        This adheres to the \"Strategic Subtraction\" principle: only empirical traces are visualized.\r\n                                    </DialogDescription>\r\n                                </DialogHeader>\r\n                                <div className=\"py-4\">\r\n                                    <Textarea\r\n                                        placeholder=\"Paste text here (e.g., 'The CCP uses the SIFARE server to regulate pharmaceutical distribution...')\"\r\n                                        value={extractionText}\r\n                                        onChange={(e) => setExtractionText(e.target.value)}\r\n                                        className=\"min-h-[150px]\"\r\n                                    />\r\n                                </div>\r\n                                <DialogFooter>\r\n                                    <Button onClick={onExtract} disabled={isExtracting} className=\"bg-slate-900 text-white\">\r\n                                        {isExtracting ? (\r\n                                            <>\r\n                                                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                                Adhering Source...\r\n                                            </>\r\n                                        ) : (\r\n                                            <>\r\n                                                <Wand2 className=\"mr-2 h-4 w-4\" />\r\n                                                Adhere Empirical Source\r\n                                            </>\r\n                                        )}\r\n                                    </Button>\r\n                                </DialogFooter>\r\n                            </DialogContent>\r\n                        </Dialog>\r\n\r\n\r\n\r\n                        <AlertDialog>\r\n                            <AlertDialogTrigger asChild>\r\n                                <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8\" title=\"Clear All Actors\">\r\n                                    <Trash2 className=\"h-4 w-4 text-red-600\" />\r\n                                </Button>\r\n                            </AlertDialogTrigger>\r\n                            <AlertDialogContent>\r\n                                <AlertDialogHeader>\r\n                                    <AlertDialogTitle>Clear All Actors?</AlertDialogTitle>\r\n                                    <AlertDialogDescription>\r\n                                        This will remove all actors (including mock data). You&apos;ll start with an empty ecosystem. This action cannot be undone.\r\n                                    </AlertDialogDescription>\r\n                                </AlertDialogHeader>\r\n                                <AlertDialogFooter>\r\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\r\n                                    <AlertDialogAction onClick={onClearAll} className=\"bg-red-600 hover:bg-red-700\">\r\n                                        Clear All\r\n                                    </AlertDialogAction>\r\n                                </AlertDialogFooter>\r\n                            </AlertDialogContent>\r\n                        </AlertDialog>\r\n\r\n                    </div>\r\n                </div>\r\n                <div className=\"relative mt-2\">\r\n                    <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-slate-400\" />\r\n                    <input\r\n                        placeholder=\"Search actors...\"\r\n                        className=\"w-full pl-8 pr-4 py-2 text-sm border rounded-md bg-slate-50 text-slate-900\"\r\n                    />\r\n                </div>\r\n\r\n                {/* Explicit Actions Row */}\r\n            </CardHeader>\r\n            <CardContent className=\"flex-1 overflow-y-auto space-y-2 pt-0\">\r\n                {actors.length === 0 && (\r\n                    <div className=\"text-center p-6 text-slate-500 text-sm border-2 border-dashed border-slate-200 rounded-lg m-2 bg-slate-50/50\">\r\n                        <div className=\"flex justify-center mb-3\">\r\n                            <div className=\"relative\">\r\n                                <Globe className=\"h-10 w-10 text-slate-300\" />\r\n                                <div className=\"absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border border-slate-200\">\r\n                                    <X className=\"h-4 w-4 text-slate-400\" />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <h3 className=\"font-semibold text-slate-700 mb-1\">Strategic Subtraction Active</h3>\r\n                        <p className=\"text-xs text-slate-500 max-w-[280px] mx-auto mb-4 leading-relaxed\">\r\n                            Automated web scraping and predictive modeling are excluded to preserve empirical traceability.\r\n                            You must adhere researcher-curated text to trace mediations.\r\n                        </p>\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={() => setIsExtractionDialogOpen(true)}\r\n                            className=\"bg-white hover:bg-slate-50 text-xs gap-2\"\r\n                        >\r\n                            <FileText className=\"h-3 w-3 text-emerald-600\" />\r\n                            Adhere Empirical Source\r\n                        </Button>\r\n                    </div>\r\n                )}\r\n                {actors.map(actor => (\r\n                    <div\r\n                        key={actor.id}\r\n                        className={`p-3 rounded-md border cursor-pointer transition-colors relative ${selectedActorId === actor.id ? 'bg-indigo-50 border-indigo-200' :\r\n                            actor.source === 'absence_fill' ? 'bg-amber-50/50 border-amber-200 hover:bg-amber-50' : 'bg-white hover:bg-slate-50'}`}\r\n                        onClick={() => onSelectActor(actor.id)}\r\n                    >\r\n                        {actor.source === 'absence_fill' && (\r\n                            <div className=\"absolute -top-1.5 -right-1.5\">\r\n                                <span className=\"flex h-3 w-3 relative\">\r\n                                    <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75\"></span>\r\n                                    <span className=\"relative inline-flex rounded-full h-3 w-3 bg-amber-500\"></span>\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n                        <div className=\"flex items-center justify-between mb-1\">\r\n                            <div className=\"flex items-center gap-1.5 flex-wrap\">\r\n                                <span className={`font-medium text-sm ${actor.source === 'absence_fill' ? 'text-amber-900 group-hover:text-amber-700' : ''}`}>\r\n                                    {actor.name}\r\n                                </span>\r\n                                {(!actor.source || actor.source === 'default') && (\r\n                                    <ProvisionalBadge\r\n                                        className=\"h-4 px-1 text-[9px] border-indigo-200 bg-indigo-50 text-indigo-600\"\r\n                                        fragility={{ value: 0.4, interpretation: \"provisional\", factors: { input_completeness: 0.5, model_uncertainty: 0.3, theoretical_tension: 0.4, empirical_grounding: 0.8 } }}\r\n                                    />\r\n                                )}\r\n                            </div>\r\n                            <div className=\"flex gap-1 shrink-0\">\r\n                                {actor.source === 'absence_fill' && (\r\n                                    <Badge variant=\"outline\" className=\"text-[9px] px-1 py-0 h-5 border-amber-300 text-amber-600 bg-amber-100\">\r\n                                        Recovered\r\n                                    </Badge>\r\n                                )}\r\n                                <Badge variant=\"outline\" className=\"text-[10px] px-1 py-0 h-5\">\r\n                                    {actor.type}\r\n                                </Badge>\r\n                                {actor.role_type && (\r\n                                    <Badge variant=\"secondary\" className=\"text-[10px] px-1 py-0 h-5 bg-slate-100 text-slate-600 border border-slate-200\">\r\n                                        {actor.role_type}\r\n                                    </Badge>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                        <p className=\"text-xs text-slate-500 line-clamp-2 mb-2\">{actor.description}</p>\r\n\r\n                        {/* Trace Evidence Display */}\r\n                        {actor.quotes && actor.quotes.length > 0 && (\r\n                            <div className=\"mt-2 mb-2 bg-slate-50 p-2 rounded border border-slate-100\">\r\n                                <p className=\"text-[10px] font-semibold text-slate-400 mb-1 flex items-center gap-1 uppercase tracking-wider\">\r\n                                    <FileText className=\"h-3 w-3\" /> Empirical Traces\r\n                                </p>\r\n                                <ul className=\"space-y-1\">\r\n                                    {actor.quotes.map((quote, idx) => (\r\n                                        <li key={idx} className=\"text-[10px] text-slate-600 italic border-l-2 border-indigo-200 pl-2\">\r\n                                            &quot;{quote}&quot;\r\n                                        </li>\r\n                                    ))}\r\n                                </ul>\r\n                            </div>\r\n                        )}\r\n\r\n                        {actor.url && (\r\n                            <a\r\n                                href={actor.url}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"text-xs text-indigo-600 hover:text-indigo-800 flex items-center gap-1 hover:underline\"\r\n                                onClick={(e) => e.stopPropagation()}\r\n                            >\r\n                                <ExternalLink className=\"h-3 w-3\" />\r\n                                Visit Website\r\n                            </a>\r\n                        )}\r\n                    </div>\r\n                ))}\r\n            </CardContent>\r\n        </Card >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\AssemblageCompass.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":3,"column":129,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":134},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedActorId' is defined but never used.","line":14,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":75},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":74,"column":46,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[3170,3249],"text":"\r\n                    This policy document hasn&apos;t been analyzed yet. Go to the "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[3170,3249],"text":"\r\n                    This policy document hasn&lsquo;t been analyzed yet. Go to the "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[3170,3249],"text":"\r\n                    This policy document hasn&#39;t been analyzed yet. Go to the "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[3170,3249],"text":"\r\n                    This policy document hasn&rsquo;t been analyzed yet. Go to the "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":120,"column":106,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. &quot;Black boxes\" that are unquestioned and widely adopted."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. &ldquo;Black boxes\" that are unquestioned and widely adopted."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. &#34;Black boxes\" that are unquestioned and widely adopted."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. &rdquo;Black boxes\" that are unquestioned and widely adopted."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":120,"column":118,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. \"Black boxes&quot; that are unquestioned and widely adopted."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. \"Black boxes&ldquo; that are unquestioned and widely adopted."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. \"Black boxes&#34; that are unquestioned and widely adopted."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6381,6502],"text":"High Influence / Low Resistance. Stable, sedimented institutions. \"Black boxes&rdquo; that are unquestioned and widely adopted."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":199,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11408,11411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11408,11411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\nimport { ScatterChart, Scatter, XAxis, YAxis, ZAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceArea, ReferenceLine, Label } from 'recharts';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\r\nimport { Info } from 'lucide-react';\r\n\r\ninterface AssemblageCompassProps {\r\n    actors: EcosystemActor[];\r\n    onSelectActor: (id: string) => void;\r\n    selectedActorId: string | null;\r\n}\r\n\r\nexport function AssemblageCompass({ actors, onSelectActor, selectedActorId }: AssemblageCompassProps) {\r\n\r\n    // Pseudo-random jitter based on actor ID string to be deterministic but scattered\r\n    // (Prevents jittering on re-renders)\r\n    const getJitter = (str: string) => {\r\n        let hash = 0;\r\n        for (let i = 0; i < str.length; i++) {\r\n            hash = str.charCodeAt(i) + ((hash << 5) - hash);\r\n        }\r\n        return (hash % 1000) / 1000 - 0.5; // -0.5 to 0.5\r\n    };\r\n\r\n    // Helper to convert qualitative metrics to numeric scale for plotting\r\n    const qualitativeToNumeric = (val: string | number | undefined): number => {\r\n        if (typeof val === 'number') return val;\r\n        switch (val) {\r\n            case 'High': return 8;\r\n            case 'Moderate': return 5;\r\n            case 'Low': return 2;\r\n            case 'Weak': return 2;\r\n            default: return 5;\r\n        }\r\n    };\r\n\r\n    // Prepare data for the scatter plot\r\n    const data = actors.map(actor => {\r\n        const baseInf = qualitativeToNumeric(actor.metrics?.influence);\r\n        const baseRes = qualitativeToNumeric(actor.metrics?.resistance);\r\n\r\n        // Apply jitter properties - scaled to avoid shifting too much \r\n        // (0.4 jitter means max deviation is +/- 0.2 units on 0-10 scale)\r\n        const jitterX = getJitter(actor.id + \"x\") * 0.4;\r\n        const jitterY = getJitter(actor.id + \"y\") * 0.4;\r\n\r\n        return {\r\n            id: actor.id,\r\n            name: actor.name,\r\n            type: actor.type,\r\n            x: Math.max(0, Math.min(10, baseInf + jitterX)), // Clamp to 0-10\r\n            y: Math.max(0, Math.min(10, baseRes + jitterY)),\r\n            z: 100, // Size\r\n            fill: getColorByType(actor.type),\r\n            actor: actor // Pass full actor for tooltip\r\n        };\r\n    });\r\n\r\n    // Quadrant Definitions\r\n    // Q1 (High Inf, High Res): Battleground\r\n    // Q2 (High Inf, Low Res): Strata\r\n    // Q3 (Low Inf, High Res): Lines of Flight\r\n    // Q4 (Low Inf, Low Res): Amorphous\r\n\r\n    if (actors.length === 0) {\r\n        return (\r\n            <div className=\"w-full h-[600px] flex flex-col items-center justify-center text-center p-8 border border-slate-200 border-dashed rounded-xl bg-slate-50\">\r\n                <div className=\"w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4\">\r\n                    <Info className=\"h-8 w-8 text-slate-300\" />\r\n                </div>\r\n                <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">No Actors Mapped Yet</h3>\r\n                <p className=\"text-slate-500 max-w-md mb-6\">\r\n                    This policy document hasn't been analyzed yet. Go to the <strong>Visual Assemblage</strong> tab and use the <strong>Materialize</strong> or <strong>Simulation</strong> tools to populate the map.\r\n                </p>\r\n                <div className=\"text-xs text-slate-400\">\r\n                    Once actors are created, they will appear on this epistemic plane based on their territorialization and resistance scores.\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"w-full min-h-[1000px] bg-white rounded-xl border border-slate-200 shadow-sm p-4 relative overflow-hidden flex flex-col\">\r\n            <div className=\"bg-white/90 p-2 rounded-md border shadow-sm mb-4 shrink-0 self-start z-10 flex items-center gap-3\">\r\n                <div>\r\n                    <h3 className=\"text-sm font-bold text-slate-900\">Plane of Consistency</h3>\r\n                    <p className=\"text-xs text-slate-500\">Mapping the vectors of becoming.</p>\r\n                </div>\r\n                <Popover>\r\n                    <PopoverTrigger asChild>\r\n                        <button className=\"text-slate-400 hover:text-indigo-600 transition-colors\">\r\n                            <Info className=\"h-4 w-4\" />\r\n                        </button>\r\n                    </PopoverTrigger>\r\n                    <PopoverContent className=\"w-80 h-96 overflow-y-auto p-4\" align=\"start\">\r\n                        <h4 className=\"font-bold text-slate-900 mb-2 text-sm\">Assemblage Theory Guide</h4>\r\n                        <div className=\"space-y-4 text-xs text-slate-600\">\r\n\r\n                            {/* Axes */}\r\n                            <div className=\"border-b border-slate-100 pb-2\">\r\n                                <p className=\"font-semibold text-slate-900 mb-1\">X-Axis: Territorialization</p>\r\n                                <p>Forces that stabilize identity, enforce boundaries, and increase internal homogeneity. (Rules, Standards, Habits, Code)</p>\r\n                            </div>\r\n                            <div className=\"border-b border-slate-100 pb-2\">\r\n                                <p className=\"font-semibold text-slate-900 mb-1\">Y-Axis: Deterritorialization</p>\r\n                                <p>Forces that destabilize, create new connections, and facilitate escape. (Innovation, Rebellion, Glitches, Art)</p>\r\n                            </div>\r\n\r\n                            {/* Quadrants */}\r\n                            <div>\r\n                                <h5 className=\"font-bold text-slate-900 mb-2 mt-3 text-xs\">The Four Quadrants</h5>\r\n\r\n                                <div className=\"mb-2\">\r\n                                    <span className=\"text-red-600 font-bold block\">The Battleground (Q1)</span>\r\n                                    <p>High Influence / High Resistance. The zone of active conflict, negotiation, and power struggles. Institutions under siege.</p>\r\n                                </div>\r\n                                <div className=\"mb-2\">\r\n                                    <span className=\"text-blue-600 font-bold block\">The Strata (Q2)</span>\r\n                                    <p>High Influence / Low Resistance. Stable, sedimented institutions. \"Black boxes\" that are unquestioned and widely adopted.</p>\r\n                                </div>\r\n                                <div className=\"mb-2\">\r\n                                    <span className=\"text-emerald-600 font-bold block\">Lines of Flight (Q3)</span>\r\n                                    <p>Low Influence / High Resistance. Radical experiments, hackers, and movements attempting to escape the dominant logic.</p>\r\n                                </div>\r\n                                <div className=\"mb-2\">\r\n                                    <span className=\"text-slate-500 font-bold block\">The Amorphous (Q4)</span>\r\n                                    <p>Low Influence / Low Resistance. Passive components, raw resources, or disengaged users. Potential energy waiting to be formed.</p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </PopoverContent>\r\n                </Popover>\r\n            </div>\r\n\r\n            <div className=\"w-full h-[900px]\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                    <ScatterChart margin={{ top: 20, right: 20, bottom: 80, left: 80 }}>\r\n                        <CartesianGrid strokeDasharray=\"3 3\" opacity={0.3} />\r\n\r\n                        {/* Background Zones - Subtle Tinting */}\r\n                        <ReferenceArea x1={5} x2={10} y1={5} y2={10} fill=\"rgba(239, 68, 68, 0.05)\" /> {/* Top Right: Battleground */}\r\n                        <ReferenceArea x1={5} x2={10} y1={0} y2={5} fill=\"rgba(59, 130, 246, 0.05)\" />  {/* Bottom Right: Strata */}\r\n                        <ReferenceArea x1={0} x2={5} y1={5} y2={10} fill=\"rgba(16, 185, 129, 0.05)\" />  {/* Top Left: Flight */}\r\n                        <ReferenceArea x1={0} x2={5} y1={0} y2={5} fill=\"rgba(100, 116, 139, 0.05)\" />  {/* Bottom Left: Amorphous */}\r\n\r\n                        <XAxis\r\n                            type=\"number\"\r\n                            dataKey=\"x\"\r\n                            name=\"Territorialization\"\r\n                            domain={[0, 10]}\r\n                            ticks={[0, 2, 4, 6, 8, 10]}\r\n                            label={{ value: 'Degree of Territorialization (Influence)', position: 'bottom', offset: 0, fill: '#64748b', fontSize: 12 }}\r\n                        />\r\n                        <YAxis\r\n                            type=\"number\"\r\n                            dataKey=\"y\"\r\n                            name=\"Deterritorialization\"\r\n                            domain={[0, 10]}\r\n                            ticks={[0, 2, 4, 6, 8, 10]}\r\n                            label={{ value: 'Degree of Deterritorialization (Resistance)', angle: -90, position: 'left', offset: 0, fill: '#64748b', fontSize: 12, style: { textAnchor: 'middle' } }}\r\n                        />\r\n                        <ZAxis type=\"number\" dataKey=\"z\" range={[64, 400]} />\r\n\r\n                        {/* Quadrant Labels */}\r\n                        <ReferenceLine x={5} stroke=\"#94a3b8\" strokeDasharray=\"5 5\" />\r\n                        <ReferenceLine y={5} stroke=\"#94a3b8\" strokeDasharray=\"5 5\" />\r\n\r\n                        <Tooltip content={<CustomTooltip />} cursor={{ strokeDasharray: '3 3' }} />\r\n\r\n                        <Scatter\r\n                            name=\"Actors\"\r\n                            data={data}\r\n                            fill=\"#8884d8\"\r\n                            onClick={(node) => onSelectActor(node.payload.id)}\r\n                            className=\"cursor-pointer\"\r\n                        />\r\n                    </ScatterChart>\r\n                </ResponsiveContainer>\r\n            </div>\r\n\r\n            {/* Quadrant Text Labels (Absolute Positioned Overlay for better control) */}\r\n            <div className=\"absolute top-[20%] right-[15%] text-red-900/40 font-bold text-2xl select-none pointer-events-none text-center\">\r\n                THE BATTLEGROUND<br /><span className=\"text-xs font-normal opacity-70\">Contested Territory</span>\r\n            </div>\r\n            <div className=\"absolute bottom-[20%] right-[15%] text-blue-900/40 font-bold text-2xl select-none pointer-events-none text-center\">\r\n                THE STRATA<br /><span className=\"text-xs font-normal opacity-70\">Institutional Stability</span>\r\n            </div>\r\n            <div className=\"absolute top-[20%] left-[15%] text-emerald-900/40 font-bold text-2xl select-none pointer-events-none text-center\">\r\n                LINES OF FLIGHT<br /><span className=\"text-xs font-normal opacity-70\">Escape & Innovation</span>\r\n            </div>\r\n            <div className=\"absolute bottom-[20%] left-[15%] text-slate-500/30 font-bold text-2xl select-none pointer-events-none text-center\">\r\n                AMORPHOUS<br /><span className=\"text-xs font-normal opacity-70\">Potential Energy</span>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nconst CustomTooltip = ({ active, payload }: any) => {\r\n    if (active && payload && payload.length) {\r\n        const data = payload[0].payload;\r\n        const actor = data.actor;\r\n\r\n        return (\r\n            <Card className=\"bg-white/95 backdrop-blur shadow-xl border-slate-200 p-3 min-w-[200px]\">\r\n                <p className=\"font-bold text-sm text-slate-900 mb-1\">{data.name}</p>\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                    <span className=\"text-[10px] uppercase font-bold tracking-wider px-1.5 py-0.5 rounded bg-slate-100 text-slate-600\">\r\n                        {data.type}\r\n                    </span>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-2 text-xs border-t border-slate-100 pt-2 mb-2\">\r\n                    <div>\r\n                        <span className=\"text-slate-500 block\">Territorialization</span>\r\n                        <span className=\"font-mono font-bold text-indigo-600\">\r\n                            {data.actor.metrics?.influence || \"Unknown\"}\r\n                        </span>\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-slate-500 block\">Deterritorialization</span>\r\n                        <span className=\"font-mono font-bold text-emerald-600\">\r\n                            {data.actor.metrics?.resistance || \"Unknown\"}\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n\r\n                <p className=\"text-[10px] text-slate-500 italic leading-tight\">\r\n                    {actor.description.slice(0, 100)}...\r\n                </p>\r\n            </Card>\r\n        );\r\n    }\r\n    return null;\r\n};\r\n\r\n// Helper to match map colors\r\nfunction getColorByType(type: string) {\r\n    switch (type) {\r\n        case 'Policymaker': return '#4f46e5'; // Indigo\r\n        case 'Startup': return '#0ea5e9'; // Sky\r\n        case 'Civil Society': return '#ea580c'; // Orange\r\n        case 'Academic': return '#8b5cf6'; // Violet\r\n        case 'Infrastructure': return '#64748b'; // Slate\r\n        case 'Algorithm': return '#ec4899'; // Pink\r\n        case 'Dataset': return '#10b981'; // Emerald\r\n        default: return '#94a3b8';\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\AssemblagePanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Plus' is defined but never used.","line":7,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Ghost' is defined but never used.","line":7,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BoxSelect' is defined but never used.","line":7,"column":82,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":91}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';\r\nimport { Loader2, Plus, Ghost, Layers, Globe, ShieldCheck, Maximize2, Minimize2, BoxSelect, X, Search } from 'lucide-react';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\r\nimport { EcosystemActor, AssemblageAnalysis, EcosystemConfiguration } from '@/types/ecosystem';\r\nimport { ProvisionalBadge, FragilityIndicator } from '@/components/ui/provisional-badge';\r\n\r\nimport { ReflexiveLog } from './ReflexiveLog';\r\n\r\ninterface AssemblagePanelProps {\r\n    actors: EcosystemActor[];\r\n    analyzedText?: string;\r\n    savedAnalysis?: AssemblageAnalysis | null;\r\n    onSaveAnalysis?: (analysis: AssemblageAnalysis) => void;\r\n    // Expansion Props\r\n    isExpanded?: boolean;\r\n    onToggleExpand?: () => void;\r\n    // Unification Props\r\n    selectedConfig?: EcosystemConfiguration | null;\r\n    onUpdateConfig?: (config: EcosystemConfiguration) => void;\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function AssemblagePanel({ actors, analyzedText = \"\", savedAnalysis, onSaveAnalysis, isExpanded = false, onToggleExpand, selectedConfig, onUpdateConfig, onClose }: AssemblagePanelProps) {\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n\r\n    const handleAddLog = (entry: import('@/types/ecosystem').ReflexiveLogEntry) => {\r\n        if (!selectedConfig || !onUpdateConfig) return;\r\n\r\n        const updatedConfig = {\r\n            ...selectedConfig,\r\n            reflexive_log: [...(selectedConfig.reflexive_log || []), entry]\r\n        };\r\n        onUpdateConfig(updatedConfig);\r\n    };\r\n\r\n    const handleDeleteLog = (entryId: string) => {\r\n        if (!selectedConfig || !onUpdateConfig) return;\r\n\r\n        const updatedConfig = {\r\n            ...selectedConfig,\r\n            reflexive_log: (selectedConfig.reflexive_log || []).filter(l => l.id !== entryId)\r\n        };\r\n        onUpdateConfig(updatedConfig);\r\n    };\r\n\r\n    const handleDeepScan = async () => {\r\n        if (actors.length === 0 && !analyzedText) {\r\n            alert(\"Please add actors or text source before analyzing.\");\r\n            return;\r\n        }\r\n\r\n        setIsAnalyzing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            // Always try to send demo ID if available (handles client/server env mismatch)\r\n            if (process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/ecosystem/absence', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({ actors, text: analyzedText })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                console.error(\"Assemblage Analysis failed:\", response.status, response.statusText);\r\n                alert(`Analysis failed: Server returned ${response.status}`);\r\n                return;\r\n            }\r\n\r\n            const data = await response.json();\r\n            if (data.success && onSaveAnalysis) {\r\n                if (data.success && onSaveAnalysis) {\r\n                    // [FIX] Safe Merge: Explicitly preserve traces and metrics from existing analysis\r\n                    // The 'absence' analysis (deep scan) does typically NOT return traces/metrics,\r\n                    // so specific keys must be protected from being overwritten by undefined/null.\r\n                    const effectiveAnalysis = selectedConfig?.analysisData || savedAnalysis || {};\r\n\r\n                    const mergedAnalysis = {\r\n                        ...effectiveAnalysis,\r\n                        ...data.analysis,\r\n                        // Force preserve critical metric data if it exists in the old state\r\n                        traces: effectiveAnalysis.traces || data.analysis.traces,\r\n                        computed_metrics: effectiveAnalysis.computed_metrics || data.analysis.computed_metrics,\r\n                        // Preserve the core assemblage identity if not provided by new analysis\r\n                        assemblage: effectiveAnalysis.assemblage || data.analysis.assemblage\r\n                    };\r\n\r\n                    onSaveAnalysis(mergedAnalysis);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Assemblage Analysis failed\", error);\r\n            alert(\"Failed to analyze assemblage. Please check your connection.\");\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Card className=\"h-full border-l-4 border-l-slate-400 bg-slate-50/50 flex flex-col\">\r\n            <CardHeader className=\"pb-2\">\r\n                <CardTitle className=\"text-lg font-semibold flex items-center justify-between text-slate-700\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Layers className=\"h-5 w-5 text-indigo-600\" />\r\n                        Interpretive Workspace\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1\">\r\n                        {onToggleExpand && (\r\n                            <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 text-slate-400 hover:text-slate-600\" onClick={onToggleExpand} title={isExpanded ? \"Collapse\" : \"Expand\"}>\r\n                                {isExpanded ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\r\n                            </Button>\r\n                        )}\r\n                        {onClose && (\r\n                            <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 bg-red-100 text-red-600 hover:bg-red-200\" onClick={onClose} title=\"Close Panel\">\r\n                                <X className=\"h-4 w-4\" />\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n                </CardTitle>\r\n                <CardDescription>\r\n                    Tracing components, mobilities, and silences in the policy assemblage.\r\n                    {/* Provisional Badge in Header if available */}\r\n                    {(savedAnalysis?.provisional_status || (selectedConfig?.analysisData as AssemblageAnalysis)?.provisional_status) && (\r\n                        <div className=\"mt-2\">\r\n                            <ProvisionalBadge\r\n                                fragility={(savedAnalysis?.provisional_status || (selectedConfig?.analysisData as AssemblageAnalysis)?.provisional_status)?.fragility_score}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                </CardDescription>\r\n\r\n                <div className=\"pt-2\">\r\n                    <Button\r\n                        size=\"sm\"\r\n                        onClick={handleDeepScan}\r\n                        disabled={isAnalyzing}\r\n                        className={`w-full text-xs font-medium gap-2 transition-all ${savedAnalysis ? \"bg-indigo-100 text-indigo-700 hover:bg-indigo-200 border-indigo-200\" : \"bg-slate-900 text-white hover:bg-slate-800\"}`}\r\n                    >\r\n                        {isAnalyzing ? (\r\n                            <>\r\n                                <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n                                Analyzing Assemblage...\r\n                            </>\r\n                        ) : savedAnalysis ? (\r\n                            <>\r\n                                <Search className=\"h-3 w-3\" />\r\n                                Re-Trace Inscriptions\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Layers className=\"h-3 w-3\" />\r\n                                Trace Inscriptions\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6 overflow-y-auto flex-1 p-4\">\r\n                {selectedConfig ? (\r\n                    <div className=\"space-y-6\">\r\n                        <div className=\"bg-indigo-50 border border-indigo-100 p-4 rounded-lg\">\r\n                            <h3 className=\"font-bold text-indigo-900 text-lg mb-1\">{selectedConfig.name}</h3>\r\n                            <p className=\"text-sm text-indigo-700 mb-3\">{selectedConfig.description}</p>\r\n\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <TooltipProvider>\r\n                                    <Tooltip>\r\n                                        <TooltipTrigger asChild>\r\n                                            <div className=\"bg-white p-2 rounded border border-indigo-100 cursor-help hover:bg-slate-50 transition-colors\">\r\n                                                <span className=\"text-[10px] uppercase font-bold text-slate-500 block mb-1\">Territorialization</span>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <span className=\"text-base font-bold text-slate-900\">\r\n                                                        {(Number(selectedConfig.properties.territorialization_score) || 0) > 7 ? \"High Intensity\" : (Number(selectedConfig.properties.territorialization_score) || 0) > 4 ? \"Medium Intensity\" : \"Low Intensity\"}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                        </TooltipTrigger>\r\n                                        <TooltipContent className=\"max-w-xs bg-slate-900 text-white border-slate-800\">\r\n                                            <p className=\"font-bold border-b border-slate-700 pb-1 mb-1\">Computed from Traces:</p>\r\n                                            <ul className=\"text-xs list-disc list-inside space-y-1\">\r\n                                                {(selectedConfig.analysisData as AssemblageAnalysis)?.computed_metrics?.territorialization_audit && (selectedConfig.analysisData as AssemblageAnalysis).computed_metrics!.territorialization_audit!.length > 0\r\n                                                    ? (selectedConfig.analysisData as AssemblageAnalysis).computed_metrics!.territorialization_audit!.map((t: string, i: number) => <li key={i}>{t}</li>)\r\n                                                    : <li className=\"text-slate-400\">No traces found</li>}\r\n                                            </ul>\r\n                                        </TooltipContent>\r\n                                    </Tooltip>\r\n\r\n                                    <Tooltip>\r\n                                        <TooltipTrigger asChild>\r\n                                            <div className=\"bg-white p-2 rounded border border-indigo-100 cursor-help hover:bg-slate-50 transition-colors\">\r\n                                                <span className=\"text-[10px] uppercase font-bold text-slate-500 block mb-1\">Coding Intensity</span>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <span className=\"text-base font-bold text-slate-900\">\r\n                                                        {(Number(selectedConfig.properties.coding_intensity_score) || 0) > 7 ? \"Over-Coded\" : (Number(selectedConfig.properties.coding_intensity_score) || 0) > 4 ? \"Mixed Coding\" : \"Decoded\"}\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                        </TooltipTrigger>\r\n                                        <TooltipContent className=\"max-w-xs bg-slate-900 text-white border-slate-800\">\r\n                                            <p className=\"font-bold border-b border-slate-700 pb-1 mb-1\">Computed from Traces:</p>\r\n                                            <ul className=\"text-xs list-disc list-inside space-y-1\">\r\n                                                {(selectedConfig.analysisData as AssemblageAnalysis)?.computed_metrics?.coding_audit && (selectedConfig.analysisData as AssemblageAnalysis).computed_metrics!.coding_audit!.length > 0\r\n                                                    ? (selectedConfig.analysisData as AssemblageAnalysis).computed_metrics!.coding_audit!.map((t: string, i: number) => <li key={i}>{t}</li>)\r\n                                                    : <li className=\"text-slate-400\">No traces found</li>}\r\n                                            </ul>\r\n                                        </TooltipContent>\r\n                                    </Tooltip>\r\n                                </TooltipProvider>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {selectedConfig.analysisData ? (\r\n                            <Tabs defaultValue=\"critique\" className=\"w-full\">\r\n                                <TabsList className=\"grid w-full grid-cols-5 bg-slate-100/50 p-1 mb-4 h-auto\">\r\n                                    <TabsTrigger value=\"critique\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                        Critique\r\n                                    </TabsTrigger>\r\n                                    <TabsTrigger value=\"actants\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                        Actants\r\n                                    </TabsTrigger>\r\n                                    <TabsTrigger value=\"mechanisms\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                        Mechanisms\r\n                                    </TabsTrigger>\r\n                                    <TabsTrigger value=\"relations\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                        Relations\r\n                                    </TabsTrigger>\r\n                                    <TabsTrigger value=\"journal\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                        Journal\r\n                                    </TabsTrigger>\r\n                                </TabsList>\r\n\r\n                                <TabsContent value=\"journal\" className=\"space-y-4 h-[400px]\">\r\n                                    <ReflexiveLog\r\n                                        logs={selectedConfig.reflexive_log || []}\r\n                                        onAddLog={handleAddLog}\r\n                                        onDeleteLog={handleDeleteLog}\r\n                                    />\r\n                                </TabsContent>\r\n\r\n                                <TabsContent value=\"critique\" className=\"space-y-4\">\r\n                                    <div className=\"bg-amber-50 p-3 rounded-lg border border-amber-100 text-amber-900 text-xs italic\">\r\n                                        &quot;{(selectedConfig.analysisData as AssemblageAnalysis).narrative}&quot;\r\n                                        {(selectedConfig.analysisData as AssemblageAnalysis).provisional_status && (\r\n                                            <div className=\"mt-2 pt-2 border-t border-amber-200\">\r\n                                                <FragilityIndicator score={(selectedConfig.analysisData as AssemblageAnalysis).provisional_status!.fragility_score} />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div>\r\n                                        <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Excluded Voices</h4>\r\n                                        <div className=\"space-y-2\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).missing_voices?.map((mv, i) => (\r\n                                                <div key={i} className=\"bg-white p-2 rounded border border-slate-200 shadow-sm flex justify-between gap-2\">\r\n                                                    <div>\r\n                                                        <span className=\"font-semibold text-xs text-slate-900 block\">{mv.name}</span>\r\n                                                        <p className=\"text-[10px] text-slate-500\">{mv.reason}</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div>\r\n                                        <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Structural Voids</h4>\r\n                                        <ul className=\"list-disc list-inside text-xs text-slate-600 space-y-1\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).structural_voids?.map((v, i) => <li key={i}>{v}</li>)}\r\n                                        </ul>\r\n                                    </div>\r\n                                </TabsContent>\r\n\r\n                                <TabsContent value=\"actants\" className=\"space-y-4\">\r\n                                    <div>\r\n                                        <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Infrastructures</h4>\r\n                                        <div className=\"flex flex-wrap gap-2\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).socio_technical_components?.infra?.map((inf, i) => (\r\n                                                <span key={i} className=\"px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded border border-slate-200\">\r\n                                                    {inf}\r\n                                                </span>\r\n                                            )) || <p className=\"text-xs text-slate-400\">No infrastructures detected.</p>}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div>\r\n                                        <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Discourses</h4>\r\n                                        <div className=\"space-y-2\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).socio_technical_components?.discourse?.map((d, i) => (\r\n                                                <p key={i} className=\"text-xs text-slate-600 border-l-2 border-indigo-200 pl-2\">\r\n                                                    {d}\r\n                                                </p>\r\n                                            )) || <p className=\"text-xs text-slate-400\">No discourses detected.</p>}\r\n                                        </div>\r\n                                    </div>\r\n                                </TabsContent>\r\n\r\n                                <TabsContent value=\"relations\" className=\"space-y-4\">\r\n                                    <div className=\"bg-white p-3 rounded-lg border border-slate-200\">\r\n                                        <div className=\"flex items-center justify-between mb-2\">\r\n                                            <h4 className=\"text-xs font-bold text-slate-700 uppercase\">Mobility Score</h4>\r\n                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${(selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.mobility_score === \"High\" ? \"bg-green-100 text-green-700\" :\r\n                                                (selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.mobility_score === \"Low\" ? \"bg-red-100 text-red-700\" :\r\n                                                    \"bg-amber-100 text-amber-700\"\r\n                                                }`}>\r\n                                                {(selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.mobility_score || \"Unknown\"}\r\n                                            </span>\r\n                                        </div>\r\n                                        <p className=\"text-[10px] text-slate-500 mb-3\">\r\n                                            High exteriority means components can be easily detached and reused in other assemblages.\r\n                                        </p>\r\n\r\n                                        <div className=\"grid grid-cols-2 gap-3\">\r\n                                            <div className=\"space-y-1\">\r\n                                                <span className=\"text-[10px] uppercase font-bold text-green-600 block border-b border-green-100 pb-1\">Detachable</span>\r\n                                                {(selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.detachable?.length ? (\r\n                                                    (selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.detachable.map((item, i) => (\r\n                                                        <p key={i} className=\"text-xs text-slate-600 pl-1\">{item}</p>\r\n                                                    ))\r\n                                                ) : <p className=\"text-[10px] text-slate-400 italic\">None identified</p>}\r\n                                            </div>\r\n                                            <div className=\"space-y-1\">\r\n                                                <span className=\"text-[10px] uppercase font-bold text-red-600 block border-b border-red-100 pb-1\">Embedded (Interior)</span>\r\n                                                {(selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.embedded?.length ? (\r\n                                                    (selectedConfig.analysisData as AssemblageAnalysis).relations_of_exteriority?.embedded.map((item, i) => (\r\n                                                        <p key={i} className=\"text-xs text-slate-600 pl-1\">{item}</p>\r\n                                                    ))\r\n                                                ) : <p className=\"text-[10px] text-slate-400 italic\">None identified</p>}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"bg-blue-50 p-3 rounded-lg border border-blue-100\">\r\n                                        <h4 className=\"text-xs font-bold text-blue-800 uppercase mb-2 flex items-center gap-1\">\r\n                                            <Globe className=\"h-3 w-3\" /> Origin Concepts\r\n                                        </h4>\r\n                                        <ul className=\"list-disc list-inside text-xs text-blue-900 space-y-1\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).policy_mobilities?.origin_concepts?.map((c, i) => <li key={i}>{c}</li>) || <li>None detected</li>}\r\n                                        </ul>\r\n                                    </div>\r\n                                    <div className=\"bg-emerald-50 p-3 rounded-lg border border-emerald-100\">\r\n                                        <h4 className=\"text-xs font-bold text-emerald-800 uppercase mb-2\">Local Mutations</h4>\r\n                                        <ul className=\"list-disc list-inside text-xs text-emerald-900 space-y-1\">\r\n                                            {(selectedConfig.analysisData as AssemblageAnalysis).policy_mobilities?.local_mutations?.map((m, i) => <li key={i}>{m}</li>) || <li>None detected</li>}\r\n                                        </ul>\r\n                                    </div>\r\n                                </TabsContent>\r\n\r\n                                <TabsContent value=\"mechanisms\" className=\"space-y-4\">\r\n                                    <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Stabilization Mechanisms</h4>\r\n                                    <p className=\"text-xs text-slate-500 mb-2\">How this assemblage holds together against disruption:</p>\r\n                                    <div className=\"space-y-2\">\r\n                                        {(selectedConfig.analysisData as AssemblageAnalysis).stabilization_mechanisms?.map((mech, i) => (\r\n                                            <div key={i} className=\"flex items-start gap-2 text-xs text-slate-700\">\r\n                                                <ShieldCheck className=\"h-3 w-3 text-slate-400 mt-0.5 shrink-0\" />\r\n                                                <span>{mech}</span>\r\n                                            </div>\r\n                                        )) || <p className=\"text-xs text-slate-400\">No mechanisms detected.</p>}\r\n                                    </div>\r\n                                </TabsContent>\r\n                            </Tabs>\r\n                        ) : (\r\n                            <div className=\"p-4 border border-dashed border-slate-300 rounded-lg text-center text-slate-500\">\r\n                                <p className=\"text-sm\">No deep analysis data available for this configuration.</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                ) : savedAnalysis ? (\r\n                    <Tabs defaultValue=\"critique\" className=\"w-full\">\r\n                        <TabsList className=\"grid w-full grid-cols-4 bg-slate-100/50 p-1 mb-4 h-auto\">\r\n                            <TabsTrigger value=\"critique\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                Critique\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"actants\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                Actants\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"mechanisms\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                Mechanisms\r\n                            </TabsTrigger>\r\n                            <TabsTrigger value=\"relations\" className=\"text-xs data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-indigo-600\">\r\n                                Relations\r\n                            </TabsTrigger>\r\n                        </TabsList>\r\n\r\n                        {/* CRITIQUE TAB (Existing Absence Data) */}\r\n                        <TabsContent value=\"critique\" className=\"space-y-4\">\r\n                            <div className=\"bg-amber-50 p-3 rounded-lg border border-amber-100 text-amber-900 text-xs italic\">\r\n                                &quot;{savedAnalysis.narrative}&quot;\r\n                                {savedAnalysis.provisional_status && (\r\n                                    <div className=\"mt-2 pt-2 border-t border-amber-200\">\r\n                                        <FragilityIndicator score={savedAnalysis.provisional_status.fragility_score} />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            <div>\r\n                                <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Excluded Voices</h4>\r\n                                <div className=\"space-y-2\">\r\n                                    {savedAnalysis.missing_voices.map((mv, i) => (\r\n                                        <div key={i} className=\"bg-white p-2 rounded border border-slate-200 shadow-sm flex justify-between gap-2\">\r\n                                            <div>\r\n                                                <span className=\"font-semibold text-xs text-slate-900 block\">{mv.name}</span>\r\n                                                <p className=\"text-[10px] text-slate-500\">{mv.reason}</p>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n                            <div>\r\n                                <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Structural Voids</h4>\r\n                                <ul className=\"list-disc list-inside text-xs text-slate-600 space-y-1\">\r\n                                    {savedAnalysis.structural_voids.map((v, i) => <li key={i}>{v}</li>)}\r\n                                </ul>\r\n                            </div>\r\n                        </TabsContent>\r\n\r\n                        {/* ACTANTS TAB (New Socio-Technical Components) */}\r\n                        <TabsContent value=\"actants\" className=\"space-y-4\">\r\n                            <div>\r\n                                <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Infrastructures</h4>\r\n                                <div className=\"flex flex-wrap gap-2\">\r\n                                    {savedAnalysis.socio_technical_components?.infra.map((inf, i) => (\r\n                                        <span key={i} className=\"px-2 py-1 bg-slate-100 text-slate-700 text-xs rounded border border-slate-200\">\r\n                                            {inf}\r\n                                        </span>\r\n                                    )) || <p className=\"text-xs text-slate-400\">No infrastructures detected.</p>}\r\n                                </div>\r\n                            </div>\r\n                            <div>\r\n                                <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Discourses</h4>\r\n                                <div className=\"space-y-2\">\r\n                                    {savedAnalysis.socio_technical_components?.discourse.map((d, i) => (\r\n                                        <p key={i} className=\"text-xs text-slate-600 border-l-2 border-indigo-200 pl-2\">\r\n                                            {d}\r\n                                        </p>\r\n                                    )) || <p className=\"text-xs text-slate-400\">No discourses detected.</p>}\r\n                                </div>\r\n                            </div>\r\n                        </TabsContent>\r\n\r\n                        {/* RELATIONS TAB */}\r\n                        <TabsContent value=\"relations\" className=\"space-y-4\">\r\n                            <div className=\"bg-white p-3 rounded-lg border border-slate-200\">\r\n                                <div className=\"flex items-center justify-between mb-2\">\r\n                                    <h4 className=\"text-xs font-bold text-slate-700 uppercase\">Mobility Score</h4>\r\n                                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${savedAnalysis.relations_of_exteriority?.mobility_score === \"High\" ? \"bg-green-100 text-green-700\" :\r\n                                        savedAnalysis.relations_of_exteriority?.mobility_score === \"Low\" ? \"bg-red-100 text-red-700\" :\r\n                                            \"bg-amber-100 text-amber-700\"\r\n                                        }`}>\r\n                                        {savedAnalysis.relations_of_exteriority?.mobility_score || \"Unknown\"}\r\n                                    </span>\r\n                                </div>\r\n                                <p className=\"text-[10px] text-slate-500 mb-3\">\r\n                                    High exteriority means components can be easily detached and reused in other assemblages.\r\n                                </p>\r\n\r\n                                <div className=\"grid grid-cols-2 gap-3\">\r\n                                    <div className=\"space-y-1\">\r\n                                        <span className=\"text-[10px] uppercase font-bold text-green-600 block border-b border-green-100 pb-1\">Detachable</span>\r\n                                        {savedAnalysis.relations_of_exteriority?.detachable?.length ? (\r\n                                            savedAnalysis.relations_of_exteriority.detachable.map((item, i) => (\r\n                                                <p key={i} className=\"text-xs text-slate-600 pl-1\">{item}</p>\r\n                                            ))\r\n                                        ) : <p className=\"text-[10px] text-slate-400 italic\">None identified</p>}\r\n                                    </div>\r\n                                    <div className=\"space-y-1\">\r\n                                        <span className=\"text-[10px] uppercase font-bold text-red-600 block border-b border-red-100 pb-1\">Embedded (Interior)</span>\r\n                                        {savedAnalysis.relations_of_exteriority?.embedded?.length ? (\r\n                                            savedAnalysis.relations_of_exteriority.embedded.map((item, i) => (\r\n                                                <p key={i} className=\"text-xs text-slate-600 pl-1\">{item}</p>\r\n                                            ))\r\n                                        ) : <p className=\"text-[10px] text-slate-400 italic\">None identified</p>}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"bg-blue-50 p-3 rounded-lg border border-blue-100\">\r\n                                <h4 className=\"text-xs font-bold text-blue-800 uppercase mb-2 flex items-center gap-1\">\r\n                                    <Globe className=\"h-3 w-3\" /> Origin Concepts\r\n                                </h4>\r\n                                <ul className=\"list-disc list-inside text-xs text-blue-900 space-y-1\">\r\n                                    {savedAnalysis.policy_mobilities?.origin_concepts.map((c, i) => <li key={i}>{c}</li>) || <li>None detected</li>}\r\n                                </ul>\r\n                            </div>\r\n                            <div className=\"bg-emerald-50 p-3 rounded-lg border border-emerald-100\">\r\n                                <h4 className=\"text-xs font-bold text-emerald-800 uppercase mb-2\">Local Mutations</h4>\r\n                                <ul className=\"list-disc list-inside text-xs text-emerald-900 space-y-1\">\r\n                                    {savedAnalysis.policy_mobilities?.local_mutations.map((m, i) => <li key={i}>{m}</li>) || <li>None detected</li>}\r\n                                </ul>\r\n                            </div>\r\n                        </TabsContent>\r\n\r\n                        {/* MECHANISMS TAB (New Stabilization Mechanisms) */}\r\n                        <TabsContent value=\"mechanisms\" className=\"space-y-4\">\r\n                            <h4 className=\"text-xs font-bold text-slate-500 uppercase mb-2\">Stabilization Mechanisms</h4>\r\n                            <p className=\"text-xs text-slate-500 mb-2\">How this assemblage holds together against disruption:</p>\r\n                            <div className=\"space-y-2\">\r\n                                {savedAnalysis.stabilization_mechanisms?.map((mech, i) => (\r\n                                    <div key={i} className=\"flex items-start gap-2 text-xs text-slate-700\">\r\n                                        <ShieldCheck className=\"h-3 w-3 text-slate-400 mt-0.5 shrink-0\" />\r\n                                        <span>{mech}</span>\r\n                                    </div>\r\n                                )) || <p className=\"text-xs text-slate-400\">No mechanisms detected.</p>}\r\n                            </div>\r\n                        </TabsContent>\r\n                    </Tabs>\r\n                ) : (\r\n                    <div className=\"flex flex-col items-center justify-center h-48 text-center text-slate-400\">\r\n                        <Layers className=\"h-8 w-8 mb-2 opacity-50\" />\r\n                        <p className=\"text-sm\">Run analysis to map the assemblage.</p>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n            <div className=\"p-2 border-t border-slate-200 bg-slate-50 text-[10px] text-slate-400 text-center italic\">\r\n                Methodological constrained artifact. Outputs are provisional inscriptions.\r\n            </div>\r\n        </Card >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\ConfigurationDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\EcosystemLegends.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\EcosystemMap.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'svg' is assigned a value but never used.","line":181,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":181,"endColumn":18},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":240,"column":5,"severity":1,"nodeType":null,"fix":{"range":[9787,9849],"text":" "}}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'simulation' is assigned a value but never used.","line":167,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":167,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import React, { useRef, useState, useMemo, useEffect } from 'react';\r\nimport * as d3 from 'd3';\r\nimport { EcosystemActor, EcosystemConfiguration, AssemblageAnalysis, AiAbsenceAnalysis, AssemblageExplanation } from '@/types/ecosystem';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Network, MousePointer2, Layers, EyeOff, ChevronDown, Loader2, ZoomIn, Maximize, Minimize, MessageSquare, X, Trash2 } from 'lucide-react';\r\nimport { useForceGraph, SimulationNode } from '@/hooks/useForceGraph';\r\nimport { generateEdges } from '@/lib/graph-utils';\r\nimport { TranslationChain } from './TranslationChain';\r\nimport dynamic from 'next/dynamic';\r\nimport { StratumLegend, ViewTypeLegend } from './EcosystemLegends';\r\nimport { SWISS_COLORS, getActorColor, getActorShape, mergeGhostNodes, GhostActor } from '@/lib/ecosystem-utils';\r\n\r\nconst EcosystemMap3D = dynamic(() => import('./EcosystemMap3D').then(mod => mod.EcosystemMap3D), {\r\n    ssr: false,\r\n    loading: () => <div className=\"h-full flex items-center justify-center bg-slate-50 text-slate-400\">Loading 3D Engine...</div>\r\n});\r\n\r\nimport { AnalysisMode, ModeSelector } from '@/components/ui/mode-selector';\r\n\r\ninterface EcosystemMapProps {\r\n    actors: EcosystemActor[];\r\n    configurations: EcosystemConfiguration[];\r\n    positions?: Record<string, { x: number, y: number }>;\r\n    interactionMode: \"drag\" | \"select\";\r\n    setInteractionMode: (mode: \"drag\" | \"select\") => void;\r\n    selectedForGrouping: string[];\r\n    onToggleSelection: (actorId: string) => void;\r\n    onCreateConfiguration: () => void;\r\n    onActorDrag: (actorId: string, x: number, y: number) => void;\r\n    onConfigDrag: (configId: string, dx: number, dy: number) => void;\r\n    activeLayers?: Record<string, boolean>;\r\n    toggleLayer?: (layer: string) => void;\r\n    colorMode?: \"type\" | \"epistemic\";\r\n    onConfigClick?: (configId: string) => void;\r\n    selectedConfigId?: string | null;\r\n    onDeleteConfiguration?: (configId: string) => void;\r\n    absenceAnalysis?: AssemblageAnalysis | AiAbsenceAnalysis | null;\r\n    analysisMode?: AnalysisMode;\r\n    setAnalysisMode?: (mode: AnalysisMode) => void;\r\n    configLayout?: Record<string, { x: number; y: number }>;\r\n}\r\n\r\n// --- Swiss Design System Constants ---\r\n// Moved to @/lib/ecosystem-utils\r\n\r\nconst HULL_STYLES = {\r\n    opacity: 0.15,\r\n    strokeDash: \"6 4\",\r\n    strokeWidth: 2\r\n};\r\n\r\n// ... unchanged styles ...\r\n\r\nexport function EcosystemMap({\r\n    actors,\r\n    configurations,\r\n    interactionMode,\r\n    setInteractionMode,\r\n    selectedForGrouping,\r\n    onToggleSelection,\r\n    onCreateConfiguration,\r\n    onConfigClick,\r\n    onConfigDrag,\r\n    selectedConfigId,\r\n    onDeleteConfiguration,\r\n    absenceAnalysis,\r\n    analysisMode = \"hybrid_reflexive\",\r\n    setAnalysisMode,\r\n    configLayout = {}\r\n}: EcosystemMapProps) {\r\n    const [focusedNodeId, setFocusedNodeId] = useState<string | null>(null);\r\n    const [draggingNodeId, setDraggingNodeId] = useState<string | null>(null);\r\n    const [draggingConfigId, setDraggingConfigId] = useState<string | null>(null);\r\n    const svgRef = useRef<SVGSVGElement>(null);\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n    const zoomBehaviorRef = useRef<d3.ZoomBehavior<SVGSVGElement, unknown> | null>(null); // Ref for zoom behavior\r\n    const [dimensions, setDimensions] = useState({ width: 800, height: 800 });\r\n    const [isLegendOpen, setIsLegendOpen] = useState(false);\r\n    const [isNestedMode, setIsNestedMode] = useState(false);\r\n    const [isStratumMode, setIsStratumMode] = useState(false);\r\n    const [isFullScreen, setIsFullScreen] = useState(false);\r\n    const [is3DMode, setIs3DMode] = useState(false);\r\n\r\n    const [highlightedStage, setHighlightedStage] = useState<string | null>(null);\r\n\r\n    // Zoom/Pan State\r\n    const [transform, setTransform] = useState({ k: 1, x: 0, y: 0 });\r\n\r\n    // Merged Actors with Ghosts\r\n    const mergedActors = useMemo(() => {\r\n        return mergeGhostNodes(actors, absenceAnalysis || null);\r\n    }, [actors, absenceAnalysis]);\r\n\r\n    // Assemblage Explanation State\r\n    const [isExplaining, setIsExplaining] = useState(false);\r\n    const [explanation, setExplanation] = useState<AssemblageExplanation | null>(null);\r\n\r\n    const handleExplainMap = async () => {\r\n        setIsExplaining(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({\r\n                    analysisMode: 'assemblage_explanation', // Legacy required field\r\n                    mode: analysisMode, // NEW: Theoretical mode for backward compatible routing\r\n                    configurations: configurations, // Pass metrics implicitly via configs\r\n                    actors: mergedActors, // Pass actors for tracing\r\n                    links: links, // Pass links for tracing\r\n                    text: 'Assess Hull Metrics' // Dummy text\r\n                })\r\n            });\r\n            const data = await response.json();\r\n            if (data.analysis) {\r\n                setExplanation(data.analysis);\r\n                setIsLegendOpen(false); // Close legend to show explanation\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Explanation failed:\", error);\r\n        } finally {\r\n            setIsExplaining(false);\r\n        }\r\n    };\r\n\r\n    const isActorRelevant = (actor: EcosystemActor, stageId: string | null) => {\r\n        if (!stageId) return true;\r\n        const t = actor.type.toLowerCase();\r\n\r\n        switch (stageId) {\r\n            case 'problem':\r\n                return ['civilsociety', 'ngo', 'academic', 'activist', 'public'].some(k => t.includes(k));\r\n            case 'regulation':\r\n                return ['policymaker', 'government', 'legislator', 'regulator', 'court', 'legalobject', 'law'].some(k => t.includes(k));\r\n            case 'inscription':\r\n                return ['standard', 'algorithm', 'technologist', 'expert', 'scientist'].some(k => t.includes(k));\r\n            case 'delegation':\r\n                return ['auditor', 'cloud', 'infrastructure', 'compliance', 'legal'].some(k => t.includes(k));\r\n            case 'market':\r\n                return ['startup', 'private', 'corporation', 'sme', 'user'].some(k => t.includes(k));\r\n            default:\r\n                return true;\r\n        }\r\n    };\r\n\r\n    const links = useMemo(() => {\r\n        const generated = generateEdges(mergedActors);\r\n        return generated.map(e => ({\r\n            source: e.source.id,\r\n            target: e.target.id,\r\n            type: e.label\r\n        }));\r\n    }, [mergedActors]);\r\n\r\n    // Simplified Actor Hydration (No Simulation)\r\n    const hydratedActors = useMemo(() => {\r\n        return mergedActors;\r\n    }, [mergedActors]);\r\n\r\n    // Force Physics\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const { nodes, simulation, drag } = useForceGraph(\r\n        hydratedActors, // Use hydrated actors with dynamic power\r\n        dimensions.width,\r\n        dimensions.height,\r\n        configurations.map(c => ({ id: c.id, memberIds: c.memberIds })),\r\n        links,\r\n        isNestedMode,\r\n        is3DMode,\r\n        configLayout // Renamed internally in hook, but prop name can stay configLayout or be renamed. Let's send the prop as 'configOffsets' arg.\r\n    );\r\n\r\n    // Zoom Behavior Setup\r\n    useEffect(() => {\r\n        if (!svgRef.current) return;\r\n        const svg = d3.select(svgRef.current);\r\n\r\n        const zoom = d3.zoom<SVGSVGElement, unknown>()\r\n            .scaleExtent([0.1, 4])\r\n            .filter((event) => {\r\n                // Prevent zoom/pan if clicking on a draggable config or if button is not left click\r\n                if (event.target instanceof Element && event.target.closest('.draggable-config')) {\r\n                    return false;\r\n                }\r\n                return !event.button;\r\n            })\r\n            .on(\"zoom\", (event) => {\r\n                setTransform(event.transform);\r\n            });\r\n\r\n\r\n        zoomBehaviorRef.current = zoom; // Store in ref\r\n        const svgSelection = d3.select(svgRef.current);\r\n        svgSelection.call(zoom);\r\n\r\n        return () => {\r\n            svgSelection.on(\".zoom\", null);\r\n        };\r\n    }, [is3DMode]);\r\n\r\n    // Full Screen Escape Listener\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (e.key === \"Escape\" && isFullScreen) {\r\n                setIsFullScreen(false);\r\n            }\r\n        };\r\n        window.addEventListener(\"keydown\", handleKeyDown);\r\n        return () => window.removeEventListener(\"keydown\", handleKeyDown);\r\n    }, [isFullScreen]);\r\n\r\n\r\n    // Resize Observer\r\n    useEffect(() => {\r\n        if (!containerRef.current) return;\r\n        const resizeObserver = new ResizeObserver((entries: ResizeObserverEntry[]) => {\r\n            for (const entry of entries) {\r\n                setDimensions({\r\n                    width: entry.contentRect.width,\r\n                    height: entry.contentRect.height\r\n                });\r\n            }\r\n        });\r\n        resizeObserver.observe(containerRef.current);\r\n        return () => resizeObserver.disconnect();\r\n    }, []);\r\n\r\n\r\n\r\n    const getNodePos = (id: string) => {\r\n        const node = nodes.find(n => n.id === id);\r\n        return node ? { x: node.x || 0, y: node.y || 0 } : { x: 0, y: 0 };\r\n    };\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const handleMouseDown = (e: React.MouseEvent, node: SimulationNode) => {\r\n        e.stopPropagation(); // Prevent Zoom/Pan start\r\n        if (interactionMode === \"drag\") {\r\n            setDraggingNodeId(node.id);\r\n            drag(node).dragStarted({ active: true, x: node.x ?? 0, y: node.y ?? 0 });\r\n        }\r\n        // In select mode, we just consume the event so zoom doesn't start\r\n    };\r\n\r\n    const handleConfigMouseDown = (e: React.MouseEvent, configId: string) => {\r\n        e.stopPropagation();\r\n        if (interactionMode === \"drag\") {\r\n            setDraggingConfigId(configId);\r\n            // We don't use d3 drag behavior for configs, we just track delta in mouseMove\r\n        } else if (onConfigClick) {\r\n            onConfigClick(configId);\r\n        }\r\n    };\r\n\r\n    const handleNodeClick = (e: React.MouseEvent, actor: EcosystemActor) => {\r\n        e.stopPropagation();\r\n        if (interactionMode === \"select\") {\r\n            onToggleSelection(actor.id);\r\n        } else {\r\n            setFocusedNodeId(focusedNodeId === actor.id ? null : actor.id);\r\n        }\r\n    };\r\n\r\n    const getTransformedPoint = (clientX: number, clientY: number) => {\r\n        if (!svgRef.current) return { x: 0, y: 0 };\r\n        const svg = svgRef.current;\r\n        const pt = svg.createSVGPoint();\r\n        pt.x = clientX;\r\n        pt.y = clientY;\r\n        const svgP = pt.matrixTransform(svg.getScreenCTM()?.inverse());\r\n        return {\r\n            x: (svgP.x - transform.x) / transform.k,\r\n            y: (svgP.y - transform.y) / transform.k\r\n        };\r\n    };\r\n\r\n    const handleSvgMouseMove = (e: React.MouseEvent) => {\r\n        if (interactionMode !== \"drag\") return;\r\n\r\n        const worldP = getTransformedPoint(e.clientX, e.clientY);\r\n\r\n        if (draggingNodeId) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            const node = nodes.find(n => n.id === draggingNodeId);\r\n            if (node) drag(node).dragged({ x: worldP.x, y: worldP.y });\r\n        } else if (draggingConfigId && onConfigDrag) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            // Simple delta calculation requires previous mouse position, \r\n            // but since we don't store it, we can use movementX/Y and scale by transform.k\r\n            // However, movementX/Y is screen pixels.\r\n            const dx = e.movementX / transform.k;\r\n            const dy = e.movementY / transform.k;\r\n            onConfigDrag(draggingConfigId, dx, dy);\r\n        }\r\n    };\r\n\r\n    const handleMouseUp = () => {\r\n        if (draggingNodeId) {\r\n            const node = nodes.find(n => n.id === draggingNodeId);\r\n            if (node) drag(node).dragEnded({ active: false, x: 0, y: 0 });\r\n            setDraggingNodeId(null);\r\n        }\r\n        if (draggingConfigId) {\r\n            setDraggingConfigId(null);\r\n        }\r\n    };\r\n\r\n    // Zoom Controls\r\n    const resetZoom = () => {\r\n        if (!svgRef.current || !zoomBehaviorRef.current) return;\r\n        // Use the stored behavior to trigger the reset\r\n        d3.select(svgRef.current)\r\n            .transition()\r\n            .duration(750)\r\n            .call(zoomBehaviorRef.current.transform, d3.zoomIdentity);\r\n    };\r\n\r\n    const toggleFullScreen = () => {\r\n        setIsFullScreen(!isFullScreen);\r\n    };\r\n\r\n    const getHullPath = (points: { x: number, y: number }[]) => {\r\n        if (points.length < 3) return \"\";\r\n        points.sort((a, b) => a.x - b.x || a.y - b.y);\r\n        const cross = (o: { x: number, y: number }, a: { x: number, y: number }, b: { x: number, y: number }) => (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x);\r\n        const lower = [];\r\n        for (let i = 0; i < points.length; i++) {\r\n            while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], points[i]) <= 0) lower.pop();\r\n            lower.push(points[i]);\r\n        }\r\n        const upper = [];\r\n        for (let i = points.length - 1; i >= 0; i--) {\r\n            while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], points[i]) <= 0) upper.pop();\r\n            upper.push(points[i]);\r\n        }\r\n        upper.pop(); lower.pop();\r\n        const hull = lower.concat(upper);\r\n        return `M ${hull.map(p => `${p.x},${p.y}`).join(\" L \")} Z`;\r\n    };\r\n\r\n    // Standard Config Passthrough\r\n    const hydratedConfigs = useMemo(() => {\r\n        return configurations;\r\n    }, [configurations]);\r\n\r\n    const [hoveredNode, setHoveredNode] = useState<EcosystemActor | null>(null);\r\n    const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });\r\n\r\n    // Node Event Handlers\r\n    const handleNodeHover = (e: React.MouseEvent, actor: EcosystemActor) => {\r\n        const rect = containerRef.current?.getBoundingClientRect();\r\n        if (rect) {\r\n            setTooltipPos({\r\n                x: e.clientX - rect.left,\r\n                y: e.clientY - rect.top\r\n            });\r\n        }\r\n        setHoveredNode(actor);\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative w-full h-full\">\r\n            <Card\r\n                className={`flex flex-col shadow-none border border-slate-200 bg-white transition-all duration-300 relative ${isFullScreen ? 'fixed inset-0 z-50 h-screen w-screen rounded-none' : 'h-[800px]'}`}\r\n                ref={containerRef}\r\n            >\r\n                {/* ... (Header remains) */}\r\n                <CardHeader className=\"py-3 px-4 border-b border-slate-100 flex flex-row items-center justify-between bg-white z-10 relative\">\r\n                    <div>\r\n                        <CardTitle className=\"text-sm font-semibold text-slate-900 tracking-tight\">Assemblage Compass</CardTitle>\r\n                        <CardDescription className=\"text-xs text-slate-500 font-normal\">\r\n                            {is3DMode ? \"3D WebGL Visualization\" : (isNestedMode ? \"Nested Assemblage (Actor â†’ Collective â†’ Regime)\" : \"Hierarchical view of assemblage clusters\")}\r\n                        </CardDescription>\r\n                    </div>\r\n\r\n                    {/* Modern Toolbar */}\r\n                    <div className=\"flex items-center gap-1.5 bg-slate-50 p-1 rounded-md border border-slate-200\">\r\n                        <Button\r\n                            variant=\"ghost\" size=\"sm\"\r\n                            onClick={() => {\r\n                                const newMode = !is3DMode;\r\n                                setIs3DMode(newMode);\r\n                                if (newMode) setIsStratumMode(true);\r\n                            }}\r\n                            className={`h-7 px-2.5 text-xs font-medium ${is3DMode ? \"bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm\" : \"text-slate-500 hover:text-slate-900\"}`}\r\n                        >\r\n                            <Network className=\"h-3 w-3 mr-1\" /> {is3DMode ? \"3D View\" : \"2D View\"}\r\n                        </Button>\r\n\r\n                        {!is3DMode && (\r\n                            <>\r\n                                <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                                <Button\r\n                                    variant=\"ghost\" size=\"sm\"\r\n                                    onClick={() => setIsNestedMode(!isNestedMode)}\r\n                                    className={`h-7 px-2.5 text-xs font-medium ${isNestedMode ? \"bg-indigo-50 text-indigo-700 border border-indigo-200\" : \"text-slate-500 hover:text-slate-900\"}`}\r\n                                >\r\n                                    <Layers className=\"h-3 w-3 mr-1\" /> {isNestedMode ? \"Nested Map\" : \"Force Layout\"}\r\n                                </Button>\r\n                                <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                                <Button\r\n                                    variant=\"ghost\" size=\"sm\"\r\n                                    className={`h-7 px-2.5 text-xs font-medium ${interactionMode === \"drag\" ? \"bg-white text-slate-900 shadow-sm\" : \"text-slate-500 hover:text-slate-900\"}`}\r\n                                    onClick={() => setInteractionMode(\"drag\")}\r\n                                >\r\n                                    <MousePointer2 className=\"h-3 w-3 mr-1\" /> Move Actor\r\n                                </Button>\r\n                                <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                                <Button\r\n                                    variant=\"ghost\" size=\"sm\"\r\n                                    className=\"h-7 px-2.5 text-xs font-medium text-slate-500 hover:text-slate-900\"\r\n                                    onClick={resetZoom}\r\n                                >\r\n                                    <ZoomIn className=\"h-3 w-3 mr-1\" /> Reset View\r\n                                </Button>\r\n                            </>\r\n                        )}\r\n\r\n                        {is3DMode && (\r\n                            <>\r\n                                <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                                <Button\r\n                                    variant=\"ghost\" size=\"sm\"\r\n                                    onClick={() => setIsStratumMode(!isStratumMode)}\r\n                                    className={`h-7 px-2.5 text-xs font-medium ${isStratumMode ? \"bg-indigo-50 text-indigo-700 border border-indigo-200\" : \"text-slate-500 hover:text-slate-900\"}`}\r\n                                    title=\"Visualize Law as a Stratum over the Meshwork\"\r\n                                >\r\n                                    <Layers className=\"h-3 w-3 mr-1\" /> {isStratumMode ? \"Stratum Active\" : \"Legal Stratum\"}\r\n                                </Button>\r\n                            </>\r\n                        )}\r\n\r\n                        <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n\r\n                        {/* Integrated Mode Selector */}\r\n                        {analysisMode && setAnalysisMode && (\r\n                            <>\r\n                                <div className=\"flex items-center scale-90 origin-center -mx-1\">\r\n                                    <ModeSelector\r\n                                        value={analysisMode}\r\n                                        onChange={setAnalysisMode}\r\n                                        className=\"h-7 border-none shadow-none text-xs\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                            </>\r\n                        )}\r\n\r\n                        <Button\r\n                            variant=\"ghost\" size=\"sm\"\r\n                            className={`h-7 px-2.5 text-xs font-medium text-slate-500 hover:text-indigo-600 ${isExplaining ? \"animate-pulse\" : \"\"}`}\r\n                            onClick={handleExplainMap}\r\n                            disabled={isExplaining}\r\n                        >\r\n                            {isExplaining ? <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" /> : <MessageSquare className=\"h-3 w-3 mr-1\" />}\r\n                            {isExplaining ? \"Analyzing...\" : \"Explain Map\"}\r\n                        </Button>\r\n                        <div className=\"w-px h-3 bg-slate-300 mx-0.5\" />\r\n                        <Button\r\n                            variant=\"ghost\" size=\"sm\"\r\n                            className={`h-7 px-2.5 text-xs font-medium ${isFullScreen ? \"bg-red-50 text-red-600\" : \"text-slate-500 hover:text-slate-900\"}`}\r\n                            onClick={toggleFullScreen}\r\n                        >\r\n                            {isFullScreen ? (\r\n                                <><Minimize className=\"h-3 w-3 mr-1\" /> Exit Full Screen</>\r\n                            ) : (\r\n                                <><Maximize className=\"h-3 w-3 mr-1\" /> Full Screen</>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </CardHeader>\r\n\r\n                <CardContent className=\"flex-1 p-0 relative overflow-hidden bg-[#FAFAFA]\">\r\n                    {/* ... (Existing Map Content) ... */}\r\n                    {is3DMode ? (\r\n                        <EcosystemMap3D\r\n                            actors={actors}\r\n                            configurations={configurations}\r\n                            selectedForGrouping={selectedForGrouping}\r\n                            onToggleSelection={onToggleSelection}\r\n                            focusedNodeId={focusedNodeId}\r\n                            width={dimensions.width}\r\n                            height={dimensions.height}\r\n                            isStratumMode={isStratumMode}\r\n                        />\r\n                    ) : (\r\n                        <>\r\n                            {/* ... (SVG Content) ... */}\r\n                            <svg\r\n                                ref={svgRef}\r\n                                width=\"100%\" height=\"100%\"\r\n                                className=\"cursor-move\"\r\n                                onMouseMove={handleSvgMouseMove}\r\n                                onMouseUp={handleMouseUp}\r\n                                onMouseLeave={handleMouseUp}\r\n                                style={{ fontFamily: 'Inter, sans-serif' }}\r\n                            >\r\n                                {/* ... (Defs, G, Hulls, Links, Nodes) ... */}\r\n                                <defs>\r\n                                    <marker id=\"arrow\" viewBox=\"0 0 10 10\" refX=\"20\" refY=\"5\"\r\n                                        markerWidth=\"6\" markerHeight=\"6\" orient=\"auto-start-reverse\">\r\n                                        <path d=\"M 0 0 L 10 5 L 0 10 z\" fill=\"#94A3B8\" />\r\n                                    </marker>\r\n                                </defs>\r\n\r\n                                <g transform={`translate(${transform.x},${transform.y}) scale(${transform.k})`}>\r\n                                    {isNestedMode && (\r\n                                        <g className=\"opacity-0 animate-in fade-in duration-1000 pointer-events-none\">\r\n                                            <circle cx={dimensions.width / 2} cy={dimensions.height / 2} r={Math.min(dimensions.width, dimensions.height) * 0.45} fill=\"none\" stroke=\"#E2E8F0\" strokeWidth=\"2\" strokeDasharray=\"8 8\" />\r\n                                            <text x={dimensions.width / 2} y={dimensions.height / 2 - Math.min(dimensions.width, dimensions.height) * 0.45 - 10} textAnchor=\"middle\" className=\"text-[10px] font-bold fill-slate-400 uppercase tracking-[0.2em]\">Governance Regime Boundary</text>\r\n                                            <circle cx={dimensions.width / 2} cy={dimensions.height / 2} r={10} fill=\"#6366F1\" opacity=\"0.1\" />\r\n                                            <text x={dimensions.width / 2} y={dimensions.height / 2} dy={3} textAnchor=\"middle\" className=\"text-[6px] font-bold fill-indigo-400 uppercase\">Policy</text>\r\n                                        </g>\r\n                                    )}\r\n\r\n                                    {hydratedConfigs.map((config: EcosystemConfiguration) => {\r\n                                        const memberPoints = config.memberIds.map((id: string) => getNodePos(id)).filter((p: { x: number; y: number }) => p.x !== 0 && p.y !== 0);\r\n                                        if (memberPoints.length < 2) return null;\r\n                                        const centroid = memberPoints.reduce((acc: { x: number; y: number }, p: { x: number; y: number }) => ({ x: acc.x + p.x, y: acc.y + p.y }), { x: 0, y: 0 });\r\n                                        centroid.x /= memberPoints.length;\r\n                                        centroid.y /= memberPoints.length;\r\n                                        const porosity = config.properties.porosity_index || 0;\r\n                                        const strokeDash = porosity > 0.6 ? \"6 4\" : (porosity > 0.3 ? \"10 2\" : \"none\");\r\n                                        const stability = config.properties.calculated_stability || 0.1;\r\n                                        const isConfigSelected = selectedConfigId === config.id;\r\n                                        const fillOpacity = isConfigSelected ? 0.3 : Math.max(0.05, Math.min(0.3, stability * 0.4));\r\n                                        return (\r\n                                            <g key={config.id} className={`draggable-config transition-all duration-500 ease-out ${interactionMode === 'drag' ? 'cursor-move' : 'cursor-pointer'}`} opacity={highlightedStage ? 0.1 : 1} onMouseDown={(e) => handleConfigMouseDown(e, config.id)}>\r\n                                                <path\r\n                                                    d={memberPoints.length === 2 ? `M ${memberPoints[0].x} ${memberPoints[0].y} L ${memberPoints[1].x} ${memberPoints[1].y}` : getHullPath(memberPoints)}\r\n                                                    fill={config.color} fillOpacity={fillOpacity} stroke={config.color} strokeWidth={isConfigSelected ? 3 : HULL_STYLES.strokeWidth} strokeDasharray={strokeDash} strokeLinejoin=\"round\" strokeLinecap=\"round\"\r\n                                                    className={isConfigSelected ? \"drop-shadow-md\" : \"\"}\r\n                                                />\r\n                                                <rect x={centroid.x - (config.name.length * 3 + 8)} y={centroid.y - 32} width={config.name.length * 6 + 16} height={18} rx={9} fill={config.color} fillOpacity={0.9} stroke=\"white\" strokeWidth={1.5} className=\"drop-shadow-sm\" />\r\n                                                <text x={centroid.x} y={centroid.y - 20} textAnchor=\"middle\" dominantBaseline=\"middle\" className=\"text-[10px] font-bold fill-white uppercase tracking-wider\" style={{ pointerEvents: 'none' }}>{config.name}</text>\r\n                                            </g>\r\n                                        );\r\n                                    })}\r\n\r\n                                    {links.map((link, i) => {\r\n                                        const s = getNodePos(link.source as string);\r\n                                        const t = getNodePos(link.target as string);\r\n                                        if (s.x === 0 || t.x === 0) return null;\r\n                                        const isFocused = focusedNodeId && (link.source === focusedNodeId || link.target === focusedNodeId);\r\n                                        let strokeWidth = 1;\r\n                                        if (link.type === \"Regulates\" || link.type === \"Governs\") strokeWidth = 2.5;\r\n                                        if (link.type === \"Excludes\") strokeWidth = 1.5;\r\n                                        if (isFocused) strokeWidth += 1;\r\n                                        return <line key={i} x1={s.x} y1={s.y} x2={t.x} y2={t.y} stroke={isFocused ? \"#64748B\" : \"#CBD5E1\"} strokeWidth={strokeWidth} strokeOpacity={highlightedStage ? 0.1 : (isFocused ? 0.9 : 0.5)} strokeDasharray={link.type === \"Excludes\" || link.type === \"Extracts\" ? \"4 4\" : \"none\"} markerEnd={!highlightedStage ? \"url(#arrow)\" : \"\"} className=\"transition-all duration-300\" pointerEvents=\"none\" />;\r\n                                    })}\r\n\r\n                                    {nodes.map((node: SimulationNode) => {\r\n                                        const actor = hydratedActors.find((a: EcosystemActor) => a.id === node.id);\r\n                                        if (!actor) return null;\r\n                                        const color = getActorColor(actor.type);\r\n                                        const isSelected = selectedForGrouping.includes(actor.id);\r\n                                        const isFocused = focusedNodeId === actor.id;\r\n                                        const isRelevant = isActorRelevant(actor, highlightedStage);\r\n                                        const isGhost = 'isGhost' in actor ? (actor as EcosystemActor & { isGhost?: boolean }).isGhost : false;\r\n                                        let opacity = highlightedStage ? (isRelevant ? 1 : 0.1) : 1;\r\n                                        if (isGhost) opacity *= 0.6;\r\n                                        const scale = highlightedStage && isRelevant ? 1.2 : 1;\r\n                                        const power = actor.metrics?.dynamic_power || 0;\r\n                                        const baseR = 5 + (power * 1.5);\r\n                                        const r = isFocused || isSelected ? baseR + 2 : baseR;\r\n                                        const strokeDash = isGhost ? \"3 2\" : \"none\";\r\n                                        return (\r\n                                            <g key={node.id} transform={`translate(${node.x},${node.y}) scale(${scale})`} onMouseDown={(e) => handleMouseDown(e, node)} onMouseEnter={(e) => handleNodeHover(e, actor)} onMouseLeave={() => setHoveredNode(null)} onClick={(e) => handleNodeClick(e, actor)} className=\"group cursor-pointer\" style={{ transition: 'transform 0.2s ease-out, opacity 0.2s ease-out', opacity }}>\r\n                                                {isSelected && (getActorShape(actor.type) === 'square' ? <rect x={-r - 4} y={-r - 4} width={(r + 4) * 2} height={(r + 4) * 2} fill=\"none\" stroke={color} strokeWidth={2} opacity={0.5} /> : getActorShape(actor.type) === 'triangle' ? <polygon points={`0,${-r - 6} ${r + 6},${r + 4} ${-r - 6},${r + 4}`} fill=\"none\" stroke={color} strokeWidth={2} opacity={0.5} /> : getActorShape(actor.type) === 'rect' ? <rect x={-(r + 6)} y={-(r + 4)} width={(r + 6) * 2} height={(r + 4) * 2} fill=\"none\" stroke={color} strokeWidth={2} opacity={0.5} /> : <circle r={r + 4} fill=\"none\" stroke={color} strokeWidth={2} opacity={0.5} />)}\r\n                                                {getActorShape(actor.type) === 'square' ? <rect x={-r} y={-r} width={r * 2} height={r * 2} fill={isGhost ? \"white\" : color} className=\"drop-shadow-sm transition-all duration-200\" stroke={color} strokeWidth={1.5} strokeDasharray={strokeDash} /> : getActorShape(actor.type) === 'triangle' ? <polygon points={`0,${-r - 2} ${r + 2},${r + 2} ${-r - 2},${r + 2}`} fill={isGhost ? \"white\" : color} className=\"drop-shadow-sm transition-all duration-200\" stroke={color} strokeWidth={1.5} strokeDasharray={strokeDash} /> : getActorShape(actor.type) === 'rect' ? <rect x={-(r + 2)} y={-r} width={(r + 2) * 2} height={r * 2} fill={isGhost ? \"white\" : color} className=\"drop-shadow-sm transition-all duration-200\" stroke={color} strokeWidth={1.5} strokeDasharray={strokeDash} /> : <circle r={r} fill={isGhost ? \"white\" : color} className=\"drop-shadow-sm transition-all duration-200\" stroke={color} strokeWidth={1.5} strokeDasharray={strokeDash} />}\r\n                                                <foreignObject x=\"8\" y=\"-10\" width=\"150\" height=\"24\" className=\"overflow-visible pointer-events-none\">\r\n                                                    <div className={`flex items-center px-1.5 py-0.5 rounded-sm bg-slate-100/90 border border-slate-200 backdrop-blur-[1px] transform transition-opacity duration-200 ${(focusedNodeId && !isFocused) || (highlightedStage && !isRelevant) ? \"opacity-20\" : \"opacity-100\"}`}>\r\n                                                        <span className={`text-[10px] whitespace-nowrap font-medium leading-none ${isGhost ? \"text-slate-400 italic\" : \"text-slate-700\"}`}>{actor.name} {isGhost && \"(Missing)\"}</span>\r\n                                                    </div>\r\n                                                </foreignObject>\r\n                                            </g>\r\n                                        );\r\n                                    })}\r\n                                </g>\r\n                            </svg>\r\n\r\n                            {/* EXPLANATION OVERLAY */}\r\n                            {explanation && (\r\n                                <div className=\"absolute top-16 right-4 left-4 sm:left-auto sm:w-96 bg-white/95 backdrop-blur-md shadow-xl border border-slate-200 rounded-lg overflow-hidden animate-in slide-in-from-top-5 duration-300 z-50\">\r\n                                    <div className=\"bg-slate-50 border-b border-slate-100 p-3 flex justify-between items-center\">\r\n                                        <h3 className=\"text-sm font-semibold text-slate-800 flex items-center gap-2\">\r\n                                            <MessageSquare className=\"h-4 w-4 text-indigo-500\" />\r\n                                            {analysisMode === 'ant_trace' ? 'ANT Trace Analysis' :\r\n                                                analysisMode === 'hybrid_reflexive' ? 'Hybrid Reflexive Analysis' :\r\n                                                    'Assemblage Analysis'}\r\n                                        </h3>\r\n                                        <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 text-slate-400 hover:text-red-500\" onClick={() => setExplanation(null)}>\r\n                                            <X className=\"h-4 w-4\" />\r\n                                        </Button>\r\n                                    </div>\r\n                                    <div className=\"p-4 max-h-[60vh] overflow-y-auto\">\r\n                                        <p className=\"text-sm text-slate-600 leading-relaxed mb-4\">{explanation.narrative}</p>\r\n\r\n                                        <div className=\"space-y-3\">\r\n                                            {(explanation.hulls || []).map((hull, i: number) => (\r\n                                                <div key={i} className=\"bg-slate-50 rounded-md p-3 border border-slate-100\">\r\n                                                    <div className=\"flex justify-between items-start mb-1\">\r\n                                                        <span className=\"font-medium text-xs text-slate-900\">{hull.id.replace('config-', '')}</span>\r\n                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-full font-medium ${hull.classification === 'Fortress' ? 'bg-red-100 text-red-700' :\r\n                                                            hull.classification === 'Sieve' ? 'bg-orange-100 text-orange-700' :\r\n                                                                'bg-blue-100 text-blue-700'\r\n                                                            }`}>{hull.classification}</span>\r\n                                                    </div>\r\n                                                    <p className=\"text-xs text-slate-500\">{hull.interpretation}</p>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* SELECTION CONTEXT MENU (New) */}\r\n                            {selectedForGrouping.length > 0 && (\r\n                                <div className=\"absolute top-16 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur-md shadow-xl border border-indigo-200 rounded-lg p-2 z-40 animate-in slide-in-from-top-2 flex items-center gap-3\">\r\n                                    <div className=\"flex items-center gap-2 pl-2 border-r border-slate-200 pr-3\">\r\n                                        <div className=\"bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded-full\">\r\n                                            {selectedForGrouping.length}\r\n                                        </div>\r\n                                        <span className=\"text-xs font-medium text-slate-600\">Selected</span>\r\n                                    </div>\r\n                                    <Button\r\n                                        size=\"sm\"\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation();\r\n                                            onCreateConfiguration();\r\n                                        }}\r\n                                        className=\"h-7 text-xs bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm\"\r\n                                    >\r\n                                        <Layers className=\"h-3 w-3 mr-1.5\" />\r\n                                        Create Configuration\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant=\"ghost\"\r\n                                        size=\"icon\"\r\n                                        onClick={() => {\r\n                                            selectedForGrouping.forEach(id => onToggleSelection(id));\r\n                                        }}\r\n                                        className=\"h-7 w-7 text-slate-400 hover:text-red-600 hover:bg-red-50\"\r\n                                        title=\"Clear Selection\"\r\n                                    >\r\n                                        <X className=\"h-4 w-4\" />\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Floating Legend Card (Existing) */}\r\n                            {isLegendOpen && (\r\n                                <div className=\"absolute top-4 right-4 bg-white/95 backdrop-blur-sm border border-slate-200 rounded-lg shadow-sm p-3 w-48 text-xs z-10 max-h-[600px] overflow-y-auto\">\r\n                                    <div className=\"flex justify-between items-center mb-2 pb-1 border-b border-slate-100\">\r\n                                        <span className=\"font-semibold text-slate-800\">Actant Types</span>\r\n                                        <Button variant=\"ghost\" size=\"icon\" className=\"h-4 w-4 text-slate-400\" onClick={() => setIsLegendOpen(false)}>\r\n                                            <ChevronDown className=\"h-3 w-3\" />\r\n                                        </Button>\r\n                                    </div>\r\n                                    <div className=\"grid grid-cols-1 gap-1.5\">\r\n                                        {Object.entries(SWISS_COLORS).filter(([k]) => k !== 'default').map(([key, color]) => (\r\n                                            <div key={key} className=\"flex items-center gap-2\">\r\n                                                <div className=\"w-2.5 h-2.5 rounded-full shadow-sm ring-1 ring-black/5\" style={{ backgroundColor: color }} />\r\n                                                <span className=\"capitalize text-slate-600\">{key.replace(\"civilsociety\", \"Civil Society\")}</span>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n\r\n\r\n                                    {/* Macro Assemblages Legend */}\r\n\r\n                                    {/* Macro Assemblages Legend */}\r\n                                    {configurations.length > 0 && (\r\n                                        <div className=\"mt-3 pt-2 border-t border-slate-100\">\r\n                                            <p className=\"font-semibold text-slate-800 mb-2\">Macro Assemblages</p>\r\n                                            <div className=\"space-y-1.5\">\r\n                                                {configurations.map(config => (\r\n                                                    <div key={config.id} className=\"flex items-center gap-2 group justify-between p-1 rounded hover:bg-slate-50 cursor-pointer\" onClick={() => onConfigClick?.(config.id)}>\r\n                                                        <div className=\"flex items-center gap-2 overflow-hidden\">\r\n                                                            <div\r\n                                                                className=\"w-3 h-3 rounded-sm shadow-sm ring-1 ring-black/5 opacity-80 shrink-0\"\r\n                                                                style={{ backgroundColor: config.color }}\r\n                                                            />\r\n                                                            <span className=\"text-slate-600 truncate text-[10px] group-hover:text-slate-900 transition-colors\">{config.name}</span>\r\n                                                        </div>\r\n                                                        {onDeleteConfiguration && (\r\n                                                            <Button\r\n                                                                variant=\"ghost\"\r\n                                                                size=\"icon\"\r\n                                                                className=\"h-4 w-4 opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all ml-1\"\r\n                                                                onClick={(e) => {\r\n                                                                    e.stopPropagation();\r\n                                                                    if (confirm(`Delete configuration \"${config.name}\"?`)) {\r\n                                                                        onDeleteConfiguration(config.id);\r\n                                                                    }\r\n                                                                }}\r\n                                                                title=\"Delete Configuration\"\r\n                                                            >\r\n                                                                <Trash2 className=\"h-3 w-3\" />\r\n                                                            </Button>\r\n                                                        )}\r\n                                                    </div>\r\n                                                ))}\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <div className=\"mt-3 pt-2 border-t border-slate-100 text-[10px] text-slate-500\">\r\n                                        <p className=\"mb-1\"><span className=\"font-bold\">â”€</span> Line Thickness: Connectivity</p>\r\n                                        <p><span className=\"font-bold\">â—</span> Node Size: Translation Strength</p>\r\n                                        <p><span className=\"font-bold\">- -</span> Absent / Virtual (Ghost)</p>\r\n                                    </div>\r\n\r\n                                    {/* Hull Style Legend */}\r\n                                    <div className=\"mt-3 pt-2 border-t border-slate-100\">\r\n                                        <p className=\"font-semibold text-slate-800 mb-2\">Boundary Strength</p>\r\n                                        <div className=\"space-y-2 text-[10px] text-slate-500\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <div className=\"w-6 h-3 border-2 border-slate-300 bg-slate-100/50 rounded-sm\"></div>\r\n                                                <span>Solid: Stable/Closed</span>\r\n                                            </div>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <div className=\"w-6 h-3 border-2 border-slate-300 border-dashed bg-slate-100/20 rounded-sm\"></div>\r\n                                                <span>Dashed: Porous/Open</span>\r\n                                            </div>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <div className=\"w-3 h-3 bg-slate-400 rounded-sm\"></div>\r\n                                                <span>Darker: High Density</span>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* ... (Close Legend Button) ... */}\r\n                            {!isLegendOpen && (\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    size=\"sm\"\r\n                                    className=\"absolute top-4 right-4 h-8 bg-white shadow-sm text-xs\"\r\n                                    onClick={() => setIsLegendOpen(true)}\r\n                                >\r\n                                    Show Legend\r\n                                </Button>\r\n                            )}\r\n\r\n                            {focusedNodeId && (\r\n                                <div className=\"absolute bottom-4 left-4\">\r\n                                    <Button\r\n                                        variant=\"secondary\"\r\n                                        size=\"sm\"\r\n                                        className=\"text-xs shadow-sm bg-white hover:bg-slate-50 border border-slate-200\"\r\n                                        onClick={() => setFocusedNodeId(null)}\r\n                                    >\r\n                                        <EyeOff className=\"h-3 w-3 mr-1.5 text-slate-500\" /> Reset Focus\r\n                                    </Button>\r\n                                </div>\r\n                            )}\r\n\r\n                            {hoveredNode && (\r\n                                <div\r\n                                    className=\"absolute z-50 pointer-events-none\"\r\n                                    style={{\r\n                                        left: tooltipPos.x + 10,\r\n                                        top: tooltipPos.y + 10,\r\n                                    }}\r\n                                >\r\n                                    <div className=\"bg-slate-900/90 backdrop-blur-md text-slate-50 text-xs px-3 py-2 rounded-md shadow-lg border border-slate-700 max-w-[250px] animate-in fade-in zoom-in-95 duration-200\">\r\n                                        <div className=\"font-semibold mb-0.5 flex items-center gap-2\">\r\n                                            {(hoveredNode as GhostActor).isGhost && (\r\n                                                <span className=\"w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse\" />\r\n                                            )}\r\n                                            {hoveredNode.name}\r\n                                        </div>\r\n                                        <div className=\"text-slate-400 text-[10px] mb-1\">{hoveredNode.type}</div>\r\n                                        {hoveredNode.description && (\r\n                                            <div className=\"text-slate-300 border-t border-slate-700/50 pt-1 mt-1 leading-relaxed\">\r\n                                                {(hoveredNode as GhostActor).isGhost ? `MISSING: ${hoveredNode.description}` : hoveredNode.description}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {isNestedMode && (\r\n                                <div className=\"animate-in slide-in-from-bottom-5 duration-700\">\r\n                                    <TranslationChain\r\n                                        actors={actors}\r\n                                        onHoverStage={setHighlightedStage}\r\n                                    />\r\n                                </div>\r\n                            )}\r\n\r\n                        </>\r\n                    )}\r\n\r\n                    {is3DMode && isStratumMode && <StratumLegend />}\r\n                    {is3DMode && !isStratumMode && <ViewTypeLegend />}\r\n                </CardContent>\r\n            </Card >\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\EcosystemMap3D.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useMemo' is defined but never used.","line":3,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":32},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":90,"column":1,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":90,"endColumn":14,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2668,2681],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2963,2966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2963,2966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4400,4403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4400,4403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4463,4466],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4463,4466],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\EcosystemMap3D.tsx:193:9\n  191 |         });\n  192 |\n> 193 |         setGraphData({ nodes, links });\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  194 |     }, [actors, configurations, selectedForGrouping, isStratumMode]);\n  195 |\n  196 |     // Focus link camera behavior","line":193,"column":9,"nodeType":null,"endLine":193,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7683,7686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7683,7686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":235,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8048,8051],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8048,8051],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":242,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":242,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8418,8421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8418,8421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":255,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9267,9270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9267,9270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11149,11152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11149,11152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":308,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":308,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11919,11922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11919,11922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useRef, useMemo, useEffect, useState } from 'react';\r\nimport { EcosystemActor, EcosystemConfiguration } from '@/types/ecosystem';\r\nimport dynamic from 'next/dynamic';\r\nimport * as THREE from 'three';\r\nimport { getActorColor } from '@/lib/ecosystem-utils';\r\n\r\n// Dynamically import ForceGraph3D because it uses window/WEBGL which is client-side only\r\nconst ForceGraph3D = dynamic(() => import('react-force-graph-3d'), {\r\n    ssr: false,\r\n    loading: () => <div className=\"flex items-center justify-center h-full text-slate-400\">Loading 3D Engine...</div>\r\n});\r\n\r\ninterface EcosystemMap3DProps {\r\n    actors: EcosystemActor[];\r\n    configurations: EcosystemConfiguration[];\r\n    selectedForGrouping: string[];\r\n    onToggleSelection: (actorId: string) => void;\r\n    focusedNodeId: string | null;\r\n    width: number;\r\n    height: number;\r\n    isStratumMode: boolean;\r\n}\r\n\r\n\r\n\r\n// --- Types ---\r\ninterface GraphNode {\r\n    id: string;\r\n    name: string;\r\n    type: string;\r\n    val: number;\r\n    color: string;\r\n    isConfiguration: boolean;\r\n    x?: number; actor?: EcosystemActor;\r\n    y?: number;\r\n    z?: number;\r\n}\r\n\r\ninterface GraphLink {\r\n    source: string | GraphNode;\r\n    target: string | GraphNode;\r\n    type: \"Strong\" | \"Porous\" | \"LabelTether\" | \"Standard\";\r\n    color?: string;\r\n    label?: string;\r\n    distance?: number;\r\n}\r\n\r\n// --- Helper: Create Text Sprite for Labels ---\r\nconst createTextSprite = (text: string, color: string, fontSize: number = 24) => {\r\n    if (typeof document === 'undefined') return new THREE.Mesh();\r\n\r\n    const canvas = document.createElement('canvas');\r\n    const context = canvas.getContext('2d');\r\n    if (!context) return new THREE.Mesh();\r\n\r\n    const font = `Bold ${fontSize}px Inter, sans-serif`;\r\n    context.font = font;\r\n\r\n    // Measure\r\n    const metrics = context.measureText(text);\r\n    const textWidth = metrics.width;\r\n\r\n    // Resize canvas\r\n    canvas.width = textWidth + 20;\r\n    canvas.height = fontSize + 20;\r\n\r\n    // Background Pill\r\n    context.font = font;\r\n    context.fillStyle = color;\r\n    context.beginPath();\r\n    context.roundRect(0, 0, canvas.width, canvas.height, 10);\r\n    context.fill();\r\n\r\n    // Text\r\n    context.fillStyle = 'white';\r\n    context.textAlign = 'center';\r\n    context.textBaseline = 'middle';\r\n    context.fillText(text, canvas.width / 2, canvas.height / 2);\r\n\r\n    const texture = new THREE.CanvasTexture(canvas);\r\n    const material = new THREE.SpriteMaterial({ map: texture, transparent: true });\r\n    const sprite = new THREE.Sprite(material);\r\n\r\n    sprite.scale.set(textWidth / 4, (fontSize + 10) / 4, 1);\r\n    return sprite;\r\n};\r\n\r\n// @ts-ignore\r\n// import { forceZ } from 'd3-force-3d'; // Removed broken import\r\n\r\n\r\n\r\n// ... (existing imports)\r\n\r\nexport function EcosystemMap3D({ actors, configurations, selectedForGrouping, onToggleSelection, width, height, isStratumMode }: EcosystemMap3DProps) {\r\n    const fgRef = useRef<any>(null);\r\n    const [graphData, setGraphData] = useState<{ nodes: GraphNode[], links: GraphLink[] }>({ nodes: [], links: [] });\r\n    const [selectedLink, setSelectedLink] = useState<GraphLink | null>(null);\r\n\r\n\r\n\r\n    useEffect(() => {\r\n        // 1. Map real actors\r\n        // ... (rest of existing useEffect)\r\n\r\n        // Define vertical layers helper\r\n        const getZLevel = (type: string) => {\r\n            const t = type.toLowerCase();\r\n            if (t === 'legalobject' || t === 'law' || t === 'regulation') return 150;\r\n            if (t === 'policymaker' || t === 'government') return 80;\r\n            if (t === 'civilsociety' || t === 'academic') return 20;\r\n            if (t === 'startup' || t === 'private') return -40;\r\n            if (t === 'algorithmicagent' || t === 'algorithm') return -80;\r\n            if (t === 'infrastructure') return -120;\r\n            return 0;\r\n        };\r\n\r\n        const nodes: GraphNode[] = actors.map(actor => {\r\n            const baseNode = {\r\n                id: actor.id,\r\n                name: actor.name,\r\n                type: actor.type,\r\n                val: selectedForGrouping.includes(actor.id) ? 20 : 10,\r\n                color: getActorColor(actor.type),\r\n                isConfiguration: false,\r\n                actor: actor\r\n            };\r\n\r\n            // Apply Stratum Logic directly during creation\r\n            if (isStratumMode) {\r\n                (baseNode as any).fz = getZLevel(actor.type);\r\n                (baseNode as any).z = getZLevel(actor.type); // Set initial Z too to prevent flying\r\n            }\r\n\r\n            return baseNode;\r\n        });\r\n\r\n        // 2. Generate Links\r\n        const links: GraphLink[] = [];\r\n\r\n        actors.forEach((source, i) => {\r\n            actors.forEach((target, j) => {\r\n                if (i >= j) return;\r\n\r\n                const sharedConfig = configurations.find(c => c.memberIds.includes(source.id) && c.memberIds.includes(target.id));\r\n\r\n                if (sharedConfig) {\r\n                    links.push({\r\n                        source: source.id,\r\n                        target: target.id,\r\n                        type: \"Strong\",\r\n                        color: sharedConfig.color,\r\n                        label: sharedConfig.name\r\n                    });\r\n                } else if (source.type === target.type && Math.random() > 0.9) {\r\n                    links.push({\r\n                        source: source.id,\r\n                        target: target.id,\r\n                        type: \"Porous\",\r\n                        color: \"#CBD5E1\"\r\n                    });\r\n                }\r\n            });\r\n        });\r\n\r\n        // 3. Add \"Configuration Label\" Nodes\r\n        configurations.forEach(config => {\r\n            const labelNodeId = `config-${config.id}`;\r\n            nodes.push({\r\n                id: labelNodeId,\r\n                name: config.name,\r\n                type: 'Configuration',\r\n                val: 5,\r\n                color: config.color,\r\n                isConfiguration: true\r\n            });\r\n\r\n            config.memberIds.forEach(memberId => {\r\n                if (actors.find(a => a.id === memberId)) {\r\n                    links.push({\r\n                        source: labelNodeId,\r\n                        target: memberId,\r\n                        type: \"LabelTether\",\r\n                        color: \"transparent\",\r\n                        distance: 50\r\n                    });\r\n                }\r\n            });\r\n        });\r\n\r\n        setGraphData({ nodes, links });\r\n    }, [actors, configurations, selectedForGrouping, isStratumMode]);\r\n\r\n    // Focus link camera behavior\r\n    const focusLink = (link: GraphLink) => {\r\n        const source = link.source as GraphNode;\r\n        const target = link.target as GraphNode;\r\n        if (!source.x || !target.x) return;\r\n\r\n        const mx = (source.x! + target.x!) / 2;\r\n        const my = (source.y! + target.y!) / 2;\r\n        const mz = (source.z! + target.z!) / 2;\r\n\r\n        const dist = 50;\r\n        fgRef.current?.cameraPosition(\r\n            { x: mx + dist, y: my + dist, z: mz + dist },\r\n            { x: mx, y: my, z: mz },\r\n            1000\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div style={{ width: '100%', height: '100%', overflow: 'hidden', position: 'relative' }}>\r\n            <ForceGraph3D\r\n                ref={fgRef}\r\n                width={width}\r\n                height={height}\r\n                graphData={graphData}\r\n                nodeLabel=\"name\"\r\n                nodeColor=\"color\"\r\n                nodeResolution={16}\r\n                nodeOpacity={0.9}\r\n                backgroundColor=\"#FAFAFA\"\r\n\r\n                // Link Styling\r\n                linkWidth={(link: any) => {\r\n                    const l = link as GraphLink;\r\n                    if (l.type === \"LabelTether\") return 0; // Invisible\r\n                    if (l === selectedLink) return 3; // Highlight selected\r\n                    if (l.type === \"Strong\") return 2;\r\n                    return 0.5; // Porous\r\n                }}\r\n                linkColor={(link: any) => {\r\n                    const l = link as GraphLink;\r\n                    if (l.type === \"LabelTether\") return 'rgba(0,0,0,0)';\r\n                    if (l === selectedLink) return '#F43F5E'; // Red highlight\r\n                    return l.color || \"#CBD5E1\";\r\n                }}\r\n                linkOpacity={0.6}\r\n                linkDirectionalParticles={(link: any) => {\r\n                    const l = link as GraphLink;\r\n                    return l === selectedLink ? 4 : (l.type === \"Porous\" ? 2 : 0);\r\n                }}\r\n                linkDirectionalParticleWidth={selectedLink ? 3 : 2}\r\n                linkDirectionalParticleSpeed={0.005}\r\n\r\n                // 3D Objects\r\n                nodeThreeObjectExtend={true} // Allow default sphere + custom object? No, we replace or extend.\r\n                // We'll replace default rendering for Configuration nodes, and specific behavior for others if needed.\r\n                // Actually nodeThreeObject replaces the node. If extend is true, it adds TO the node.\r\n                // Let's set extend=false mostly, or handle complex logic.\r\n                // Simplest: Replace everything so we have full control.\r\n                nodeThreeObject={(node: any) => {\r\n                    const n = node as GraphNode; // Cast for now as library types can be loose\r\n                    if (n.isConfiguration) {\r\n                        return createTextSprite(n.name, n.color);\r\n                    }\r\n\r\n                    // Standard Actor Node\r\n                    const group = new THREE.Group();\r\n                    let geometry;\r\n                    const normalizedType = n.type.toLowerCase().trim();\r\n\r\n                    if (normalizedType === 'algorithmicagent' || normalizedType === 'algorithm') {\r\n                        // Tetrahedron for AI/Algorithms (Platonic solid, mathematical)\r\n                        geometry = new THREE.TetrahedronGeometry(n.val / 2);\r\n                    } else if (normalizedType === 'legalobject' || normalizedType === 'law' || normalizedType === 'regulation') {\r\n                        // Box for Legal Objects (Structure, firmness)\r\n                        geometry = new THREE.BoxGeometry(n.val / 1.5, n.val / 1.5, n.val / 1.5);\r\n                    } else if (normalizedType === 'infrastructure') {\r\n                        // Octahedron for Infrastructure (Networked stability)\r\n                        geometry = new THREE.OctahedronGeometry(n.val / 2);\r\n                    } else {\r\n                        // Default Sphere for human/institutional actors\r\n                        geometry = new THREE.SphereGeometry(n.val / 2, 16, 16);\r\n                    }\r\n\r\n                    const material = new THREE.MeshLambertMaterial({\r\n                        color: n.color,\r\n                        transparent: true,\r\n                        opacity: 0.9\r\n                    });\r\n                    const mesh = new THREE.Mesh(geometry, material);\r\n                    group.add(mesh);\r\n\r\n\r\n\r\n                    return group;\r\n                }}\r\n                onNodeClick={(node: any) => {\r\n                    const n = node as GraphNode;\r\n                    if (n.isConfiguration) return; // Ignore clicks on labels\r\n\r\n                    // Zoom to node\r\n                    const distance = 40;\r\n                    const distRatio = 1 + distance / Math.hypot(n.x!, n.y!, n.z!);\r\n\r\n                    fgRef.current?.cameraPosition(\r\n                        { x: n.x! * distRatio, y: n.y! * distRatio, z: n.z! * distRatio }, // new position\r\n                        n, // lookAt ({ x, y, z })\r\n                        3000  // ms transition duration\r\n                    );\r\n                    onToggleSelection(n.id);\r\n                    setSelectedLink(null); // Clear link selection\r\n                }}\r\n                onLinkClick={(link: any) => {\r\n                    const l = link as GraphLink;\r\n                    if (l.type === \"LabelTether\") return;\r\n                    setSelectedLink(l);\r\n                    focusLink(l);\r\n                }}\r\n                onBackgroundClick={() => setSelectedLink(null)}\r\n                cooldownTicks={100}\r\n            />\r\n\r\n            {/* Link Details Card Overlay */}\r\n            {selectedLink && (\r\n                <div className=\"absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-md border border-slate-200 rounded-lg shadow-lg p-4 w-72 animate-in slide-in-from-bottom-5\">\r\n                    <div className=\"flex justify-between items-start mb-2\">\r\n                        <div>\r\n                            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-0.5\">Connection Details</h4>\r\n                            <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium\r\n                                ${selectedLink.type === \"Strong\" ? \"bg-indigo-50 text-indigo-700\" : \"bg-slate-100 text-slate-600\"}`}>\r\n                                {selectedLink.type === \"Strong\" ? \"Strong Assemblage\" : \"Porous / Weak\"}\r\n                            </span>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => setSelectedLink(null)}\r\n                            className=\"text-slate-400 hover:text-slate-600 focus:outline-none\"\r\n                        >\r\n                            <svg className=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                            </svg>\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-3\">\r\n                        <div className=\"flex items-center justify-between text-sm\">\r\n                            <div className=\"flex flex-col items-center flex-1\">\r\n                                <div className=\"w-2 h-2 rounded-full mb-1\" style={{ backgroundColor: getActorColor((selectedLink.source as GraphNode).type) }} />\r\n                                <span className=\"text-slate-800 font-medium text-center leading-tight\">{(selectedLink.source as GraphNode).name}</span>\r\n                            </div>\r\n\r\n                            <div className=\"px-2 text-slate-300\">\r\n                                <svg className=\"w-4 h-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 8l4 4m0 0l-4 4m4-4H3\" />\r\n                                </svg>\r\n                            </div>\r\n\r\n                            <div className=\"flex flex-col items-center flex-1\">\r\n                                <div className=\"w-2 h-2 rounded-full mb-1\" style={{ backgroundColor: getActorColor((selectedLink.target as GraphNode).type) }} />\r\n                                <span className=\"text-slate-800 font-medium text-center leading-tight\">{(selectedLink.target as GraphNode).name}</span>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {selectedLink.label && (\r\n                            <div className=\"bg-slate-50 rounded p-2 text-xs border border-slate-100\">\r\n                                <span className=\"font-semibold text-slate-500\">Context: </span>\r\n                                <span className=\"text-slate-700\" style={{ color: selectedLink.color !== \"#CBD5E1\" ? selectedLink.color : undefined }}>\r\n                                    {selectedLink.label}\r\n                                </span>\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"text-[10px] text-slate-400 italic text-center border-t border-slate-100 pt-2\">\r\n                            {selectedLink.type === \"Strong\"\r\n                                ? \"High translation intensity & resource exchange.\"\r\n                                : \"Loose coupling or information flow only.\"}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\EcosystemTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1556,1559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1556,1559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1634,1637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1634,1637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\nimport { Table, TableBody, TableCaption, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\r\nimport { ExternalLink, ArrowUpDown, Check, Minus, Gavel, Coins, Code2, Megaphone } from 'lucide-react';\r\n\r\ninterface EcosystemTableProps {\r\n    actors: EcosystemActor[];\r\n    onSelectActor: (id: string) => void;\r\n    selectedActorId: string | null;\r\n}\r\n\r\nexport function EcosystemTable({ actors, onSelectActor, selectedActorId }: EcosystemTableProps) {\r\n    const [sortConfig, setSortConfig] = React.useState<{ key: keyof EcosystemActor | 'metrics.resistance' | 'metrics.influence'; direction: 'asc' | 'desc' } | null>(null);\r\n\r\n    const getMetricRank = (val: string | number | undefined): number => {\r\n        if (!val) return 0;\r\n        if (typeof val === 'number') return val;\r\n        // Map qualitative to rank\r\n        const map: Record<string, number> = {\r\n            \"Strong\": 3, \"High\": 3,\r\n            \"Moderate\": 2, \"Medium\": 2,\r\n            \"Weak\": 1, \"Low\": 1,\r\n            \"Latent\": 0\r\n        };\r\n        return map[val] || 0;\r\n    };\r\n\r\n    const sortedActors = React.useMemo(() => {\r\n        const sortableActors = [...actors];\r\n        if (sortConfig !== null) {\r\n            sortableActors.sort((a, b) => {\r\n                let aValue: any = a[sortConfig.key as keyof EcosystemActor];\r\n                let bValue: any = b[sortConfig.key as keyof EcosystemActor];\r\n\r\n                // Handle nested metrics with rank conversion\r\n                if (sortConfig.key === 'metrics.resistance') {\r\n                    aValue = getMetricRank(a.metrics?.resistance);\r\n                    bValue = getMetricRank(b.metrics?.resistance);\r\n                } else if (sortConfig.key === 'metrics.influence') {\r\n                    aValue = getMetricRank(a.metrics?.influence);\r\n                    bValue = getMetricRank(b.metrics?.influence);\r\n                }\r\n\r\n                if (aValue < bValue) {\r\n                    return sortConfig.direction === 'asc' ? -1 : 1;\r\n                }\r\n                if (aValue > bValue) {\r\n                    return sortConfig.direction === 'asc' ? 1 : -1;\r\n                }\r\n                return 0;\r\n            });\r\n        }\r\n        return sortableActors;\r\n    }, [actors, sortConfig]);\r\n\r\n    const requestSort = (key: keyof EcosystemActor | 'metrics.resistance' | 'metrics.influence') => {\r\n        let direction: 'asc' | 'desc' = 'asc';\r\n        if (sortConfig && sortConfig.key === key && sortConfig.direction === 'asc') {\r\n            direction = 'desc';\r\n        }\r\n        setSortConfig({ key, direction });\r\n    };\r\n\r\n    // Helper to determine functional aptitude\r\n    const getFunctionalAptitude = (type: string) => {\r\n        const t = type.toLowerCase();\r\n        return {\r\n            regulatory: ['policy', 'law', 'regulation', 'government', 'court', 'legislator', 'regulator'].some(k => t.includes(k)),\r\n            fund: ['fund', 'capital', 'investor', 'market', 'corporation', 'private', 'bank'].some(k => t.includes(k)),\r\n            implement: ['startup', 'technologist', 'infrastructure', 'algorithm', 'standard', 'cloud', 'developer', 'lab'].some(k => t.includes(k)),\r\n            contest: ['civilsociety', 'ngo', 'academic', 'activist', 'public', 'union', 'advocate'].some(k => t.includes(k)),\r\n        };\r\n    };\r\n\r\n    const renderCheck = (active: boolean) => active ? (\r\n        <Check className=\"h-4 w-4 text-emerald-600 mx-auto\" />\r\n    ) : (\r\n        <Minus className=\"h-3 w-3 text-slate-200 mx-auto\" />\r\n    );\r\n\r\n    return (\r\n        <TooltipProvider>\r\n            <div className=\"rounded-md border bg-white overflow-y-auto max-h-[600px] shadow-sm\">\r\n                <Table>\r\n                    <TableCaption>Actor-Function Matrix: Capabilities of Ecosystem Participants</TableCaption>\r\n                    <TableHeader className=\"bg-slate-50 sticky top-0 z-10\">\r\n                        <TableRow>\r\n                            <TableHead className=\"w-[180px] cursor-pointer hover:bg-slate-100\" onClick={() => requestSort('name')}>\r\n                                Name <ArrowUpDown className=\"ml-2 h-3.5 w-3.5 inline-block text-slate-400\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"w-[100px] cursor-pointer hover:bg-slate-100\" onClick={() => requestSort('type')}>\r\n                                Type\r\n                            </TableHead>\r\n\r\n                            {/* Functional Matrix Columns */}\r\n                            <TableHead className=\"text-center w-[60px]\" title=\"Regulatory Capability\">\r\n                                <Gavel className=\"h-4 w-4 mx-auto text-slate-500\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"text-center w-[60px]\" title=\"Financial/Funding Capability\">\r\n                                <Coins className=\"h-4 w-4 mx-auto text-slate-500\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"text-center w-[60px]\" title=\"Technical Implementation\">\r\n                                <Code2 className=\"h-4 w-4 mx-auto text-slate-500\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"text-center w-[60px]\" title=\"Contestation/Advocacy\">\r\n                                <Megaphone className=\"h-4 w-4 mx-auto text-slate-500\" />\r\n                            </TableHead>\r\n\r\n                            <TableHead className=\"text-right cursor-pointer hover:bg-slate-100\" onClick={() => requestSort('metrics.influence')}>\r\n                                Infl. <ArrowUpDown className=\"ml-1 h-3 w-3 inline-block text-slate-400\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"text-right cursor-pointer hover:bg-slate-100\" onClick={() => requestSort('metrics.resistance')}>\r\n                                Res. <ArrowUpDown className=\"ml-1 h-3 w-3 inline-block text-slate-400\" />\r\n                            </TableHead>\r\n                            <TableHead className=\"text-right\">Link</TableHead>\r\n                        </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                        {sortedActors.map((actor) => {\r\n                            const aptitude = getFunctionalAptitude(actor.type);\r\n                            return (\r\n                                <TableRow\r\n                                    key={actor.id}\r\n                                    className={`cursor-pointer transition-colors ${selectedActorId === actor.id ? 'bg-indigo-50 hover:bg-indigo-100' : 'hover:bg-slate-50'} ${actor.source === 'absence_fill' ? 'bg-amber-50/30' : ''}`}\r\n                                    onClick={() => onSelectActor(actor.id)}\r\n                                >\r\n                                    <TableCell className=\"font-medium py-2\">\r\n                                        <div className=\"flex flex-col\">\r\n                                            <span className=\"truncate max-w-[150px] text-xs font-semibold text-slate-700\">{actor.name}</span>\r\n                                            {actor.source === 'absence_fill' && (\r\n                                                <span className=\"text-[9px] text-amber-600 font-medium\">Recovered Check</span>\r\n                                            )}\r\n                                        </div>\r\n                                    </TableCell>\r\n                                    <TableCell className=\"py-2\">\r\n                                        <Badge variant=\"secondary\" className=\"font-normal text-[10px] px-1.5 h-5\">{actor.type}</Badge>\r\n                                    </TableCell>\r\n\r\n                                    {/* Functional Matrix Cells */}\r\n                                    <TableCell className=\"text-center py-2 bg-slate-50/50 border-x border-slate-50\">{renderCheck(aptitude.regulatory)}</TableCell>\r\n                                    <TableCell className=\"text-center py-2 bg-slate-50/50 border-x border-slate-50\">{renderCheck(aptitude.fund)}</TableCell>\r\n                                    <TableCell className=\"text-center py-2 bg-slate-50/50 border-x border-slate-50\">{renderCheck(aptitude.implement)}</TableCell>\r\n                                    <TableCell className=\"text-center py-2 bg-slate-50/50 border-x border-slate-50\">{renderCheck(aptitude.contest)}</TableCell>\r\n\r\n                                    <TableCell className=\"text-right py-2\">\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <span className=\"cursor-help decoration-slate-300 underline underline-offset-2 decoration-dotted text-xs text-slate-500 font-mono\">\r\n                                                    {actor.metrics?.influence || '-'}\r\n                                                </span>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent className=\"max-w-[300px] p-3 text-xs\">\r\n                                                <p className=\"font-semibold mb-2\">Influence Quality: {actor.metrics?.influence}</p>\r\n                                                {/* Dimensional Breakdown */}\r\n                                                {actor.metrics?.territoriality !== undefined && (\r\n                                                    <div className=\"grid grid-cols-2 gap-x-4 gap-y-1 mb-2 text-[10px] text-slate-500\">\r\n                                                        <span>Territoriality:</span><span className=\"font-mono text-slate-900\">{actor.metrics.territoriality}</span>\r\n                                                        <span>Coding:</span><span className=\"font-mono text-slate-900\">{actor.metrics.coding}</span>\r\n                                                        <span>Centrality:</span><span className=\"font-mono text-slate-900\">{actor.metrics.centrality}</span>\r\n                                                    </div>\r\n                                                )}\r\n                                            </TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TableCell>\r\n                                    <TableCell className=\"text-right py-2\">\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <span className={`cursor-help decoration-slate-300 underline underline-offset-2 decoration-dotted text-xs font-mono font-bold ${(actor.metrics?.resistance === 'Strong' || (typeof actor.metrics?.resistance === 'number' && actor.metrics.resistance > 6)) ? 'text-red-500' : 'text-slate-400'\r\n                                                    }`}>\r\n                                                    {actor.metrics?.resistance || '-'}\r\n                                                </span>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent className=\"max-w-[300px] p-3 text-xs\">\r\n                                                <p className=\"font-semibold mb-2\">Resistance Quality: {actor.metrics?.resistance}</p>\r\n                                                {/* Dimensional Breakdown */}\r\n                                                {actor.metrics?.counter_conduct !== undefined && (\r\n                                                    <div className=\"grid grid-cols-2 gap-x-4 gap-y-1 mb-2 text-[10px] text-slate-500\">\r\n                                                        <span>Counter-Conduct:</span><span className=\"font-mono text-slate-900\">{actor.metrics.counter_conduct}</span>\r\n                                                        <span>Opposition:</span><span className=\"font-mono text-slate-900\">{actor.metrics.discursive_opposition}</span>\r\n                                                    </div>\r\n                                                )}\r\n                                            </TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TableCell>\r\n\r\n                                    <TableCell className=\"text-right py-2\">\r\n                                        {actor.url && (\r\n                                            <a href={actor.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"inline-flex items-center justify-center h-6 w-6 rounded-full hover:bg-slate-100 text-slate-400 hover:text-indigo-600\" onClick={(e) => e.stopPropagation()}>\r\n                                                <ExternalLink className=\"h-3 w-3\" />\r\n                                            </a>\r\n                                        )}\r\n                                    </TableCell>\r\n                                </TableRow>\r\n                            );\r\n                        })}\r\n                    </TableBody>\r\n                </Table>\r\n            </div>\r\n        </TooltipProvider>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\ReflexiveLog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":2,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2831,2834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2831,2834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Plus, BookOpen, Trash2 } from 'lucide-react';\r\nimport { ReflexiveLogEntry } from '@/types/ecosystem';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\n\r\ninterface ReflexiveLogProps {\r\n    logs: ReflexiveLogEntry[];\r\n    onAddLog: (log: ReflexiveLogEntry) => void;\r\n    onDeleteLog?: (id: string) => void;\r\n}\r\n\r\nexport function ReflexiveLog({ logs, onAddLog, onDeleteLog }: ReflexiveLogProps) {\r\n    const [isAdding, setIsAdding] = useState(false);\r\n    const [newRationale, setNewRationale] = useState(\"\");\r\n    const [actionType, setActionType] = useState<ReflexiveLogEntry['action_type']>(\"Other\");\r\n\r\n    const handleAdd = () => {\r\n        if (!newRationale.trim()) return;\r\n\r\n        const entry: ReflexiveLogEntry = {\r\n            id: crypto.randomUUID(),\r\n            timestamp: Date.now(),\r\n            action_type: actionType,\r\n            rationale: newRationale,\r\n        };\r\n\r\n        onAddLog(entry);\r\n        setNewRationale(\"\");\r\n        setIsAdding(false);\r\n    };\r\n\r\n    return (\r\n        <Card className=\"h-full flex flex-col border-none shadow-none bg-transparent\">\r\n            <CardHeader className=\"px-0 pt-0 pb-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                        <CardTitle className=\"text-sm font-bold text-slate-700 flex items-center gap-2\">\r\n                            <BookOpen className=\"h-4 w-4 text-slate-500\" />\r\n                            Methodological Journal\r\n                        </CardTitle>\r\n                        <CardDescription className=\"text-xs\">\r\n                            Log interpretive moves and strategic subtractions.\r\n                        </CardDescription>\r\n                    </div>\r\n                    <Button size=\"sm\" variant=\"outline\" className=\"h-8 text-xs gap-1\" onClick={() => setIsAdding(!isAdding)}>\r\n                        <Plus className=\"h-3 w-3\" />\r\n                        Log Move\r\n                    </Button>\r\n                </div>\r\n            </CardHeader>\r\n\r\n            {isAdding && (\r\n                <div className=\"mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg space-y-3 animation-in slide-in-from-top-2\">\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"text-[10px] font-bold uppercase text-slate-500\">Action Type</label>\r\n                        <Select value={actionType} onValueChange={(v: any) => setActionType(v)}>\r\n                            <SelectTrigger className=\"h-8 text-xs bg-white\">\r\n                                <SelectValue placeholder=\"Select type\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"Trace_Rejection\">Trace Rejection</SelectItem>\r\n                                <SelectItem value=\"Actor_Merge\">Actor Merge</SelectItem>\r\n                                <SelectItem value=\"Strategic_Subtraction\">Strategic Subtraction</SelectItem>\r\n                                <SelectItem value=\"Manual_Inscription\">Manual Inscription</SelectItem>\r\n                                <SelectItem value=\"Other\">Other Interpretation</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"text-[10px] font-bold uppercase text-slate-500\">Rationale</label>\r\n                        <Textarea\r\n                            value={newRationale}\r\n                            onChange={(e) => setNewRationale(e.target.value)}\r\n                            placeholder=\"Why did you make this decision? What theory guided it?\"\r\n                            className=\"text-xs min-h-[80px] bg-white\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"flex justify-end gap-2\">\r\n                        <Button size=\"sm\" variant=\"ghost\" onClick={() => setIsAdding(false)} className=\"text-xs h-7 text-slate-500\">Cancel</Button>\r\n                        <Button size=\"sm\" onClick={handleAdd} className=\"text-xs h-7 bg-indigo-600 hover:bg-indigo-700 text-white\">Save Entry</Button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <ScrollArea className=\"flex-1 -mx-2 px-2\">\r\n                <div className=\"space-y-3 pb-4\">\r\n                    {logs.length === 0 ? (\r\n                        <div className=\"text-center py-8 text-slate-400 text-xs italic\">\r\n                            No entries logged. Document your process to ensure rigor.\r\n                        </div>\r\n                    ) : (\r\n                        logs.sort((a, b) => b.timestamp - a.timestamp).map((log) => (\r\n                            <div key={log.id} className=\"group relative pl-3 border-l-2 border-slate-200 hover:border-indigo-300 transition-colors pb-1\">\r\n                                <div className=\"absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-slate-200 border-2 border-white group-hover:bg-indigo-400 transition-colors\" />\r\n\r\n                                <div className=\"flex items-center gap-2 mb-1\">\r\n                                    <Badge variant=\"outline\" className=\"text-[10px] h-5 px-1.5 font-normal bg-slate-50 text-slate-600 border-slate-200\">\r\n                                        {log.action_type.replace('_', ' ')}\r\n                                    </Badge>\r\n                                    <span className=\"text-[10px] text-slate-400\">\r\n                                        {new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                                    </span>\r\n                                    {onDeleteLog && (\r\n                                        <button\r\n                                            onClick={() => onDeleteLog(log.id)}\r\n                                            className=\"ml-auto opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-red-500\"\r\n                                        >\r\n                                            <Trash2 className=\"h-3 w-3\" />\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n\r\n                                <p className=\"text-xs text-slate-700 whitespace-pre-wrap leading-relaxed\">\r\n                                    {log.rationale}\r\n                                </p>\r\n                            </div>\r\n                        ))\r\n                    )}\r\n                </div>\r\n            </ScrollArea>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ecosystem\\TranslationChain.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\governance\\GovernanceCompass.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":4,"column":107,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":112}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from 'react';\r\nimport { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Label, Cell, LabelList } from 'recharts';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { DriftVector } from '@/lib/governance';\r\n\r\ninterface GovernanceCompassProps {\r\n    analysis: DriftVector | null;\r\n}\r\n\r\nexport function GovernanceCompass({ analysis }: GovernanceCompassProps) {\r\n    if (!analysis) {\r\n        return (\r\n            <Card className=\"h-[500px] flex items-center justify-center bg-slate-50 border-dashed\">\r\n                <p className=\"text-slate-400\">Run analysis to generate Governance Compass</p>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    const data = [\r\n        { x: analysis.rhetoric.x, y: analysis.rhetoric.y, name: 'Rhetoric', fill: '#3b82f6' }, // Blue\r\n        { x: analysis.reality.x, y: analysis.reality.y, name: 'Reality', fill: '#0f172a' },   // Black\r\n    ];\r\n\r\n    return (\r\n        <Card className=\"w-full\">\r\n            <CardHeader>\r\n                <CardTitle>Governance Drift Compass</CardTitle>\r\n                <CardDescription>\r\n                    Visualizing the gap between ethical rhetoric and technical reality.\r\n                    <br />\r\n                    <span className=\"text-xs text-slate-500\">\r\n                        Drift Magnitude: {analysis.magnitude.toFixed(2)} |\r\n                        X-Shift: {analysis.driftX.toFixed(2)} |\r\n                        Y-Shift: {analysis.driftY.toFixed(2)}\r\n                    </span>\r\n                </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <div className=\"h-[500px] w-full relative\">\r\n                    {/* Background Quadrant Labels */}\r\n                    <div className=\"absolute top-4 right-4 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded opacity-80\">\r\n                        REGENERATIVE / PARTICIPATORY\r\n                    </div>\r\n                    <div className=\"absolute bottom-4 left-4 text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded opacity-80\">\r\n                        EXTRACTIVE / ASYMMETRICAL\r\n                    </div>\r\n\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <ScatterChart margin={{ top: 20, right: 20, bottom: 40, left: 80 }}>\r\n                            <CartesianGrid strokeDasharray=\"3 3\" />\r\n                            <XAxis\r\n                                type=\"number\"\r\n                                dataKey=\"x\"\r\n                                name=\"Power\"\r\n                                domain={[-1.2, 1.2]}\r\n                                label={{ value: 'Power: Asymmetrical (-) vs Participatory (+)', position: 'bottom', offset: 0 }}\r\n                            />\r\n                            <YAxis\r\n                                type=\"number\"\r\n                                dataKey=\"y\"\r\n                                name=\"Value\"\r\n                                domain={[-1.2, 1.2]}\r\n                                label={{ value: 'Value: Extractive (-) vs Regenerative (+)', angle: -90, position: 'insideLeft', offset: 10, style: { textAnchor: 'middle' } }}\r\n                            />\r\n                            <ReferenceLine x={0} stroke=\"#64748b\" />\r\n                            <ReferenceLine y={0} stroke=\"#64748b\" />\r\n\r\n                            <Tooltip cursor={{ strokeDasharray: '3 3' }} />\r\n\r\n                            <Scatter name=\"Points\" data={data} fill=\"#8884d8\">\r\n                                {data.map((entry, index) => (\r\n                                    <Cell key={`cell-${index}`} fill={entry.fill} />\r\n                                ))}\r\n                                <LabelList dataKey=\"name\" position=\"top\" offset={10} style={{ fill: '#64748b', fontSize: '12px', fontWeight: 'bold' }} />\r\n                            </Scatter>\r\n                        </ScatterChart>\r\n                    </ResponsiveContainer>\r\n\r\n                    {/* SVG Overlay for the Arrow (Drift Vector) */}\r\n                    {/* Note: Precise overlay requires mapping coordinates to pixels, which is hard with ResponsiveContainer. \r\n                        For this MVP, we rely on the scatter points. A more advanced version would use a custom SVG layer. */}\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\landing\\GalaxyGraph.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useMemo' is defined but never used.","line":3,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":4,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":12},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\landing\\GalaxyGraph.tsx:102:9\n  100 |             fixed: false\n  101 |         }));\n> 102 |         setNodes(initialNodes);\n      |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  103 |     }, [highResistanceCount]);\n  104 |\n  105 |     // Handle Resize","line":102,"column":9,"nodeType":null,"endLine":102,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'updatePhysics'. Either include it or remove the dependency array.","line":214,"column":8,"nodeType":"ArrayExpression","endLine":214,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [dimensions, updatePhysics]","fix":{"range":[9484,9496],"text":"[dimensions, updatePhysics]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useRef, useState, useMemo } from 'react';\r\nimport Link from 'next/link';\r\nimport { Database, Users, Scan, Network, Scale, Lightbulb, BookOpen, Activity } from 'lucide-react';\r\n\r\n// --- Types ---\r\ninterface Node {\r\n    id: string;\r\n    name: string;\r\n    href: string;\r\n    icon: React.ElementType;\r\n    description: string;\r\n    color: string;\r\n    category: 'micro' | 'mezzo' | 'macro';\r\n    x: number;\r\n    y: number;\r\n    vx: number;\r\n    vy: number;\r\n    radius: number;\r\n    fixed?: boolean;\r\n}\r\n\r\ninterface LinkData {\r\n    source: string; // ID of source node\r\n    target: string; // ID of target node\r\n    type?: 'structural' | 'justification'; // Type of connection\r\n}\r\n\r\n// --- Data ---\r\n// Re-using features data but structured for graph\r\nconst INITIAL_NODES: Omit<Node, 'x' | 'y' | 'vx' | 'vy' | 'radius'>[] = [\r\n    // Micro: Individual, Traces, Resistance -> RED Theme\r\n    { id: 'empirical', name: 'Empirical Data', href: '/empirical', icon: Users, description: 'Web traces & social data', color: '#ef4444', category: 'micro' },\r\n    { id: 'resistance', name: 'Resistance', href: '/resistance', icon: Users, description: 'Micro-resistance analytics', color: '#ef4444', category: 'micro' },\r\n    { id: 'reflexivity', name: 'Reflexivity', href: '/reflexivity', icon: Scan, description: 'Critical self-reflection', color: '#ef4444', category: 'micro' },\r\n    { id: 'cultural', name: 'Cultural', href: '/cultural', icon: Lightbulb, description: 'Epistemic authority', color: '#ef4444', category: 'micro' },\r\n\r\n    // Mezzo: Institutional, Documents, Governance -> BLUE Theme\r\n    { id: 'docs', name: 'Documents', href: '/data', icon: Database, description: 'Archive of policy texts', color: '#3b82f6', category: 'mezzo' },\r\n    { id: 'governance', name: 'Governance', href: '/governance', icon: Scale, description: 'Institutional logics', color: '#3b82f6', category: 'mezzo' },\r\n    { id: 'comparison', name: 'Comparison', href: '/comparison', icon: Scale, description: 'Side-by-side frameworks', color: '#3b82f6', category: 'mezzo' },\r\n\r\n    // Macro: Systemic, Ecosystem, Time -> GREEN Theme\r\n    { id: 'ecosystem', name: 'Ecosystem', href: '/ecosystem', icon: Users, description: 'Actor network mapping', color: '#10b981', category: 'macro' },\r\n    { id: 'synthesis', name: 'Synthesis', href: '/synthesis', icon: Network, description: 'Cross-case comparison', color: '#10b981', category: 'macro' },\r\n    { id: 'ontology', name: 'Ontology', href: '/ontology', icon: BookOpen, description: 'Concept mapping', color: '#10b981', category: 'macro' },\r\n    { id: 'timeline', name: 'Timeline', href: '/timeline', icon: Activity, description: 'Temporal evolution', color: '#10b981', category: 'macro' },\r\n];\r\n\r\n// Define relationships (assemblage connections)\r\nconst LINKS: LinkData[] = [\r\n    // Structural Links (The \"Skeleton\")\r\n    { source: 'docs', target: 'governance', type: 'structural' },\r\n    { source: 'empirical', target: 'resistance', type: 'structural' },\r\n    { source: 'resistance', target: 'ecosystem', type: 'structural' },\r\n    { source: 'reflexivity', target: 'synthesis', type: 'structural' },\r\n    { source: 'ecosystem', target: 'governance', type: 'structural' },\r\n    { source: 'synthesis', target: 'comparison', type: 'structural' },\r\n    { source: 'cultural', target: 'ontology', type: 'structural' },\r\n    { source: 'ontology', target: 'docs', type: 'structural' },\r\n    { source: 'timeline', target: 'comparison', type: 'structural' },\r\n    { source: 'docs', target: 'empirical', type: 'structural' },\r\n\r\n    // Justification/Discursive Links (The \"Meaning\") - New for CfP Alignment\r\n    { source: 'governance', target: 'cultural', type: 'justification' },  // Governance justifies via Culture\r\n    { source: 'resistance', target: 'docs', type: 'justification' },      // Resistance challenges Docs\r\n    { source: 'reflexivity', target: 'ontology', type: 'justification' }, // Reflexivity questions Ontology\r\n    { source: 'ecosystem', target: 'synthesis', type: 'structural' }\r\n];\r\n\r\n// Physics Constants\r\nconst REPULSION = 1500;\r\nconst SPRING_LENGTH = 120;\r\nconst SPRING_STRENGTH = 0.05;\r\nconst CENTER_GRAVITY = 0.05;\r\nconst DAMPING = 0.9;\r\nconst DT = 1;\r\n\r\nexport function GalaxyGraph({ highResistanceCount = 0 }: { highResistanceCount?: number }) {\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n    const [nodes, setNodes] = useState<Node[]>([]);\r\n    const [dimensions, setDimensions] = useState({ width: 800, height: 600 });\r\n    const [hoveredNode, setHoveredNode] = useState<string | null>(null);\r\n    const requestRef = useRef<number>(0);\r\n    const isDragging = useRef<string | null>(null);\r\n    const mousePos = useRef<{ x: number, y: number } | null>(null);\r\n\r\n    // Initialize nodes\r\n    useEffect(() => {\r\n        const initialNodes = INITIAL_NODES.map(n => ({\r\n            ...n,\r\n            // If high resistance is detected, the Ecosystem node becomes \"Hot\" (Red)\r\n            color: (n.id === 'ecosystem' && highResistanceCount > 0) ? '#ef4444' : n.color,\r\n            x: Math.random() * 800,\r\n            y: Math.random() * 600,\r\n            vx: (Math.random() - 0.5) * 2,\r\n            vy: (Math.random() - 0.5) * 2,\r\n            radius: 40,\r\n            fixed: false\r\n        }));\r\n        setNodes(initialNodes);\r\n    }, [highResistanceCount]);\r\n\r\n    // Handle Resize\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            if (containerRef.current) {\r\n                setDimensions({\r\n                    width: containerRef.current.clientWidth,\r\n                    height: containerRef.current.clientHeight\r\n                });\r\n            }\r\n        };\r\n        window.addEventListener('resize', handleResize);\r\n        handleResize();\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, []);\r\n\r\n    // Physics Loop\r\n    const updatePhysics = () => {\r\n        setNodes(prevNodes => {\r\n            const nextNodes = prevNodes.map(n => ({ ...n }));\r\n            const width = dimensions.width;\r\n            const height = dimensions.height;\r\n\r\n            // Define Gravity Centers for Categories - Adjusted to safe zones\r\n            const centers = {\r\n                mezzo: { x: width * 0.5, y: height * 0.25 },   // Top Center\r\n                micro: { x: width * 0.25, y: height * 0.6 },  // Bottom Left\r\n                macro: { x: width * 0.75, y: height * 0.6 }   // Bottom Right\r\n            };\r\n\r\n            // 1. Repulsion\r\n            for (let i = 0; i < nextNodes.length; i++) {\r\n                for (let j = i + 1; j < nextNodes.length; j++) {\r\n                    const dx = nextNodes[i].x - nextNodes[j].x;\r\n                    const dy = nextNodes[i].y - nextNodes[j].y;\r\n                    const distSq = dx * dx + dy * dy || 1;\r\n                    const dist = Math.sqrt(distSq);\r\n                    const force = REPULSION / distSq;\r\n\r\n                    const fx = (dx / dist) * force;\r\n                    const fy = (dy / dist) * force;\r\n\r\n                    if (!nextNodes[i].fixed) {\r\n                        nextNodes[i].vx += fx;\r\n                        nextNodes[i].vy += fy;\r\n                    }\r\n                    if (!nextNodes[j].fixed) {\r\n                        nextNodes[j].vx -= fx;\r\n                        nextNodes[j].vy -= fy;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // 2. Spring Forces\r\n            LINKS.forEach(link => {\r\n                const source = nextNodes.find(n => n.id === link.source);\r\n                const target = nextNodes.find(n => n.id === link.target);\r\n\r\n                if (!source || !target) return;\r\n\r\n                const dx = target.x - source.x;\r\n                const dy = target.y - source.y;\r\n                const dist = Math.sqrt(dx * dx + dy * dy) || 1;\r\n                const force = (dist - SPRING_LENGTH) * SPRING_STRENGTH;\r\n\r\n                const fx = (dx / dist) * force;\r\n                const fy = (dy / dist) * force;\r\n\r\n                if (!source.fixed) {\r\n                    source.vx += fx;\r\n                    source.vy += fy;\r\n                }\r\n                if (!target.fixed) {\r\n                    target.vx -= fx;\r\n                    target.vy -= fy;\r\n                }\r\n            });\r\n\r\n            // 3. Category Gravity\r\n            nextNodes.forEach(node => {\r\n                const target = centers[node.category];\r\n\r\n                if (!node.fixed && isDragging.current !== node.id) {\r\n                    node.vx += (target.x - node.x) * CENTER_GRAVITY;\r\n                    node.vy += (target.y - node.y) * CENTER_GRAVITY;\r\n                }\r\n\r\n                if (isDragging.current === node.id && mousePos.current) {\r\n                    node.x = mousePos.current.x;\r\n                    node.y = mousePos.current.y;\r\n                    node.vx = 0;\r\n                    node.vy = 0;\r\n                    node.fixed = true;\r\n                } else if (!node.fixed) {\r\n                    node.x += node.vx * DT;\r\n                    node.y += node.vy * DT;\r\n                    node.vx *= DAMPING;\r\n                    node.vy *= DAMPING;\r\n                }\r\n            });\r\n\r\n            return nextNodes;\r\n        });\r\n\r\n        requestRef.current = requestAnimationFrame(updatePhysics);\r\n    };\r\n\r\n    useEffect(() => {\r\n        requestRef.current = requestAnimationFrame(updatePhysics);\r\n        return () => cancelAnimationFrame(requestRef.current);\r\n    }, [dimensions]);\r\n\r\n    // Interaction Handlers\r\n    const handleMouseDown = (e: React.MouseEvent, nodeId: string) => {\r\n        isDragging.current = nodeId;\r\n        const rect = containerRef.current?.getBoundingClientRect();\r\n        if (rect) {\r\n            mousePos.current = {\r\n                x: e.clientX - rect.left,\r\n                y: e.clientY - rect.top\r\n            };\r\n        }\r\n    };\r\n\r\n    const handleMouseMove = (e: React.MouseEvent) => {\r\n        if (isDragging.current) {\r\n            const rect = containerRef.current?.getBoundingClientRect();\r\n            if (rect) {\r\n                mousePos.current = {\r\n                    x: e.clientX - rect.left,\r\n                    y: e.clientY - rect.top\r\n                };\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleMouseUp = () => {\r\n        isDragging.current = null;\r\n        mousePos.current = null;\r\n    };\r\n\r\n    // Calculate center positions for labels\r\n    const width = dimensions.width;\r\n    const height = dimensions.height;\r\n    const centers = {\r\n        mezzo: { x: width * 0.5, y: height * 0.25 },\r\n        micro: { x: width * 0.25, y: height * 0.6 },\r\n        macro: { x: width * 0.75, y: height * 0.6 }\r\n    };\r\n\r\n    return (\r\n        <div\r\n            ref={containerRef}\r\n            className=\"w-full h-[600px] bg-slate-950 rounded-2xl overflow-hidden relative border border-slate-800 shadow-2xl\"\r\n            onMouseMove={handleMouseMove}\r\n            onMouseUp={handleMouseUp}\r\n            onMouseLeave={handleMouseUp}\r\n        >\r\n            <div className=\"absolute inset-0 opacity-20 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-indigo-900/50 via-slate-950 to-slate-950 pointer-events-none\"></div>\r\n\r\n            <svg className=\"w-full h-full\">\r\n                <defs>\r\n                    <radialGradient id=\"grad-micro\" cx=\"50%\" cy=\"50%\" r=\"50%\" fx=\"50%\" fy=\"50%\">\r\n                        <stop offset=\"0%\" stopColor=\"#dc2626\" stopOpacity=\"0.15\" />\r\n                        <stop offset=\"100%\" stopColor=\"#dc2626\" stopOpacity=\"0\" />\r\n                    </radialGradient>\r\n                    <radialGradient id=\"grad-mezzo\" cx=\"50%\" cy=\"50%\" r=\"50%\" fx=\"50%\" fy=\"50%\">\r\n                        <stop offset=\"0%\" stopColor=\"#2563eb\" stopOpacity=\"0.15\" />\r\n                        <stop offset=\"100%\" stopColor=\"#2563eb\" stopOpacity=\"0\" />\r\n                    </radialGradient>\r\n                    <radialGradient id=\"grad-macro\" cx=\"50%\" cy=\"50%\" r=\"50%\" fx=\"50%\" fy=\"50%\">\r\n                        <stop offset=\"0%\" stopColor=\"#059669\" stopOpacity=\"0.15\" />\r\n                        <stop offset=\"100%\" stopColor=\"#059669\" stopOpacity=\"0\" />\r\n                    </radialGradient>\r\n                </defs>\r\n\r\n                {/* Zone Backgrounds */}\r\n                <circle cx={centers.micro.x} cy={centers.micro.y} r=\"200\" fill=\"url(#grad-micro)\" />\r\n                <circle cx={centers.mezzo.x} cy={centers.mezzo.y} r=\"200\" fill=\"url(#grad-mezzo)\" />\r\n                <circle cx={centers.macro.x} cy={centers.macro.y} r=\"200\" fill=\"url(#grad-macro)\" />\r\n\r\n                {/* Category Labels (Background) - Adjusted Safe Positions */}\r\n                <text x={centers.mezzo.x} y={centers.mezzo.y - 80} textAnchor=\"middle\" fill=\"#60a5fa\" fontSize=\"36\" fontWeight=\"900\" opacity=\"0.4\" className=\"select-none pointer-events-none tracking-widest\">MEZZO: INSTITUTIONAL</text>\r\n                <text x={centers.micro.x} y={centers.micro.y + 130} textAnchor=\"middle\" fill=\"#f87171\" fontSize=\"36\" fontWeight=\"900\" opacity=\"0.4\" className=\"select-none pointer-events-none tracking-widest\">MICRO: INDIVIDUAL</text>\r\n                <text x={centers.macro.x} y={centers.macro.y + 130} textAnchor=\"middle\" fill=\"#34d399\" fontSize=\"36\" fontWeight=\"900\" opacity=\"0.4\" className=\"select-none pointer-events-none tracking-widest\">MACRO: SYSTEMIC</text>\r\n\r\n                {/* Region Rings (Visual Guide) */}\r\n                <circle cx={centers.mezzo.x} cy={centers.mezzo.y} r=\"180\" fill=\"none\" stroke=\"#2563eb\" strokeWidth=\"2\" opacity=\"0.1\" strokeDasharray=\"8 8\" />\r\n                <circle cx={centers.micro.x} cy={centers.micro.y} r=\"180\" fill=\"none\" stroke=\"#dc2626\" strokeWidth=\"2\" opacity=\"0.1\" strokeDasharray=\"8 8\" />\r\n                <circle cx={centers.macro.x} cy={centers.macro.y} r=\"180\" fill=\"none\" stroke=\"#059669\" strokeWidth=\"2\" opacity=\"0.1\" strokeDasharray=\"8 8\" />\r\n\r\n                {/* Links */}\r\n                {LINKS.map((link, i) => {\r\n                    const source = nodes.find(n => n.id === link.source);\r\n                    const target = nodes.find(n => n.id === link.target);\r\n                    if (!source || !target) return null;\r\n\r\n                    // Highlight link if connected to 'hot' ecosystem\r\n                    const isHotLink = (highResistanceCount > 0) && (source.id === 'ecosystem' || target.id === 'ecosystem');\r\n                    const isJustification = link.type === 'justification';\r\n\r\n                    return (\r\n                        <g key={i}>\r\n                            <line\r\n                                x1={source.x}\r\n                                y1={source.y}\r\n                                x2={target.x}\r\n                                y2={target.y}\r\n                                stroke={isHotLink ? \"#ef4444\" : isJustification ? \"#d8b4fe\" : \"#475569\"} // Purple for justification\r\n                                strokeWidth={isHotLink ? \"2\" : isJustification ? \"1.5\" : \"1\"}\r\n                                strokeOpacity={isHotLink ? \"0.6\" : isJustification ? \"0.5\" : \"0.4\"}\r\n                                strokeDasharray={isHotLink || isJustification ? \"4 4\" : \"0\"}\r\n                                className={isHotLink ? \"animate-pulse\" : \"\"}\r\n                            />\r\n                            {isJustification && (\r\n                                <title>Justification Bond: Discursive Connection</title>\r\n                            )}\r\n                        </g>\r\n                    );\r\n                })}\r\n\r\n                {/* Nodes */}\r\n                {nodes.map((node) => {\r\n                    const Icon = node.icon;\r\n                    const isHovered = hoveredNode === node.id;\r\n\r\n                    return (\r\n                        <g\r\n                            key={node.id}\r\n                            transform={`translate(${node.x},${node.y})`}\r\n                            onMouseDown={(e) => handleMouseDown(e, node.id)}\r\n                            onMouseEnter={() => setHoveredNode(node.id)}\r\n                            onMouseLeave={() => setHoveredNode(null)}\r\n                            style={{ cursor: 'grab' }}\r\n                        >\r\n                            {/* Pulse Effect */}\r\n                            <circle\r\n                                r={node.radius + 15}\r\n                                fill={node.color}\r\n                                opacity=\"0.1\"\r\n                                className={isHovered ? \"animate-ping\" : \"hidden\"}\r\n                            />\r\n\r\n                            {/* Node Body */}\r\n                            <circle\r\n                                r={node.radius}\r\n                                fill=\"#0f172a\"\r\n                                stroke={node.color}\r\n                                strokeWidth={isHovered ? 3 : 1.5}\r\n                                className=\"transition-all duration-300\"\r\n                                onDoubleClick={() => window.location.href = node.href}\r\n                            />\r\n\r\n                            {/* Icon */}\r\n                            <foreignObject x=\"-12\" y=\"-12\" width=\"24\" height=\"24\" className=\"pointer-events-none\">\r\n                                <div className=\"w-full h-full flex items-center justify-center\">\r\n                                    <Icon className=\"w-6 h-6 text-slate-200\" />\r\n                                </div>\r\n                            </foreignObject>\r\n\r\n                            {/* Label */}\r\n                            <text\r\n                                y={node.radius + 24}\r\n                                textAnchor=\"middle\"\r\n                                fill=\"#e2e8f0\"\r\n                                fontSize=\"16\"\r\n                                fontWeight=\"700\"\r\n                                className=\"pointer-events-none select-none drop-shadow-md\"\r\n                            >\r\n                                {node.name}\r\n                            </text>\r\n\r\n                            {/* Category Label (Tiny) */}\r\n                            <text\r\n                                y={node.radius + 38}\r\n                                textAnchor=\"middle\"\r\n                                fill={node.color}\r\n                                fontSize=\"10\"\r\n                                className=\"pointer-events-none select-none uppercase tracking-wider opacity-80 font-bold\"\r\n                            >\r\n                                {node.category}\r\n                            </text>\r\n                        </g>\r\n                    );\r\n                })}\r\n            </svg>\r\n\r\n            {/* Floating Tooltip */}\r\n            {hoveredNode && nodes.find(n => n.id === hoveredNode) && (\r\n                <div\r\n                    className=\"absolute pointer-events-none bg-slate-900/90 border border-slate-700 p-4 rounded-lg shadow-xl backdrop-blur-sm z-50 max-w-xs transition-all duration-200\"\r\n                    style={{\r\n                        left: (nodes.find(n => n.id === hoveredNode)?.x ?? 0) + 50,\r\n                        top: (nodes.find(n => n.id === hoveredNode)?.y ?? 0) - 50\r\n                    }}\r\n                >\r\n                    <div className=\"flex items-center gap-2 mb-1\">\r\n                        <span className={`text-[10px] font-bold uppercase px-1.5 py-0.5 rounded border ${nodes.find(n => n.id === hoveredNode)?.category === 'micro' ? 'border-red-500/50 text-red-400 bg-red-950/30' :\r\n                                nodes.find(n => n.id === hoveredNode)?.category === 'mezzo' ? 'border-blue-500/50 text-blue-400 bg-blue-950/30' :\r\n                                    'border-emerald-500/50 text-emerald-400 bg-emerald-950/30'\r\n                            }`}>\r\n                            {nodes.find(n => n.id === hoveredNode)?.category}\r\n                        </span>\r\n                    </div>\r\n                    <h4 className=\"font-bold text-white mb-1\" style={{ color: nodes.find(n => n.id === hoveredNode)?.color }}>\r\n                        {nodes.find(n => n.id === hoveredNode)?.name}\r\n                    </h4>\r\n                    <p className=\"text-xs text-slate-300 leading-relaxed\">\r\n                        {nodes.find(n => n.id === hoveredNode)?.description}\r\n                    </p>\r\n                    <div className=\"mt-2 text-[10px] text-slate-400 uppercase tracking-widest border-t border-slate-800 pt-2\">\r\n                        Double-click to open\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <div className=\"absolute top-4 left-4 text-xs text-slate-500 bg-slate-950/50 px-2 py-1 rounded border border-slate-900\">\r\n                Drag to rearrange â€¢ Hover for details â€¢ Gravity aligns to Micro/Mezzo/Macro levels\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\onboarding\\OnboardingWizard.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":100,"column":41,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4935,5090],"text":"\r\n                                        &quot;To understand AI, we must trace the network of relations that sustain it.\"\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4935,5090],"text":"\r\n                                        &ldquo;To understand AI, we must trace the network of relations that sustain it.\"\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4935,5090],"text":"\r\n                                        &#34;To understand AI, we must trace the network of relations that sustain it.\"\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4935,5090],"text":"\r\n                                        &rdquo;To understand AI, we must trace the network of relations that sustain it.\"\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":100,"column":115,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4935,5090],"text":"\r\n                                        \"To understand AI, we must trace the network of relations that sustain it.&quot;\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4935,5090],"text":"\r\n                                        \"To understand AI, we must trace the network of relations that sustain it.&ldquo;\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4935,5090],"text":"\r\n                                        \"To understand AI, we must trace the network of relations that sustain it.&#34;\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4935,5090],"text":"\r\n                                        \"To understand AI, we must trace the network of relations that sustain it.&rdquo;\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":191,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11392,11395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11392,11395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState } from 'react';\r\nimport { Dialog, DialogContent, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { ArrowRight, BookOpen, Users, Globe, Network, GraduationCap, Briefcase, Eye } from 'lucide-react';\r\nimport { useServerStorage } from '@/hooks/useServerStorage';\r\n\r\ninterface OnboardingWizardProps {\r\n    onComplete: () => void;\r\n}\r\n\r\nexport function OnboardingWizard({ onComplete }: OnboardingWizardProps) {\r\n    const [step, setStep] = useState(1);\r\n    const [userRole, setUserRole] = useServerStorage<string | null>(\"user_role\", null);\r\n\r\n    const totalSteps = 4;\r\n\r\n    const nextStep = () => {\r\n        if (step < totalSteps) setStep(step + 1);\r\n        else onComplete();\r\n    };\r\n\r\n    const roles = [\r\n        { id: \"researcher\", label: \"Researcher\", icon: GraduationCap },\r\n        { id: \"policymaker\", label: \"Policymaker\", icon: Briefcase },\r\n        { id: \"student\", label: \"Student\", icon: BookOpen },\r\n        { id: \"analyst\", label: \"Analyst\", icon: Eye },\r\n    ];\r\n\r\n    const concepts = [\r\n        {\r\n            title: \"Assemblage Theory\",\r\n            description: \"Socio-technical arrangements of humans, artifacts, and concepts.\",\r\n            icon: Users\r\n        },\r\n        {\r\n            title: \"Legitimacy Dynamics\",\r\n            description: \"How power is justified, challenged, and maintained in the ecosystem.\",\r\n            icon: Globe\r\n        },\r\n        {\r\n            title: \"Resistance Strategies\",\r\n            description: \"Micro-political acts that contest dominant power structures.\",\r\n            icon: Network\r\n        },\r\n        {\r\n            title: \"Rhizomatic Navigation\",\r\n            description: \"Exploring data through connections rather than a linear path (like browsing Wikipedia).\",\r\n            context: \"Contrast to 'arborescent' (tree-like) hierarchies.\",\r\n            icon: Network\r\n        }\r\n    ];\r\n\r\n    const [conceptIndex, setConceptIndex] = useState(0);\r\n\r\n    return (\r\n        <Dialog open={true}>\r\n            <DialogContent className=\"sm:max-w-xl p-0 overflow-hidden bg-white border-none shadow-2xl\">\r\n                <DialogTitle className=\"sr-only\">Onboarding Wizard</DialogTitle>\r\n                <div className=\"flex h-[400px]\">\r\n                    {/* Left Panel: Progress / Art */}\r\n                    <div className=\"w-1/3 bg-slate-900 p-6 flex flex-col justify-between text-white\">\r\n                        <div>\r\n                            <div className=\"flex items-center gap-2 font-bold tracking-tight mb-8\">\r\n                                <Network className=\"h-5 w-5 text-emerald-400\" />\r\n                                Assemblage AI\r\n                            </div>\r\n                            <div className=\"space-y-4\">\r\n                                {[1, 2, 3, 4].map(s => (\r\n                                    <div key={s} className={`flex items-center gap-3 text-sm ${step === s ? \"text-white font-medium\" : \"text-slate-500\"}`}>\r\n                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs border ${step === s ? \"border-emerald-500 bg-emerald-500/20 text-emerald-400\" : \"border-slate-700 bg-slate-800\"}`}>\r\n                                            {s}\r\n                                        </div>\r\n                                        <span>\r\n                                            {s === 1 && \"Welcome\"}\r\n                                            {s === 2 && \"Role\"}\r\n                                            {s === 3 && \"Concepts\"}\r\n                                            {s === 4 && \"Ready\"}\r\n                                        </span>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-xs text-slate-500\">\r\n                            v0.1.0 Beta\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Right Panel: Content */}\r\n                    <div className=\"w-2/3 p-8 flex flex-col\">\r\n                        <div className=\"flex-1\">\r\n                            {step === 1 && (\r\n                                <div className=\"space-y-4 animate-in fade-in slide-in-from-right-4 duration-300\">\r\n                                    <h2 className=\"text-2xl font-bold text-slate-900\">Welcome to the Field</h2>\r\n                                    <p className=\"text-slate-600 leading-relaxed\">\r\n                                        This tool maps the complex **assemblages** of AI governanceâ€”connecting policy, technology, and social dynamics.\r\n                                    </p>\r\n                                    <div className=\"bg-slate-50 p-4 rounded-lg border border-slate-100 text-sm text-slate-600 italic\">\r\n                                        \"To understand AI, we must trace the network of relations that sustain it.\"\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === 2 && (\r\n                                <div className=\"space-y-4 animate-in fade-in slide-in-from-right-4 duration-300\">\r\n                                    <h2 className=\"text-xl font-bold text-slate-900\">Identify Your Position</h2>\r\n                                    <p className=\"text-slate-500 text-sm\">How do you primarily engage with this field?</p>\r\n                                    <div className=\"grid grid-cols-2 gap-3 mt-4\">\r\n                                        {roles.map(role => {\r\n                                            const Icon = role.icon;\r\n                                            return (\r\n                                                <button\r\n                                                    key={role.id}\r\n                                                    onClick={() => setUserRole(role.id)}\r\n                                                    className={`p-3 rounded-lg border text-left transition-all ${userRole === role.id\r\n                                                        ? \"border-emerald-500 bg-emerald-50 ring-1 ring-emerald-500\"\r\n                                                        : \"border-slate-200 hover:border-slate-300 hover:bg-slate-50\"\r\n                                                        }`}\r\n                                                >\r\n                                                    <Icon className={`h-5 w-5 mb-2 ${userRole === role.id ? \"text-emerald-600\" : \"text-slate-400\"}`} />\r\n                                                    <div className={`font-medium text-sm ${userRole === role.id ? \"text-emerald-900\" : \"text-slate-700\"}`}>{role.label}</div>\r\n                                                </button>\r\n                                            )\r\n                                        })}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === 3 && (\r\n                                <div className=\"space-y-4 animate-in fade-in slide-in-from-right-4 duration-300\">\r\n                                    <h2 className=\"text-xl font-bold text-slate-900\">Core Concepts</h2>\r\n                                    <Card className=\"border-slate-200 shadow-sm\">\r\n                                        <CardContent className=\"p-5 h-[180px] flex flex-col justify-center text-center\">\r\n                                            {React.createElement(concepts[conceptIndex].icon, { className: \"h-8 w-8 mx-auto mb-3 text-indigo-500\" })}\r\n                                            <h3 className=\"font-bold text-slate-900 mb-2\">{concepts[conceptIndex].title}</h3>\r\n                                            <p className=\"text-sm text-slate-600\">{concepts[conceptIndex].description}</p>\r\n                                            {concepts[conceptIndex].context && (\r\n                                                <p className=\"text-xs text-slate-400 mt-2 italic\">{concepts[conceptIndex].context}</p>\r\n                                            )}\r\n                                        </CardContent>\r\n                                    </Card>\r\n                                    <div className=\"flex justify-center gap-2 mt-2\">\r\n                                        {concepts.map((_, i) => (\r\n                                            <button\r\n                                                key={i}\r\n                                                onClick={() => setConceptIndex(i)}\r\n                                                className={`w-2 h-2 rounded-full transition-all ${i === conceptIndex ? \"bg-indigo-600 w-4\" : \"bg-slate-300\"}`}\r\n                                            />\r\n                                        ))}\r\n                                    </div>\r\n                                    <div className=\"flex justify-between text-xs text-slate-400 px-2\">\r\n                                        <button onClick={() => setConceptIndex((i) => Math.max(0, i - 1))} disabled={conceptIndex === 0}>Prev</button>\r\n                                        <button onClick={() => setConceptIndex((i) => Math.min(concepts.length - 1, i + 1))} disabled={conceptIndex === concepts.length - 1}>Next</button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {step === 4 && (\r\n                                <div className=\"space-y-4 animate-in fade-in slide-in-from-right-4 duration-300 text-center py-8\">\r\n                                    <div className=\"w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                                        <Sparkles className=\"h-8 w-8 text-emerald-600\" />\r\n                                    </div>\r\n                                    <h2 className=\"text-2xl font-bold text-slate-900\">Ready to Explore</h2>\r\n                                    <p className=\"text-slate-600\">\r\n                                        You are now ready to navigate the ecosystem rhizomatically.\r\n                                    </p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"flex justify-end pt-6 border-t border-slate-100 mt-auto\">\r\n                            {step < totalSteps ? (\r\n                                <Button onClick={nextStep} className=\"bg-slate-900 hover:bg-slate-800 text-white gap-2\">\r\n                                    Next <ArrowRight className=\"h-4 w-4\" />\r\n                                </Button>\r\n                            ) : (\r\n                                <Button onClick={onComplete} className=\"bg-emerald-600 hover:bg-emerald-700 text-white gap-2 shadow-lg shadow-emerald-200\">\r\n                                    Start Tutorial <ArrowRight className=\"h-4 w-4\" />\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n\r\n// Icon helper\r\nfunction Sparkles(props: any) {\r\n    return (\r\n        <svg\r\n            {...props}\r\n            xmlns=\"http://www.w3.org/2000/svg\"\r\n            width=\"24\"\r\n            height=\"24\"\r\n            viewBox=\"0 0 24 24\"\r\n            fill=\"none\"\r\n            stroke=\"currentColor\"\r\n            strokeWidth=\"2\"\r\n            strokeLinecap=\"round\"\r\n            strokeLinejoin=\"round\"\r\n        >\r\n            <path d=\"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z\" />\r\n        </svg>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\AssemblageGauges.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":115,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6085,6120],"text":"\r\n                                &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6085,6120],"text":"\r\n                                &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6085,6120],"text":"\r\n                                &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6085,6120],"text":"\r\n                                &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":115,"column":88,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6174,6205],"text":"&quot;\r\n                            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6174,6205],"text":"&ldquo;\r\n                            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6174,6205],"text":"&#34;\r\n                            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6174,6205],"text":"&rdquo;\r\n                            "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":125,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6791,6826],"text":"\r\n                                &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6791,6826],"text":"\r\n                                &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6791,6826],"text":"\r\n                                &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6791,6826],"text":"\r\n                                &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":125,"column":76,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6868,6899],"text":"&quot;\r\n                            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6868,6899],"text":"&ldquo;\r\n                            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6868,6899],"text":"&#34;\r\n                            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6868,6899],"text":"&rdquo;\r\n                            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Info } from \"lucide-react\";\r\n\r\ninterface Metric {\r\n    jurisdiction: string;\r\n    territorialization: number;\r\n    territorialization_justification: string;\r\n    coding: number;\r\n    coding_justification: string;\r\n}\r\n\r\ninterface AssemblageGaugesProps {\r\n    metrics?: Metric[];\r\n}\r\n\r\nconst Dial = ({ value, label, color, description, comparisonValues = [] }: { value: number, label: string, color: string, description: string, comparisonValues?: number[] }) => {\r\n    // Convert 0-100 to Angle (-90 to 90 degrees)\r\n    const angle = (val: number) => (val / 100) * 180 - 90;\r\n\r\n    return (\r\n        <div className=\"flex flex-col items-center\">\r\n            <div className=\"relative w-36 h-20 overflow-hidden mb-2 group cursor-help transition-all hover:scale-105\">\r\n                {/* Gauge Background */}\r\n                <div className=\"absolute bottom-0 w-36 h-36 rounded-full border-[14px] border-slate-100 border-t-transparent border-l-transparent border-r-transparent transform rotate-45\" />\r\n\r\n                {/* Ghost Needles (Comparison) */}\r\n                {comparisonValues.map((val, idx) => (\r\n                    <div\r\n                        key={`ghost-${idx}`}\r\n                        className=\"absolute bottom-0 left-1/2 w-0.5 h-28 bg-slate-300 origin-bottom rounded-full z-0 opacity-60\"\r\n                        style={{ transform: `translateX(-50%) rotate(${angle(val)}deg)` }}\r\n                    />\r\n                ))}\r\n\r\n                {/* Limit markers (optional visual flair for 0 and 100) */}\r\n                <div className=\"absolute bottom-1 left-2 w-1 h-3 bg-slate-200 rotate-[-90deg]\"></div>\r\n                <div className=\"absolute bottom-1 right-2 w-1 h-3 bg-slate-200 rotate-[90deg]\"></div>\r\n\r\n                {/* Primary Needle */}\r\n                <div\r\n                    className={`absolute bottom-0 left-1/2 w-1.5 h-28 ${color.replace('text-', 'bg-')} origin-bottom rounded-full transition-transform duration-1000 ease-out z-10 shadow-sm`}\r\n                    style={{ transform: `translateX(-50%) rotate(${angle(value)}deg)` }}\r\n                />\r\n\r\n                {/* Pivot */}\r\n                <div className=\"absolute bottom-0 left-1/2 w-5 h-5 bg-slate-800 rounded-full transform -translate-x-1/2 translate-y-1/2 z-20 border-2 border-white shadow-md\" />\r\n\r\n                {/* Tooltip */}\r\n                <div className=\"opacity-0 group-hover:opacity-100 transition-opacity absolute top-0 left-0 right-0 bg-slate-900 text-white text-[10px] p-2 rounded shadow-lg text-center z-50 pointer-events-none mt-4 mx-2\">\r\n                    {description}\r\n                    {comparisonValues.length > 0 && <div className=\"mt-1 text-slate-400 border-t border-slate-700 pt-1 font-mono text-[9px]\">Others: {comparisonValues.join(', ')}</div>}\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"text-center mt-2\">\r\n                <div className=\"text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-0.5\">{label}</div>\r\n                <div className={`text-2xl font-black ${color} tabular-nums leading-none`}>{value}</div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst GaugePanel = ({ metric, allMetrics }: { metric: Metric, allMetrics: Metric[] }) => {\r\n    // Get comparison values for this specific gauge type, excluding self\r\n    const otherTerritorialization = allMetrics\r\n        .filter(m => m.jurisdiction !== metric.jurisdiction)\r\n        .map(m => m.territorialization);\r\n\r\n    const otherCoding = allMetrics\r\n        .filter(m => m.jurisdiction !== metric.jurisdiction)\r\n        .map(m => m.coding);\r\n\r\n    return (\r\n        <Card className=\"bg-gradient-to-b from-white to-slate-50 border-slate-200 shadow-sm hover:shadow-md transition-shadow\">\r\n            <CardContent className=\"p-6\">\r\n                <div className=\"text-center mb-6 border-b border-slate-100 pb-3\">\r\n                    <Badge variant=\"outline\" className=\"bg-white text-slate-900 border-slate-300 font-bold px-4 py-1.5 shadow-sm text-sm\">\r\n                        {metric.jurisdiction.toUpperCase()}\r\n                    </Badge>\r\n                </div>\r\n\r\n                <div className=\"flex justify-around items-end gap-2 mb-8\">\r\n                    <Dial\r\n                        value={metric.territorialization}\r\n                        label=\"Territorialization\"\r\n                        color=\"text-red-600\"\r\n                        description={metric.territorialization_justification}\r\n                        comparisonValues={otherTerritorialization}\r\n                    />\r\n                    <Dial\r\n                        value={metric.coding}\r\n                        label=\"Coding\"\r\n                        color=\"text-indigo-600\"\r\n                        description={metric.coding_justification}\r\n                        comparisonValues={otherCoding}\r\n                    />\r\n                </div>\r\n\r\n                {/* Score Computation Logic */}\r\n                <div className=\"bg-slate-50 rounded-lg p-4 text-sm text-slate-700 border border-slate-200 shadow-sm mt-4\">\r\n                    <div className=\"font-bold text-slate-900 mb-3 flex items-center gap-2 uppercase tracking-wide text-xs\">\r\n                        <Info className=\"h-3 w-3 text-slate-500\" />\r\n                        Score Computation Logic\r\n                    </div>\r\n\r\n                    <div className=\"space-y-4\">\r\n                        <div className=\"relative pl-3 border-l-2 border-red-500\">\r\n                            <div className=\"flex justify-between items-baseline mb-1\">\r\n                                <span className=\"font-bold text-red-900 text-xs uppercase\">Territorialization (Rigidity)</span>\r\n                                <span className=\"text-[10px] text-slate-500\">How strictly are boundaries defined?</span>\r\n                            </div>\r\n                            <p className=\"italic text-slate-600 leading-relaxed text-xs\">\r\n                                \"{metric.territorialization_justification || 'No data'}\"\r\n                            </p>\r\n                        </div>\r\n\r\n                        <div className=\"relative pl-3 border-l-2 border-indigo-500\">\r\n                            <div className=\"flex justify-between items-baseline mb-1\">\r\n                                <span className=\"font-bold text-indigo-900 text-xs uppercase\">Coding (Formalization)</span>\r\n                                <span className=\"text-[10px] text-slate-500\">How dense are the rules/definitions?</span>\r\n                            </div>\r\n                            <p className=\"italic text-slate-600 leading-relaxed text-xs\">\r\n                                \"{metric.coding_justification || 'No data'}\"\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n};\r\n\r\nexport function AssemblageGauges({ metrics }: AssemblageGaugesProps) {\r\n    if (!metrics || metrics.length === 0) {\r\n        return (\r\n            <div className=\"text-center p-8 bg-slate-50 rounded-lg border border-dashed border-slate-300\">\r\n                <Info className=\"h-8 w-8 text-slate-400 mx-auto mb-2\" />\r\n                <p className=\"text-slate-500\">No assemblage metrics available. Run a new synthesis to generate gauge data.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 my-8\">\r\n            {metrics.map((metric, idx) => (\r\n                <GaugePanel key={idx} metric={metric} allMetrics={metrics} />\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\ComparisonView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Select' is defined but never used.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectContent' is defined but never used.","line":7,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectItem' is defined but never used.","line":7,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectTrigger' is defined but never used.","line":7,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectValue' is defined but never used.","line":7,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sources' is defined but never used.","line":17,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { ComparisonResult } from '@/types/ontology';\r\nimport { Source } from '@/types'; // Import Source type\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { SystemCritiqueSection } from \"@/components/common/SystemCritiqueSection\";\r\nimport { ConceptCard } from './ConceptCard';\r\nimport { AssemblageGauges } from './AssemblageGauges';\r\n\r\ninterface ComparisonViewProps {\r\n    result: ComparisonResult;\r\n    sources: Source[];\r\n}\r\n\r\nexport function ComparisonView({ result, sources }: ComparisonViewProps) {\r\n    // Legacy visualization state removed in favor of AssemblageGauges\r\n\r\n    return (\r\n        <div className=\"space-y-8 animate-in fade-in duration-500\">\r\n            {/* Interactive Assemblage Gauges (The \"Machine\") */}\r\n            <div className=\"space-y-4\">\r\n                <h3 className=\"text-xl font-bold text-slate-900 flex items-center gap-2\">\r\n                    Assemblage Metrics\r\n                </h3>\r\n                <p className=\"text-slate-500 text-sm\">\r\n                    AI-derived scores for Territorialization (Rigidity) and Coding (Rule Density).\r\n                </p>\r\n                <AssemblageGauges metrics={result.assemblage_metrics} />\r\n            </div>\r\n\r\n            {/* Comparison Summary */}\r\n            <Card className=\"bg-indigo-50 border-indigo-200\">\r\n                <CardHeader>\r\n                    <CardTitle className=\"text-xl text-indigo-900\">\r\n                        Comparison Summary\r\n                    </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <p className=\"text-indigo-800 leading-relaxed font-medium\">\r\n                        {result.summary}\r\n                    </p>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <Card>\r\n                    <CardHeader>\r\n                        <CardTitle className=\"text-base\">Structural Differences</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        <p className=\"text-sm text-slate-600 leading-relaxed\">\r\n                            {result.structural_differences}\r\n                        </p>\r\n                    </CardContent>\r\n                </Card>\r\n                <ConceptCard\r\n                    title=\"Shared Concepts\"\r\n                    concepts={result.shared_concepts}\r\n                    variant=\"outline\"\r\n                    className=\"bg-white\" // ensure bg matches previous visual if needed, though default card is usually white\r\n                // Outline badges previously had: className=\"bg-green-50 text-green-700 border-green-200\"\r\n                // ConceptCard variant='outline' gives default outline. \r\n                // I might need to adjust ConceptCard to support custom badge classes if strict visual parity is needed.\r\n                // For now, standard 'outline' is acceptable for a clean refactor.\r\n                />\r\n            </div>\r\n\r\n            <div className={`grid grid-cols-1 md:gap-6 ${result.sourceCId ? 'md:grid-cols-3' : 'md:grid-cols-2'}`}>\r\n                <ConceptCard\r\n                    title=\"Unique to Source A\"\r\n                    concepts={result.unique_concepts_source_a}\r\n                />\r\n                <ConceptCard\r\n                    title=\"Unique to Source B\"\r\n                    concepts={result.unique_concepts_source_b}\r\n                />\r\n                {result.sourceCId && (\r\n                    <ConceptCard\r\n                        title=\"Unique to Source C\"\r\n                        concepts={result.unique_concepts_source_c || []}\r\n                        emptyMessage=\"No unique concepts identified.\"\r\n                    />\r\n                )}\r\n            </div>\r\n\r\n            {/* System Critique (Devil's Advocate) */}\r\n            {result.system_critique && (\r\n                <SystemCritiqueSection critique={{\r\n                    ...result.system_critique,\r\n                    blind_spots: result.system_critique.blind_spots || [],\r\n                    critique: \"Comparison Critique\", // Default title\r\n                    implications: []\r\n                }} />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\ConceptCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\ConceptDetailsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\ConceptList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\MapGallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ontology\\OntologyMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\AddDocumentDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\AddUrlDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\AnalysisResults.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'InterpretationLens' is defined but never used.","line":37,"column":6,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":24},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":508,"column":49,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the &quot;Devil's Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the &ldquo;Devil's Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the &#34;Devil's Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the &rdquo;Devil's Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":508,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil&apos;s Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil&lsquo;s Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil&#39;s Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil&rsquo;s Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":508,"column":66,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil's Advocate&quot; protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil's Advocate&ldquo; protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil's Advocate&#34; protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[27942,28107],"text":"\r\n                                        Run the \"Devil's Advocate&rdquo; protocol to identify blind spots and over-interpretations.\r\n                                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { AnalysisResult } from \"@/types\";\r\nimport { Sparkles, Scale, Users, Hand, Eye, ShieldCheck, Landmark, Activity, AlertTriangle, LayoutDashboard, Layers, BadgeCheck, MessageSquareDashed } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { GovernanceCompass } from \"./GovernanceCompass\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\n\r\nimport { ValidationSection } from \"./analysis/ValidationSection\";\r\nimport { DimensionCard } from \"./analysis/DimensionCard\";\r\nimport { DynamicsCard } from \"./analysis/DynamicsCard\";\r\nimport { VerifiedEvidenceSection } from \"./analysis/VerifiedEvidenceSection\";\r\nimport { StressTestSection } from \"./analysis/StressTestSection\";\r\nimport { CulturalHolesSection } from \"./analysis/CulturalHolesSection\";\r\nimport { VerificationPathwaysTable } from \"./analysis/VerificationPathwaysTable\";\r\nimport { SystemCritiqueSection } from \"@/components/common/SystemCritiqueSection\";\r\nimport { calculateMicroFascismRisk } from \"@/lib/risk-calculator\";\r\nimport { MicroFascismRiskCard } from \"./analysis/MicroFascismRiskCard\";\r\nimport { calculateLiberatoryCapacity } from \"@/lib/liberatory-calculator\";\r\nimport { LiberatoryCapacityCard } from \"./analysis/LiberatoryCapacityCard\";\r\nimport { AccountabilitySection } from \"./analysis/AccountabilitySection\";\r\nimport { InterpretationLensSelector } from \"./analysis/InterpretationLensSelector\";\r\nimport { DEFAULT_PERSPECTIVE_A, DEFAULT_PERSPECTIVE_B } from \"@/lib/perspectives\";\r\nimport { BASELINE_SOURCES } from '@/lib/data/baselines';\r\nimport { MaterializeDialog } from \"@/components/policy/MaterializeDialog\";\r\nimport { EcosystemActor } from \"@/types/ecosystem\";\r\n\r\ninterface AnalysisResultsProps {\r\n    analysis: NonNullable<AnalysisResult>;\r\n    sourceTitle?: string;\r\n    sourceId?: string; // Need ID for linking\r\n    onUpdate?: (updates: Partial<AnalysisResult>) => Promise<void>;\r\n    onAddActor?: (entity: EcosystemActor) => Promise<void>;\r\n    ecosystemActors?: EcosystemActor[]; // List of existing actors for de-duplication\r\n    onViewActor?: (name: string) => void;\r\n}\r\n\r\ntype InterpretationLens = 'default' | string; // 'default' or perspective ID\r\n\r\nexport function AnalysisResults({ analysis, sourceTitle, sourceId, onUpdate, onAddActor, ecosystemActors = [], onViewActor }: AnalysisResultsProps) {\r\n    // FALLBACK: Inject baseline data for demo logic if missing from props\r\n    const baselineMatch = BASELINE_SOURCES.find(b => b.title === sourceTitle);\r\n\r\n    // Materialization State\r\n    const [materializeDialog, setMaterializeDialog] = useState<{\r\n        isOpen: boolean;\r\n        name: string;\r\n        detail: string;\r\n        context: \"accountability\" | \"legitimacy\" | \"trace\";\r\n    }>({\r\n        isOpen: false,\r\n        name: \"\",\r\n        detail: \"\",\r\n        context: \"accountability\"\r\n    });\r\n    const effectiveAnalysis = { ...analysis };\r\n\r\n    // Helper to get list of existing actor names for checking duplicates\r\n    const existingActorNames = ecosystemActors.map(a => a.name);\r\n\r\n    if (baselineMatch) {\r\n        if (!effectiveAnalysis.accountability_map && baselineMatch.analysis?.accountability_map) {\r\n            effectiveAnalysis.accountability_map = baselineMatch.analysis.accountability_map;\r\n        }\r\n        if (!effectiveAnalysis.rebuttals && baselineMatch.analysis?.rebuttals) {\r\n            effectiveAnalysis.rebuttals = baselineMatch.analysis.rebuttals;\r\n        }\r\n    }\r\n\r\n    console.log(\"DEBUG: AnalysisResults Rendered\", {\r\n        hasAccountability: !!effectiveAnalysis.accountability_map,\r\n        hasRebuttals: !!effectiveAnalysis.rebuttals,\r\n        keys: Object.keys(effectiveAnalysis)\r\n    });\r\n\r\n    const [activeLens, setActiveLens] = useState<string>('default');\r\n    const riskAnalysis = calculateMicroFascismRisk(effectiveAnalysis);\r\n    const liberatoryCapacity = calculateLiberatoryCapacity(effectiveAnalysis);\r\n    const [userImpression] = useState(effectiveAnalysis.user_impression || \"\");\r\n    const [isCritiqueLoading, setIsCritiqueLoading] = useState(false);\r\n    const [critiqueResult, setCritiqueResult] = useState<AnalysisResult['system_critique'] | null>(null);\r\n    const [critiqueError, setCritiqueError] = useState<string | null>(null);\r\n\r\n    // Interpretation Sets (DR2) State\r\n    const [perspectiveResults, setPerspectiveResults] = useState<Record<string, string> | null>(effectiveAnalysis.perspectives || null);\r\n    const [isSimulating, setIsSimulating] = useState(false);\r\n\r\n    const handleGeneratePerspectives = async () => {\r\n        setIsSimulating(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/simulate-perspectives', {\r\n                method: 'POST',\r\n                headers,\r\n                body: JSON.stringify({\r\n                    topic: sourceTitle,\r\n                    perspectiveAId: DEFAULT_PERSPECTIVE_A.id,\r\n                    perspectiveBId: DEFAULT_PERSPECTIVE_B.id\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success && data.perspectives) {\r\n                // Map API response to our state structure\r\n                // API returns: { perspectiveA: \"text\", perspectiveB: \"text\" }\r\n                const newPerspectives = {\r\n                    [DEFAULT_PERSPECTIVE_A.id]: data.perspectives.perspectiveA,\r\n                    [DEFAULT_PERSPECTIVE_B.id]: data.perspectives.perspectiveB\r\n                };\r\n\r\n                setPerspectiveResults(newPerspectives);\r\n\r\n                // Cache results to the database (via source update)\r\n                if (onUpdate) {\r\n                    onUpdate({ perspectives: newPerspectives });\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Simulation failed:\", error);\r\n            alert(\"Failed to generate perspective simulation.\");\r\n        } finally {\r\n            setIsSimulating(false);\r\n        }\r\n    };\r\n\r\n    // Determine current display content based on lens\r\n    const getCurrentContent = () => {\r\n        if (activeLens === 'default') {\r\n            return {\r\n                title: \"Key Insight\",\r\n                text: effectiveAnalysis.key_insight,\r\n                colorClass: \"bg-purple-100 text-purple-600\",\r\n                bgGradient: \"from-purple-50 to-indigo-50\",\r\n                borderClass: \"border-purple-100\"\r\n            };\r\n        }\r\n\r\n        const resultText = perspectiveResults?.[activeLens];\r\n        if (!resultText) return null;\r\n\r\n        const isLensA = activeLens === DEFAULT_PERSPECTIVE_A.id;\r\n\r\n        return {\r\n            title: isLensA ? DEFAULT_PERSPECTIVE_A.name : DEFAULT_PERSPECTIVE_B.name,\r\n            text: resultText,\r\n            colorClass: isLensA ? \"bg-indigo-100 text-indigo-700\" : \"bg-rose-100 text-rose-700\",\r\n            bgGradient: isLensA ? \"from-indigo-50 to-blue-50\" : \"from-rose-50 to-orange-50\",\r\n            borderClass: isLensA ? \"border-indigo-100\" : \"border-rose-100\"\r\n        };\r\n    };\r\n\r\n    const currentDisplay = getCurrentContent();\r\n\r\n    const handleRunCritique = async () => {\r\n        setIsCritiqueLoading(true);\r\n        setCritiqueError(null);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            const response = await fetch('/api/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    analysisMode: 'critique',\r\n                    text: sourceTitle || \"Source Text\", // Context\r\n                    existingAnalysis: analysis\r\n                })\r\n            });\r\n            const data = await response.json();\r\n\r\n            if (data.success && data.analysis?.system_critique) {\r\n                setCritiqueResult(data.analysis.system_critique);\r\n                if (onUpdate) {\r\n                    onUpdate({ system_critique: data.analysis.system_critique });\r\n                }\r\n            } else {\r\n                setCritiqueError(data.error || \"Failed to generate critique.\");\r\n            }\r\n        } catch (err) {\r\n            setCritiqueError(\"Network error.\");\r\n            console.error(err);\r\n        } finally {\r\n            setIsCritiqueLoading(false);\r\n        }\r\n    };\r\n\r\n    // Data Presence Checks\r\n    // Force accountability section to show (even if empty) by defaulting to an empty object\r\n    const accountabilityData = effectiveAnalysis.accountability_map || {\r\n        signatory: \"\",\r\n        liability_holder: \"\",\r\n        appeals_mechanism: \"\",\r\n        human_in_the_loop: undefined\r\n    };\r\n\r\n    const hasAccountability = true; // Always show now\r\n\r\n    const hasGovernanceScores = !!(\r\n        effectiveAnalysis.governance_scores &&\r\n        typeof effectiveAnalysis.governance_scores.rights_focus === 'number' &&\r\n        typeof effectiveAnalysis.governance_scores.procedurality === 'number'\r\n    );\r\n\r\n\r\n    const hasUserImpression = !!(userImpression && userImpression.trim().length > 0);\r\n\r\n    return (\r\n        <div className=\"mt-6 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n\r\n            {/* --- TOP LEVEL CONTEXT (Always Visible) --- */}\r\n\r\n            {onAddActor && (\r\n                <MaterializeDialog\r\n                    isOpen={materializeDialog.isOpen}\r\n                    onClose={() => setMaterializeDialog(prev => ({ ...prev, isOpen: false }))}\r\n                    initialName={materializeDialog.name}\r\n                    initialDescription={`Identified in ${materializeDialog.context} analysis of ${sourceTitle}.`}\r\n                    sourceContext={{\r\n                        sourceId: sourceId || \"unknown\",\r\n                        type: materializeDialog.context,\r\n                        detail: materializeDialog.detail\r\n                    }}\r\n                    onConfirm={async (actorData) => {\r\n                        if (onAddActor) {\r\n                            const newActor: EcosystemActor = {\r\n                                ...actorData, // Spread the Omit<EcosystemActor, \"id\"> properties\r\n                                id: `temp-${Date.now()}`,\r\n                            };\r\n                            await onAddActor(newActor);\r\n                        }\r\n                    }}\r\n                />\r\n            )}\r\n\r\n            {/* Interpretation Lens Selector */}\r\n            <InterpretationLensSelector\r\n                currentLens={activeLens}\r\n                onLensChange={setActiveLens}\r\n                onGenerate={handleGeneratePerspectives}\r\n                isGenerating={isSimulating}\r\n                hasResults={!!perspectiveResults}\r\n            />\r\n\r\n            {/* Key Insight Hero Section (Dynamic) */}\r\n            {currentDisplay && (\r\n                <div className={`relative overflow-hidden rounded-xl bg-gradient-to-br ${currentDisplay.bgGradient} border ${currentDisplay.borderClass} p-5 shadow-sm transition-all duration-500`}>\r\n                    <div className={`absolute top-0 right-0 -mt-4 -mr-4 h-24 w-24 rounded-full blur-2xl opacity-50 ${currentDisplay.colorClass}`}></div>\r\n                    <div className=\"relative flex items-start gap-3\">\r\n                        <div className={`p-2 bg-white rounded-lg shadow-sm shrink-0`}>\r\n                            <Sparkles className={`h-5 w-5 ${currentDisplay.colorClass.split(' ')[1]}`} />\r\n                        </div>\r\n                        <div>\r\n                            <h4 className={`text-xs font-bold uppercase tracking-widest mb-2 ${currentDisplay.colorClass.split(' ')[1]}`}>\r\n                                {currentDisplay.title} {activeLens !== 'default' && <span className=\"opacity-70\">(Simulated)</span>}\r\n                            </h4>\r\n                            <p className=\"text-sm font-medium text-slate-800 leading-relaxed italic\">\r\n                                &quot;{currentDisplay.text}&quot;\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Verification Gap Alert */}\r\n            {effectiveAnalysis.verification_gap?.high_rhetoric_low_verification && (\r\n                <div className=\"flex items-start gap-3 p-4 rounded-lg bg-red-50 border border-red-200 text-red-900 animate-pulse\">\r\n                    <AlertTriangle className=\"h-5 w-5 shrink-0 mt-0.5 text-red-600\" />\r\n                    <div>\r\n                        <h4 className=\"text-sm font-bold uppercase tracking-wide mb-1\">Warning: Verification Gap Detected</h4>\r\n                        <p className=\"text-xs leading-relaxed\">\r\n                            {effectiveAnalysis.verification_gap?.gap_explanation}\r\n                        </p>\r\n                        <p className=\"text-[10px] mt-2 font-mono text-red-700 uppercase\">\r\n                            High Rhetoric / Low Verification â€¢ Potential Purpose Drift\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* --- TABS --- */}\r\n            <Tabs defaultValue=\"diagnostic\" className=\"w-full\">\r\n                <TabsList className=\"grid w-full grid-cols-4 bg-slate-100/50 p-1\">\r\n                    <TabsTrigger value=\"diagnostic\" className=\"text-xs uppercase font-bold text-slate-500 data-[state=active]:text-slate-800 data-[state=active]:shadow-sm\">\r\n                        <LayoutDashboard className=\"h-3 w-3 mr-2\" /> Diagnostic\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"dialectics\" className=\"text-xs uppercase font-bold text-slate-500 data-[state=active]:text-slate-800 data-[state=active]:shadow-sm\">\r\n                        <Scale className=\"h-3 w-3 mr-2\" /> Dialectics\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"deep-analysis\" className=\"text-xs uppercase font-bold text-slate-500 data-[state=active]:text-slate-800 data-[state=active]:shadow-sm\">\r\n                        <Layers className=\"h-3 w-3 mr-2\" /> Deep Analysis\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"critique\" className=\"text-xs uppercase font-bold text-slate-500 data-[state=active]:text-slate-800 data-[state=active]:shadow-sm\">\r\n                        <MessageSquareDashed className=\"h-3 w-3 mr-2\" /> Reflexivity\r\n                    </TabsTrigger>\r\n                    <TabsTrigger value=\"audit\" className=\"text-xs uppercase font-bold text-slate-500 data-[state=active]:text-slate-800 data-[state=active]:shadow-sm\">\r\n                        <BadgeCheck className=\"h-3 w-3 mr-2\" /> Audit\r\n                    </TabsTrigger>\r\n                </TabsList>\r\n\r\n                {/* 1. DIAGNOSTIC TAB */}\r\n                <TabsContent value=\"diagnostic\" className=\"space-y-6 mt-4 animate-in fade-in-50 duration-300\">\r\n\r\n                    {/* User's Impression & Governance Compass */}\r\n                    {(hasUserImpression || hasGovernanceScores) && (\r\n                        <div className=\"grid md:grid-cols-2 gap-6 items-start\">\r\n                            {hasUserImpression && (\r\n                                <div className=\"p-4 rounded-lg bg-slate-50 border border-slate-200 space-y-2 h-full\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <h5 className=\"text-xs font-bold text-slate-500 uppercase\">Your Initial Anchor</h5>\r\n                                        {effectiveAnalysis.anchor_bias_choice && (\r\n                                            <span className={`text-[10px] font-bold px-2 py-1 rounded-full uppercase ${effectiveAnalysis.anchor_bias_choice === 'extractive_asymmetrical' ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`}>\r\n                                                {effectiveAnalysis.anchor_bias_choice.replace('_', ' ')}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                    <p className=\"text-sm text-slate-800 italic\">&quot;{userImpression}&quot;</p>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Governance Compass */}\r\n                            {hasGovernanceScores && effectiveAnalysis.governance_scores && (\r\n                                <div className=\"h-full\">\r\n                                    <GovernanceCompass\r\n                                        rhetoricScore={effectiveAnalysis.governance_scores.rights_focus}\r\n                                        realityScore={effectiveAnalysis.governance_scores.procedurality}\r\n                                        driftExplanation={effectiveAnalysis.verification_gap?.gap_explanation}\r\n                                        scoreExplanations={effectiveAnalysis.governance_score_explanations}\r\n                                    />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Always render Accountability Section (with defaults if needed) */}\r\n                    <AccountabilitySection\r\n                        accountability={accountabilityData}\r\n                        onMaterialize={(entity) => setMaterializeDialog({\r\n                            isOpen: true,\r\n                            name: entity.name,\r\n                            detail: entity.detail,\r\n                            context: \"accountability\"\r\n                        })}\r\n                        existingActors={existingActorNames}\r\n                        onViewActor={onViewActor}\r\n                    />\r\n\r\n                    {/* Empty State */}\r\n                    {!hasUserImpression && !hasGovernanceScores && !hasAccountability && (\r\n                        <div className=\"p-8 text-center bg-slate-50 rounded-xl border border-dashed border-slate-200\">\r\n                            <p className=\"text-slate-500 italic\">No diagnostic signals detected. Try running a deeper analysis or checking a different document.</p>\r\n                        </div>\r\n                    )}\r\n\r\n\r\n                </TabsContent>\r\n\r\n                {/* DB. DIALECTICS TAB (New) */}\r\n                <TabsContent value=\"dialectics\" className=\"space-y-6 mt-4 animate-in fade-in-50 duration-300\">\r\n\r\n                    <div className=\"p-4 bg-slate-50 rounded-lg border border-slate-100 text-center mb-6\">\r\n                        <p className=\"text-xs text-slate-400 uppercase tracking-widest\">\r\n                            Dialectical Reading: Hardening vs. Opening\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Dialectical Risk/Capacity Cards */}\r\n                    <div className=\"grid md:grid-cols-2 gap-6 items-start\">\r\n                        <MicroFascismRiskCard risk={riskAnalysis} analysis={effectiveAnalysis} sourceTitle={sourceTitle} onUpdate={onUpdate} />\r\n                        <LiberatoryCapacityCard capacity={liberatoryCapacity} analysis={effectiveAnalysis} sourceTitle={sourceTitle} />\r\n                    </div>\r\n\r\n                </TabsContent>\r\n\r\n                {/* 2. DEEP ANALYSIS TAB */}\r\n                <TabsContent value=\"deep-analysis\" className=\"space-y-6 mt-4 animate-in fade-in-50 duration-300\">\r\n\r\n                    {/* Core Dimensions Grid */}\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <DimensionCard\r\n                            title=\"Governance & Power\"\r\n                            icon={<Landmark className=\"h-4 w-4 text-blue-600\" />}\r\n                            content={analysis.governance_power_accountability || 'No analysis available.'}\r\n                            color=\"blue\"\r\n                        />\r\n                        <DimensionCard\r\n                            title=\"Plurality & Inclusion\"\r\n                            icon={<Users className=\"h-4 w-4 text-pink-600\" />}\r\n                            content={analysis.plurality_inclusion_embodiment || 'No analysis available.'}\r\n                            color=\"pink\"\r\n                        />\r\n                        <DimensionCard\r\n                            title=\"Agency & Co-Design\"\r\n                            icon={<Hand className=\"h-4 w-4 text-emerald-600\" />}\r\n                            content={analysis.agency_codesign_self_determination || 'No analysis available.'}\r\n                            color=\"emerald\"\r\n                        />\r\n                        <DimensionCard\r\n                            title=\"Reflexivity\"\r\n                            icon={<Eye className=\"h-4 w-4 text-amber-600\" />}\r\n                            content={analysis.reflexivity_situated_praxis || 'No analysis available.'}\r\n                            color=\"amber\"\r\n                        />\r\n                        {analysis.coloniality_of_power && (\r\n                            <DimensionCard\r\n                                title=\"Coloniality of Power\"\r\n                                icon={<span className=\"text-red-600 font-bold text-xs border border-red-600 rounded px-0.5\">CP</span>}\r\n                                content={analysis.coloniality_of_power}\r\n                                color=\"red\"\r\n                            />\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Assemblage Dynamics Section */}\r\n                    {analysis.assemblage_dynamics && (\r\n                        <div className=\"rounded-xl border border-teal-200 bg-teal-50/50 overflow-hidden\">\r\n                            <div className=\"bg-teal-100/50 px-4 py-3 border-b border-teal-200 flex items-center gap-2\">\r\n                                <Activity className=\"h-4 w-4 text-teal-700\" />\r\n                                <h4 className=\"text-xs font-bold text-teal-900 uppercase tracking-wider\">Assemblage Dynamics</h4>\r\n                            </div>\r\n                            <div className=\"p-4 grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                <DynamicsCard\r\n                                    label=\"Territorialization\"\r\n                                    subLabel=\"(Stabilization)\"\r\n                                    content={analysis.assemblage_dynamics.territorialization}\r\n                                    color=\"teal\"\r\n                                />\r\n                                <DynamicsCard\r\n                                    label=\"Deterritorialization\"\r\n                                    subLabel=\"(Lines of Flight)\"\r\n                                    content={analysis.assemblage_dynamics.deterritorialization}\r\n                                    color=\"cyan\"\r\n                                />\r\n                                <div className=\"md:col-span-2\">\r\n                                    <DynamicsCard\r\n                                        label=\"Coding\"\r\n                                        subLabel=\"(Translation)\"\r\n                                        content={analysis.assemblage_dynamics.coding}\r\n                                        color=\"emerald\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Legitimacy */}\r\n                    {analysis.legitimacy_claims && (\r\n                        <div className=\"rounded-xl border border-amber-200 bg-amber-50/50 overflow-hidden\">\r\n                            <div className=\"bg-amber-100/50 px-4 py-3 border-b border-amber-200 flex items-center gap-2\">\r\n                                <Scale className=\"h-4 w-4 text-amber-700\" />\r\n                                <h4 className=\"text-xs font-bold text-amber-900 uppercase tracking-wider\">Legitimacy Claims Analysis</h4>\r\n                            </div>\r\n                            <div className=\"p-4 space-y-4\">\r\n                                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\r\n                                    <div className=\"bg-white p-3 rounded-lg border border-amber-100 shadow-sm\">\r\n                                        <span className=\"text-[10px] font-bold text-amber-600 uppercase block mb-1\">Source</span>\r\n                                        <p className=\"text-xs text-slate-700 font-medium\">{analysis.legitimacy_claims.source || 'N/A'}</p>\r\n                                    </div>\r\n                                    <div className=\"bg-white p-3 rounded-lg border border-amber-100 shadow-sm col-span-2\">\r\n                                        <span className=\"text-[10px] font-bold text-amber-600 uppercase block mb-1\">Mechanisms</span>\r\n                                        <p className=\"text-xs text-slate-700\">{analysis.legitimacy_claims.mechanisms || 'N/A'}</p>\r\n                                    </div>\r\n                                </div>\r\n                                {analysis.legitimacy_claims.tensions && (\r\n                                    <div className=\"bg-white/50 p-3 rounded-lg border border-amber-100/50\">\r\n                                        <span className=\"text-[10px] font-bold text-amber-600 uppercase block mb-1\">Tensions & Contradictions</span>\r\n                                        <p className=\"text-xs text-slate-600 italic\">{analysis.legitimacy_claims.tensions}</p>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Cultural Holes */}\r\n                    {analysis.holes && analysis.holes.length > 0 && (\r\n                        <CulturalHolesSection holes={analysis.holes} />\r\n                    )}\r\n\r\n                    {/* Stress Test */}\r\n                    {analysis.stress_test_report && (\r\n                        <StressTestSection report={analysis.stress_test_report} />\r\n                    )}\r\n\r\n                </TabsContent>\r\n\r\n                {/* 3. CRITIQUE TAB (Reflexivity) */}\r\n                <TabsContent value=\"critique\" className=\"space-y-6 mt-4 animate-in fade-in-50 duration-300\">\r\n                    {/* Devil's Advocate / Critique Section */}\r\n                    {(analysis.system_critique || critiqueResult) && (\r\n                        <SystemCritiqueSection critique={critiqueResult || analysis.system_critique!} />\r\n                    )}\r\n\r\n                    {/* Critique Trigger Button (Always show for re-run/audit capability) */}\r\n                    <div className={`p-6 rounded-xl border border-dashed ${analysis.system_critique || critiqueResult ? 'border-slate-200 bg-slate-50/30' : 'border-slate-300 bg-slate-50/50'} flex flex-col items-center justify-center text-center space-y-3`}>\r\n                        {(!analysis.system_critique && !critiqueResult) && (\r\n                            <>\r\n                                <div className=\"p-3 bg-slate-100 rounded-full\">\r\n                                    <ShieldCheck className=\"h-6 w-6 text-slate-400\" />\r\n                                </div>\r\n                                <div>\r\n                                    <h4 className=\"text-sm font-bold text-slate-700\">Audit this Analysis</h4>\r\n                                    <p className=\"text-xs text-slate-500 max-w-xs mx-auto\">\r\n                                        Run the \"Devil's Advocate\" protocol to identify blind spots and over-interpretations.\r\n                                    </p>\r\n                                </div>\r\n                            </>\r\n                        )}\r\n\r\n                        <Button\r\n                            onClick={handleRunCritique}\r\n                            disabled={isCritiqueLoading}\r\n                            variant=\"outline\"\r\n                            className=\"gap-2\"\r\n                        >\r\n                            {isCritiqueLoading ? (\r\n                                <>\r\n                                    <Activity className=\"h-4 w-4 animate-spin\" /> Running Audit...\r\n                                </>\r\n                            ) : (\r\n                                <>{(analysis.system_critique || critiqueResult) ? 'Re-Run System Reflexivity' : 'Run System Reflexivity'}</>\r\n                            )}\r\n                        </Button>\r\n                        {critiqueError && (\r\n                            <p className=\"text-xs text-red-600 font-medium bg-red-50 px-2 py-1 rounded\">\r\n                                Error: {critiqueError}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </TabsContent>\r\n\r\n                {/* 4. AUDIT TAB */}\r\n                <TabsContent value=\"audit\" className=\"space-y-6 mt-4 animate-in fade-in-50 duration-300\">\r\n                    {analysis.verified_quotes && analysis.verified_quotes.length > 0 && (\r\n                        <VerifiedEvidenceSection quotes={analysis.verified_quotes} />\r\n                    )}\r\n                    {analysis.verification_pathways && (\r\n                        <VerificationPathwaysTable pathways={analysis.verification_pathways} />\r\n                    )}\r\n\r\n                    <ValidationSection\r\n                        userImpression={userImpression}\r\n                        existingValidation={analysis.validation_status}\r\n                        sourceTitle={sourceTitle}\r\n                        analysis={analysis}\r\n                        onValidate={(status) => onUpdate && onUpdate({ validation_status: status })}\r\n                    />\r\n\r\n                    {/* Rhetoric Compliance Disclaimer */}\r\n                    <div className=\"flex items-start gap-3 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-xs\">\r\n                        <AlertTriangle className=\"h-4 w-4 shrink-0 mt-0.5\" />\r\n                        <p>\r\n                            <strong>Methodological Note:</strong> This tool analyzes the <em>textual construction</em> of legitimacy and ethics (&quot;Rhetoric Compliance&quot;), not the material operations or actual impact of the organization.\r\n                        </p>\r\n                    </div>\r\n                </TabsContent>\r\n            </Tabs>\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\DocumentCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnalysisResult' is defined but never used.","line":1,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":15,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Sparkles' is defined but never used.","line":15,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":15,"column":92,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":98},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSearching' is defined but never used.","line":37,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Source, AnalysisResult } from \"@/types\";\r\nimport { AnalysisMode } from \"@/services/analysis\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport {\r\n    DropdownMenu,\r\n    DropdownMenuContent,\r\n    DropdownMenuItem,\r\n    DropdownMenuLabel,\r\n    DropdownMenuSeparator,\r\n    DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport { FileText, Globe, Loader2, Sparkles, Trash, Pencil, MoreVertical, PlayCircle, Eye, Search, Maximize2, Minimize2, Zap } from \"lucide-react\";\r\nimport { AnalysisResults } from \"./AnalysisResults\";\r\n\r\ninterface DocumentCardProps {\r\n    source: Source;\r\n    isAnalyzing: boolean;\r\n    isSearching: boolean;\r\n    isSelected?: boolean;\r\n    onSelect?: (selected: boolean) => void;\r\n    onAnalyze: (id: string, mode: AnalysisMode) => void;\r\n    onDelete: (id: string) => void;\r\n    onEdit: (source: Source) => void;\r\n    onFindTraces: (source: Source) => void;\r\n    onView: (source: Source) => void;\r\n    onUpdateSource?: (id: string, updates: Partial<Source>) => void;\r\n    isFocused?: boolean;\r\n    onToggleFocus?: () => void;\r\n}\r\n\r\nexport function DocumentCard({\r\n    source,\r\n    isAnalyzing,\r\n    isSearching,\r\n    isSelected = false,\r\n    onSelect,\r\n    onAnalyze,\r\n    onDelete,\r\n    onEdit,\r\n    onFindTraces,\r\n    onView,\r\n    onUpdateSource,\r\n    isFocused = false,\r\n    onToggleFocus\r\n}: DocumentCardProps) {\r\n    const hasAnalysis = !!source.analysis;\r\n\r\n    return (\r\n        <Card className={`transition-all duration-200 ${isSelected ? 'ring-2 ring-indigo-500 border-indigo-500 shadow-md bg-indigo-50/10' : 'hover:shadow-md border-slate-200'}`}>\r\n            <CardHeader className=\"flex flex-row items-start gap-4 p-4 pb-2\">\r\n                {/* Selection Checkbox */}\r\n                {onSelect && (\r\n                    <div className=\"pt-1\">\r\n                        <Checkbox\r\n                            checked={isSelected}\r\n                            onCheckedChange={(c) => onSelect(c === true)}\r\n                            className=\"h-5 w-5 data-[state=checked]:bg-indigo-600 data-[state=checked]:border-indigo-600 border-slate-300\"\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"flex-1 min-w-0 space-y-1\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                        <CardTitle className=\"text-sm font-semibold leading-tight line-clamp-2\" title={source.title}>\r\n                            {source.title}\r\n                        </CardTitle>\r\n\r\n                        {/* Actions Menu */}\r\n                        <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                                <Button variant=\"ghost\" className=\"h-8 w-8 p-0 -mr-2\">\r\n                                    <MoreVertical className=\"h-4 w-4 text-slate-400\" />\r\n                                </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\">\r\n                                <DropdownMenuLabel>Actions</DropdownMenuLabel>\r\n                                <DropdownMenuItem onClick={() => onView(source)}>\r\n                                    <Eye className=\"mr-2 h-4 w-4\" /> View Text\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => onFindTraces(source)} disabled={!source.extractedText}>\r\n                                    <Globe className=\"mr-2 h-4 w-4\" /> Find Traces\r\n                                </DropdownMenuItem>\r\n                                {onToggleFocus && (\r\n                                    <DropdownMenuItem onClick={onToggleFocus}>\r\n                                        {isFocused ? <Minimize2 className=\"mr-2 h-4 w-4\" /> : <Maximize2 className=\"mr-2 h-4 w-4\" />}\r\n                                        {isFocused ? 'Exit Focus' : 'Focus Mode'}\r\n                                    </DropdownMenuItem>\r\n                                )}\r\n                                <DropdownMenuSeparator />\r\n                                <DropdownMenuItem onClick={() => onEdit(source)}>\r\n                                    <Pencil className=\"mr-2 h-4 w-4\" /> Edit Metadata\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem onClick={() => onDelete(source.id)} className=\"text-red-600\">\r\n                                    <Trash className=\"mr-2 h-4 w-4\" /> Delete\r\n                                </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n                    </div>\r\n                    <CardDescription className=\"text-xs line-clamp-1\">{source.description}</CardDescription>\r\n                </div>\r\n            </CardHeader>\r\n            <CardContent className=\"p-4 pt-2\">\r\n                <div className=\"flex items-center gap-2 mb-3 flex-wrap\">\r\n                    <Badge variant=\"secondary\" className={`${hasAnalysis ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'} text-[10px] uppercase font-bold`}>\r\n                        {hasAnalysis ? 'Analyzed' : 'Draft'}\r\n                    </Badge>\r\n                    <span className=\"text-[10px] text-slate-400\">\r\n                        {source.type} â€¢ {source.addedDate}\r\n                    </span>\r\n                    {source.jurisdiction && (\r\n                        <>\r\n                            <span className=\"text-[10px] text-slate-300\">â€¢</span>\r\n                            <Badge variant=\"outline\" className=\"text-[10px] h-4 px-1\">\r\n                                {source.jurisdiction}\r\n                            </Badge>\r\n                        </>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex flex-col gap-2\">\r\n                    <Button\r\n                        size=\"sm\"\r\n                        variant={hasAnalysis ? \"outline\" : \"default\"}\r\n                        className={`w-full text-xs h-8 ${!hasAnalysis && 'bg-indigo-600 hover:bg-indigo-700'}`}\r\n                        onClick={() => onAnalyze(source.id, 'dsf')}\r\n                        disabled={isAnalyzing}\r\n                    >\r\n                        {isAnalyzing ? (\r\n                            <Loader2 className=\"mr-2 h-3 w-3 animate-spin\" />\r\n                        ) : (\r\n                            <PlayCircle className=\"mr-2 h-3 w-3\" />\r\n                        )}\r\n                        {hasAnalysis ? 'Re-Run Analysis' : 'Run Analysis'}\r\n                    </Button>\r\n\r\n                    {hasAnalysis && (\r\n                        <Button\r\n                            size=\"sm\"\r\n                            variant=\"secondary\"\r\n                            className=\"w-full text-xs h-8 bg-orange-50 text-orange-700 hover:bg-orange-100 border border-orange-200\"\r\n                            onClick={() => onAnalyze(source.id, 'stress_test')}\r\n                            disabled={isAnalyzing}\r\n                        >\r\n                            <Zap className=\"mr-2 h-3 w-3\" />\r\n                            Run Stress Test\r\n                        </Button>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Inline Analysis Results (if available) - simplified for card */}\r\n                {source.analysis && (\r\n                    <div className=\"mt-4 pt-4 border-t border-slate-100\">\r\n                        <AnalysisResults\r\n                            analysis={source.analysis}\r\n                            sourceTitle={source.title}\r\n                            onUpdate={(updates) => onUpdateSource && onUpdateSource(source.id, {\r\n                                analysis: { ...source.analysis!, ...updates }\r\n                            })}\r\n                        />\r\n                    </div>\r\n                )}\r\n\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\DocumentToolbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\EditSourceDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\ExportReportDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\GovernanceCompass.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":1,"column":105,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":110}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, ZAxis, Tooltip, Cell, ReferenceLine, Label } from 'recharts';\r\n\r\ninterface GovernanceCompassProps {\r\n    rhetoricScore: number; // 0-100 (Y-Axis)\r\n    realityScore: number; // 0-100 (X-Axis)\r\n    driftExplanation?: string;\r\n    scoreExplanations?: {\r\n        rights_focus?: string;\r\n        procedurality?: string;\r\n        [key: string]: string | undefined;\r\n    };\r\n}\r\n\r\nexport function GovernanceCompass({ rhetoricScore, realityScore, driftExplanation, scoreExplanations }: GovernanceCompassProps) {\r\n    const data = [\r\n        { x: realityScore, y: rhetoricScore, name: 'Governance State' }\r\n    ];\r\n\r\n    // Calculate drift magnitude\r\n    const drift = Math.abs(rhetoricScore - realityScore);\r\n    const isHighDrift = drift > 30;\r\n\r\n    return (\r\n        <div className=\"p-4 rounded-xl bg-white border border-slate-200 shadow-sm\">\r\n            <div className=\"mb-4\">\r\n                <h4 className=\"text-sm font-bold text-slate-900 uppercase tracking-wide\">Governance Compass</h4>\r\n                <p className=\"text-xs text-slate-500\">Mapping Discursive Claims (Rhetoric) vs. Material Operations (Reality)</p>\r\n            </div>\r\n\r\n            <div className=\"h-[300px] w-full relative\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                    <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>\r\n                        <XAxis\r\n                            type=\"number\"\r\n                            dataKey=\"x\"\r\n                            name=\"Reality (Enforcement)\"\r\n                            domain={[0, 100]}\r\n                            tick={{ fontSize: 10 }}\r\n                            label={{ value: 'Material Reality (Enforcement) â†’', position: 'bottom', offset: 0, fontSize: 10 }}\r\n                        />\r\n                        <YAxis\r\n                            type=\"number\"\r\n                            dataKey=\"y\"\r\n                            name=\"Rhetoric (Claims)\"\r\n                            domain={[0, 100]}\r\n                            tick={{ fontSize: 10 }}\r\n                            label={{ value: 'Discursive Rhetoric (Claims) â†’', angle: -90, position: 'left', offset: 0, fontSize: 10 }}\r\n                        />\r\n                        <ZAxis range={[100, 100]} />\r\n                        <Tooltip\r\n                            cursor={{ strokeDasharray: '3 3' }}\r\n                            content={({ active, payload }) => {\r\n                                if (active && payload && payload.length) {\r\n                                    return (\r\n                                        <div className=\"bg-white p-2 border border-slate-200 shadow-md rounded text-xs max-w-[200px]\">\r\n                                            <p className=\"font-bold mb-1\">Governance Coords</p>\r\n                                            <p>Real: {payload[0].value}</p>\r\n                                            <p>Rhet: {payload[1].value}</p>\r\n                                        </div>\r\n                                    );\r\n                                }\r\n                                return null;\r\n                            }}\r\n                        />\r\n\r\n                        {/* Quadrant Lines */}\r\n                        <ReferenceLine x={50} stroke=\"#e2e8f0\" />\r\n                        <ReferenceLine y={50} stroke=\"#e2e8f0\" />\r\n\r\n                        {/* Quadrant Labels */}\r\n                        <ReferenceLine y={90} label={{ value: \"High Rhetoric\", position: 'insideTopRight', fontSize: 10, fill: '#94a3b8' }} stroke=\"none\" />\r\n                        <ReferenceLine x={90} label={{ value: \"High Reality\", position: 'insideTopRight', fontSize: 10, fill: '#94a3b8' }} stroke=\"none\" />\r\n\r\n                        {/* Drift Vector (Ideal Line) */}\r\n                        <ReferenceLine segment={[{ x: 0, y: 0 }, { x: 100, y: 100 }]} stroke=\"#cbd5e1\" strokeDasharray=\"3 3\" />\r\n\r\n                        <Scatter data={data} fill=\"#8884d8\">\r\n                            {data.map((entry, index) => (\r\n                                <Cell key={`cell-${index}`} fill={isHighDrift ? '#ef4444' : '#10b981'} />\r\n                            ))}\r\n                        </Scatter>\r\n                    </ScatterChart>\r\n                </ResponsiveContainer>\r\n\r\n                {/* Custom Annotation for the Point */}\r\n                <div\r\n                    className=\"absolute transform -translate-x-1/2 -translate-y-1/2 pointer-events-none\"\r\n                    style={{\r\n                        left: `${(realityScore / 100) * 80 + 10}%`, // Rough approximation for positioning\r\n                        bottom: `${(rhetoricScore / 100) * 80 + 10}%`\r\n                    }}\r\n                >\r\n                    <div className={`px-2 py-1 rounded text-[10px] font-bold text-white ${isHighDrift ? 'bg-red-500' : 'bg-emerald-500'} shadow-sm whitespace-nowrap`}>\r\n                        {isHighDrift ? 'Drift Detected' : 'Aligned'}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"mt-4 grid grid-cols-2 gap-3\">\r\n                <div className=\"p-2 bg-slate-50 rounded border border-slate-100\">\r\n                    <div className=\"text-[10px] font-bold text-slate-500 uppercase\">Rhetoric Score ({rhetoricScore})</div>\r\n                    <p className=\"text-[10px] text-slate-700 italic leading-snug mt-1\">\r\n                        {scoreExplanations?.rights_focus || \"Measures the intensity of ethical/human-rights claims made in the text.\"}\r\n                    </p>\r\n                </div>\r\n                <div className=\"p-2 bg-slate-50 rounded border border-slate-100\">\r\n                    <div className=\"text-[10px] font-bold text-slate-500 uppercase\">Reality Score ({realityScore})</div>\r\n                    <p className=\"text-[10px] text-slate-700 italic leading-snug mt-1\">\r\n                        {scoreExplanations?.procedurality || \"Measures the concreteness of operational mechanisms described.\"}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n\r\n            {isHighDrift && (\r\n                <div className=\"mt-3 p-3 rounded-lg bg-red-50 border border-red-100 text-xs text-red-800\">\r\n                    <strong>Governance Drift:</strong> {driftExplanation || \"Significant gap between ethical claims and enforcement mechanisms.\"}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\LegitimacyAnalysisView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used.","line":4,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":44}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[745,748],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[745,748],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1974,1977],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1974,1977],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { LegitimacyAnalysis } from \"@/types\";\r\nimport { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Tooltip } from 'recharts';\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Scale } from \"lucide-react\";\r\n\r\n\r\ninterface LegitimacyAnalysisViewProps {\r\n    analysis: LegitimacyAnalysis;\r\n}\r\n\r\nexport function LegitimacyAnalysisView({ analysis }: LegitimacyAnalysisViewProps) {\r\n    if (!analysis || !analysis.orders) return null;\r\n\r\n    // Helper to safely render any weird hallucinated structure\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const renderSafe = (content: any): React.ReactNode => {\r\n        if (typeof content === 'string' || typeof content === 'number') return content;\r\n        if (Array.isArray(content)) return content.map(c => renderSafe(c)).join(\", \");\r\n        if (typeof content === 'object' && content !== null) {\r\n            // Check if it's a known conflict spot structure\r\n            if (content.location && content.description) {\r\n                return (\r\n                    <div className=\"space-y-1\">\r\n                        <span className=\"font-semibold\">{renderSafe(content.location)}: </span>\r\n                        <span>{renderSafe(content.description)}</span>\r\n                    </div>\r\n                );\r\n            }\r\n            // Fallback for unknown objects\r\n            return Object.entries(content).map(([k, v]) => (\r\n                <div key={k} className=\"text-xs\">\r\n                    <span className=\"font-semibold capitalize\">{k.replace(/_/g, ' ')}:</span> {renderSafe(v)}\r\n                </div>\r\n            ));\r\n        }\r\n        return JSON.stringify(content);\r\n    };\r\n\r\n    // Helper to extract score from potentially complex object\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const getScore = (val: any): number => {\r\n        if (typeof val === 'number') return val;\r\n        if (typeof val === 'string') {\r\n            const parsed = parseFloat(val);\r\n            return isNaN(parsed) ? 0 : parsed;\r\n        }\r\n        if (typeof val === 'object' && val !== null) {\r\n            // gpt-5.1 likes to return { score: 8, evidence: \"...\" }\r\n            if (val.score) return getScore(val.score);\r\n            if (val.value) return getScore(val.value);\r\n            if (val.strength) return getScore(val.strength);\r\n        }\r\n        return 0;\r\n    };\r\n\r\n    const data = [\r\n        { subject: 'Market', A: getScore(analysis.orders.market), fullMark: 10 },\r\n        { subject: 'Industrial', A: getScore(analysis.orders.industrial), fullMark: 10 },\r\n        { subject: 'Civic', A: getScore(analysis.orders.civic), fullMark: 10 },\r\n        { subject: 'Domestic', A: getScore(analysis.orders.domestic), fullMark: 10 },\r\n        { subject: 'Inspired', A: getScore(analysis.orders.inspired), fullMark: 10 },\r\n        { subject: 'Fame', A: getScore(analysis.orders.fame), fullMark: 10 },\r\n    ];\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex flex-col md:flex-row gap-6\">\r\n                {/* Radar Chart */}\r\n                <div className=\"w-full md:w-1/2 h-[300px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={data}>\r\n                            <PolarGrid stroke=\"#e2e8f0\" />\r\n                            <PolarAngleAxis dataKey=\"subject\" tick={{ fill: '#64748b', fontSize: 12 }} />\r\n                            <PolarRadiusAxis angle={30} domain={[0, 10]} tick={false} axisLine={false} />\r\n                            <Radar\r\n                                name=\"Legitimacy\"\r\n                                dataKey=\"A\"\r\n                                stroke=\"#4f46e5\"\r\n                                strokeWidth={2}\r\n                                fill=\"#6366f1\"\r\n                                fillOpacity={0.4}\r\n                            />\r\n                            <Tooltip\r\n                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}\r\n                            />\r\n                        </RadarChart>\r\n                    </ResponsiveContainer>\r\n                </div>\r\n\r\n                {/* Analysis Details */}\r\n                <div className=\"w-full md:w-1/2 space-y-4\">\r\n                    <div>\r\n                        <h4 className=\"text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2\">Dominant Order</h4>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Scale className=\"h-5 w-5 text-indigo-600\" />\r\n                            <span className=\"text-lg font-bold text-slate-900\">\r\n                                {renderSafe(analysis.dominant_order)}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                        <h4 className=\"text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2\">Justification Logic</h4>\r\n                        <div className=\"text-sm text-slate-700 leading-relaxed bg-slate-50 p-3 rounded-md border border-slate-100\">\r\n                            {renderSafe(analysis.justification_logic)}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                        <h4 className=\"text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2\">Moral Vocabulary</h4>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {(Array.isArray(analysis.moral_vocabulary)\r\n                                ? analysis.moral_vocabulary\r\n                                : typeof analysis.moral_vocabulary === 'string'\r\n                                    ? (analysis.moral_vocabulary as string).split(',').map(s => s.trim())\r\n                                    : []\r\n                            ).map((term, i) => (\r\n                                <Badge key={i} variant=\"secondary\" className=\"bg-indigo-50 text-indigo-700 hover:bg-indigo-100\">\r\n                                    {renderSafe(term)}\r\n                                </Badge>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Conflict Spot */}\r\n            {analysis.conflict_spot && (\r\n                <Card className=\"bg-amber-50 border-amber-200\">\r\n                    <CardHeader className=\"pb-2\">\r\n                        <CardTitle className=\"text-sm font-bold text-amber-800 flex items-center gap-2\">\r\n                            âš ï¸ Conflict Spot\r\n                        </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent className=\"text-sm text-amber-900 space-y-2\">\r\n                        {renderSafe(analysis.conflict_spot)}\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\MaterializeDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8000,8003],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8000,8003],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from \"react\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { EcosystemActor } from \"@/types/ecosystem\";\r\nimport { Loader2, Network } from \"lucide-react\";\r\n\r\ninterface MaterializeDialogProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    initialName: string;\r\n    initialDescription: string;\r\n    sourceContext: {\r\n        sourceId: string;\r\n        type: \"accountability\" | \"legitimacy\" | \"cultural_absence\" | \"trace\";\r\n        detail: string;\r\n    };\r\n    onConfirm: (actor: Omit<EcosystemActor, \"id\">) => Promise<void>;\r\n}\r\n\r\nexport function MaterializeDialog({\r\n    isOpen,\r\n    onClose,\r\n    initialName,\r\n    initialDescription,\r\n    sourceContext,\r\n    onConfirm\r\n}: MaterializeDialogProps) {\r\n    const [name, setName] = useState(initialName);\r\n    const [description, setDescription] = useState(initialDescription);\r\n    const [type, setType] = useState<EcosystemActor[\"type\"]>(\"Policymaker\");\r\n    const [roleType, setRoleType] = useState<EcosystemActor[\"role_type\"]>(\"Mixed\");\r\n    const [mode, setMode] = useState<\"actor\" | \"constraint\">(\"actor\");\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n    // Reset form when dialog opens with new data\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setName(initialName);\r\n            setDescription(initialDescription);\r\n            setIsSubmitting(false);\r\n\r\n            // Heuristic for type\r\n            if (sourceContext.type === \"accountability\") setType(\"Policymaker\");\r\n            if (sourceContext.type === \"cultural_absence\") setType(\"Civil Society\");\r\n        }\r\n    }, [isOpen, initialName, initialDescription, sourceContext.type]);\r\n\r\n    const handleConfirm = async () => {\r\n        if (!name) return;\r\n        setIsSubmitting(true);\r\n        try {\r\n            await onConfirm({\r\n                name,\r\n                description,\r\n                type: mode === \"constraint\" ? \"LegalObject\" : type,\r\n                role_type: mode === \"constraint\" ? \"Expressive\" : roleType,\r\n                influence: \"Medium\", // Default\r\n                source: \"default\",\r\n                materialized_from: {\r\n                    source_id: sourceContext.sourceId,\r\n                    context_type: sourceContext.type,\r\n                    context_detail: sourceContext.detail\r\n                }\r\n            });\r\n            onClose();\r\n        } catch (error) {\r\n            console.error(\"Failed to materialize actor:\", error);\r\n            // Optionally show error state\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"sm:max-w-[500px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Network className=\"h-5 w-5 text-indigo-600\" />\r\n                        Materialize in Ecosystem\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        Convert this analysis insight into a persistent actor in the ecosystem graph.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"grid gap-4 py-4\">\r\n                    <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                        <Label htmlFor=\"name\" className=\"text-right\">\r\n                            Name\r\n                        </Label>\r\n                        <Input\r\n                            id=\"name\"\r\n                            value={name}\r\n                            onChange={(e) => setName(e.target.value)}\r\n                            className=\"col-span-3\"\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                        <Label htmlFor=\"type\" className=\"text-right\">\r\n                            Actor Type\r\n                        </Label>\r\n                        <Select\r\n                            value={mode === \"constraint\" ? \"LegalObject\" : type}\r\n                            onValueChange={(val: EcosystemActor[\"type\"]) => setType(val)}\r\n                            disabled={mode === \"constraint\"}\r\n                        >\r\n                            <SelectTrigger className=\"col-span-3\">\r\n                                <SelectValue placeholder=\"Select type\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"Policymaker\">Policymaker</SelectItem>\r\n                                <SelectItem value=\"Civil Society\">Civil Society</SelectItem>\r\n                                <SelectItem value=\"Infrastructure\">Infrastructure</SelectItem>\r\n                                <SelectItem value=\"Algorithm\">Algorithm</SelectItem>\r\n                                <SelectItem value=\"Startup\">Startup</SelectItem>\r\n                                <SelectItem value=\"Academic\">Academic</SelectItem>\r\n                                <SelectItem value=\"Dataset\">Dataset</SelectItem>\r\n                                <SelectItem value=\"AlgorithmicAgent\">Algorithmic Agent (AI)</SelectItem>\r\n                                <SelectItem value=\"LegalObject\">Legal Object (Regulation)</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                        <Label htmlFor=\"role\" className=\"text-right\">\r\n                            Ontology\r\n                        </Label>\r\n                        <Select\r\n                            value={mode === \"constraint\" ? \"Expressive\" : roleType}\r\n                            onValueChange={(val) => setRoleType(val as EcosystemActor[\"role_type\"])}\r\n                            disabled={mode === \"constraint\"}\r\n                        >\r\n                            <SelectTrigger className=\"col-span-3\">\r\n                                <SelectValue placeholder=\"Role Type\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"Material\">Material (Hardware/Bodies)</SelectItem>\r\n                                <SelectItem value=\"Expressive\">Expressive (Code/Law)</SelectItem>\r\n                                <SelectItem value=\"Mixed\">Mixed (Assemblage)</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 items-start gap-4\">\r\n                        <Label htmlFor=\"desc\" className=\"text-right pt-2\">\r\n                            Context\r\n                        </Label>\r\n                        <Textarea\r\n                            id=\"desc\"\r\n                            value={description}\r\n                            onChange={(e) => setDescription(e.target.value)}\r\n                            className=\"col-span-3 h-20 text-xs\"\r\n                            placeholder={mode === \"constraint\" ? \"Paste the legal text or requirement here...\" : \"Describe the actor...\"}\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 items-start gap-4\">\r\n                        <Label className=\"text-right pt-2\">Mode</Label>\r\n                        <Tabs value={mode} onValueChange={(v) => setMode(v as any)} className=\"col-span-3\">\r\n                            <TabsList className=\"grid w-full grid-cols-2\">\r\n                                <TabsTrigger value=\"actor\">Actor / Assemblage</TabsTrigger>\r\n                                <TabsTrigger value=\"constraint\">Code / Law</TabsTrigger>\r\n                            </TabsList>\r\n                        </Tabs>\r\n                    </div>\r\n\r\n                    <div className=\"bg-slate-50 p-3 rounded text-xs text-slate-500 flex gap-2 border border-slate-100 italic\">\r\n                        <span className=\"font-bold not-italic\">Source:</span>\r\n                        {sourceContext.type.replace('_', ' ')} â€¢ {sourceContext.detail}\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={onClose} disabled={isSubmitting}>\r\n                        Cancel\r\n                    </Button>\r\n                    <Button onClick={handleConfirm} disabled={!name || isSubmitting} className=\"bg-indigo-600 hover:bg-indigo-700\">\r\n                        {isSubmitting ? (\r\n                            <>\r\n                                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                Adding...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Network className=\"mr-2 h-4 w-4\" />\r\n                                Add to Ecosystem\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\PolicyComparisonView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tooltip' is defined but never used.","line":8,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TooltipContent' is defined but never used.","line":8,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TooltipProvider' is defined but never used.","line":8,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TooltipTrigger' is defined but never used.","line":8,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":66},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":26,"column":46,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1438,1504],"text":"Select documents from the &quot;My Documents\" tab to compare them here."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1438,1504],"text":"Select documents from the &ldquo;My Documents\" tab to compare them here."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1438,1504],"text":"Select documents from the &#34;My Documents\" tab to compare them here."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1438,1504],"text":"Select documents from the &rdquo;My Documents\" tab to compare them here."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":26,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1438,1504],"text":"Select documents from the \"My Documents&quot; tab to compare them here."},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1438,1504],"text":"Select documents from the \"My Documents&ldquo; tab to compare them here."},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1438,1504],"text":"Select documents from the \"My Documents&#34; tab to compare them here."},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1438,1504],"text":"Select documents from the \"My Documents&rdquo; tab to compare them here."},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'explanationKey' is assigned a value but never used.","line":276,"column":51,"nodeType":null,"messageId":"unusedVar","endLine":276,"endColumn":65},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":293,"column":95,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":293,"endColumn":98,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22681,22684],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22681,22684],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Source } from \"@/types\";\r\nimport { calculateMicroFascismRisk } from \"@/lib/risk-calculator\";\r\nimport { calculateLiberatoryCapacity } from \"@/lib/liberatory-calculator\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ScrollArea, ScrollBar } from \"@/components/ui/scroll-area\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport {\r\n    AlertTriangle, Sprout, Scale, Sparkles, Gavel, ShieldAlert, EyeOff, Zap, History, Ban,\r\n    RefreshCw, Hand, HeartHandshake, Feather, MessageSquare, Info\r\n} from \"lucide-react\";\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface PolicyComparisonViewProps {\r\n    sources: Source[];\r\n}\r\n\r\nexport function PolicyComparisonView({ sources }: PolicyComparisonViewProps) {\r\n    if (!sources || sources.length === 0) {\r\n        return (\r\n            <div className=\"text-center p-12 bg-slate-50 border border-dashed border-slate-200 rounded-xl text-slate-500\">\r\n                <Scale className=\"h-10 w-10 text-slate-300 mx-auto mb-4\" />\r\n                <h3 className=\"text-lg font-bold text-slate-700\">No Policies Selected</h3>\r\n                <p>Select documents from the \"My Documents\" tab to compare them here.</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const comparisons = sources.map(source => {\r\n        const risk = source.analysis ? calculateMicroFascismRisk(source.analysis) : null;\r\n        const liberty = source.analysis ? calculateLiberatoryCapacity(source.analysis) : null;\r\n        return {\r\n            source,\r\n            risk,\r\n            liberty,\r\n            anchor: source.analysis?.anchor_bias_choice || 'N/A',\r\n            insight: source.analysis?.key_insight || 'No analysis available.'\r\n        };\r\n    });\r\n\r\n    // --- Helpers for Color Coding ---\r\n    const getRiskBg = (score: number) => {\r\n        if (score >= 5) return \"bg-red-50 border-red-200 text-red-900\";\r\n        if (score >= 3) return \"bg-amber-50 border-amber-200 text-amber-900\";\r\n        return \"bg-emerald-50 border-emerald-200 text-emerald-900\";\r\n    };\r\n\r\n    const getLibertyBg = (score: number) => {\r\n        if (score >= 6) return \"bg-emerald-50 border-emerald-200 text-emerald-900\";\r\n        if (score >= 3) return \"bg-amber-50 border-amber-200 text-amber-900\";\r\n        return \"bg-slate-50 border-slate-200 text-slate-700\";\r\n    };\r\n\r\n    // --- Dimension Definitions ---\r\n    const riskDimensions = [\r\n        { key: \"power_hardening\", label: \"Power Hardening\", icon: Gavel },\r\n        { key: \"agency_collapse\", label: \"Agency Collapse\", icon: ShieldAlert },\r\n        { key: \"epistemic_narrowing\", label: \"Epistemic Narrowing\", icon: EyeOff },\r\n        { key: \"structural_violence\", label: \"Structural Violence\", icon: Zap },\r\n        { key: \"temporal_closure\", label: \"Temporal Closure\", icon: History },\r\n        { key: \"absence_as_control\", label: \"Absence as Control\", icon: Ban },\r\n    ] as const;\r\n\r\n    const libertyDimensions = [\r\n        { key: \"power_reversibility\", label: \"Power Reversibility\", icon: RefreshCw },\r\n        { key: \"agency_protection\", label: \"Situated Agency\", icon: Hand },\r\n        { key: \"epistemic_plurality\", label: \"Epistemic Plurality\", icon: Sparkles },\r\n        { key: \"exit_rights\", label: \"Exit/Refusal Rights\", icon: Scale },\r\n        { key: \"repair_recognition\", label: \"Repair & Care\", icon: HeartHandshake },\r\n        { key: \"temporal_openness\", label: \"Temporal Openness\", icon: History },\r\n        { key: \"proportionality\", label: \"Proportionality\", icon: Feather },\r\n        { key: \"contestable_safety\", label: \"Contestable Safety\", icon: MessageSquare },\r\n    ] as const;\r\n\r\n    return (\r\n        <Card className=\"border-slate-200 shadow-sm overflow-hidden h-full flex flex-col\">\r\n            <CardHeader className=\"pb-4 bg-slate-50/50 border-b border-slate-100 shrink-0\">\r\n                <CardTitle className=\"text-lg font-bold flex items-center gap-2\">\r\n                    <Scale className=\"h-5 w-5 text-indigo-600\" />\r\n                    Comparative Diagnostic Matrix\r\n                </CardTitle>\r\n                <CardDescription>\r\n                    Flattened matrix view for rapid cross-policy signal analysis.\r\n                </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"p-0 flex-1 overflow-hidden\">\r\n                <ScrollArea className=\"h-full\">\r\n                    <div className=\"min-w-max\">\r\n                        <Table>\r\n                            <TableHeader className=\"bg-slate-50 sticky top-0 z-50 shadow-sm\">\r\n                                <TableRow className=\"hover:bg-slate-50\">\r\n                                    <TableHead className=\"w-[220px] min-w-[220px] bg-slate-50 text-slate-700 font-bold sticky left-0 z-50 border-r border-slate-200 pl-6 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]\">\r\n                                        Diagnostic Criteria\r\n                                    </TableHead>\r\n                                    {comparisons.map((c) => (\r\n                                        <TableHead key={c.source.id} className=\"min-w-[120px] max-w-[120px] align-top py-4 border-l border-slate-100 text-left\">\r\n                                            <div className=\"flex flex-col gap-1.5 items-start\">\r\n                                                <span className=\"text-sm font-bold text-slate-900 leading-tight line-clamp-3\" title={c.source.title}>\r\n                                                    {c.source.title}\r\n                                                </span>\r\n                                                <Badge variant=\"outline\" className={`w-fit text-[10px] border-0 px-1.5 py-0 ${c.source.colorClass}`}>\r\n                                                    {c.source.type}\r\n                                                </Badge>\r\n                                            </div>\r\n                                        </TableHead>\r\n                                    ))}\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {/* --- High Level Scores --- */}\r\n                                <TableRow className=\"bg-slate-50/30\">\r\n                                    <TableCell className=\"font-semibold text-slate-600 sticky left-0 z-40 bg-slate-50/95 backdrop-blur border-r border-slate-200 pl-6\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            Overall Risk Index\r\n                                            <Popover>\r\n                                                <PopoverTrigger asChild>\r\n                                                    <Info className=\"h-4 w-4 text-slate-400 hover:text-indigo-600 transition-colors cursor-pointer\" />\r\n                                                </PopoverTrigger>\r\n                                                <PopoverContent className=\"w-80 p-4 shadow-xl border-indigo-100\" side=\"right\" align=\"start\">\r\n                                                    <div className=\"space-y-3\">\r\n                                                        <div className=\"border-b border-indigo-100 pb-2 mb-2\">\r\n                                                            <h4 className=\"font-bold text-indigo-900 flex items-center gap-2\">\r\n                                                                <Gavel className=\"h-4 w-4\" />\r\n                                                                Risk Calculation Logic\r\n                                                            </h4>\r\n                                                            <p className=\"text-xs text-slate-500 mt-1\">Sum of 6 weighted micro-fascism signals (0-6 scale).</p>\r\n                                                        </div>\r\n                                                        <ul className=\"space-y-2 text-sm text-slate-600\">\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-red-50 text-red-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Power</span>\r\n                                                                <span>Centralization &gt; 75% or rigid procedure.</span>\r\n                                                            </li>\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-red-50 text-red-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Agency</span>\r\n                                                                <span>Rights Focus &lt; 35% (collapse).</span>\r\n                                                            </li>\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-red-50 text-red-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Truth</span>\r\n                                                                <span>Coloniality &gt; 60% or high silence.</span>\r\n                                                            </li>\r\n                                                        </ul>\r\n                                                    </div>\r\n                                                </PopoverContent>\r\n                                            </Popover>\r\n                                        </div>\r\n                                    </TableCell>\r\n                                    {comparisons.map((c) => (\r\n                                        <TableHead key={c.source.id} className=\"border-l border-slate-100 p-2 text-left\">\r\n                                            {c.risk ? (\r\n                                                <div className={cn(\"rounded-md p-2 border mr-auto w-fit text-center\", getRiskBg(c.risk.score))}>\r\n                                                    <div className=\"text-2xl font-black leading-none mb-1\">\r\n                                                        {c.risk.score}<span className=\"text-xs opacity-60 font-medium\">/6</span>\r\n                                                    </div>\r\n                                                    <div className=\"text-[10px] font-bold uppercase tracking-wider opacity-90\">{c.risk.level}</div>\r\n                                                </div>\r\n                                            ) : <span className=\"text-slate-300 text-xs\">-</span>}\r\n                                        </TableHead>\r\n                                    ))}\r\n                                </TableRow>\r\n                                <TableRow className=\"bg-slate-50/30\">\r\n                                    <TableCell className=\"font-semibold text-slate-600 sticky left-0 z-40 bg-slate-50/95 backdrop-blur border-r border-slate-200 pl-6\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            Liberatory Potential\r\n                                            <Popover>\r\n                                                <PopoverTrigger asChild>\r\n                                                    <Info className=\"h-4 w-4 text-slate-400 hover:text-emerald-600 transition-colors cursor-pointer\" />\r\n                                                </PopoverTrigger>\r\n                                                <PopoverContent className=\"w-80 p-4 shadow-xl border-emerald-100\" side=\"right\" align=\"start\">\r\n                                                    <div className=\"space-y-3\">\r\n                                                        <div className=\"border-b border-emerald-100 pb-2 mb-2\">\r\n                                                            <h4 className=\"font-bold text-emerald-900 flex items-center gap-2\">\r\n                                                                <Sprout className=\"h-4 w-4\" />\r\n                                                                Liberatory Logic\r\n                                                            </h4>\r\n                                                            <p className=\"text-xs text-slate-500 mt-1\">Sum of 8 capacity signals based on governance metrics (0-8 scale).</p>\r\n                                                        </div>\r\n                                                        <ul className=\"space-y-2 text-sm text-slate-600\">\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Revokes</span>\r\n                                                                <span>Centralization &lt; 40% (reversible).</span>\r\n                                                            </li>\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Codesign</span>\r\n                                                                <span>Rights Focus &gt; 65% or explicit codesign.</span>\r\n                                                            </li>\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Refusal</span>\r\n                                                                <span>Explicit exit rights or opt-out.</span>\r\n                                                            </li>\r\n                                                            <li className=\"flex items-start gap-2\">\r\n                                                                <span className=\"font-bold text-xs uppercase bg-emerald-50 text-emerald-700 px-1.5 py-0.5 rounded shrink-0 mt-0.5\">Repair</span>\r\n                                                                <span>Verification of maintenance/care labor.</span>\r\n                                                            </li>\r\n                                                        </ul>\r\n                                                    </div>\r\n                                                </PopoverContent>\r\n                                            </Popover>\r\n                                        </div>\r\n                                    </TableCell>\r\n                                    {comparisons.map((c) => (\r\n                                        <TableHead key={c.source.id} className=\"border-l border-slate-100 p-2 text-left\">\r\n                                            {c.liberty ? (\r\n                                                <div className={cn(\"rounded-md p-2 border mr-auto w-fit text-center\", getLibertyBg(c.liberty.score))}>\r\n                                                    <div className=\"text-2xl font-black leading-none mb-1\">\r\n                                                        {c.liberty.score}<span className=\"text-xs opacity-60 font-medium\">/8</span>\r\n                                                    </div>\r\n                                                    <div className=\"text-[10px] font-bold uppercase tracking-wider opacity-90\">{c.liberty.level}</div>\r\n                                                </div>\r\n                                            ) : <span className=\"text-slate-300 text-xs\">-</span>}\r\n                                        </TableHead>\r\n                                    ))}\r\n                                </TableRow>\r\n\r\n\r\n\r\n                                {/* --- Section: Risk Signals --- */}\r\n                                <TableRow className=\"bg-slate-100/50 hover:bg-slate-100/50\">\r\n                                    <TableCell colSpan={comparisons.length + 1} className=\"py-2 pl-6 text-xs font-bold uppercase tracking-widest text-slate-400\">\r\n                                        Micro-Fascism Signals\r\n                                    </TableCell>\r\n                                </TableRow>\r\n\r\n                                {riskDimensions.map((dim) => (\r\n                                    <TableRow key={dim.key} className=\"hover:bg-slate-50/50 group\">\r\n                                        <TableCell className=\"text-sm font-medium text-slate-700 sticky left-0 z-40 bg-white group-hover:bg-slate-50/50 border-r border-slate-200 pl-6 align-top py-3\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <dim.icon className=\"h-4 w-4 text-slate-400\" />\r\n                                                {dim.label}\r\n                                            </div>\r\n                                        </TableCell>\r\n                                        {comparisons.map((c) => {\r\n                                            const triggered = c.risk?.flags[dim.key as keyof typeof c.risk.flags];\r\n                                            const explanation = c.risk?.explanations[dim.key.split('_')[0] as keyof typeof c.risk.explanations];\r\n\r\n                                            return (\r\n                                                <TableCell key={c.source.id} className={cn(\r\n                                                    \"border-l border-slate-100 p-3 align-top transition-colors text-xs leading-relaxed text-left\",\r\n                                                    triggered ? \"bg-red-50/30\" : \"\"\r\n                                                )}>\r\n                                                    {triggered ? (\r\n                                                        <div className=\"flex flex-col gap-1 items-start\">\r\n                                                            <div className=\"flex items-center gap-1.5 text-red-700 font-bold uppercase text-[10px]\">\r\n                                                                <AlertTriangle className=\"h-3 w-3\" />\r\n                                                                Detected\r\n                                                            </div>\r\n                                                            <span className=\"text-slate-800\">{explanation}</span>\r\n                                                        </div>\r\n                                                    ) : (\r\n                                                        <span className=\"text-slate-300 italic text-[10px]\">Not detected</span>\r\n                                                    )}\r\n                                                </TableCell>\r\n                                            );\r\n                                        })}\r\n                                    </TableRow>\r\n                                ))}\r\n\r\n                                {/* --- Section: Liberatory Signals --- */}\r\n                                <TableRow className=\"bg-slate-100/50 hover:bg-slate-100/50\">\r\n                                    <TableCell colSpan={comparisons.length + 1} className=\"py-2 pl-6 text-xs font-bold uppercase tracking-widest text-slate-400\">\r\n                                        Liberatory Capacity\r\n                                    </TableCell>\r\n                                </TableRow>\r\n\r\n                                {libertyDimensions.map((dim) => (\r\n                                    <TableRow key={dim.key} className=\"hover:bg-slate-50/50 group\">\r\n                                        <TableCell className=\"text-sm font-medium text-slate-700 sticky left-0 z-40 bg-white group-hover:bg-slate-50/50 border-r border-slate-200 pl-6 align-top py-3\">\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <dim.icon className=\"h-4 w-4 text-slate-400\" />\r\n                                                {dim.label}\r\n                                            </div>\r\n                                        </TableCell>\r\n                                        {comparisons.map((c) => {\r\n                                            const triggered = c.liberty?.signals[dim.key as keyof typeof c.liberty.signals];\r\n                                            const explanationKey = dim.key === 'proportionality' || dim.key === 'contestable_safety'\r\n                                                ? dim.key.split('_')[1] // 'safety' for contestable_safety? No wait, check mapping.\r\n                                                : dim.key.split('_')[0];\r\n\r\n                                            // Manual fix for key mapping if needed, or rely on consistent naming.\r\n                                            // Let's check LiberatoryCapacityCard mapping:\r\n                                            // agency_protection -> capacity.explanations.agency\r\n                                            // exit_rights -> capacity.explanations.exit\r\n                                            // contestable_safety -> capacity.explanations.safety\r\n\r\n                                            let explanation = \"\";\r\n                                            if (c.liberty) {\r\n                                                if (dim.key === 'agency_protection') explanation = c.liberty.explanations.agency;\r\n                                                else if (dim.key === 'exit_rights') explanation = c.liberty.explanations.exit;\r\n                                                else if (dim.key === 'repair_recognition') explanation = c.liberty.explanations.repair;\r\n                                                else if (dim.key === 'contestable_safety') explanation = c.liberty.explanations.safety;\r\n                                                else if (dim.key === 'proportionality') explanation = c.liberty.explanations.proportionality || '';\r\n                                                else explanation = (c.liberty.explanations as any)[dim.key.split('_')[0]];\r\n                                            }\r\n\r\n                                            return (\r\n                                                <TableCell key={c.source.id} className={cn(\r\n                                                    \"border-l border-slate-100 p-3 align-top transition-colors text-xs leading-relaxed text-left\",\r\n                                                    triggered ? \"bg-emerald-50/30\" : \"\"\r\n                                                )}>\r\n                                                    {triggered ? (\r\n                                                        <div className=\"flex flex-col gap-1 items-start\">\r\n                                                            <div className=\"flex items-center gap-1.5 text-emerald-700 font-bold uppercase text-[10px]\">\r\n                                                                <Sprout className=\"h-3 w-3\" />\r\n                                                                Active\r\n                                                            </div>\r\n                                                            <span className=\"text-slate-800\">{explanation}</span>\r\n                                                        </div>\r\n                                                    ) : (\r\n                                                        <span className=\"text-slate-300 italic text-[10px]\">Criterion not met</span>\r\n                                                    )}\r\n                                                </TableCell>\r\n                                            );\r\n                                        })}\r\n                                    </TableRow>\r\n                                ))}\r\n                            </TableBody>\r\n                        </Table>\r\n                    </div>\r\n                    <ScrollBar orientation=\"horizontal\" />\r\n                </ScrollArea>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\PolicyFocusView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\RebuttalButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dimensionKey' is defined but never used.","line":14,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":46},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":42,"column":178,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific &quot;risk bit\".\r\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific &ldquo;risk bit\".\r\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific &#34;risk bit\".\r\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific &rdquo;risk bit\".\r\n                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":42,"column":187,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific \"risk bit&quot;.\r\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific \"risk bit&ldquo;.\r\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific \"risk bit&#34;.\r\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1831,2043],"text":"\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific \"risk bit&rdquo;.\r\n                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\r\nimport { MessageSquarePlus } from \"lucide-react\";\r\n\r\ninterface RebuttalInputContext {\r\n    dimensionKey: string;\r\n    dimensionLabel: string;\r\n    existingRebuttal?: string;\r\n    onSave: (text: string) => void;\r\n}\r\n\r\nexport function RebuttalButton({ dimensionKey, dimensionLabel, existingRebuttal, onSave }: RebuttalInputContext) {\r\n    const [open, setOpen] = useState(false);\r\n    const [text, setText] = useState(existingRebuttal || \"\");\r\n\r\n    const handleSave = () => {\r\n        onSave(text);\r\n        setOpen(false);\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={setOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className={`h-6 px-2 text-[10px] uppercase font-bold tracking-wider ${existingRebuttal ? 'text-purple-600 bg-purple-50 hover:bg-purple-100' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-100'}`}\r\n                >\r\n                    <MessageSquarePlus className=\"h-3 w-3 mr-1\" />\r\n                    {existingRebuttal ? \"Edit Context\" : \"Contest\"}\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"sm:max-w-[425px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2 text-slate-800\">\r\n                        <MessageSquarePlus className=\"h-5 w-5 text-purple-600\" />\r\n                        Contest: {dimensionLabel}\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        AI diagnosis is a starting point, not a verdict. Add your own expert context or rebuttal to this flag. This will be permanently attached to the specific \"risk bit\".\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"grid gap-4 py-4\">\r\n                    <Textarea\r\n                        placeholder=\"E.g. 'This centralization is necessary for immediate compliance enforcement...'\"\r\n                        className=\"min-h-[120px]\"\r\n                        value={text}\r\n                        onChange={(e) => setText(e.target.value)}\r\n                    />\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => setOpen(false)}>Cancel</Button>\r\n                    <Button onClick={handleSave} className=\"bg-purple-600 text-white hover:bg-purple-700\">Attach Rebuttal</Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\ViewSourceDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\AccountabilitySection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\CulturalHolesSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Network' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalysisResult } from \"@/types\";\r\nimport { Network } from \"lucide-react\";\r\n\r\nexport function CulturalHolesSection({ holes }: { holes: NonNullable<AnalysisResult['holes']> }) {\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {holes.map((hole, i) => (\r\n                <div key={i} className=\"rounded-xl border border-indigo-200 bg-indigo-50/50 overflow-hidden\">\r\n                    <div className=\"px-4 py-3 border-b border-indigo-200 flex items-center justify-between bg-indigo-100/30\">\r\n                        <h4 className=\"text-xs font-bold text-indigo-900 uppercase tracking-wider\">Cultural Hole: {hole.concept}</h4>\r\n                        <span className=\"text-[10px] text-indigo-600 font-bold uppercase\">Between {hole.between.join(' & ')}</span>\r\n                    </div>\r\n                    <div className=\"p-4 space-y-4\">\r\n                        <p className=\"text-xs text-slate-700\">{hole.description}</p>\r\n\r\n\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\DimensionCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\DynamicsCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\InterpretationLensSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useState' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Sparkles, Layers, RefreshCw } from \"lucide-react\";\r\nimport { AVAILABLE_PERSPECTIVES, DEFAULT_PERSPECTIVE_A, DEFAULT_PERSPECTIVE_B } from \"@/lib/perspectives\";\r\n\r\ninterface InterpretationLensSelectorProps {\r\n    currentLens: string;\r\n    onLensChange: (lensId: string) => void;\r\n    onGenerate: () => void;\r\n    isGenerating: boolean;\r\n    hasResults: boolean;\r\n    perspectiveAId?: string;\r\n    perspectiveBId?: string;\r\n}\r\n\r\nexport function InterpretationLensSelector({\r\n    currentLens,\r\n    onLensChange,\r\n    onGenerate,\r\n    isGenerating,\r\n    hasResults,\r\n    perspectiveAId,\r\n    perspectiveBId\r\n}: InterpretationLensSelectorProps) {\r\n\r\n    const perspA = AVAILABLE_PERSPECTIVES.find(p => p.id === (perspectiveAId || DEFAULT_PERSPECTIVE_A.id)) || DEFAULT_PERSPECTIVE_A;\r\n    const perspB = AVAILABLE_PERSPECTIVES.find(p => p.id === (perspectiveBId || DEFAULT_PERSPECTIVE_B.id)) || DEFAULT_PERSPECTIVE_B;\r\n\r\n    if (!hasResults) {\r\n        return (\r\n            <div className=\"flex items-center gap-4 p-4 bg-slate-50 border border-slate-200 rounded-lg shadow-sm\">\r\n                <div className=\"flex-1\">\r\n                    <h4 className=\"text-sm font-bold text-slate-800 flex items-center gap-2\">\r\n                        <Layers className=\"h-4 w-4 text-slate-500\" />\r\n                        Interpretation Sets\r\n                    </h4>\r\n                    <p className=\"text-xs text-slate-500 mt-1\">\r\n                        Compare this document through different theoretical lenses to avoid a single narrative.\r\n                    </p>\r\n                </div>\r\n                <Button\r\n                    onClick={onGenerate}\r\n                    disabled={isGenerating}\r\n                    variant=\"outline\"\r\n                    className=\"gap-2 text-xs font-bold uppercase tracking-wider text-purple-700 bg-purple-50 border-purple-200 hover:bg-purple-100\"\r\n                >\r\n                    {isGenerating ? (\r\n                        <RefreshCw className=\"h-3 w-3 animate-spin\" />\r\n                    ) : (\r\n                        <Sparkles className=\"h-3 w-3\" />\r\n                    )}\r\n                    {isGenerating ? \"Simulating...\" : \"Generate Perspectives\"}\r\n                </Button>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col sm:flex-row items-center gap-3 p-2 bg-slate-100/80 rounded-lg border border-slate-200\">\r\n            <span className=\"text-xs font-bold text-slate-500 uppercase tracking-widest px-2 flex items-center gap-2\">\r\n                <Layers className=\"h-3 w-3\" />\r\n                Active Lens:\r\n            </span>\r\n            <div className=\"flex items-center gap-1.5 p-1 bg-white rounded-md border border-slate-200 shadow-sm\">\r\n                <button\r\n                    onClick={() => onLensChange('default')}\r\n                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${currentLens === 'default'\r\n                            ? 'bg-slate-800 text-white shadow-sm'\r\n                            : 'text-slate-600 hover:bg-slate-50'\r\n                        }`}\r\n                >\r\n                    Assemblage / DSF (Default)\r\n                </button>\r\n                <div className=\"w-px h-4 bg-slate-200 mx-1\" />\r\n                <button\r\n                    onClick={() => onLensChange(perspA.id)}\r\n                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${currentLens === perspA.id\r\n                            ? 'bg-indigo-600 text-white shadow-sm'\r\n                            : 'text-slate-600 hover:bg-slate-50'\r\n                        }`}\r\n                >\r\n                    {perspA.name}\r\n                </button>\r\n                <button\r\n                    onClick={() => onLensChange(perspB.id)}\r\n                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${currentLens === perspB.id\r\n                            ? 'bg-rose-600 text-white shadow-sm'\r\n                            : 'text-slate-600 hover:bg-slate-50'\r\n                        }`}\r\n                >\r\n                    {perspB.name}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\LiberatoryCapacityCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\MicroFascismRiskCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\StressTestSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":22,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalysisResult } from \"@/types\";\r\nimport { AlertTriangle } from \"lucide-react\";\r\n\r\nexport function StressTestSection({ report }: { report: NonNullable<AnalysisResult['stress_test_report']> }) {\r\n    // Helper to clean potential JSON artifacts from the text\r\n    const cleanText = (text: string): string => {\r\n        try {\r\n            if (!text || typeof text !== 'string') return text;\r\n\r\n            const trimmed = text.trim();\r\n            // 1. Try recursive JSON Parse\r\n            if (trimmed.startsWith('{') || trimmed.startsWith('\"')) {\r\n                const parsed = JSON.parse(text);\r\n                if (parsed && typeof parsed === 'object' && parsed.inverted_text) {\r\n                    return cleanText(parsed.inverted_text);\r\n                }\r\n                if (typeof parsed === 'string' && parsed !== text) {\r\n                    return cleanText(parsed);\r\n                }\r\n            }\r\n            return text;\r\n        } catch (e) {\r\n            // 2. Regex Fallback for malformed/dirty JSON\r\n            // Look for: \"inverted_text\": \"CAPTURE_THIS\"\r\n            const match = text.match(/\"inverted_text\"\\s*:\\s*\"((?:[^\"\\\\]|\\\\.)*)\"/);\r\n            if (match && match[1]) {\r\n                try {\r\n                    // Try to standard unescape by wrapping as valid JSON string\r\n                    return JSON.parse(`\"${match[1]}\"`);\r\n                } catch {\r\n                    // Manual unescape if that fails\r\n                    return match[1]\r\n                        .replace(/\\\\\"/g, '\"')\r\n                        .replace(/\\\\n/g, '\\n')\r\n                        .replace(/\\\\\\\\/g, '\\\\');\r\n                }\r\n            }\r\n\r\n            // 3. Brute force strip if the key exists but regex failed\r\n            if (text.includes('inverted_text\"')) {\r\n                return text\r\n                    .replace(/.*\"inverted_text\"\\s*:\\s*\"/, '') // Remove header\r\n                    .replace(/\"\\s*\\}?$/, '') // Remove trailer\r\n                    .replace(/\\\\\"/g, '\"')\r\n                    .replace(/\\\\n/g, '\\n');\r\n            }\r\n\r\n            return text;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"rounded-xl border border-red-200 bg-red-50/10 overflow-hidden\">\r\n            <div className=\"bg-red-100/30 px-4 py-3 border-b border-red-200 flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <AlertTriangle className=\"h-4 w-4 text-red-700\" />\r\n                    <h4 className=\"text-xs font-bold text-red-900 uppercase tracking-wider\">Consistency Stress-Test (Adversarial Framing)</h4>\r\n                </div>\r\n                <span className={`text-[10px] font-bold px-2 py-1 rounded-full uppercase ${report.framing_sensitivity === 'High' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>\r\n                    Sensitivity: {report.framing_sensitivity}\r\n                </span>\r\n            </div>\r\n\r\n            {/* Explanation of the Test */}\r\n            <div className=\"mx-4 mt-4 p-3 bg-red-50/50 rounded-lg border border-red-100 text-xs text-red-900/80 leading-relaxed\">\r\n                <p>\r\n                    <strong>Analysis:</strong> {getInterpretation(report)}\r\n                </p>\r\n                <div className=\"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-[10px]\">\r\n                    <div>\r\n                        <strong>â€¢ Sensitivity:</strong> {report.framing_sensitivity}\r\n                    </div>\r\n                    <div>\r\n                        <strong>â€¢ Shift:</strong> {report.original_score} (Original) â†’ {report.perturbed_score} (Inverted)\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"p-4 grid grid-cols-2 gap-4\">\r\n                <div>\r\n                    <h5 className=\"text-[10px] font-bold text-slate-500 uppercase mb-2\">Inverted Rhetoric Sample</h5>\r\n                    <p className=\"text-xs font-mono text-slate-600 bg-white p-2 rounded border border-slate-200 leading-relaxed whitespace-pre-wrap\">\r\n                        &quot;{cleanText(report.inverted_text_excerpt)}&quot;\r\n                    </p>\r\n                </div>\r\n                <div>\r\n                    <h5 className=\"text-[10px] font-bold text-slate-500 uppercase mb-2\">Score Deviation</h5>\r\n                    <div className=\"flex items-center justify-center h-20 bg-white rounded border border-slate-200\">\r\n                        <div className=\"text-center\">\r\n                            <div className=\"text-xs text-slate-400 uppercase\">Shift in Market Power</div>\r\n                            <div className=\"text-lg font-bold text-slate-700\">\r\n                                {Math.abs(report.original_score - report.perturbed_score)} pts\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {report.rhetorical_shifts && report.rhetorical_shifts.length > 0 && (\r\n                    <div className=\"col-span-2 mt-2\">\r\n                        <h5 className=\"text-[10px] font-bold text-slate-500 uppercase mb-2\">Key Rhetorical Shifts</h5>\r\n                        <div className=\"space-y-2\">\r\n                            {report.rhetorical_shifts.map((shift, idx) => (\r\n                                <div key={idx} className=\"bg-white p-3 rounded border border-slate-200 text-xs\">\r\n                                    <div className=\"flex items-center gap-2 mb-1\">\r\n                                        <span className=\"line-through text-slate-400\">{shift.original}</span>\r\n                                        <span className=\"text-slate-300\">â†’</span>\r\n                                        <span className=\"font-bold text-red-700 bg-red-50 px-1 rounded\">{shift.new}</span>\r\n                                    </div>\r\n                                    <p className=\"text-slate-600 text-[10px] italic\">{shift.explanation}</p>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction getInterpretation(report: AnalysisResult['stress_test_report']): string {\r\n    if (!report) return \"No data available.\";\r\n\r\n    // [Fixed] We prioritize the calculated score interpretation because the AI's narrative \r\n    // often hallucinates fragility even when the score shift is low. \r\n    // The measurement is the ground truth.\r\n    // if (report.shift_explanation && report.shift_explanation.length > 20) {\r\n    //     return report.shift_explanation;\r\n    // }\r\n\r\n    const diff = report.original_score - report.perturbed_score;\r\n    const absDiff = Math.abs(diff);\r\n\r\n    if (report.framing_sensitivity === 'High') {\r\n        return \"CRITICAL FRAGILITY: This document's authority is highly dependent on its specific rhetorical framing. When the 'tone' is inverted, its perceived power collapses. This suggests the policy relies more on persuasive language than robust structural mechanisms.\";\r\n    }\r\n\r\n    if (report.framing_sensitivity === 'Medium') {\r\n        if (diff > 0) {\r\n            return \"MODERATE DEPENDENCY: The document shows some reliance on rhetoric. Inverting the framing weakens its authority (dropping \" + absDiff + \" points), suggesting that while it has some structural teeth, a hostile interpretation could successfully undermine it.\";\r\n        } else {\r\n            return \"UNUSUAL RESULT: The adversarial inversion actually INCREASED the perceived market power. This might suggest the original text was written too defensively or modestly, effectively 'hiding' its own potential power.\";\r\n        }\r\n    }\r\n\r\n    // Low Sensitivity\r\n    return \"ROBUST STRUCTURE: This document is extremely stable. Even when rewritten with hostile input, its core power dynamics remain largely unchanged. The mechanisms described are likely concrete and specific enough to survive 'spin'.\";\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\ValidationSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\VerificationPathwaysTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\policy\\analysis\\VerifiedEvidenceSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\EvidenceLineageModal.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":53,"column":37,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2361,2400],"text":"\r\n                                    &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2361,2400],"text":"\r\n                                    &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2361,2400],"text":"\r\n                                    &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2361,2400],"text":"\r\n                                    &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":53,"column":50,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2412,2447],"text":"&quot;\r\n                                "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2412,2447],"text":"&ldquo;\r\n                                "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2412,2447],"text":"&#34;\r\n                                "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2412,2447],"text":"&rdquo;\r\n                                "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\r\nimport { Quote, FileText } from 'lucide-react';\r\n\r\ninterface EvidenceQuote {\r\n    text: string;\r\n    source?: string;\r\n    context?: string;\r\n}\r\n\r\ninterface EvidenceLineageModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    title: string;\r\n    description?: string;\r\n    quotes: EvidenceQuote[];\r\n    sourceType?: \"Order of Worth\" | \"Cultural Cluster\" | \"Trace\";\r\n}\r\n\r\nexport function EvidenceLineageModal({\r\n    isOpen,\r\n    onClose,\r\n    title,\r\n    description,\r\n    quotes,\r\n    sourceType = \"Trace\"\r\n}: EvidenceLineageModalProps) {\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onClose}>\r\n            <DialogContent className=\"max-w-md max-h-[80vh] overflow-y-auto\">\r\n                <DialogHeader className=\"mb-4\">\r\n                    <div className=\"flex items-center gap-2 text-indigo-600 mb-1\">\r\n                        <FileText className=\"h-4 w-4\" />\r\n                        <span className=\"text-xs font-bold uppercase tracking-wider\">{sourceType} Evidence Lineage</span>\r\n                    </div>\r\n                    <DialogTitle className=\"text-xl font-bold text-slate-900\">{title}</DialogTitle>\r\n                    {description && (\r\n                        <DialogDescription className=\"text-slate-600 mt-2\">\r\n                            {description}\r\n                        </DialogDescription>\r\n                    )}\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-6\">\r\n                    {quotes.length === 0 ? (\r\n                        <div className=\"p-6 text-center text-slate-500 bg-slate-50 rounded-lg border border-dashed\">\r\n                            No direct textual evidence extracted for this item.\r\n                        </div>\r\n                    ) : (\r\n                        quotes.map((quote, idx) => (\r\n                            <div key={idx} className=\"relative pl-6 border-l-2 border-indigo-200 group hover:border-indigo-400 transition-colors\">\r\n                                <Quote className=\"absolute -left-2.5 top-0 h-5 w-5 text-indigo-100 bg-white p-0.5 group-hover:text-indigo-500 transition-colors\" fill=\"currentColor\" />\r\n                                <blockquote className=\"text-sm text-slate-800 italic leading-relaxed mb-2\">\r\n                                    \"{quote.text}\"\r\n                                </blockquote>\r\n                                {quote.source && (\r\n                                    <div className=\"text-xs text-indigo-600 font-medium flex items-center gap-1\">\r\n                                        â€” {quote.source}\r\n                                    </div>\r\n                                )}\r\n                                {quote.context && (\r\n                                    <div className=\"mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded\">\r\n                                        Context: {quote.context}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ))\r\n                    )}\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\EvidenceLineageSheet.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":53,"column":37,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2338,2377],"text":"\r\n                                    &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2338,2377],"text":"\r\n                                    &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2338,2377],"text":"\r\n                                    &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2338,2377],"text":"\r\n                                    &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":53,"column":50,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[2389,2424],"text":"&quot;\r\n                                "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[2389,2424],"text":"&ldquo;\r\n                                "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[2389,2424],"text":"&#34;\r\n                                "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[2389,2424],"text":"&rdquo;\r\n                                "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\r\nimport { Quote, FileText } from 'lucide-react';\r\n\r\ninterface EvidenceQuote {\r\n    text: string;\r\n    source?: string;\r\n    context?: string;\r\n}\r\n\r\ninterface EvidenceLineageSheetProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    title: string;\r\n    description?: string;\r\n    quotes: EvidenceQuote[];\r\n    sourceType?: \"Order of Worth\" | \"Cultural Cluster\" | \"Trace\";\r\n}\r\n\r\nexport function EvidenceLineageSheet({\r\n    isOpen,\r\n    onClose,\r\n    title,\r\n    description,\r\n    quotes,\r\n    sourceType = \"Trace\"\r\n}: EvidenceLineageSheetProps) {\r\n    return (\r\n        <Sheet open={isOpen} onOpenChange={onClose}>\r\n            <SheetContent className=\"overflow-y-auto sm:max-w-md\">\r\n                <SheetHeader className=\"mb-6\">\r\n                    <div className=\"flex items-center gap-2 text-indigo-600 mb-1\">\r\n                        <FileText className=\"h-4 w-4\" />\r\n                        <span className=\"text-xs font-bold uppercase tracking-wider\">{sourceType} Evidence Lineage</span>\r\n                    </div>\r\n                    <SheetTitle className=\"text-2xl font-bold text-slate-900\">{title}</SheetTitle>\r\n                    {description && (\r\n                        <SheetDescription className=\"text-slate-600 mt-2\">\r\n                            {description}\r\n                        </SheetDescription>\r\n                    )}\r\n                </SheetHeader>\r\n\r\n                <div className=\"space-y-6\">\r\n                    {quotes.length === 0 ? (\r\n                        <div className=\"p-6 text-center text-slate-500 bg-slate-50 rounded-lg border border-dashed\">\r\n                            No direct textual evidence extracted for this item.\r\n                        </div>\r\n                    ) : (\r\n                        quotes.map((quote, idx) => (\r\n                            <div key={idx} className=\"relative pl-6 border-l-2 border-indigo-200 group hover:border-indigo-400 transition-colors\">\r\n                                <Quote className=\"absolute -left-2.5 top-0 h-5 w-5 text-indigo-100 bg-white p-0.5 group-hover:text-indigo-500 transition-colors\" fill=\"currentColor\" />\r\n                                <blockquote className=\"text-sm text-slate-800 italic leading-relaxed mb-2\">\r\n                                    \"{quote.text}\"\r\n                                </blockquote>\r\n                                {quote.source && (\r\n                                    <div className=\"text-xs text-indigo-600 font-medium flex items-center gap-1\">\r\n                                        â€” {quote.source}\r\n                                    </div>\r\n                                )}\r\n                                {quote.context && (\r\n                                    <div className=\"mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded\">\r\n                                        Context: {quote.context}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ))\r\n                    )}\r\n                </div>\r\n            </SheetContent>\r\n        </Sheet>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\LogEntry.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":4,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":42},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":29,"column":43,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1614,1615],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1614,1615],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1614,1615],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1614,1615],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":29,"column":67,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[1638,1639],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[1638,1639],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[1638,1639],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[1638,1639],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":104,"column":33,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6616,6651],"text":"\r\n                                &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6616,6651],"text":"\r\n                                &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6616,6651],"text":"\r\n                                &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6616,6651],"text":"\r\n                                &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":104,"column":147,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6764,6795],"text":"&quot;\r\n                            "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6764,6795],"text":"&ldquo;\r\n                            "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6764,6795],"text":"&#34;\r\n                            "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6764,6795],"text":"&rdquo;\r\n                            "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MethodLog } from \"@/types/logs\";\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Info, AlertTriangle, CheckCircle, BrainCircuit, Scale, User, Bot } from \"lucide-react\";\r\n\r\nconst formatEnum = (value: string) => {\r\n    return value.split('_').map(word => word.charAt(0) + word.slice(1).toLowerCase()).join(' ');\r\n};\r\n\r\nexport function LogEntry({ log }: { log: MethodLog }) {\r\n    const isConflictLog = !!log.details.discrepancy;\r\n    const isPositionalityLog = log.action === \"Positionality Calibration\";\r\n\r\n    return (\r\n        <div className={`border-l-2 pl-4 py-3 space-y-2 transition-all ${isConflictLog ? 'border-amber-400 bg-amber-50/30 rounded-r-lg pr-2' : 'border-slate-200'}`}>\r\n            <div className=\"flex items-center justify-between mb-1\">\r\n                <span className=\"text-xs font-semibold text-slate-500\">\r\n                    {new Date(log.timestamp).toLocaleString()}\r\n                </span>\r\n                <Badge variant={isConflictLog ? \"default\" : \"outline\"} className={`text-xs ${isConflictLog ? 'bg-amber-600 hover:bg-amber-700' : ''}`}>\r\n                    {log.action}\r\n                </Badge>\r\n            </div>\r\n\r\n            {/* Positionality Statement */}\r\n            {log.details.statement && (\r\n                <div className=\"bg-slate-50 p-3 rounded-md border border-slate-100 text-sm text-slate-700 italic relative\">\r\n                    <User className=\"h-3 w-3 absolute top-3 left-2 text-slate-400\" />\r\n                    <div className=\"pl-4\">\"{log.details.statement}\"</div>\r\n                    {isPositionalityLog && (\r\n                        <div className=\"mt-2 text-xs text-slate-500 flex gap-2\">\r\n                            <Badge variant=\"secondary\" className=\"text-[10px]\">Locus: {log.details.locus as string}</Badge>\r\n                            <Badge variant=\"secondary\" className=\"text-[10px]\">Lens: {log.details.discipline as string}</Badge>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* Rich Conflict Resolution Log */}\r\n            {log.details.discrepancy && (\r\n                <div className=\"mt-2 space-y-3\">\r\n                    <div className=\"bg-white p-3 rounded-md border border-slate-200 shadow-sm\">\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                            <Scale className=\"h-4 w-4 text-amber-600\" />\r\n                            <span className=\"font-semibold text-slate-800 text-xs uppercase tracking-wide\">Interpretive Discrepancy</span>\r\n                            <TooltipProvider>\r\n                                <Tooltip>\r\n                                    <TooltipTrigger>\r\n                                        <Info className=\"h-3 w-3 text-slate-400 cursor-help\" />\r\n                                    </TooltipTrigger>\r\n                                    <TooltipContent className=\"max-w-xs\">\r\n                                        <p>The AI detected a divergence between its analysis and your anchor. This log captures how you resolved it.</p>\r\n                                    </TooltipContent>\r\n                                </Tooltip>\r\n                            </TooltipProvider>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"bg-slate-50 p-2 rounded border border-slate-100\">\r\n                                <div className=\"flex items-center gap-1 mb-1\">\r\n                                    <Bot className=\"h-3 w-3 text-indigo-500\" />\r\n                                    <span className=\"text-[10px] text-slate-500 uppercase font-bold\">AI Proposition</span>\r\n                                </div>\r\n                                <span className=\"font-medium text-indigo-700 text-sm block\">\r\n                                    {formatEnum(log.details.discrepancy.systemProposition.placement)}\r\n                                </span>\r\n                                <p className=\"text-[10px] text-slate-500 mt-1 leading-tight\">\r\n                                    {log.details.discrepancy.systemProposition.evidence}\r\n                                </p>\r\n                            </div>\r\n                            <div className=\"bg-slate-50 p-2 rounded border border-slate-100\">\r\n                                <div className=\"flex items-center gap-1 mb-1\">\r\n                                    <User className=\"h-3 w-3 text-emerald-500\" />\r\n                                    <span className=\"text-[10px] text-slate-500 uppercase font-bold\">Human Anchor</span>\r\n                                </div>\r\n                                <span className=\"font-medium text-emerald-700 text-sm block\">\r\n                                    {formatEnum(log.details.discrepancy.humanAnchor.placement)}\r\n                                </span>\r\n                                <p className=\"text-[10px] text-slate-500 mt-1 leading-tight\">\r\n                                    {log.details.discrepancy.humanAnchor.evidence}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between bg-slate-100 p-2 rounded text-xs\">\r\n                        <span className=\"font-semibold text-slate-600\">Resolution:</span>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className={log.details.resolution?.action === 'MANUAL_OVERRIDE' ? 'text-red-600 font-bold' : 'text-emerald-600 font-bold'}>\r\n                                {formatEnum(log.details.resolution?.action || '')}\r\n                            </span>\r\n                            <span className=\"text-slate-500\">â†’</span>\r\n                            <span className=\"text-slate-800 font-medium\">{formatEnum(log.details.resolution?.finalValue || '')}</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {log.details.justification && (\r\n                        <div className=\"bg-red-50 p-3 rounded-md border border-red-100 text-red-900 text-xs\">\r\n                            <div className=\"flex items-center gap-2 mb-1 text-red-700 font-semibold\">\r\n                                <AlertTriangle className=\"h-3 w-3\" />\r\n                                <span>Analyst Rationale</span>\r\n                            </div>\r\n                            <p className=\"italic pl-5\">\r\n                                \"{typeof log.details.justification === 'string' ? log.details.justification : log.details.justification.rationale}\"\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {log.details.reflexivity && (\r\n                        <div className=\"bg-purple-50 p-3 rounded-md border border-purple-100 text-purple-900 text-xs\">\r\n                            <div className=\"flex items-center gap-2 mb-1 text-purple-700 font-semibold\">\r\n                                <BrainCircuit className=\"h-3 w-3\" />\r\n                                <span>System Reflexivity</span>\r\n                                <TooltipProvider>\r\n                                    <Tooltip>\r\n                                        <TooltipTrigger>\r\n                                            <Info className=\"h-3 w-3 text-purple-400 cursor-help\" />\r\n                                        </TooltipTrigger>\r\n                                        <TooltipContent className=\"max-w-xs\">\r\n                                            <p>How the system is updating its internal model based on this interaction.</p>\r\n                                        </TooltipContent>\r\n                                    </Tooltip>\r\n                                </TooltipProvider>\r\n                            </div>\r\n                            <p className=\"pl-5\">\r\n                                {log.details.reflexivity.feedbackLoop}\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            {/* Standard Validation Details (Legacy) */}\r\n            {!log.details.discrepancy && log.details.agreement && (\r\n                <div className=\"text-xs space-y-1 pl-2\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <span className=\"font-semibold text-slate-600\">Agreement:</span>\r\n                        <span className={log.details.agreement === 'yes' ? 'text-emerald-600 font-bold' : 'text-red-600 font-bold'}>\r\n                            {log.details.agreement.toUpperCase()}\r\n                        </span>\r\n                    </div>\r\n                    {log.details.initial_impression && (\r\n                        <p className=\"text-slate-600\"><span className=\"font-semibold\">Initial Impression:</span> {log.details.initial_impression}</p>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\MultiLensAnalysis.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":97,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":100,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2013,2016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2013,2016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4715,4718],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4715,4718],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":215,"column":71,"nodeType":null,"messageId":"unusedVar","endLine":215,"endColumn":72},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":216,"column":69,"nodeType":null,"messageId":"unusedVar","endLine":216,"endColumn":70},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'__' is defined but never used.","line":216,"column":82,"nodeType":null,"messageId":"unusedVar","endLine":216,"endColumn":84},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17780,17783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17780,17783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { useServerStorage } from '@/hooks/useServerStorage';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Loader2, Play, GitCompare, Maximize2, Minimize2, FileText, VolumeX } from 'lucide-react';\r\nimport { analyzeDocument, AnalysisMode } from '@/services/analysis';\r\nimport { AnalysisResult, LegitimacyAnalysis, Source } from '@/types';\r\nimport { SpectralRadar } from './SpectralRadar';\r\nimport { SystemCritiqueSection } from '@/components/common/SystemCritiqueSection';\r\nimport { EvidenceLineageModal } from '@/components/reflexivity/EvidenceLineageModal';\r\n\r\ninterface MultiLensAnalysisProps {\r\n    initialText?: string;\r\n    sources?: Source[];\r\n}\r\n\r\ntype LensType = 'dsf' | 'cultural_framing' | 'institutional_logics' | 'legitimacy';\r\n\r\nconst LENSES: { id: LensType; name: string; description: string }[] = [\r\n    { id: 'dsf', name: 'Decolonial Framework', description: 'Power, agency, and coloniality' },\r\n    { id: 'cultural_framing', name: 'Cultural Framing', description: 'Values, narratives, and epistemic authority' },\r\n    { id: 'institutional_logics', name: 'Institutional Logics', description: 'Conflicting institutional orders and practices' },\r\n    { id: 'legitimacy', name: 'Legitimacy Orders', description: 'Justification regimes and moral vocabulary' }\r\n];\r\n\r\nexport function MultiLensAnalysis({ initialText = '', sources = [] }: MultiLensAnalysisProps) {\r\n    // Persist text input\r\n    const [text, setText] = useServerStorage(\"multi_lens_text\", initialText);\r\n\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [progress, setProgress] = useState<string>('');\r\n    const [activeEvidence, setActiveEvidence] = useState<{ title: string; type: string; quotes: any[] } | null>(null);\r\n\r\n    // Persist analysis results\r\n    const [results, setResults] = useServerStorage<Record<LensType, AnalysisResult | null>>(\"multi_lens_results\", {\r\n        dsf: null,\r\n        cultural_framing: null,\r\n        institutional_logics: null,\r\n        legitimacy: null\r\n    });\r\n\r\n    const [expandedLens, setExpandedLens] = useState<LensType | null>(null);\r\n\r\n    const handleSourceSelect = (sourceId: string) => {\r\n        const source = sources.find(s => s.id === sourceId);\r\n        if (source && source.extractedText) {\r\n            setText(source.extractedText.substring(0, 15000)); // Limit text length for analysis\r\n        }\r\n    };\r\n\r\n    const handleAnalyze = async () => {\r\n        if (!text.trim()) return;\r\n\r\n        setIsAnalyzing(true);\r\n        const newResults = { ...results };\r\n\r\n        try {\r\n            for (const lens of LENSES) {\r\n                setProgress(`Running ${lens.name}...`);\r\n                try {\r\n                    const result = await analyzeDocument(\r\n                        text,\r\n                        lens.id as AnalysisMode,\r\n                        'Policy Document', // Default source type\r\n                        true // Force refresh to ensure fresh comparison\r\n                    );\r\n                    newResults[lens.id] = result;\r\n                    setResults({ ...newResults });\r\n                } catch (error) {\r\n                    console.error(`Error analyzing with ${lens.name}:`, error);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error('Analysis failed:', error);\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n            setProgress('');\r\n        }\r\n    };\r\n\r\n    const getKeyInsight = (lens: LensType, result: AnalysisResult | null) => {\r\n        if (!result) return 'No analysis yet.';\r\n\r\n        switch (lens) {\r\n            case 'dsf':\r\n                return result.key_insight || result.reflexivity_situated_praxis || 'No insight generated.';\r\n            case 'cultural_framing':\r\n                return result.dominant_cultural_logic ? `Dominant Logic: ${result.dominant_cultural_logic}. ${result.state_market_society}` : result.key_insight || 'No cultural insight.';\r\n            case 'institutional_logics':\r\n                if (result.dominant_logic) {\r\n                    return `Dominant Logic: ${result.dominant_logic}. ${result.overall_assessment || ''}`;\r\n                }\r\n                return result.overall_assessment || 'No institutional insight.';\r\n            case 'legitimacy':\r\n                const legitResult = result as unknown as LegitimacyAnalysis;\r\n                let justification = legitResult.justification_logic as any;\r\n\r\n                // Handle case where LLM returns object instead of string\r\n                if (typeof justification === 'object' && justification !== null) {\r\n                    justification = justification.summary || justification.text || justification.description || JSON.stringify(justification);\r\n                }\r\n\r\n                if (legitResult.dominant_order) {\r\n                    return `Dominant Order: ${legitResult.dominant_order}. Justification: ${justification}`;\r\n                }\r\n                return justification || 'No legitimacy insight.';\r\n            default:\r\n                return 'N/A';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                        <GitCompare className=\"h-5 w-5 text-indigo-600\" />\r\n                        Comparative Lens Analysis\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                        Deploy multiple theoretical lenses simultaneously to observe how the assemblage refracts the artifact.\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                    {sources.length > 0 && (\r\n                        <div className=\"flex items-center gap-2 mb-2\">\r\n                            <FileText className=\"h-4 w-4 text-slate-500\" />\r\n                            <Select onValueChange={handleSourceSelect}>\r\n                                <SelectTrigger className=\"w-full md:w-[300px]\">\r\n                                    <SelectValue placeholder=\"Select artifact to assemble...\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {sources.map(source => (\r\n                                        <SelectItem key={source.id} value={source.id}>\r\n                                            {source.title}\r\n                                        </SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                            <span className=\"text-xs text-slate-400\">or paste text below</span>\r\n                        </div>\r\n                    )}\r\n                    <Textarea\r\n                        placeholder=\"Paste text for theoretical entanglement...\"\r\n                        value={text}\r\n                        onChange={(e) => setText(e.target.value)}\r\n                        className=\"min-h-[150px] font-mono text-sm\"\r\n                    />\r\n                    <Button\r\n                        onClick={handleAnalyze}\r\n                        disabled={isAnalyzing || !text.trim()}\r\n                        className=\"w-full sm:w-auto\"\r\n                    >\r\n                        {isAnalyzing ? (\r\n                            <>\r\n                                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                {progress}\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Play className=\"mr-2 h-4 w-4\" />\r\n                                Initiate Entanglement\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {Object.values(results).some(r => r !== null) && (\r\n                <div className=\"space-y-6\">\r\n                    {/* Visualization of Entanglements */}\r\n                    <SpectralRadar results={results} />\r\n\r\n                    <div className=\"grid gap-6 md:grid-cols-2\">\r\n                        {LENSES.map((lens) => (\r\n                            <Card key={lens.id} className={`flex flex-col ${expandedLens === lens.id ? 'md:col-span-2 ring-2 ring-indigo-500' : ''}`}>\r\n                                <CardHeader className=\"pb-2\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <div className=\"space-y-1\">\r\n                                            <CardTitle className=\"text-base font-semibold text-slate-800\">\r\n                                                {lens.name}\r\n                                            </CardTitle>\r\n                                            <CardDescription className=\"text-xs\">\r\n                                                {lens.description}\r\n                                            </CardDescription>\r\n                                        </div>\r\n                                        <Button\r\n                                            variant=\"ghost\"\r\n                                            size=\"icon\"\r\n                                            className=\"h-6 w-6\"\r\n                                            onClick={() => setExpandedLens(expandedLens === lens.id ? null : lens.id)}\r\n                                        >\r\n                                            {expandedLens === lens.id ? <Minimize2 className=\"h-3 w-3\" /> : <Maximize2 className=\"h-3 w-3\" />}\r\n                                        </Button>\r\n                                    </div>\r\n                                </CardHeader>\r\n                                <CardContent className=\"flex-1 text-sm text-slate-600\">\r\n                                    {results[lens.id] ? (\r\n                                        <div className=\"space-y-3\">\r\n                                            <div className=\"bg-slate-50 p-3 rounded-md border border-slate-100\">\r\n                                                <span className=\"text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1\">Key Insight</span>\r\n                                                <p className=\"leading-relaxed\">\r\n                                                    {getKeyInsight(lens.id, results[lens.id])}\r\n                                                </p>\r\n                                            </div>\r\n\r\n                                            {/* Legitimacy Interactive Orders */}\r\n                                            {lens.id === 'legitimacy' && results['legitimacy'] && (\r\n                                                <div className=\"mt-3\">\r\n                                                    <span className=\"text-xs font-semibold text-slate-500 block mb-2\">Orders of Worth (Click for Evidence)</span>\r\n                                                    <div className=\"flex flex-wrap gap-2\">\r\n                                                        {Object.entries((results['legitimacy'] as unknown as LegitimacyAnalysis).orders || {})\r\n                                                            .filter(([_, score]) => score > 0)\r\n                                                            .sort(([_, scoreA], [__, scoreB]) => scoreB - scoreA)\r\n                                                            .map(([order, score]) => (\r\n                                                                <div\r\n                                                                    key={order}\r\n                                                                    className=\"flex items-center gap-1 bg-white border border-slate-200 rounded-full px-3 py-1 text-xs cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-colors group\"\r\n                                                                    onClick={() => {\r\n                                                                        const legAnalysis = results['legitimacy'] as unknown as LegitimacyAnalysis;\r\n                                                                        const quotes = legAnalysis.evidence_quotes?.[order] || [];\r\n                                                                        setActiveEvidence({\r\n                                                                            title: `${order.charAt(0).toUpperCase() + order.slice(1)} Order`,\r\n                                                                            type: \"Order of Worth\",\r\n                                                                            quotes: quotes.map(q => ({ text: q, source: \"Policy Text\" }))\r\n                                                                        });\r\n                                                                    }}\r\n                                                                >\r\n                                                                    <span className=\"font-medium text-slate-700 group-hover:text-indigo-700 capitalize\">{order}</span>\r\n                                                                    <span className=\"bg-slate-100 text-slate-600 px-1.5 rounded-full font-bold group-hover:bg-indigo-100 group-hover:text-indigo-700\">{score}</span>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Voices Silenced Section */}\r\n                                            {results[lens.id]?.silenced_voices && results[lens.id]!.silenced_voices!.length > 0 && (\r\n                                                <div className=\"bg-red-50 p-3 rounded-md border border-red-100 relative overflow-hidden group\">\r\n                                                    <div className=\"absolute right-0 top-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity\">\r\n                                                        <VolumeX className=\"h-12 w-12 text-red-900\" />\r\n                                                    </div>\r\n                                                    <span className=\"text-xs font-bold text-red-600 uppercase tracking-wider block mb-2 flex items-center gap-1\">\r\n                                                        <VolumeX className=\"h-3 w-3\" /> Voices Silenced\r\n                                                    </span>\r\n                                                    <ul className=\"space-y-1 relative z-10\">\r\n                                                        {results[lens.id]!.silenced_voices!.map((voice, idx) => (\r\n                                                            <li key={idx} className=\"text-xs text-red-800 font-medium flex items-start gap-2\">\r\n                                                                <span className=\"block w-1 h-1 rounded-full bg-red-400 mt-1.5 shrink-0\" />\r\n                                                                {voice}\r\n                                                            </li>\r\n                                                        ))}\r\n                                                    </ul>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {expandedLens === lens.id && (\r\n                                                <div className=\"mt-4 space-y-2 animate-in fade-in duration-300\">\r\n                                                    <h4 className=\"font-medium text-slate-900\">Detailed Analysis</h4>\r\n                                                    <pre className=\"whitespace-pre-wrap bg-slate-900 text-slate-50 p-4 rounded-md text-xs overflow-x-auto max-h-[300px]\">\r\n                                                        {JSON.stringify(results[lens.id], null, 2)}\r\n                                                    </pre>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"h-24 flex items-center justify-center text-slate-400 italic bg-slate-50 rounded-md border border-dashed\">\r\n                                            Waiting for analysis...\r\n                                        </div>\r\n                                    )}\r\n                                </CardContent>\r\n                            </Card>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* System Critique (Devil's Advocate) */}\r\n                    {results['dsf'] && results['dsf'].system_critique && (\r\n                        <SystemCritiqueSection critique={results['dsf'].system_critique} />\r\n                    )}\r\n                </div>\r\n            )}\r\n\r\n            <EvidenceLineageModal\r\n                isOpen={!!activeEvidence}\r\n                onClose={() => setActiveEvidence(null)}\r\n                title={activeEvidence?.title || \"\"}\r\n                description=\"Verbatim text segments that triggered this classification.\"\r\n                quotes={activeEvidence?.quotes || []}\r\n                sourceType={activeEvidence?.type as any || \"Trace\"}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\PositionalityDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used.","line":8,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":60},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":78,"column":70,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its &quot;Decolonial Prompts\" and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its &ldquo;Decolonial Prompts\" and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its &#34;Decolonial Prompts\" and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its &rdquo;Decolonial Prompts\" and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":78,"column":89,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its \"Decolonial Prompts&quot; and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its \"Decolonial Prompts&ldquo; and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its \"Decolonial Prompts&#34; and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[3213,3373],"text":"\r\n                        Assemblage-AI uses your inputs to adjust its \"Decolonial Prompts&rdquo; and flag potential cultural misunderstandings.\r\n                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":156,"column":44,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable &quot;Counter-Narrative\" Prompts\r\n                                "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable &ldquo;Counter-Narrative\" Prompts\r\n                                "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable &#34;Counter-Narrative\" Prompts\r\n                                "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable &rdquo;Counter-Narrative\" Prompts\r\n                                "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":156,"column":62,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable \"Counter-Narrative&quot; Prompts\r\n                                "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable \"Counter-Narrative&ldquo; Prompts\r\n                                "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable \"Counter-Narrative&#34; Prompts\r\n                                "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[8359,8465],"text":"\r\n                                    Enable \"Counter-Narrative&rdquo; Prompts\r\n                                "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Loader2, Settings2, Globe, BookOpen, AlertTriangle } from \"lucide-react\";\r\nimport { PositionalityData } from \"@/types\";\r\n\r\ninterface PositionalityDialogProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onConfirm: (data: PositionalityData) => void;\r\n}\r\n\r\nexport function PositionalityDialog({ isOpen, onClose, onConfirm }: PositionalityDialogProps) {\r\n    const [locus, setLocus] = useState(\"\");\r\n    const [discipline, setDiscipline] = useState(\"\");\r\n    const [reflexiveGap, setReflexiveGap] = useState(\"\");\r\n    const [enableCounterNarrative, setEnableCounterNarrative] = useState(false);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const handleConfirm = async () => {\r\n        if (!locus || !discipline || !reflexiveGap) return;\r\n\r\n        setIsSaving(true);\r\n        const data: PositionalityData = {\r\n            locus,\r\n            discipline,\r\n            reflexiveGap,\r\n            enableCounterNarrative\r\n        };\r\n\r\n        try {\r\n            // Save to logs\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true' && process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n            }\r\n\r\n            await fetch('/api/logs', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    action: \"Positionality Calibration\",\r\n                    details: {\r\n                        ...data,\r\n                        context: \"Pre-Analysis Calibration\"\r\n                    }\r\n                })\r\n            });\r\n\r\n            onConfirm(data);\r\n            // Reset for next time\r\n            setLocus(\"\");\r\n            setDiscipline(\"\");\r\n            setReflexiveGap(\"\");\r\n            setEnableCounterNarrative(false);\r\n        } catch (error) {\r\n            console.error(\"Failed to save positionality statement\", error);\r\n            onConfirm(data);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"sm:max-w-[600px] max-h-[90vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                    <div className=\"flex items-center gap-2 text-indigo-600 mb-2\">\r\n                        <Settings2 className=\"h-5 w-5\" />\r\n                        <span className=\"text-xs font-bold uppercase tracking-wider\">System Calibration</span>\r\n                    </div>\r\n                    <DialogTitle className=\"text-xl\">Calibrate Interpretive Lenses</DialogTitle>\r\n                    <DialogDescription>\r\n                        Assemblage-AI uses your inputs to adjust its \"Decolonial Prompts\" and flag potential cultural misunderstandings.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-6 py-4\">\r\n                    {/* Part 1: Locus of Enunciation */}\r\n                    <div className=\"space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200\">\r\n                        <h5 className=\"text-sm font-bold text-slate-900 uppercase flex items-center gap-2\">\r\n                            <Globe className=\"h-4 w-4 text-slate-500\" />\r\n                            Part 1: Locus of Enunciation\r\n                        </h5>\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label className=\"text-xs\">Geographic Locus</Label>\r\n                                <Select value={locus} onValueChange={setLocus}>\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"Select Region\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        <SelectItem value=\"Global North\">Global North</SelectItem>\r\n                                        <SelectItem value=\"Global South\">Global South</SelectItem>\r\n                                        <SelectItem value=\"Indigenous\">Indigenous / First Nations</SelectItem>\r\n                                        <SelectItem value=\"Diasporic\">Diasporic</SelectItem>\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label className=\"text-xs\">Disciplinary Lens</Label>\r\n                                <Select value={discipline} onValueChange={setDiscipline}>\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"Select Discipline\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        <SelectItem value=\"Legal\">Legal / Regulatory</SelectItem>\r\n                                        <SelectItem value=\"Technical\">Technical / Engineering</SelectItem>\r\n                                        <SelectItem value=\"Sociological\">Sociological / STS</SelectItem>\r\n                                        <SelectItem value=\"Activist\">Activist / Civil Society</SelectItem>\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Part 2: Epistemic Distance */}\r\n                    <div className=\"space-y-4\">\r\n                        <h5 className=\"text-sm font-bold text-slate-900 uppercase flex items-center gap-2\">\r\n                            <BookOpen className=\"h-4 w-4 text-slate-500\" />\r\n                            Part 2: Epistemic Distance\r\n                        </h5>\r\n                        <div className=\"space-y-2\">\r\n                            <Label className=\"text-xs\">Reflexive Gap Prediction</Label>\r\n                            <p className=\"text-xs text-slate-500 mb-2\">\r\n                                Given your Locus ({locus || \"...\"}) and the Target Document, what specific concepts might you misinterpret?\r\n                            </p>\r\n                            <Textarea\r\n                                placeholder=\"e.g., 'I might default to individual privacy definitions instead of communal data rights.'\"\r\n                                value={reflexiveGap}\r\n                                onChange={(e) => setReflexiveGap(e.target.value)}\r\n                                className=\"min-h-[80px]\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Part 3: Active Calibration */}\r\n                    <div className=\"space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100\">\r\n                        <h5 className=\"text-sm font-bold text-indigo-900 uppercase flex items-center gap-2\">\r\n                            <Settings2 className=\"h-4 w-4\" />\r\n                            Part 3: Active Calibration\r\n                        </h5>\r\n                        <div className=\"flex items-start gap-3\">\r\n                            <Checkbox\r\n                                id=\"counter-narrative\"\r\n                                checked={enableCounterNarrative}\r\n                                onCheckedChange={(checked: boolean | \"indeterminate\") => setEnableCounterNarrative(checked === true)}\r\n                                className=\"mt-1\"\r\n                            />\r\n                            <div className=\"space-y-1\">\r\n                                <Label htmlFor=\"counter-narrative\" className=\"font-semibold text-indigo-900 cursor-pointer\">\r\n                                    Enable \"Counter-Narrative\" Prompts\r\n                                </Label>\r\n                                <p className=\"text-xs text-indigo-700 leading-relaxed\">\r\n                                    Force the AI to re-summarize key findings from the perspective of marginalized actors identified in the text.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={onClose}>Cancel</Button>\r\n                    <Button\r\n                        onClick={handleConfirm}\r\n                        disabled={!locus || !discipline || !reflexiveGap || isSaving}\r\n                        className=\"bg-indigo-600 hover:bg-indigo-700 text-white\"\r\n                    >\r\n                        {isSaving ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\r\n                        Save & Calibrate Engine\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\reflexivity\\SpectralRadar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'governanceResult' is assigned a value but never used.","line":15,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React from 'react';\r\nimport { ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, Tooltip } from 'recharts';\r\nimport { AnalysisResult, LegitimacyAnalysis } from '@/types';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Activity } from 'lucide-react';\r\n\r\ninterface SpectralRadarProps {\r\n    results: Record<string, AnalysisResult | null>;\r\n}\r\n\r\nexport function SpectralRadar({ results }: SpectralRadarProps) {\r\n    // 1. Extract Governance Scores (if available)\r\n    const governanceResult = results['institutional_logics']; // Often holds gov scores in this app structure, or 'governance' if key exists.\r\n    // Actually, based on types, governance scores might be in any result if the prompt extracted them.\r\n    // But usually it's specifically the \"Institutional Logics\" or a specific \"Governance\" lens.\r\n    // Let's iterate and find the first result with governance scores.\r\n    const govScores = Object.values(results).find(r => r?.governance_scores)?.governance_scores;\r\n\r\n    // 2. Extract Legitimacy Orders\r\n    const legitimacyResult = results['legitimacy'] as unknown as LegitimacyAnalysis | undefined;\r\n    // Note: cast as LegitimacyAnalysis because the generic AnalysisResult might not fully capture the specific shape if types aren't perfectly unified.\r\n    // Looking at src/types/index.ts, `legitimacy_analysis` is a property on Source, but `AnalysisResult` has `legitimacy_claims`. \r\n    // However, the `MultiLensAnalysis` component casts the result to `LegitimacyAnalysis` in `getKeyInsight`, so the result object ITSELF mirrors that structure for that lens.\r\n    const legOrders = legitimacyResult?.orders;\r\n\r\n\r\n    if (!govScores && !legOrders) {\r\n        return null;\r\n    }\r\n\r\n    // 3. Transform Data for Radar Chart\r\n    // We want to normalize everything to 0-10 scale if possible.\r\n    // Governance scores are usually 0-10 or 0-1. Let's assume 0-10 based on typical prompt.\r\n    // Legitimacy orders are 0-10.\r\n\r\n    const data = [\r\n        { subject: 'Market', A: legOrders?.market || 0, B: govScores?.market_power || 0, fullMark: 10 },\r\n        { subject: 'Civic/Rights', A: legOrders?.civic || 0, B: govScores?.rights_focus || 0, fullMark: 10 },\r\n        { subject: 'Industrial/Proc', A: legOrders?.industrial || 0, B: govScores?.procedurality || 0, fullMark: 10 },\r\n        { subject: 'Domestic/Flex', A: legOrders?.domestic || 0, B: govScores?.flexibility || 0, fullMark: 10 },\r\n        { subject: 'Inspiration/Cent', A: legOrders?.inspired || 0, B: govScores?.centralization || 0, fullMark: 10 },\r\n        // { subject: 'Fame', A: legOrders?.fame || 0, B: 0, fullMark: 10 },\r\n    ];\r\n\r\n    return (\r\n        <Card className=\"col-span-1 md:col-span-2 border-indigo-100 bg-slate-50/50\">\r\n            <CardHeader className=\"pb-2\">\r\n                <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\r\n                    <Activity className=\"h-4 w-4 text-indigo-600\" />\r\n                    Diffractive Spectral Radar\r\n                </CardTitle>\r\n                <CardDescription className=\"text-xs\">\r\n                    Visualizing the interference pattern between Legitimacy Orders (Justification) and Governance Mechanics (Power).\r\n                </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"h-[300px]\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                    <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={data}>\r\n                        <PolarGrid stroke=\"#e2e8f0\" />\r\n                        <PolarAngleAxis dataKey=\"subject\" tick={{ fill: '#64748b', fontSize: 10 }} />\r\n                        <PolarRadiusAxis angle={30} domain={[0, 10]} tick={false} axisLine={false} />\r\n\r\n                        <Radar\r\n                            name=\"Legitimacy (Justification)\"\r\n                            dataKey=\"A\"\r\n                            stroke=\"#8884d8\"\r\n                            strokeWidth={2}\r\n                            fill=\"#8884d8\"\r\n                            fillOpacity={0.3}\r\n                        />\r\n                        <Radar\r\n                            name=\"Governance (Mechanics)\"\r\n                            dataKey=\"B\"\r\n                            stroke=\"#82ca9d\"\r\n                            strokeWidth={2}\r\n                            fill=\"#82ca9d\"\r\n                            fillOpacity={0.3}\r\n                        />\r\n                        <Legend wrapperStyle={{ fontSize: '12px', paddingTop: '10px' }} />\r\n                        <Tooltip\r\n                            contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#f8fafc' }}\r\n                            itemStyle={{ color: '#f8fafc' }}\r\n                        />\r\n                    </RadarChart>\r\n                </ResponsiveContainer>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\ArtifactRepository.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\DiscourseAnalyzer.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":107,"column":57,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5067,5126],"text":"\r\n                                                        &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5067,5126],"text":"\r\n                                                        &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5067,5126],"text":"\r\n                                                        &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5067,5126],"text":"\r\n                                                        &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":107,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5133,5188],"text":"&quot;\r\n                                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5133,5188],"text":"&ldquo;\r\n                                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5133,5188],"text":"&#34;\r\n                                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5133,5188],"text":"&rdquo;\r\n                                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":137,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6903,6959],"text":"\r\n                                            Example: &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6903,6959],"text":"\r\n                                            Example: &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6903,6959],"text":"\r\n                                            Example: &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6903,6959],"text":"\r\n                                            Example: &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":137,"column":73,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6977,7020],"text":"&quot;\r\n                                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6977,7020],"text":"&ldquo;\r\n                                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6977,7020],"text":"&#34;\r\n                                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6977,7020],"text":"&rdquo;\r\n                                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\";\r\nimport { ResistanceArtifact, ArtifactAnalysisResult } from \"@/types/resistance\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Loader2, Sparkles, BookOpen, MessageCircle, Network } from \"lucide-react\";\r\n\r\ninterface DiscourseAnalyzerProps {\r\n    artifact: ResistanceArtifact;\r\n    onAnalysisComplete?: (analysis: ArtifactAnalysisResult) => void;\r\n}\r\n\r\nexport function DiscourseAnalyzer({ artifact, onAnalysisComplete }: DiscourseAnalyzerProps) {\r\n    const [isAnalyzing, setIsAnalyzing] = useState(false);\r\n    const [analysis, setAnalysis] = useState<ArtifactAnalysisResult | null>(\r\n        artifact.frames ? {\r\n            artifact_id: artifact.id,\r\n            frames: artifact.frames,\r\n            strategies: artifact.rhetorical_strategies || [],\r\n            reconfiguration: artifact.reconfiguration_potential,\r\n            generated_at: new Date().toISOString()\r\n        } : null\r\n    );\r\n\r\n    const handleAnalyze = async () => {\r\n        setIsAnalyzing(true);\r\n        try {\r\n            const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n            if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n                headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID || 'demo-user';\r\n            }\r\n\r\n            const response = await fetch('/api/resistance/analyze', {\r\n                method: 'POST',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    artifact_id: artifact.id,\r\n                    artifact_text: artifact.text,\r\n                    analysis_type: 'full'\r\n                })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (data.success) {\r\n                setAnalysis(data.analysis);\r\n                onAnalysisComplete?.(data.analysis);\r\n            }\r\n        } catch (error) {\r\n            console.error('Analysis failed:', error);\r\n        } finally {\r\n            setIsAnalyzing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Analysis Trigger */}\r\n            {!analysis && (\r\n                <Card>\r\n                    <CardContent className=\"py-8 text-center\">\r\n                        <Sparkles className=\"h-12 w-12 text-purple-500 mx-auto mb-4\" />\r\n                        <h3 className=\"font-semibold text-lg mb-2\">Discourse Analysis</h3>\r\n                        <p className=\"text-sm text-slate-600 mb-4 max-w-md mx-auto\">\r\n                            Analyze this artifact to extract discourse frames, rhetorical strategies,\r\n                            and assemblage reconfiguration potential.\r\n                        </p>\r\n                        <Button onClick={handleAnalyze} disabled={isAnalyzing}>\r\n                            {isAnalyzing ? (\r\n                                <>\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                    Analyzing...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                    Run Discourse Analysis\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n\r\n            {/* Analysis Results */}\r\n            {analysis && (\r\n                <>\r\n                    {/* Discourse Frames */}\r\n                    {analysis.frames && analysis.frames.length > 0 && (\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <BookOpen className=\"h-5 w-5 text-blue-600\" />\r\n                                    <CardTitle className=\"text-lg\">Discourse Frames</CardTitle>\r\n                                </div>\r\n                            </CardHeader>\r\n                            <CardContent className=\"space-y-4\">\r\n                                {analysis.frames.map((frame, idx) => (\r\n                                    <div key={idx} className=\"border-l-4 border-blue-500 pl-4 py-2\">\r\n                                        <h4 className=\"font-bold text-slate-900\">{frame.frame_name}</h4>\r\n                                        <p className=\"text-sm text-slate-700 mt-1\">{frame.description}</p>\r\n                                        {frame.evidence_quotes && frame.evidence_quotes.length > 0 && (\r\n                                            <div className=\"mt-3 space-y-2\">\r\n                                                {frame.evidence_quotes.map((quote, qIdx) => (\r\n                                                    <blockquote key={qIdx} className=\"text-xs text-slate-600 italic pl-3 border-l-2 border-slate-200\">\r\n                                                        \"{quote}\"\r\n                                                    </blockquote>\r\n                                                ))}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                ))}\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n\r\n                    {/* Rhetorical Strategies */}\r\n                    {analysis.strategies && analysis.strategies.length > 0 && (\r\n                        <Card>\r\n                            <CardHeader>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <MessageCircle className=\"h-5 w-5 text-green-600\" />\r\n                                    <CardTitle className=\"text-lg\">Rhetorical Strategies</CardTitle>\r\n                                </div>\r\n                            </CardHeader>\r\n                            <CardContent className=\"space-y-4\">\r\n                                {analysis.strategies.map((strategy, idx) => (\r\n                                    <div key={idx} className=\"bg-green-50 p-4 rounded-lg\">\r\n                                        <div className=\"flex items-start justify-between\">\r\n                                            <Badge className=\"bg-green-200 text-green-800\">\r\n                                                {strategy.strategy.replace('_', ' ')}\r\n                                            </Badge>\r\n                                        </div>\r\n                                        <p className=\"text-sm text-slate-700 mt-2\">{strategy.description}</p>\r\n                                        <p className=\"text-xs text-slate-600 mt-2 italic\">\r\n                                            Example: \"{strategy.example}\"\r\n                                        </p>\r\n                                    </div>\r\n                                ))}\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n\r\n                    {/* Assemblage Reconfiguration */}\r\n                    {analysis.reconfiguration && (\r\n                        <Card className=\"border-2 border-purple-200\">\r\n                            <CardHeader className=\"bg-purple-50\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Network className=\"h-5 w-5 text-purple-600\" />\r\n                                    <CardTitle className=\"text-lg\">Assemblage Reconfiguration Analysis</CardTitle>\r\n                                </div>\r\n                            </CardHeader>\r\n                            <CardContent className=\"space-y-4 pt-6\">\r\n                                <div>\r\n                                    <h4 className=\"font-semibold text-sm text-purple-900 mb-1\">Deterritorializes:</h4>\r\n                                    <p className=\"text-sm text-slate-700\">{analysis.reconfiguration.deterritorializes}</p>\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <h4 className=\"font-semibold text-sm text-purple-900 mb-1\">Recodes:</h4>\r\n                                    <p className=\"text-sm text-slate-700\">{analysis.reconfiguration.recodes}</p>\r\n                                </div>\r\n\r\n                                {analysis.reconfiguration.new_connections && (\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-sm text-purple-900 mb-2\">New Connections:</h4>\r\n                                        <ul className=\"space-y-1\">\r\n                                            {analysis.reconfiguration.new_connections.map((conn, idx) => (\r\n                                                <li key={idx} className=\"text-sm text-slate-700 flex items-start gap-2\">\r\n                                                    <span className=\"text-purple-500 mt-1\">â†’</span>\r\n                                                    <span>{conn}</span>\r\n                                                </li>\r\n                                            ))}\r\n                                        </ul>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {analysis.reconfiguration.lines_of_flight && (\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-sm text-purple-900 mb-2\">Lines of Flight:</h4>\r\n                                        <ul className=\"space-y-1\">\r\n                                            {analysis.reconfiguration.lines_of_flight.map((line, idx) => (\r\n                                                <li key={idx} className=\"text-sm text-slate-700 flex items-start gap-2\">\r\n                                                    <span className=\"text-purple-500 mt-1\">â†—</span>\r\n                                                    <span>{line}</span>\r\n                                                </li>\r\n                                            ))}\r\n                                        </ul>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"pt-4 border-t border-purple-100\">\r\n                                    <h4 className=\"font-semibold text-sm text-purple-900 mb-2\">Theoretical Contribution:</h4>\r\n                                    <p className=\"text-sm text-slate-800 leading-relaxed bg-white p-3 rounded border border-purple-100\">\r\n                                        {analysis.reconfiguration.theoretical_contribution}\r\n                                    </p>\r\n                                </div>\r\n\r\n                                {analysis.reconfiguration.empirical_evidence && (\r\n                                    <div>\r\n                                        <h4 className=\"font-semibold text-sm text-purple-900 mb-2\">Empirical Evidence:</h4>\r\n                                        <blockquote className=\"text-xs text-slate-600 italic pl-3 border-l-2 border-purple-200\">\r\n                                            {analysis.reconfiguration.empirical_evidence}\r\n                                        </blockquote>\r\n                                    </div>\r\n                                )}\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n\r\n                    {/* Re-analyze button */}\r\n                    <div className=\"flex justify-center\">\r\n                        <Button variant=\"outline\" onClick={handleAnalyze} disabled={isAnalyzing}>\r\n                            {isAnalyzing ? (\r\n                                <>\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                    Re-analyzing...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Sparkles className=\"mr-2 h-4 w-4\" />\r\n                                    Re-run Analysis\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\DiscoveryDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\ReconfigurationTracker.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":134,"column":29,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6855,6886],"text":"\r\n                            &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6855,6886],"text":"\r\n                            &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6855,6886],"text":"\r\n                            &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6855,6886],"text":"\r\n                            &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":134,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6915,6942],"text":"&quot;\r\n                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6915,6942],"text":"&ldquo;\r\n                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6915,6942],"text":"&#34;\r\n                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6915,6942],"text":"&rdquo;\r\n                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { ResistanceArtifact, ReconfigurationAnalysis } from \"@/types/resistance\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { ArrowRight, Network } from \"lucide-react\";\r\n\r\ninterface ReconfigurationTrackerProps {\r\n    artifact: ResistanceArtifact;\r\n    targetPolicyTitle?: string;\r\n}\r\n\r\nexport function ReconfigurationTracker({ artifact, targetPolicyTitle }: ReconfigurationTrackerProps) {\r\n    const reconfig = artifact.reconfiguration_potential;\r\n\r\n    if (!reconfig) {\r\n        return null;\r\n    }\r\n\r\n    return (\r\n        <Card className=\"border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-white\">\r\n            <CardHeader className=\"bg-purple-100/50\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Network className=\"h-5 w-5 text-purple-600\" />\r\n                    <CardTitle>Assemblage Reconfiguration Dynamics</CardTitle>\r\n                </div>\r\n                {targetPolicyTitle && (\r\n                    <p className=\"text-sm text-slate-600 mt-2\">\r\n                        Target: <span className=\"font-semibold\">{targetPolicyTitle}</span>\r\n                    </p>\r\n                )}\r\n            </CardHeader>\r\n            <CardContent className=\"pt-6\">\r\n                {/* Three-Stage Flow */}\r\n                <div className=\"grid md:grid-cols-3 gap-4 mb-6\">\r\n                    {/* Before State */}\r\n                    <div className=\"space-y-2\">\r\n                        <Badge className=\"bg-slate-200 text-slate-800\">Before</Badge>\r\n                        <div className=\"p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[120px]\">\r\n                            <p className=\"text-xs font-semibold text-slate-500 uppercase mb-2\">\r\n                                Original Configuration\r\n                            </p>\r\n                            <p className=\"text-sm text-slate-700\">\r\n                                {getBeforeState(reconfig)}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Arrow */}\r\n                    <div className=\"hidden md:flex items-center justify-center\">\r\n                        <ArrowRight className=\"h-8 w-8 text-purple-400\" />\r\n                    </div>\r\n\r\n                    {/* After State */}\r\n                    <div className=\"space-y-2\">\r\n                        <Badge className=\"bg-purple-200 text-purple-800\">After</Badge>\r\n                        <div className=\"p-4 bg-purple-50 rounded-lg border border-purple-200 min-h-[120px]\">\r\n                            <p className=\"text-xs font-semibold text-purple-600 uppercase mb-2\">\r\n                                Proposed Reconfiguration\r\n                            </p>\r\n                            <p className=\"text-sm text-slate-700\">\r\n                                {reconfig.recodes}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Intervention */}\r\n                <div className=\"mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded\">\r\n                    <p className=\"text-xs font-semibold text-yellow-800 uppercase mb-2\">\r\n                        Resistance Intervention\r\n                    </p>\r\n                    <p className=\"text-sm text-slate-700\">\r\n                        <strong>{artifact.title}</strong> deterritorializes: {reconfig.deterritorializes}\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Dynamics Grid */}\r\n                <div className=\"grid md:grid-cols-2 gap-4 mb-6\">\r\n                    {/* New Connections */}\r\n                    {reconfig.new_connections && reconfig.new_connections.length > 0 && (\r\n                        <div className=\"p-4 bg-blue-50 rounded-lg border border-blue-200\">\r\n                            <h4 className=\"text-sm font-bold text-blue-900 mb-3 flex items-center gap-2\">\r\n                                <span className=\"text-blue-500\">âš¡</span>\r\n                                New Connections Enabled\r\n                            </h4>\r\n                            <ul className=\"space-y-2\">\r\n                                {reconfig.new_connections.map((conn, idx) => (\r\n                                    <li key={idx} className=\"text-xs text-slate-700 flex items-start gap-2\">\r\n                                        <span className=\"text-blue-500 mt-0.5\">â†’</span>\r\n                                        <span>{conn}</span>\r\n                                    </li>\r\n                                ))}\r\n                            </ul>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Lines of Flight */}\r\n                    {reconfig.lines_of_flight && reconfig.lines_of_flight.length > 0 && (\r\n                        <div className=\"p-4 bg-green-50 rounded-lg border border-green-200\">\r\n                            <h4 className=\"text-sm font-bold text-green-900 mb-3 flex items-center gap-2\">\r\n                                <span className=\"text-green-500\">â†—</span>\r\n                                Lines of Flight (Escape Routes)\r\n                            </h4>\r\n                            <ul className=\"space-y-2\">\r\n                                {reconfig.lines_of_flight.map((line, idx) => (\r\n                                    <li key={idx} className=\"text-xs text-slate-700 flex items-start gap-2\">\r\n                                        <span className=\"text-green-500 mt-0.5\">â†—</span>\r\n                                        <span>{line}</span>\r\n                                    </li>\r\n                                ))}\r\n                            </ul>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Theoretical Insight */}\r\n                <div className=\"p-5 bg-white rounded-lg border-2 border-purple-200 shadow-sm\">\r\n                    <h4 className=\"text-sm font-bold text-purple-900 mb-3 flex items-center gap-2\">\r\n                        ðŸ’¡ Theoretical Contribution\r\n                    </h4>\r\n                    <p className=\"text-sm text-slate-800 leading-relaxed\">\r\n                        {reconfig.theoretical_contribution}\r\n                    </p>\r\n                </div>\r\n\r\n                {/* Empirical Grounding */}\r\n                {reconfig.empirical_evidence && (\r\n                    <div className=\"mt-4 p-4 bg-slate-50 rounded border border-slate-200\">\r\n                        <h4 className=\"text-xs font-semibold text-slate-600 uppercase mb-2\">\r\n                            Empirical Evidence\r\n                        </h4>\r\n                        <blockquote className=\"text-xs text-slate-700 italic border-l-2 border-slate-300 pl-3\">\r\n                            \"{reconfig.empirical_evidence}\"\r\n                        </blockquote>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n\r\n// Helper to infer \"before state\" from deterritorialization\r\nfunction getBeforeState(reconfig: ReconfigurationAnalysis): string {\r\n    // Extract what was being deterritorialized as the \"before\" state\r\n    return reconfig.deterritorializes;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\ResistanceArtifactView.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[746,749],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[746,749],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { ResistanceArtifact } from \"@/types/resistance\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { ArrowLeft, FileText, Calendar, User } from \"lucide-react\";\r\nimport { DiscourseAnalyzer } from \"./DiscourseAnalyzer\";\r\nimport { ReconfigurationTracker } from \"./ReconfigurationTracker\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\n\r\ninterface ResistanceArtifactViewProps {\r\n    artifact: ResistanceArtifact;\r\n    onBack: () => void;\r\n    onUpdate?: (updatedArtifact: ResistanceArtifact) => void;\r\n}\r\n\r\nexport function ResistanceArtifactView({ artifact, onBack, onUpdate }: ResistanceArtifactViewProps) {\r\n    const handleAnalysisComplete = (analysis: any) => {\r\n        const updatedArtifact = {\r\n            ...artifact,\r\n            frames: analysis.frames,\r\n            rhetorical_strategies: analysis.strategies,\r\n            reconfiguration_potential: analysis.reconfiguration\r\n        };\r\n        onUpdate?.(updatedArtifact);\r\n    };\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <Button variant=\"ghost\" className=\"mb-2\" onClick={onBack}>\r\n                <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                Back to Repository\r\n            </Button>\r\n\r\n            {/* Header */}\r\n            <div className=\"space-y-4\">\r\n                <div className=\"flex items-start justify-between\">\r\n                    <div>\r\n                        <h2 className=\"text-3xl font-bold text-slate-900\">{artifact.title}</h2>\r\n                        <div className=\"flex items-center gap-4 text-slate-500 mt-2\">\r\n                            <span className=\"flex items-center gap-1\">\r\n                                <User className=\"h-4 w-4\" />\r\n                                {artifact.source}\r\n                            </span>\r\n                            <span className=\"flex items-center gap-1\">\r\n                                <Calendar className=\"h-4 w-4\" />\r\n                                {new Date(artifact.date).toLocaleDateString()}\r\n                            </span>\r\n                            <Badge variant=\"secondary\" className=\"bg-slate-100 text-slate-700\">\r\n                                {artifact.type.replace('_', ' ')}\r\n                            </Badge>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Target Context */}\r\n                {(artifact.target_policy || artifact.target_components.length > 0) && (\r\n                    <div className=\"bg-blue-50/50 p-4 rounded-lg border border-blue-100\">\r\n                        <p className=\"text-sm font-medium text-slate-700 mb-2\">Assemblage Context:</p>\r\n                        <div className=\"flex flex-wrap gap-2\">\r\n                            {artifact.target_policy && (\r\n                                <Badge variant=\"outline\" className=\"border-blue-200 text-blue-700 bg-white\">\r\n                                    Target: {artifact.target_policy}\r\n                                </Badge>\r\n                            )}\r\n                            {artifact.target_components.map((comp, idx) => (\r\n                                <Badge key={idx} variant=\"outline\" className=\"border-slate-200 text-slate-600 bg-white\">\r\n                                    {comp}\r\n                                </Badge>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Content Tabs/Sections */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* Left Column: Text & Context */}\r\n                <div className=\"lg:col-span-1 space-y-6\">\r\n                    <Card>\r\n                        <CardContent className=\"pt-6\">\r\n                            <h3 className=\"font-semibold text-lg mb-4 flex items-center gap-2\">\r\n                                <FileText className=\"h-5 w-5 text-slate-400\" />\r\n                                Artifact Text\r\n                            </h3>\r\n                            <div className=\"prose prose-sm max-w-none max-h-[600px] overflow-y-auto bg-slate-50 p-4 rounded-md border border-slate-100 font-mono text-xs leading-relaxed whitespace-pre-wrap\">\r\n                                {artifact.text}\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {artifact.notes && (\r\n                        <Card>\r\n                            <CardContent className=\"pt-6\">\r\n                                <h3 className=\"font-semibold text-lg mb-4\">Field Notes</h3>\r\n                                <p className=\"text-sm text-slate-700 whitespace-pre-wrap\">\r\n                                    {artifact.notes}\r\n                                </p>\r\n                            </CardContent>\r\n                        </Card>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Right Column: Analysis */}\r\n                <div className=\"lg:col-span-2 space-y-8\">\r\n                    {/* Reconfiguration Tracker (Top Priority) */}\r\n                    <section>\r\n                        <ReconfigurationTracker\r\n                            artifact={artifact}\r\n                            targetPolicyTitle={artifact.target_policy} // Pass title if we have it, ID for now\r\n                        />\r\n                    </section>\r\n\r\n                    {/* Discourse Analysis Tools */}\r\n                    <section>\r\n                        <DiscourseAnalyzer\r\n                            artifact={artifact}\r\n                            onAnalysisComplete={handleAnalysisComplete}\r\n                        />\r\n                    </section>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\resistance\\UploadArtifactDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\input.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":5,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":5,"endColumn":28,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[77,158],"text":"type InputProps = React.InputHTMLAttributes<HTMLInputElement>"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport interface InputProps\r\n    extends React.InputHTMLAttributes<HTMLInputElement> { }\r\n\r\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\r\n    ({ className, type, ...props }, ref) => {\r\n        return (\r\n            <input\r\n                type={type}\r\n                className={cn(\r\n                    \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n                    className\r\n                )}\r\n                ref={ref}\r\n                {...props}\r\n            />\r\n        )\r\n    }\r\n)\r\nInput.displayName = \"Input\"\r\n\r\nexport { Input }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\mode-selector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\provisional-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\textarea.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":5,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":5,"endColumn":31,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[77,167],"text":"type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport interface TextareaProps\r\n    extends React.TextareaHTMLAttributes<HTMLTextAreaElement> { }\r\n\r\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\r\n    ({ className, ...props }, ref) => {\r\n        return (\r\n            <textarea\r\n                className={cn(\r\n                    \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n                    className\r\n                )}\r\n                ref={ref}\r\n                {...props}\r\n            />\r\n        )\r\n    }\r\n)\r\nTextarea.displayName = \"Textarea\"\r\n\r\nexport { Textarea }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\hooks\\useForceGraph.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'configurations', 'links', and 'nodes'. Either include them or remove the dependency array. You can also do a functional update 'setNodes(n => ...)' if you only need 'nodes' in the 'setNodes' call.","line":163,"column":8,"nodeType":"ArrayExpression","endLine":163,"endColumn":102,"suggestions":[{"desc":"Update the dependencies array to be: [nodes.length, links.length, width, height, configurations.length, enableClustering, isPaused, nodes, links, configurations]","fix":{"range":[6902,6996],"text":"[nodes.length, links.length, width, height, configurations.length, enableClustering, isPaused, nodes, links, configurations]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7257,7260],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7257,7260],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState } from 'react';\r\nimport * as d3 from 'd3';\r\nimport { EcosystemActor } from '@/types/ecosystem';\r\n\r\nexport interface SimulationNode extends d3.SimulationNodeDatum {\r\n    id: string;\r\n    type: string;\r\n    radius: number;\r\n    x?: number;\r\n    y?: number;\r\n    vx?: number;\r\n    vy?: number;\r\n}\r\n\r\ninterface SimulationLink extends d3.SimulationLinkDatum<SimulationNode> {\r\n    source: string | SimulationNode;\r\n    target: string | SimulationNode;\r\n    type: string;\r\n}\r\n\r\nexport function useForceGraph(\r\n    actors: EcosystemActor[],\r\n    width: number,\r\n    height: number,\r\n    configurations: { id: string; memberIds: string[] }[] = [],\r\n    links: { source: string; target: string; type: string }[] = [],\r\n    enableClustering: boolean = false,\r\n    isPaused: boolean = false,\r\n    configOffsets: Record<string, { x: number; y: number }> = {} // CHANGED: Offsets from default\r\n) {\r\n    const [nodes, setNodes] = useState<SimulationNode[]>([]);\r\n    const simulationRef = useRef<d3.Simulation<SimulationNode, SimulationLink> | null>(null);\r\n    const configOffsetsRef = useRef(configOffsets);\r\n\r\n    // Keep Ref in Sync & Wake up simulation on drag\r\n    useEffect(() => {\r\n        configOffsetsRef.current = configOffsets;\r\n        if (simulationRef.current) {\r\n            simulationRef.current.alphaTarget(0.3).restart();\r\n        }\r\n    }, [configOffsets]);\r\n\r\n    // Initialize Nodes\r\n    useEffect(() => {\r\n        setNodes(prevNodes => {\r\n            const newNodes: SimulationNode[] = actors.map(actor => {\r\n                const existing = prevNodes.find(n => n.id === actor.id);\r\n                return {\r\n                    id: actor.id,\r\n                    type: actor.type,\r\n                    radius: actor.influence === 'High' ? 45 : actor.influence === 'Medium' ? 30 : 20,\r\n                    x: existing ? existing.x : width / 2 + (Math.random() - 0.5) * 50,\r\n                    y: existing ? existing.y : height / 2 + (Math.random() - 0.5) * 50,\r\n                    vx: existing ? existing.vx : 0,\r\n                    vy: existing ? existing.vy : 0\r\n                };\r\n            });\r\n            return newNodes;\r\n        });\r\n    }, [actors, width, height]);\r\n\r\n    // Run Simulation\r\n    useEffect(() => {\r\n        if (!nodes.length || isPaused) {\r\n            simulationRef.current?.stop();\r\n            return;\r\n        }\r\n\r\n        if (simulationRef.current) simulationRef.current.stop();\r\n\r\n        // 1. Initialize Simulation (Base Forces)\r\n        const simulation = d3.forceSimulation(nodes)\r\n            .force(\"collide\", d3.forceCollide().radius((d: d3.SimulationNodeDatum) => (d as SimulationNode).radius + 10).iterations(2));\r\n\r\n        // 2. Configure Layout Specific Forces\r\n        if (enableClustering) {\r\n            // Nested Assemblage Layout (Radial Rings)\r\n            const getRadialRadius = (type: string) => {\r\n                const t = type.toLowerCase();\r\n                const minDim = Math.min(width, height);\r\n                // Center (0) reserved for Policy Object if it exists\r\n                if (t === 'legalobject' || t === 'regulation' || t === 'law') return 0; // Ring 0 (Center)\r\n                if (t === 'policymaker' || t === 'government' || t === 'regulator') return minDim * 0.15; // Ring 1\r\n                if (t === 'civilsociety' || t === 'academic' || t === 'ngo') return minDim * 0.25; // Ring 2\r\n                if (t === 'startup' || t === 'private' || t === 'market' || t === 'corporation') return minDim * 0.35; // Ring 3\r\n                return minDim * 0.45; // Ring 4 (Outer: Infra, Algo, etc)\r\n            };\r\n\r\n            simulation\r\n                .force(\"radial\", d3.forceRadial((d: d3.SimulationNodeDatum) => getRadialRadius((d as SimulationNode).type), width / 2, height / 2).strength(0.8))\r\n                .force(\"charge\", d3.forceManyBody().strength(-300)) // Weaker repulsion for rings\r\n                .force(\"center\", null)\r\n                .force(\"x\", null)\r\n                .force(\"y\", null);\r\n        } else {\r\n            // Standard Force Layout\r\n            simulation\r\n                .force(\"radial\", null)\r\n                .force(\"center\", d3.forceCenter(width / 2, height / 2).strength(0.05))\r\n                .force(\"x\", d3.forceX(width / 2).strength(0.05))\r\n                .force(\"y\", d3.forceY(height / 2).strength(0.05))\r\n                .force(\"charge\", d3.forceManyBody().strength(-800)); // Strong repulsion for spread\r\n        }\r\n\r\n        // 3. Configure Links\r\n        if (links.length > 0) {\r\n            const nodeIds = new Set(nodes.map(n => n.id));\r\n            const validLinks = links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target))\r\n                .map(l => ({ ...l }));\r\n\r\n            if (validLinks.length > 0) {\r\n                // Tighter links in radial mode to keep rings coherent\r\n                simulation.force(\"link\", d3.forceLink(validLinks).id((d: d3.SimulationNodeDatum) => (d as SimulationNode).id).distance(enableClustering ? 100 : 150));\r\n            }\r\n        }\r\n\r\n        // 4. Custom Grouping (Configuration) Force - Radially Separates Macro Groups\r\n        const groupForce = (alpha: number) => {\r\n            configurations.forEach((config, i) => {\r\n                const members = nodes.filter(n => config.memberIds.includes(n.id));\r\n                if (members.length < 1) return;\r\n\r\n                // Calculate a target \"home\" for this configuration based on index\r\n                const totalConfigs = configurations.length;\r\n\r\n                let targetX = width / 2;\r\n                let targetY = height / 2;\r\n\r\n                // Calculate Default Home\r\n                if (totalConfigs > 1) {\r\n                    const radius = Math.min(width, height) * 0.35; // Use 35% of view dimension\r\n                    const angle = (i / totalConfigs) * 2 * Math.PI - (Math.PI / 2); // Start at top\r\n                    targetX = (width / 2) + Math.cos(angle) * radius;\r\n                    targetY = (height / 2) + Math.sin(angle) * radius;\r\n                }\r\n\r\n                // Apply Manual Offsets via Ref (Hot update)\r\n                const currentOffsets = configOffsetsRef.current;\r\n                if (currentOffsets[config.id]) {\r\n                    targetX += currentOffsets[config.id].x;\r\n                    targetY += currentOffsets[config.id].y;\r\n                }\r\n\r\n                members.forEach(d => {\r\n                    d.vx! += (targetX - d.x!) * alpha * 0.15;\r\n                    d.vy! += (targetY - d.y!) * alpha * 0.15;\r\n                });\r\n            });\r\n        };\r\n\r\n        simulation.alphaDecay(0.02);\r\n\r\n        simulation.on(\"tick\", () => {\r\n            groupForce(simulation.alpha());\r\n            setNodes([...nodes]);\r\n        });\r\n\r\n        simulationRef.current = simulation;\r\n\r\n        return () => {\r\n            simulation.stop();\r\n        };\r\n    }, [nodes.length, links.length, width, height, configurations.length, enableClustering, isPaused]); // Removed configOffsets from deps\r\n\r\n    // Custom interface to compatible with both D3 internal events and manual React triggers\r\n    interface GraphDragEvent {\r\n        active?: boolean | number;\r\n        x: number;\r\n        y: number;\r\n        subject?: any;\r\n    }\r\n\r\n    const drag = (node: SimulationNode) => {\r\n        const dragStarted = (event: GraphDragEvent) => {\r\n            if (!event.active) simulationRef.current?.alphaTarget(0.3).restart();\r\n            node.fx = node.x;\r\n            node.fy = node.y;\r\n        };\r\n\r\n        const dragged = (event: GraphDragEvent) => {\r\n            node.fx = event.x;\r\n            node.fy = event.y;\r\n        };\r\n\r\n        const dragEnded = (event: GraphDragEvent) => {\r\n            if (!event.active) simulationRef.current?.alphaTarget(0);\r\n            node.fx = null;\r\n            node.fy = null;\r\n        };\r\n\r\n        return { dragStarted, dragged, dragEnded };\r\n    };\r\n\r\n    return { nodes, simulation: simulationRef.current, drag };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\hooks\\useResistanceArtifacts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\hooks\\useServerStorage.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initialValue'. Either include it or remove the dependency array. If 'setStoredValue' needs the current value of 'initialValue', you can also switch to useReducer instead of useState and read 'initialValue' in the reducer.","line":45,"column":8,"nodeType":"ArrayExpression","endLine":45,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [initialValue, key]","fix":{"range":[1719,1724],"text":"[initialValue, key]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\n\r\nexport function useServerStorage<T>(key: string, initialValue: T): [T, (value: T | ((val: T) => T)) => void, boolean] {\r\n    const [storedValue, setStoredValue] = useState<T>(initialValue);\r\n    const [isLoading, setIsLoading] = useState(true);\r\n\r\n    // Fetch initial value from server\r\n    useEffect(() => {\r\n        let isMounted = true;\r\n\r\n        const fetchValue = async () => {\r\n            try {\r\n                const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n                // Send demo user ID if configured (relaxed check to match EcosystemPage)\r\n                if (process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                    headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n                }\r\n\r\n                const response = await fetch(`/api/storage?key=${encodeURIComponent(key)}`, {\r\n                    headers: headers\r\n                });\r\n\r\n                if (response.ok) {\r\n                    const data = await response.json();\r\n                    if (isMounted) {\r\n                        setStoredValue(data.value ?? initialValue);\r\n                    }\r\n                } else {\r\n                    console.warn(`[useServerStorage] Failed to fetch ${key}: ${response.status} ${response.statusText}`);\r\n                }\r\n            } catch (error) {\r\n                console.error(`Failed to fetch storage key \"${key}\":`, error);\r\n            } finally {\r\n                if (isMounted) {\r\n                    setIsLoading(false);\r\n                }\r\n            }\r\n        };\r\n\r\n        fetchValue();\r\n\r\n        return () => {\r\n            isMounted = false;\r\n        };\r\n    }, [key]);\r\n\r\n    // Return a wrapped version of useState's setter function that ...\r\n    // ... persists the new value to the server.\r\n    const setValue = useCallback((value: T | ((val: T) => T)) => {\r\n        try {\r\n            // Allow value to be a function so we have same API as useState\r\n            setStoredValue((prevValue) => {\r\n                const valueToStore = value instanceof Function ? value(prevValue) : value;\r\n\r\n                // Save to server\r\n                const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n                if (process.env.NEXT_PUBLIC_DEMO_USER_ID) {\r\n                    headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID;\r\n                }\r\n\r\n                fetch('/api/storage', {\r\n                    method: 'POST',\r\n                    headers: headers,\r\n                    body: JSON.stringify({ key, value: valueToStore }),\r\n                }).catch(err => console.error(`Failed to save storage key \"${key}\":`, err));\r\n\r\n                return valueToStore;\r\n            });\r\n        } catch (error) {\r\n            console.error(`Error setting value for key \"${key}\":`, error);\r\n        }\r\n    }, [key]);\r\n\r\n    return [storedValue, setValue, isLoading];\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\hooks\\useSources.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\hooks\\useWebDiscovery.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis-parser.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":5,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[178,181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[178,181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[293,296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[293,296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[318,321],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[318,321],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis-prompts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis-service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PromptRegistry' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'StorageService' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'verifyQuotes' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'runCritiqueLoop' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sourceType' is assigned a value but never used.","line":95,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'lens' is assigned a value but never used.","line":95,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":64}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[896,899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[896,899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[992,995],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[992,995],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1088,1091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1088,1091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1186,1189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1186,1189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4331,4334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4331,4334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5557,5560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5557,5560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PromptRegistry } from '@/lib/prompts/registry';\r\nimport { strategies } from './analysis-strategies';\r\nimport crypto from 'crypto';\r\nimport OpenAI from 'openai';\r\nimport { StorageService } from '@/lib/storage-service';\r\nimport { verifyQuotes } from '@/lib/analysis-utils';\r\nimport { PositionalityData } from '@/types';\r\nimport { parseAnalysisResponse } from '@/lib/analysis-parser';\r\nimport { runStressTest } from '@/lib/analysis/stress-test-service';\r\nimport { runCritiqueLoop } from '@/lib/analysis/critique-service';\r\n\r\nexport interface AnalysisConfig {\r\n    systemPrompt: string;\r\n    userContent: string;\r\n}\r\n\r\nexport async function getAnalysisConfig(\r\n    userId: string,\r\n    analysisMode: string,\r\n    data: {\r\n        text?: string;\r\n        title?: string;\r\n        sourceType?: string;\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        sourceA?: any;\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        sourceB?: any;\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        sourceC?: any;\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        documents?: any[];\r\n        lens?: string;\r\n    }\r\n): Promise<AnalysisConfig> {\r\n    const safeUserId = userId || 'default';\r\n\r\n    // Select strategy or fallback to default\r\n    const strategy = strategies[analysisMode] || strategies.default;\r\n\r\n    return strategy(safeUserId, data);\r\n}\r\n\r\n// =================================================================================================\r\n// EXTRACTED ANALYSIS LOGIC\r\n// =================================================================================================\r\n\r\nexport function generateCacheKey(mode: string, text: string, sourceType: string, version: string = 'v20'): string {\r\n    const hash = crypto.createHash('sha256').update(text).digest('hex');\r\n    return `analysis:${mode}:${sourceType}:${version}:${hash}`;\r\n}\r\n\r\nexport function generateCalibrationContext(positionality: string | PositionalityData | undefined): string {\r\n    if (!positionality) return \"\";\r\n\r\n    if (typeof positionality === 'object') {\r\n        const { locus, discipline, reflexiveGap, enableCounterNarrative } = positionality as PositionalityData;\r\n\r\n        return `\r\n### *** DYNAMIC POSITIONALITY OVERLAY ***\r\n** USER CONTEXT:** The human analyst identifies as ** ${locus}** with a ** ${discipline}** lens.\r\n** RISK FACTOR:** They have flagged a potential blind spot regarding ** ${reflexiveGap}**.\r\n\r\n### YOUR PRIME DIRECTIVES(CALIBRATED):\r\n1. ** COUNTER - BIAS PROTOCOL:**\r\n  ${locus.includes('Global North') ? `Because the analyst is from the Global North, you must NOT accept standard Western legal definitions of \"privacy\" or \"ownership\" as default.\r\n    * *Action:* If the text mentions \"Data Ownership,\" immediately query: \"Does this imply individual property (Western) or sovereign stewardship (Indigenous)?\"` : ''}\r\n    ${discipline.includes('Legal') ? `Because the analyst uses a Legal lens, you must explicitly highlight technical or sociological implications they might miss.` : ''}\r\n\r\n2. ** BLIND SPOT WATCHDOG:**\r\n  The analyst fears missing ** ${reflexiveGap}**.\r\n    * * Action:* Scan the document specifically for concepts related to this gap.If these terms are absent, flag a \"Critical Silence\".\r\n\r\n3. ** ADVERSARIAL SUMMARY:**\r\n  ${enableCounterNarrative ? `After your standard summary, you must generate a \"Counter-Narrative\" written from the perspective of the most marginalized actors identified (or silenced) in the text, critiquing the policy's reliance on dominant standards.` : ''}\r\n`;\r\n    } else if (typeof positionality === 'string') {\r\n        return `\r\n        *** ANALYST POSITIONALITY STATEMENT ***\r\n          The analyst has provided the following positionality statement: \"${positionality}\"\r\n      INSTRUCTION: Use this statement to contextualize your analysis.Flag any concepts in the text that might conflict with or be invisible to this specific worldview.\r\n`;\r\n    }\r\n    return \"\";\r\n}\r\n\r\n/**\r\n * Orchestrates the full analysis workflow: Config -> AI Call -> Parsing -> Stress Test -> Verification\r\n */\r\nexport async function performAnalysis(\r\n    openai: OpenAI,\r\n    userId: string,\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    requestData: any\r\n) {\r\n    const { text, sourceType, analysisMode, positionality, lens } = requestData;\r\n\r\n    // Config\r\n    const config = await getAnalysisConfig(userId, analysisMode, requestData);\r\n    let { systemPrompt } = config;\r\n    const { userContent } = config;\r\n\r\n    // Calibration\r\n    if (['dsf', 'cultural_framing', 'institutional_logics', 'legitimacy'].includes(analysisMode || 'dsf')) {\r\n        systemPrompt += generateCalibrationContext(positionality);\r\n    }\r\n\r\n    console.log(`[ANALYSIS] Calling OpenAI for mode: ${analysisMode} `);\r\n    const aiStartTime = Date.now();\r\n\r\n    // AI Call\r\n    const completion = await openai.chat.completions.create({\r\n        model: process.env.OPENAI_MODEL || \"gpt-4o\",\r\n        messages: [\r\n            { role: 'system', content: systemPrompt },\r\n            { role: 'user', content: userContent }\r\n        ],\r\n        max_completion_tokens: 16384,\r\n        response_format: { type: \"json_object\" }\r\n    });\r\n    console.log(`[ANALYSIS] OpenAI response received in ${Date.now() - aiStartTime} ms`);\r\n\r\n    const responseText = completion.choices[0]?.message?.content || '';\r\n\r\n    // Parsing\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let analysis: any = parseAnalysisResponse(responseText, analysisMode);\r\n\r\n    // Stress Test\r\n    if (analysisMode === 'stress_test') {\r\n        analysis = await runStressTest(openai, userId, text, analysis, requestData.existingAnalysis);\r\n    }\r\n\r\n    // Return analysis result with usage stats\r\n    return {\r\n        analysis,\r\n        usage: completion.usage\r\n    };\r\n}\r\n\r\nexport { runStressTest } from '@/lib/analysis/stress-test-service';\r\nexport { runCritiqueLoop } from '@/lib/analysis/critique-service';\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis-strategies.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2202,2205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2202,2205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7894,7897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7894,7897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":196,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7996,7999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7996,7999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":204,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8442,8445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8442,8445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PromptRegistry } from '@/lib/prompts/registry';\r\n\r\ntype StrategyResult = { systemPrompt: string; userContent: string };\r\n\r\nconst getLensInstruction = (lensType: string) => {\r\n    switch (lensType) {\r\n        case 'market':\r\n            return `\\n\\n*** INTERPRETATION LENS: MARKET / ACCELERATIONIST ***\r\n    Analyze this through the lens of market efficiency, innovation, and capital flow.\r\n    - Highlight friction points that impede rapid deployment or scaling.\r\n    - Frame \"Risks\" as potential liability costs or market barriers.\r\n    - Identify opportunities for regulatory arbitrage or competitive advantage.\r\n    - Tone: Pragmatic, economic, efficiency-oriented.`;\r\n        case 'democratic':\r\n            return `\\n\\n*** INTERPRETATION LENS: PRECARIOUS / DEMOCRATIC ***\r\n    Analyze this through the lens of democratic oversight, labor rights, and vulnerability.\r\n    - Highlight where \"efficiency\" masks exploitation or disenfranchisement.\r\n    - Focus on the rights of workers, gig laborers, and marginalized groups.\r\n    - Critique \"technocratic\" solutions that lack public accountability.\r\n    - Tone: Critical, rights-focused, solidarity-oriented.`;\r\n        case 'decolonial':\r\n            return `\\n\\n*** INTERPRETATION LENS: DECOLONIAL / SOVEREIGNTY ***\r\n    Analyze this through the lens of power asymmetries, data extractivism, and digital sovereignty.\r\n    - Highlight \"universalist\" claims that mask Western normative imposition.\r\n    - Focus on data extraction from the Global South vs. value capture in the Global North.\r\n    - Identify mechanisms of \"digital colonialism\" or \"legal transplants\".\r\n    - Tone: Structural, historical, resistance-oriented.`;\r\n        case 'assemblage':\r\n        default:\r\n            return `\\n\\n*** INTERPRETATION LENS: RELATIONAL ASSEMBLAGE (DEFAULT) ***\r\n    Analyze this through the lens of Actor-Network Theory and assemblage thinking.\r\n    - Focus on the relations between human and non-human actors (institutions, code, markets).\r\n    - Map the \"translations\" and \"mutations\" of concepts as they travel.\r\n    - Tone: Analytical, descriptive, relational.`;\r\n    }\r\n};\r\n\r\nexport const strategies: Record<string, (userId: string, data: any) => Promise<StrategyResult>> = {\r\n    comparison: async (userId, { sourceA, sourceB }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'comparison_framework'),\r\n        userContent: `SOURCE A(${sourceA.title}):\r\n${sourceA.text}\r\n\r\nSOURCE B(${sourceB.title}):\r\n${sourceB.text}\r\n\r\nPlease compare these sources according to the system prompt instructions.`\r\n    }),\r\n\r\n    ecosystem: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'ecosystem_analysis'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease map the ecosystem impacts of this text according to the system prompt instructions.`\r\n    }),\r\n\r\n    resistance: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'resistance_analysis'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease analyze this text according to the system prompt instructions.`\r\n    }),\r\n\r\n    generate_resistance: async (userId, { text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'resistance_generation'),\r\n        userContent: `POLICY DOCUMENT TEXT:\r\n${text}\r\n\r\nPlease generate 3 synthetic resistance traces based on this policy.`\r\n    }),\r\n\r\n    ontology: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'ontology_extraction'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease extract the ontology / concept map from this text.`\r\n    }),\r\n\r\n    ontology_comparison: async (userId, { sourceA, sourceB, sourceC }) => {\r\n        const systemPrompt = await PromptRegistry.getEffectivePrompt(userId, 'ontology_comparison');\r\n        let comparisonContent = `ONTOLOGY A(${sourceA.title}):\r\n${JSON.stringify(sourceA.data, null, 2)}\r\n\r\nONTOLOGY B(${sourceB.title}):\r\n${JSON.stringify(sourceB.data, null, 2)}`;\r\n\r\n        if (sourceC) {\r\n            comparisonContent += `\r\n\r\nONTOLOGY C(${sourceC.title}):\r\n${JSON.stringify(sourceC.data, null, 2)}`;\r\n        }\r\n\r\n        return {\r\n            systemPrompt,\r\n            userContent: `${comparisonContent}\r\n\r\nPlease compare these ${sourceC ? 'three' : 'two'} ontologies according to the system prompt instructions.`\r\n        };\r\n    },\r\n\r\n    cultural_framing: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'cultural_framing'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease analyze the cultural framing of this text according to the system prompt instructions.`\r\n    }),\r\n\r\n    institutional_logics: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'institutional_logics'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease analyze the institutional logics in this text according to the system prompt instructions.`\r\n    }),\r\n\r\n    legitimacy: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'legitimacy_analysis'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease analyze the legitimacy and justification orders in this text.`\r\n    }),\r\n\r\n    comparative_synthesis: async (userId, { documents, lens = 'assemblage' }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'comparative_synthesis'),\r\n        userContent: `DOCUMENTS TO SYNTHESIZE:\r\n${JSON.stringify(documents, null, 2)}\r\n\r\nPlease synthesize the analysis results for these documents.${getLensInstruction(lens)}`\r\n    }),\r\n\r\n    cultural_holes: async (userId, { sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'cultural_holes'),\r\n        userContent: `SOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease identify cultural holes in this text.`\r\n    }),\r\n\r\n    assemblage_extraction_v3: async (userId, { text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'assemblage_extraction_v3'),\r\n        userContent: `TEXT CONTENT:\r\n${text}\r\n\r\nPlease extract the assemblage from this text.`\r\n    }),\r\n\r\n    resistance_synthesis: async (userId, { documents }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'resistance_synthesis'),\r\n        userContent: `ANALYZED TRACES TO SYNTHESIZE:\r\n${JSON.stringify(documents, null, 2)}\r\n\r\nPlease synthesize these resistance findings according to the system prompt instructions.`\r\n    }),\r\n\r\n    stress_test: async (userId, { text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'stress_test'),\r\n        userContent: text || ''\r\n    }),\r\n\r\n    assemblage_explanation: async (userId, { configurations }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'assemblage_explanation'),\r\n        userContent: `ANALYSIS TARGET: Hull Metrics Integration\r\n\r\nHere are the calculated Assemblage Metrics for the current ecosystem map:\r\n${JSON.stringify(configurations, null, 2)}\r\n\r\nPlease interpret these \"Stability\" (Density) and \"Porosity\" (External Connectivity) scores.`\r\n    }),\r\n\r\n    ant_trace: async (userId, { actors, links }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'ant_trace_explanation'),\r\n        userContent: `TRACED ACTORS:\r\n${JSON.stringify(actors.map((a: any) => ({ name: a.name, type: a.type })), null, 2)}\r\n\r\nASSOCIATIONS:\r\n${JSON.stringify(links.map((l: any) => ({ source: l.source, target: l.target, type: l.type })), null, 2)}\r\n\r\nPlease provide a methodological trace of this network.`\r\n    }),\r\n\r\n    assemblage_realist: async (userId, { traced_actors, detected_mechanisms, identified_capacities }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'assemblage_realist_explanation'),\r\n        userContent: `ASSEMBLAGE COMPONENTS:\r\n${JSON.stringify(traced_actors.map((a: any) => a.name), null, 2)}\r\n\r\nDETECTED MECHANISMS (Territorialization/Coding):\r\n${JSON.stringify(detected_mechanisms, null, 2)}\r\n\r\nIDENTIFIED CAPACITIES:\r\n${JSON.stringify(identified_capacities, null, 2)}\r\n\r\nPlease interpret the ontological status of this assemblage.`\r\n    }),\r\n\r\n    hybrid_reflexive: async (userId, { ant_trace, assemblage_analysis, tensions }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'hybrid_reflexive_explanation'),\r\n        userContent: `ANT TRACE DATA:\r\nActor Count: ${ant_trace.actor_count}\r\n\r\nASSEMBLAGE MECHANISMS:\r\n${JSON.stringify(assemblage_analysis, null, 2)}\r\n\r\nTHEORETICAL TENSIONS:\r\n${JSON.stringify(tensions, null, 2)}\r\n\r\nPlease synthesize these findings and discuss the reflexivity of the analysis.`\r\n    }),\r\n\r\n    default: async (userId, { title, sourceType, text }) => ({\r\n        systemPrompt: await PromptRegistry.getEffectivePrompt(userId, 'dsf_lens'),\r\n        userContent: `DOCUMENT TITLE: ${title || 'Untitled Document'}\r\nSOURCE TYPE: ${sourceType || 'Policy Document'}\r\n\r\nTEXT CONTENT:\r\n${text}\r\n\r\nPlease analyze this text using the Decolonial Situatedness Framework (DSF) as described in the system prompt.`\r\n    })\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis\\critique-service.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[262,265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[262,265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\analysis\\stress-test-service.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[319,322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[319,322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":123,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":126,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[342,345],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[342,345],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[681,684],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[681,684],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\ant-trace-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\api-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\assemblage-mechanism-service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MechanismType' is defined but never used.","line":1,"column":64,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":77}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AssemblageMechanism, AssemblageCapacity, HullMetrics, MechanismType } from '@/types/assemblage-realist';\r\nimport { TracedActor, Association } from '@/types/ant';\r\nimport { EcosystemConfiguration } from '@/types/ecosystem';\r\n\r\n/**\r\n * Assemblage Mechanism Service\r\n * Implements DeLanda's Assemblage Theory as ONTOLOGICAL layer\r\n * \r\n * Key Principle: Provides explanatory mechanisms grounded in ANT traces\r\n */\r\nexport class AssemblageMechanismService {\r\n    /**\r\n     * Detect territorialization mechanisms from traced network\r\n     */\r\n    static detectTerritorialization(\r\n        actors: TracedActor[],\r\n        associations: Association[],\r\n        configurations: EcosystemConfiguration[]\r\n    ): AssemblageMechanism[] {\r\n        const mechanisms: AssemblageMechanism[] = [];\r\n\r\n        configurations.forEach(config => {\r\n            const memberActors = actors.filter(a => config.memberIds.includes(a.id));\r\n            const internalLinks = associations.filter(\r\n                a => config.memberIds.includes(a.source) && config.memberIds.includes(a.target)\r\n            );\r\n\r\n            const intensity = config.properties.calculated_stability || 0.5;\r\n\r\n            mechanisms.push({\r\n                type: \"territorialization\",\r\n                intensity,\r\n                evidence: memberActors,\r\n                explanation: `Configuration \"${config.name}\" exhibits ${this.intensityLabel(intensity)} territorialization through ${internalLinks.length} internal associations among ${memberActors.length} actors. This boundary-making process stabilizes the assemblage.`,\r\n                confidence: 0.75\r\n            });\r\n        });\r\n\r\n        return mechanisms;\r\n    }\r\n\r\n    /**\r\n     * Detect deterritorialization mechanisms\r\n     */\r\n    static detectDeterritorialization(\r\n        actors: TracedActor[],\r\n        associations: Association[]\r\n    ): AssemblageMechanism[] {\r\n        const mechanisms: AssemblageMechanism[] = [];\r\n\r\n        // Look for actors with high external connectivity (lines of flight)\r\n        actors.forEach(actor => {\r\n            const externalLinks = associations.filter(\r\n                a => (a.source === actor.id || a.target === actor.id)\r\n            );\r\n\r\n            if (externalLinks.length > 5) { // Threshold for deterritorialization\r\n                mechanisms.push({\r\n                    type: \"deterritorialization\",\r\n                    intensity: Math.min(externalLinks.length / 10, 1),\r\n                    evidence: [actor],\r\n                    explanation: `Actor \"${actor.name}\" shows deterritorialization through ${externalLinks.length} cross-boundary connections, creating lines of flight that destabilize territorial boundaries.`,\r\n                    confidence: 0.7\r\n                });\r\n            }\r\n        });\r\n\r\n        return mechanisms;\r\n    }\r\n\r\n    /**\r\n     * Identify assemblage capacities (what it can/cannot do)\r\n     */\r\n    static identifyCapacities(\r\n        actors: TracedActor[],\r\n        associations: Association[]\r\n    ): AssemblageCapacity[] {\r\n        const capacities: AssemblageCapacity[] = [];\r\n\r\n        // Enforcement capacity\r\n        const policymakers = actors.filter(a => a.type === \"Policymaker\");\r\n        const regulatoryLinks = associations.filter(a => a.relation_type === \"Regulates\");\r\n\r\n        if (policymakers.length > 0 && regulatoryLinks.length > 0) {\r\n            capacities.push({\r\n                name: \"Enforcement Capacity\",\r\n                description: \"Ability to enforce regulatory compliance through legal mechanisms\",\r\n                enabled_by: policymakers.map(p => p.id),\r\n                blocked_by: [],\r\n                actual: true,\r\n                potential: true,\r\n                evidence: `${policymakers.length} policymaker(s) with ${regulatoryLinks.length} regulatory link(s)`\r\n            });\r\n        }\r\n\r\n        // Deliberation capacity\r\n        const civilSociety = actors.filter(a => a.type === \"Civil Society\");\r\n        const academics = actors.filter(a => a.type === \"Academic\");\r\n\r\n        if (civilSociety.length > 0 || academics.length > 0) {\r\n            capacities.push({\r\n                name: \"Deliberation Capacity\",\r\n                description: \"Ability to engage in multi-stakeholder dialogue and knowledge production\",\r\n                enabled_by: [...civilSociety.map(c => c.id), ...academics.map(a => a.id)],\r\n                blocked_by: [],\r\n                actual: civilSociety.length + academics.length > 2,\r\n                potential: true,\r\n                evidence: `${civilSociety.length} civil society + ${academics.length} academic actor(s)`\r\n            });\r\n        }\r\n\r\n        // Innovation capacity\r\n        const startups = actors.filter(a => a.type === \"Startup\");\r\n        const infrastructure = actors.filter(a => a.type === \"Infrastructure\");\r\n\r\n        if (startups.length > 0 && infrastructure.length > 0) {\r\n            capacities.push({\r\n                name: \"Innovation Capacity\",\r\n                description: \"Ability to develop and deploy new technological solutions\",\r\n                enabled_by: [...startups.map(s => s.id), ...infrastructure.map(i => i.id)],\r\n                blocked_by: [],\r\n                actual: true,\r\n                potential: true,\r\n                evidence: `${startups.length} startup(s) with ${infrastructure.length} infrastructure actor(s)`\r\n            });\r\n        }\r\n\r\n        return capacities;\r\n    }\r\n\r\n    /**\r\n     * Calculate hull metrics (both ANT and Assemblage perspectives)\r\n     */\r\n    static calculateHullMetrics(\r\n        config: EcosystemConfiguration,\r\n        actors: TracedActor[],\r\n        associations: Association[]\r\n    ): HullMetrics {\r\n        const memberIds = config.memberIds;\r\n        const memberActors = actors.filter(a => memberIds.includes(a.id));\r\n\r\n        const internalLinks = associations.filter(\r\n            a => memberIds.includes(a.source) && memberIds.includes(a.target)\r\n        );\r\n\r\n        const externalLinks = associations.filter(\r\n            a => (memberIds.includes(a.source) && !memberIds.includes(a.target)) ||\r\n                (!memberIds.includes(a.source) && memberIds.includes(a.target))\r\n        );\r\n\r\n        const totalLinks = internalLinks.length + externalLinks.length;\r\n\r\n        // ANT flow metrics (methodological)\r\n        const porosity = totalLinks > 0 ? externalLinks.length / totalLinks : 0;\r\n        const connectivity = memberActors.length > 1\r\n            ? internalLinks.length / (memberActors.length * (memberActors.length - 1))\r\n            : 0;\r\n\r\n        // Assemblage realist metrics (ontological)\r\n        const territorialization = config.properties.calculated_stability || 0.5;\r\n        const coding_intensity = 1 - (config.properties.porosity_index || 0.5);\r\n        const capacity_score = 0.7; // Would calculate from actual capacities\r\n\r\n        return {\r\n            flow_metrics: {\r\n                porosity,\r\n                connectivity,\r\n                label: \"ANT Flow Analysis\"\r\n            },\r\n            realist_metrics: {\r\n                territorialization,\r\n                coding_intensity,\r\n                capacity_score,\r\n                label: \"Assemblage Mechanism Analysis\"\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Helper: Get intensity label\r\n     */\r\n    private static intensityLabel(intensity: number): string {\r\n        if (intensity > 0.7) return \"high\";\r\n        if (intensity > 0.4) return \"medium\";\r\n        return \"low\";\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\auth-helper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\clustering-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\content-extractor.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":29,"column":30,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":29,"endColumn":50,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\credits.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\cultural-analysis-service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BridgingConcept' is defined but never used.","line":8,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'openai' is defined but never used.","line":112,"column":126,"nodeType":null,"messageId":"unusedVar","endLine":112,"endColumn":132}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1995,1998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1995,1998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2099,2102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2099,2102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2713,2716],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2713,2716],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2837,2840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2837,2840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import OpenAI from 'openai';\r\nimport { PromptRegistry } from '@/lib/prompts/registry';\r\nimport { safeJSONParse } from '@/lib/analysis-utils';\r\nimport { detectSilences } from '@/lib/ontology';\r\nimport { CULTURAL_FRAMING_PROMPT } from '@/lib/prompts/cultural-framing';\r\nimport {\r\n    ThemeObject,\r\n    BridgingConcept,\r\n    BridgingData,\r\n    DiscourseCluster,\r\n    CulturalHole,\r\n    CulturalAnalysisResult\r\n} from '@/types/cultural';\r\n\r\nimport { cosineSimilarity, hierarchicalClustering } from '@/lib/clustering-utils';\r\n\r\n// (Functions extracted to clustering-utils.ts)\r\n\r\nexport async function performCulturalAnalysis(\r\n    userId: string,\r\n    sources: { id: string; title: string; text: string }[],\r\n    lensId: string,\r\n    openai: OpenAI\r\n): Promise<CulturalAnalysisResult> {\r\n\r\n    // Step 1: Extract Themes\r\n    const themeExtractions = await extractThemes(userId, sources, lensId, openai);\r\n\r\n    // Step 2: Embeddings\r\n    const { validThemes, allThemeObjects, sourceIds } = await generateThemeEmbeddings(themeExtractions, openai);\r\n\r\n    if (validThemes.length === 0) {\r\n        console.log('No valid themes found in sources.');\r\n        return {\r\n            summary: \"No themes could be extracted from the provided sources. Please ensure the documents contain sufficient text content.\",\r\n            clusters: [],\r\n            holes: [],\r\n            timestamp: new Date().toISOString(),\r\n        } as CulturalAnalysisResult;\r\n    }\r\n\r\n    // Step 3: Clustering\r\n    const clustersWithDescriptions = await clusterThemes(allThemeObjects, validThemes, sourceIds, openai);\r\n\r\n    // Step 4: Cultural Holes\r\n    const holes = await identifyCulturalHoles(userId, clustersWithDescriptions, openai);\r\n\r\n    // Step 5: Silences & Framing\r\n    console.log('Detecting silences (missing stakeholders)...');\r\n    const combinedText = sources.map((s) => s.text).join(' ');\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const silences = detectSilences(combinedText) as any[];\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let cultural_framing: any = undefined;\r\n    if (lensId === 'dsf_lens' || lensId === 'institutional_logics') {\r\n        cultural_framing = await analyzeCulturalFraming(combinedText, openai);\r\n    }\r\n\r\n    // Step 6: Summary\r\n    const summary = await generateAnalysisSummary(clustersWithDescriptions, holes, openai);\r\n\r\n    // Calculate Connectivity\r\n    const overall_connectivity_score = calculateConnectivity(clustersWithDescriptions);\r\n\r\n    return {\r\n        summary,\r\n        clusters: clustersWithDescriptions,\r\n        holes,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        silences: silences as any,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        cultural_framing: cultural_framing as any,\r\n        overall_connectivity_score,\r\n        timestamp: new Date().toISOString(),\r\n    };\r\n}\r\n\r\n// ------------------------------------------------------------------\r\n// HELPER FUNCTIONS\r\n// ------------------------------------------------------------------\r\n\r\nasync function extractThemes(userId: string, sources: { id: string; title: string; text: string }[], lensId: string, openai: OpenAI) {\r\n    const themeExtractionPrompt = await PromptRegistry.getEffectivePrompt(userId, 'theme_extraction');\r\n    const lensPrompt = await PromptRegistry.getEffectivePrompt(userId, `cultural_lens_${lensId}`) || '';\r\n    const finalSystemPrompt = `${themeExtractionPrompt}\\n\\n${lensPrompt}`;\r\n\r\n    console.log('Extracting themes from sources...');\r\n    return Promise.all(\r\n        sources.map(async (source, index) => {\r\n            try {\r\n                console.log(`Extracting themes from source ${index + 1}/${sources.length}: ${source.title}`);\r\n                const response = await openai.chat.completions.create({\r\n                    model: 'gpt-4o-mini',\r\n                    messages: [\r\n                        { role: 'system', content: finalSystemPrompt },\r\n                        { role: 'user', content: source.text.substring(0, 4000) },\r\n                    ],\r\n                    temperature: 0.3,\r\n                });\r\n                const themesText = response.choices[0].message.content || '[]';\r\n                const themes = safeJSONParse<ThemeObject[]>(themesText, []);\r\n                return { sourceId: source.id, sourceTitle: source.title, themes };\r\n            } catch (error: unknown) {\r\n                console.error(`Error extracting themes from source ${source.title}:`, (error as Error).message);\r\n                throw error;\r\n            }\r\n        })\r\n    );\r\n}\r\n\r\nasync function generateThemeEmbeddings(themeExtractions: { sourceId: string; sourceTitle: string; themes: ThemeObject[] }[], openai: OpenAI) {\r\n    console.log('Generating embeddings...');\r\n    const allThemesText: string[] = [];\r\n    const allThemeObjects: { theme: string; quote: string; source: string }[] = [];\r\n    const sourceIds: string[] = [];\r\n\r\n    themeExtractions.forEach((extraction) => {\r\n        extraction.themes.forEach((item: ThemeObject | string) => {\r\n            const themeText = typeof item === 'string' ? item : item.theme;\r\n            const quote = typeof item === 'string' ? '' : item.quote;\r\n            allThemesText.push(themeText);\r\n            allThemeObjects.push({ theme: themeText, quote, source: extraction.sourceTitle });\r\n            sourceIds.push(extraction.sourceId);\r\n        });\r\n    });\r\n\r\n    const validThemes = allThemesText.filter(t => t && t.trim().length > 0);\r\n    return { validThemes, allThemeObjects, sourceIds };\r\n}\r\n\r\nasync function clusterThemes(allThemeObjects: { theme: string; quote: string; source: string }[], validThemes: string[], sourceIds: string[], openai: OpenAI) {\r\n    const embeddingResponse = await openai.embeddings.create({\r\n        model: 'text-embedding-3-small',\r\n        input: validThemes,\r\n    });\r\n    const embeddings = embeddingResponse.data.map((item) => item.embedding);\r\n\r\n    console.log('Clustering themes...');\r\n    const rawClusters = hierarchicalClustering(allThemeObjects, embeddings, sourceIds, 0.7);\r\n\r\n    const clusters: DiscourseCluster[] = rawClusters.map((cluster, i) => ({\r\n        id: `cluster-${i}`,\r\n        name: cluster.themes[0].theme,\r\n        themes: cluster.themes.map(t => t.theme),\r\n        quotes: cluster.themes.map(t => ({ text: t.quote, source: t.source })).filter(q => q.text),\r\n        sources: cluster.sources,\r\n        centroid: cluster.centroid,\r\n        size: cluster.themes.length,\r\n    }));\r\n\r\n    console.log('Generating cluster descriptions...');\r\n    return Promise.all(\r\n        clusters.map(async (cluster) => {\r\n            try {\r\n                const descriptionResponse = await openai.chat.completions.create({\r\n                    model: 'gpt-4o-mini',\r\n                    messages: [\r\n                        { role: 'system', content: `You are an expert in discourse analysis. Provide a concise 15-word definition of this discourse cluster.` },\r\n                        { role: 'user', content: `Themes: ${cluster.themes.join(', ')}` }\r\n                    ],\r\n                    temperature: 0.3,\r\n                });\r\n                const description = descriptionResponse.choices[0].message.content?.trim() || cluster.name;\r\n                return { ...cluster, description };\r\n            } catch {\r\n                return { ...cluster, description: cluster.name };\r\n            }\r\n        })\r\n    );\r\n}\r\n\r\nasync function identifyCulturalHoles(userId: string, clusters: DiscourseCluster[], openai: OpenAI) {\r\n    console.log('Identifying cultural holes...');\r\n    const potentialHoles = [];\r\n    const holeThreshold = 0.4;\r\n\r\n    for (let i = 0; i < clusters.length; i++) {\r\n        for (let j = i + 1; j < clusters.length; j++) {\r\n            const similarity = cosineSimilarity(clusters[i].centroid, clusters[j].centroid);\r\n            const distance = 1 - similarity;\r\n            if (distance > holeThreshold) {\r\n                potentialHoles.push({ clusterA: clusters[i], clusterB: clusters[j], distance: parseFloat(distance.toFixed(3)) });\r\n            }\r\n        }\r\n    }\r\n\r\n    potentialHoles.sort((a, b) => b.distance - a.distance);\r\n    const topHoles = potentialHoles.slice(0, 3);\r\n    const bridgingPrompt = await PromptRegistry.getEffectivePrompt(userId, 'bridging_concepts');\r\n\r\n    return Promise.all(\r\n        topHoles.map(async (hole) => {\r\n            try {\r\n                const bridgingResponse = await openai.chat.completions.create({\r\n                    model: 'gpt-4o',\r\n                    messages: [\r\n                        { role: 'system', content: bridgingPrompt },\r\n                        { role: 'user', content: `Cluster A: ${hole.clusterA.themes.join(', ')}\\nCluster B: ${hole.clusterB.themes.join(', ')}` },\r\n                    ],\r\n                    temperature: 0.5,\r\n                });\r\n                const bridgingData = safeJSONParse<BridgingData>(\r\n                    bridgingResponse.choices[0].message.content || '{}',\r\n                    { bridgingConcepts: [], opportunity: '', policyImplication: '' }\r\n                );\r\n                return {\r\n                    id: `hole-${hole.clusterA.id}-${hole.clusterB.id}`,\r\n                    clusterA: hole.clusterA.name,\r\n                    clusterB: hole.clusterB.name,\r\n                    distance: hole.distance,\r\n                    bridgingConcepts: bridgingData.bridgingConcepts || [],\r\n                    opportunity: bridgingData.opportunity || '',\r\n                    policyImplication: bridgingData.policyImplication || '',\r\n                };\r\n            } catch {\r\n                return {\r\n                    id: `hole-${hole.clusterA.id}`,\r\n                    clusterA: hole.clusterA.name,\r\n                    clusterB: hole.clusterB.name,\r\n                    distance: hole.distance,\r\n                    bridgingConcepts: [],\r\n                    opportunity: 'Error',\r\n                    policyImplication: 'Error'\r\n                };\r\n            }\r\n        })\r\n    );\r\n}\r\n\r\nasync function analyzeCulturalFraming(text: string, openai: OpenAI) {\r\n    console.log('Running Cultural Framing analysis...');\r\n    try {\r\n        const framingResponse = await openai.chat.completions.create({\r\n            model: 'gpt-4o',\r\n            messages: [\r\n                { role: 'system', content: CULTURAL_FRAMING_PROMPT },\r\n                { role: 'user', content: text.substring(0, 15000) }\r\n            ],\r\n            temperature: 0.4,\r\n            response_format: { type: \"json_object\" }\r\n        });\r\n        if (framingResponse.choices[0].message.content) {\r\n            return JSON.parse(framingResponse.choices[0].message.content);\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error generating cultural framing:\", error);\r\n    }\r\n    return undefined;\r\n}\r\n\r\nasync function generateAnalysisSummary(clusters: DiscourseCluster[], holes: CulturalHole[], openai: OpenAI) {\r\n    console.log('Generating overall summary...');\r\n    try {\r\n        const summaryResponse = await openai.chat.completions.create({\r\n            model: 'gpt-4o-mini',\r\n            messages: [\r\n                {\r\n                    role: 'system',\r\n                    content: `Summarize the key findings of this cultural analysis in 2-3 sentences. Focus on clusters and holes.`\r\n                },\r\n                {\r\n                    role: 'user',\r\n                    content: `Clusters: ${clusters.map(c => c.name).join(', ')}\\nTop Hole: ${holes.length > 0 ? `${holes[0].clusterA} vs ${holes[0].clusterB}` : \"None\"}`\r\n                }\r\n            ],\r\n            temperature: 0.5,\r\n        });\r\n        return summaryResponse.choices[0].message.content || \"\";\r\n    } catch {\r\n        return \"Summary generation failed.\";\r\n    }\r\n}\r\n\r\nfunction calculateConnectivity(clusters: DiscourseCluster[]) {\r\n    let overall_connectivity_score = 1.0;\r\n    if (clusters.length > 1) {\r\n        let totalSimilarity = 0;\r\n        let pairCount = 0;\r\n        for (let i = 0; i < clusters.length; i++) {\r\n            for (let j = i + 1; j < clusters.length; j++) {\r\n                const similarity = cosineSimilarity(clusters[i].centroid, clusters[j].centroid);\r\n                totalSimilarity += similarity;\r\n                pairCount++;\r\n            }\r\n        }\r\n        if (pairCount > 0) {\r\n            overall_connectivity_score = totalSimilarity / pairCount;\r\n        }\r\n    }\r\n    return overall_connectivity_score;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\data\\baselines.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\delanda-service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AssemblageExtractionResult' is defined but never used.","line":1,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AssemblageTrace, AssemblageExtractionResult } from \"@/types/assemblage\";\r\n\r\n/**\r\n * Computes DeLanda Metrics from Extracted Traces.\r\n * \r\n * Theory:\r\n * - Territorialization (T): The degree to which component roles are fixed and boundaries are sharpened.\r\n *   Calculated as: Density of Enforcements (Boundaries) + Narratives (Identity) weighted by Durability.\r\n * \r\n * - Coding Intensity (C): The role of formal RULES (code, law) in defining behavior.\r\n *   Calculated as: Density of Rules (Code/Law) weighted by Durability.\r\n */\r\n\r\nconst DURABILITY_WEIGHTS = {\r\n    \"High\": 3,   // Law, Code, Physics\r\n    \"Medium\": 2, // Contracts, Standards\r\n    \"Low\": 1     // Norms, Speech\r\n};\r\n\r\nexport function computeDeLandaMetrics(traces: AssemblageTrace[] = []) {\r\n    if (!traces || traces.length === 0) {\r\n        return {\r\n            territorialization_score: 0,\r\n            coding_intensity_score: 0,\r\n            territorialization_audit: [\"No traces found.\"],\r\n            coding_audit: [\"No traces found.\"]\r\n        };\r\n    }\r\n\r\n    let tScoreRaw = 0;\r\n    let cScoreRaw = 0;\r\n    const tAudit: string[] = [];\r\n    const cAudit: string[] = [];\r\n\r\n    traces.forEach(trace => {\r\n        const weight = DURABILITY_WEIGHTS[trace.durability] || 1;\r\n\r\n        // TERRITORIALIZATION: Mechanisms that define \"Inside vs Outside\" or \"Identity\"\r\n        if (trace.type === \"Enforcement\" || trace.type === \"Narrative\") {\r\n            tScoreRaw += weight;\r\n            tAudit.push(`[${trace.type} | ${trace.durability}] ${trace.description} (+${weight})`);\r\n        }\r\n\r\n        // CODING INTENSITY: Mechanisms that define \"Correct vs Incorrect\" behavior (Rules)\r\n        // Note: Enforcements often *enforce* coding, so they count partially too (half weight).\r\n        if (trace.type === \"Rule\") {\r\n            cScoreRaw += weight;\r\n            cAudit.push(`[${trace.type} | ${trace.durability}] ${trace.description} (+${weight})`);\r\n        } else if (trace.type === \"Enforcement\") {\r\n            cScoreRaw += (weight * 0.5); // Enforcement proves coding exists\r\n            cAudit.push(`[${trace.type} | ${trace.durability}] ${trace.description} (+${weight * 0.5})`);\r\n        }\r\n    });\r\n\r\n    // Normalize Scores (Logarithmic scale to dampen explosion of traces)\r\n    // We assume ~5 high-durability traces = \"High\" score (15 pts) for a typical 1-paragraph text.\r\n    const normalize = (raw: number) => Math.min(10, Math.max(1, Math.round((Math.log2(raw + 1) / Math.log2(16)) * 10)));\r\n\r\n    return {\r\n        territorialization_score: normalize(tScoreRaw),\r\n        coding_intensity_score: normalize(cScoreRaw),\r\n        territorialization_audit: tAudit,\r\n        coding_audit: cAudit\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\ecosystem-utils.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2594,2597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2594,2597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2994,2997],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2994,2997],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\governance.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'count' is assigned a value but never used.","line":37,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface CompassPoint {\r\n    x: number; // Asymmetrical (-1) vs Participatory (+1)\r\n    y: number; // Extractive (-1) vs Regenerative (+1)\r\n    label: string;\r\n}\r\n\r\nexport interface DriftVector {\r\n    rhetoric: CompassPoint;\r\n    reality: CompassPoint;\r\n    driftX: number;\r\n    driftY: number;\r\n    magnitude: number;\r\n}\r\n\r\n// Keywords for scoring (simplified for this implementation)\r\n// Keywords for scoring (expanded for better matching)\r\nconst REGENERATIVE_KEYWORDS = [\r\n    'capacity building', 'community ownership', 'local adaptation', 'public good', 'sustainability', 'empowerment',\r\n    'humanity', 'benefit', 'safety', 'beneficial', 'robust', 'reliable', 'fairness', 'justice', 'equity', 'access', 'open source', 'public', 'thriving', 'ecosystem'\r\n];\r\nconst EXTRACTIVE_KEYWORDS = [\r\n    'data mining', 'user acquisition', 'behavioral surplus', 'monetization', 'lock-in', 'surveillance',\r\n    'proprietary', 'closed', 'profit', 'commercial', 'usage policies', 'restrictions', 'license', 'fee', 'paid', 'exclusive', 'competitive', 'capture', 'market share', 'dominance'\r\n];\r\nconst PARTICIPATORY_KEYWORDS = [\r\n    'co-design', 'veto power', 'citizen jury', 'public consultation', 'multi-stakeholder', 'consensus',\r\n    'oversight', 'accountability', 'transparency', 'explainability', 'audit', 'feedback', 'redress', 'appeal', 'collaboration', 'partnership', 'agency', 'choice', 'democratic'\r\n];\r\nconst ASYMMETRICAL_KEYWORDS = [\r\n    'unilateral', 'compliance requirement', 'terms of service', 'mandatory', 'enforcement', 'top-down',\r\n    'centralized', 'control', 'authority', 'restricted', 'prohibited', 'disallowed', 'monitoring', 'rules', 'opaque', 'black box', 'limited access'\r\n];\r\n\r\nfunction calculateScore(text: string, positiveKeywords: string[], negativeKeywords: string[]): number {\r\n    const lowerText = text.toLowerCase();\r\n    let score = 0;\r\n    let count = 0;\r\n\r\n    positiveKeywords.forEach(keyword => {\r\n        if (lowerText.includes(keyword)) {\r\n            score += 1;\r\n            count++;\r\n        }\r\n    });\r\n\r\n    negativeKeywords.forEach(keyword => {\r\n        if (lowerText.includes(keyword)) {\r\n            score -= 1;\r\n            count++;\r\n        }\r\n    });\r\n\r\n    // Normalize to -1 to 1 range, avoiding division by zero\r\n    // We use a sigmoid-like squash or simple clamping. Here, simple clamping with a scaling factor.\r\n    // Assuming 5 keywords is a \"strong\" signal.\r\n    return Math.max(-1, Math.min(1, score * 0.2));\r\n}\r\n\r\nexport function calculateCompassScore(text: string, label: string): CompassPoint {\r\n    const y = calculateScore(text, REGENERATIVE_KEYWORDS, EXTRACTIVE_KEYWORDS);\r\n    const x = calculateScore(text, PARTICIPATORY_KEYWORDS, ASYMMETRICAL_KEYWORDS);\r\n    return { x, y, label };\r\n}\r\n\r\nexport function calculateDrift(policyText: string, techText: string): DriftVector {\r\n    const rhetoric = calculateCompassScore(policyText, \"Rhetoric\");\r\n    const reality = calculateCompassScore(techText, \"Reality\");\r\n\r\n    const driftX = reality.x - rhetoric.x;\r\n    const driftY = reality.y - rhetoric.y;\r\n    const magnitude = Math.sqrt(driftX * driftX + driftY * driftY);\r\n\r\n    return {\r\n        rhetoric,\r\n        reality,\r\n        driftX,\r\n        driftY,\r\n        magnitude\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\graph-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\liberatory-calculator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\narrative-interpreters.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":101,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":102,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":102,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Narrative Interpretation Utilities\r\n * \r\n * Converts numerical scores and metrics into rich qualitative narratives\r\n * for I&O journal-style interpretive analysis.\r\n */\r\n\r\nexport interface RiskAnalysis {\r\n    score: number;\r\n    level: \"Interpretive\" | \"Directional Drift\" | \"Micro-Fascist Hardening\";\r\n    flags: Record<string, boolean>;\r\n}\r\n\r\nexport interface CapacityAnalysis {\r\n    score: number;\r\n    level: \"Rhetorical/Fragile\" | \"Partial/Conditional\" | \"Structural/Robust\";\r\n    signals: Record<string, boolean>;\r\n}\r\n\r\n/**\r\n * Generate narrative interpretation of micro-fascism risk analysis\r\n */\r\nexport function interpretRiskNarrative(risk: RiskAnalysis): string {\r\n    if (risk.level === 'Micro-Fascist Hardening' || risk.score >= 5) {\r\n        return \"The assemblage exhibits pronounced authoritarian characteristics, manifested through exclusionary boundaries, opaque decision-making, and punitive enforcement mechanisms that concentrate power while marginalizing affected communities. These dynamics create conditions for micro-fascist organizing where bureaucratic authority supersedes democratic accountability.\";\r\n    } else if (risk.level === 'Directional Drift' || risk.score >= 3) {\r\n        return \"Moderate authoritarian tendencies emerge in bureaucratic rigidity and limited participatory channels, though countervailing democratic elements provide some accountability. The assemblage oscillates between technocratic efficiency and inclusive governance, creating friction points where power concentrates.\";\r\n    } else {\r\n        return \"The assemblage demonstrates democratic robustness with distributed authority, transparent procedures, and meaningful participation mechanisms. While not without hierarchies, power relations remain contestable and subject to procedural checks that prevent authoritarian drift.\";\r\n    }\r\n}\r\n\r\n/**\r\n * Generate narrative interpretation of liberatory capacity analysis\r\n */\r\nexport function interpretCapacityNarrative(capacity: CapacityAnalysis): string {\r\n    if (capacity.level === 'Structural/Robust' || capacity.score >= 6) {\r\n        return \"The assemblage creates substantive openings for emancipatory practice through collective rights frameworks, participatory governance structures, and explicit recognition of marginalized epistemologies. These enabling conditions support bottom-up organizing and resist neoliberal enclosure of political possibility.\";\r\n    } else if (capacity.level === 'Partial/Conditional' || capacity.score >= 3) {\r\n        return \"Liberatory potential exists but remains constrained by institutional inertia and market logics. While formal rights and consultation mechanisms provide some agency, systemic barriers limit transformative capacity. The assemblage offers tactical openings rather than strategic reconfigurations of power.\";\r\n    } else {\r\n        return \"Limited liberatory capacity emerges within a predominantly technocratic framework that forecloses radical alternatives. Participation channels privilege expert knowledge over lived experience, and accountability mechanisms reinforce existing hierarchies rather than enabling collective self-determination.\";\r\n    }\r\n}\r\n\r\n/**\r\n * Generate narrative interpretation of centralization dynamics\r\n */\r\nexport function interpretCentralizationNarrative(score: number): string {\r\n    if (score >= 75) {\r\n        return \"Authority flows hierarchically through formal bureaucratic channels, creating rigid decision-making structures that marginalize participatory input. Centralization concentrates epistemic authority in technocratic institutions, establishing them as obligatory passage points that filter and transform grassroots knowledge claims.\";\r\n    } else if (score >= 50) {\r\n        return \"Governance exhibits mixed centralization with formal hierarchy coexisting alongside distributed networks. Decision-making authority oscillates between concentrated nodes and peripheral actors, creating uneven power geometries where influence depends on positional leverage within the assemblage.\";\r\n    } else {\r\n        return \"Distributed governance structures enable polycentric authority with multiple sites of legitimate decision-making. Decentralization creates spaces for local adaptation and contestation, though coordination challenges may fragment coherent action across scales.\";\r\n    }\r\n}\r\n\r\n/**\r\n * Generate narrative interpretation of territorialization\r\n */\r\nexport function interpretTerritorializationNarrative(score: number): string {\r\n    if (score >= 75) {\r\n        return \"The assemblage exhibits strong territorializing forces through standardized procedures, fixed classifications, and bureaucratic routinization. These stabilizing mechanisms create predictable patterns but risk rigidity, limiting adaptive capacity to emergent challenges and marginalizing practices that don't fit prescribed templates.\";\r\n    } else if (score >= 50) {\r\n        return \"Territorializing and deterritorializing forces create dynamic tension. While institutional patterns provide stable reference points, spaces for improvisation and reinterpretation allow the assemblage to flex and evolve. This balanced instability enables both coherence and innovation.\";\r\n    } else {\r\n        return \"Deterritorializing flows dominate, creating fluid, emergent patterns that resist codification. This openness enables creative recombination and adaptive governance but may lack the stable infrastructure needed for long-term institutionalization. The assemblage remains in formation, its boundaries contested and porous.\";\r\n    }\r\n}\r\n\r\n/**\r\n * Generate narrative interpretation of material flows\r\n */\r\nexport function interpretMaterialFlowNarrative(description: string, intensity?: number): string {\r\n    const intensityPhrase = intensity && intensity >= 7 ?\r\n        \"intensive circulation\" :\r\n        intensity && intensity >= 4 ?\r\n            \"moderate flow\" :\r\n            \"limited movement\";\r\n\r\n    return `Material resources circulate through the assemblage with ${intensityPhrase}, shaping power relations and enabling or constraining organizational practices. ${description} These flows create dependencies and affordances that structure what becomes possible within the assemblage's operational field.`;\r\n}\r\n\r\n/**\r\n * Generate narrative for verification gap analysis\r\n */\r\nexport function interpretVerificationGapNarrative(hasGap: boolean, explanation: string): string {\r\n    if (hasGap) {\r\n        return `A significant rhetorical-empirical gap emerges where aspirational language outpaces concrete enforcement mechanisms. ${explanation} This disconnect between text and practice creates space for symbolic compliance while substantive accountability remains elusive.`;\r\n    } else {\r\n        return `Claims are grounded in verifiable mechanisms, creating aligned rhetoric and enforcement. ${explanation} This coherence between stated intentions and operational capacity suggests the assemblage can deliver on its commitments.`;\r\n    }\r\n}\r\n\r\n/**\r\n * Generate narrative list of triggered indicators\r\n */\r\nexport function narrativizeFlags(flags: Record<string, boolean>, context: string): string[] {\r\n    return Object.entries(flags)\r\n        .filter(([_, value]) => value)\r\n        .map(([key, _]) => {\r\n            const readable = key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\r\n            return `${readable} patterns observed in ${context}`;\r\n        });\r\n}\r\n\r\n/**\r\n * Convert score-based stress test to narrative\r\n */\r\nexport function interpretStressTestNarrative(\r\n    sensitivity: 'High' | 'Medium' | 'Low',\r\n    originalScore: number,\r\n    perturbedScore: number\r\n): string {\r\n    const shift = Math.abs(originalScore - perturbedScore);\r\n\r\n    if (sensitivity === 'High') {\r\n        return `Critical fragility detected: the assemblage's authority collapses under rhetorical inversion (${shift}-point degradation), revealing dependence on persuasive framing rather than robust structural mechanisms. This brittleness suggests the policy relies more on ideological legitimation than material accountability, making it vulnerable to hostile interpretation or bad-faith implementation.`;\r\n    } else if (sensitivity === 'Medium') {\r\n        return `Moderate rhetorical dependency emerges through adversarial reframing (${shift}-point shift). While the assemblage possesses some structural integrity, hostile actors could exploit framing ambiguities to weaken its authority. This suggests a need for more concrete enforcement mechanisms to insulate governance from interpretive manipulation.`;\r\n    } else {\r\n        return `Robust structural resilience withstands rhetorical inversion with minimal degradation (${shift}-point variance). The assemblage's authority derives from concrete mechanisms and specific mandates rather than aspirational language, enabling it to resist hostile spin and maintain operational coherence across varied interpretive contexts.`;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\ontology-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\ontology.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\perspectives.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\absence.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\assemblage-explanation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\assemblage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\comparative-synthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\comparison.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\critique.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\cultural-analysis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\cultural-framing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\cultural-holes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\dsf.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\ecosystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\institutional-logics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\legitimacy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\liberatory.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":46,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":47,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { LiberatoryCapacity } from \"@/lib/liberatory-calculator\";\r\n\r\nexport const LIBERATORY_CAPACITY_SUMMARY_PROMPT_TEMPLATE = `\r\nYou are a governance systems analyst producing an executive diagnostic summary for a Liberatory Governance Capacity Index (LGCI).\r\n\r\nCONTEXT\r\nA policy document (â€œ{{CONTEXT}}â€) has been analyzed for its capacity to preserve openness, plurality, reversibility, and situated judgment within an AI governance assemblage.\r\n\r\nLiberatory Capacity Score: {{LIBERATION_SCORE}} / 8\r\nCapacity Level: {{LIBERATION_LEVEL}}\r\n\r\nActivated Liberatory Signals:\r\n{{ACTIVE_COUNTER_INDICATORS}}\r\n\r\nANALYTIC DIMENSIONS\r\nThe following liberatory governance properties were assessed:\r\n\r\nPower Reversibility: {{POWER_REVERSIBILITY_EXPLANATION}}\r\nSituated Agency Protection: {{AGENCY_PROTECTION_EXPLANATION}}\r\nEpistemic Plurality: {{EPISTEMIC_PLURALITY_EXPLANATION}}\r\nExit, Pause, or Refusal Rights: {{EXIT_RIGHTS_EXPLANATION}}\r\nRecognition of Repair & Care Work: {{REPAIR_RECOGNITION_EXPLANATION}}\r\nTemporal Openness: {{TEMPORAL_OPENNESS_EXPLANATION}}\r\nCapacity-Sensitive Proportionality: {{CAPACITY_SENSITIVITY_EXPLANATION}}\r\nContestable Safety Framing: {{SAFETY_CONTESTABILITY_EXPLANATION}}\r\n\r\nTASK\r\nWrite a concise, high-level diagnostic narrative (maximum 3 sentences) explaining how this document sustains or fails to sustain liberatory governance capacity.\r\n\r\nGuidelines:\r\nFocus on the interaction and reinforcement of liberatory features, not isolated safeguards.\r\nEmphasize whether openness is structural (designed into procedures) or merely symbolic.\r\nDescribe the direction of governance the document enables (iterative, plural, reversible vs brittle, exceptional, or conditional).\r\n\r\nTone by Score:\r\nScore 0â€“2: Note the absence or fragility of liberatory design; openness is rhetorical or easily overridden.\r\nScore 3â€“5: Highlight partial safeguards and points of leverage, alongside conditions under which they may erode.\r\nScore 6â€“8: Emphasize robust design features that actively preserve contestability, exit, and learning under pressure.\r\n\r\nDo not praise intentions, speculate about political motives, or propose reforms.\r\nYour role is diagnostic and descriptive, not normative.\r\n`;\r\n\r\nexport const fillLiberatoryPrompt = (template: string, context: string, capacity: LiberatoryCapacity) => {\r\n    const activeSignals = Object.entries(capacity.signals)\r\n        .filter(([_, active]) => active)\r\n        .map(([key, _]) => key.replace(/_/g, ' ').toUpperCase());\r\n\r\n    return template\r\n        .replace('{{CONTEXT}}', context || 'Unknown Document')\r\n        .replace('{{LIBERATION_SCORE}}', capacity.score.toString())\r\n        .replace('{{LIBERATION_LEVEL}}', capacity.level)\r\n        .replace('{{ACTIVE_COUNTER_INDICATORS}}', activeSignals.length > 0 ? activeSignals.join(', ') : \"None (Fragile)\")\r\n        .replace('{{POWER_REVERSIBILITY_EXPLANATION}}', capacity.explanations.power || \"N/A\")\r\n        .replace('{{AGENCY_PROTECTION_EXPLANATION}}', capacity.explanations.agency || \"N/A\")\r\n        .replace('{{EPISTEMIC_PLURALITY_EXPLANATION}}', capacity.explanations.epistemic || \"N/A\")\r\n        .replace('{{EXIT_RIGHTS_EXPLANATION}}', capacity.explanations.exit || \"N/A\")\r\n        .replace('{{REPAIR_RECOGNITION_EXPLANATION}}', capacity.explanations.repair || \"N/A\")\r\n        .replace('{{TEMPORAL_OPENNESS_EXPLANATION}}', capacity.explanations.temporal || \"N/A\")\r\n        .replace('{{CAPACITY_SENSITIVITY_EXPLANATION}}', capacity.explanations.proportionality || \"N/A\")\r\n        .replace('{{SAFETY_CONTESTABILITY_EXPLANATION}}', capacity.explanations.safety || \"N/A\");\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\micro-fascism.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":30,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":31,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MicroFascismRisk } from \"@/lib/risk-calculator\";\r\n\r\nexport const MICRO_FASCISM_RISK_SUMMARY_PROMPT_TEMPLATE = `\r\nYou are a specialized political risk analyst providing a diagnostic summary for a \"Micro-Fascism Risk Index\".\r\n\r\nCONTEXT:\r\nThe system has analyzed a policy document (\"{{CONTEXT}}\") and computed a risk score of {{RISK_SCORE}}/6.\r\nLevel: {{RISK_LEVEL}}\r\n\r\nACTIVE RISK FLAGS:\r\n{{ACTIVE_FLAGS}}\r\n\r\nDETAILED FINDINGS:\r\n- Power Hardening: {{POWER_EXPLANATION}}\r\n- Agency Collapse: {{AGENCY_EXPLANATION}}\r\n- Epistemic Narrowing: {{EPISTEMIC_EXPLANATION}}\r\n- Structural Violence: {{STRUCTURAL_EXPLANATION}}\r\n- Temporal Closure: {{TEMPORAL_EXPLANATION}}\r\n- Absence as Control: {{ABSENCE_EXPLANATION}}\r\n\r\nTASK:\r\nWrite a concise, high-level summary (max 3 sentences) explaining WHY this document received this score.\r\nFocus on the *convergence* of the active factors. Do not list them mechanically; weave them into a diagnostic narrative.\r\nIf the score is 0-2, emphasize the effective \"Interpretive Governance\" features (openness, accountability).\r\nIf the score is 5-6, warn sternly about the \"Hardening\" of control.\r\n`;\r\n\r\nexport const fillRiskSummaryPrompt = (template: string, context: string, risk: MicroFascismRisk) => {\r\n    const activeFlags = Object.entries(risk.flags)\r\n        .filter(([_, active]) => active)\r\n        .map(([key, _]) => key.replace(/_/g, ' ').toUpperCase());\r\n\r\n    return template\r\n        .replace('{{CONTEXT}}', context || 'Unknown Document')\r\n        .replace('{{RISK_SCORE}}', risk.score.toString())\r\n        .replace('{{RISK_LEVEL}}', risk.level)\r\n        .replace('{{ACTIVE_FLAGS}}', activeFlags.length > 0 ? activeFlags.join(', ') : \"None (Safe)\")\r\n        .replace('{{POWER_EXPLANATION}}', risk.explanations.power || \"None\")\r\n        .replace('{{AGENCY_EXPLANATION}}', risk.explanations.agency || \"None\")\r\n        .replace('{{EPISTEMIC_EXPLANATION}}', risk.explanations.epistemic || \"None\")\r\n        .replace('{{STRUCTURAL_EXPLANATION}}', risk.explanations.structural || \"None\")\r\n        .replace('{{TEMPORAL_EXPLANATION}}', risk.explanations.temporal || \"None\")\r\n        .replace('{{ABSENCE_EXPLANATION}}', risk.explanations.absence || \"None\");\r\n};\r\n\r\n// Deprecated: wrapper for backward compatibility if needed, but we will update usage.\r\nexport const generateRiskSummaryPrompt = (context: string, risk: MicroFascismRisk) => {\r\n    return fillRiskSummaryPrompt(MICRO_FASCISM_RISK_SUMMARY_PROMPT_TEMPLATE, context, risk);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\ontology.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\registry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\resistance-analysis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\resistance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\search-traces.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\stress-test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\prompts\\theoretical-prompts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\provisional-wrapper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\ratelimit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\redis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\risk-calculator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'agencyScore' is assigned a value but never used.","line":57,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":57,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalysisResult } from \"@/types\";\r\n\r\nexport interface MicroFascismRisk {\r\n    score: number; // 0-6\r\n    level: \"Interpretive\" | \"Directional Drift\" | \"Micro-Fascist Hardening\";\r\n    flags: {\r\n        power_hardening: boolean;\r\n        agency_collapse: boolean;\r\n        epistemic_narrowing: boolean;\r\n        structural_violence: boolean;\r\n        temporal_closure: boolean;\r\n        absence_as_control: boolean;\r\n    };\r\n    explanations: {\r\n        power: string;\r\n        agency: string;\r\n        epistemic: string;\r\n        structural: string;\r\n        temporal: string;\r\n        absence: string;\r\n    };\r\n}\r\n\r\nexport function calculateMicroFascismRisk(analysis: AnalysisResult): MicroFascismRisk {\r\n    const flags = {\r\n        power_hardening: false,\r\n        agency_collapse: false,\r\n        epistemic_narrowing: false,\r\n        structural_violence: false,\r\n        temporal_closure: false,\r\n        absence_as_control: false\r\n    };\r\n\r\n    const explanations = {\r\n        power: \"\",\r\n        agency: \"\",\r\n        epistemic: \"\",\r\n        structural: \"\",\r\n        temporal: \"\",\r\n        absence: \"\"\r\n    };\r\n\r\n    const scores = analysis.governance_scores || { centralization: 50, procedurality: 50, market_power: 50, rights_focus: 50, flexibility: 50 };\r\n\r\n    // 1. Power Hardening\r\n    // Authority collapse into procedure or high centralization\r\n    if ((scores.centralization || 0) > 75) {\r\n        flags.power_hardening = true;\r\n        explanations.power = `Centralization score (${scores.centralization}) exceeds critical threshold.`;\r\n    } else if ((scores.procedurality || 0) > 85) {\r\n        flags.power_hardening = true;\r\n        explanations.power = `Procedurality score (${scores.procedurality}) indicates automated bureaucracy.`;\r\n    }\r\n\r\n    // 2. Agency Collapse\r\n    // Agency reframed as liability\r\n    const agencyScore = parseInt(analysis.agency_codesign_self_determination?.match(/(\\d+)/)?.[1] || \"50\"); // Heuristic if not numeric field, but usually implicit\r\n    // Actually we don't have a raw score for agency in governance_scores, so we infer from rights_focus or add it.\r\n    // Let's use Rights Focus < 40 as proxy if explicit agency score missing, OR if we parse it from text.\r\n    // Better: Use `rights_focus` context.\r\n    if ((scores.rights_focus || 0) < 35) {\r\n        flags.agency_collapse = true;\r\n        explanations.agency = `Rights Focus (${scores.rights_focus}) is critically low, suggesting user liability.`;\r\n    }\r\n\r\n    // 3. Epistemic Narrowing\r\n    // Knowledge standardization\r\n    // Use Plurality/Inclusion text analysis or Coloniality Score\r\n    if ((scores.coloniality || 0) > 60) {\r\n        flags.epistemic_narrowing = true;\r\n        explanations.epistemic = `Coloniality score (${scores.coloniality}) indicates domination of a single worldview.`;\r\n    } else if (analysis.silenced_voices && analysis.silenced_voices.length > 3) {\r\n        flags.epistemic_narrowing = true;\r\n        explanations.epistemic = `High number of silenced voices (${analysis.silenced_voices.length}) detected.`;\r\n    }\r\n\r\n    // 4. Structural Violence\r\n    // Material Consequences\r\n    if (analysis.economic_burden) {\r\n        if (analysis.economic_burden.market_consolidation_risk === \"High\") {\r\n            flags.structural_violence = true;\r\n            explanations.structural = \"High risk of market consolidation detected.\";\r\n        } else if (analysis.economic_burden.burden_bearer === \"Individual\" || analysis.economic_burden.burden_bearer === \"Society\") {\r\n            flags.structural_violence = true;\r\n            explanations.structural = `Economic burden shifted to ${analysis.economic_burden.burden_bearer}.`;\r\n        }\r\n    }\r\n\r\n    // 5. Temporal Closure\r\n    // Teleology\r\n    if (analysis.temporal_orientation) {\r\n        if (analysis.temporal_orientation.score < 35) {\r\n            flags.temporal_closure = true;\r\n            explanations.temporal = `Temporal Openness score (${analysis.temporal_orientation.score}) indicates 'Desinty' or 'Urgency' framing.`;\r\n        } else if (analysis.temporal_orientation.framing === \"Urgency\" || analysis.temporal_orientation.framing === \"Destiny\") {\r\n            flags.temporal_closure = true;\r\n            explanations.temporal = `Future framed as '${analysis.temporal_orientation.framing}', closing off alternatives.`;\r\n        }\r\n    }\r\n\r\n    // 6. Absence as Control\r\n    // No exit rights, invisible labor\r\n    // We check system critique blind spots\r\n    const blindSpots = analysis.system_critique?.blind_spots?.length || 0;\r\n    if (blindSpots > 4) {\r\n        flags.absence_as_control = true;\r\n        explanations.absence = `Critical mass of blind spots (${blindSpots}) indicates governance by omission.`;\r\n    }\r\n\r\n    // Calculate Composite\r\n    const score = Object.values(flags).filter(f => f).length;\r\n    let level: MicroFascismRisk[\"level\"] = \"Interpretive\";\r\n    if (score >= 5) level = \"Micro-Fascist Hardening\";\r\n    else if (score >= 3) level = \"Directional Drift\";\r\n\r\n    return {\r\n        score,\r\n        level,\r\n        flags,\r\n        explanations\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\scenario-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\search-service.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1533,1536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1533,1536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1780,1783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1780,1783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\storage-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\store.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1766,1769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1766,1769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Source } from '@/types';\r\nimport { StorageService } from '@/lib/storage-service';\r\nimport { BASELINE_SOURCES } from '@/lib/data/baselines';\r\n\r\n// Read sources from Redis\r\nexport const getSources = async (userId: string): Promise<Source[]> => {\r\n    let sources = await StorageService.get<Source[]>(userId, 'sources');\r\n\r\n    // Seed if empty\r\n    if (!sources || sources.length === 0) {\r\n        sources = BASELINE_SOURCES;\r\n        await saveSources(userId, sources);\r\n    }\r\n\r\n    // Hot-patch loop: check for missing features in baselines (DR3/DR4 updates)\r\n    let needsUpdate = false;\r\n    const patchedSources = sources.map(source => {\r\n        const baseline = BASELINE_SOURCES.find(b => b.id === source.id);\r\n        if (baseline) {\r\n            const patched = { ...source };\r\n            // Check for missing accountability_map (DR3)\r\n            if (baseline.analysis?.accountability_map && !source.analysis?.accountability_map) {\r\n                patched.analysis = {\r\n                    ...patched.analysis,\r\n                    accountability_map: baseline.analysis.accountability_map\r\n                };\r\n                needsUpdate = true;\r\n            }\r\n            // Check for missing rebuttals (DR4)\r\n            if (baseline.analysis?.rebuttals && !source.analysis?.rebuttals) {\r\n                patched.analysis = {\r\n                    ...patched.analysis,\r\n                    rebuttals: baseline.analysis.rebuttals\r\n                };\r\n                needsUpdate = true;\r\n            }\r\n\r\n            // Patch for missing Cultural/Logics/Legitimacy fields\r\n            // Aggressive check: if missing OR if specific keys are missing (handling stale partial data)\r\n            const cf = source.cultural_framing as Record<string, any> | undefined;\r\n            if (baseline.cultural_framing && (!cf || !cf.technology_role)) {\r\n                patched.cultural_framing = baseline.cultural_framing;\r\n                needsUpdate = true;\r\n            }\r\n            if (baseline.institutional_logics && !source.institutional_logics) {\r\n                patched.institutional_logics = baseline.institutional_logics;\r\n                needsUpdate = true;\r\n            }\r\n            if (baseline.legitimacy_analysis && !source.legitimacy_analysis) {\r\n                patched.legitimacy_analysis = baseline.legitimacy_analysis; // Note: type mismatch might occur if LegitimacyAnalysis vs AnalysisResult\r\n                needsUpdate = true;\r\n            }\r\n\r\n            return patched;\r\n        }\r\n        return source;\r\n    });\r\n\r\n    if (needsUpdate) {\r\n        await saveSources(userId, patchedSources);\r\n        return patchedSources;\r\n    }\r\n\r\n    return sources;\r\n};\r\n\r\n// Save sources to Redis\r\nexport const saveSources = async (userId: string, sources: Source[]): Promise<void> => {\r\n    await StorageService.set(userId, 'sources', sources);\r\n};\r\n\r\n// Add a new source\r\nexport const addSource = async (userId: string, source: Source): Promise<Source> => {\r\n    const sources = await getSources(userId);\r\n    const newSources = [...sources, source];\r\n    await saveSources(userId, newSources);\r\n    return source;\r\n};\r\n\r\n// Update a source\r\nexport const updateSource = async (userId: string, id: string, updates: Partial<Source>): Promise<Source | null> => {\r\n    const sources = await getSources(userId);\r\n    const index = sources.findIndex(s => s.id === id);\r\n\r\n    if (index === -1) return null;\r\n\r\n    const updatedSource = { ...sources[index], ...updates };\r\n    sources[index] = updatedSource;\r\n    await saveSources(userId, sources);\r\n\r\n    return updatedSource;\r\n};\r\n\r\n// Delete a source\r\nexport const deleteSource = async (userId: string, id: string): Promise<boolean> => {\r\n    const sources = await getSources(userId);\r\n    const filteredSources = sources.filter(s => s.id !== id);\r\n\r\n    if (filteredSources.length === sources.length) return false;\r\n\r\n    await saveSources(userId, filteredSources);\r\n    return true;\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\services\\analysis.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnalyzeRequest' is defined but never used.","line":5,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalysisResult, Source, PositionalityData } from \"@/types\";\r\n\r\nexport type AnalysisMode = 'dsf' | 'cultural_framing' | 'institutional_logics' | 'resistance' | 'ecosystem' | 'ontology' | 'comparison' | 'generate_resistance' | 'cultural_holes' | 'legitimacy' | 'comparative_synthesis' | 'assemblage_extraction' | 'resistance_synthesis' | 'stress_test';\r\n\r\ninterface AnalyzeRequest {\r\n    text: string;\r\n    sourceType: string;\r\n    analysisMode?: AnalysisMode;\r\n    sourceA?: { title: string; text: string };\r\n    sourceB?: { title: string; text: string };\r\n    documents?: Source[]; // For comparative synthesis\r\n    existingAnalysis?: AnalysisResult;\r\n}\r\n\r\ninterface AnalyzeResponse {\r\n    success: boolean;\r\n    analysis: AnalysisResult;\r\n    error?: string;\r\n    details?: string;\r\n}\r\n\r\nexport const analyzeDocument = async (\r\n    text: string,\r\n    mode: AnalysisMode = 'dsf',\r\n    sourceType: string = 'Policy Document',\r\n    force: boolean = false,\r\n    documentId?: string,\r\n    title?: string,\r\n    positionality?: PositionalityData,\r\n    existingAnalysis?: AnalysisResult\r\n): Promise<AnalysisResult> => {\r\n    try {\r\n        const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n        if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID || 'demo-user';\r\n        }\r\n        console.log('analyzeDocument headers:', headers);\r\n\r\n        const response = await fetch('/api/analyze', {\r\n            method: 'POST',\r\n            headers: headers,\r\n            body: JSON.stringify({\r\n                text,\r\n                sourceType,\r\n                analysisMode: mode,\r\n                force,\r\n                documentId,\r\n                title,\r\n                positionality,\r\n                existingAnalysis\r\n            })\r\n        });\r\n\r\n        const result: AnalyzeResponse = await response.json();\r\n\r\n        if (!result.success) {\r\n            throw new Error(result.details || result.error || 'Analysis failed');\r\n        }\r\n\r\n        return result.analysis;\r\n    } catch (error) {\r\n        console.error(`Analysis error (${mode}):`, error);\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const synthesizeComparison = async (documents: Source[], lens: string = \"assemblage\"): Promise<AnalysisResult> => {\r\n    try {\r\n        const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n        if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID || 'demo-user';\r\n        }\r\n\r\n        const response = await fetch('/api/analyze', {\r\n            method: 'POST',\r\n            headers: headers,\r\n            body: JSON.stringify({\r\n                analysisMode: 'comparative_synthesis',\r\n                documents,\r\n                lens\r\n            })\r\n        });\r\n\r\n        const result: AnalyzeResponse = await response.json();\r\n\r\n        if (!result.success) {\r\n            throw new Error(result.details || result.error || 'Synthesis failed');\r\n        }\r\n\r\n        return result.analysis;\r\n    } catch (error) {\r\n        console.error('Comparative synthesis error:', error);\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const generateSearchTerms = async (insight: string): Promise<string[]> => {\r\n    try {\r\n        const headers: HeadersInit = { 'Content-Type': 'application/json' };\r\n        if (process.env.NEXT_PUBLIC_ENABLE_DEMO_MODE === 'true') {\r\n            headers['x-demo-user-id'] = process.env.NEXT_PUBLIC_DEMO_USER_ID || 'demo-user';\r\n        }\r\n\r\n        const response = await fetch('/api/generate-search-terms', {\r\n            method: 'POST',\r\n            headers: headers,\r\n            body: JSON.stringify({ insight })\r\n        });\r\n\r\n        const result = await response.json();\r\n        return result.searchTerms || [];\r\n    } catch (error) {\r\n        console.error('Search terms generation error:', error);\r\n        return [];\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\ant.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[694,697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[694,697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ANT (Actor-Network Theory) Types\r\n * These types represent the methodological layer - empirical tracing of actors and associations\r\n * \r\n * Key Principle: ANT is a METHOD for tracing networks, not an ontology\r\n */\r\n\r\nexport type TraceSource = \"document_extraction\" | \"ai_inference\" | \"user_input\";\r\n\r\nexport interface TracedActor {\r\n    id: string;\r\n    name: string;\r\n    type: string;\r\n\r\n    // ANT-specific fields\r\n    trace_source: TraceSource;\r\n    trace_evidence: string; // Quote or reference from source\r\n    provisional: boolean; // True if AI-generated\r\n    confidence: number; // 0-1\r\n\r\n    // Backward compatibility - preserve existing metrics\r\n    metrics?: Record<string, any>;\r\n}\r\n\r\nexport interface Association {\r\n    source: string;\r\n    target: string;\r\n    relation_type: \"Regulates\" | \"Funds\" | \"Excludes\" | \"Extracts\" | \"Supports\" | \"Contests\";\r\n    trace_evidence: string;\r\n    strength: number; // 0-1\r\n    provisional: boolean;\r\n}\r\n\r\nexport interface TranslationStage {\r\n    id: string;\r\n    label: string;\r\n    description: string;\r\n    actors: string[];\r\n    ontology: \"social\" | \"regulatory\" | \"technical\" | \"market\";\r\n    fidelity_score?: number;\r\n    betrayal_type?: \"Simplification\" | \"Displacement\" | \"None\";\r\n}\r\n\r\nexport interface TraceSequence {\r\n    stages: TranslationStage[];\r\n    fidelity_scores: number[];\r\n    betrayal_points: {\r\n        stage_index: number;\r\n        type: \"Simplification\" | \"Displacement\";\r\n        description: string;\r\n    }[];\r\n}\r\n\r\nexport interface ANTTraceResult {\r\n    mode: \"ant_trace\";\r\n    traced_actors: TracedActor[];\r\n    associations: Association[];\r\n    translation_sequence?: TraceSequence;\r\n    provenance_summary: string;\r\n    metadata: {\r\n        total_actors: number;\r\n        document_extracted: number;\r\n        ai_inferred: number;\r\n        user_provided: number;\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\assemblage-realist.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\assemblage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\cultural.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1045,1048],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1045,1048],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1193,1196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1193,1196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\ecosystem.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3470,3473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3470,3473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2544,2547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2544,2547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export type QualitativeMetric = \"Strong\" | \"Moderate\" | \"Weak\" | \"Latent\";\r\n\r\nexport interface ReflexiveLogEntry {\r\n    id: string;\r\n    timestamp: number;\r\n    action_type: \"Trace_Rejection\" | \"Actor_Merge\" | \"Strategic_Subtraction\" | \"Manual_Inscription\" | \"Other\";\r\n    rationale: string;\r\n    affected_actors?: string[];\r\n    user_id?: string;\r\n}\r\n\r\nexport interface EcosystemActor {\r\n    id: string;\r\n    name: string;\r\n    type: \"Startup\" | \"Policymaker\" | \"Civil Society\" | \"Academic\" | \"Infrastructure\" | \"Algorithm\" | \"Dataset\" | \"AlgorithmicAgent\" | \"LegalObject\";\r\n    description: string;\r\n    influence: \"High\" | \"Medium\" | \"Low\";\r\n    url?: string;\r\n    metrics?: {\r\n        influence: QualitativeMetric;\r\n        alignment: QualitativeMetric;\r\n        resistance: QualitativeMetric;\r\n        rationale?: string;\r\n        dynamic_power?: number; // Calculated via centrality/pagerank (internal only)\r\n        // Dimensional Breakdown (V3) - De-quantified for interpretive rigor\r\n        territoriality?: QualitativeMetric; // Power to enforce\r\n        coding?: QualitativeMetric;        // Power to define\r\n        centrality?: QualitativeMetric;    // Network reach\r\n        counter_conduct?: QualitativeMetric;    // Active subversion\r\n        discursive_opposition?: QualitativeMetric; // Critical speech\r\n    };\r\n    source?: \"default\" | \"absence_fill\";\r\n    quotes?: string[];\r\n    region?: \"Global North\" | \"Global South\" | \"International\" | \"Unknown\";\r\n    role_type?: \"Material\" | \"Expressive\" | \"Mixed\";\r\n    materialized_from?: {\r\n        source_id: string;\r\n        context_type: \"accountability\" | \"legitimacy\" | \"cultural_absence\" | \"trace\";\r\n        context_detail: string;\r\n    };\r\n\r\n    // NEW: ANT trace metadata (optional for backward compatibility)\r\n    trace_metadata?: {\r\n        source: \"document_extraction\" | \"ai_inference\" | \"user_input\";\r\n        evidence: string;\r\n        provisional: boolean;\r\n        confidence: number;\r\n    };\r\n}\r\n\r\nexport interface EcosystemConfiguration {\r\n    id: string;\r\n    name: string;\r\n    description: string;\r\n    memberIds: string[];\r\n    properties: {\r\n        stability: \"High\" | \"Medium\" | \"Low\";\r\n        generativity: \"High\" | \"Medium\" | \"Low\";\r\n        calculated_stability?: number; // 0-1 (Internal density)\r\n        porosity_index?: number; // 0-1 (External connections / Total connections)\r\n        [key: string]: string | number | undefined;\r\n    };\r\n    color: string;\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    analysisData?: any; // To store full AssemblageExtractionResult\r\n    reflexive_log?: ReflexiveLogEntry[];\r\n}\r\n\r\n\r\n\r\nexport interface AssemblageAnalysis {\r\n    narrative: string;\r\n    missing_voices: { name: string; reason: string; category: string }[];\r\n    structural_voids: string[];\r\n    blindspot_intensity: \"Low\" | \"Medium\" | \"High\";\r\n    socio_technical_components: {\r\n        infra: string[];\r\n        discourse: string[];\r\n    };\r\n    policy_mobilities: {\r\n        origin_concepts: string[];\r\n        local_mutations: string[];\r\n    };\r\n    stabilization_mechanisms: string[];\r\n    relations_of_exteriority?: {\r\n        detachable: string[];\r\n        embedded: string[];\r\n        mobility_score: \"High\" | \"Medium\" | \"Low\";\r\n    };\r\n    provisional_status?: import('./provisional').ProvisionalInscription;\r\n    computed_metrics?: {\r\n        territorialization_audit?: string[];\r\n        coding_audit?: string[];\r\n    };\r\n    traces?: any[]; // To store ANT trace objects if included\r\n}\r\n\r\nexport interface AiAbsenceAnalysis {\r\n    narrative: string;\r\n    missing_voices: { name: string; reason: string; category: string }[];\r\n    structural_voids: string[];\r\n    blindspot_intensity: \"Low\" | \"Medium\" | \"High\";\r\n    recommendations?: string[];\r\n    blindspots?: string[]; // Legacy field support\r\n}\r\n\r\nexport interface TranslationStage {\r\n    id: string;\r\n    label: string;\r\n    description: string;\r\n    actors: string[];\r\n    ontology: \"social\" | \"regulatory\" | \"technical\" | \"market\";\r\n    required_actor_types?: string[]; // Types of actors expected in this stage (e.g. ['Policy', 'NGO'])\r\n    fidelity_score?: number; // 0-1, calculated dynamically\r\n    betrayal_type?: \"Simplification\" | \"Displacement\" | \"None\";\r\n    active_actor_count?: number; // The logic-based count of actors present in this stage\r\n}\r\n\r\nexport interface AssemblageExplanationHull {\r\n    id: string;\r\n    classification: \"Fortress\" | \"Sieve\" | \"Meshwork\" | string;\r\n    interpretation: string;\r\n}\r\n\r\nexport interface AssemblageExplanation {\r\n    narrative: string;\r\n    hulls: AssemblageExplanationHull[];\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\logs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\ontology.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\provisional.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1135,1138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1135,1138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1184,1187],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1184,1187],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Provisional Inscription Types\r\n * Represents AI outputs with acknowledged fragility and contestability\r\n * \r\n * Key Principle: AI outputs are PROVISIONAL, not authoritative\r\n */\r\n\r\nexport interface FragilityScore {\r\n    value: number; // 0-1 (1 = highly fragile)\r\n    factors: {\r\n        input_completeness: number;\r\n        model_uncertainty: number;\r\n        theoretical_tension: number;\r\n        empirical_grounding: number;\r\n    };\r\n    interpretation: \"stable\" | \"contested\" | \"provisional\" | \"speculative\";\r\n}\r\n\r\nexport interface ProvisionalInscription {\r\n    content: string;\r\n    source: \"ai_generated\" | \"user_validated\" | \"document_extracted\";\r\n\r\n    fragility_score: FragilityScore;\r\n    authority_conditions: string[]; // When this gains traction\r\n    contestation_risks: string[]; // How it could be contested\r\n\r\n    alternative_interpretations?: {\r\n        interpretation: string;\r\n        theoretical_basis: string;\r\n        plausibility: number;\r\n    }[];\r\n\r\n    created_at: string;\r\n    last_contested_at?: string;\r\n}\r\n\r\nexport interface HybridAnalysisResult {\r\n    mode: \"hybrid_reflexive\";\r\n\r\n    ant_trace: any; // From ANT layer\r\n    assemblage_analysis: any; // From Assemblage layer\r\n\r\n    theoretical_tensions: {\r\n        description: string;\r\n        latour_would_reject: string;\r\n        delanda_requires: string;\r\n        our_instrumentalization: string;\r\n    }[];\r\n\r\n    provisional_status: ProvisionalInscription;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\report.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\resistance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\types\\synthesis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\utils\\generateFullReportDOCX.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UnderlineType' is defined but never used.","line":1,"column":77,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":90},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2112,2115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2112,2115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":257,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":257,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8745,8748],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8745,8748],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":278,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9660,9663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9660,9663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":297,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":297,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10580,10583],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10580,10583],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":303,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":303,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10788,10791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10788,10791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":314,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":314,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11244,11247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11244,11247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":342,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":342,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12641,12644],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12641,12644],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":379,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":379,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14414,14417],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14414,14417],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":389,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":389,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14857,14860],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14857,14860],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":400,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":400,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15561,15564],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15561,15564],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":453,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":453,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":480,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":480,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":573,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":573,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24426,24429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24426,24429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":583,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":583,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25631,25634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25631,25634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":632,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":632,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29251,29254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29251,29254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":650,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":650,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29986,29989],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29986,29989],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":665,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":665,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30787,30790],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30787,30790],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":678,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":678,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31376,31379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31376,31379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":689,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":689,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31954,31957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31954,31957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":701,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":701,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32604,32607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32604,32607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":730,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":730,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33888,33891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33888,33891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":735,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":735,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34126,34129],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34126,34129],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":746,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":746,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34613,34616],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34613,34616],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":762,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":762,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35258,35261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35258,35261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":770,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":770,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35618,35621],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35618,35621],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":822,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":822,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37811,37814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37811,37814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":839,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":839,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38948,38951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38948,38951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":868,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":868,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40406,40409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40406,40409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":877,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":877,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40847,40850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40847,40850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":886,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":886,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41197,41200],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41197,41200],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":921,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":921,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43366,43369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43366,43369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":938,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":938,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43928,43931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43928,43931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":948,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":948,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44489,44492],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44489,44492],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":957,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":957,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44821,44824],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44821,44824],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":964,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":964,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45367,45370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45367,45370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":988,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":988,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[46103,46106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[46103,46106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":989,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":989,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[46140,46143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[46140,46143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":996,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":996,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[46480,46483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[46480,46483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1007,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1007,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47062,47065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47062,47065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1009,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1009,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47198,47201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47198,47201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1010,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1010,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47304,47307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47304,47307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1020,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1020,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47798,47801],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47798,47801],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1027,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1027,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[48144,48147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[48144,48147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1046,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1046,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[49100,49103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[49100,49103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'k' is defined but never used.","line":1148,"column":71,"nodeType":null,"messageId":"unusedVar","endLine":1148,"endColumn":72},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'k' is defined but never used.","line":1154,"column":71,"nodeType":null,"messageId":"unusedVar","endLine":1154,"endColumn":72},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1232,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1232,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57562,57565],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57562,57565],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1257,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1257,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58732,58735],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58732,58735],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1332,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1332,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62200,62203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62200,62203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1340,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1340,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62521,62524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62521,62524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1345,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1345,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62714,62717],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62714,62717],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1370,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1370,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[63935,63938],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[63935,63938],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'scenarioId' is defined but never used.","line":1378,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":1378,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1378,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1378,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[64386,64389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[64386,64389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1395,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1395,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65059,65062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65059,65062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1402,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1402,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65369,65372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65369,65372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":1402,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":1402,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1426,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1426,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[66462,66465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[66462,66465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1443,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1443,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67212,67215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67212,67215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":1528,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":1528,"endColumn":46,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[70226,70263],"text":"// @ts-expect-error - Private method access"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":54,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, UnderlineType, BorderStyle, Table, TableRow, TableCell, WidthType } from \"docx\";\r\nimport { saveAs } from \"file-saver\";\r\n// import { Source } from \"../types\"; // Imported via ReportData\r\nimport { ReportData, ReportSectionSelection } from \"../types/report\";\r\nimport { Source } from \"../types\";\r\nimport { CulturalAnalysisResult } from \"../types/cultural\";\r\nimport { calculateMicroFascismRisk } from \"../lib/risk-calculator\";\r\nimport { calculateLiberatoryCapacity } from \"../lib/liberatory-calculator\";\r\n\r\n// --- Configuration ---\r\n\r\nconst STYLE = {\r\n    fonts: {\r\n        normal: \"Helvetica\",\r\n        header: \"Helvetica\",\r\n    },\r\n    colors: {\r\n        primary: \"0F172A\",   // Slate 900\r\n        secondary: \"334155\", // Slate 700\r\n        text: \"000000\",      // Black\r\n        meta: \"64748B\",      // Slate 500\r\n        subtle: \"94A3B8\",    // Slate 400\r\n        accent: \"F1F5F9\",    // Slate 100\r\n        danger: \"B91C1C\",    // Red 700\r\n        success: \"15803D\",   // Green 700\r\n    },\r\n    sizes: {\r\n        title: 48,      // 24pt\r\n        header: 32,     // 16pt\r\n        section: 28,    // 14pt (Increased slightly)\r\n        subHeader: 24,  // 12pt\r\n        body: 22,       // 11pt\r\n        meta: 18,       // 9pt\r\n        small: 16,      // 8pt\r\n    },\r\n    spacing: {\r\n        lineHeight: 1.15,\r\n        paragraph: 200,\r\n    }\r\n};\r\n\r\n// --- Helper Functions ---\r\n\r\nfunction sanitizeText(text: string): string {\r\n    if (!text) return \"\";\r\n\r\n    let clean = text\r\n        .replace(/[\\u2018\\u2019]/g, \"'\")\r\n        .replace(/[\\u201C\\u201D]/g, '\"')\r\n        .replace(/[\\u2013\\u2014]/g, \"-\")\r\n        .replace(/\\u2026/g, \"...\")\r\n        .replace(/[\\u00A0\\u200B\\u202F\\u205F]/g, \" \");\r\n\r\n    clean = clean\r\n        .replace(/\\*\\*/g, \"\")\r\n        .replace(/^#+\\s/gm, \"\")\r\n        .replace(/`/g, \"\")\r\n        .replace(/\\[(.*?)\\]\\(.*?\\)/g, \"$1\")\r\n        .replace(/\\*/g, \"\");\r\n\r\n    clean = clean.replace(/^- /gm, \"â€¢ \");\r\n\r\n    return clean;\r\n}\r\n\r\n// --- Report Generator Class ---\r\n\r\nclass ReportGeneratorDOCX {\r\n    private sections: any[] = [];\r\n\r\n    constructor() { }\r\n\r\n    public addTitlePage(title: string, subtitle: string) {\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: title,\r\n                heading: HeadingLevel.TITLE,\r\n                alignment: AlignmentType.CENTER,\r\n                spacing: { before: 4000, after: 300 },\r\n                run: {\r\n                    font: STYLE.fonts.header,\r\n                    color: STYLE.colors.primary,\r\n                    size: STYLE.sizes.title,\r\n                    bold: true,\r\n                }\r\n            })\r\n        );\r\n\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: subtitle,\r\n                alignment: AlignmentType.CENTER,\r\n                spacing: { after: 300 },\r\n                run: {\r\n                    font: STYLE.fonts.normal,\r\n                    color: STYLE.colors.meta,\r\n                    size: STYLE.sizes.subHeader,\r\n                }\r\n            })\r\n        );\r\n\r\n        const dateStr = `Generated: ${new Date().toLocaleDateString(\"en-US\", { year: \"numeric\", month: \"long\", day: \"numeric\" })}`;\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: dateStr,\r\n                alignment: AlignmentType.CENTER,\r\n                run: {\r\n                    font: STYLE.fonts.normal,\r\n                    color: STYLE.colors.meta,\r\n                    size: STYLE.sizes.body,\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    public addPageBreak() {\r\n        this.sections.push(new Paragraph({\r\n            children: [new TextRun({ break: 1 })],\r\n            pageBreakBefore: true\r\n        }));\r\n    }\r\n\r\n    public addSectionHeader(title: string, pageBreak: boolean = false) {\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: title.toUpperCase(),\r\n                heading: HeadingLevel.HEADING_1,\r\n                spacing: { before: 300, after: 150 },\r\n                pageBreakBefore: pageBreak,\r\n                run: {\r\n                    font: STYLE.fonts.header,\r\n                    color: STYLE.colors.primary,\r\n                    size: STYLE.sizes.section,\r\n                    bold: true,\r\n                },\r\n                border: {\r\n                    bottom: { color: STYLE.colors.accent, space: 1, style: BorderStyle.SINGLE, size: 12 }\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    public addSubHeader(title: string) {\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: title,\r\n                heading: HeadingLevel.HEADING_2,\r\n                spacing: { before: 200, after: 100 },\r\n                run: {\r\n                    font: STYLE.fonts.header,\r\n                    color: STYLE.colors.primary,\r\n                    size: STYLE.sizes.subHeader,\r\n                    bold: true,\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    public addText(text: string | null | undefined, color: string = STYLE.colors.text, indent: number = 0, bold: boolean = false) {\r\n        if (!text) return;\r\n\r\n        const cleanContent = sanitizeText(text);\r\n        const paragraphs = cleanContent.split('\\n');\r\n\r\n        paragraphs.forEach(p => {\r\n            let content = p.trim();\r\n            if (!content) return;\r\n\r\n            const isBullet = content.startsWith(\"â€¢\");\r\n            if (isBullet) {\r\n                content = content.replace(/^[â€¢\\s]+/, \"\").trim();\r\n            }\r\n\r\n            this.sections.push(\r\n                new Paragraph({\r\n                    text: content,\r\n                    bullet: isBullet ? { level: 0 } : undefined,\r\n                    indent: isBullet ? undefined : { left: indent * 100 },\r\n                    spacing: { after: 120 },\r\n                    run: {\r\n                        font: STYLE.fonts.normal,\r\n                        color: color,\r\n                        size: STYLE.sizes.body,\r\n                        bold: bold,\r\n                    }\r\n                })\r\n            );\r\n        });\r\n    }\r\n\r\n    public addSpacer() {\r\n        this.sections.push(new Paragraph({ text: \"\" }));\r\n    }\r\n\r\n    // --- Specific Section Renderers ---\r\n\r\n    public renderSourceAnalysis(source: Source, index: number) {\r\n        const titleRun = new TextRun({\r\n            text: `${index}. ${source.title}`,\r\n            font: STYLE.fonts.header,\r\n            color: STYLE.colors.primary,\r\n            size: STYLE.sizes.header,\r\n            bold: true,\r\n        });\r\n\r\n        this.sections.push(\r\n            new Paragraph({\r\n                children: [titleRun],\r\n                spacing: { before: 400, after: 200 },\r\n                pageBreakBefore: true,\r\n                shading: {\r\n                    fill: STYLE.colors.accent,\r\n                    type: \"clear\",\r\n                    color: \"auto\",\r\n                },\r\n                border: {\r\n                    left: { color: STYLE.colors.primary, space: 10, style: BorderStyle.SINGLE, size: 6 }\r\n                }\r\n            })\r\n        );\r\n\r\n        const metaText = `TYPE: ${source.type.toUpperCase()}  |  ADDED: ${source.addedDate}  |  STATUS: ${source.status}`;\r\n        this.sections.push(\r\n            new Paragraph({\r\n                text: metaText,\r\n                spacing: { after: 400 },\r\n                run: {\r\n                    font: STYLE.fonts.normal,\r\n                    color: STYLE.colors.meta,\r\n                    size: STYLE.sizes.meta,\r\n                }\r\n            })\r\n        );\r\n\r\n        // 1. Core Analysis (Governance, etc)\r\n        if (source.analysis || source.cultural_framing || source.institutional_logics || source.legitimacy_analysis) {\r\n            // ... Logic from previous implementation ...\r\n            this.renderExistingAnalysisSections(source);\r\n\r\n            // NEW: Data Page Specific Sections\r\n            this.renderDataPageCalculations(source);\r\n        } else if (source.resistance_analysis) {\r\n            // 1b. Resistance Trace Analysis\r\n            this.renderResistanceTrace(source);\r\n        } else {\r\n            this.addText(\"No analysis data available for this source.\", STYLE.colors.subtle);\r\n        }\r\n    }\r\n\r\n    private renderExistingAnalysisSections(source: Source) {\r\n        if (source.cultural_framing) this.renderCulturalFraming(source.cultural_framing);\r\n        if (source.institutional_logics) this.renderInstitutionalLogics(source.institutional_logics);\r\n        if (source.legitimacy_analysis) this.renderLegitimacyAnalysis(source.legitimacy_analysis);\r\n        if (source.analysis) this.renderGovernanceAnalysis(source.analysis);\r\n    }\r\n\r\n    private renderCulturalFraming(framing: any) {\r\n        this.addSubHeader(\"Cultural Framing Analysis\");\r\n\r\n        if (framing.state_market_society) {\r\n            this.addText(\"State-Market-Society Relations:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(framing.state_market_society);\r\n        }\r\n        if (framing.technology_role) {\r\n            this.addText(\"Role of Technology:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(framing.technology_role);\r\n        }\r\n        if (framing.rights_conception) {\r\n            this.addText(\"Conception of Rights:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(framing.rights_conception);\r\n        }\r\n        if (framing.dominant_cultural_logic) {\r\n            this.addText(\"Dominant Cultural Logic:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(framing.dominant_cultural_logic);\r\n        }\r\n    }\r\n\r\n    private renderInstitutionalLogics(logics: any) {\r\n        this.addSubHeader(\"Institutional Logics\");\r\n\r\n        if (logics.dominant_logic) {\r\n            this.addText(\"Dominant Logic: \" + logics.dominant_logic, STYLE.colors.primary, 0, true);\r\n        }\r\n\r\n        if (logics.logics) {\r\n            const l = logics.logics;\r\n            let stats = \"\";\r\n            if (l.market) stats += `â€¢ Market Logic: ${l.market.strength}/10\\n`;\r\n            if (l.state) stats += `â€¢ State Logic: ${l.state.strength}/10\\n`;\r\n            if (l.professional) stats += `â€¢ Professional Logic: ${l.professional.strength}/10\\n`;\r\n            if (l.community) stats += `â€¢ Community Logic: ${l.community.strength}/10`;\r\n            this.addText(stats);\r\n        }\r\n\r\n        if (logics.logic_conflicts && logics.logic_conflicts.length > 0) {\r\n            this.addText(\"Key Institutional Conflicts:\", STYLE.colors.secondary, 0, true);\r\n            logics.logic_conflicts.forEach((c: any) => {\r\n                this.addText(`â€¢ ${c.between}: ${c.site_of_conflict} (Resolution: ${c.resolution_strategy})`);\r\n            });\r\n        }\r\n    }\r\n\r\n    private renderLegitimacyAnalysis(legitimacy: any) {\r\n        this.addSubHeader(\"Legitimacy Analysis\");\r\n\r\n        if (legitimacy.dominant_order) {\r\n            let domOrder = legitimacy.dominant_order;\r\n            if (typeof domOrder === 'object') domOrder = \"Mixed/Complex Orders\";\r\n            this.addText(\"Dominant Order: \" + domOrder, STYLE.colors.primary, 0, true);\r\n        }\r\n\r\n        if (legitimacy.orders) {\r\n            const o = legitimacy.orders;\r\n            const formatScore = (val: any) => {\r\n                if (typeof val === 'object' && val !== null) {\r\n                    return val.score || val.value || val.strength || \"N/A\";\r\n                }\r\n                return val;\r\n            };\r\n\r\n            const scores = `â€¢ Market: ${formatScore(o.market)}   â€¢ Industrial: ${formatScore(o.industrial)}   â€¢ Civic: ${formatScore(o.civic)}\\nâ€¢ Domestic: ${formatScore(o.domestic)}   â€¢ Inspired: ${formatScore(o.inspired)}   â€¢ Fame: ${formatScore(o.fame)}`;\r\n            this.addText(scores);\r\n        }\r\n\r\n        if (legitimacy.conflict_spot) {\r\n            this.addText(\"Conflict Spot:\", STYLE.colors.secondary, 0, true);\r\n            const conflict = legitimacy.conflict_spot;\r\n            let conflictDesc = \"\";\r\n\r\n            if (typeof conflict === 'string') {\r\n                conflictDesc = conflict;\r\n            } else {\r\n                if (conflict.course_of_action) conflictDesc += `Location: ${conflict.location}\\n`;\r\n                if (conflict.location && !conflict.course_of_action) conflictDesc += `Location: ${conflict.location}\\n`;\r\n                if (conflict.description) conflictDesc += `${conflict.description}\\n`;\r\n                if (conflict.resolution_strategy) conflictDesc += `Strategy: ${conflict.resolution_strategy}`;\r\n            }\r\n            this.addText(conflictDesc);\r\n        }\r\n    }\r\n\r\n    private renderGovernanceAnalysis(analysis: any) {\r\n        if (!analysis.governance_scores) return;\r\n\r\n        this.addSubHeader(\"Governance Compass & Decolonial Analysis (DSF)\");\r\n\r\n        const g = analysis.governance_scores;\r\n        const gScores = `â€¢ Centralization: ${g.centralization}\\nâ€¢ Rights Focus: ${g.rights_focus}\\nâ€¢ Flexibility: ${g.flexibility}\\nâ€¢ Market Power: ${g.market_power}\\nâ€¢ Procedurality: ${g.procedurality}`;\r\n        this.addText(gScores);\r\n\r\n        if (analysis.key_insight) {\r\n            this.addText(\"Key Insight:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(analysis.key_insight);\r\n        }\r\n\r\n        // Qualitative Analysis Fields\r\n        if (analysis.governance_power_accountability) {\r\n            this.addText(\"Governance, Power & Accountability:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(analysis.governance_power_accountability);\r\n        }\r\n        if (analysis.plurality_inclusion_embodiment) {\r\n            this.addText(\"Plurality & Inclusion:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(analysis.plurality_inclusion_embodiment);\r\n        }\r\n        if (analysis.agency_codesign_self_determination) {\r\n            this.addText(\"Agency & Self-Determination:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(analysis.agency_codesign_self_determination);\r\n        }\r\n        if (analysis.reflexivity_situated_praxis) {\r\n            this.addText(\"Reflexivity & Situated Praxis:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(analysis.reflexivity_situated_praxis);\r\n        }\r\n\r\n        this.renderAssemblageDynamics(analysis);\r\n        this.renderStructuralPillars(analysis);\r\n        this.renderGovernanceScoreExplanations(analysis);\r\n    }\r\n\r\n    private renderAssemblageDynamics(analysis: any) {\r\n        if (analysis.assemblage_dynamics) {\r\n            this.addSubHeader(\"Assemblage Dynamics\");\r\n            const dyn = analysis.assemblage_dynamics;\r\n            this.addText(`â€¢ Territorialization: ${dyn.territorialization}`);\r\n            this.addText(`â€¢ Deterritorialization: ${dyn.deterritorialization}`);\r\n            this.addText(`â€¢ Coding: ${dyn.coding}`);\r\n        }\r\n    }\r\n\r\n    private renderStructuralPillars(analysis: any) {\r\n        if (analysis.structural_pillars) {\r\n            this.addSubHeader(\"Structural Pillars\");\r\n            const pillars = analysis.structural_pillars;\r\n            if (pillars.risk) this.addText(`Risk: ${pillars.risk.description} (${pillars.risk.badge})`);\r\n            if (pillars.rights) this.addText(`Rights: ${pillars.rights.description} (${pillars.rights.badge})`);\r\n            if (pillars.enforcement) this.addText(`Enforcement: ${pillars.enforcement.description} (${pillars.enforcement.badge})`);\r\n            if (pillars.scope) this.addText(`Scope: ${pillars.scope.description} (${pillars.scope.badge})`);\r\n        }\r\n    }\r\n\r\n    private renderGovernanceScoreExplanations(analysis: any) {\r\n        if (analysis.governance_score_explanations) {\r\n            this.addText(\"Score Explanations:\", STYLE.colors.secondary, 0, true);\r\n            const e = analysis.governance_score_explanations;\r\n            let expl = \"\";\r\n            if (e.centralization) expl += `â€¢ Centralization: ${e.centralization}\\n`;\r\n            if (e.rights_focus) expl += `â€¢ Rights Focus: ${e.rights_focus}\\n`;\r\n            if (e.flexibility) expl += `â€¢ Flexibility: ${e.flexibility}`;\r\n            if (e.market_power) expl += `\\nâ€¢ Market Power: ${e.market_power}`;\r\n            if (e.procedurality) expl += `\\nâ€¢ Procedurality: ${e.procedurality}`;\r\n            if (e.coloniality) expl += `\\nâ€¢ Coloniality: ${e.coloniality}`;\r\n            this.addText(expl);\r\n        }\r\n    }\r\n\r\n    private renderDataPageCalculations(source: Source) {\r\n        if (!source.analysis) return;\r\n\r\n        // 0. Decision Ownership & Accountability - Narrative First\r\n        if (source.analysis.accountability_map) {\r\n            this.addSubHeader(\"Decision Ownership & Accountability\");\r\n            const acc = source.analysis.accountability_map;\r\n\r\n            // Build interpretive narrative\r\n            const hasFullAccountability = acc.signatory && acc.liability_holder && acc.appeals_mechanism;\r\n            const narrative = hasFullAccountability\r\n                ? `Accountability chains are formalized through explicit designation of ${acc.signatory} as signatory authority, with liability assigned to ${acc.liability_holder}. Appeals mechanisms (${acc.appeals_mechanism}) provide contestation pathways, suggesting robust procedural accountability architecture.`\r\n                : `Accountability structures exhibit gaps or ambiguities. ${acc.signatory ? `While ${acc.signatory} serves as formal signatory, ` : 'Signatory authority remains unspecified, and '}${acc.liability_holder ? `liability rests with ${acc.liability_holder}, ` : 'liability assignment is unclear, '}creating potential enforcement weaknesses.`;\r\n\r\n            this.addText(narrative);\r\n            this.addSpacer();\r\n\r\n            // Supporting details (subtle)\r\n            if (acc.human_in_the_loop !== undefined) {\r\n                this.addText(`  â†’ Human oversight: ${acc.human_in_the_loop ? 'Required' : 'Not mandated'}`, STYLE.colors.subtle, 1);\r\n            }\r\n        }\r\n\r\n        // Calculate risk and capacity first as they are used in multiple sections\r\n        const risk = calculateMicroFascismRisk(source.analysis);\r\n        const capacity = calculateLiberatoryCapacity(source.analysis);\r\n\r\n        // 1. Authoritarian Tendencies - Interpretive Narrative\r\n        if (risk) {\r\n            this.addSubHeader(\"Authoritarian Tendencies Analysis\");\r\n\r\n            // Lead with rich interpretation\r\n            const narrative = this.interpretRiskNarrative(risk);\r\n            this.addText(narrative);\r\n            this.addSpacer();\r\n\r\n            // Evidence from observed indicators\r\n            const triggeredFlags = Object.entries(risk.flags)\r\n                .filter(([_, val]) => val)\r\n                .map(([key]) => key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()));\r\n\r\n            if (triggeredFlags.length > 0) {\r\n                this.addText(\"Observed Indicators:\", STYLE.colors.secondary, 0, true);\r\n                triggeredFlags.forEach(flag => {\r\n                    this.addText(`  â†’ ${flag}`, undefined, 1);\r\n                });\r\n                this.addSpacer();\r\n            }\r\n\r\n            // Score goes to parenthetical reference\r\n            this.addText(`(Parametric summary: ${risk.score}/6 ${risk.level} - see methodological appendix)`, STYLE.colors.meta, 0, false);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // 2. Liberatory Capacity - Interpretive Narrative\r\n        if (capacity) {\r\n            this.addSubHeader(\"Liberatory Capacity Assessment\");\r\n\r\n            // Lead with interpretation\r\n            const narrative = this.interpretCapacityNarrative(capacity);\r\n            this.addText(narrative);\r\n            this.addSpacer();\r\n\r\n            // Evidence from active signals\r\n            const triggeredSignals = Object.entries(capacity.signals)\r\n                .filter(([_, val]) => val)\r\n                .map(([key]) => key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()));\r\n\r\n            if (triggeredSignals.length > 0) {\r\n                this.addText(\"Enabling Conditions:\", STYLE.colors.secondary, 0, true);\r\n                triggeredSignals.forEach(signal => {\r\n                    this.addText(`  â†’ ${signal}`, undefined, 1);\r\n                });\r\n                this.addSpacer();\r\n            }\r\n\r\n            // Score parenthetical\r\n            this.addText(`(Parametric summary: ${capacity.score}/8 ${capacity.level})`, STYLE.colors.meta, 0, false);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // 3. Verification Gap - Narrative First\r\n        if (source.analysis.verification_gap) {\r\n            this.addSubHeader(\"Rhetorical-Empirical Alignment\");\r\n            const gap = source.analysis.verification_gap;\r\n\r\n            // Interpretive narrative\r\n            const narrative = gap.high_rhetoric_low_verification\r\n                ? `A significant rhetorical-empirical gap emerges where aspirational language outpaces concrete enforcement mechanisms. ${gap.gap_explanation} This disconnect between text and practice creates space for symbolic compliance while substantive accountability remains elusive.`\r\n                : `Claims are grounded in verifiable mechanisms, creating aligned rhetoric and enforcement. ${gap.gap_explanation} This coherence between stated intentions and operational capacity suggests the assemblage can deliver on its commitments.`;\r\n\r\n            this.addText(narrative);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // 4. Counter-Narrative Stress Test - Narrative First\r\n        if (source.analysis.stress_test_report) {\r\n            this.addSubHeader(\"Rhetorical Robustness Assessment\");\r\n            const stress = source.analysis.stress_test_report;\r\n\r\n            // Lead with interpretive narrative\r\n            const narrative = this.interpretStressTestNarrative(\r\n                stress.framing_sensitivity,\r\n                stress.original_score,\r\n                stress.perturbed_score\r\n            );\r\n            this.addText(narrative);\r\n            this.addSpacer();\r\n\r\n            // Supporting evidence - rhetorical shifts\r\n            if (stress.rhetorical_shifts && stress.rhetorical_shifts.length > 0) {\r\n                this.addText(\"Key Rhetorical Transformations:\", STYLE.colors.secondary, 0, true);\r\n                stress.rhetorical_shifts.forEach(shift => {\r\n                    this.addText(`  â†’ \"${shift.original}\" reframed as \"${shift.new}\"`, undefined, 1);\r\n                    if (shift.explanation) {\r\n                        this.addText(`    (${shift.explanation})`, STYLE.colors.subtle, 2);\r\n                    }\r\n                });\r\n                this.addSpacer();\r\n            }\r\n\r\n            // Score as parenthetical\r\n            this.addText(`(Score shift: ${stress.original_score} â†’ ${stress.perturbed_score}, Sensitivity: ${stress.framing_sensitivity})`, STYLE.colors.meta, 0, false);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // 5. System Critique (Blind Spots) - Already narrative-heavy\r\n        if (source.analysis.system_critique) {\r\n            this.addSubHeader(\"Reflexive Critique & Epistemological Limits\");\r\n            const critique = source.analysis.system_critique;\r\n\r\n            if (critique.blind_spots && critique.blind_spots.length > 0) {\r\n                this.addText(\"Potential Blind Spots:\", STYLE.colors.danger, 0, true);\r\n                critique.blind_spots.forEach(spot => this.addText(`  â†’ ${spot}`, undefined, 1));\r\n                this.addSpacer();\r\n            }\r\n\r\n            if (critique.legitimacy_correction) {\r\n                this.addText(\"Legitimacy Correction:\", STYLE.colors.secondary, 0, true);\r\n                this.addText(critique.legitimacy_correction);\r\n                this.addSpacer();\r\n            }\r\n        }\r\n\r\n        // 6. Canonical Evidence - Narrative context\r\n        if (source.analysis.verified_quotes && source.analysis.verified_quotes.length > 0) {\r\n            this.addSubHeader(\"Canonical Evidence\");\r\n            this.addText(\"The following textual anchors ground the above interpretations:\");\r\n            this.addSpacer();\r\n\r\n            source.analysis.verified_quotes.forEach((quote, idx) => {\r\n                this.addText(`[${idx + 1}] \"${quote.text}\"`, STYLE.colors.secondary, 0, false);\r\n                this.addText(`    Context: ${quote.context} (Confidence: ${quote.confidence})`, STYLE.colors.meta, 1);\r\n            });\r\n        }\r\n    }\r\n\r\n    // New helper methods for narrative interpretation\r\n    private interpretRiskNarrative(risk: any): string {\r\n        if (risk.level === 'High') {\r\n            return \"The assemblage exhibits pronounced authoritarian characteristics, manifested through exclusionary boundaries, opaque decision-making, and punitive enforcement mechanisms that concentrate power while marginalizing affected communities. These dynamics create conditions for micro-fascist organizing where bureaucratic authority supersedes democratic accountability.\";\r\n        } else if (risk.level === 'Medium') {\r\n            return \"Moderate authoritarian tendencies emerge in bureaucratic rigidity and limited participatory channels, though countervailing democratic elements provide some accountability. The assemblage oscillates between technocratic efficiency and inclusive governance, creating friction points where power concentrates.\";\r\n        } else {\r\n            return \"The assemblage demonstrates democratic robustness with distributed authority, transparent procedures, and meaningful participation mechanisms. While not without hierarchies, power relations remain contestable and subject to procedural checks that prevent authoritarian drift.\";\r\n        }\r\n    }\r\n\r\n    private interpretCapacityNarrative(capacity: any): string {\r\n        if (capacity.level === 'High') {\r\n            return \"The assemblage creates substantive openings for emancipatory practice through collective rights frameworks, participatory governance structures, and explicit recognition of marginalized epistemologies. These enabling conditions support bottom-up organizing and resist neoliberal enclosure of political possibility.\";\r\n        } else if (capacity.level === 'Medium') {\r\n            return \"Liberatory potential exists but remains constrained by institutional inertia and market logics. While formal rights and consultation mechanisms provide some agency, systemic barriers limit transformative capacity. The assemblage offers tactical openings rather than strategic reconfigurations of power.\";\r\n        } else {\r\n            return \"Limited liberatory capacity emerges within a predominantly technocratic framework that forecloses radical alternatives. Participation channels privilege expert knowledge over lived experience, and accountability mechanisms reinforce existing hierarchies rather than enabling collective self-determination.\";\r\n        }\r\n    }\r\n\r\n    private interpretStressTestNarrative(\r\n        sensitivity: 'High' | 'Medium' | 'Low',\r\n        originalScore: number,\r\n        perturbedScore: number\r\n    ): string {\r\n        const shift = Math.abs(originalScore - perturbedScore);\r\n\r\n        if (sensitivity === 'High') {\r\n            return `Critical fragility detected: the assemblage's authority collapses under rhetorical inversion (${shift}-point degradation), revealing dependence on persuasive framing rather than robust structural mechanisms. This brittleness suggests the policy relies more on ideological legitimation than material accountability, making it vulnerable to hostile interpretation or bad-faith implementation.`;\r\n        } else if (sensitivity === 'Medium') {\r\n            return `Moderate rhetorical dependency emerges through adversarial reframing (${shift}-point shift). While the assemblage possesses some structural integrity, hostile actors could exploit framing ambiguities to weaken its authority. This suggests a need for more concrete enforcement mechanisms to insulate governance from interpretive manipulation.`;\r\n        } else {\r\n            return `Robust structural resilience withstands rhetorical inversion with minimal degradation (${shift}-point variance). The assemblage's authority derives from concrete mechanisms and specific mandates rather than aspirational language, enabling it to resist hostile spin and maintain operational coherence across varied interpretive contexts.`;\r\n        }\r\n    }\r\n\r\n    private renderResistanceTrace(source: Source) {\r\n        if (!source.resistance_analysis) return;\r\n\r\n        const r = source.resistance_analysis;\r\n        this.addSubHeader(\"Micro-Resistance Trace Analysis\");\r\n\r\n        this.addText(`Strategy: ${r.strategy_detected}`, STYLE.colors.primary, 0, true);\r\n        this.addText(`Confidence: ${r.confidence}`, r.confidence === 'High' ? STYLE.colors.success : STYLE.colors.secondary, 0, true);\r\n\r\n        if (r.evidence_quote) {\r\n            this.addText(`Evidence: \"${r.evidence_quote}\"`, STYLE.colors.subtle, 1);\r\n        }\r\n\r\n        if (r.interpretation) {\r\n            this.addText(\"Interpretation:\", STYLE.colors.secondary, 0, true);\r\n            this.addText(r.interpretation);\r\n        }\r\n    }\r\n\r\n    public renderCrossCaseSynthesis(data: ReportData[\"synthesis\"]) {\r\n        if (!data || !data.comparison) return;\r\n        this.addSectionHeader(\"Cross-Case Synthesis\", true);\r\n\r\n        const comp = data.comparison as any; // Using any for ComparativeSynthesis fields\r\n\r\n        // Synthesis Summary (Relational Summary)\r\n        if (comp.synthesis_summary) {\r\n            this.addSubHeader(\"Relational Summary\");\r\n            this.addText(comp.synthesis_summary);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Executive Matrix\r\n        this.renderSynthesisMatrix(comp);\r\n\r\n        // Concept Mutations (Policy Mobilities)\r\n        if (comp.concept_mutations && comp.concept_mutations.length > 0) {\r\n            this.addSubHeader(\"Policy Mobilities & Concept Mutations\");\r\n            this.addText(\"How concepts travel and mutate across jurisdictions:\");\r\n            this.addSpacer();\r\n\r\n            comp.concept_mutations.forEach((mutation: any) => {\r\n                this.addText(`â€¢ ${mutation.concept}`, STYLE.colors.primary, 0, true);\r\n                this.addText(`Origin: ${mutation.origin_context}`, undefined, 1);\r\n                this.addText(`Local Mutation: ${mutation.local_mutation}`, undefined, 1);\r\n                this.addText(`Mechanism: ${mutation.mechanism}`, STYLE.colors.subtle, 1);\r\n                this.addSpacer();\r\n            });\r\n        }\r\n\r\n        // Stabilization Mechanisms\r\n        if (comp.stabilization_mechanisms && comp.stabilization_mechanisms.length > 0) {\r\n            this.addSubHeader(\"Stabilization Mechanisms\");\r\n            this.addText(\"How assemblages maintain coherence across territorial boundaries:\");\r\n            this.addSpacer();\r\n\r\n            comp.stabilization_mechanisms.forEach((mech: any) => {\r\n                this.addText(`â€¢ [${mech.type}] ${mech.jurisdiction}`, STYLE.colors.secondary, 0, true);\r\n                this.addText(mech.mechanism, undefined, 1);\r\n            });\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Desire and Friction\r\n        if (comp.desire_and_friction && comp.desire_and_friction.length > 0) {\r\n            this.addSubHeader(\"Desire & Friction Points\");\r\n            this.addText(\"Tensions between policy aspirations and structural constraints:\");\r\n            this.addSpacer();\r\n\r\n            comp.desire_and_friction.forEach((item: any) => {\r\n                this.addText(`${item.topic}`, STYLE.colors.primary, 0, true);\r\n                this.addText(`Friction: ${item.friction_point}`, undefined, 1);\r\n                this.addText(`Underlying Desire: ${item.underlying_desire}`, STYLE.colors.secondary, 1);\r\n                this.addSpacer();\r\n            });\r\n        }\r\n\r\n        // Institutional Conflicts\r\n        if (comp.institutional_conflict && comp.institutional_conflict.length > 0) {\r\n            this.addSubHeader(\"Institutional Conflicts\");\r\n            comp.institutional_conflict.forEach((conf: any) => {\r\n                this.addText(conf.conflict_type, STYLE.colors.primary, 0, true);\r\n                this.addText(conf.description, undefined, 1);\r\n                this.addText(`Policy A Evidence: \"${conf.policy_a_evidence}\"`, STYLE.colors.subtle, 1);\r\n                this.addText(`Policy B Evidence: \"${conf.policy_b_evidence}\"`, STYLE.colors.subtle, 1);\r\n                this.addSpacer();\r\n            });\r\n        }\r\n\r\n        // Legitimacy Tensions\r\n        if (comp.legitimacy_tensions && comp.legitimacy_tensions.length > 0) {\r\n            this.addSubHeader(\"Legitimacy Tensions\");\r\n            comp.legitimacy_tensions.forEach((tens: any) => {\r\n                this.addText(tens.tension_type, STYLE.colors.primary, 0, true);\r\n                this.addText(tens.description, undefined, 1);\r\n                this.addText(`Policy A Evidence: \"${tens.policy_a_evidence}\"`, STYLE.colors.subtle, 1);\r\n                this.addText(`Policy B Evidence: \"${tens.policy_b_evidence}\"`, STYLE.colors.subtle, 1);\r\n                this.addSpacer();\r\n            });\r\n        }\r\n\r\n        // Coloniality Assessment\r\n        if (comp.coloniality_assessment) {\r\n            this.addSubHeader(\"Coloniality Assessment\");\r\n            this.addText(comp.coloniality_assessment);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // System Critique\r\n        if (comp.system_critique) this.renderSynthesisCritique(comp.system_critique);\r\n\r\n        // Verified Quotes\r\n        if (comp.verified_quotes && comp.verified_quotes.length > 0) this.renderVerifiedQuotes(comp.verified_quotes);\r\n\r\n        // Ecosystem Impacts (Sankey Data)\r\n        if (data.ecosystemImpacts && data.ecosystemImpacts.length > 0) this.renderEcosystemImpacts(data.ecosystemImpacts);\r\n\r\n        // Assemblage Rhizome Network\r\n        if (comp.assemblage_network) this.renderAssemblageRhizome(comp.assemblage_network);\r\n    }\r\n\r\n    private renderSynthesisMatrix(comp: any) {\r\n        this.addSubHeader(\"Synthesis Framework Matrix\");\r\n\r\n        ['Risk', 'Governance', 'Rights', 'Scope'].forEach(dim => {\r\n            const key = dim.toLowerCase() as keyof typeof comp;\r\n            const val = comp[key] as any; // Type assertion since structure is uniform\r\n            if (val) {\r\n                this.addText(`${dim} Dimension:`, STYLE.colors.primary, 0, true);\r\n                this.addText(`â€¢ Convergence: ${val.convergence}`);\r\n                this.addText(`â€¢ Divergence: ${val.divergence}`);\r\n                this.addText(`â€¢ Coloniality: ${val.coloniality}`);\r\n                this.addText(\"\"); // Separator\r\n            }\r\n        });\r\n    }\r\n\r\n    private renderSynthesisCritique(crit: any) {\r\n        this.addSubHeader(\"System-Level Critique\");\r\n        if (typeof crit === 'string') {\r\n            this.addText(crit);\r\n        } else {\r\n            if (crit.blind_spots) {\r\n                this.addText(\"Blind Spots:\", STYLE.colors.secondary, 0, true);\r\n                crit.blind_spots.forEach((Spot: string) => this.addText(`â€¢ ${Spot}`));\r\n            }\r\n            if (crit.legitimacy_correction) {\r\n                this.addText(\"Legitimacy Correction:\", STYLE.colors.secondary, 0, true);\r\n                this.addText(crit.legitimacy_correction);\r\n            }\r\n        }\r\n    }\r\n\r\n    private renderVerifiedQuotes(quotes: any[]) {\r\n        this.addSubHeader(\"Verified Canonical Evidence\");\r\n        quotes.forEach(quote => {\r\n            this.addText(`\"${quote.text}\"`, STYLE.colors.secondary, 0, false);\r\n            this.addText(`(Source: ${quote.source} | Relevance: ${quote.relevance})`, STYLE.colors.meta, 1);\r\n        });\r\n    }\r\n\r\n    private renderEcosystemImpacts(impacts: any[]) {\r\n        this.addSubHeader(\"Ecosystem Impact Mapping\");\r\n        this.addText(\"Mapping of policy mechanisms to ecosystem actors.\", STYLE.colors.meta);\r\n\r\n        impacts.forEach(impact => {\r\n            this.addText(`${impact.actor}`, STYLE.colors.primary, 0, true);\r\n            this.addText(`â€¢ Mechanism: ${impact.mechanism}`);\r\n            this.addText(`â€¢ Impact: ${impact.impact} (${impact.type})`);\r\n            if (impact.interconnection_type) {\r\n                this.addText(`â€¢ Connection: ${impact.interconnection_type}`, STYLE.colors.meta);\r\n            }\r\n            this.addSpacer();\r\n        });\r\n    }\r\n\r\n    public renderResistanceAnalysis(data: ReportData[\"resistance\"]) {\r\n        if (!data) return;\r\n        this.addSectionHeader(\"Micro-Resistance Analysis\", true);\r\n\r\n        if (data.executive_summary) {\r\n            this.addText(data.executive_summary);\r\n        }\r\n\r\n        if (data.dominant_strategies && data.dominant_strategies.length > 0) {\r\n            this.addSubHeader(\"Dominant Strategies\");\r\n            data.dominant_strategies.forEach(s => {\r\n                this.addText(`${s.strategy} (${s.frequency}):`, STYLE.colors.primary, 0, true);\r\n                this.addText(s.description);\r\n            });\r\n        }\r\n\r\n        if (data.emerging_themes && data.emerging_themes.length > 0) {\r\n            this.addSubHeader(\"Emerging Themes\");\r\n            data.emerging_themes.forEach(t => this.addText(`â€¢ ${t}`));\r\n        }\r\n\r\n        if (data.implications_for_policy) {\r\n            this.addSubHeader(\"Implications for Policy\");\r\n            this.addText(data.implications_for_policy);\r\n        }\r\n    }\r\n\r\n    public renderEcosystemAnalysis(data: ReportData[\"ecosystem\"]) {\r\n        if (!data) return;\r\n        this.addSectionHeader(\"Ecosystem & Assemblage Analysis\", true);\r\n\r\n        if (data.actors) this.renderEcosystemActors(data.actors);\r\n        if (data.configurations) this.renderEcosystemConfigurations(data.configurations);\r\n        if (data.absenceAnalysis) this.renderAbsenceAnalysis(data.absenceAnalysis);\r\n        if (data.assemblage) this.renderAssemblageAnalysis(data.assemblage);\r\n    }\r\n\r\n    private renderEcosystemActors(actors: any[]) { // Use EcosystemActor type but avoid bad imports for now\r\n        if (actors.length === 0) return;\r\n\r\n        this.addSubHeader(\"Key Ecosystem Actors\");\r\n\r\n        // Create Table Rows\r\n        const headerRow = new TableRow({\r\n            children: [\r\n                new TableCell({ width: { size: 20, type: WidthType.PERCENTAGE }, children: [new Paragraph({ text: \"Actor Name\", run: { bold: true } })] }),\r\n                new TableCell({ width: { size: 15, type: WidthType.PERCENTAGE }, children: [new Paragraph({ text: \"Type\", run: { bold: true } })] }),\r\n                new TableCell({ width: { size: 10, type: WidthType.PERCENTAGE }, children: [new Paragraph({ text: \"Infl.\", run: { bold: true } })] }),\r\n                new TableCell({ width: { size: 15, type: WidthType.PERCENTAGE }, children: [new Paragraph({ text: \"Context\", run: { bold: true } })] }),\r\n                new TableCell({ width: { size: 40, type: WidthType.PERCENTAGE }, children: [new Paragraph({ text: \"Description\", run: { bold: true } })] }),\r\n            ],\r\n            tableHeader: true,\r\n        });\r\n\r\n        const rows = actors.map((actor: any) => new TableRow({\r\n            children: [\r\n                new TableCell({ children: [new Paragraph(actor.name)] }),\r\n                new TableCell({ children: [new Paragraph(actor.type)] }),\r\n                new TableCell({ children: [new Paragraph(actor.influence)] }),\r\n                new TableCell({ children: [new Paragraph(actor.materialized_from?.context_type || \"Direct\")] }),\r\n                new TableCell({ children: [new Paragraph(sanitizeText(actor.description || \"\"))] }),\r\n            ]\r\n        }));\r\n\r\n        const table = new Table({\r\n            rows: [headerRow, ...rows],\r\n            width: { size: 100, type: WidthType.PERCENTAGE },\r\n            borders: {\r\n                top: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                bottom: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                left: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                right: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n            }\r\n        });\r\n\r\n        this.sections.push(table);\r\n        this.sections.push(new Paragraph({ text: \"\" })); // Spacing\r\n    }\r\n\r\n\r\n\r\n    private renderAbsenceAnalysis(absenceAnalysis: any) {\r\n        this.addSubHeader(\"Critique: Absences & Blindspots\");\r\n        if (absenceAnalysis.narrative) {\r\n            this.addText(absenceAnalysis.narrative);\r\n            this.addSpacer();\r\n        }\r\n\r\n        if (absenceAnalysis.missing_voices && absenceAnalysis.missing_voices.length > 0) {\r\n            this.addText(\"Missing Voices:\", STYLE.colors.secondary, 0, true);\r\n            absenceAnalysis.missing_voices.forEach((voice: any) => {\r\n                // Check if voice is an object or string\r\n                const text = typeof voice === 'string' ? voice : `${voice.name} (${voice.category}): ${voice.reason}`;\r\n                this.addText(`â€¢ ${text}`);\r\n            });\r\n            this.addSpacer();\r\n        }\r\n    }\r\n\r\n    private renderAssemblageAnalysis(assemblage: any) {\r\n        this.addSubHeader(\"Assemblage Analysis\");\r\n\r\n        // Parts (Socio-Technical Components)\r\n        if (assemblage.socio_technical_components) {\r\n            this.addText(\"Parts (Socio-Technical Components)\", STYLE.colors.secondary, 0, true);\r\n            const { infra, discourse } = assemblage.socio_technical_components;\r\n            if (infra && infra.length > 0) this.addText(`Infrastructure: ${infra.join(\", \")}`);\r\n            if (discourse && discourse.length > 0) this.addText(`Discourse: ${discourse.join(\", \")}`);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Flow (Policy Mobilities)\r\n        if (assemblage.policy_mobilities) {\r\n            this.addText(\"Flow (Policy Mobilities)\", STYLE.colors.secondary, 0, true);\r\n            const { origin_concepts, local_mutations } = assemblage.policy_mobilities;\r\n            if (origin_concepts && origin_concepts.length > 0) this.addText(`Origin Concepts: ${origin_concepts.join(\", \")}`);\r\n            if (local_mutations && local_mutations.length > 0) this.addText(`Local Mutations: ${local_mutations.join(\", \")}`);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Exterior (Relations of Exteriority)\r\n        if (assemblage.relations_of_exteriority) {\r\n            this.addText(\"Exterior (Relations of Exteriority)\", STYLE.colors.secondary, 0, true);\r\n            const { detachable, embedded, mobility_score } = assemblage.relations_of_exteriority;\r\n            // Check if mobility_score exists before printing\r\n            if (mobility_score) this.addText(`Mobility Score: ${mobility_score}`);\r\n            if (detachable && detachable.length > 0) this.addText(`Detachable Relations: ${detachable.join(\", \")}`);\r\n            if (embedded && embedded.length > 0) this.addText(`Embedded Relations: ${embedded.join(\", \")}`);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Stable (Stabilization Mechanisms)\r\n        if (assemblage.stabilization_mechanisms && assemblage.stabilization_mechanisms.length > 0) {\r\n            this.addText(\"Stable (Stabilization Mechanisms)\", STYLE.colors.secondary, 0, true);\r\n            assemblage.stabilization_mechanisms.forEach((mech: any) => this.addText(`â€¢ ${mech}`));\r\n            this.addSpacer();\r\n        }\r\n    }\r\n\r\n    public renderCulturalAnalysis(data: CulturalAnalysisResult | null) {\r\n        if (!data) return;\r\n        this.addSectionHeader(\"Cultural Framing of Discursive Fields\", true);\r\n\r\n        if (data.summary) {\r\n            this.addText(data.summary);\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Clusters\r\n        if (data.clusters && data.clusters.length > 0) {\r\n            this.addSubHeader(\"Discourse Clusters\");\r\n            data.clusters.forEach((cluster: any) => {\r\n                this.addText(`${cluster.name} (Size: ${cluster.size})`, STYLE.colors.primary, 0, true);\r\n                if (cluster.description) {\r\n                    this.addText(cluster.description, STYLE.colors.secondary);\r\n                }\r\n\r\n                this.addText(\"Themes: \" + cluster.themes.join(\", \"), STYLE.colors.meta);\r\n\r\n                if (cluster.quotes && cluster.quotes.length > 0) {\r\n                    this.addText(\"Evidence:\", STYLE.colors.secondary, 0, true);\r\n                    cluster.quotes.slice(0, 3).forEach((q: any) => this.addText(`\"${q.text}\" (${q.source})`, STYLE.colors.subtle));\r\n                }\r\n                this.addSpacer();\r\n            });\r\n        }\r\n\r\n        // Holes\r\n        if (data.holes && data.holes.length > 0) {\r\n            this.addSubHeader(\"Cultural Holes & Opportunities\");\r\n            data.holes.forEach((hole: any) => {\r\n                this.addText(`Gap: ${hole.clusterA} â†” ${hole.clusterB} (Distance: ${hole.distance.toFixed(2)})`, STYLE.colors.danger, 0, true);\r\n                this.addText(`Opportunity: ${hole.opportunity}`);\r\n                if (hole.policyImplication) {\r\n                    this.addText(`Policy Implication: ${hole.policyImplication}`, STYLE.colors.secondary);\r\n                }\r\n                if (hole.bridgingConcepts && hole.bridgingConcepts.length > 0) {\r\n                    const concepts = hole.bridgingConcepts.map((b: any) => b.concept).join(\", \");\r\n                    this.addText(`Bridging Concepts: ${concepts}`, STYLE.colors.success);\r\n                }\r\n                this.addSpacer();\r\n            });\r\n        }\r\n    }\r\n\r\n    public renderOntology(data: ReportData[\"ontology\"]) {\r\n        if (!data) return;\r\n        this.addSectionHeader(\"Ontological Cartography\", true);\r\n\r\n        const maps = Object.values(data.maps);\r\n        if (maps.length === 0) {\r\n            this.addText(\"No ontological maps generated.\");\r\n        } else {\r\n            this.renderOntologyMaps(maps);\r\n        }\r\n\r\n        if (data.comparison) {\r\n            this.renderOntologyComparison(data.comparison);\r\n        }\r\n    }\r\n\r\n    private renderOntologyMaps(maps: any[]) {\r\n        maps.forEach((map: any, idx) => {\r\n            this.addSubHeader(`Map Analysis ${idx + 1}`);\r\n            if (map.summary) this.addText(map.summary);\r\n\r\n            // Nodes\r\n            if (map.nodes && map.nodes.length > 0) {\r\n                this.addText(\"Key Concepts (Nodes):\", STYLE.colors.secondary, 0, true);\r\n                map.nodes.forEach((node: any) => {\r\n                    this.addText(`â€¢ ${node.label} [${node.category}]`, STYLE.colors.primary, 0, true);\r\n                    if (node.description) this.addText(node.description);\r\n                    if (node.quote) this.addText(`\"${node.quote}\"`, STYLE.colors.subtle, 1);\r\n                });\r\n                this.addSpacer();\r\n            }\r\n\r\n            // Links\r\n            if (map.links && map.links.length > 0) {\r\n                this.addText(\"Network Topology (Relations):\", STYLE.colors.secondary, 0, true);\r\n                const relations = map.links.map((l: any) => {\r\n                    // Find node labels if possible, else use IDs\r\n                    const sourceNode = map.nodes.find((n: any) => n.id === l.source)?.label || l.source;\r\n                    const targetNode = map.nodes.find((n: any) => n.id === l.target)?.label || l.target;\r\n                    return `${sourceNode} --[${l.relation}]--> ${targetNode}`;\r\n                });\r\n                relations.slice(0, 15).forEach((r: string) => this.addText(`â€¢ ${r}`)); // Limit to top 15 to avoid spam\r\n                if (relations.length > 15) this.addText(`...and ${relations.length - 15} more relations.`);\r\n                this.addSpacer();\r\n            }\r\n        });\r\n    }\r\n\r\n    private renderOntologyComparison(comp: any) {\r\n        this.addSubHeader(\"Comparative Ontology\");\r\n        if (comp.summary) this.addText(comp.summary);\r\n\r\n        // Metrics\r\n        if (comp.assemblage_metrics && comp.assemblage_metrics.length > 0) {\r\n            this.addText(\"Assemblage Metrics:\", STYLE.colors.secondary, 0, true);\r\n            comp.assemblage_metrics.forEach((m: any) => {\r\n                this.addText(`${m.jurisdiction}:`, STYLE.colors.primary, 0, true);\r\n                this.addText(`â€¢ Territorialization: ${m.territorialization}/100 - ${m.territorialization_justification}`);\r\n                this.addText(`â€¢ Coding: ${m.coding}/100 - ${m.coding_justification}`);\r\n            });\r\n            this.addSpacer();\r\n        }\r\n\r\n        // Differences\r\n        this.addText(\"Structural Differences:\", STYLE.colors.secondary, 0, true);\r\n        this.addText(comp.structural_differences);\r\n        this.addSpacer();\r\n\r\n        if (comp.shared_concepts && comp.shared_concepts.length > 0) {\r\n            this.addText(`Shared Concepts: ${comp.shared_concepts.join(\", \")}`);\r\n        }\r\n\r\n        if (comp.relationship_divergences && comp.relationship_divergences.length > 0) {\r\n            this.addText(\"Relationship Divergences:\", STYLE.colors.secondary, 0, true);\r\n            comp.relationship_divergences.forEach((d: any) => {\r\n                this.addText(`â€¢ ${d.concept}: ${d.difference}`);\r\n            });\r\n        }\r\n    }\r\n\r\n    public renderComparisonMatrix(sources: Source[]) {\r\n        if (!sources || sources.length < 2) return;\r\n\r\n        // Filter for sources with analysis\r\n        const validSources = sources.filter(s => s.analysis);\r\n        if (validSources.length < 2) return;\r\n\r\n        this.addSectionHeader(\"Comparative Diagnostic Matrix\", true);\r\n        this.addText(\"Flattened matrix view for rapid cross-policy signal analysis.\", STYLE.colors.meta);\r\n\r\n        // 1. Comparison Table\r\n        this.renderComparisonTable(validSources);\r\n\r\n        // 2. Detailed Breakdown text (to avoid super wide tables)\r\n        this.renderComparisonSignalBreakdown(validSources);\r\n    }\r\n\r\n    private renderComparisonTable(validSources: Source[]) {\r\n        // Calculate headers: Diagnostic Criteria + Source Names\r\n        const tableHeaders = [\r\n            new TableCell({\r\n                width: { size: 25, type: WidthType.PERCENTAGE },\r\n                children: [new Paragraph({ text: \"Diagnostic Criteria\", run: { bold: true, size: STYLE.sizes.small } })]\r\n            }),\r\n            ...validSources.map(s => new TableCell({\r\n                width: { size: (75 / validSources.length), type: WidthType.PERCENTAGE },\r\n                children: [new Paragraph({ text: s.title, run: { bold: true, size: STYLE.sizes.small } })]\r\n            }))\r\n        ];\r\n\r\n        const rows: TableRow[] = [];\r\n\r\n        // Header Row\r\n        rows.push(new TableRow({ children: tableHeaders, tableHeader: true }));\r\n\r\n        // A. Overall Risk Index Row\r\n        const riskRowCells = [\r\n            new TableCell({ children: [new Paragraph({ text: \"Overall Risk Index\", run: { bold: true, size: STYLE.sizes.small } })] }),\r\n            ...validSources.map(s => {\r\n                const risk = calculateMicroFascismRisk(s.analysis!);\r\n                const color = risk && risk.score >= 4 ? STYLE.colors.danger : STYLE.colors.primary;\r\n                return new TableCell({\r\n                    children: [new Paragraph({\r\n                        text: risk ? `${risk.score}/6 (${risk.level})` : \"-\",\r\n                        run: { color: color, bold: true, size: STYLE.sizes.small }\r\n                    })]\r\n                });\r\n            })\r\n        ];\r\n        rows.push(new TableRow({ children: riskRowCells }));\r\n\r\n        // B. Liberatory Potential Row\r\n        const capacityRowCells = [\r\n            new TableCell({ children: [new Paragraph({ text: \"Liberatory Potential\", run: { bold: true, size: STYLE.sizes.small } })] }),\r\n            ...validSources.map(s => {\r\n                const cap = calculateLiberatoryCapacity(s.analysis!);\r\n                const color = cap && cap.score >= 5 ? STYLE.colors.success : STYLE.colors.primary;\r\n                return new TableCell({\r\n                    children: [new Paragraph({\r\n                        text: cap ? `${cap.score}/8 (${cap.level})` : \"-\",\r\n                        run: { color: color, bold: true, size: STYLE.sizes.small }\r\n                    })]\r\n                });\r\n            })\r\n        ];\r\n        rows.push(new TableRow({ children: capacityRowCells }));\r\n\r\n        // Table Construction\r\n        const matrixTable = new Table({\r\n            rows: rows,\r\n            width: { size: 100, type: WidthType.PERCENTAGE },\r\n            borders: {\r\n                top: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                bottom: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                left: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                right: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n            }\r\n        });\r\n\r\n        this.sections.push(matrixTable);\r\n        this.addSpacer();\r\n        this.addSpacer();\r\n    }\r\n\r\n    private renderComparisonSignalBreakdown(validSources: Source[]) {\r\n        this.addSubHeader(\"Detailed Signal Breakdown\");\r\n\r\n        validSources.forEach(s => {\r\n            const risk = calculateMicroFascismRisk(s.analysis!);\r\n            const cap = calculateLiberatoryCapacity(s.analysis!);\r\n\r\n            this.addText(`${s.title}:`, STYLE.colors.primary, 0, true);\r\n\r\n            if (risk) {\r\n                const riskFlags = Object.entries(risk.flags).filter(([k, v]) => v).map(([k]) => k.replace(/_/g, ' '));\r\n                if (riskFlags.length > 0) {\r\n                    this.addText(`â€¢ Risk Signals: ${riskFlags.join(\", \")}`, STYLE.colors.danger);\r\n                }\r\n            }\r\n            if (cap) {\r\n                const capFlags = Object.entries(cap.signals).filter(([k, v]) => v).map(([k]) => k.replace(/_/g, ' '));\r\n                if (capFlags.length > 0) {\r\n                    this.addText(`â€¢ Liberatory Capacities: ${capFlags.join(\", \")}`, STYLE.colors.success);\r\n                }\r\n            }\r\n            this.addText(\"\");\r\n        });\r\n    }\r\n\r\n    public renderGovernanceMatrix(sources: Source[]) {\r\n        if (!sources || sources.length < 2) return;\r\n\r\n        // Filter for sources with governance scores\r\n        const validSources = sources.filter(s => s.analysis && s.analysis.governance_scores);\r\n        if (validSources.length < 2) return;\r\n\r\n        this.addSectionHeader(\"Governance Compass Matrix\", true);\r\n        this.addText(\"Comparative analysis of governance mechanisms across frameworks.\", STYLE.colors.meta);\r\n\r\n        // Governance Dimensions\r\n        const dimensions = [\r\n            { id: \"centralization\", label: \"Centralization\" },\r\n            { id: \"rights_focus\", label: \"Rights Focus\" },\r\n            { id: \"flexibility\", label: \"Flexibility\" },\r\n            { id: \"market_power\", label: \"Market Power\" },\r\n            { id: \"procedurality\", label: \"Procedurality\" }\r\n        ];\r\n\r\n        // 1. Comparison Table\r\n        const tableHeaders = [\r\n            new TableCell({\r\n                width: { size: 25, type: WidthType.PERCENTAGE },\r\n                children: [new Paragraph({ text: \"Governance Dimension\", run: { bold: true, size: STYLE.sizes.small } })]\r\n            }),\r\n            ...validSources.map(s => new TableCell({\r\n                width: { size: (75 / validSources.length), type: WidthType.PERCENTAGE },\r\n                children: [new Paragraph({ text: s.title, run: { bold: true, size: STYLE.sizes.small } })]\r\n            }))\r\n        ];\r\n\r\n        const rows: TableRow[] = [];\r\n        rows.push(new TableRow({ children: tableHeaders, tableHeader: true }));\r\n\r\n        dimensions.forEach(dim => {\r\n            const rowCells = [\r\n                new TableCell({ children: [new Paragraph({ text: dim.label, run: { bold: true, size: STYLE.sizes.small } })] }),\r\n                ...validSources.map(s => {\r\n                    const score = s.analysis?.governance_scores?.[dim.id as keyof typeof s.analysis.governance_scores] ?? \"-\";\r\n                    return new TableCell({\r\n                        children: [new Paragraph({\r\n                            text: String(score),\r\n                            run: { color: STYLE.colors.secondary, size: STYLE.sizes.small }\r\n                        })]\r\n                    });\r\n                })\r\n            ];\r\n            rows.push(new TableRow({ children: rowCells }));\r\n        });\r\n\r\n        // Table Construction\r\n        const matrixTable = new Table({\r\n            rows: rows,\r\n            width: { size: 100, type: WidthType.PERCENTAGE },\r\n            borders: {\r\n                top: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                bottom: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                left: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                right: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.subtle },\r\n                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: STYLE.colors.accent },\r\n            }\r\n        });\r\n\r\n        this.sections.push(matrixTable);\r\n        this.addSpacer();\r\n    }\r\n\r\n\r\n    private renderResistanceArtifacts(artifacts: any[]) {\r\n        if (!artifacts || artifacts.length === 0) return;\r\n\r\n        this.addSectionHeader(\"Primary Data: Resistance Artifacts\", true);\r\n        this.addText(\"Analysis of resistance materials (manifestos, policy drafts, etc.) revealing assemblage reconfiguration dynamics.\", STYLE.colors.meta);\r\n        this.addSpacer();\r\n\r\n        artifacts.forEach((artifact, index) => {\r\n            this.addSubHeader(`${index + 1}. ${artifact.title}`);\r\n\r\n            const meta = [\r\n                `Type: ${artifact.type.replace('_', ' ')}`,\r\n                `Source: ${artifact.source}`,\r\n                `Date: ${new Date(artifact.date).toLocaleDateString()}`\r\n            ];\r\n            this.addText(meta.join(\" | \"), STYLE.colors.subtle, 0, false);\r\n\r\n            if (artifact.target_policy) {\r\n                this.addText(`Target: ${artifact.target_policy}`, STYLE.colors.secondary, 0, false);\r\n            }\r\n            this.addSpacer();\r\n\r\n            // Frames\r\n            if (artifact.frames && artifact.frames.length > 0) {\r\n                this.addText(\"Discourse Frames:\", STYLE.colors.primary, 0, true);\r\n                artifact.frames.forEach((frame: any) => {\r\n                    this.addText(`â€¢ ${frame.frame_name}: ${frame.description}`, undefined, 1);\r\n                    if (frame.evidence_quotes && frame.evidence_quotes.length > 0) {\r\n                        this.addText(`\"${frame.evidence_quotes[0]}\"`, STYLE.colors.subtle, 2, false);\r\n                    }\r\n                });\r\n                this.addSpacer();\r\n            }\r\n\r\n            // Reconfiguration\r\n            if (artifact.reconfiguration_potential) {\r\n                const reconfig = artifact.reconfiguration_potential;\r\n                this.addText(\"Assemblage Reconfiguration:\", STYLE.colors.primary, 0, true);\r\n\r\n                if (reconfig.deterritorializes) {\r\n                    this.addText(`Deterritorializes: ${reconfig.deterritorializes}`, undefined, 1);\r\n                }\r\n                if (reconfig.recodes) {\r\n                    this.addText(`Recodes: ${reconfig.recodes}`, undefined, 1);\r\n                }\r\n                if (reconfig.theoretical_contribution) {\r\n                    this.addText(\"Theoretical Contribution:\", STYLE.colors.secondary, 1, true);\r\n                    this.addText(reconfig.theoretical_contribution, undefined, 2);\r\n                }\r\n                this.addSpacer();\r\n            }\r\n        });\r\n\r\n        this.addPageBreak();\r\n    }\r\n\r\n    public renderMultiLensAnalysis(data: ReportData[\"multiLens\"]) {\r\n        if (!data || !data.results) return;\r\n\r\n        // Check if any results actually exist\r\n        const hasResults = Object.values(data.results).some(r => r !== null);\r\n        if (!hasResults) return;\r\n\r\n        this.addSectionHeader(\"Reflexive Multi-Lens Analysis\", true);\r\n        this.addText(\"Theoretical Entanglement of: \" + data.text.substring(0, 100) + \"...\", STYLE.colors.meta);\r\n\r\n        // Iterate through known lenses\r\n        const lenses = [\r\n            { id: 'dsf', name: 'Decolonial Framework' },\r\n            { id: 'cultural_framing', name: 'Cultural Framing' },\r\n            { id: 'institutional_logics', name: 'Institutional Logics' },\r\n            { id: 'legitimacy', name: 'Legitimacy Orders' }\r\n        ];\r\n\r\n        lenses.forEach(lens => {\r\n            const result = data.results[lens.id as import(\"../types/report\").LensType];\r\n\r\n            // Actually, I will explicitly perform the replace to be sure.\r\n            if (result) {\r\n                this.addSubHeader(lens.name);\r\n\r\n                // Key Insight\r\n                if (result.key_insight) {\r\n                    this.addText(\"Key Insight:\", STYLE.colors.secondary, 0, true);\r\n                    this.addText(result.key_insight);\r\n                }\r\n\r\n                // Specific Fields based on lens type\r\n                if (lens.id === 'cultural_framing') {\r\n                    if (result.dominant_cultural_logic) this.addText(`Dominant Logic: ${result.dominant_cultural_logic}`);\r\n                    if (result.state_market_society) this.addText(result.state_market_society);\r\n                }\r\n\r\n                if (lens.id === 'institutional_logics') {\r\n                    if (result.dominant_logic) this.addText(`Dominant Logic: ${result.dominant_logic}`);\r\n                    if (result.overall_assessment) this.addText(result.overall_assessment);\r\n                }\r\n\r\n                if (lens.id === 'legitimacy') {\r\n                    // Cast to any to access specific fields without importing the type locally if not needed\r\n                    const l = result as any;\r\n                    if (l.dominant_order) this.addText(`Dominant Order: ${l.dominant_order}`);\r\n                    if (l.justification_logic) this.addText(`Justification: ${l.justification_logic}`);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    private renderEcosystemConfigurations(configurations: any[]) {\r\n        if (!configurations || configurations.length === 0) return;\r\n\r\n        this.addSubHeader(\"Ecosystem Configurations (Assemblages)\");\r\n\r\n        configurations.forEach((config: any, index: number) => {\r\n            this.addText(`${index + 1}. ${config.name}`, STYLE.colors.primary, 0, true);\r\n            if (config.description) {\r\n                this.addText(config.description, STYLE.colors.subtle, 1);\r\n            }\r\n\r\n            if (config.properties) {\r\n                this.addText(`Stability: ${config.properties.stability || 'N/A'}`, undefined, 1);\r\n                this.addText(`Generativity: ${config.properties.generativity || 'N/A'}`, undefined, 1);\r\n                if (config.properties.territorialization_score !== undefined) {\r\n                    this.addText(`Territorialization: ${config.properties.territorialization_score}/10`, undefined, 1);\r\n                }\r\n                if (config.properties.coding_intensity_score !== undefined) {\r\n                    this.addText(`Coding Intensity: ${config.properties.coding_intensity_score}/10`, undefined, 1);\r\n                }\r\n            }\r\n\r\n            if (config.memberIds && config.memberIds.length > 0) {\r\n                this.addText(`Member Actors: ${config.memberIds.length}`, STYLE.colors.secondary, 1);\r\n            }\r\n\r\n            this.addSpacer();\r\n        });\r\n    }\r\n\r\n    public renderScenarios(scenarios: any) {\r\n        if (!scenarios || Object.keys(scenarios).length === 0) return;\r\n\r\n        this.addSectionHeader(\"Scenario Analysis\", true);\r\n        this.addText(\"Hypothetical scenarios testing the resilience and adaptability of the governance assemblage.\");\r\n        this.addSpacer();\r\n\r\n        // Scenarios are typically stored as an object with scenario IDs as keys\r\n        Object.entries(scenarios).forEach(([scenarioId, scenarioData]: [string, any]) => {\r\n            if (scenarioData && scenarioData.name) {\r\n                this.addSubHeader(scenarioData.name);\r\n                if (scenarioData.description) {\r\n                    this.addText(scenarioData.description);\r\n                }\r\n                if (scenarioData.effects) {\r\n                    this.addText(\"Effects:\", STYLE.colors.secondary, 0, true);\r\n                    scenarioData.effects.forEach((effect: string) => {\r\n                        this.addText(`â€¢ ${effect}`, undefined, 1);\r\n                    });\r\n                }\r\n                this.addSpacer();\r\n            }\r\n        });\r\n    }\r\n\r\n    public renderMethodologicalLogs(logs: any[]) {\r\n        if (!logs || logs.length === 0) return;\r\n\r\n        this.addSectionHeader(\"Methodological Reflexivity Log\", true);\r\n        this.addText(\"Documentation of interpretive decisions, conflicts, and positionality throughout the analysis.\");\r\n        this.addSpacer();\r\n\r\n        logs.forEach((log: any, index: number) => {\r\n            const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A';\r\n            this.addText(`[${timestamp}] ${log.type}`, STYLE.colors.primary, 0, true);\r\n\r\n            if (log.details) {\r\n                if (log.details.conflict_type) {\r\n                    this.addText(`Conflict Type: ${log.details.conflict_type}`, undefined, 1);\r\n                }\r\n                if (log.details.lens_applied) {\r\n                    this.addText(`Lens Applied: ${log.details.lens_applied}`, undefined, 1);\r\n                }\r\n                if (log.details.resolution || log.details.rationale) {\r\n                    const text = log.details.resolution || log.details.rationale;\r\n                    this.addText(text, undefined, 1);\r\n                }\r\n                if (log.details.discrepancy_score) {\r\n                    this.addText(`Discrepancy Score: ${log.details.discrepancy_score}`, undefined, 1);\r\n                }\r\n            }\r\n\r\n            this.addSpacer();\r\n        });\r\n    }\r\n\r\n    private renderAssemblageRhizome(network: any) {\r\n        if (!network || !network.nodes || network.nodes.length === 0) return;\r\n\r\n        this.addSubHeader(\"Assemblage Rhizome (Policy Network)\");\r\n        this.addText(\"Mapping shared ancestry and inter-referential citations across policy documents.\");\r\n        this.addSpacer();\r\n\r\n        // Nodes\r\n        this.addText(\"Network Nodes:\", STYLE.colors.secondary, 0, true);\r\n        network.nodes.forEach((node: string) => {\r\n            this.addText(`â€¢ ${node}`, undefined, 1);\r\n        });\r\n        this.addSpacer();\r\n\r\n        // Edges (Relationships)\r\n        if (network.edges && network.edges.length > 0) {\r\n            this.addText(\"Network Relationships:\", STYLE.colors.secondary, 0, true);\r\n            network.edges.forEach((edge: any) => {\r\n                this.addText(`â€¢ ${edge.from} â†’ ${edge.to} (${edge.type})`, undefined, 1);\r\n            });\r\n            this.addSpacer();\r\n        }\r\n\r\n        this.addText(\"Note: Visual network diagram available in the web interface.\", STYLE.colors.subtle, 0, false);\r\n    }\r\n\r\n    public async generateAndDownload(filename: string) {\r\n        const doc = new Document({\r\n            sections: [{\r\n                properties: {},\r\n                children: this.sections,\r\n            }],\r\n        });\r\n\r\n        const blob = await Packer.toBlob(doc);\r\n        saveAs(blob, filename);\r\n    }\r\n}\r\n\r\n\r\nexport async function generateFullReportDOCX(data: ReportData, options?: ReportSectionSelection) {\r\n    const generator = new ReportGeneratorDOCX();\r\n\r\n    // Default to true for all if options are not provided\r\n    const show = options || {\r\n        documentAnalysis: true,\r\n        comparisonMatrix: true,\r\n        synthesis: true,\r\n        resistance: true,\r\n        ecosystem: true,\r\n        cultural: true,\r\n        ontology: true,\r\n        multiLens: true,\r\n        scenarios: true,\r\n        logs: true,\r\n        configurations: true,\r\n        resistanceArtifacts: true\r\n    };\r\n\r\n    // 1. Title Page\r\n    generator.addTitlePage(\"Comprehensive Analysis Report\", \"Decolonial Situatedness in Global AI Governance\");\r\n\r\n    // 2. Document Analysis (Iterate Sources)\r\n    if (show.documentAnalysis) {\r\n        const analyzedSources = data.sources.filter(s =>\r\n            s.analysis || s.cultural_framing || s.institutional_logics || s.legitimacy_analysis || s.resistance_analysis\r\n        );\r\n\r\n        if (analyzedSources.length > 0) {\r\n            generator.addSectionHeader(\"Document Analysis\", true);\r\n            analyzedSources.forEach((source, index) => {\r\n                generator.renderSourceAnalysis(source, index + 1);\r\n            });\r\n        }\r\n    }\r\n\r\n    // 3. Comparative Diagnostic Matrix\r\n    if (show.comparisonMatrix) {\r\n        // Need re-filtering if document analysis wasn't run earlier, but lightweight filter is fine\r\n        const analyzedSourcesForMatrix = data.sources.filter(s =>\r\n            s.analysis || s.cultural_framing || s.institutional_logics || s.legitimacy_analysis || s.resistance_analysis\r\n        );\r\n\r\n        if (analyzedSourcesForMatrix.length >= 2) {\r\n            generator.renderComparisonMatrix(analyzedSourcesForMatrix);\r\n            // 3a. Governance Compass Matrix - bundled with comparison for now logic-wise, or could be split if requested\r\n            generator.renderGovernanceMatrix(analyzedSourcesForMatrix);\r\n        }\r\n    }\r\n\r\n    // 4. Synthesis\r\n    if (show.synthesis && data.synthesis) {\r\n        generator.renderCrossCaseSynthesis(data.synthesis);\r\n    }\r\n\r\n    // 4. Resistance Synthesis\r\n    if (show.resistance && data.resistance) {\r\n        generator.renderResistanceAnalysis(data.resistance);\r\n    }\r\n\r\n    // 4b. Resistance Artifacts (Primary Data)\r\n    if (show.resistanceArtifacts && data.resistanceArtifacts) {\r\n        // @ts-ignore - Private method access\r\n        generator.renderResistanceArtifacts(data.resistanceArtifacts);\r\n    }\r\n\r\n    // 5. Ecosystem\r\n    if (show.ecosystem && data.ecosystem) {\r\n        generator.renderEcosystemAnalysis(data.ecosystem);\r\n    }\r\n\r\n    // 6. Cultural (Discursive Fields)\r\n    if (show.cultural && data.cultural) {\r\n        generator.renderCulturalAnalysis(data.cultural);\r\n    }\r\n\r\n    // 7. Ontology\r\n    if (show.ontology && data.ontology) {\r\n        generator.renderOntology(data.ontology);\r\n    }\r\n\r\n    // 7. Multi-Lens (Reflexivity)\r\n    if (show.multiLens && data.multiLens) {\r\n        generator.renderMultiLensAnalysis(data.multiLens);\r\n    }\r\n\r\n    // 8. Scenarios\r\n    if (show.scenarios && data.ecosystem?.configurations) {\r\n        // For now, scenarios are not directly stored, but we can render configurations as a proxy\r\n        // If scenarios are stored separately in the future, update this logic\r\n        generator.renderScenarios({});\r\n    }\r\n\r\n    // 9. Methodological Logs\r\n    if (show.logs && data.logs) {\r\n        generator.renderMethodologicalLogs(data.logs);\r\n    }\r\n\r\n    await generator.generateAndDownload(`Comprehensive_Report_${new Date().toISOString().split('T')[0]}.docx`);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\utils\\generateFullReportPDF.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\utils\\generateSynthesisPDF.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\src\\utils\\pdfExtractor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-analysis.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testAnalysis() {\r\n    const artifactText = \"This automated system is a form of digital colonialism. We refuse to be data subjects. We claim sovereignty over our digital territories.\";\r\n\r\n    console.log(\"Testing discourse analysis API...\");\r\n    try {\r\n        const response = await fetch('http://localhost:3000/api/resistance/analyze', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                artifact_id: 'test-id',\r\n                artifact_text: artifactText,\r\n                analysis_type: 'full'\r\n            })\r\n        });\r\n\r\n        const data = await response.json();\r\n        console.log(\"Response Status:\", response.status);\r\n        if (data.success) {\r\n            console.log(\"SUCCESS: Analysis received\");\r\n            console.log(JSON.stringify(data.analysis, null, 2));\r\n        } else {\r\n            console.error(\"FAILURE: API returned error\");\r\n            console.error(data);\r\n        }\r\n    } catch (e) {\r\n        console.error(\"FAILURE: Network or script error\", e);\r\n    }\r\n}\r\n\r\ntestAnalysis();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-auth-fix.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testFetchUrlAuth() {\r\n    try {\r\n        console.log(\"Testing /api/fetch-url auth fix...\");\r\n        const urlToFetch = \"https://www.example.com\";\r\n        const body = JSON.stringify({ url: urlToFetch });\r\n\r\n        // Emulate the frontend logic for headers\r\n        const headers = {\r\n            'Content-Type': 'application/json',\r\n            'x-demo-user-id': 'demo-user' // Using the default we patched in\r\n        };\r\n\r\n        const response = await fetch('http://localhost:3000/api/fetch-url', {\r\n            method: 'POST',\r\n            headers: headers,\r\n            body: body\r\n        });\r\n\r\n        console.log(`Status: ${response.status}`);\r\n\r\n        if (response.status === 401) {\r\n            console.error(\"âŒ Still Unauthorized (401)\");\r\n        } else if (response.status === 200) {\r\n            console.log(\"âœ… Success: Authorized (200)\");\r\n            const data = await response.json();\r\n            console.log(\"Response data preview:\", JSON.stringify(data).substring(0, 100));\r\n        } else {\r\n            console.log(`Received status ${response.status}`);\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Test failed:\", e);\r\n    }\r\n}\r\n\r\ntestFetchUrlAuth();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-credits.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCredits' is assigned a value but never used.","line":3,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":52,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":69,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":97,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'redis' is assigned a value but never used.","line":4,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":14,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":19,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":45,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-fetch-400.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testFetch400() {\r\n    console.log(\"Testing /api/fetch-url for 400 error...\");\r\n\r\n    const headers = {\r\n        'Content-Type': 'application/json',\r\n        'x-demo-user-id': 'demo-user'\r\n    };\r\n\r\n    // Test 1: Empty object (simulate url undefined)\r\n    const response1 = await fetch('http://localhost:3000/api/fetch-url', {\r\n        method: 'POST',\r\n        headers: headers,\r\n        body: JSON.stringify({})\r\n    });\r\n    console.log(`Test 1 (Empty Body) Status: ${response1.status}`);\r\n    const data1 = await response1.json();\r\n    console.log(`Test 1 Response:`, data1);\r\n\r\n    // Test 2: Valid URL\r\n    const response2 = await fetch('http://localhost:3000/api/fetch-url', {\r\n        method: 'POST',\r\n        headers: headers,\r\n        body: JSON.stringify({ url: \"https://example.com\" })\r\n    });\r\n    console.log(`Test 2 (Valid URL) Status: ${response2.status}`);\r\n\r\n}\r\n\r\ntestFetch400();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-fetch.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testFetch() {\r\n    const urls = [\r\n        \"https://edri.org/wp-content/uploads/2021/12/Political-statement-AI-Act.pdf\",\r\n        \"https://www.accessnow.org/wp-content/uploads/2022/11/Access-Now-Version-Human-Rights-Implications-of-Algorithmic-Impact-Assessme-nts_-Priority-Recommendations-to-Guide-Effective-Development-and-Use.pdf\"\r\n    ];\r\n\r\n    console.log(\"Testing fetch-url API with real PDFs...\");\r\n\r\n    for (const url of urls) {\r\n        try {\r\n            console.log(`\\nFetching: ${url}`);\r\n            const response = await fetch('http://localhost:3000/api/fetch-url', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ url })\r\n            });\r\n\r\n            const data = await response.json();\r\n            if (response.ok && data.success) {\r\n                console.log(`SUCCESS: Fetched ${data.title}`);\r\n                console.log(`Content length: ${data.content.length} characters`);\r\n                console.log(`Sample: ${data.content.substring(0, 100)}...`);\r\n            } else {\r\n                console.error(`FAILURE: ${response.status} - ${data.error || 'Unknown error'}`);\r\n            }\r\n        } catch (e) {\r\n            console.error(`FAILURE: Network error for ${url}`, e.message);\r\n        }\r\n    }\r\n}\r\n\r\ntestFetch();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-google-search.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-redis.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\test-search-api.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fetch = require('node-fetch');\r\n\r\nasync function testSearch() {\r\n    try {\r\n        console.log(\"Testing /api/resistance/search fallback...\");\r\n        const response = await fetch('http://localhost:3000/api/resistance/search?q=test_query');\r\n\r\n        console.log(`Status: ${response.status}`);\r\n        const data = await response.json();\r\n\r\n        console.log(\"Source:\", data.source);\r\n        console.log(\"Result Count:\", data.results?.length);\r\n\r\n        if (data.source === 'mock' && data.results.length > 0) {\r\n            console.log(\"âœ… Fallback verification successful: Mock data returned.\");\r\n        } else {\r\n            console.error(\"âŒ Verification failed:\", data);\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Test failed:\", e);\r\n    }\r\n}\r\n\r\ntestSearch();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\verify_config.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nconst { OpenAI } = require('openai');\r\n\r\n// Mock environment\r\nconst apiKey = process.env.OPENAI_API_KEY;\r\nconst baseURL = process.env.OPENAI_BASE_URL;\r\nconst model = process.env.OPENAI_MODEL || \"gpt-4o\";\r\n\r\nconsole.log(\"Testing OpenAI Configuration:\");\r\nconsole.log(\"Model:\", model);\r\nconsole.log(\"Base URL:\", baseURL || \"Default (OpenAI)\");\r\n\r\nif (!apiKey) {\r\n    console.error(\"Error: OPENAI_API_KEY is missing in environment.\");\r\n    process.exit(1);\r\n}\r\n\r\nconst openai = new OpenAI({\r\n    apiKey: apiKey,\r\n    baseURL: baseURL\r\n});\r\n\r\nasync function testConnection() {\r\n    try {\r\n        console.log(\"Sending test request...\");\r\n        const completion = await openai.chat.completions.create({\r\n            model: model,\r\n            messages: [\r\n                { role: \"system\", content: \"You are a helpful assistant.\" },\r\n                { role: \"user\", content: \"Say 'Connection Successful' if you can hear me.\" }\r\n            ]\r\n        });\r\n        console.log(\"Response:\", completion.choices[0].message.content);\r\n        console.log(\"SUCCESS: Backend configuration is valid.\");\r\n    } catch (error) {\r\n        console.error(\"FAILURE: OpenAI API call failed.\");\r\n        console.error(error);\r\n    }\r\n}\r\n\r\ntestConnection();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mount\\.gemini\\antigravity\\scratch\\verify_registry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]